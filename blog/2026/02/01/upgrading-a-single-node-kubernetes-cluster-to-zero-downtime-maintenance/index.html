<!DOCTYPE html><html lang="en" class="no-js"><head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://stibbons1990.github.io/hex/blog/2026/02/01/upgrading-a-single-node-kubernetes-cluster-to-zero-downtime-maintenance/">
      
      
        <link rel="prev" href="../../../01/25/migrating-kubernetes-volumes-to-longhorn/">
      
      
        <link rel="next" href="../../10/self-hosted-personal-dis-organizer-with-vikunja/">
      
      
        
      
      
      <link rel="icon" href="../../../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.7.1">
    
    
      
        <title>Upgrading a single-node Kubernetes cluster to Zero Downtime Maintenance - Inadvisably Applied Magic</title>
      
    
    
      <link rel="stylesheet" href="../../../../../assets/stylesheets/main.484c7ddc.min.css">
      
        
        <link rel="stylesheet" href="../../../../../assets/stylesheets/palette.ab4e12ef.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&amp;display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../../../../stylesheets/extra.css">
    
    <script>__md_scope=new URL("../../../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      
  


  
  

<script id="__analytics">function __md_analytics(){function e(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],e("js",new Date),e("config","G-Y167L3ZVGY"),document.addEventListener("DOMContentLoaded",(function(){document.forms.search&&document.forms.search.query.addEventListener("blur",(function(){this.value&&e("event","search",{search_term:this.value})}));document$.subscribe((function(){var t=document.forms.feedback;if(void 0!==t)for(var a of t.querySelectorAll("[type=submit]"))a.addEventListener("click",(function(a){a.preventDefault();var n=document.location.pathname,d=this.getAttribute("data-md-value");e("event","feedback",{page:n,data:d}),t.firstElementChild.disabled=!0;var r=t.querySelector(".md-feedback__note [data-md-value='"+d+"']");r&&(r.hidden=!1)})),t.hidden=!1})),location$.subscribe((function(t){e("config","G-Y167L3ZVGY",{page_path:t.pathname})}))}));var t=document.createElement("script");t.async=!0,t.src="https://www.googletagmanager.com/gtag/js?id=G-Y167L3ZVGY",document.getElementById("__analytics").insertAdjacentElement("afterEnd",t)}</script>
  
    <script>"undefined"!=typeof __md_analytics&&__md_analytics()</script>
  

    
    
  <link href="../../../../../assets/stylesheets/glightbox.min.css" rel="stylesheet"><script src="../../../../../assets/javascripts/glightbox.min.js"></script><style id="glightbox-style">
            html.glightbox-open { overflow: initial; height: 100%; }
            .gslide-title { margin-top: 0px; user-select: text; }
            .gslide-desc { color: #666; user-select: text; }
            .gslide-image img { background: white; }
            .gscrollbar-fixer { padding-right: 15px; }
            .gdesc-inner { font-size: 0.75rem; }
            body[data-md-color-scheme="slate"] .gdesc-inner { background: var(--md-default-bg-color); }
            body[data-md-color-scheme="slate"] .gslide-title { color: var(--md-default-fg-color); }
            body[data-md-color-scheme="slate"] .gslide-desc { color: var(--md-default-fg-color); }
        </style></head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="slate" data-md-color-primary="deep-purple" data-md-color-accent="green">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#the-pln" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../../../.." title="Inadvisably Applied Magic" class="md-header__button md-logo" aria-label="Inadvisably Applied Magic" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="m64 400 85.7-208.2c17-41.3 47.8-75.3 87.2-96.3l146.9-78.3c12.3-6.6 26.5 4.7 23 18.2l-37.2 142.4c-1.1 4.1-1.6 8.3-1.6 12.6 0 6.3 1.2 12.6 3.6 18.5L448 400H240.9l11.8-35.4 40.4-13.5c6.5-2.2 10.9-8.3 10.9-15.2s-4.4-13-10.9-15.2l-40.4-13.5-13.5-40.4c-2.2-6.4-8.3-10.8-15.2-10.8s-13 4.4-15.2 10.9l-13.5 40.4-40.4 13.5c-6.5 2.2-10.9 8.3-10.9 15.2s4.4 13 10.9 15.2l40.4 13.5 11.8 35.4H64zm215.6-258.5c-1.1-3.3-4.1-5.5-7.6-5.5s-6.5 2.2-7.6 5.5l-6.7 20.2-20.2 6.7c-3.3 1.1-5.5 4.1-5.5 7.6s2.2 6.5 5.5 7.6l20.2 6.7 6.7 20.2c1.1 3.3 4.1 5.5 7.6 5.5s6.5-2.2 7.6-5.5l6.7-20.2 20.2-6.7c3.3-1.1 5.5-4.1 5.5-7.6s-2.2-6.5-5.5-7.6l-20.2-6.7zM32 448h448c17.7 0 32 14.3 32 32s-14.3 32-32 32H32c-17.7 0-32-14.3-32-32s14.3-32 32-32"></path></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"></path></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Inadvisably Applied Magic
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Upgrading a single-node Kubernetes cluster to Zero Downtime Maintenance
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="deep-purple" data-md-color-accent="green" aria-label="Dark mode" type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 7a5 5 0 0 1 5 5 5 5 0 0 1-5 5 5 5 0 0 1-5-5 5 5 0 0 1 5-5m0 2a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3m0-7 2.39 3.42C13.65 5.15 12.84 5 12 5s-1.65.15-2.39.42zM3.34 7l4.16-.35A7.2 7.2 0 0 0 5.94 8.5c-.44.74-.69 1.5-.83 2.29zm.02 10 1.76-3.77a7.131 7.131 0 0 0 2.38 4.14zM20.65 7l-1.77 3.79a7.02 7.02 0 0 0-2.38-4.15zm-.01 10-4.14.36c.59-.51 1.12-1.14 1.54-1.86.42-.73.69-1.5.83-2.29zM12 22l-2.41-3.44c.74.27 1.55.44 2.41.44.82 0 1.63-.17 2.37-.44z"></path></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="deep-purple" data-md-color-accent="green" aria-label="Light mode" type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m17.75 4.09-2.53 1.94.91 3.06-2.63-1.81-2.63 1.81.91-3.06-2.53-1.94L12.44 4l1.06-3 1.06 3zm3.5 6.91-1.64 1.25.59 1.98-1.7-1.17-1.7 1.17.59-1.98L15.75 11l2.06-.05L18.5 9l.69 1.95zm-2.28 4.95c.83-.08 1.72 1.1 1.19 1.85-.32.45-.66.87-1.08 1.27C15.17 23 8.84 23 4.94 19.07c-3.91-3.9-3.91-10.24 0-14.14.4-.4.82-.76 1.27-1.08.75-.53 1.93.36 1.85 1.19-.27 2.86.69 5.83 2.89 8.02a9.96 9.96 0 0 0 8.02 2.89m-1.64 2.02a12.08 12.08 0 0 1-7.8-3.47c-2.17-2.19-3.33-5-3.49-7.82-2.81 3.14-2.7 7.96.31 10.98 3.02 3.01 7.84 3.12 10.98.31"></path></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"></path></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"></path></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"></path></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"></path></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
                
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" hidden>
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../../../.." title="Inadvisably Applied Magic" class="md-nav__button md-logo" aria-label="Inadvisably Applied Magic" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="m64 400 85.7-208.2c17-41.3 47.8-75.3 87.2-96.3l146.9-78.3c12.3-6.6 26.5 4.7 23 18.2l-37.2 142.4c-1.1 4.1-1.6 8.3-1.6 12.6 0 6.3 1.2 12.6 3.6 18.5L448 400H240.9l11.8-35.4 40.4-13.5c6.5-2.2 10.9-8.3 10.9-15.2s-4.4-13-10.9-15.2l-40.4-13.5-13.5-40.4c-2.2-6.4-8.3-10.8-15.2-10.8s-13 4.4-15.2 10.9l-13.5 40.4-40.4 13.5c-6.5 2.2-10.9 8.3-10.9 15.2s4.4 13 10.9 15.2l40.4 13.5 11.8 35.4H64zm215.6-258.5c-1.1-3.3-4.1-5.5-7.6-5.5s-6.5 2.2-7.6 5.5l-6.7 20.2-20.2 6.7c-3.3 1.1-5.5 4.1-5.5 7.6s2.2 6.5 5.5 7.6l20.2 6.7 6.7 20.2c1.1 3.3 4.1 5.5 7.6 5.5s6.5-2.2 7.6-5.5l6.7-20.2 20.2-6.7c3.3-1.1 5.5-4.1 5.5-7.6s-2.2-6.5-5.5-7.6l-20.2-6.7zM32 448h448c17.7 0 32 14.3 32 32s-14.3 32-32 32H32c-17.7 0-32-14.3-32-32s14.3-32 32-32"></path></svg>

    </a>
    Inadvisably Applied Magic
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    About This Place
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_2">
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Projects
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    Projects
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../projects/conmon/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Continuous Monitoring
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../projects/self-hosting/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Self-hosting
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      <a href="../../../../" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Unexpected Linux Adventures
  

    
  </span>
  
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
                
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#the-pln" class="md-nav__link">
    <span class="md-ellipsis">
      
        The PLN
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="The PLN">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#potential-expansions" class="md-nav__link">
    <span class="md-ellipsis">
      
        Potential expansions
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#reinstall-lexicon" class="md-nav__link">
    <span class="md-ellipsis">
      
        Reinstall lexicon
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Reinstall lexicon">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#update-to-hwe-614-kernel" class="md-nav__link">
    <span class="md-ellipsis">
      
        Update to HWE 6.14 kernel
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#kubernetes" class="md-nav__link">
    <span class="md-ellipsis">
      
        Kubernetes
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Kubernetes">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#bootstrap-with-kubeadm" class="md-nav__link">
    <span class="md-ellipsis">
      
        Bootstrap with kubeadm
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Bootstrap with kubeadm">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#join-as-worker-node" class="md-nav__link">
    <span class="md-ellipsis">
      
        Join as worker node
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#temporary-cordon" class="md-nav__link">
    <span class="md-ellipsis">
      
        Temporary cordon
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#setup-kubectl-access" class="md-nav__link">
    <span class="md-ellipsis">
      
        Setup kubectl access
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#default-pod-distribution" class="md-nav__link">
    <span class="md-ellipsis">
      
        Default pod distribution
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#longhorn" class="md-nav__link">
    <span class="md-ellipsis">
      
        Longhorn
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#intel-gpu" class="md-nav__link">
    <span class="md-ellipsis">
      
        Intel GPU
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Intel GPU">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#logs-reader-helper" class="md-nav__link">
    <span class="md-ellipsis">
      
        Logs reader helper
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#headlamp" class="md-nav__link">
    <span class="md-ellipsis">
      
        Headlamp
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#metrics-server" class="md-nav__link">
    <span class="md-ellipsis">
      
        Metrics Server
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#node-affinity" class="md-nav__link">
    <span class="md-ellipsis">
      
        Node Affinity
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#zero-downtime-reboots" class="md-nav__link">
    <span class="md-ellipsis">
      
        Zero-Downtime Reboots
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Zero-Downtime Reboots">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#tolerations-on-helm-charts" class="md-nav__link">
    <span class="md-ellipsis">
      
        Tolerations on Helm Charts
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#high-availability-ingress" class="md-nav__link">
    <span class="md-ellipsis">
      
        High Availability Ingress
      
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
  <div class="md-content md-content--post" data-md-component="content">
    <div class="md-sidebar md-sidebar--post" data-md-component="sidebar" data-md-type="navigation">
      <div class="md-sidebar__scrollwrap">
        <div class="md-sidebar__inner md-post">
          <nav class="md-nav md-nav--primary">
            <div class="md-post__back">
              <div class="md-nav__title md-nav__container">
                <a href="../../../../" class="md-nav__link">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"></path></svg>
                  <span class="md-ellipsis">
                    Back to index
                  </span>
                </a>
              </div>
            </div>
            
            <ul class="md-post__meta md-nav__list">
              <li class="md-nav__item md-nav__item--section">
                <div class="md-post__title">
                  <span class="md-ellipsis">
                    Metadata
                  </span>
                </div>
                <nav class="md-nav">
                  <ul class="md-nav__list">
                    <li class="md-nav__item">
                      <div class="md-nav__link">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 19H5V8h14m-3-7v2H8V1H6v2H5c-1.11 0-2 .89-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V5a2 2 0 0 0-2-2h-1V1m-1 11h-5v5h5z"></path></svg>
                        <time datetime="2026-02-01 00:00:00+00:00" class="md-ellipsis">February 1, 2026</time>
                      </div>
                    </li>
                    
                    
                      <li class="md-nav__item">
                        <div class="md-nav__link">
                          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9 3v15h3V3zm3 2 4 13 3-1-4-13zM5 5v13h3V5zM3 19v2h18v-2z"></path></svg>
                          <span class="md-ellipsis">
                            in
                            
                              <a href="../../../../category/linux/">linux</a>, 
                              <a href="../../../../category/ubuntu/">Ubuntu</a>, 
                              <a href="../../../../category/server/">Server</a>, 
                              <a href="../../../../category/kubernetes/">kubernetes</a>, 
                              <a href="../../../../category/intel-nuc/">Intel NUC</a></span>
                        </div>
                      </li>
                    
                    
                      
                      <li class="md-nav__item">
                        <div class="md-nav__link">
                          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 20a8 8 0 0 0 8-8 8 8 0 0 0-8-8 8 8 0 0 0-8 8 8 8 0 0 0 8 8m0-18a10 10 0 0 1 10 10 10 10 0 0 1-10 10C6.47 22 2 17.5 2 12A10 10 0 0 1 12 2m.5 5v5.25l4.5 2.67-.75 1.23L11 13V7z"></path></svg>
                          <span class="md-ellipsis">
                            
                              28 min read
                            
                          </span>
                        </div>
                      </li>
                    
                  </ul>
                </nav>
              </li>
            </ul>
            
          </nav>
          
        </div>
      </div>
    </div>
    <article class="md-content__inner md-typeset">
      
        
  




  <h1>Upgrading a single-node Kubernetes cluster to Zero Downtime Maintenance</h1>

<p>Ever since the new, <em>more powerful</em>
<a href="../../../../2025/04/12/kubernetes-homelab-server-with-ubuntu-server-2404-octavo/"><code>octavo</code></a>
replaced the good old
<a href="../../../../2023/03/25/single-node-kubernetes-cluster-on-ubuntu-server-lexicon/"><code>lexicon</code></a>
server as the single-node Kubernetes cluster to serve all the local self-hosting needs,
the latter has not found any use. Since it would be a waste to let it sit in a box
unused, it will be setup to join the (for now) single-node cluster that is <code>octavo</code> to
enable <strong>Zero Downtime Maintenance</strong>.</p>
<!-- more -->

<h2 id="the-pln">The PLN</h2>
<p>The first step will be to have <code>lexicon</code> join the cluster as a worker node, while
keeping <code>octavo</code> as the control plane. Chances are another Intel NUC will join the
cluster later with an intermediate CPU (Intel Core i5) which will bring the total
size of the cluster to the ideal 3: a control plane and two wokers for an
<strong>Active-Passive High Availability</strong> setup.</p>
<p>Nodes with more capable CPU and GPU can be setup to run the more CPU/GPU instensive
workloads, such as Jellyfin (heavy media transcoding), by using <strong>Node Labels</strong> and
<strong>Taints</strong> to ensure high-demand tasks stay on the more capable nodes.</p>
<p>All nodes have direct access to a NAS where all files are available, both NUCs have NVMe
SSDs for the operating system and Kubernetes local persistent volumns, and <code>octavo</code> has
an additional 4TB SATA SSD, a capability unlikely to be added to other nodes in the near
future. Keeping Jellyfin running in <code>octavo</code> should let it stay using the media files
out of the 4TB SATA SSD rather than using the NAS, while most of audio-only media can be
replicated on the NVMe SSDs.</p>
<p>To handle the diverse storage landscape, two <code>StorageClasses</code> will be defined, one for
the NVMe SSD and another one for the <em>bigger but slower</em> SATA SSD. For apps that benefit
from faster SSD, <code>nodeAffinity</code> can force them onto <code>octavo</code>, while <code>lexicon</code> is kept 
exclusively for <em>overflow</em> or light tasks, with a taint to <code>lexicon</code> so that only
specifically <em>tolerated</em> pods will schedule on it.</p>
<h3 id="potential-expansions">Potential expansions</h3>
<p>There is a distinct possibility that a second high-perf NUC (with an Intel Core i5 CPU)
may be added later. In that case, <code>lexicon</code> could be dedicated (mostly) only to run the
control panel, leaving the high-perf NUCs run all the workloads. <strong>Pod Anti-Affinity</strong>
could then be used to ensure that if one of then high-perf nodes goes down, a redundant
copy of critical apps are already running on the second high-perf NUC.</p>
<p>This would then leave <code>lexicon</code> as the third Quorum/Control Plane "witness" node, which
would be useful to avoid "split-brain" issues during network partitions. For a 3-node
Kubernetes cluster to be truly stable (HA), it needs a Quorum (a majority vote) to make
decisions. A "witness" node provides this third vote without needing to be powerful.</p>
<details class="note">
<summary>Alternative devices considered (and discarded).</summary>
<p>There is Raspberry Pi 4 currently available but in has only 2GB or RAM, which is not
enough (too tight) becuase the Kubernetes Control Plane typically takes up to 1.8 GB.
Instead, an old (2016) retired
<a href="https://www.neobyte.es/mini-pc-asus-chromebox-m014u-i3-4010u-4gb-569.html">ASUS Chromebox-M014U</a>
with a Core i3-4010U CPU, 4 GB of RAM and 16 GB SSD, already running
<a href="https://galliumos.org/download">GalliumOS 3.1</a>,
could be enough to run the Control Plane node, but considering the latest release
of GalliumOS 3.1 was released on 2019-12-22, it doesn't seem fit for this purpose.</p>
</details>
<p>If there is a critical hardware failure on <code>lexicon</code>, the cluster <em>degrades</em> but stays
online, management continues without Fault Tolerance. Applications already running on
worker nodes are unaffected by a control plane failure and will continue to run
normally, but if a worker node also fails while the control plane is degraded (only 1
node left), then Kubernetes cannot "self-heal" by rescheduling those pods to <code>octavo</code>
because the "brain" (API server) is inaccessible.</p>
<p>In such event, replacing a failed hardware "witness" is a standard maintenance task:</p>
<ol>
<li>Remove the failed node from the <code>etcd</code> member list using<br>
<code>etcdctl member remove &lt;ID&gt;</code> from one of the healthy NUCs.</li>
<li>Delete the dead node object from Kubernetes using<br>
<code>kubectl delete node &lt;chromebox-name&gt;</code></li>
<li>Bring in a replacement and join it as a new control plane node using<br>
<code>kubeadm join --control-plane</code></li>
</ol>
<h2 id="reinstall-lexicon">Reinstall <code>lexicon</code></h2>
<p><a href="../../../../2022/07/03/low-effort-homelab-server-with-ubuntu-server-on-intel-nuc/"><code>lexicon</code></a>
was running Ubuntu Server 22.04 and was upgraded to 24.04 using the <code>do-release-upgrade</code>
tool but, although the upgrade went well, it did not fix an old issue that caused the NIC
to slowly become more and more overloaded and slow:</p>
<p><a class="glightbox" data-type="image" data-width="auto" data-height="auto" href="../../../../media/2026-02-01-kubernetes-homelab-server-with-ubuntu-server-24-04-lexicon/lexicon-ethernet-problem.png" data-desc-position="bottom"><img alt="" src="../../../../media/2026-02-01-kubernetes-homelab-server-with-ubuntu-server-24-04-lexicon/lexicon-ethernet-problem.png"></a></p>
<p><a href="https://ubuntu.com/tutorials/install-ubuntu-server">Installing Ubuntu Server 24.04</a>
went smoothly and without any problems, the NUC booted from the USB stick and secure
boot, enabled by default, never presented any problem.</p>
<p>Once the intaller boots, the installation steps are:</p>
<ol>
<li>Choose language and keyboard layout.</li>
<li>Choose <strong>Ubuntu Server</strong> (default, not <em>(minimized)</em>).<ul>
<li>Checked the option to <em>Search for third-party drivers</em>.</li>
</ul>
</li>
<li>Networking: DHCP on wired network.<ul>
<li>The <code>enp89s0</code> interface is the NUC's integrated 2.5Gbps NIC (Intel I226-V).</li>
</ul>
</li>
<li>Pick a local Ubuntu mirror to install packages from.</li>
<li>Setup a <strong>Custom storage layout</strong> as follows<ol>
<li>Select the disk (Samsung SSD 970 EVO PLUS 2TB) to <strong>Use As Boot Device</strong>.
    This automatically creates a 1GB partition for <code>/boot/efi</code> (formatted as <code>fat32</code>).</li>
<li>Create a 30G partition to mount as <code>/</code> (formatted as <code>ext4</code>).</li>
<li>Create a 30G partition to reverse for a future OS.</li>
<li>Create a 60G partition to mount as <code>/var/lib</code> (formatted as <code>xfs</code>).</li>
<li>Create a partition with the remaining space (1.7T) to mount as <code>/home</code>
    (formatted as <code>xfs</code>).</li>
</ol>
</li>
<li>Confirm partitions &amp; changes.</li>
<li>Set up a Profile: username (<code>ponder</code>), hostname (<code>lexicon</code>) and password.</li>
<li>Skip Upgrade to Ubuntu Pro (to be done later).</li>
<li>Install OpenSSH server and allow password authentication (for now).</li>
<li>A selection of snap packages is available at this point, none were selected.</li>
<li>Confirm all previous choices and start to <strong>install software</strong>.</li>
<li>Once the installation is complete, remove the UBS stick and hit Enter to reboot.</li>
</ol>
<p>After the first reboot, the server is setup with the same steps as done for <code>octavo</code>:</p>
<ul>
<li>
<p><a href="../../../../2025/04/12/kubernetes-homelab-server-with-ubuntu-server-2404-octavo/#disable-swap">Disable swap</a>.</p>
</li>
<li>
<p><a href="../../../../2025/04/12/kubernetes-homelab-server-with-ubuntu-server-2404-octavo/#tweak-bash-prompt">Tweak Bash prompt</a>.</p>
</li>
<li>
<p><a href="../../../../2025/04/12/kubernetes-homelab-server-with-ubuntu-server-2404-octavo/#tweak-network-config">Tweak OpenSSH server</a> to set the (only) <code>enp89s0</code> interface (Intel 2.5GB NIC)
    with the <code>.6</code>addresses with this Netplan configuration:</p>
<div class="language-yaml highlight"><span class="filename">/etc/netplan/50-cloud-init.yaml</span><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="c1"># Dual static IP on LAN, nothing else.</span>
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a><span class="nt">network</span><span class="p">:</span>
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a><span class="w">  </span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">2</span>
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a><span class="w">  </span><span class="nt">renderer</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">networkd</span>
</span><span id="__span-0-5"><a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a><span class="w">  </span><span class="nt">ethernets</span><span class="p">:</span>
</span><span id="__span-0-6"><a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a><span class="hll"><span class="w">    </span><span class="nt">enp89s0</span><span class="p">:</span>
</span></span><span id="__span-0-7"><a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a><span class="w">      </span><span class="nt">dhcp4</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">no</span>
</span><span id="__span-0-8"><a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a><span class="w">      </span><span class="nt">dhcp6</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">no</span>
</span><span id="__span-0-9"><a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a><span class="w">      </span><span class="c1"># Ser IP address &amp; subnet mask</span>
</span><span id="__span-0-10"><a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a><span class="hll"><span class="w">      </span><span class="nt">addresses</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="w"> </span><span class="nv">10.0.0.6/24</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">192.168.0.6/24</span><span class="w"> </span><span class="p p-Indicator">]</span>
</span></span><span id="__span-0-11"><a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a><span class="w">      </span><span class="c1"># Set default gateway</span>
</span><span id="__span-0-12"><a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a><span class="w">      </span><span class="nt">routes</span><span class="p">:</span>
</span><span id="__span-0-13"><a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">to</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">default</span>
</span><span id="__span-0-14"><a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a><span class="hll"><span class="w">        </span><span class="nt">via</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">192.168.0.1</span><span class="w">  </span><span class="c1"># UniFi router gateway</span>
</span></span><span id="__span-0-15"><a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a><span class="w">      </span><span class="c1"># Set DNS name servers</span>
</span><span id="__span-0-16"><a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a><span class="w">      </span><span class="nt">nameservers</span><span class="p">:</span>
</span><span id="__span-0-17"><a id="__codelineno-0-17" name="__codelineno-0-17" href="#__codelineno-0-17"></a><span class="hll"><span class="w">        </span><span class="nt">addresses</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="w"> </span><span class="nv">77.109.128.2</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">213.144.129.20</span><span class="w"> </span><span class="p p-Indicator">]</span>
</span></span></code></pre></div>
</li>
<li>
<p><a href="../../../../2025/04/12/kubernetes-homelab-server-with-ubuntu-server-2404-octavo/#set-correct-timezone">Set correct timezone</a>.</p>
</li>
<li>
<p><a href="../../../../2025/04/12/kubernetes-homelab-server-with-ubuntu-server-2404-octavo/#update-system-packages">Update system packages</a>.</p>
</li>
<li>
<p><a href="../../../../2025/04/12/kubernetes-homelab-server-with-ubuntu-server-2404-octavo/#upgrade-to-ubuntu-pro">Upgrade to Ubuntu Pro</a>.</p>
</li>
<li>
<p><a href="../../../../2025/04/12/kubernetes-homelab-server-with-ubuntu-server-2404-octavo/#stop-apparmor-spew-in-the-logs">Stop <code>apparmor</code> spew in the logs</a>.</p>
</li>
<li>
<p><a href="../../../../2025/04/12/kubernetes-homelab-server-with-ubuntu-server-2404-octavo/#nas-nfs-mount">Mount the NAS NFS</a>.</p>
</li>
<li>
<p><a href="../../../../../projects/conmon/#install-conmon">Install Continuous Monitoring</a>.</p>
</li>
<li>
<p>Setup Remote Access:
    <a href="../../../../2025/04/12/kubernetes-homelab-server-with-ubuntu-server-2404-octavo/#cloudflare-tunnel">Cloudflare Tunnel</a>
    and
    <a href="../../../../2025/04/12/kubernetes-homelab-server-with-ubuntu-server-2404-octavo/#tailscale">Tailscale</a>.</p>
</li>
</ul>
<h3 id="update-to-hwe-614-kernel">Update to HWE 6.14 kernel</h3>
<p>While the Intel 11th Gen hardware does not require the absolute latest kernel, having
both nodes on the same major kernel branch (e.g. 6.14) simplifies troubleshooting and
ensures CNI and networking features behave identically across the cluster.</p>
<p>Once the system is upgraded to Ubuntu 24.04, switching the kernel is as easy as
<code>apt install linux-generic-hwe-24.04</code> and it even becomes the new default kernel in GRUB:</p>
<details class="terminal">
<summary><code># apt install linux-generic-hwe-24.04 -y</code></summary>
<div class="language-console highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a><span class="gp"># </span>apt<span class="w"> </span>install<span class="w"> </span>linux-generic-hwe-24.04<span class="w"> </span>-y
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a><span class="go">Reading package lists... Done</span>
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a><span class="go">Building dependency tree... Done</span>
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4" href="#__codelineno-1-4"></a><span class="go">Reading state information... Done</span>
</span><span id="__span-1-5"><a id="__codelineno-1-5" name="__codelineno-1-5" href="#__codelineno-1-5"></a><span class="go">The following additional packages will be installed:</span>
</span><span id="__span-1-6"><a id="__codelineno-1-6" name="__codelineno-1-6" href="#__codelineno-1-6"></a><span class="go">  libdebuginfod-common libdebuginfod1t64 linux-headers-6.14.0-37-generic linux-headers-generic-hwe-24.04</span>
</span><span id="__span-1-7"><a id="__codelineno-1-7" name="__codelineno-1-7" href="#__codelineno-1-7"></a><span class="go">  linux-hwe-6.14-headers-6.14.0-37 linux-hwe-6.14-tools-6.14.0-37 linux-image-6.14.0-37-generic</span>
</span><span id="__span-1-8"><a id="__codelineno-1-8" name="__codelineno-1-8" href="#__codelineno-1-8"></a><span class="go">  linux-image-generic-hwe-24.04 linux-modules-6.14.0-37-generic linux-modules-extra-6.14.0-37-generic</span>
</span><span id="__span-1-9"><a id="__codelineno-1-9" name="__codelineno-1-9" href="#__codelineno-1-9"></a><span class="go">  linux-tools-6.14.0-37-generic</span>
</span><span id="__span-1-10"><a id="__codelineno-1-10" name="__codelineno-1-10" href="#__codelineno-1-10"></a><span class="go">Suggested packages:</span>
</span><span id="__span-1-11"><a id="__codelineno-1-11" name="__codelineno-1-11" href="#__codelineno-1-11"></a><span class="go">  linux-hwe-6.14-tools</span>
</span><span id="__span-1-12"><a id="__codelineno-1-12" name="__codelineno-1-12" href="#__codelineno-1-12"></a><span class="go">The following NEW packages will be installed:</span>
</span><span id="__span-1-13"><a id="__codelineno-1-13" name="__codelineno-1-13" href="#__codelineno-1-13"></a><span class="go">  libdebuginfod-common libdebuginfod1t64 linux-generic-hwe-24.04 linux-headers-6.14.0-37-generic</span>
</span><span id="__span-1-14"><a id="__codelineno-1-14" name="__codelineno-1-14" href="#__codelineno-1-14"></a><span class="go">  linux-headers-generic-hwe-24.04 linux-hwe-6.14-headers-6.14.0-37 linux-hwe-6.14-tools-6.14.0-37</span>
</span><span id="__span-1-15"><a id="__codelineno-1-15" name="__codelineno-1-15" href="#__codelineno-1-15"></a><span class="go">  linux-image-6.14.0-37-generic linux-image-generic-hwe-24.04 linux-modules-6.14.0-37-generic</span>
</span><span id="__span-1-16"><a id="__codelineno-1-16" name="__codelineno-1-16" href="#__codelineno-1-16"></a><span class="go">  linux-modules-extra-6.14.0-37-generic linux-tools-6.14.0-37-generic</span>
</span><span id="__span-1-17"><a id="__codelineno-1-17" name="__codelineno-1-17" href="#__codelineno-1-17"></a><span class="go">0 upgraded, 12 newly installed, 0 to remove and 6 not upgraded.</span>
</span><span id="__span-1-18"><a id="__codelineno-1-18" name="__codelineno-1-18" href="#__codelineno-1-18"></a><span class="go">Need to get 0 B/199 MB of archives.</span>
</span><span id="__span-1-19"><a id="__codelineno-1-19" name="__codelineno-1-19" href="#__codelineno-1-19"></a><span class="go">After this operation, 320 MB of additional disk space will be used.</span>
</span><span id="__span-1-20"><a id="__codelineno-1-20" name="__codelineno-1-20" href="#__codelineno-1-20"></a><span class="go">Preconfiguring packages ...</span>
</span><span id="__span-1-21"><a id="__codelineno-1-21" name="__codelineno-1-21" href="#__codelineno-1-21"></a><span class="go">Selecting previously unselected package libdebuginfod-common.</span>
</span><span id="__span-1-22"><a id="__codelineno-1-22" name="__codelineno-1-22" href="#__codelineno-1-22"></a><span class="gp gp-VirtualEnv">(Reading database ... 87562 files and directories currently installed.)</span>
</span><span id="__span-1-23"><a id="__codelineno-1-23" name="__codelineno-1-23" href="#__codelineno-1-23"></a><span class="go">Preparing to unpack .../00-libdebuginfod-common_0.190-1.1ubuntu0.1_all.deb ...</span>
</span><span id="__span-1-24"><a id="__codelineno-1-24" name="__codelineno-1-24" href="#__codelineno-1-24"></a><span class="go">Unpacking libdebuginfod-common (0.190-1.1ubuntu0.1) ...</span>
</span><span id="__span-1-25"><a id="__codelineno-1-25" name="__codelineno-1-25" href="#__codelineno-1-25"></a><span class="go">Selecting previously unselected package libdebuginfod1t64:amd64.</span>
</span><span id="__span-1-26"><a id="__codelineno-1-26" name="__codelineno-1-26" href="#__codelineno-1-26"></a><span class="go">Preparing to unpack .../01-libdebuginfod1t64_0.190-1.1ubuntu0.1_amd64.deb ...</span>
</span><span id="__span-1-27"><a id="__codelineno-1-27" name="__codelineno-1-27" href="#__codelineno-1-27"></a><span class="go">Unpacking libdebuginfod1t64:amd64 (0.190-1.1ubuntu0.1) ...</span>
</span><span id="__span-1-28"><a id="__codelineno-1-28" name="__codelineno-1-28" href="#__codelineno-1-28"></a><span class="go">Selecting previously unselected package linux-modules-6.14.0-37-generic.</span>
</span><span id="__span-1-29"><a id="__codelineno-1-29" name="__codelineno-1-29" href="#__codelineno-1-29"></a><span class="go">Preparing to unpack .../02-linux-modules-6.14.0-37-generic_6.14.0-37.37~24.04.1_amd64.deb ...</span>
</span><span id="__span-1-30"><a id="__codelineno-1-30" name="__codelineno-1-30" href="#__codelineno-1-30"></a><span class="go">Unpacking linux-modules-6.14.0-37-generic (6.14.0-37.37~24.04.1) ...</span>
</span><span id="__span-1-31"><a id="__codelineno-1-31" name="__codelineno-1-31" href="#__codelineno-1-31"></a><span class="go">Selecting previously unselected package linux-image-6.14.0-37-generic.</span>
</span><span id="__span-1-32"><a id="__codelineno-1-32" name="__codelineno-1-32" href="#__codelineno-1-32"></a><span class="go">Preparing to unpack .../03-linux-image-6.14.0-37-generic_6.14.0-37.37~24.04.1_amd64.deb ...</span>
</span><span id="__span-1-33"><a id="__codelineno-1-33" name="__codelineno-1-33" href="#__codelineno-1-33"></a><span class="go">Unpacking linux-image-6.14.0-37-generic (6.14.0-37.37~24.04.1) ...</span>
</span><span id="__span-1-34"><a id="__codelineno-1-34" name="__codelineno-1-34" href="#__codelineno-1-34"></a><span class="go">Selecting previously unselected package linux-modules-extra-6.14.0-37-generic.</span>
</span><span id="__span-1-35"><a id="__codelineno-1-35" name="__codelineno-1-35" href="#__codelineno-1-35"></a><span class="go">Preparing to unpack .../04-linux-modules-extra-6.14.0-37-generic_6.14.0-37.37~24.04.1_amd64.deb ...</span>
</span><span id="__span-1-36"><a id="__codelineno-1-36" name="__codelineno-1-36" href="#__codelineno-1-36"></a><span class="go">Unpacking linux-modules-extra-6.14.0-37-generic (6.14.0-37.37~24.04.1) ...</span>
</span><span id="__span-1-37"><a id="__codelineno-1-37" name="__codelineno-1-37" href="#__codelineno-1-37"></a><span class="go">Selecting previously unselected package linux-image-generic-hwe-24.04.</span>
</span><span id="__span-1-38"><a id="__codelineno-1-38" name="__codelineno-1-38" href="#__codelineno-1-38"></a><span class="go">Preparing to unpack .../05-linux-image-generic-hwe-24.04_6.14.0-37.37~24.04.1_amd64.deb ...</span>
</span><span id="__span-1-39"><a id="__codelineno-1-39" name="__codelineno-1-39" href="#__codelineno-1-39"></a><span class="go">Unpacking linux-image-generic-hwe-24.04 (6.14.0-37.37~24.04.1) ...</span>
</span><span id="__span-1-40"><a id="__codelineno-1-40" name="__codelineno-1-40" href="#__codelineno-1-40"></a><span class="go">Selecting previously unselected package linux-hwe-6.14-headers-6.14.0-37.</span>
</span><span id="__span-1-41"><a id="__codelineno-1-41" name="__codelineno-1-41" href="#__codelineno-1-41"></a><span class="go">Preparing to unpack .../06-linux-hwe-6.14-headers-6.14.0-37_6.14.0-37.37~24.04.1_all.deb ...</span>
</span><span id="__span-1-42"><a id="__codelineno-1-42" name="__codelineno-1-42" href="#__codelineno-1-42"></a><span class="go">Unpacking linux-hwe-6.14-headers-6.14.0-37 (6.14.0-37.37~24.04.1) ...</span>
</span><span id="__span-1-43"><a id="__codelineno-1-43" name="__codelineno-1-43" href="#__codelineno-1-43"></a><span class="go">Selecting previously unselected package linux-headers-6.14.0-37-generic.</span>
</span><span id="__span-1-44"><a id="__codelineno-1-44" name="__codelineno-1-44" href="#__codelineno-1-44"></a><span class="go">Preparing to unpack .../07-linux-headers-6.14.0-37-generic_6.14.0-37.37~24.04.1_amd64.deb ...</span>
</span><span id="__span-1-45"><a id="__codelineno-1-45" name="__codelineno-1-45" href="#__codelineno-1-45"></a><span class="go">Unpacking linux-headers-6.14.0-37-generic (6.14.0-37.37~24.04.1) ...</span>
</span><span id="__span-1-46"><a id="__codelineno-1-46" name="__codelineno-1-46" href="#__codelineno-1-46"></a><span class="go">Selecting previously unselected package linux-headers-generic-hwe-24.04.</span>
</span><span id="__span-1-47"><a id="__codelineno-1-47" name="__codelineno-1-47" href="#__codelineno-1-47"></a><span class="go">Preparing to unpack .../08-linux-headers-generic-hwe-24.04_6.14.0-37.37~24.04.1_amd64.deb ...</span>
</span><span id="__span-1-48"><a id="__codelineno-1-48" name="__codelineno-1-48" href="#__codelineno-1-48"></a><span class="go">Unpacking linux-headers-generic-hwe-24.04 (6.14.0-37.37~24.04.1) ...</span>
</span><span id="__span-1-49"><a id="__codelineno-1-49" name="__codelineno-1-49" href="#__codelineno-1-49"></a><span class="go">Selecting previously unselected package linux-generic-hwe-24.04.</span>
</span><span id="__span-1-50"><a id="__codelineno-1-50" name="__codelineno-1-50" href="#__codelineno-1-50"></a><span class="go">Preparing to unpack .../09-linux-generic-hwe-24.04_6.14.0-37.37~24.04.1_amd64.deb ...</span>
</span><span id="__span-1-51"><a id="__codelineno-1-51" name="__codelineno-1-51" href="#__codelineno-1-51"></a><span class="go">Unpacking linux-generic-hwe-24.04 (6.14.0-37.37~24.04.1) ...</span>
</span><span id="__span-1-52"><a id="__codelineno-1-52" name="__codelineno-1-52" href="#__codelineno-1-52"></a><span class="go">Selecting previously unselected package linux-hwe-6.14-tools-6.14.0-37.</span>
</span><span id="__span-1-53"><a id="__codelineno-1-53" name="__codelineno-1-53" href="#__codelineno-1-53"></a><span class="go">Preparing to unpack .../10-linux-hwe-6.14-tools-6.14.0-37_6.14.0-37.37~24.04.1_amd64.deb ...</span>
</span><span id="__span-1-54"><a id="__codelineno-1-54" name="__codelineno-1-54" href="#__codelineno-1-54"></a><span class="go">Unpacking linux-hwe-6.14-tools-6.14.0-37 (6.14.0-37.37~24.04.1) ...</span>
</span><span id="__span-1-55"><a id="__codelineno-1-55" name="__codelineno-1-55" href="#__codelineno-1-55"></a><span class="go">Selecting previously unselected package linux-tools-6.14.0-37-generic.</span>
</span><span id="__span-1-56"><a id="__codelineno-1-56" name="__codelineno-1-56" href="#__codelineno-1-56"></a><span class="go">Preparing to unpack .../11-linux-tools-6.14.0-37-generic_6.14.0-37.37~24.04.1_amd64.deb ...</span>
</span><span id="__span-1-57"><a id="__codelineno-1-57" name="__codelineno-1-57" href="#__codelineno-1-57"></a><span class="go">Unpacking linux-tools-6.14.0-37-generic (6.14.0-37.37~24.04.1) ...</span>
</span><span id="__span-1-58"><a id="__codelineno-1-58" name="__codelineno-1-58" href="#__codelineno-1-58"></a><span class="go">Setting up libdebuginfod-common (0.190-1.1ubuntu0.1) ...</span>
</span><span id="__span-1-59"><a id="__codelineno-1-59" name="__codelineno-1-59" href="#__codelineno-1-59"></a><span class="go">Setting up linux-hwe-6.14-headers-6.14.0-37 (6.14.0-37.37~24.04.1) ...</span>
</span><span id="__span-1-60"><a id="__codelineno-1-60" name="__codelineno-1-60" href="#__codelineno-1-60"></a><span class="go">Setting up linux-modules-6.14.0-37-generic (6.14.0-37.37~24.04.1) ...</span>
</span><span id="__span-1-61"><a id="__codelineno-1-61" name="__codelineno-1-61" href="#__codelineno-1-61"></a><span class="go">Setting up linux-headers-6.14.0-37-generic (6.14.0-37.37~24.04.1) ...</span>
</span><span id="__span-1-62"><a id="__codelineno-1-62" name="__codelineno-1-62" href="#__codelineno-1-62"></a><span class="go">Setting up libdebuginfod1t64:amd64 (0.190-1.1ubuntu0.1) ...</span>
</span><span id="__span-1-63"><a id="__codelineno-1-63" name="__codelineno-1-63" href="#__codelineno-1-63"></a><span class="go">Setting up linux-image-6.14.0-37-generic (6.14.0-37.37~24.04.1) ...</span>
</span><span id="__span-1-64"><a id="__codelineno-1-64" name="__codelineno-1-64" href="#__codelineno-1-64"></a><span class="go">I: /boot/vmlinuz is now a symlink to vmlinuz-6.14.0-37-generic</span>
</span><span id="__span-1-65"><a id="__codelineno-1-65" name="__codelineno-1-65" href="#__codelineno-1-65"></a><span class="go">I: /boot/initrd.img is now a symlink to initrd.img-6.14.0-37-generic</span>
</span><span id="__span-1-66"><a id="__codelineno-1-66" name="__codelineno-1-66" href="#__codelineno-1-66"></a><span class="go">Setting up linux-modules-extra-6.14.0-37-generic (6.14.0-37.37~24.04.1) ...</span>
</span><span id="__span-1-67"><a id="__codelineno-1-67" name="__codelineno-1-67" href="#__codelineno-1-67"></a><span class="go">Setting up linux-headers-generic-hwe-24.04 (6.14.0-37.37~24.04.1) ...</span>
</span><span id="__span-1-68"><a id="__codelineno-1-68" name="__codelineno-1-68" href="#__codelineno-1-68"></a><span class="go">Setting up linux-hwe-6.14-tools-6.14.0-37 (6.14.0-37.37~24.04.1) ...</span>
</span><span id="__span-1-69"><a id="__codelineno-1-69" name="__codelineno-1-69" href="#__codelineno-1-69"></a><span class="go">Setting up linux-image-generic-hwe-24.04 (6.14.0-37.37~24.04.1) ...</span>
</span><span id="__span-1-70"><a id="__codelineno-1-70" name="__codelineno-1-70" href="#__codelineno-1-70"></a><span class="go">Setting up linux-generic-hwe-24.04 (6.14.0-37.37~24.04.1) ...</span>
</span><span id="__span-1-71"><a id="__codelineno-1-71" name="__codelineno-1-71" href="#__codelineno-1-71"></a><span class="go">Setting up linux-tools-6.14.0-37-generic (6.14.0-37.37~24.04.1) ...</span>
</span><span id="__span-1-72"><a id="__codelineno-1-72" name="__codelineno-1-72" href="#__codelineno-1-72"></a><span class="go">Processing triggers for man-db (2.12.0-4build2) ...</span>
</span><span id="__span-1-73"><a id="__codelineno-1-73" name="__codelineno-1-73" href="#__codelineno-1-73"></a><span class="go">Processing triggers for libc-bin (2.39-0ubuntu8.6) ...</span>
</span><span id="__span-1-74"><a id="__codelineno-1-74" name="__codelineno-1-74" href="#__codelineno-1-74"></a><span class="go">Processing triggers for linux-image-6.14.0-37-generic (6.14.0-37.37~24.04.1) ...</span>
</span><span id="__span-1-75"><a id="__codelineno-1-75" name="__codelineno-1-75" href="#__codelineno-1-75"></a><span class="go">/etc/kernel/postinst.d/initramfs-tools:</span>
</span><span id="__span-1-76"><a id="__codelineno-1-76" name="__codelineno-1-76" href="#__codelineno-1-76"></a><span class="go">update-initramfs: Generating /boot/initrd.img-6.14.0-37-generic</span>
</span><span id="__span-1-77"><a id="__codelineno-1-77" name="__codelineno-1-77" href="#__codelineno-1-77"></a><span class="go">/etc/kernel/postinst.d/zz-update-grub:</span>
</span><span id="__span-1-78"><a id="__codelineno-1-78" name="__codelineno-1-78" href="#__codelineno-1-78"></a><span class="go">Sourcing file `/etc/default/grub'</span>
</span><span id="__span-1-79"><a id="__codelineno-1-79" name="__codelineno-1-79" href="#__codelineno-1-79"></a><span class="go">Generating grub configuration file ...</span>
</span><span id="__span-1-80"><a id="__codelineno-1-80" name="__codelineno-1-80" href="#__codelineno-1-80"></a><span class="go">Found linux image: /boot/vmlinuz-6.14.0-37-generic</span>
</span><span id="__span-1-81"><a id="__codelineno-1-81" name="__codelineno-1-81" href="#__codelineno-1-81"></a><span class="go">Found initrd image: /boot/initrd.img-6.14.0-37-generic</span>
</span><span id="__span-1-82"><a id="__codelineno-1-82" name="__codelineno-1-82" href="#__codelineno-1-82"></a><span class="go">Found linux image: /boot/vmlinuz-6.8.0-94-generic</span>
</span><span id="__span-1-83"><a id="__codelineno-1-83" name="__codelineno-1-83" href="#__codelineno-1-83"></a><span class="go">Found initrd image: /boot/initrd.img-6.8.0-94-generic</span>
</span><span id="__span-1-84"><a id="__codelineno-1-84" name="__codelineno-1-84" href="#__codelineno-1-84"></a><span class="go">Warning: os-prober will not be executed to detect other bootable partitions.</span>
</span><span id="__span-1-85"><a id="__codelineno-1-85" name="__codelineno-1-85" href="#__codelineno-1-85"></a><span class="go">Systems on them will not be added to the GRUB boot configuration.</span>
</span><span id="__span-1-86"><a id="__codelineno-1-86" name="__codelineno-1-86" href="#__codelineno-1-86"></a><span class="go">Check GRUB_DISABLE_OS_PROBER documentation entry.</span>
</span><span id="__span-1-87"><a id="__codelineno-1-87" name="__codelineno-1-87" href="#__codelineno-1-87"></a><span class="go">Adding boot menu entry for UEFI Firmware Settings ...</span>
</span><span id="__span-1-88"><a id="__codelineno-1-88" name="__codelineno-1-88" href="#__codelineno-1-88"></a><span class="go">done</span>
</span><span id="__span-1-89"><a id="__codelineno-1-89" name="__codelineno-1-89" href="#__codelineno-1-89"></a><span class="go">Scanning processes...                                                                                        </span>
</span><span id="__span-1-90"><a id="__codelineno-1-90" name="__codelineno-1-90" href="#__codelineno-1-90"></a><span class="go">Scanning candidates...                                                                                       </span>
</span><span id="__span-1-91"><a id="__codelineno-1-91" name="__codelineno-1-91" href="#__codelineno-1-91"></a><span class="go">Scanning processor microcode...                                                                              </span>
</span><span id="__span-1-92"><a id="__codelineno-1-92" name="__codelineno-1-92" href="#__codelineno-1-92"></a><span class="go">Scanning linux images...                                                                                     </span>
</span><span id="__span-1-93"><a id="__codelineno-1-93" name="__codelineno-1-93" href="#__codelineno-1-93"></a>
</span><span id="__span-1-94"><a id="__codelineno-1-94" name="__codelineno-1-94" href="#__codelineno-1-94"></a><span class="go">Pending kernel upgrade!</span>
</span><span id="__span-1-95"><a id="__codelineno-1-95" name="__codelineno-1-95" href="#__codelineno-1-95"></a><span class="go">Running kernel version:</span>
</span><span id="__span-1-96"><a id="__codelineno-1-96" name="__codelineno-1-96" href="#__codelineno-1-96"></a><span class="go">  6.8.0-94-generic</span>
</span><span id="__span-1-97"><a id="__codelineno-1-97" name="__codelineno-1-97" href="#__codelineno-1-97"></a><span class="go">Diagnostics:</span>
</span><span id="__span-1-98"><a id="__codelineno-1-98" name="__codelineno-1-98" href="#__codelineno-1-98"></a><span class="go">  The currently running kernel version is not the expected kernel version 6.14.0-37-generic.</span>
</span><span id="__span-1-99"><a id="__codelineno-1-99" name="__codelineno-1-99" href="#__codelineno-1-99"></a>
</span><span id="__span-1-100"><a id="__codelineno-1-100" name="__codelineno-1-100" href="#__codelineno-1-100"></a><span class="go">Restarting the system to load the new kernel will not be handled automatically, so you should consider</span>
</span><span id="__span-1-101"><a id="__codelineno-1-101" name="__codelineno-1-101" href="#__codelineno-1-101"></a><span class="go">rebooting.</span>
</span><span id="__span-1-102"><a id="__codelineno-1-102" name="__codelineno-1-102" href="#__codelineno-1-102"></a>
</span><span id="__span-1-103"><a id="__codelineno-1-103" name="__codelineno-1-103" href="#__codelineno-1-103"></a><span class="go">The processor microcode seems to be up-to-date.</span>
</span><span id="__span-1-104"><a id="__codelineno-1-104" name="__codelineno-1-104" href="#__codelineno-1-104"></a>
</span><span id="__span-1-105"><a id="__codelineno-1-105" name="__codelineno-1-105" href="#__codelineno-1-105"></a><span class="go">Restarting services...</span>
</span><span id="__span-1-106"><a id="__codelineno-1-106" name="__codelineno-1-106" href="#__codelineno-1-106"></a>
</span><span id="__span-1-107"><a id="__codelineno-1-107" name="__codelineno-1-107" href="#__codelineno-1-107"></a><span class="go">Service restarts being deferred:</span>
</span><span id="__span-1-108"><a id="__codelineno-1-108" name="__codelineno-1-108" href="#__codelineno-1-108"></a><span class="go">/etc/needrestart/restart.d/dbus.service</span>
</span><span id="__span-1-109"><a id="__codelineno-1-109" name="__codelineno-1-109" href="#__codelineno-1-109"></a><span class="go">systemctl restart getty@tty1.service</span>
</span><span id="__span-1-110"><a id="__codelineno-1-110" name="__codelineno-1-110" href="#__codelineno-1-110"></a><span class="go">systemctl restart systemd-logind.service</span>
</span><span id="__span-1-111"><a id="__codelineno-1-111" name="__codelineno-1-111" href="#__codelineno-1-111"></a><span class="go">systemctl restart unattended-upgrades.service</span>
</span><span id="__span-1-112"><a id="__codelineno-1-112" name="__codelineno-1-112" href="#__codelineno-1-112"></a><span class="go">systemctl restart wpa_supplicant.service</span>
</span><span id="__span-1-113"><a id="__codelineno-1-113" name="__codelineno-1-113" href="#__codelineno-1-113"></a>
</span><span id="__span-1-114"><a id="__codelineno-1-114" name="__codelineno-1-114" href="#__codelineno-1-114"></a><span class="go">No containers need to be restarted.</span>
</span><span id="__span-1-115"><a id="__codelineno-1-115" name="__codelineno-1-115" href="#__codelineno-1-115"></a>
</span><span id="__span-1-116"><a id="__codelineno-1-116" name="__codelineno-1-116" href="#__codelineno-1-116"></a><span class="go">User sessions running outdated binaries:</span>
</span><span id="__span-1-117"><a id="__codelineno-1-117" name="__codelineno-1-117" href="#__codelineno-1-117"></a><span class="go">root @ session #1: sshd[913]</span>
</span><span id="__span-1-118"><a id="__codelineno-1-118" name="__codelineno-1-118" href="#__codelineno-1-118"></a><span class="go">root @ session #4: sshd[1153]</span>
</span><span id="__span-1-119"><a id="__codelineno-1-119" name="__codelineno-1-119" href="#__codelineno-1-119"></a><span class="go">root @ user manager service: systemd[918]</span>
</span><span id="__span-1-120"><a id="__codelineno-1-120" name="__codelineno-1-120" href="#__codelineno-1-120"></a>
</span><span id="__span-1-121"><a id="__codelineno-1-121" name="__codelineno-1-121" href="#__codelineno-1-121"></a><span class="go">No VM guests are running outdated hypervisor (qemu) binaries on this host.</span>
</span></code></pre></div>
</details>
<p>Check what the new default kernel is to make sure it is the newer one:</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a><span class="gp"># </span>awk<span class="w"> </span>-F<span class="s2">"'"</span><span class="w"> </span><span class="s1">'/menuentry / &amp;&amp; /with Linux/ {print i++ " : " $2}'</span><span class="w"> </span><span class="se">\</span>
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a><span class="w">  </span>/boot/grub/grub.cfg
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a><span class="go">0 : Ubuntu, with Linux 6.14.0-37-generic</span>
</span><span id="__span-2-4"><a id="__codelineno-2-4" name="__codelineno-2-4" href="#__codelineno-2-4"></a><span class="go">1 : Ubuntu, with Linux 6.14.0-37-generic (recovery mode)</span>
</span><span id="__span-2-5"><a id="__codelineno-2-5" name="__codelineno-2-5" href="#__codelineno-2-5"></a><span class="go">2 : Ubuntu, with Linux 6.8.0-90-generic</span>
</span><span id="__span-2-6"><a id="__codelineno-2-6" name="__codelineno-2-6" href="#__codelineno-2-6"></a><span class="go">3 : Ubuntu, with Linux 6.8.0-90-generic (recovery mode)</span>
</span></code></pre></div>
<p><strong>Reboot the server to load the new kernel now.</strong></p>
<h2 id="kubernetes">Kubernetes</h2>
<p><a href="../../../../2025/02/22/home-assistant-on-kubernetes-on-raspberry-pi-5-alfred/#kubernetes">Kubernetes on Raspberry Pi 5 (<code>alfred</code>)</a>
showed quite a few <em>new hurdles</em> caused by newer versions of Kubernetes (v1.32.2) and
a few components, but now those have been deprecated, so that following the installation
process from <code>octavo</code> is good enough of a guide.</p>
<p><a href="../../../../2025/04/12/kubernetes-homelab-server-with-ubuntu-server-2404-octavo/#storage-requirements">Storage Requirements</a>
are satisfaied in the same way by having similar partitions setup.</p>
<p><a href="../../../../2025/04/12/kubernetes-homelab-server-with-ubuntu-server-2404-octavo/#install-helm">Install Helm</a>
(via <code>apt</code>) and then
<a href="../../../../2025/04/12/kubernetes-homelab-server-with-ubuntu-server-2404-octavo/#install-kubernetes">install Kubernetes</a>
(also via <code>apt</code>); install Kubernetes version
<a href="../../../01/10/upgrading-single-node-kubernetes-cluster-on-ubuntu-studio-2404-octavo/#upgrade-to-134"><strong>v1.34.3</strong> which is the one running at the moment in the cluster</a>:</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a><span class="gp"># </span>kubectl<span class="w"> </span>version<span class="w"> </span>--output<span class="o">=</span>yaml
</span><span id="__span-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a><span class="go">clientVersion:</span>
</span><span id="__span-3-3"><a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a><span class="go">  buildDate: "2025-12-09T15:06:39Z"</span>
</span><span id="__span-3-4"><a id="__codelineno-3-4" name="__codelineno-3-4" href="#__codelineno-3-4"></a><span class="go">  compiler: gc</span>
</span><span id="__span-3-5"><a id="__codelineno-3-5" name="__codelineno-3-5" href="#__codelineno-3-5"></a><span class="go">  gitCommit: df11db1c0f08fab3c0baee1e5ce6efbf816af7f1</span>
</span><span id="__span-3-6"><a id="__codelineno-3-6" name="__codelineno-3-6" href="#__codelineno-3-6"></a><span class="go">  gitTreeState: clean</span>
</span><span id="__span-3-7"><a id="__codelineno-3-7" name="__codelineno-3-7" href="#__codelineno-3-7"></a><span class="hll"><span class="go">  gitVersion: v1.34.3</span>
</span></span><span id="__span-3-8"><a id="__codelineno-3-8" name="__codelineno-3-8" href="#__codelineno-3-8"></a><span class="go">  goVersion: go1.24.11</span>
</span><span id="__span-3-9"><a id="__codelineno-3-9" name="__codelineno-3-9" href="#__codelineno-3-9"></a><span class="go">  major: "1"</span>
</span><span id="__span-3-10"><a id="__codelineno-3-10" name="__codelineno-3-10" href="#__codelineno-3-10"></a><span class="go">  minor: "34"</span>
</span><span id="__span-3-11"><a id="__codelineno-3-11" name="__codelineno-3-11" href="#__codelineno-3-11"></a><span class="go">  platform: linux/amd64</span>
</span><span id="__span-3-12"><a id="__codelineno-3-12" name="__codelineno-3-12" href="#__codelineno-3-12"></a><span class="go">kustomizeVersion: v5.7.1</span>
</span><span id="__span-3-13"><a id="__codelineno-3-13" name="__codelineno-3-13" href="#__codelineno-3-13"></a>
</span><span id="__span-3-14"><a id="__codelineno-3-14" name="__codelineno-3-14" href="#__codelineno-3-14"></a><span class="go">The connection to the server localhost:8080 was refused - did you specify the right host or port?</span>
</span></code></pre></div>
<p>Finally,
<a href="../../../../2025/04/12/kubernetes-homelab-server-with-ubuntu-server-2404-octavo/#install-container-runtime">install container runtime</a>
and Kubernetes is ready to be initialized.</p>
<h3 id="bootstrap-with-kubeadm">Bootstrap with <code>kubeadm</code></h3>
<p><a href="https://kubernetes.io/docs/tasks/administer-cluster/kubeadm/adding-linux-nodes/">Adding Linux worker nodes</a>
is the next big step towards upgrading the single-node cluster to a multi-node cluster,
so here is where the setup of this node (<code>lexicon</code>) diverges from that of the first node
(<code>octavo</code>).</p>
<h4 id="join-as-worker-node">Join as worker node</h4>
<p>Having initialized the cluster originally in <code>octavo</code> with
<a href="../../../../2025/04/12/kubernetes-homelab-server-with-ubuntu-server-2404-octavo/#initialize-the-control-plane"><code>kubeadm init</code></a>, the first step is to obtain a fresh token to join the
customer (this token expires in 24 hours):</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a><span class="gp">$ </span>kubeadm<span class="w"> </span>token<span class="w"> </span>create<span class="w"> </span>--print-join-command
</span><span id="__span-4-2"><a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a><span class="go">kubeadm join 10.0.0.8:6443 \</span>
</span><span id="__span-4-3"><a id="__codelineno-4-3" name="__codelineno-4-3" href="#__codelineno-4-3"></a><span class="go">  --token ivpct4.7piqcgw68ng77kn5 \</span>
</span><span id="__span-4-4"><a id="__codelineno-4-4" name="__codelineno-4-4" href="#__codelineno-4-4"></a><span class="go">  --discovery-token-ca-cert-hash \</span>
</span><span id="__span-4-5"><a id="__codelineno-4-5" name="__codelineno-4-5" href="#__codelineno-4-5"></a><span class="go">  sha256:18d968e92516e1a2808166d90a7d7c8b6f7b37cbac6328c49793863f9ae2b982 </span>
</span></code></pre></div>
<p>Then run that command on the new node:</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a><span class="gp"># </span>kubeadm<span class="w"> </span>join<span class="w"> </span><span class="m">10</span>.0.0.8:6443<span class="w"> </span><span class="se">\</span>
</span><span id="__span-5-2"><a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a><span class="w">  </span>--token<span class="w"> </span>a0vi2t.rhxs1cc2rkicpeu0<span class="w"> </span><span class="se">\</span>
</span><span id="__span-5-3"><a id="__codelineno-5-3" name="__codelineno-5-3" href="#__codelineno-5-3"></a><span class="w">  </span>--discovery-token-ca-cert-hash<span class="w"> </span><span class="se">\</span>
</span><span id="__span-5-4"><a id="__codelineno-5-4" name="__codelineno-5-4" href="#__codelineno-5-4"></a><span class="w">  </span>sha256:18d968e92516e1a2808166d90a7d7c8b6f7b37cbac6328c49793863f9ae2b982
</span><span id="__span-5-5"><a id="__codelineno-5-5" name="__codelineno-5-5" href="#__codelineno-5-5"></a><span class="go">[preflight] Running pre-flight checks</span>
</span><span id="__span-5-6"><a id="__codelineno-5-6" name="__codelineno-5-6" href="#__codelineno-5-6"></a><span class="go">[preflight] Reading configuration from the "kubeadm-config" ConfigMap in namespace "kube-system"...</span>
</span><span id="__span-5-7"><a id="__codelineno-5-7" name="__codelineno-5-7" href="#__codelineno-5-7"></a><span class="go">[preflight] Use 'kubeadm init phase upload-config kubeadm --config your-config-file' to re-upload it.</span>
</span><span id="__span-5-8"><a id="__codelineno-5-8" name="__codelineno-5-8" href="#__codelineno-5-8"></a><span class="go">[kubelet-start] Writing kubelet configuration to file "/var/lib/kubelet/instance-config.yaml"</span>
</span><span id="__span-5-9"><a id="__codelineno-5-9" name="__codelineno-5-9" href="#__codelineno-5-9"></a><span class="go">[patches] Applied patch of type "application/strategic-merge-patch+json" to target "kubeletconfiguration"</span>
</span><span id="__span-5-10"><a id="__codelineno-5-10" name="__codelineno-5-10" href="#__codelineno-5-10"></a><span class="go">[kubelet-start] Writing kubelet configuration to file "/var/lib/kubelet/config.yaml"</span>
</span><span id="__span-5-11"><a id="__codelineno-5-11" name="__codelineno-5-11" href="#__codelineno-5-11"></a><span class="go">[kubelet-start] Writing kubelet environment file with flags to file "/var/lib/kubelet/kubeadm-flags.env"</span>
</span><span id="__span-5-12"><a id="__codelineno-5-12" name="__codelineno-5-12" href="#__codelineno-5-12"></a><span class="go">[kubelet-start] Starting the kubelet</span>
</span><span id="__span-5-13"><a id="__codelineno-5-13" name="__codelineno-5-13" href="#__codelineno-5-13"></a><span class="go">[kubelet-check] Waiting for a healthy kubelet at http://127.0.0.1:10248/healthz. This can take up to 4m0s</span>
</span><span id="__span-5-14"><a id="__codelineno-5-14" name="__codelineno-5-14" href="#__codelineno-5-14"></a><span class="go">[kubelet-check] The kubelet is healthy after 504.313399ms</span>
</span><span id="__span-5-15"><a id="__codelineno-5-15" name="__codelineno-5-15" href="#__codelineno-5-15"></a><span class="go">[kubelet-start] Waiting for the kubelet to perform the TLS Bootstrap</span>
</span><span id="__span-5-16"><a id="__codelineno-5-16" name="__codelineno-5-16" href="#__codelineno-5-16"></a>
</span><span id="__span-5-17"><a id="__codelineno-5-17" name="__codelineno-5-17" href="#__codelineno-5-17"></a><span class="go">This node has joined the cluster:</span>
</span><span id="__span-5-18"><a id="__codelineno-5-18" name="__codelineno-5-18" href="#__codelineno-5-18"></a><span class="go">* Certificate signing request was sent to apiserver and a response was received.</span>
</span><span id="__span-5-19"><a id="__codelineno-5-19" name="__codelineno-5-19" href="#__codelineno-5-19"></a><span class="go">* The Kubelet was informed of the new secure connection details.</span>
</span><span id="__span-5-20"><a id="__codelineno-5-20" name="__codelineno-5-20" href="#__codelineno-5-20"></a>
</span><span id="__span-5-21"><a id="__codelineno-5-21" name="__codelineno-5-21" href="#__codelineno-5-21"></a><span class="go">Run 'kubectl get nodes' on the control-plane to see this node join the cluster.</span>
</span></code></pre></div>
<p>After a few seconds the new node is ready:</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-6-1"><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a><span class="gp">$ </span>kubectl<span class="w"> </span>get<span class="w"> </span>nodes
</span><span id="__span-6-2"><a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a><span class="go">NAME      STATUS   ROLES           AGE    VERSION</span>
</span><span id="__span-6-3"><a id="__codelineno-6-3" name="__codelineno-6-3" href="#__codelineno-6-3"></a><span class="go">lexicon   Ready    &lt;none&gt;          42s    v1.34.3</span>
</span><span id="__span-6-4"><a id="__codelineno-6-4" name="__codelineno-6-4" href="#__codelineno-6-4"></a><span class="go">octavo    Ready    control-plane   281d   v1.34.3</span>
</span></code></pre></div>
<h4 id="temporary-cordon">Temporary <code>cordon</code></h4>
<p>Even if the new node is <em>ready to run</em> pods, it is not yet ready to satisfy all their
requirements yet; even though all the <code>hostPath</code> volumes have been migrated to
<a href="../../../01/25/migrating-kubernetes-volumes-to-longhorn/">Longhorn</a>, they are not yet
replicated to the new node.</p>
<p>To avoid having pods scheduled in the new node before everything is ready, temporarily
cordon it:</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-7-1"><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a><span class="gp">$ </span>kubectl<span class="w"> </span>cordon<span class="w"> </span>lexicon
</span><span id="__span-7-2"><a id="__codelineno-7-2" name="__codelineno-7-2" href="#__codelineno-7-2"></a><span class="go">node/lexicon cordoned</span>
</span><span id="__span-7-3"><a id="__codelineno-7-3" name="__codelineno-7-3" href="#__codelineno-7-3"></a>
</span><span id="__span-7-4"><a id="__codelineno-7-4" name="__codelineno-7-4" href="#__codelineno-7-4"></a><span class="gp">$ </span>kubectl<span class="w"> </span>get<span class="w"> </span>nodes<span class="w"> </span>-o<span class="w"> </span>wide
</span><span id="__span-7-5"><a id="__codelineno-7-5" name="__codelineno-7-5" href="#__codelineno-7-5"></a><span class="go">NAME      STATUS                     ROLES           AGE    VERSION   INTERNAL-IP   EXTERNAL-IP   OS-IMAGE             KERNEL-VERSION      CONTAINER-RUNTIME</span>
</span><span id="__span-7-6"><a id="__codelineno-7-6" name="__codelineno-7-6" href="#__codelineno-7-6"></a><span class="hll"><span class="go">lexicon   Ready,SchedulingDisabled   &lt;none&gt;          19h    v1.34.3   192.168.0.6   &lt;none&gt;        Ubuntu 24.04.3 LTS   6.14.0-37-generic   containerd://2.2.1</span>
</span></span><span id="__span-7-7"><a id="__codelineno-7-7" name="__codelineno-7-7" href="#__codelineno-7-7"></a><span class="go">octavo    Ready                      control-plane   282d   v1.34.3   192.168.0.8   &lt;none&gt;        Ubuntu 24.04.3 LTS   6.14.0-37-generic   containerd://2.2.1</span>
</span></code></pre></div>
<h4 id="setup-kubectl-access">Setup <code>kubectl</code> access</h4>
<p>To run <code>kubectl</code> as a non-root user, copy the Kubernetes config file under the
<code>~/.kube</code> directory from the currento node to the new one:</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-8-1"><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a><span class="gp">$ </span>scp<span class="w"> </span>-r<span class="w"> </span>.kube/<span class="w"> </span>lexicon:
</span></code></pre></div>
<p>And with that all the <code>kubectl</code> commands work:</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-9-1"><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a><span class="gp">$ </span>kubectl<span class="w"> </span>get<span class="w"> </span>nodes
</span><span id="__span-9-2"><a id="__codelineno-9-2" name="__codelineno-9-2" href="#__codelineno-9-2"></a><span class="go">NAME      STATUS   ROLES           AGE     VERSION</span>
</span><span id="__span-9-3"><a id="__codelineno-9-3" name="__codelineno-9-3" href="#__codelineno-9-3"></a><span class="go">lexicon   Ready    &lt;none&gt;          4m53s   v1.34.3</span>
</span><span id="__span-9-4"><a id="__codelineno-9-4" name="__codelineno-9-4" href="#__codelineno-9-4"></a><span class="go">octavo    Ready    control-plane   281d    v1.34.3</span>
</span><span id="__span-9-5"><a id="__codelineno-9-5" name="__codelineno-9-5" href="#__codelineno-9-5"></a>
</span><span id="__span-9-6"><a id="__codelineno-9-6" name="__codelineno-9-6" href="#__codelineno-9-6"></a><span class="gp">$ </span>kubectl<span class="w"> </span>cluster-info
</span><span id="__span-9-7"><a id="__codelineno-9-7" name="__codelineno-9-7" href="#__codelineno-9-7"></a><span class="go">Kubernetes control plane is running at https://10.0.0.8:6443</span>
</span><span id="__span-9-8"><a id="__codelineno-9-8" name="__codelineno-9-8" href="#__codelineno-9-8"></a><span class="go">CoreDNS is running at https://10.0.0.8:6443/api/v1/namespaces/kube-system/services/kube-dns:dns/proxy</span>
</span><span id="__span-9-9"><a id="__codelineno-9-9" name="__codelineno-9-9" href="#__codelineno-9-9"></a>
</span><span id="__span-9-10"><a id="__codelineno-9-10" name="__codelineno-9-10" href="#__codelineno-9-10"></a><span class="go">To further debug and diagnose cluster problems, use 'kubectl cluster-info dump'.</span>
</span></code></pre></div>
<h3 id="default-pod-distribution">Default pod distribution</h3>
<p>After joining the cluster as a worker node, infrastructure components will behave
differently depending on how they were deployed (<code>DaemonSets</code> vs. <code>Deployments</code>).</p>
<p>Resources deployed as a <code>DaemonSet</code> will immediately spawn a pod on the new node, so
these are the components that will run on <code>lexicon</code> automatically:</p>
<ul>
<li><strong>Flannel</strong>: <code>kube-flannel</code> pod will start to establish the pod network on <code>lexicon</code>.</li>
<li><strong>MetalLB</strong>: The speaker pods will start and <code>lexicon</code> will be able to respond to ARP
    requests for <code>LoadBalancer</code> IPs (once it settles).</li>
<li><strong>Longhorn</strong>: the <code>longhorn-manager</code> and <code>csi-plugin</code> pods will start and Longhorn
    will detect the new 2TB SSD if the Node Labeling Job running or after the node is
    manually labeled.</li>
<li><strong>Intel Device Plugin</strong>: this is an <em>operator-managed</em> <code>DaemonSet</code>, so it will
    detect the GPU and make it available for hardware transcoding (e.g., in Jellyfin).</li>
<li><strong>Prometheus</strong>: a <code>DaemonSet</code> running as part of the
    <a href="../../../../2025/12/21/monitoring-a-kubernetes-cluster-for-vulnerabilities/#trivy-operator-dashboard-in-grafana">Trivy Operator Dashboard in Grafana</a>.</li>
</ul>
<details class="terminal">
<summary><code>kubectl get daemonsets.apps -A</code></summary>
<div class="language-console highlight"><pre><span></span><code><span id="__span-10-1"><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a><span class="gp">$ </span>kubectl<span class="w"> </span>get<span class="w"> </span>daemonsets.apps<span class="w"> </span>-A
</span><span id="__span-10-2"><a id="__codelineno-10-2" name="__codelineno-10-2" href="#__codelineno-10-2"></a><span class="go">NAMESPACE                  NAME                               DESIRED   CURRENT   READY   UP-TO-DATE   AVAILABLE   NODE SELECTOR                               AGE</span>
</span><span id="__span-10-3"><a id="__codelineno-10-3" name="__codelineno-10-3" href="#__codelineno-10-3"></a><span class="go">intel-device-plugins-gpu   intel-gpu-plugin-gpudeviceplugin   1         1         1       1            1           intel.feature.node.kubernetes.io/gpu=true   277d</span>
</span><span id="__span-10-4"><a id="__codelineno-10-4" name="__codelineno-10-4" href="#__codelineno-10-4"></a><span class="go">kube-flannel               kube-flannel-ds                    1         1         1       1            1           &lt;none&gt;                                      281d</span>
</span><span id="__span-10-5"><a id="__codelineno-10-5" name="__codelineno-10-5" href="#__codelineno-10-5"></a><span class="go">kube-system                csi-nfs-node                       1         1         1       1            1           kubernetes.io/os=linux                      8d</span>
</span><span id="__span-10-6"><a id="__codelineno-10-6" name="__codelineno-10-6" href="#__codelineno-10-6"></a><span class="go">kube-system                kube-proxy                         1         1         1       1            1           kubernetes.io/os=linux                      281d</span>
</span><span id="__span-10-7"><a id="__codelineno-10-7" name="__codelineno-10-7" href="#__codelineno-10-7"></a><span class="go">longhorn-system            engine-image-ei-ff1cedad           1         1         1       1            1           &lt;none&gt;                                      2d20h</span>
</span><span id="__span-10-8"><a id="__codelineno-10-8" name="__codelineno-10-8" href="#__codelineno-10-8"></a><span class="go">longhorn-system            longhorn-csi-plugin                1         1         1       1            1           &lt;none&gt;                                      2d20h</span>
</span><span id="__span-10-9"><a id="__codelineno-10-9" name="__codelineno-10-9" href="#__codelineno-10-9"></a><span class="go">longhorn-system            longhorn-manager                   1         1         1       1            1           &lt;none&gt;                                      7d5h</span>
</span><span id="__span-10-10"><a id="__codelineno-10-10" name="__codelineno-10-10" href="#__codelineno-10-10"></a><span class="go">metallb-system             metallb-speaker                    1         1         1       1            1           kubernetes.io/os=linux                      44h</span>
</span><span id="__span-10-11"><a id="__codelineno-10-11" name="__codelineno-10-11" href="#__codelineno-10-11"></a><span class="go">monitoring                 prom-prometheus-node-exporter      1         1         1       1            1           kubernetes.io/os=linux                      42d</span>
</span><span id="__span-10-12"><a id="__codelineno-10-12" name="__codelineno-10-12" href="#__codelineno-10-12"></a><span class="go">node-feature-discovery     node-feature-discovery-worker      1         1         1       1            1           &lt;none&gt;                                      277d</span>
</span></code></pre></div>
</details>
<p>Resources deployed as <code>Deployments</code> (single-replica so far) or <code>StatefulSets</code> will stay
running only on on <code>octavo</code>. Most of these will need to be scaled up to 2+ replicas
before a pod is started on <code>lexicon</code>, with a few notable exceptions:</p>
<ul>
<li><strong>CoreDNS</strong>: Has 2 replicas; Kubernetes will likely move one to <code>lexicon</code> to balance
    the load.</li>
<li><strong>Longhorn UI/Controller</strong>: These central "brains" stay on <code>octavo</code>.</li>
</ul>
<details class="terminal">
<summary><code>kubectl get deployments.apps -A; kubectl get statefulsets.apps -A</code></summary>
<div class="language-console highlight"><pre><span></span><code><span id="__span-11-1"><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a><span class="gp">$ </span>kubectl<span class="w"> </span>get<span class="w"> </span>deployments.apps<span class="w"> </span>-A<span class="w"> </span>
</span><span id="__span-11-2"><a id="__codelineno-11-2" name="__codelineno-11-2" href="#__codelineno-11-2"></a><span class="go">NAMESPACE                  NAME                                    READY   UP-TO-DATE   AVAILABLE   AGE</span>
</span><span id="__span-11-3"><a id="__codelineno-11-3" name="__codelineno-11-3" href="#__codelineno-11-3"></a><span class="go">audiobookshelf             audiobookshelf                          1/1     1            1           279d</span>
</span><span id="__span-11-4"><a id="__codelineno-11-4" name="__codelineno-11-4" href="#__codelineno-11-4"></a><span class="go">cert-manager               cert-manager                            1/1     1            1           281d</span>
</span><span id="__span-11-5"><a id="__codelineno-11-5" name="__codelineno-11-5" href="#__codelineno-11-5"></a><span class="go">cert-manager               cert-manager-cainjector                 1/1     1            1           281d</span>
</span><span id="__span-11-6"><a id="__codelineno-11-6" name="__codelineno-11-6" href="#__codelineno-11-6"></a><span class="go">cert-manager               cert-manager-webhook                    1/1     1            1           281d</span>
</span><span id="__span-11-7"><a id="__codelineno-11-7" name="__codelineno-11-7" href="#__codelineno-11-7"></a><span class="go">cert-manager               cert-manager-webhook-porkbun            1/1     1            1           15d</span>
</span><span id="__span-11-8"><a id="__codelineno-11-8" name="__codelineno-11-8" href="#__codelineno-11-8"></a><span class="go">code-server                code-server                             1/1     1            1           276d</span>
</span><span id="__span-11-9"><a id="__codelineno-11-9" name="__codelineno-11-9" href="#__codelineno-11-9"></a><span class="go">default                    ddns-updater                            1/1     1            1           129d</span>
</span><span id="__span-11-10"><a id="__codelineno-11-10" name="__codelineno-11-10" href="#__codelineno-11-10"></a><span class="go">firefly-iii                firefly-iii                             1/1     1            1           276d</span>
</span><span id="__span-11-11"><a id="__codelineno-11-11" name="__codelineno-11-11" href="#__codelineno-11-11"></a><span class="go">firefly-iii                firefly-iii-mysql                       1/1     1            1           276d</span>
</span><span id="__span-11-12"><a id="__codelineno-11-12" name="__codelineno-11-12" href="#__codelineno-11-12"></a><span class="go">home-assistant             home-assistant                          1/1     1            1           280d</span>
</span><span id="__span-11-13"><a id="__codelineno-11-13" name="__codelineno-11-13" href="#__codelineno-11-13"></a><span class="go">homepage                   homepage                                1/1     1            1           31d</span>
</span><span id="__span-11-14"><a id="__codelineno-11-14" name="__codelineno-11-14" href="#__codelineno-11-14"></a><span class="go">intel-device-plugins-gpu   inteldeviceplugins-controller-manager   1/1     1            1           277d</span>
</span><span id="__span-11-15"><a id="__codelineno-11-15" name="__codelineno-11-15" href="#__codelineno-11-15"></a><span class="go">komga                      komga                                   1/1     1            1           279d</span>
</span><span id="__span-11-16"><a id="__codelineno-11-16" name="__codelineno-11-16" href="#__codelineno-11-16"></a><span class="go">kube-system                coredns                                 2/2     2            2           281d</span>
</span><span id="__span-11-17"><a id="__codelineno-11-17" name="__codelineno-11-17" href="#__codelineno-11-17"></a><span class="go">kube-system                csi-nfs-controller                      1/1     1            1           8d</span>
</span><span id="__span-11-18"><a id="__codelineno-11-18" name="__codelineno-11-18" href="#__codelineno-11-18"></a><span class="go">kube-system                headlamp                                1/1     1            1           22h</span>
</span><span id="__span-11-19"><a id="__codelineno-11-19" name="__codelineno-11-19" href="#__codelineno-11-19"></a><span class="go">kube-system                snapshot-controller                     1/1     1            1           8d</span>
</span><span id="__span-11-20"><a id="__codelineno-11-20" name="__codelineno-11-20" href="#__codelineno-11-20"></a><span class="go">kubernetes-dashboard       kubernetes-dashboard-api                1/1     1            1           281d</span>
</span><span id="__span-11-21"><a id="__codelineno-11-21" name="__codelineno-11-21" href="#__codelineno-11-21"></a><span class="go">kubernetes-dashboard       kubernetes-dashboard-auth               1/1     1            1           281d</span>
</span><span id="__span-11-22"><a id="__codelineno-11-22" name="__codelineno-11-22" href="#__codelineno-11-22"></a><span class="go">kubernetes-dashboard       kubernetes-dashboard-kong               1/1     1            1           281d</span>
</span><span id="__span-11-23"><a id="__codelineno-11-23" name="__codelineno-11-23" href="#__codelineno-11-23"></a><span class="go">kubernetes-dashboard       kubernetes-dashboard-metrics-scraper    1/1     1            1           281d</span>
</span><span id="__span-11-24"><a id="__codelineno-11-24" name="__codelineno-11-24" href="#__codelineno-11-24"></a><span class="go">kubernetes-dashboard       kubernetes-dashboard-web                1/1     1            1           281d</span>
</span><span id="__span-11-25"><a id="__codelineno-11-25" name="__codelineno-11-25" href="#__codelineno-11-25"></a><span class="go">longhorn-system            csi-attacher                            3/3     3            3           2d22h</span>
</span><span id="__span-11-26"><a id="__codelineno-11-26" name="__codelineno-11-26" href="#__codelineno-11-26"></a><span class="go">longhorn-system            csi-provisioner                         3/3     3            3           2d22h</span>
</span><span id="__span-11-27"><a id="__codelineno-11-27" name="__codelineno-11-27" href="#__codelineno-11-27"></a><span class="go">longhorn-system            csi-resizer                             3/3     3            3           2d22h</span>
</span><span id="__span-11-28"><a id="__codelineno-11-28" name="__codelineno-11-28" href="#__codelineno-11-28"></a><span class="go">longhorn-system            csi-snapshotter                         3/3     3            3           2d22h</span>
</span><span id="__span-11-29"><a id="__codelineno-11-29" name="__codelineno-11-29" href="#__codelineno-11-29"></a><span class="go">longhorn-system            longhorn-driver-deployer                1/1     1            1           7d8h</span>
</span><span id="__span-11-30"><a id="__codelineno-11-30" name="__codelineno-11-30" href="#__codelineno-11-30"></a><span class="go">longhorn-system            longhorn-ui                             2/2     2            2           7d8h</span>
</span><span id="__span-11-31"><a id="__codelineno-11-31" name="__codelineno-11-31" href="#__codelineno-11-31"></a><span class="go">media-center               jellyfin                                1/1     1            1           278d</span>
</span><span id="__span-11-32"><a id="__codelineno-11-32" name="__codelineno-11-32" href="#__codelineno-11-32"></a><span class="go">metallb-system             metallb-controller                      1/1     1            1           46h</span>
</span><span id="__span-11-33"><a id="__codelineno-11-33" name="__codelineno-11-33" href="#__codelineno-11-33"></a><span class="go">monitoring                 grafana                                 1/1     1            1           280d</span>
</span><span id="__span-11-34"><a id="__codelineno-11-34" name="__codelineno-11-34" href="#__codelineno-11-34"></a><span class="go">monitoring                 influxdb                                1/1     1            1           280d</span>
</span><span id="__span-11-35"><a id="__codelineno-11-35" name="__codelineno-11-35" href="#__codelineno-11-35"></a><span class="go">monitoring                 prom-kube-prometheus-stack-operator     1/1     1            1           42d</span>
</span><span id="__span-11-36"><a id="__codelineno-11-36" name="__codelineno-11-36" href="#__codelineno-11-36"></a><span class="go">monitoring                 prom-kube-state-metrics                 1/1     1            1           42d</span>
</span><span id="__span-11-37"><a id="__codelineno-11-37" name="__codelineno-11-37" href="#__codelineno-11-37"></a><span class="go">monitoring                 trivy-operator-dashboard                1/1     1            1           42d</span>
</span><span id="__span-11-38"><a id="__codelineno-11-38" name="__codelineno-11-38" href="#__codelineno-11-38"></a><span class="go">monitoring                 version-checker                         1/1     1            1           42d</span>
</span><span id="__span-11-39"><a id="__codelineno-11-39" name="__codelineno-11-39" href="#__codelineno-11-39"></a><span class="go">navidrome                  navidrome                               1/1     1            1           279d</span>
</span><span id="__span-11-40"><a id="__codelineno-11-40" name="__codelineno-11-40" href="#__codelineno-11-40"></a><span class="go">node-feature-discovery     node-feature-discovery-gc               1/1     1            1           278d</span>
</span><span id="__span-11-41"><a id="__codelineno-11-41" name="__codelineno-11-41" href="#__codelineno-11-41"></a><span class="go">node-feature-discovery     node-feature-discovery-master           1/1     1            1           278d</span>
</span><span id="__span-11-42"><a id="__codelineno-11-42" name="__codelineno-11-42" href="#__codelineno-11-42"></a><span class="go">pomerium                   pomerium                                1/1     1            1           45d</span>
</span><span id="__span-11-43"><a id="__codelineno-11-43" name="__codelineno-11-43" href="#__codelineno-11-43"></a><span class="go">ryot                       postgres                                1/1     1            1           227d</span>
</span><span id="__span-11-44"><a id="__codelineno-11-44" name="__codelineno-11-44" href="#__codelineno-11-44"></a><span class="go">ryot                       ryot                                    1/1     1            1           227d</span>
</span><span id="__span-11-45"><a id="__codelineno-11-45" name="__codelineno-11-45" href="#__codelineno-11-45"></a><span class="go">tailscale                  operator                                1/1     1            1           281d</span>
</span><span id="__span-11-46"><a id="__codelineno-11-46" name="__codelineno-11-46" href="#__codelineno-11-46"></a><span class="go">trivy-system               trivy-operator                          1/1     1            1           42d</span>
</span><span id="__span-11-47"><a id="__codelineno-11-47" name="__codelineno-11-47" href="#__codelineno-11-47"></a><span class="go">unifi                      mongo                                   1/1     1            1           276d</span>
</span><span id="__span-11-48"><a id="__codelineno-11-48" name="__codelineno-11-48" href="#__codelineno-11-48"></a><span class="go">unifi                      unifi                                   1/1     1            1           276d</span>
</span><span id="__span-11-49"><a id="__codelineno-11-49" name="__codelineno-11-49" href="#__codelineno-11-49"></a>
</span><span id="__span-11-50"><a id="__codelineno-11-50" name="__codelineno-11-50" href="#__codelineno-11-50"></a><span class="gp">$ </span>kubectl<span class="w"> </span>get<span class="w"> </span>statefulsets.apps<span class="w"> </span>-A<span class="w"> </span>
</span><span id="__span-11-51"><a id="__codelineno-11-51" name="__codelineno-11-51" href="#__codelineno-11-51"></a><span class="go">NAMESPACE        NAME                                                   READY   AGE</span>
</span><span id="__span-11-52"><a id="__codelineno-11-52" name="__codelineno-11-52" href="#__codelineno-11-52"></a><span class="go">monitoring       alertmanager-prom-kube-prometheus-stack-alertmanager   1/1     42d</span>
</span><span id="__span-11-53"><a id="__codelineno-11-53" name="__codelineno-11-53" href="#__codelineno-11-53"></a><span class="go">monitoring       prometheus-prom-kube-prometheus-stack-prometheus       1/1     42d</span>
</span><span id="__span-11-54"><a id="__codelineno-11-54" name="__codelineno-11-54" href="#__codelineno-11-54"></a><span class="go">steam-headless   steam-headless                                         0/0     188d</span>
</span><span id="__span-11-55"><a id="__codelineno-11-55" name="__codelineno-11-55" href="#__codelineno-11-55"></a><span class="go">tailscale        ts-home-assistant-tailscale-mdqlt                      1/1     280d</span>
</span><span id="__span-11-56"><a id="__codelineno-11-56" name="__codelineno-11-56" href="#__codelineno-11-56"></a><span class="go">tailscale        ts-kubernetes-dashboard-ingress-tailscale-jhb6z        1/1     281d</span>
</span></code></pre></div>
</details>
<h3 id="longhorn">Longhorn</h3>
<p>Longhorn needs to know the new node is ready for data; to activate Longhorn storage on
the new node it need to be labeled:</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-12-1"><a id="__codelineno-12-1" name="__codelineno-12-1" href="#__codelineno-12-1"></a><span class="gp"># </span>kubectl<span class="w"> </span>label<span class="w"> </span>node<span class="w"> </span>lexicon<span class="w"> </span>node.longhorn.io/create-default-disk<span class="o">=</span><span class="nb">true</span>
</span><span id="__span-12-2"><a id="__codelineno-12-2" name="__codelineno-12-2" href="#__codelineno-12-2"></a><span class="go">node/lexicon labeled</span>
</span></code></pre></div>
<p>Once the node is labeled, the Longhorn UI will immediately show that the node now has one
disk (<code>/home/longhorn</code>). The new disk will not automatically get any <strong>Disk Tag</strong> so the
<code>nvme</code> must be manually added so that the disk fits the <code>longhorn-nmve</code> storage class.</p>
<p>Once the node is ready and the 2TB SSD disk is ready and tagged, existing volumes can be
<em>rescaled</em> up by increasint the value of <code>numberOfReplicas</code> in the relevant volumes or
even on the <code>longhorn-nmve</code> storage class:</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-13-1"><a id="__codelineno-13-1" name="__codelineno-13-1" href="#__codelineno-13-1"></a><span class="gp">$ </span>kubectl<span class="w"> </span>patch<span class="w"> </span>storageclass<span class="w"> </span>longhorn-nvme<span class="w"> </span>--type<span class="w"> </span>merge<span class="w"> </span><span class="se">\</span>
</span><span id="__span-13-2"><a id="__codelineno-13-2" name="__codelineno-13-2" href="#__codelineno-13-2"></a><span class="w">  </span>-p<span class="w"> </span><span class="s1">'{"parameters":{"numberOfReplicas":"2"}}'</span>
</span></code></pre></div>
<p>This can also be done by updating y reapplying the <code>longhorn-storage.yaml</code> manifest
created when 
<a href="../../../01/25/migrating-kubernetes-volumes-to-longhorn/">migratng <code>hostPaht</code> volumes to Longhorn</a>:</p>
<div class="admonition k8s">
<p class="admonition-title"><code>longhorn-storage.yaml</code></p>
<div class="language-yaml highlight"><pre><span></span><code><span id="__span-14-1"><a id="__codelineno-14-1" name="__codelineno-14-1" href="#__codelineno-14-1"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">storage.k8s.io/v1</span>
</span><span id="__span-14-2"><a id="__codelineno-14-2" name="__codelineno-14-2" href="#__codelineno-14-2"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">StorageClass</span>
</span><span id="__span-14-3"><a id="__codelineno-14-3" name="__codelineno-14-3" href="#__codelineno-14-3"></a><span class="nt">metadata</span><span class="p">:</span>
</span><span id="__span-14-4"><a id="__codelineno-14-4" name="__codelineno-14-4" href="#__codelineno-14-4"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">longhorn-nvme</span>
</span><span id="__span-14-5"><a id="__codelineno-14-5" name="__codelineno-14-5" href="#__codelineno-14-5"></a><span class="nt">provisioner</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">driver.longhorn.io</span>
</span><span id="__span-14-6"><a id="__codelineno-14-6" name="__codelineno-14-6" href="#__codelineno-14-6"></a><span class="nt">allowVolumeExpansion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
</span><span id="__span-14-7"><a id="__codelineno-14-7" name="__codelineno-14-7" href="#__codelineno-14-7"></a><span class="nt">parameters</span><span class="p">:</span>
</span><span id="__span-14-8"><a id="__codelineno-14-8" name="__codelineno-14-8" href="#__codelineno-14-8"></a><span class="hll"><span class="w">  </span><span class="nt">numberOfReplicas</span><span class="p">:</span><span class="w"> </span><span class="s">"2"</span>
</span></span><span id="__span-14-9"><a id="__codelineno-14-9" name="__codelineno-14-9" href="#__codelineno-14-9"></a><span class="w">  </span><span class="nt">diskSelector</span><span class="p">:</span><span class="w"> </span><span class="s">"nvme"</span>
</span><span id="__span-14-10"><a id="__codelineno-14-10" name="__codelineno-14-10" href="#__codelineno-14-10"></a><span class="w">  </span><span class="nt">dataLocality</span><span class="p">:</span><span class="w"> </span><span class="s">"best-effort"</span>
</span><span id="__span-14-11"><a id="__codelineno-14-11" name="__codelineno-14-11" href="#__codelineno-14-11"></a><span class="nn">---</span>
</span><span id="__span-14-12"><a id="__codelineno-14-12" name="__codelineno-14-12" href="#__codelineno-14-12"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">storage.k8s.io/v1</span>
</span><span id="__span-14-13"><a id="__codelineno-14-13" name="__codelineno-14-13" href="#__codelineno-14-13"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">StorageClass</span>
</span><span id="__span-14-14"><a id="__codelineno-14-14" name="__codelineno-14-14" href="#__codelineno-14-14"></a><span class="nt">metadata</span><span class="p">:</span>
</span><span id="__span-14-15"><a id="__codelineno-14-15" name="__codelineno-14-15" href="#__codelineno-14-15"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">longhorn-sata</span>
</span><span id="__span-14-16"><a id="__codelineno-14-16" name="__codelineno-14-16" href="#__codelineno-14-16"></a><span class="nt">provisioner</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">driver.longhorn.io</span>
</span><span id="__span-14-17"><a id="__codelineno-14-17" name="__codelineno-14-17" href="#__codelineno-14-17"></a><span class="nt">allowVolumeExpansion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
</span><span id="__span-14-18"><a id="__codelineno-14-18" name="__codelineno-14-18" href="#__codelineno-14-18"></a><span class="nt">parameters</span><span class="p">:</span>
</span><span id="__span-14-19"><a id="__codelineno-14-19" name="__codelineno-14-19" href="#__codelineno-14-19"></a><span class="w">  </span><span class="nt">numberOfReplicas</span><span class="p">:</span><span class="w"> </span><span class="s">"1"</span>
</span><span id="__span-14-20"><a id="__codelineno-14-20" name="__codelineno-14-20" href="#__codelineno-14-20"></a><span class="w">  </span><span class="nt">diskSelector</span><span class="p">:</span><span class="w"> </span><span class="s">"sata"</span>
</span><span id="__span-14-21"><a id="__codelineno-14-21" name="__codelineno-14-21" href="#__codelineno-14-21"></a><span class="w">  </span><span class="nt">dataLocality</span><span class="p">:</span><span class="w"> </span><span class="s">"best-effort"</span>
</span></code></pre></div>
</div>
<p>However, one does not simply <em>modify</em> a <code>StorageClass</code>:</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-15-1"><a id="__codelineno-15-1" name="__codelineno-15-1" href="#__codelineno-15-1"></a><span class="gp">$ </span>kubectl<span class="w"> </span>apply<span class="w"> </span>-f<span class="w"> </span>longhorn-storage.yaml
</span><span id="__span-15-2"><a id="__codelineno-15-2" name="__codelineno-15-2" href="#__codelineno-15-2"></a><span class="go">The StorageClass "longhorn-nvme" is invalid: parameters: Forbidden: updates to parameters are forbidden.</span>
</span></code></pre></div>
<p>Instead, the <code>StorageClass</code> must be deleted, then recreated anew; this does not affect
existing volumes, only those that are created later:</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-16-1"><a id="__codelineno-16-1" name="__codelineno-16-1" href="#__codelineno-16-1"></a><span class="gp">$ </span>kubectl<span class="w"> </span>delete<span class="w"> </span>storageclass<span class="w"> </span>longhorn-nvme
</span><span id="__span-16-2"><a id="__codelineno-16-2" name="__codelineno-16-2" href="#__codelineno-16-2"></a><span class="go">storageclass.storage.k8s.io "longhorn-nvme" deleted</span>
</span><span id="__span-16-3"><a id="__codelineno-16-3" name="__codelineno-16-3" href="#__codelineno-16-3"></a>
</span><span id="__span-16-4"><a id="__codelineno-16-4" name="__codelineno-16-4" href="#__codelineno-16-4"></a><span class="gp">$ </span>kubectl<span class="w"> </span>apply<span class="w"> </span>-f<span class="w"> </span>longhorn-storage.yaml<span class="w"> </span>
</span><span id="__span-16-5"><a id="__codelineno-16-5" name="__codelineno-16-5" href="#__codelineno-16-5"></a><span class="go">storageclass.storage.k8s.io/longhorn-nvme created</span>
</span><span id="__span-16-6"><a id="__codelineno-16-6" name="__codelineno-16-6" href="#__codelineno-16-6"></a><span class="go">storageclass.storage.k8s.io/longhorn-sata unchanged</span>
</span></code></pre></div>
<p>Since this does not affect existing volumes, Longhorn will not immediately start
replicating the volumes from <code>octavo</code> to <code>lexicon</code>; this needs to be done manually for
each existing volume by <code>patch</code>ing it; with the caveat that volumes on the SATA SSD are
<strong>not</strong> to be replicated:</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-17-1"><a id="__codelineno-17-1" name="__codelineno-17-1" href="#__codelineno-17-1"></a><span class="gp">$ </span>kubectl<span class="w"> </span>get<span class="w"> </span>volumes.longhorn.io<span class="w"> </span>-n<span class="w"> </span>longhorn-system<span class="w"> </span>-o<span class="w"> </span>json<span class="w"> </span><span class="se">\</span>
</span><span id="__span-17-2"><a id="__codelineno-17-2" name="__codelineno-17-2" href="#__codelineno-17-2"></a><span class="p">|</span><span class="w"> </span>jq<span class="w"> </span>-r<span class="w"> </span><span class="s1">'.items[] | select(.spec.numberOfReplicas==1 and (.spec.diskSelector | contains(["nvme"]))) | .metadata.name'</span><span class="w"> </span><span class="se">\</span>
</span><span id="__span-17-3"><a id="__codelineno-17-3" name="__codelineno-17-3" href="#__codelineno-17-3"></a><span class="p">|</span><span class="w"> </span>xargs<span class="w"> </span>-I<span class="w"> </span><span class="o">{}</span><span class="w"> </span>kubectl<span class="w"> </span>-n<span class="w"> </span>longhorn-system<span class="w"> </span>patch<span class="w"> </span>volumes.longhorn.io<span class="w"> </span><span class="o">{}</span><span class="w"> </span><span class="se">\</span>
</span><span id="__span-17-4"><a id="__codelineno-17-4" name="__codelineno-17-4" href="#__codelineno-17-4"></a><span class="w">  </span>--type<span class="w"> </span>merge<span class="w"> </span>-p<span class="w"> </span><span class="s1">'{"spec":{"numberOfReplicas":2}}'</span>
</span><span id="__span-17-5"><a id="__codelineno-17-5" name="__codelineno-17-5" href="#__codelineno-17-5"></a><span class="go">volume.longhorn.io/pvc-0c892178-0451-4043-be76-9e2e33464631 patched</span>
</span><span id="__span-17-6"><a id="__codelineno-17-6" name="__codelineno-17-6" href="#__codelineno-17-6"></a><span class="go">volume.longhorn.io/pvc-1083fedd-27e9-4a58-8a8f-6b8553d62034 patched</span>
</span><span id="__span-17-7"><a id="__codelineno-17-7" name="__codelineno-17-7" href="#__codelineno-17-7"></a><span class="go">volume.longhorn.io/pvc-17d73e68-4c5a-4f34-b5dc-89936202d8d7 patched</span>
</span><span id="__span-17-8"><a id="__codelineno-17-8" name="__codelineno-17-8" href="#__codelineno-17-8"></a><span class="go">volume.longhorn.io/pvc-1d7dc891-4694-4744-be75-6ab12c11aea9 patched</span>
</span><span id="__span-17-9"><a id="__codelineno-17-9" name="__codelineno-17-9" href="#__codelineno-17-9"></a><span class="go">volume.longhorn.io/pvc-2610bf0b-0c90-4ecb-956c-355d8619dbe4 patched</span>
</span><span id="__span-17-10"><a id="__codelineno-17-10" name="__codelineno-17-10" href="#__codelineno-17-10"></a><span class="go">volume.longhorn.io/pvc-2b72de1d-93d8-492e-aed1-1708a35ce5b4 patched</span>
</span><span id="__span-17-11"><a id="__codelineno-17-11" name="__codelineno-17-11" href="#__codelineno-17-11"></a><span class="go">volume.longhorn.io/pvc-2e7cd0bd-6efe-4e8b-ae81-a025b447a7f9 patched</span>
</span><span id="__span-17-12"><a id="__codelineno-17-12" name="__codelineno-17-12" href="#__codelineno-17-12"></a><span class="go">volume.longhorn.io/pvc-43916c81-6e07-4eae-92e4-e37b816c407c patched</span>
</span><span id="__span-17-13"><a id="__codelineno-17-13" name="__codelineno-17-13" href="#__codelineno-17-13"></a><span class="go">volume.longhorn.io/pvc-495872f3-cf95-4268-b3ea-2f4d51d33399 patched</span>
</span><span id="__span-17-14"><a id="__codelineno-17-14" name="__codelineno-17-14" href="#__codelineno-17-14"></a><span class="go">volume.longhorn.io/pvc-5c724ff5-e7dd-483b-9450-0b8e299c49ca patched</span>
</span><span id="__span-17-15"><a id="__codelineno-17-15" name="__codelineno-17-15" href="#__codelineno-17-15"></a><span class="go">volume.longhorn.io/pvc-5dd1e736-b80b-43a8-9570-95a3637cff4d patched</span>
</span><span id="__span-17-16"><a id="__codelineno-17-16" name="__codelineno-17-16" href="#__codelineno-17-16"></a><span class="go">volume.longhorn.io/pvc-6250f010-4a0b-4ac5-83a6-07cf71d95b33 patched</span>
</span><span id="__span-17-17"><a id="__codelineno-17-17" name="__codelineno-17-17" href="#__codelineno-17-17"></a><span class="go">volume.longhorn.io/pvc-726c1b2d-c0c0-4232-85f5-b3119558d0d1 patched</span>
</span><span id="__span-17-18"><a id="__codelineno-17-18" name="__codelineno-17-18" href="#__codelineno-17-18"></a><span class="go">volume.longhorn.io/pvc-72741e77-c05c-4b84-b74d-bddcf32a2236 patched</span>
</span><span id="__span-17-19"><a id="__codelineno-17-19" name="__codelineno-17-19" href="#__codelineno-17-19"></a><span class="go">volume.longhorn.io/pvc-7ae11ade-d6c8-4296-ac67-58953e3dddc2 patched</span>
</span><span id="__span-17-20"><a id="__codelineno-17-20" name="__codelineno-17-20" href="#__codelineno-17-20"></a><span class="go">volume.longhorn.io/pvc-aea4a7e9-baf0-4fbc-ba5f-7007a66fcef6 patched</span>
</span><span id="__span-17-21"><a id="__codelineno-17-21" name="__codelineno-17-21" href="#__codelineno-17-21"></a><span class="go">volume.longhorn.io/pvc-e3f04fc3-9126-43d6-82c0-c427a730b338 patched</span>
</span><span id="__span-17-22"><a id="__codelineno-17-22" name="__codelineno-17-22" href="#__codelineno-17-22"></a><span class="go">volume.longhorn.io/pvc-fd8bb4e8-39a4-4b7f-a3c5-668333e4d64a patched</span>
</span></code></pre></div>
<p>Doing this will result in all those volumes going from <strong>Healthy</strong> to <strong>Degraded</strong>.
Because <code>lexicon</code> was previously <em>cordoned</em> to avoid pods running on it before the
volumes were ready, this also means the Kubernetes scheduler (and by extension the
Longhorn scheduler) is forbidden from starting the <strong>Replica Instance Manager</strong> pods;
so now is the time to uncordon <code>lexicon</code>.</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-18-1"><a id="__codelineno-18-1" name="__codelineno-18-1" href="#__codelineno-18-1"></a><span class="gp">$ </span>kubectl<span class="w"> </span>uncordon<span class="w"> </span>lexicon<span class="w"> </span>
</span><span id="__span-18-2"><a id="__codelineno-18-2" name="__codelineno-18-2" href="#__codelineno-18-2"></a><span class="go">node/lexicon already uncordoned</span>
</span></code></pre></div>
<p>This launches Longhorn into <em>an I/O frenzy</em> to replicate all those volumes and keeps the
2.5 Gbps NICs at their maximum throughput for 8 minutes to replicate about 250 GB first,
then stays at nearly the maximum for over an hour to finish replicating the last volume,
much larger than the rest, until eventually all volumes are <strong>Healthy</strong> again.</p>
<h3 id="intel-gpu">Intel GPU</h3>
<p>Support for the Intel GPU works automatically when joining the node:</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-19-1"><a id="__codelineno-19-1" name="__codelineno-19-1" href="#__codelineno-19-1"></a><span class="gp">$ </span>kubectl<span class="w"> </span>describe<span class="w"> </span>node<span class="w"> </span>lexicon
</span><span id="__span-19-2"><a id="__codelineno-19-2" name="__codelineno-19-2" href="#__codelineno-19-2"></a><span class="go">Name:               lexicon</span>
</span><span id="__span-19-3"><a id="__codelineno-19-3" name="__codelineno-19-3" href="#__codelineno-19-3"></a><span class="go">Roles:              &lt;none&gt;</span>
</span><span id="__span-19-4"><a id="__codelineno-19-4" name="__codelineno-19-4" href="#__codelineno-19-4"></a><span class="go">Labels:             beta.kubernetes.io/arch=amd64</span>
</span><span id="__span-19-5"><a id="__codelineno-19-5" name="__codelineno-19-5" href="#__codelineno-19-5"></a><span class="go">                    ...</span>
</span><span id="__span-19-6"><a id="__codelineno-19-6" name="__codelineno-19-6" href="#__codelineno-19-6"></a><span class="hll"><span class="go">                    gpu.intel.com/device-id.0300-9a78.count=1</span>
</span></span><span id="__span-19-7"><a id="__codelineno-19-7" name="__codelineno-19-7" href="#__codelineno-19-7"></a><span class="hll"><span class="go">                    gpu.intel.com/device-id.0300-9a78.present=true</span>
</span></span><span id="__span-19-8"><a id="__codelineno-19-8" name="__codelineno-19-8" href="#__codelineno-19-8"></a><span class="hll"><span class="go">                    intel.feature.node.kubernetes.io/gpu=true</span>
</span></span><span id="__span-19-9"><a id="__codelineno-19-9" name="__codelineno-19-9" href="#__codelineno-19-9"></a><span class="hll"><span class="go">...</span>
</span></span><span id="__span-19-10"><a id="__codelineno-19-10" name="__codelineno-19-10" href="#__codelineno-19-10"></a><span class="go">Capacity:</span>
</span><span id="__span-19-11"><a id="__codelineno-19-11" name="__codelineno-19-11" href="#__codelineno-19-11"></a><span class="go">  cpu:                            4</span>
</span><span id="__span-19-12"><a id="__codelineno-19-12" name="__codelineno-19-12" href="#__codelineno-19-12"></a><span class="go">  ephemeral-storage:              61376Mi</span>
</span><span id="__span-19-13"><a id="__codelineno-19-13" name="__codelineno-19-13" href="#__codelineno-19-13"></a><span class="hll"><span class="go">  gpu.intel.com/i915:             1</span>
</span></span><span id="__span-19-14"><a id="__codelineno-19-14" name="__codelineno-19-14" href="#__codelineno-19-14"></a><span class="hll"><span class="go">  gpu.intel.com/i915_monitoring:  1</span>
</span></span><span id="__span-19-15"><a id="__codelineno-19-15" name="__codelineno-19-15" href="#__codelineno-19-15"></a><span class="go">  hugepages-1Gi:                  0</span>
</span><span id="__span-19-16"><a id="__codelineno-19-16" name="__codelineno-19-16" href="#__codelineno-19-16"></a><span class="go">  hugepages-2Mi:                  0</span>
</span><span id="__span-19-17"><a id="__codelineno-19-17" name="__codelineno-19-17" href="#__codelineno-19-17"></a><span class="go">  memory:                         32484920Ki</span>
</span><span id="__span-19-18"><a id="__codelineno-19-18" name="__codelineno-19-18" href="#__codelineno-19-18"></a><span class="go">  pods:                           110</span>
</span><span id="__span-19-19"><a id="__codelineno-19-19" name="__codelineno-19-19" href="#__codelineno-19-19"></a><span class="go">Allocatable:</span>
</span><span id="__span-19-20"><a id="__codelineno-19-20" name="__codelineno-19-20" href="#__codelineno-19-20"></a><span class="go">  cpu:                            4</span>
</span><span id="__span-19-21"><a id="__codelineno-19-21" name="__codelineno-19-21" href="#__codelineno-19-21"></a><span class="go">  ephemeral-storage:              57921660423</span>
</span><span id="__span-19-22"><a id="__codelineno-19-22" name="__codelineno-19-22" href="#__codelineno-19-22"></a><span class="hll"><span class="go">  gpu.intel.com/i915:             1</span>
</span></span><span id="__span-19-23"><a id="__codelineno-19-23" name="__codelineno-19-23" href="#__codelineno-19-23"></a><span class="hll"><span class="go">  gpu.intel.com/i915_monitoring:  1</span>
</span></span><span id="__span-19-24"><a id="__codelineno-19-24" name="__codelineno-19-24" href="#__codelineno-19-24"></a><span class="go">  hugepages-1Gi:                  0</span>
</span><span id="__span-19-25"><a id="__codelineno-19-25" name="__codelineno-19-25" href="#__codelineno-19-25"></a><span class="go">  hugepages-2Mi:                  0</span>
</span><span id="__span-19-26"><a id="__codelineno-19-26" name="__codelineno-19-26" href="#__codelineno-19-26"></a><span class="go">  memory:                         32382520Ki</span>
</span><span id="__span-19-27"><a id="__codelineno-19-27" name="__codelineno-19-27" href="#__codelineno-19-27"></a><span class="go">  pods:                           110</span>
</span><span id="__span-19-28"><a id="__codelineno-19-28" name="__codelineno-19-28" href="#__codelineno-19-28"></a><span class="go">...</span>
</span><span id="__span-19-29"><a id="__codelineno-19-29" name="__codelineno-19-29" href="#__codelineno-19-29"></a><span class="go">Allocated resources:</span>
</span><span id="__span-19-30"><a id="__codelineno-19-30" name="__codelineno-19-30" href="#__codelineno-19-30"></a><span class="go">  (Total limits may be over 100 percent, i.e., overcommitted.)</span>
</span><span id="__span-19-31"><a id="__codelineno-19-31" name="__codelineno-19-31" href="#__codelineno-19-31"></a><span class="go">  Resource                       Requests    Limits</span>
</span><span id="__span-19-32"><a id="__codelineno-19-32" name="__codelineno-19-32" href="#__codelineno-19-32"></a><span class="go">  --------                       --------    ------</span>
</span><span id="__span-19-33"><a id="__codelineno-19-33" name="__codelineno-19-33" href="#__codelineno-19-33"></a><span class="go">  cpu                            655m (16%)  100m (2%)</span>
</span><span id="__span-19-34"><a id="__codelineno-19-34" name="__codelineno-19-34" href="#__codelineno-19-34"></a><span class="go">  memory                         219Mi (0%)  1102Mi (3%)</span>
</span><span id="__span-19-35"><a id="__codelineno-19-35" name="__codelineno-19-35" href="#__codelineno-19-35"></a><span class="go">  ephemeral-storage              0 (0%)      0 (0%)</span>
</span><span id="__span-19-36"><a id="__codelineno-19-36" name="__codelineno-19-36" href="#__codelineno-19-36"></a><span class="go">  hugepages-1Gi                  0 (0%)      0 (0%)</span>
</span><span id="__span-19-37"><a id="__codelineno-19-37" name="__codelineno-19-37" href="#__codelineno-19-37"></a><span class="go">  hugepages-2Mi                  0 (0%)      0 (0%)</span>
</span><span id="__span-19-38"><a id="__codelineno-19-38" name="__codelineno-19-38" href="#__codelineno-19-38"></a><span class="hll"><span class="go">  gpu.intel.com/i915             0           0</span>
</span></span><span id="__span-19-39"><a id="__codelineno-19-39" name="__codelineno-19-39" href="#__codelineno-19-39"></a><span class="hll"><span class="go">  gpu.intel.com/i915_monitoring  0           0</span>
</span></span></code></pre></div>
<h4 id="logs-reader-helper">Logs reader helper</h4>
<p>Troubleshooting pods and services often involves reading or <em>watching</em> the logs, which
involves combining two <code>kubectl</code> commands to find the relevant pod/service and
requesting the logs. To make this easier, save the following script as <code>~/bin/klogs</code>
(and add <code>~/bin/</code> to the <code>$PATH</code>):</p>
<div class="language-bash highlight"><span class="filename">bin/klogs</span><pre><span></span><code><span id="__span-20-1"><a id="__codelineno-20-1" name="__codelineno-20-1" href="#__codelineno-20-1"></a><span class="ch">#!/bin/bash</span>
</span><span id="__span-20-2"><a id="__codelineno-20-2" name="__codelineno-20-2" href="#__codelineno-20-2"></a><span class="c1">#</span>
</span><span id="__span-20-3"><a id="__codelineno-20-3" name="__codelineno-20-3" href="#__codelineno-20-3"></a><span class="c1"># Watch logs from Kubernetes pod/service.</span>
</span><span id="__span-20-4"><a id="__codelineno-20-4" name="__codelineno-20-4" href="#__codelineno-20-4"></a><span class="c1">#</span>
</span><span id="__span-20-5"><a id="__codelineno-20-5" name="__codelineno-20-5" href="#__codelineno-20-5"></a><span class="c1"># Usage: klogs &lt;namespace&gt; &lt;pod/service&gt;</span>
</span><span id="__span-20-6"><a id="__codelineno-20-6" name="__codelineno-20-6" href="#__codelineno-20-6"></a>
</span><span id="__span-20-7"><a id="__codelineno-20-7" name="__codelineno-20-7" href="#__codelineno-20-7"></a><span class="nv">ns</span><span class="o">=</span><span class="nv">$1</span>
</span><span id="__span-20-8"><a id="__codelineno-20-8" name="__codelineno-20-8" href="#__codelineno-20-8"></a><span class="nv">pd</span><span class="o">=</span><span class="nv">$2</span>
</span><span id="__span-20-9"><a id="__codelineno-20-9" name="__codelineno-20-9" href="#__codelineno-20-9"></a><span class="k">if</span><span class="w"> </span><span class="o">[[</span><span class="w"> </span><span class="s2">"</span><span class="nv">$pd</span><span class="s2">"</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">""</span><span class="w"> </span><span class="o">]]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span><span class="w"> </span><span class="nv">pd</span><span class="o">=</span><span class="s2">"</span><span class="nv">$ns</span><span class="s2">"</span><span class="p">;</span><span class="w"> </span><span class="k">fi</span>
</span><span id="__span-20-10"><a id="__codelineno-20-10" name="__codelineno-20-10" href="#__codelineno-20-10"></a>kubectl<span class="w"> </span>logs<span class="w"> </span>-n<span class="w"> </span><span class="nv">$ns</span><span class="w"> </span><span class="se">\</span>
</span><span id="__span-20-11"><a id="__codelineno-20-11" name="__codelineno-20-11" href="#__codelineno-20-11"></a><span class="w">  </span><span class="k">$(</span>kubectl<span class="w"> </span>get<span class="w"> </span>pods<span class="w"> </span>-n<span class="w"> </span><span class="nv">$ns</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span><span class="nv">$pd</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>cut<span class="w"> </span>-f1<span class="w"> </span>-d<span class="s1">' '</span><span class="k">)</span><span class="w"> </span>-f
</span></code></pre></div>
<h3 id="headlamp">Headlamp</h3>
<p><a href="https://github.com/kubernetes-retired/dashboard?tab=readme-ov-file#kubernetes-dashboard">Kubernetes Dashboard</a>
was deprecated and archived in January 2026, and is no longer
maintained due to lack of active maintainers and contributors.
<a href="../../../../2025/04/12/kubernetes-homelab-server-with-ubuntu-server-2404-octavo/#new-in-2026-headlamp">Headlamp</a>
is the suggested replacement and was already
<a href="../../../../2025/04/12/kubernetes-homelab-server-with-ubuntu-server-2404-octavo/#new-in-2026-headlamp">deployed in <code>octavo</code></a>
using its Helm chart.</p>
<h3 id="metrics-server">Metrics Server</h3>
<p><a href="https://github.com/skooner-k8s/skooner?tab=readme-ov-file#skooner---kubernetes-dashboard">Skooner</a>
was briefly installed and it relied heavily on the
<a href="https://github.com/kubernetes-sigs/metrics-server?tab=readme-ov-file#kubernetes-metrics-server">Kubernetes Metrics Server</a>
to display real-time cluster metrics. Although Skooner was later removed (it has been
abandoned for 5 years), <code>metrics-server</code> turned out necessary also for many of the
Grafana dashboards installed previously to
<a href="../../../../2025/12/21/monitoring-a-kubernetes-cluster-for-vulnerabilities/">monitor the cluster for vulnerabilities</a>.</p>
<p>When installed using
<a href="https://artifacthub.io/packages/helm/metrics-server/metrics-server">its Helm chart</a>,
it uses by default a self-signed certificate which is generated during startup and the
<code>APIservice</code> resource is registered with <code>.spec.insecureSkipTLSVerify</code> set to <code>true</code>.
Although ideally <code>metrics-server</code> can be kept more secure by using the <code>cert-manager</code>
that is available in the cluster, in a homelab environment this is typically avoided.</p>
<div class="admonition k8s">
<p class="admonition-title"><code>metrics-server-values.yaml</code></p>
<div class="language-yaml highlight"><pre><span></span><code><span id="__span-21-1"><a id="__codelineno-21-1" name="__codelineno-21-1" href="#__codelineno-21-1"></a><span class="nt">apiService</span><span class="p">:</span>
</span><span id="__span-21-2"><a id="__codelineno-21-2" name="__codelineno-21-2" href="#__codelineno-21-2"></a><span class="w">  </span><span class="nt">insecureSkipTLSVerify</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">false</span>
</span><span id="__span-21-3"><a id="__codelineno-21-3" name="__codelineno-21-3" href="#__codelineno-21-3"></a><span class="nt">defaultArgs</span><span class="p">:</span>
</span><span id="__span-21-4"><a id="__codelineno-21-4" name="__codelineno-21-4" href="#__codelineno-21-4"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">--kubelet-insecure-tls</span>
</span><span id="__span-21-5"><a id="__codelineno-21-5" name="__codelineno-21-5" href="#__codelineno-21-5"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">--kubelet-preferred-address-types=InternalIP</span>
</span><span id="__span-21-6"><a id="__codelineno-21-6" name="__codelineno-21-6" href="#__codelineno-21-6"></a><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">2</span>
</span></code></pre></div>
</div>
<details class="note">
<summary>Skipping TLS verification is the standard setup for homelabs, not production!</summary>
<p>In a homelab environment without its own DNS server, nodes hostnames are not
resolvable via DNS, making the <code>InternalIP</code> the only way Metrics Server can reach
the nodes. However, <code>kubeadm</code> generates self-signed certificates for Kubelets that
do not include IP <strong>SANs</strong> by default, which causes the TLS verification failure
when trying to use certificates; metric-server pods would fail with:</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-22-1"><a id="__codelineno-22-1" name="__codelineno-22-1" href="#__codelineno-22-1"></a><span class="gp">$ </span>kubectl<span class="w"> </span>-n<span class="w"> </span>kube-system<span class="w"> </span>logs<span class="w"> </span>metrics-server-fd5dc6448-f2fkm
</span><span id="__span-22-2"><a id="__codelineno-22-2" name="__codelineno-22-2" href="#__codelineno-22-2"></a><span class="go">...</span>
</span><span id="__span-22-3"><a id="__codelineno-22-3" name="__codelineno-22-3" href="#__codelineno-22-3"></a><span class="go">E0204 22:02:20.935565       1 scraper.go:149] "Failed to scrape node" err="Get \"https://192.168.0.6:10250/metrics/resource\": tls: failed to verify certificate: x509: cannot validate certificate for 192.168.0.6 because it doesn't contain any IP SANs" node="lexicon"</span>
</span><span id="__span-22-4"><a id="__codelineno-22-4" name="__codelineno-22-4" href="#__codelineno-22-4"></a><span class="go">E0204 22:02:20.943097       1 scraper.go:149] "Failed to scrape node" err="Get \"https://192.168.0.8:10250/metrics/resource\": tls: failed to verify certificate: x509: cannot validate certificate for 192.168.0.8 because it doesn't contain any IP SANs" node="octavo"</span>
</span></code></pre></div>
<p>The most common solution in environments without internal DNS is to tell Metrics
Server to <strong>skip TLS verification</strong> when connecting to the Kubelet; this is what
the <code>defaultArgs</code> flags above do: disable CA verification for the node certificate
and force Metrics Server to use the IP directly instead of DNS.</p>
<p>To enable secure between the Metrics Server and the kubelets, these need to have
Server Certificate Bootstrapping enabled. This allows Kubelets to request
certificates signed by the cluster CA that include the correct IP SANs:</p>
<ol>
<li>
<p><strong>Enable Server TLS Bootstrapping</strong>: update <code>/var/lib/kubelet/config.yaml</code> on
    each node to include <code>serverTLSBootstrap: true</code> and then restart the service
    with <code>systemctl restart kubelet</code>.</p>
</li>
<li>
<p><strong>Approve the CSRs</strong>: Kubelet will generate a Certificate Signing Request on
    each node and these must be approved manually:</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-23-1"><a id="__codelineno-23-1" name="__codelineno-23-1" href="#__codelineno-23-1"></a><span class="gp">$ </span>kubectl<span class="w"> </span>get<span class="w"> </span>csr
</span><span id="__span-23-2"><a id="__codelineno-23-2" name="__codelineno-23-2" href="#__codelineno-23-2"></a><span class="gp">$ </span>kubectl<span class="w"> </span>certificate<span class="w"> </span>approve<span class="w"> </span>&lt;csr-name&gt;
</span></code></pre></div>
</li>
<li>
<p><strong>Update Metrics Server</strong>: Once nodes have valid certificates, point Metrics
    Server to the cluster's CA:</p>
<div class="language-yaml highlight"><pre><span></span><code><span id="__span-24-1"><a id="__codelineno-24-1" name="__codelineno-24-1" href="#__codelineno-24-1"></a><span class="nt">apiService</span><span class="p">:</span>
</span><span id="__span-24-2"><a id="__codelineno-24-2" name="__codelineno-24-2" href="#__codelineno-24-2"></a><span class="w">  </span><span class="nt">insecureSkipTLSVerify</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">false</span>
</span><span id="__span-24-3"><a id="__codelineno-24-3" name="__codelineno-24-3" href="#__codelineno-24-3"></a><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">2</span>
</span><span id="__span-24-4"><a id="__codelineno-24-4" name="__codelineno-24-4" href="#__codelineno-24-4"></a><span class="nt">args</span><span class="p">:</span>
</span><span id="__span-24-5"><a id="__codelineno-24-5" name="__codelineno-24-5" href="#__codelineno-24-5"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">--kubelet-certificate-authority=/etc/kubernetes/pki/ca.crt</span>
</span><span id="__span-24-6"><a id="__codelineno-24-6" name="__codelineno-24-6" href="#__codelineno-24-6"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">--kubelet-preferred-address-types=InternalIP</span>
</span></code></pre></div>
</li>
</ol>
</details>
<p>Install the Helm chart and then install <code>metrics-server</code> with the above values:</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-25-1"><a id="__codelineno-25-1" name="__codelineno-25-1" href="#__codelineno-25-1"></a><span class="gp">$ </span>helm<span class="w"> </span>repo<span class="w"> </span>add<span class="w"> </span>metrics-server<span class="w"> </span>https://kubernetes-sigs.github.io/metrics-server/
</span><span id="__span-25-2"><a id="__codelineno-25-2" name="__codelineno-25-2" href="#__codelineno-25-2"></a>
</span><span id="__span-25-3"><a id="__codelineno-25-3" name="__codelineno-25-3" href="#__codelineno-25-3"></a><span class="gp">$ </span>helm<span class="w"> </span>repo<span class="w"> </span>update
</span><span id="__span-25-4"><a id="__codelineno-25-4" name="__codelineno-25-4" href="#__codelineno-25-4"></a><span class="go">Hang tight while we grab the latest from your chart repositories...</span>
</span><span id="__span-25-5"><a id="__codelineno-25-5" name="__codelineno-25-5" href="#__codelineno-25-5"></a><span class="go">...</span>
</span><span id="__span-25-6"><a id="__codelineno-25-6" name="__codelineno-25-6" href="#__codelineno-25-6"></a><span class="go">...Successfully got an update from the "metrics-server" chart repository</span>
</span><span id="__span-25-7"><a id="__codelineno-25-7" name="__codelineno-25-7" href="#__codelineno-25-7"></a><span class="go">...</span>
</span><span id="__span-25-8"><a id="__codelineno-25-8" name="__codelineno-25-8" href="#__codelineno-25-8"></a><span class="go">Update Complete. Happy Helming!</span>
</span><span id="__span-25-9"><a id="__codelineno-25-9" name="__codelineno-25-9" href="#__codelineno-25-9"></a>
</span><span id="__span-25-10"><a id="__codelineno-25-10" name="__codelineno-25-10" href="#__codelineno-25-10"></a><span class="gp">$ </span>helm<span class="w"> </span>upgrade<span class="w"> </span>--install<span class="w"> </span><span class="se">\</span>
</span><span id="__span-25-11"><a id="__codelineno-25-11" name="__codelineno-25-11" href="#__codelineno-25-11"></a><span class="w">  </span>metrics-server<span class="w"> </span>metrics-server/metrics-server<span class="w"> </span><span class="se">\</span>
</span><span id="__span-25-12"><a id="__codelineno-25-12" name="__codelineno-25-12" href="#__codelineno-25-12"></a><span class="w">  </span>--namespace<span class="o">=</span>kube-system<span class="w"> </span><span class="se">\</span>
</span><span id="__span-25-13"><a id="__codelineno-25-13" name="__codelineno-25-13" href="#__codelineno-25-13"></a><span class="w">  </span>--values<span class="o">=</span>metrics-server-values.yaml
</span><span id="__span-25-14"><a id="__codelineno-25-14" name="__codelineno-25-14" href="#__codelineno-25-14"></a><span class="go">Release "metrics-server" does not exist. Installing it now.</span>
</span><span id="__span-25-15"><a id="__codelineno-25-15" name="__codelineno-25-15" href="#__codelineno-25-15"></a><span class="go">NAME: metrics-server</span>
</span><span id="__span-25-16"><a id="__codelineno-25-16" name="__codelineno-25-16" href="#__codelineno-25-16"></a><span class="go">LAST DEPLOYED: Wed Feb  4 23:00:32 2026</span>
</span><span id="__span-25-17"><a id="__codelineno-25-17" name="__codelineno-25-17" href="#__codelineno-25-17"></a><span class="go">NAMESPACE: kube-system</span>
</span><span id="__span-25-18"><a id="__codelineno-25-18" name="__codelineno-25-18" href="#__codelineno-25-18"></a><span class="go">STATUS: deployed</span>
</span><span id="__span-25-19"><a id="__codelineno-25-19" name="__codelineno-25-19" href="#__codelineno-25-19"></a><span class="go">REVISION: 1</span>
</span><span id="__span-25-20"><a id="__codelineno-25-20" name="__codelineno-25-20" href="#__codelineno-25-20"></a><span class="go">TEST SUITE: None</span>
</span><span id="__span-25-21"><a id="__codelineno-25-21" name="__codelineno-25-21" href="#__codelineno-25-21"></a><span class="go">NOTES:</span>
</span><span id="__span-25-22"><a id="__codelineno-25-22" name="__codelineno-25-22" href="#__codelineno-25-22"></a><span class="go">***********************************************************************</span>
</span><span id="__span-25-23"><a id="__codelineno-25-23" name="__codelineno-25-23" href="#__codelineno-25-23"></a><span class="go">* Metrics Server                                                      *</span>
</span><span id="__span-25-24"><a id="__codelineno-25-24" name="__codelineno-25-24" href="#__codelineno-25-24"></a><span class="go">***********************************************************************</span>
</span><span id="__span-25-25"><a id="__codelineno-25-25" name="__codelineno-25-25" href="#__codelineno-25-25"></a><span class="go">  Chart version: 3.13.0</span>
</span><span id="__span-25-26"><a id="__codelineno-25-26" name="__codelineno-25-26" href="#__codelineno-25-26"></a><span class="go">  App version:   0.8.0</span>
</span><span id="__span-25-27"><a id="__codelineno-25-27" name="__codelineno-25-27" href="#__codelineno-25-27"></a><span class="go">  Image tag:     registry.k8s.io/metrics-server/metrics-server:v0.8.0</span>
</span><span id="__span-25-28"><a id="__codelineno-25-28" name="__codelineno-25-28" href="#__codelineno-25-28"></a><span class="go">***********************************************************************</span>
</span></code></pre></div>
<h3 id="node-affinity">Node Affinity</h3>
<p>To ensure specific workloads remain on the primary node unless it goes down, use
<strong>Node Affinity</strong> with a preferred rule based on node labels. First, label the nodes
according to the relevant properties for the node affinity preferences; in this case
start with a "performance level":</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-26-1"><a id="__codelineno-26-1" name="__codelineno-26-1" href="#__codelineno-26-1"></a><span class="gp">$ </span>kubectl<span class="w"> </span>label<span class="w"> </span>node<span class="w"> </span>lexicon<span class="w"> </span>node-type<span class="o">=</span>low-perf
</span><span id="__span-26-2"><a id="__codelineno-26-2" name="__codelineno-26-2" href="#__codelineno-26-2"></a><span class="go">node/lexicon labeled</span>
</span><span id="__span-26-3"><a id="__codelineno-26-3" name="__codelineno-26-3" href="#__codelineno-26-3"></a><span class="gp">$ </span>kubectl<span class="w"> </span>label<span class="w"> </span>node<span class="w"> </span>octavo<span class="w"> </span>node-type<span class="o">=</span>high-perf
</span><span id="__span-26-4"><a id="__codelineno-26-4" name="__codelineno-26-4" href="#__codelineno-26-4"></a><span class="go">node/octavo labeled</span>
</span></code></pre></div>
<p>To apply a <em>preferred affinity</em>, use <code>preferredDuringSchedulingIgnoredDuringExecution</code> in
each <code>Deployment</code> manifest to set the preference for the node with the required label
value (e.g. <code>node-type=high-perf</code>). The scheduler will then always place the pod on the
<em>high-perf</em> node if it is available. If the high-perf node goes down, the scheduler will
allow the pod to be scheduled on other nodes because the rule is "preferred" rather than
"required". </p>
<p>Adding the <code>affinity</code> block to a Deployment's <code>spec.template.spec</code> can be done as a
<em>Hard Rule</em> (Required) or as a <em>Soft Rule</em> (Preferred).</p>
<p>Jellyfin <strong>must</strong> run on <code>octavo</code>, not only to use the Core i7 CPU but also to use the
4TB SATA SSD. If <code>octavo</code> is down, the pod will stay in a <code>Pending</code> state and will not
start on <code>lexicon</code> or other nodes without their a local replica of the relevant volumes:</p>
<div class="admonition k8s">
<p class="admonition-title"><code>jellyfin.yaml</code></p>
<div class="language-yaml highlight"><pre><span></span><code><span id="__span-27-1"><a id="__codelineno-27-1" name="__codelineno-27-1" href="#__codelineno-27-1"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">apps/v1</span>
</span><span id="__span-27-2"><a id="__codelineno-27-2" name="__codelineno-27-2" href="#__codelineno-27-2"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Deployment</span>
</span><span id="__span-27-3"><a id="__codelineno-27-3" name="__codelineno-27-3" href="#__codelineno-27-3"></a><span class="nt">metadata</span><span class="p">:</span>
</span><span id="__span-27-4"><a id="__codelineno-27-4" name="__codelineno-27-4" href="#__codelineno-27-4"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">jellyfin</span>
</span><span id="__span-27-5"><a id="__codelineno-27-5" name="__codelineno-27-5" href="#__codelineno-27-5"></a><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">media-center</span>
</span><span id="__span-27-6"><a id="__codelineno-27-6" name="__codelineno-27-6" href="#__codelineno-27-6"></a><span class="nt">spec</span><span class="p">:</span>
</span><span id="__span-27-7"><a id="__codelineno-27-7" name="__codelineno-27-7" href="#__codelineno-27-7"></a><span class="w">  </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1</span>
</span><span id="__span-27-8"><a id="__codelineno-27-8" name="__codelineno-27-8" href="#__codelineno-27-8"></a><span class="w">  </span><span class="nt">selector</span><span class="p">:</span>
</span><span id="__span-27-9"><a id="__codelineno-27-9" name="__codelineno-27-9" href="#__codelineno-27-9"></a><span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span>
</span><span id="__span-27-10"><a id="__codelineno-27-10" name="__codelineno-27-10" href="#__codelineno-27-10"></a><span class="w">      </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">jellyfin</span>
</span><span id="__span-27-11"><a id="__codelineno-27-11" name="__codelineno-27-11" href="#__codelineno-27-11"></a><span class="w">  </span><span class="nt">template</span><span class="p">:</span>
</span><span id="__span-27-12"><a id="__codelineno-27-12" name="__codelineno-27-12" href="#__codelineno-27-12"></a><span class="w">    </span><span class="nt">metadata</span><span class="p">:</span>
</span><span id="__span-27-13"><a id="__codelineno-27-13" name="__codelineno-27-13" href="#__codelineno-27-13"></a><span class="w">      </span><span class="nt">labels</span><span class="p">:</span>
</span><span id="__span-27-14"><a id="__codelineno-27-14" name="__codelineno-27-14" href="#__codelineno-27-14"></a><span class="w">        </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">jellyfin</span>
</span><span id="__span-27-15"><a id="__codelineno-27-15" name="__codelineno-27-15" href="#__codelineno-27-15"></a><span class="w">    </span><span class="nt">spec</span><span class="p">:</span>
</span><span id="__span-27-16"><a id="__codelineno-27-16" name="__codelineno-27-16" href="#__codelineno-27-16"></a><span class="hll"><span class="w">      </span><span class="nt">affinity</span><span class="p">:</span>
</span></span><span id="__span-27-17"><a id="__codelineno-27-17" name="__codelineno-27-17" href="#__codelineno-27-17"></a><span class="hll"><span class="w">        </span><span class="nt">nodeAffinity</span><span class="p">:</span>
</span></span><span id="__span-27-18"><a id="__codelineno-27-18" name="__codelineno-27-18" href="#__codelineno-27-18"></a><span class="hll"><span class="w">          </span><span class="nt">requiredDuringSchedulingIgnoredDuringExecution</span><span class="p">:</span>
</span></span><span id="__span-27-19"><a id="__codelineno-27-19" name="__codelineno-27-19" href="#__codelineno-27-19"></a><span class="hll"><span class="w">            </span><span class="nt">nodeSelectorTerms</span><span class="p">:</span>
</span></span><span id="__span-27-20"><a id="__codelineno-27-20" name="__codelineno-27-20" href="#__codelineno-27-20"></a><span class="hll"><span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">matchExpressions</span><span class="p">:</span>
</span></span><span id="__span-27-21"><a id="__codelineno-27-21" name="__codelineno-27-21" href="#__codelineno-27-21"></a><span class="hll"><span class="w">              </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">node-type</span>
</span></span><span id="__span-27-22"><a id="__codelineno-27-22" name="__codelineno-27-22" href="#__codelineno-27-22"></a><span class="hll"><span class="w">                </span><span class="nt">operator</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">In</span>
</span></span><span id="__span-27-23"><a id="__codelineno-27-23" name="__codelineno-27-23" href="#__codelineno-27-23"></a><span class="hll"><span class="w">                </span><span class="nt">values</span><span class="p">:</span>
</span></span><span id="__span-27-24"><a id="__codelineno-27-24" name="__codelineno-27-24" href="#__codelineno-27-24"></a><span class="hll"><span class="w">                </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">high-perf</span>
</span></span><span id="__span-27-25"><a id="__codelineno-27-25" name="__codelineno-27-25" href="#__codelineno-27-25"></a><span class="w">      </span><span class="nt">containers</span><span class="p">:</span>
</span><span id="__span-27-26"><a id="__codelineno-27-26" name="__codelineno-27-26" href="#__codelineno-27-26"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">jellyfin/jellyfin</span>
</span><span id="__span-27-27"><a id="__codelineno-27-27" name="__codelineno-27-27" href="#__codelineno-27-27"></a><span class="w">        </span><span class="l l-Scalar l-Scalar-Plain">...</span>
</span></code></pre></div>
</div>
<p>Audiobookshelf <strong>should</strong> run <em>preferably</em> on <code>octavo</code> for better performance, but in
<code>octavo</code> goes down then it should run on <code>lexicon</code> since it has its own replicas of all
the relevant volumes:</p>
<div class="admonition k8s">
<p class="admonition-title"><code>audiobookshelf.yaml</code></p>
<div class="language-yaml highlight"><pre><span></span><code><span id="__span-28-1"><a id="__codelineno-28-1" name="__codelineno-28-1" href="#__codelineno-28-1"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">apps/v1</span>
</span><span id="__span-28-2"><a id="__codelineno-28-2" name="__codelineno-28-2" href="#__codelineno-28-2"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Deployment</span>
</span><span id="__span-28-3"><a id="__codelineno-28-3" name="__codelineno-28-3" href="#__codelineno-28-3"></a><span class="nt">metadata</span><span class="p">:</span>
</span><span id="__span-28-4"><a id="__codelineno-28-4" name="__codelineno-28-4" href="#__codelineno-28-4"></a><span class="w">  </span><span class="nt">labels</span><span class="p">:</span>
</span><span id="__span-28-5"><a id="__codelineno-28-5" name="__codelineno-28-5" href="#__codelineno-28-5"></a><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">audiobookshelf</span>
</span><span id="__span-28-6"><a id="__codelineno-28-6" name="__codelineno-28-6" href="#__codelineno-28-6"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">audiobookshelf</span>
</span><span id="__span-28-7"><a id="__codelineno-28-7" name="__codelineno-28-7" href="#__codelineno-28-7"></a><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">audiobookshelf</span>
</span><span id="__span-28-8"><a id="__codelineno-28-8" name="__codelineno-28-8" href="#__codelineno-28-8"></a><span class="nt">spec</span><span class="p">:</span>
</span><span id="__span-28-9"><a id="__codelineno-28-9" name="__codelineno-28-9" href="#__codelineno-28-9"></a><span class="w">  </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1</span>
</span><span id="__span-28-10"><a id="__codelineno-28-10" name="__codelineno-28-10" href="#__codelineno-28-10"></a><span class="w">  </span><span class="nt">revisionHistoryLimit</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0</span>
</span><span id="__span-28-11"><a id="__codelineno-28-11" name="__codelineno-28-11" href="#__codelineno-28-11"></a><span class="w">  </span><span class="nt">selector</span><span class="p">:</span>
</span><span id="__span-28-12"><a id="__codelineno-28-12" name="__codelineno-28-12" href="#__codelineno-28-12"></a><span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span>
</span><span id="__span-28-13"><a id="__codelineno-28-13" name="__codelineno-28-13" href="#__codelineno-28-13"></a><span class="w">      </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">audiobookshelf</span>
</span><span id="__span-28-14"><a id="__codelineno-28-14" name="__codelineno-28-14" href="#__codelineno-28-14"></a><span class="w">  </span><span class="nt">strategy</span><span class="p">:</span>
</span><span id="__span-28-15"><a id="__codelineno-28-15" name="__codelineno-28-15" href="#__codelineno-28-15"></a><span class="w">    </span><span class="nt">rollingUpdate</span><span class="p">:</span>
</span><span id="__span-28-16"><a id="__codelineno-28-16" name="__codelineno-28-16" href="#__codelineno-28-16"></a><span class="w">      </span><span class="nt">maxSurge</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0</span>
</span><span id="__span-28-17"><a id="__codelineno-28-17" name="__codelineno-28-17" href="#__codelineno-28-17"></a><span class="w">      </span><span class="nt">maxUnavailable</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1</span>
</span><span id="__span-28-18"><a id="__codelineno-28-18" name="__codelineno-28-18" href="#__codelineno-28-18"></a><span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">RollingUpdate</span>
</span><span id="__span-28-19"><a id="__codelineno-28-19" name="__codelineno-28-19" href="#__codelineno-28-19"></a><span class="w">  </span><span class="nt">template</span><span class="p">:</span>
</span><span id="__span-28-20"><a id="__codelineno-28-20" name="__codelineno-28-20" href="#__codelineno-28-20"></a><span class="w">    </span><span class="nt">metadata</span><span class="p">:</span>
</span><span id="__span-28-21"><a id="__codelineno-28-21" name="__codelineno-28-21" href="#__codelineno-28-21"></a><span class="w">      </span><span class="nt">labels</span><span class="p">:</span>
</span><span id="__span-28-22"><a id="__codelineno-28-22" name="__codelineno-28-22" href="#__codelineno-28-22"></a><span class="w">        </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">audiobookshelf</span>
</span><span id="__span-28-23"><a id="__codelineno-28-23" name="__codelineno-28-23" href="#__codelineno-28-23"></a><span class="w">    </span><span class="nt">spec</span><span class="p">:</span>
</span><span id="__span-28-24"><a id="__codelineno-28-24" name="__codelineno-28-24" href="#__codelineno-28-24"></a><span class="hll"><span class="w">      </span><span class="nt">affinity</span><span class="p">:</span>
</span></span><span id="__span-28-25"><a id="__codelineno-28-25" name="__codelineno-28-25" href="#__codelineno-28-25"></a><span class="hll"><span class="w">        </span><span class="nt">nodeAffinity</span><span class="p">:</span>
</span></span><span id="__span-28-26"><a id="__codelineno-28-26" name="__codelineno-28-26" href="#__codelineno-28-26"></a><span class="hll"><span class="w">          </span><span class="nt">preferredDuringSchedulingIgnoredDuringExecution</span><span class="p">:</span>
</span></span><span id="__span-28-27"><a id="__codelineno-28-27" name="__codelineno-28-27" href="#__codelineno-28-27"></a><span class="hll"><span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">weight</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">100</span>
</span></span><span id="__span-28-28"><a id="__codelineno-28-28" name="__codelineno-28-28" href="#__codelineno-28-28"></a><span class="hll"><span class="w">            </span><span class="nt">preference</span><span class="p">:</span>
</span></span><span id="__span-28-29"><a id="__codelineno-28-29" name="__codelineno-28-29" href="#__codelineno-28-29"></a><span class="hll"><span class="w">              </span><span class="nt">matchExpressions</span><span class="p">:</span>
</span></span><span id="__span-28-30"><a id="__codelineno-28-30" name="__codelineno-28-30" href="#__codelineno-28-30"></a><span class="hll"><span class="w">              </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">node-type</span>
</span></span><span id="__span-28-31"><a id="__codelineno-28-31" name="__codelineno-28-31" href="#__codelineno-28-31"></a><span class="hll"><span class="w">                </span><span class="nt">operator</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">In</span>
</span></span><span id="__span-28-32"><a id="__codelineno-28-32" name="__codelineno-28-32" href="#__codelineno-28-32"></a><span class="hll"><span class="w">                </span><span class="nt">values</span><span class="p">:</span>
</span></span><span id="__span-28-33"><a id="__codelineno-28-33" name="__codelineno-28-33" href="#__codelineno-28-33"></a><span class="hll"><span class="w">                </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">high-perf</span>
</span></span><span id="__span-28-34"><a id="__codelineno-28-34" name="__codelineno-28-34" href="#__codelineno-28-34"></a><span class="w">      </span><span class="nt">containers</span><span class="p">:</span>
</span><span id="__span-28-35"><a id="__codelineno-28-35" name="__codelineno-28-35" href="#__codelineno-28-35"></a><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ghcr.io/advplyr/audiobookshelf:latest</span>
</span><span id="__span-28-36"><a id="__codelineno-28-36" name="__codelineno-28-36" href="#__codelineno-28-36"></a><span class="w">          </span><span class="l l-Scalar l-Scalar-Plain">...</span>
</span></code></pre></div>
</div>
<h2 id="zero-downtime-reboots">Zero-Downtime Reboots</h2>
<p>Even though the cluster now has two nodes, most deployments are running only one pod
(replica) that may be in either node (unless biased by <a href="#node-affinity">Node Affinity</a>).</p>
<p>Rebooting the control plane node (<code>octavo</code>) will still cause a total outage on <code>lexicon</code>
because three fundamental architectural dependencies are not yet correctly setup for
<em>High Availability</em>:</p>
<ol>
<li><strong>Flannel</strong>: when <code>octavo</code> goes down, the Flannel pods on <code>lexicon</code> can lose the
    ability to communicate with the API server. If <code>lexicon</code>'s networking logic "hangs"
    because it cannot reach the control plane to verify routing tables, all cross-pod
    and ingress traffic stops.</li>
<li><strong>MetalLB Controller</strong>: MetalLB has two parts: the Speaker (<code>DaemonSet</code>, runs on
    both nodes) and the Controller (<code>Deployment</code>, runs on only 1 replica by default).
    If the <code>metallb-controller</code> is running on <code>octavo</code> when it reboots, there is no
    "brain" to assign or refresh IPs. Even though the speaker on <code>lexicon</code> is alive, it
    may stop announcing the IP if it loses its lease or a network "hiccup" occurs during
    the control plane's absence.</li>
<li><strong>Pomerium</strong> (<code>Ingress</code>): all apps are exposed through Pomerium Ingress. If the
    Pomerium pods were not explicitly scaled to <strong>2</strong> replicas and spread across both
    nodes, they will likely remain on <code>octavo</code>. Even if some services' pods are running
    fine on lexicon, the "Front Door" (Pomerium) is shut down when it's (only) in the
    rebooting node. However, Pomerium cannot be scaled beyond a single replica when
    using file-based persistant storage.</li>
</ol>
<p>To prevent downtine when a node is rebooted, these components must be made
<strong>High Availability</strong> across both NUCs:</p>
<ol>
<li>
<p><strong>Scale MetalLB</strong>: the <code>metallb-controller</code> controller must be scaled manually
    because the Helm chart does not support <code>spec.replicaCount</code> (or similar) at all:</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-29-1"><a id="__codelineno-29-1" name="__codelineno-29-1" href="#__codelineno-29-1"></a><span class="gp">$ </span>kubectl<span class="w"> </span>scale<span class="w"> </span>deployment<span class="w"> </span>metallb-controller<span class="w"> </span>-n<span class="w"> </span>metallb-system<span class="w"> </span>--replicas<span class="o">=</span><span class="m">2</span>
</span><span id="__span-29-2"><a id="__codelineno-29-2" name="__codelineno-29-2" href="#__codelineno-29-2"></a><span class="go">deployment.apps/metallb-controller scaled</span>
</span></code></pre></div>
<p>After a few seconds there should be one replica <code>READY</code> on each node:</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-30-1"><a id="__codelineno-30-1" name="__codelineno-30-1" href="#__codelineno-30-1"></a><span class="gp">$ </span>kubectl<span class="w"> </span>get<span class="w"> </span>pods<span class="w"> </span>-n<span class="w"> </span>metallb-system<span class="w"> </span>-l<span class="w"> </span>app.kubernetes.io/component<span class="o">=</span>controller<span class="w"> </span>-o<span class="w"> </span>wide
</span><span id="__span-30-2"><a id="__codelineno-30-2" name="__codelineno-30-2" href="#__codelineno-30-2"></a><span class="go">NAME                                  READY   STATUS    RESTARTS   AGE     IP             NODE      NOMINATED NODE   READINESS GATES</span>
</span><span id="__span-30-3"><a id="__codelineno-30-3" name="__codelineno-30-3" href="#__codelineno-30-3"></a><span class="go">metallb-controller-764cb589cc-fgk56   1/1     Running   0          5m18s   10.244.1.237   lexicon   &lt;none&gt;           &lt;none&gt;</span>
</span><span id="__span-30-4"><a id="__codelineno-30-4" name="__codelineno-30-4" href="#__codelineno-30-4"></a><span class="go">metallb-controller-764cb589cc-hzgbq   1/1     Running   0          29s     10.244.0.31    octavo    &lt;none&gt;           &lt;none&gt;</span>
</span></code></pre></div>
</li>
<li>
<p><strong>Actually Don't</strong> Scale Pomerium: even after migrating Pomerium to a Longhorn
    <code>ReadWriteMany</code> volume, so that multiple pods can read/write the volume, the
    database inside the volume can only be used (locked) by a single pod. This is why,
    when scaling Pomerium to 2 replicas, 1 will stay <code>Running</code> but not healthy:</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-31-1"><a id="__codelineno-31-1" name="__codelineno-31-1" href="#__codelineno-31-1"></a><span class="gp">$ </span>kubectl<span class="w"> </span>scale<span class="w"> </span>deployment<span class="w"> </span>pomerium<span class="w"> </span>--replicas<span class="o">=</span><span class="m">2</span>
</span><span id="__span-31-2"><a id="__codelineno-31-2" name="__codelineno-31-2" href="#__codelineno-31-2"></a>
</span><span id="__span-31-3"><a id="__codelineno-31-3" name="__codelineno-31-3" href="#__codelineno-31-3"></a><span class="gp">$ </span>kubectl<span class="w"> </span>get<span class="w"> </span>pods<span class="w"> </span>-n<span class="w"> </span>pomerium<span class="w"> </span>-o<span class="w"> </span>wide<span class="w"> </span>
</span><span id="__span-31-4"><a id="__codelineno-31-4" name="__codelineno-31-4" href="#__codelineno-31-4"></a><span class="go">NAME                        READY   STATUS    RESTARTS        AGE   IP             NODE      NOMINATED NODE   READINESS GATES</span>
</span><span id="__span-31-5"><a id="__codelineno-31-5" name="__codelineno-31-5" href="#__codelineno-31-5"></a><span class="go">pomerium-6c7f5448b9-bvw64   0/1     Running   6 (8m19s ago)   40m   10.244.1.13    lexicon   &lt;none&gt;           &lt;none&gt;</span>
</span><span id="__span-31-6"><a id="__codelineno-31-6" name="__codelineno-31-6" href="#__codelineno-31-6"></a><span class="go">pomerium-6c7f5448b9-np27p   1/1     Running   1 (13m ago)     34m   10.244.0.101   octavo    &lt;none&gt;           &lt;none&gt;</span>
</span></code></pre></div>
</li>
<li>
<p><strong>Handle the Control Plane "Unreachable" Taints</strong>: </p>
<p>By default, when the control plane goes down, Kubernetes waits 300 seconds before
deciding to failover. This should be reduced in Deployment manifests beforehand:</p>
<div class="language-yaml highlight"><pre><span></span><code><span id="__span-32-1"><a id="__codelineno-32-1" name="__codelineno-32-1" href="#__codelineno-32-1"></a><span class="nt">spec</span><span class="p">:</span>
</span><span id="__span-32-2"><a id="__codelineno-32-2" name="__codelineno-32-2" href="#__codelineno-32-2"></a><span class="w">  </span><span class="nt">template</span><span class="p">:</span>
</span><span id="__span-32-3"><a id="__codelineno-32-3" name="__codelineno-32-3" href="#__codelineno-32-3"></a><span class="w">    </span><span class="nt">spec</span><span class="p">:</span>
</span><span id="__span-32-4"><a id="__codelineno-32-4" name="__codelineno-32-4" href="#__codelineno-32-4"></a><span class="w">      </span><span class="nt">tolerations</span><span class="p">:</span>
</span><span id="__span-32-5"><a id="__codelineno-32-5" name="__codelineno-32-5" href="#__codelineno-32-5"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="s">"management-only"</span>
</span><span id="__span-32-6"><a id="__codelineno-32-6" name="__codelineno-32-6" href="#__codelineno-32-6"></a><span class="w">        </span><span class="nt">operator</span><span class="p">:</span><span class="w"> </span><span class="s">"Equal"</span>
</span><span id="__span-32-7"><a id="__codelineno-32-7" name="__codelineno-32-7" href="#__codelineno-32-7"></a><span class="w">        </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="s">"true"</span>
</span><span id="__span-32-8"><a id="__codelineno-32-8" name="__codelineno-32-8" href="#__codelineno-32-8"></a><span class="w">        </span><span class="nt">effect</span><span class="p">:</span><span class="w"> </span><span class="s">"NoSchedule"</span>
</span><span id="__span-32-9"><a id="__codelineno-32-9" name="__codelineno-32-9" href="#__codelineno-32-9"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="s">"node.kubernetes.io/unreachable"</span>
</span><span id="__span-32-10"><a id="__codelineno-32-10" name="__codelineno-32-10" href="#__codelineno-32-10"></a><span class="w">        </span><span class="nt">operator</span><span class="p">:</span><span class="w"> </span><span class="s">"Exists"</span>
</span><span id="__span-32-11"><a id="__codelineno-32-11" name="__codelineno-32-11" href="#__codelineno-32-11"></a><span class="w">        </span><span class="nt">effect</span><span class="p">:</span><span class="w"> </span><span class="s">"NoExecute"</span>
</span><span id="__span-32-12"><a id="__codelineno-32-12" name="__codelineno-32-12" href="#__codelineno-32-12"></a><span class="w">        </span><span class="nt">tolerationSeconds</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10</span>
</span><span id="__span-32-13"><a id="__codelineno-32-13" name="__codelineno-32-13" href="#__codelineno-32-13"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="s">"node.kubernetes.io/not-ready"</span>
</span><span id="__span-32-14"><a id="__codelineno-32-14" name="__codelineno-32-14" href="#__codelineno-32-14"></a><span class="w">        </span><span class="nt">operator</span><span class="p">:</span><span class="w"> </span><span class="s">"Exists"</span>
</span><span id="__span-32-15"><a id="__codelineno-32-15" name="__codelineno-32-15" href="#__codelineno-32-15"></a><span class="w">        </span><span class="nt">effect</span><span class="p">:</span><span class="w"> </span><span class="s">"NoExecute"</span>
</span><span id="__span-32-16"><a id="__codelineno-32-16" name="__codelineno-32-16" href="#__codelineno-32-16"></a><span class="w">        </span><span class="nt">tolerationSeconds</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10</span>
</span></code></pre></div>
</li>
<li>
<p><strong>Longhorn "First Node" Settings</strong>: </p>
<p>Longhorn's UI and some managers often default to the first node. Before rebooting
<code>octavo</code>, check the Longhorn UI to ensure all volumes are Healthy on both nodes.
If a volume is only on octavo, the pod on <code>lexicon</code> will crash.</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-33-1"><a id="__codelineno-33-1" name="__codelineno-33-1" href="#__codelineno-33-1"></a><span class="gp">$ </span>kubectl<span class="w"> </span>get<span class="w"> </span>pods<span class="w"> </span>-A<span class="w"> </span>-o<span class="w"> </span>wide<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>-E<span class="w"> </span><span class="s1">'longhorn-manager|longhorn-ui'</span>
</span><span id="__span-33-2"><a id="__codelineno-33-2" name="__codelineno-33-2" href="#__codelineno-33-2"></a><span class="go">longhorn-system            longhorn-manager-7dh85                                   2/2     Running     4 (11m ago)    5d10h   10.244.1.26    lexicon   &lt;none&gt;           &lt;none&gt;</span>
</span><span id="__span-33-3"><a id="__codelineno-33-3" name="__codelineno-33-3" href="#__codelineno-33-3"></a><span class="go">longhorn-system            longhorn-manager-pbl4t                                   2/2     Running     4 (34h ago)    8d      10.244.0.73    octavo    &lt;none&gt;           &lt;none&gt;</span>
</span><span id="__span-33-4"><a id="__codelineno-33-4" name="__codelineno-33-4" href="#__codelineno-33-4"></a><span class="go">longhorn-system            longhorn-ui-7fc9b4667f-h22gm                             1/1     Running     4 (34h ago)    8d      10.244.0.68    octavo    &lt;none&gt;           &lt;none&gt;</span>
</span><span id="__span-33-5"><a id="__codelineno-33-5" name="__codelineno-33-5" href="#__codelineno-33-5"></a><span class="go">longhorn-system            longhorn-ui-7fc9b4667f-xqdvw                             1/1     Running     4 (34h ago)    8d      10.244.0.58    octavo    &lt;none&gt;           &lt;none&gt;</span>
</span></code></pre></div>
</li>
<li>
<p><strong>Longhorn "Pod Deletion Policy"</strong>: In the Longhorn UI, under <strong>Settings &gt; General</strong>
    set <strong>Pod Deletion Policy When Node is Down</strong> to
    <code>delete-both-statefulset-and-deployment-pod</code> so that when a node is down, Longhorn
    will force-delete the pods. This breaks the "Volume Lock" and allows the pods to
    start on the remaining healthy node (octavo) immediately.</p>
</li>
</ol>
<h3 id="tolerations-on-helm-charts">Tolerations on Helm Charts</h3>
<p>To apply the above management-only tolerations to those applications deployed using Helm
charts, add the <code>tolerations</code> section under the following specific keys in the YAML
values for each chart. The simplest charts will take the <code>tolerations</code> at the top level:
<a href="#headlamp">Headlamp</a>,
<a href="#metrics-server">metrics-server</a>,
<a href="../../../../2025/12/18/replacing-ingress-nginx-with-pomerium/#switch-to-dns-01-solvers">cert-manager-webhook-porkbun</a>,
<a href="../../../../2025/03/28/remote-access-options-for-self-hosted-services/#tailscale-kubernetes-operator">tailscale</a>.</p>
<p>Trivy Operator and Prometheus for the
<a href="../../../../2025/12/21/monitoring-a-kubernetes-cluster-for-vulnerabilities/#trivy-operator-dashboard-in-grafana">Trivy Operator Dashboard in Grafana</a> only accept the <code>tolerations</code> under specifc keys:
under <code>trivyOperator</code> in <code>prometheus/trivy-values.yaml</code> and under
<code>prometheus.prometheusSpec</code> in <code>prometheus/values.yaml</code>.</p>
<p><a href="../../../01/25/migrating-kubernetes-volumes-to-longhorn/">Longhorn</a> takes <code>tolerations</code>
under multiple keys, but adding it simply under <code>global</code> will make it effective for
every <code>Deployment</code> and <code>DaemonSet</code> (<code>longhorn-driver-deployer</code>, <code>longhorn-manager</code>,
<code>longhorn-ui</code>); and the
<a href="../../../01/24/migrating-nfs-volumes-to-the-nfs-csi-driver-for-kubernetes/#install-the-nfs-csi-driver">The NFS CSI driver</a>
takes <code>controller.tolerations</code> and <code>node.tolerations</code> in <code>nfs-csi-values.yaml</code>.</p>
<h2 id="high-availability-ingress">High Availability Ingress</h2>
<p>Incoming requests are routed to the <code>LoadBalancer</code> (virtual) IP of
<a href="../../../../2025/12/18/replacing-ingress-nginx-with-pomerium/">Pomerium</a>; when it goes down in
one node and starts on the other one, MetalLB moves the virtual IP to the node now
running Pomerium. Even though Pomerium cannot be scaled up beyond one replica, MetalLB
takes care of moving requests to the correct node where Pomerium is running.</p>
<p>Moreover, when traffic hits the Virtual IP on any node, the Kubernetes internal network
(<code>kube-proxy</code>) automatically load balances that request to any available Pomerium pod,
regardless of which node it sits on.</p>
<p>In Layer 2 mode, MetalLB operates as a failover rather than a load balancer. When adding
the second node, the MetalLB speaker pod will automatically deploy to it as part of its
<code>DaemonSet</code>. The two speakers will communicate; one node will be "elected" the leader
and will handle the ARP requests for the Pomerium IP. If the current leader goes
offline, the other speaker will detect the loss of its peer and automatically begin
announcing that same IP address to the router.</p>
<p>Adding a second node to a cluster already running MetalLB in <strong>Layer 2 mode</strong> provides a
"semi-automatic" path to high availability. While MetalLB will technically handle the
failover, the current setup requires two manual checks to ensure it actually works
when a node goes down:</p>
<ol>
<li>
<p><strong>External Traffic Policy:</strong> <code>Cluster</code> is the default mode that allows any node to
    be the leader, and that is requiried for high availability ingress, so that even if
    the Pomerium pod isn't on that specific node. The leader node will catch the traffic
    and forward it internally to wherever the Pomerium pod is running. This can be
    checked with the following command:</p>
<details class="terminal">
<summary><code>kubectl get svc -A</code></summary>
<div class="language-console highlight"><pre><span></span><code><span id="__span-34-1"><a id="__codelineno-34-1" name="__codelineno-34-1" href="#__codelineno-34-1"></a><span class="gp">$ </span>kubectl<span class="w"> </span>get<span class="w"> </span>svc<span class="w"> </span>-A<span class="w"> </span>-o<span class="w"> </span><span class="se">\</span>
</span><span id="__span-34-2"><a id="__codelineno-34-2" name="__codelineno-34-2" href="#__codelineno-34-2"></a><span class="w">  </span>custom-columns<span class="o">=</span><span class="s2">"NAME:.metadata.name,NAMESPACE:.spec.externalTrafficPolicy"</span><span class="w"> </span><span class="se">\</span>
</span><span id="__span-34-3"><a id="__codelineno-34-3" name="__codelineno-34-3" href="#__codelineno-34-3"></a><span class="w">  </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>-E<span class="w"> </span><span class="s1">'Cluster|Local'</span>
</span><span id="__span-34-4"><a id="__codelineno-34-4" name="__codelineno-34-4" href="#__codelineno-34-4"></a><span class="go">firefly-iii-mysql-svc                                   Cluster</span>
</span><span id="__span-34-5"><a id="__codelineno-34-5" name="__codelineno-34-5" href="#__codelineno-34-5"></a><span class="go">firefly-iii-svc                                         Cluster</span>
</span><span id="__span-34-6"><a id="__codelineno-34-6" name="__codelineno-34-6" href="#__codelineno-34-6"></a><span class="go">komga-svc                                               Cluster</span>
</span><span id="__span-34-7"><a id="__codelineno-34-7" name="__codelineno-34-7" href="#__codelineno-34-7"></a><span class="go">grafana-svc                                             Cluster</span>
</span><span id="__span-34-8"><a id="__codelineno-34-8" name="__codelineno-34-8" href="#__codelineno-34-8"></a><span class="go">influxdb-svc                                            Cluster</span>
</span><span id="__span-34-9"><a id="__codelineno-34-9" name="__codelineno-34-9" href="#__codelineno-34-9"></a><span class="go">navidrome-svc                                           Cluster</span>
</span><span id="__span-34-10"><a id="__codelineno-34-10" name="__codelineno-34-10" href="#__codelineno-34-10"></a><span class="go">pomerium-proxy                                          Cluster</span>
</span><span id="__span-34-11"><a id="__codelineno-34-11" name="__codelineno-34-11" href="#__codelineno-34-11"></a><span class="go">postgres-svc                                            Cluster</span>
</span><span id="__span-34-12"><a id="__codelineno-34-12" name="__codelineno-34-12" href="#__codelineno-34-12"></a><span class="go">ryot-svc                                                Cluster</span>
</span><span id="__span-34-13"><a id="__codelineno-34-13" name="__codelineno-34-13" href="#__codelineno-34-13"></a><span class="go">mongo-svc                                               Cluster</span>
</span><span id="__span-34-14"><a id="__codelineno-34-14" name="__codelineno-34-14" href="#__codelineno-34-14"></a><span class="go">unifi-tcp                                               Cluster</span>
</span><span id="__span-34-15"><a id="__codelineno-34-15" name="__codelineno-34-15" href="#__codelineno-34-15"></a><span class="go">unifi-tcp-1                                             Cluster</span>
</span><span id="__span-34-16"><a id="__codelineno-34-16" name="__codelineno-34-16" href="#__codelineno-34-16"></a><span class="go">unifi-udp                                               Cluster</span>
</span></code></pre></div>
</details>
</li>
<li>
<p><strong>L2 Advertisement Scope:</strong> must be unrestricted so that the <code>L2Advertisement</code>
    resource advertises to all nodes. If restricted via a <code>nodeSelector</code>, it must be
    updated it to include all the relevant nodes.</p>
</li>
</ol>
<p>As it happens, MetalLB was already setup using the default <code>Cluster</code> polic and the
<code>L2Advertisement</code> resources were not restricted, so it was essentially ready from the
beginning.</p>







  
  



  


  



<script src="https://giscus.app/client.js" data-repo="stibbons1990/hex" data-repo-id="R_kgDOKXTsSg" data-category="Announcements" data-category-id="DIC_kwDOKXTsSs4CqHDX" data-mapping="pathname" data-strict="0" data-reactions-enabled="1" data-emit-metadata="1" data-input-position="top" data-theme="preferred_color_scheme" data-lang="en" crossorigin="anonymous" async>
</script>

      
    </article>
  </div>

          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"></path></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
    
      
        
      
      <nav class="md-footer__inner md-grid" aria-label="Footer">
        
          
          <a href="../../../01/25/migrating-kubernetes-volumes-to-longhorn/" class="md-footer__link md-footer__link--prev" aria-label="Previous: Migrating Kubernetes volumes to Longhorn">
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"></path></svg>
            </div>
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Previous
              </span>
              <div class="md-ellipsis">
                Migrating Kubernetes volumes to Longhorn
              </div>
            </div>
          </a>
        
        
          
          <a href="../../10/self-hosted-personal-dis-organizer-with-vikunja/" class="md-footer__link md-footer__link--next" aria-label="Next: Self-hosted Personal Dis-Organizer with Vikunja">
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Next
              </span>
              <div class="md-ellipsis">
                Self-hosted Personal Dis-Organizer with Vikunja
              </div>
            </div>
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11z"></path></svg>
            </div>
          </a>
        
      </nav>
    
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright  2019-2025 Ponder Stibbons
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      
      <script id="__config" type="application/json">{"annotate": null, "base": "../../../../..", "features": ["content.code.copy", "navigation.expand", "navigation.footer", "navigation.top", "search.highlight", "search.suggest"], "search": "../../../../../assets/javascripts/workers/search.2c215733.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../../../../assets/javascripts/bundle.79ae519e.min.js"></script>
      
    
  
<script id="init-glightbox">const lightbox = GLightbox({"touchNavigation": true, "loop": false, "zoomable": true, "draggable": true, "openEffect": "zoom", "closeEffect": "zoom", "slideEffect": "slide"});
document$.subscribe(()=>{ lightbox.reload(); });
</script></body></html>