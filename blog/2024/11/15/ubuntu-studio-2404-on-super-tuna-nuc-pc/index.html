<!DOCTYPE html><html lang="en" class="no-js"><head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://stibbons1990.github.io/hex/blog/2024/11/15/ubuntu-studio-2404-on-super-tuna-nuc-pc/">
      
      
        <link rel="prev" href="../../03/ubuntu-studio-2404-on-rapture-gaming-pc-and-more/">
      
      
        <link rel="next" href="../../../12/03/starting-a-blog-with-mkdocs-material-on-github-pages/">
      
      
        
      
      
      <link rel="icon" href="../../../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.7.1">
    
    
      
        <title>Ubuntu Studio 24.04 on Super Tuna (NUC PC) - Inadvisably Applied Magic</title>
      
    
    
      <link rel="stylesheet" href="../../../../../assets/stylesheets/main.484c7ddc.min.css">
      
        
        <link rel="stylesheet" href="../../../../../assets/stylesheets/palette.ab4e12ef.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&amp;display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../../../../stylesheets/extra.css">
    
    <script>__md_scope=new URL("../../../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      
  


  
  

<script id="__analytics">function __md_analytics(){function e(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],e("js",new Date),e("config","G-Y167L3ZVGY"),document.addEventListener("DOMContentLoaded",(function(){document.forms.search&&document.forms.search.query.addEventListener("blur",(function(){this.value&&e("event","search",{search_term:this.value})}));document$.subscribe((function(){var t=document.forms.feedback;if(void 0!==t)for(var a of t.querySelectorAll("[type=submit]"))a.addEventListener("click",(function(a){a.preventDefault();var n=document.location.pathname,d=this.getAttribute("data-md-value");e("event","feedback",{page:n,data:d}),t.firstElementChild.disabled=!0;var r=t.querySelector(".md-feedback__note [data-md-value='"+d+"']");r&&(r.hidden=!1)})),t.hidden=!1})),location$.subscribe((function(t){e("config","G-Y167L3ZVGY",{page_path:t.pathname})}))}));var t=document.createElement("script");t.async=!0,t.src="https://www.googletagmanager.com/gtag/js?id=G-Y167L3ZVGY",document.getElementById("__analytics").insertAdjacentElement("afterEnd",t)}</script>
  
    <script>"undefined"!=typeof __md_analytics&&__md_analytics()</script>
  

    
    
  <link href="../../../../../assets/stylesheets/glightbox.min.css" rel="stylesheet"><script src="../../../../../assets/javascripts/glightbox.min.js"></script><style id="glightbox-style">
            html.glightbox-open { overflow: initial; height: 100%; }
            .gslide-title { margin-top: 0px; user-select: text; }
            .gslide-desc { color: #666; user-select: text; }
            .gslide-image img { background: white; }
            .gscrollbar-fixer { padding-right: 15px; }
            .gdesc-inner { font-size: 0.75rem; }
            body[data-md-color-scheme="slate"] .gdesc-inner { background: var(--md-default-bg-color); }
            body[data-md-color-scheme="slate"] .gslide-title { color: var(--md-default-fg-color); }
            body[data-md-color-scheme="slate"] .gslide-desc { color: var(--md-default-fg-color); }
        </style></head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="slate" data-md-color-primary="deep-purple" data-md-color-accent="green">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#preparation" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../../../.." title="Inadvisably Applied Magic" class="md-header__button md-logo" aria-label="Inadvisably Applied Magic" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="m64 400 85.7-208.2c17-41.3 47.8-75.3 87.2-96.3l146.9-78.3c12.3-6.6 26.5 4.7 23 18.2l-37.2 142.4c-1.1 4.1-1.6 8.3-1.6 12.6 0 6.3 1.2 12.6 3.6 18.5L448 400H240.9l11.8-35.4 40.4-13.5c6.5-2.2 10.9-8.3 10.9-15.2s-4.4-13-10.9-15.2l-40.4-13.5-13.5-40.4c-2.2-6.4-8.3-10.8-15.2-10.8s-13 4.4-15.2 10.9l-13.5 40.4-40.4 13.5c-6.5 2.2-10.9 8.3-10.9 15.2s4.4 13 10.9 15.2l40.4 13.5 11.8 35.4H64zm215.6-258.5c-1.1-3.3-4.1-5.5-7.6-5.5s-6.5 2.2-7.6 5.5l-6.7 20.2-20.2 6.7c-3.3 1.1-5.5 4.1-5.5 7.6s2.2 6.5 5.5 7.6l20.2 6.7 6.7 20.2c1.1 3.3 4.1 5.5 7.6 5.5s6.5-2.2 7.6-5.5l6.7-20.2 20.2-6.7c3.3-1.1 5.5-4.1 5.5-7.6s-2.2-6.5-5.5-7.6l-20.2-6.7zM32 448h448c17.7 0 32 14.3 32 32s-14.3 32-32 32H32c-17.7 0-32-14.3-32-32s14.3-32 32-32"></path></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"></path></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Inadvisably Applied Magic
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Ubuntu Studio 24.04 on Super Tuna (NUC PC)
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="deep-purple" data-md-color-accent="green" aria-label="Dark mode" type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 7a5 5 0 0 1 5 5 5 5 0 0 1-5 5 5 5 0 0 1-5-5 5 5 0 0 1 5-5m0 2a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3m0-7 2.39 3.42C13.65 5.15 12.84 5 12 5s-1.65.15-2.39.42zM3.34 7l4.16-.35A7.2 7.2 0 0 0 5.94 8.5c-.44.74-.69 1.5-.83 2.29zm.02 10 1.76-3.77a7.131 7.131 0 0 0 2.38 4.14zM20.65 7l-1.77 3.79a7.02 7.02 0 0 0-2.38-4.15zm-.01 10-4.14.36c.59-.51 1.12-1.14 1.54-1.86.42-.73.69-1.5.83-2.29zM12 22l-2.41-3.44c.74.27 1.55.44 2.41.44.82 0 1.63-.17 2.37-.44z"></path></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="deep-purple" data-md-color-accent="green" aria-label="Light mode" type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m17.75 4.09-2.53 1.94.91 3.06-2.63-1.81-2.63 1.81.91-3.06-2.53-1.94L12.44 4l1.06-3 1.06 3zm3.5 6.91-1.64 1.25.59 1.98-1.7-1.17-1.7 1.17.59-1.98L15.75 11l2.06-.05L18.5 9l.69 1.95zm-2.28 4.95c.83-.08 1.72 1.1 1.19 1.85-.32.45-.66.87-1.08 1.27C15.17 23 8.84 23 4.94 19.07c-3.91-3.9-3.91-10.24 0-14.14.4-.4.82-.76 1.27-1.08.75-.53 1.93.36 1.85 1.19-.27 2.86.69 5.83 2.89 8.02a9.96 9.96 0 0 0 8.02 2.89m-1.64 2.02a12.08 12.08 0 0 1-7.8-3.47c-2.17-2.19-3.33-5-3.49-7.82-2.81 3.14-2.7 7.96.31 10.98 3.02 3.01 7.84 3.12 10.98.31"></path></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"></path></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"></path></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"></path></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"></path></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
                
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" hidden>
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../../../.." title="Inadvisably Applied Magic" class="md-nav__button md-logo" aria-label="Inadvisably Applied Magic" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="m64 400 85.7-208.2c17-41.3 47.8-75.3 87.2-96.3l146.9-78.3c12.3-6.6 26.5 4.7 23 18.2l-37.2 142.4c-1.1 4.1-1.6 8.3-1.6 12.6 0 6.3 1.2 12.6 3.6 18.5L448 400H240.9l11.8-35.4 40.4-13.5c6.5-2.2 10.9-8.3 10.9-15.2s-4.4-13-10.9-15.2l-40.4-13.5-13.5-40.4c-2.2-6.4-8.3-10.8-15.2-10.8s-13 4.4-15.2 10.9l-13.5 40.4-40.4 13.5c-6.5 2.2-10.9 8.3-10.9 15.2s4.4 13 10.9 15.2l40.4 13.5 11.8 35.4H64zm215.6-258.5c-1.1-3.3-4.1-5.5-7.6-5.5s-6.5 2.2-7.6 5.5l-6.7 20.2-20.2 6.7c-3.3 1.1-5.5 4.1-5.5 7.6s2.2 6.5 5.5 7.6l20.2 6.7 6.7 20.2c1.1 3.3 4.1 5.5 7.6 5.5s6.5-2.2 7.6-5.5l6.7-20.2 20.2-6.7c3.3-1.1 5.5-4.1 5.5-7.6s-2.2-6.5-5.5-7.6l-20.2-6.7zM32 448h448c17.7 0 32 14.3 32 32s-14.3 32-32 32H32c-17.7 0-32-14.3-32-32s14.3-32 32-32"></path></svg>

    </a>
    Inadvisably Applied Magic
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    About This Place
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_2">
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Projects
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    Projects
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../projects/conmon/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Continuous Monitoring
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../projects/self-hosting/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Self-hosting
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      <a href="../../../../" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Unexpected Linux Adventures
  

    
  </span>
  
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
                
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#preparation" class="md-nav__link">
    <span class="md-ellipsis">
      
        Preparation
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#install-ubuntu-studio-2404" class="md-nav__link">
    <span class="md-ellipsis">
      
        Install Ubuntu Studio 24.04
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Install Ubuntu Studio 24.04">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#first-boot-into-ubuntu-studio-2404" class="md-nav__link">
    <span class="md-ellipsis">
      
        First boot into Ubuntu Studio 24.04
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="First boot into Ubuntu Studio 24.04">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#disable-power-saving-suspend" class="md-nav__link">
    <span class="md-ellipsis">
      
        Disable Power Saving / Suspend
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ssh-server" class="md-nav__link">
    <span class="md-ellipsis">
      
        SSH Server
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#check-ip-addresses-on-lan-wlan" class="md-nav__link">
    <span class="md-ellipsis">
      
        Check IP addresses on LAN &amp; WLAN
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#install-essential-packages" class="md-nav__link">
    <span class="md-ellipsis">
      
        Install Essential Packages
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Install Essential Packages">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#brave-browser" class="md-nav__link">
    <span class="md-ellipsis">
      
        Brave browser
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#google-chrome" class="md-nav__link">
    <span class="md-ellipsis">
      
        Google Chrome
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#continuous-monitoring" class="md-nav__link">
    <span class="md-ellipsis">
      
        Continuous Monitoring
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Continuous Monitoring">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#hardware-sensors" class="md-nav__link">
    <span class="md-ellipsis">
      
        Hardware Sensors
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#system-configuration" class="md-nav__link">
    <span class="md-ellipsis">
      
        System Configuration
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="System Configuration">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#apt-respositories-clean-up" class="md-nav__link">
    <span class="md-ellipsis">
      
        APT respositories clean-up
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ubuntu-pro" class="md-nav__link">
    <span class="md-ellipsis">
      
        Ubuntu Pro
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#make-dmesg-non-privileged" class="md-nav__link">
    <span class="md-ellipsis">
      
        Make dmesg non-privileged
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#weekly-btrfs-scrub" class="md-nav__link">
    <span class="md-ellipsis">
      
        Weekly btrfs scrub
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#make-sddm-look-good" class="md-nav__link">
    <span class="md-ellipsis">
      
        Make SDDM Look Good
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bluetooth-controller" class="md-nav__link">
    <span class="md-ellipsis">
      
        Bluetooth controller
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Bluetooth controller">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#bluetooth-headphones" class="md-nav__link">
    <span class="md-ellipsis">
      
        Bluetooth headphones
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#kernel-memory-leak" class="md-nav__link">
    <span class="md-ellipsis">
      
        Kernel memory leak
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Kernel memory leak">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#suspect-driver-i915" class="md-nav__link">
    <span class="md-ellipsis">
      
        Suspect driver: i915
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maybe-somewhere-else" class="md-nav__link">
    <span class="md-ellipsis">
      
        Maybe somewhere else?
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maybe-gone-after-reinstalling" class="md-nav__link">
    <span class="md-ellipsis">
      
        Maybe gone after reinstalling?
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Maybe gone after reinstalling?">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#but-why" class="md-nav__link">
    <span class="md-ellipsis">
      
        But Why?
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#not-gone-after-reinstalling" class="md-nav__link">
    <span class="md-ellipsis">
      
        Not gone after reinstalling
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Not gone after reinstalling">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#byte-level-memory-vmalloc" class="md-nav__link">
    <span class="md-ellipsis">
      
        Byte-level memory: VMalloc
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Byte-level memory: VMalloc">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#slab-allocator" class="md-nav__link">
    <span class="md-ellipsis">
      
        Slab allocator
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#debug-memory-leak" class="md-nav__link">
    <span class="md-ellipsis">
      
        Debug memory leak
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#disable-swap" class="md-nav__link">
    <span class="md-ellipsis">
      
        Disable swap
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#remove-cups" class="md-nav__link">
    <span class="md-ellipsis">
      
        Remove CUPS
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#december-2025-follow-up" class="md-nav__link">
    <span class="md-ellipsis">
      
        December 2025 Follow-up
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="December 2025 Follow-up">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#tweak-google-chrome" class="md-nav__link">
    <span class="md-ellipsis">
      
        Tweak Google Chrome
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Tweak Google Chrome">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#disable-gpu-override" class="md-nav__link">
    <span class="md-ellipsis">
      
        Disable GPU override
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#install-the-h264ify-extension" class="md-nav__link">
    <span class="md-ellipsis">
      
        Install the h264ify extension
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#switching-to-the-xe-driver" class="md-nav__link">
    <span class="md-ellipsis">
      
        Switching to the xe driver
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Switching to the xe driver">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#gpu-monitoring" class="md-nav__link">
    <span class="md-ellipsis">
      
        GPU monitoring
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#install-va-driver-non-free" class="md-nav__link">
    <span class="md-ellipsis">
      
        Install VA driver non-free
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#reinstall-linux-firmware" class="md-nav__link">
    <span class="md-ellipsis">
      
        Reinstall linux-firmware
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#grant-access-to-devdri" class="md-nav__link">
    <span class="md-ellipsis">
      
        Grant access to /dev/dri
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#graphical-glitches" class="md-nav__link">
    <span class="md-ellipsis">
      
        Graphical glitches
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Graphical glitches">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#disable-panel-self-refresh" class="md-nav__link">
    <span class="md-ellipsis">
      
        Disable Panel Self Refresh
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#toggle-iommu-for-graphics" class="md-nav__link">
    <span class="md-ellipsis">
      
        Toggle IOMMU for Graphics
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#roolback-to-i915" class="md-nav__link">
    <span class="md-ellipsis">
      
        Roolback to i915
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Roolback to i915">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#summary-of-changes" class="md-nav__link">
    <span class="md-ellipsis">
      
        Summary of changes
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#future-plans" class="md-nav__link">
    <span class="md-ellipsis">
      
        Future Plans
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Future Plans">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#disable-panel-self-refresh_1" class="md-nav__link">
    <span class="md-ellipsis">
      
        Disable Panel Self Refresh
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#update-bios-microcode" class="md-nav__link">
    <span class="md-ellipsis">
      
        Update BIOS &amp; Microcode
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2026-update-linux-kernel-614" class="md-nav__link">
    <span class="md-ellipsis">
      
        2026 Update: Linux kernel 6.14
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
  <div class="md-content md-content--post" data-md-component="content">
    <div class="md-sidebar md-sidebar--post" data-md-component="sidebar" data-md-type="navigation">
      <div class="md-sidebar__scrollwrap">
        <div class="md-sidebar__inner md-post">
          <nav class="md-nav md-nav--primary">
            <div class="md-post__back">
              <div class="md-nav__title md-nav__container">
                <a href="../../../../" class="md-nav__link">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"></path></svg>
                  <span class="md-ellipsis">
                    Back to index
                  </span>
                </a>
              </div>
            </div>
            
            <ul class="md-post__meta md-nav__list">
              <li class="md-nav__item md-nav__item--section">
                <div class="md-post__title">
                  <span class="md-ellipsis">
                    Metadata
                  </span>
                </div>
                <nav class="md-nav">
                  <ul class="md-nav__list">
                    <li class="md-nav__item">
                      <div class="md-nav__link">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 19H5V8h14m-3-7v2H8V1H6v2H5c-1.11 0-2 .89-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V5a2 2 0 0 0-2-2h-1V1m-1 11h-5v5h5z"></path></svg>
                        <time datetime="2024-11-15 00:00:00+00:00" class="md-ellipsis">November 15, 2024</time>
                      </div>
                    </li>
                    
                    
                      <li class="md-nav__item">
                        <div class="md-nav__link">
                          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9 3v15h3V3zm3 2 4 13 3-1-4-13zM5 5v13h3V5zM3 19v2h18v-2z"></path></svg>
                          <span class="md-ellipsis">
                            in
                            
                              <a href="../../../../category/linux/">linux</a>, 
                              <a href="../../../../category/ubuntu/">Ubuntu</a>, 
                              <a href="../../../../category/installation/">installation</a>, 
                              <a href="../../../../category/setup/">setup</a>, 
                              <a href="../../../../category/intel/">intel</a>, 
                              <a href="../../../../category/nuc/">nuc</a></span>
                        </div>
                      </li>
                    
                    
                      
                      <li class="md-nav__item">
                        <div class="md-nav__link">
                          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 20a8 8 0 0 0 8-8 8 8 0 0 0-8-8 8 8 0 0 0-8 8 8 8 0 0 0 8 8m0-18a10 10 0 0 1 10 10 10 10 0 0 1-10 10C6.47 22 2 17.5 2 12A10 10 0 0 1 12 2m.5 5v5.25l4.5 2.67-.75 1.23L11 13V7z"></path></svg>
                          <span class="md-ellipsis">
                            
                              46 min read
                            
                          </span>
                        </div>
                      </li>
                    
                  </ul>
                </nav>
              </li>
            </ul>
            
          </nav>
          
        </div>
      </div>
    </div>
    <article class="md-content__inner md-typeset">
      
        
  




  <h1>Ubuntu Studio 24.04 on Super Tuna (NUC PC)</h1>

<p>This <em>would</em> be a very minimal journey of installing
<a href="https://ubuntustudio.org/2024/04/ubuntu-studio-24-04-lts-released/">Ubuntu Studio 24.04</a>
on a relatively new mid-range Intel® NUC 13 Pro mini PC, had it not gone wahoonie-shaped...</p>
<!-- more -->

<h2 id="preparation">Preparation</h2>
<p>The following components are chosen for a most compact, possibly <em>portable</em>
desktop setup, to be running 24x7 without taking much space:</p>
<ul>
<li><a href="https://www.simplynuc.media/wp-content/uploads/2023/07/Arena-Canyon-i5-v5-Slim-NUC13ANKi5-v5-v1.1.pdf">ASUS Arena Canyon NUC13ANKI5</a>.
  with a 13th Generation Intel® Core™ i5-1340P and integrated Intel® UHD Graphics.</li>
<li><a href="https://www.kingston.com/en/memory/gaming/kingston-fury-impact-ddr4-memory">Kingston FURY Impact DDR4 Memory</a>
  (32 GB, 3200 MHz, DDR4).</li>
<li><a href="https://www.kingston.com/latam/ssd/gaming/kingston-fury-renegade-nvme-m2-ssd">Kingston FURY Renegade PCIe 4.0 NVMe M.2 SSD</a>.</li>
<li>14" Full HD 1080p Portable Monitor 
  <a href="https://www.verbatim-europe.com/en/portable-monitors/products/portable-monitor-14-full-hd-1080p-pm14-49590">Verbatim PM-14</a>.</li>
<li>Logitech
  <a href="https://www.logitech.com/en-eu/shop/p/k400-plus-touchpad-keyboard">K400 Plus Wireless Touch Keyboard</a>.</li>
</ul>
<h2 id="install-ubuntu-studio-2404">Install Ubuntu Studio 24.04</h2>
<p>Prepared the USB stick with <code>usb-creator-kde</code> and booted into
it, then used the “Install Ubuntu” launcher on the desktop.</p>
<ol>
<li>Plug the USB stick and turn the PC on.</li>
<li>Press <strong><code>F8</code></strong> to select the boot device and choose the
    <strong>UEFI: ...</strong> option.</li>
<li>In the Grub menu, choose to <strong>Try or Install Ubuntu</strong>.</li>
<li>Select language (English) and then <strong>Install Ubuntu</strong>.</li>
<li>Select keyboard layout (can be from a different language).</li>
<li>Select the appropriate wireless or <strong>wireless network</strong>.</li>
<li>Select <strong>Try Ubuntu Studio</strong>.</li>
<li><strong>Disable screen locking</strong> to prevent
    <a href="https://launchpad.net/bugs/2062402">KDE Plasma live lock screen rendering the session useless</a>:<ul>
<li>Press Alt-Space to invoke Krunner and type “System Settings”.</li>
<li>From there, search for “Screen Locking” and</li>
<li>deactivate “Lock automatically after…”.</li>
</ul>
</li>
<li>Select Type of install: <strong>Interactive Installation</strong>.</li>
<li>Enable the options to<ul>
<li><strong>Install third-party software for graphics and Wifi hardware</strong> and</li>
<li><strong>Download and install support for additional media formats</strong>.</li>
</ul>
</li>
<li>Select <strong>Manual Installation</strong><ul>
<li>Use the arrow keys to navigate down to the <strong>nvme0n1</strong> disk.</li>
<li>Set <strong>nvme0n1p1</strong> (300 MB) as <strong>EFI System Partition</strong> mounted
    on <code>/boot/efi</code></li>
<li>Set <strong>nvme0n1p2</strong> (60 GB) as <strong>ext4</strong> mounted on <code>/</code></li>
<li>Leave <strong>nvme0n1p3</strong> (60 GB) alone (to be used for Ubuntu 26.04)</li>
<li>Set <strong>nvme0n1p4</strong> (3.88 TB) as <strong>Leave formatted as Btrfs</strong>
    mounted on <code>/home</code></li>
<li>Set <strong>Device for boot loader installation</strong> to <strong>nvme0n1</strong></li>
</ul>
</li>
<li>Click on <strong>Next</strong> to confirm the partition selection.</li>
<li>Confirm first non-root user name (<code>coder</code>) and computer
    name (<code>super-tuna</code>).</li>
<li>Select time zone (seems to be detected correctly).</li>
<li>Review the choices and click on <strong>Install</strong> to start copying files.</li>
<li>Once it's done, select <strong>Restart</strong>
    (remove install media and hit <code>Enter</code>).</li>
</ol>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>60 GB should be a enough for the root partition for the amount
of software that tends to be installed in this PC.</p>
</div>
<h3 id="first-boot-into-ubuntu-studio-2404">First boot into Ubuntu Studio 24.04</h3>
<h4 id="disable-power-saving-suspend">Disable Power Saving / Suspend</h4>
<p>This desktop will need to continue running as normal even when left alone for
extended periods of time. To avoid interruptions, open the <strong>Energy Saving</strong>
section in <strong>System Settings</strong> and disable <strong>Screen Energy Saving</strong> and
<strong>Suspend session</strong>.</p>
<h4 id="ssh-server">SSH Server</h4>
<p>Ubuntu Studio doesn't enable the SSH server by default, but we want
this to adjust the system remotely:</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="gp"># </span>apt<span class="w"> </span>install<span class="w"> </span>ssh<span class="w"> </span>-y
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a><span class="gp"># </span>sed<span class="w"> </span>-i<span class="w"> </span><span class="s1">'s/#PermitRootLogin prohibit-password/PermitRootLogin yes/'</span><span class="w"> </span>/etc/ssh/sshd_config
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a><span class="gp"># </span>systemctl<span class="w"> </span><span class="nb">enable</span><span class="w"> </span>--now<span class="w"> </span>ssh
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a><span class="gp"># </span>systemctl<span class="w"> </span>daemon-reload
</span><span id="__span-0-5"><a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a><span class="gp"># </span>systemctl<span class="w"> </span>restart<span class="w"> </span>sshd.service
</span></code></pre></div>
<p>Enable SSH from trusted hosts by adding them to <code>.ssh/authorized_keys</code> and copy content of <code>/etc/hosts</code> from a relevant host (e.g. <code>pi-z2</code>).</p>
<h4 id="check-ip-addresses-on-lan-wlan">Check IP addresses on LAN &amp; WLAN</h4>
<p>This system will normally not be connected to the local wired network,
so it is important to take note of both IP addresses it has obtained
from the DHCP server:</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a><span class="gp"># </span>ip<span class="w"> </span>a
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a><span class="go">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000</span>
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a><span class="go">    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span>
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4" href="#__codelineno-1-4"></a><span class="go">    inet 127.0.0.1/8 scope host lo</span>
</span><span id="__span-1-5"><a id="__codelineno-1-5" name="__codelineno-1-5" href="#__codelineno-1-5"></a><span class="go">       valid_lft forever preferred_lft forever</span>
</span><span id="__span-1-6"><a id="__codelineno-1-6" name="__codelineno-1-6" href="#__codelineno-1-6"></a><span class="go">    inet6 ::1/128 scope host noprefixroute </span>
</span><span id="__span-1-7"><a id="__codelineno-1-7" name="__codelineno-1-7" href="#__codelineno-1-7"></a><span class="go">       valid_lft forever preferred_lft forever</span>
</span><span id="__span-1-8"><a id="__codelineno-1-8" name="__codelineno-1-8" href="#__codelineno-1-8"></a><span class="go">2: enp86s0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc mq state UP group default qlen 1000</span>
</span><span id="__span-1-9"><a id="__codelineno-1-9" name="__codelineno-1-9" href="#__codelineno-1-9"></a><span class="go">    link/ether 48:21:0b:57:51:92 brd ff:ff:ff:ff:ff:ff</span>
</span><span id="__span-1-10"><a id="__codelineno-1-10" name="__codelineno-1-10" href="#__codelineno-1-10"></a><span class="go">    inet 192.168.0.68/24 brd 192.168.0.255 scope global dynamic noprefixroute enp86s0</span>
</span><span id="__span-1-11"><a id="__codelineno-1-11" name="__codelineno-1-11" href="#__codelineno-1-11"></a><span class="go">       valid_lft 85819sec preferred_lft 85819sec</span>
</span><span id="__span-1-12"><a id="__codelineno-1-12" name="__codelineno-1-12" href="#__codelineno-1-12"></a><span class="go">    inet6 fe80::4a21:bff:fe57:5192/64 scope link </span>
</span><span id="__span-1-13"><a id="__codelineno-1-13" name="__codelineno-1-13" href="#__codelineno-1-13"></a><span class="go">       valid_lft forever preferred_lft forever</span>
</span><span id="__span-1-14"><a id="__codelineno-1-14" name="__codelineno-1-14" href="#__codelineno-1-14"></a><span class="go">3: enx5c857e3e1129: &lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt; mtu 1500 qdisc pfifo_fast state DOWN group default qlen 1000</span>
</span><span id="__span-1-15"><a id="__codelineno-1-15" name="__codelineno-1-15" href="#__codelineno-1-15"></a><span class="go">    link/ether 5c:85:7e:3e:11:29 brd ff:ff:ff:ff:ff:ff</span>
</span><span id="__span-1-16"><a id="__codelineno-1-16" name="__codelineno-1-16" href="#__codelineno-1-16"></a><span class="go">4: wlo1: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP group default qlen 1000</span>
</span><span id="__span-1-17"><a id="__codelineno-1-17" name="__codelineno-1-17" href="#__codelineno-1-17"></a><span class="go">    link/ether e0:c2:64:39:17:73 brd ff:ff:ff:ff:ff:ff</span>
</span><span id="__span-1-18"><a id="__codelineno-1-18" name="__codelineno-1-18" href="#__codelineno-1-18"></a><span class="go">    altname wlp0s20f3</span>
</span><span id="__span-1-19"><a id="__codelineno-1-19" name="__codelineno-1-19" href="#__codelineno-1-19"></a><span class="go">    inet 192.168.0.17/24 brd 192.168.0.255 scope global dynamic noprefixroute wlo1</span>
</span><span id="__span-1-20"><a id="__codelineno-1-20" name="__codelineno-1-20" href="#__codelineno-1-20"></a><span class="go">       valid_lft 85820sec preferred_lft 85820sec</span>
</span><span id="__span-1-21"><a id="__codelineno-1-21" name="__codelineno-1-21" href="#__codelineno-1-21"></a><span class="go">    inet6 fe80::56d1:3cea:139:daaf/64 scope link noprefixroute </span>
</span><span id="__span-1-22"><a id="__codelineno-1-22" name="__codelineno-1-22" href="#__codelineno-1-22"></a><span class="go">       valid_lft forever preferred_lft forever</span>
</span></code></pre></div>
<h2 id="install-essential-packages">Install Essential Packages</h2>
<p>Start by installing a <strong>subset</strong> of the
<a href="../../../09/14/ubuntu-studio-2404-on-computer-for-a-young-artist/#install-essential-packages">essential packages</a>, plus a few more 
that have been found necessary later (e.g. <code>auditd</code> to
<a href="../../03/ubuntu-studio-2404-on-rapture-gaming-pc-and-more/#stop-apparmor-spew-in-the-logs">stop apparmor spew in the logs</a>):</p>
<details class="terminal">
<summary><code># apt install ...</code></summary>
<div class="language-console highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a><span class="gp"># </span>apt<span class="w"> </span>install<span class="w"> </span>gdebi-core<span class="w"> </span>wget<span class="w"> </span>vim<span class="w"> </span>curl<span class="w"> </span>geeqie<span class="w"> </span>playonlinux<span class="w"> </span><span class="se">\</span>
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a><span class="w">  </span>exfat-fuse<span class="w"> </span>clementine<span class="w"> </span>id3v2<span class="w"> </span>htop<span class="w"> </span>vnstat<span class="w"> </span>sox<span class="w"> </span>wine<span class="w"> </span>smem<span class="w"> </span><span class="se">\</span>
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a><span class="w">  </span>python-is-python3<span class="w"> </span>exiv2<span class="w"> </span>rename<span class="w"> </span>scrot<span class="w"> </span>xcalib<span class="w"> </span>python3-pip<span class="w"> </span><span class="se">\</span>
</span><span id="__span-2-4"><a id="__codelineno-2-4" name="__codelineno-2-4" href="#__codelineno-2-4"></a><span class="w">  </span>netcat-openbsd<span class="w"> </span>python3-selenium<span class="w"> </span>lm-sensors<span class="w"> </span>sysstat<span class="w"> </span>tor<span class="w"> </span><span class="se">\</span>
</span><span id="__span-2-5"><a id="__codelineno-2-5" name="__codelineno-2-5" href="#__codelineno-2-5"></a><span class="w">  </span>unrar<span class="w"> </span>ttf-mscorefonts-installer<span class="w"> </span>winetricks<span class="w"> </span>icc-profiles<span class="w"> </span><span class="se">\</span>
</span><span id="__span-2-6"><a id="__codelineno-2-6" name="__codelineno-2-6" href="#__codelineno-2-6"></a><span class="w">  </span>ffmpeg<span class="w"> </span>iotop-c<span class="w"> </span>xdotool<span class="w"> </span>inxi<span class="w"> </span>mpv<span class="w"> </span>screen<span class="w"> </span>libxxf86vm-dev<span class="w"> </span><span class="se">\</span>
</span><span id="__span-2-7"><a id="__codelineno-2-7" name="__codelineno-2-7" href="#__codelineno-2-7"></a><span class="w">  </span>displaycal<span class="w"> </span>intel-gpu-tools<span class="w"> </span>redshift-qt<span class="w"> </span>auditd<span class="w"> </span>-y
</span><span id="__span-2-8"><a id="__codelineno-2-8" name="__codelineno-2-8" href="#__codelineno-2-8"></a><span class="go">Reading package lists... Done</span>
</span><span id="__span-2-9"><a id="__codelineno-2-9" name="__codelineno-2-9" href="#__codelineno-2-9"></a><span class="go">Building dependency tree... Done</span>
</span><span id="__span-2-10"><a id="__codelineno-2-10" name="__codelineno-2-10" href="#__codelineno-2-10"></a><span class="go">Reading state information... Done</span>
</span><span id="__span-2-11"><a id="__codelineno-2-11" name="__codelineno-2-11" href="#__codelineno-2-11"></a><span class="go">The following additional packages will be installed:</span>
</span><span id="__span-2-12"><a id="__codelineno-2-12" name="__codelineno-2-12" href="#__codelineno-2-12"></a><span class="go">  cabextract chromium-browser chromium-chromedriver exiftran fonts-wine</span>
</span><span id="__span-2-13"><a id="__codelineno-2-13" name="__codelineno-2-13" href="#__codelineno-2-13"></a><span class="go">  fuseiso geeqie-common icoutils libasound2-plugins libaudit-common</span>
</span><span id="__span-2-14"><a id="__codelineno-2-14" name="__codelineno-2-14" href="#__codelineno-2-14"></a><span class="go">  libaudit1 libauparse0t64 libcapi20-3t64 libegl-mesa0 libegl1-mesa-dev</span>
</span><span id="__span-2-15"><a id="__codelineno-2-15" name="__codelineno-2-15" href="#__codelineno-2-15"></a><span class="go">  libgbm1 libgl1-mesa-dri libglapi-mesa libglx-mesa0 libgpod-common</span>
</span><span id="__span-2-16"><a id="__codelineno-2-16" name="__codelineno-2-16" href="#__codelineno-2-16"></a><span class="go">  libgpod4t64 liblastfm5-1 liblua5.3-0 libmspack0t64 libmygpo-qt5-1</span>
</span><span id="__span-2-17"><a id="__codelineno-2-17" name="__codelineno-2-17" href="#__codelineno-2-17"></a><span class="go">  libosmesa6 libpython3-dev libpython3.12-dev libsgutils2-1.46-2</span>
</span><span id="__span-2-18"><a id="__codelineno-2-18" name="__codelineno-2-18" href="#__codelineno-2-18"></a><span class="go">  libutempter0 libwine libxatracker2 libxdo3 libxkbregistry0 libz-mingw-w64</span>
</span><span id="__span-2-19"><a id="__codelineno-2-19" name="__codelineno-2-19" href="#__codelineno-2-19"></a><span class="go">  mesa-va-drivers mesa-vdpau-drivers mesa-vulkan-drivers python3-dev</span>
</span><span id="__span-2-20"><a id="__codelineno-2-20" name="__codelineno-2-20" href="#__codelineno-2-20"></a><span class="go">  python3-exceptiongroup python3-h11 python3-natsort python3-outcome</span>
</span><span id="__span-2-21"><a id="__codelineno-2-21" name="__codelineno-2-21" href="#__codelineno-2-21"></a><span class="go">  python3-sniffio python3-trio python3-trio-websocket python3-wsproto</span>
</span><span id="__span-2-22"><a id="__codelineno-2-22" name="__codelineno-2-22" href="#__codelineno-2-22"></a><span class="go">  python3.12-dev redshift tor-geoipdb torsocks tree vim-common vim-runtime</span>
</span><span id="__span-2-23"><a id="__codelineno-2-23" name="__codelineno-2-23" href="#__codelineno-2-23"></a><span class="go">  vim-tiny webp-pixbuf-loader wine64 xxd</span>
</span><span id="__span-2-24"><a id="__codelineno-2-24" name="__codelineno-2-24" href="#__codelineno-2-24"></a><span class="go">Suggested packages:</span>
</span><span id="__span-2-25"><a id="__codelineno-2-25" name="__codelineno-2-25" href="#__codelineno-2-25"></a><span class="go">  audispd-plugins xpaint libjpeg-progs libterm-readline-gnu-perl</span>
</span><span id="__span-2-26"><a id="__codelineno-2-26" name="__codelineno-2-26" href="#__codelineno-2-26"></a><span class="go">  | libterm-readline-perl-perl libxml-dumper-perl sg3-utils fancontrol</span>
</span><span id="__span-2-27"><a id="__codelineno-2-27" name="__codelineno-2-27" href="#__codelineno-2-27"></a><span class="go">  read-edid i2c-tools libcuda1 winbind python-natsort-doc byobu | screenie</span>
</span><span id="__span-2-28"><a id="__codelineno-2-28" name="__codelineno-2-28" href="#__codelineno-2-28"></a><span class="go">  | iselect libsox-fmt-all mixmaster torbrowser-launcher apparmor-utils nyx</span>
</span><span id="__span-2-29"><a id="__codelineno-2-29" name="__codelineno-2-29" href="#__codelineno-2-29"></a><span class="go">  obfs4proxy ctags vim-doc vim-scripts indent vnstati q4wine wine-binfmt</span>
</span><span id="__span-2-30"><a id="__codelineno-2-30" name="__codelineno-2-30" href="#__codelineno-2-30"></a><span class="go">  dosbox wine64-preloader</span>
</span><span id="__span-2-31"><a id="__codelineno-2-31" name="__codelineno-2-31" href="#__codelineno-2-31"></a><span class="go">Recommended packages:</span>
</span><span id="__span-2-32"><a id="__codelineno-2-32" name="__codelineno-2-32" href="#__codelineno-2-32"></a><span class="go">  wine32</span>
</span><span id="__span-2-33"><a id="__codelineno-2-33" name="__codelineno-2-33" href="#__codelineno-2-33"></a><span class="go">The following NEW packages will be installed:</span>
</span><span id="__span-2-34"><a id="__codelineno-2-34" name="__codelineno-2-34" href="#__codelineno-2-34"></a><span class="go">  auditd cabextract chromium-browser chromium-chromedriver clementine curl</span>
</span><span id="__span-2-35"><a id="__codelineno-2-35" name="__codelineno-2-35" href="#__codelineno-2-35"></a><span class="go">  exfat-fuse exiftran exiv2 fonts-wine fuseiso gdebi-core geeqie</span>
</span><span id="__span-2-36"><a id="__codelineno-2-36" name="__codelineno-2-36" href="#__codelineno-2-36"></a><span class="go">  geeqie-common htop icc-profiles icoutils id3v2 intel-gpu-tools inxi</span>
</span><span id="__span-2-37"><a id="__codelineno-2-37" name="__codelineno-2-37" href="#__codelineno-2-37"></a><span class="go">  iotop-c libasound2-plugins libauparse0t64 libcapi20-3t64 libgpod-common</span>
</span><span id="__span-2-38"><a id="__codelineno-2-38" name="__codelineno-2-38" href="#__codelineno-2-38"></a><span class="go">  libgpod4t64 liblastfm5-1 liblua5.3-0 libmspack0t64 libmygpo-qt5-1</span>
</span><span id="__span-2-39"><a id="__codelineno-2-39" name="__codelineno-2-39" href="#__codelineno-2-39"></a><span class="go">  libosmesa6 libpython3-dev libpython3.12-dev libsgutils2-1.46-2</span>
</span><span id="__span-2-40"><a id="__codelineno-2-40" name="__codelineno-2-40" href="#__codelineno-2-40"></a><span class="go">  libutempter0 libwine libxdo3 libxkbregistry0 libxxf86vm-dev libz-mingw-w64</span>
</span><span id="__span-2-41"><a id="__codelineno-2-41" name="__codelineno-2-41" href="#__codelineno-2-41"></a><span class="go">  lm-sensors mpv playonlinux python-is-python3 python3-dev</span>
</span><span id="__span-2-42"><a id="__codelineno-2-42" name="__codelineno-2-42" href="#__codelineno-2-42"></a><span class="go">  python3-exceptiongroup python3-h11 python3-natsort python3-outcome</span>
</span><span id="__span-2-43"><a id="__codelineno-2-43" name="__codelineno-2-43" href="#__codelineno-2-43"></a><span class="go">  python3-pip python3-selenium python3-sniffio python3-trio</span>
</span><span id="__span-2-44"><a id="__codelineno-2-44" name="__codelineno-2-44" href="#__codelineno-2-44"></a><span class="go">  python3-trio-websocket python3-wsproto python3.12-dev redshift redshift-qt</span>
</span><span id="__span-2-45"><a id="__codelineno-2-45" name="__codelineno-2-45" href="#__codelineno-2-45"></a><span class="go">  rename screen scrot sox tor tor-geoipdb torsocks tree</span>
</span><span id="__span-2-46"><a id="__codelineno-2-46" name="__codelineno-2-46" href="#__codelineno-2-46"></a><span class="go">  ttf-mscorefonts-installer unrar vim vim-runtime vnstat webp-pixbuf-loader</span>
</span><span id="__span-2-47"><a id="__codelineno-2-47" name="__codelineno-2-47" href="#__codelineno-2-47"></a><span class="go">  wine wine64 winetricks xcalib xdotool</span>
</span><span id="__span-2-48"><a id="__codelineno-2-48" name="__codelineno-2-48" href="#__codelineno-2-48"></a><span class="go">The following packages will be upgraded:</span>
</span><span id="__span-2-49"><a id="__codelineno-2-49" name="__codelineno-2-49" href="#__codelineno-2-49"></a><span class="go">  libaudit-common libaudit1 libegl-mesa0 libegl1-mesa-dev libgbm1</span>
</span><span id="__span-2-50"><a id="__codelineno-2-50" name="__codelineno-2-50" href="#__codelineno-2-50"></a><span class="go">  libgl1-mesa-dri libglapi-mesa libglx-mesa0 libxatracker2 mesa-va-drivers</span>
</span><span id="__span-2-51"><a id="__codelineno-2-51" name="__codelineno-2-51" href="#__codelineno-2-51"></a><span class="go">  mesa-vdpau-drivers mesa-vulkan-drivers vim-common vim-tiny xxd</span>
</span><span id="__span-2-52"><a id="__codelineno-2-52" name="__codelineno-2-52" href="#__codelineno-2-52"></a><span class="go">15 upgraded, 77 newly installed, 0 to remove and 71 not upgraded.</span>
</span><span id="__span-2-53"><a id="__codelineno-2-53" name="__codelineno-2-53" href="#__codelineno-2-53"></a><span class="go">Need to get 247 MB of archives.</span>
</span><span id="__span-2-54"><a id="__codelineno-2-54" name="__codelineno-2-54" href="#__codelineno-2-54"></a><span class="go">After this operation, 965 MB of additional disk space will be used.</span>
</span></code></pre></div>
</details>
<h3 id="brave-browser">Brave browser</h3>
<p>Install from the
<a href="https://brave.com/linux/#release-channel-installation">Release Channel</a>:</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a><span class="gp"># </span>curl<span class="w"> </span>-fsSLo<span class="w"> </span><span class="se">\</span>
</span><span id="__span-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a><span class="w">  </span>/usr/share/keyrings/brave-browser-archive-keyring.gpg<span class="w"> </span><span class="se">\</span>
</span><span id="__span-3-3"><a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a><span class="w">  </span>https://brave-browser-apt-release.s3.brave.com/brave-browser-archive-keyring.gpg
</span><span id="__span-3-4"><a id="__codelineno-3-4" name="__codelineno-3-4" href="#__codelineno-3-4"></a>
</span><span id="__span-3-5"><a id="__codelineno-3-5" name="__codelineno-3-5" href="#__codelineno-3-5"></a><span class="gp"># </span><span class="nb">echo</span><span class="w"> </span><span class="s2">"deb [signed-by=/usr/share/keyrings/brave-browser-archive-keyring.gpg] https://brave-browser-apt-release.s3.brave.com/ stable main"</span><span class="w"> </span><span class="se">\</span>
</span><span id="__span-3-6"><a id="__codelineno-3-6" name="__codelineno-3-6" href="#__codelineno-3-6"></a><span class="p">|</span><span class="w"> </span>tee<span class="w"> </span>/etc/apt/sources.list.d/brave-browser-release.list
</span><span id="__span-3-7"><a id="__codelineno-3-7" name="__codelineno-3-7" href="#__codelineno-3-7"></a>
</span><span id="__span-3-8"><a id="__codelineno-3-8" name="__codelineno-3-8" href="#__codelineno-3-8"></a><span class="gp"># </span>apt<span class="w"> </span>update<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>apt<span class="w"> </span>install<span class="w"> </span>brave-browser<span class="w"> </span>-y
</span></code></pre></div>
<h3 id="google-chrome">Google Chrome</h3>
<p>Installing <a href="https://google.com/chrome">Google Chrome</a> is as
simple as downloading the Debian package and installing it:</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a><span class="gp"># </span>dpkg<span class="w"> </span>-i<span class="w"> </span>google-chrome-stable_current_amd64.deb
</span></code></pre></div>
<h3 id="continuous-monitoring">Continuous Monitoring</h3>
<p>Install the
<a href="../../../../../projects/conmon/#deploy-to-pcs">multi-thread version</a>
of the <code>conmon</code> script as <code>/usr/local/bin/conmon</code> and
<a href="../../../../../projects/conmon/#install-conmon">run it as a service</a>;
create <code>/etc/systemd/system/conmon.service</code> as follows:</p>
<div class="language-ini highlight"><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a><span class="k">[Unit]</span>
</span><span id="__span-5-2"><a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a><span class="na">Description</span><span class="o">=</span><span class="s">Continuous Monitoring</span>
</span><span id="__span-5-3"><a id="__codelineno-5-3" name="__codelineno-5-3" href="#__codelineno-5-3"></a>
</span><span id="__span-5-4"><a id="__codelineno-5-4" name="__codelineno-5-4" href="#__codelineno-5-4"></a><span class="k">[Service]</span>
</span><span id="__span-5-5"><a id="__codelineno-5-5" name="__codelineno-5-5" href="#__codelineno-5-5"></a><span class="na">ExecStart</span><span class="o">=</span><span class="s">/usr/local/bin/conmon</span>
</span><span id="__span-5-6"><a id="__codelineno-5-6" name="__codelineno-5-6" href="#__codelineno-5-6"></a><span class="na">Restart</span><span class="o">=</span><span class="s">on-failure</span>
</span><span id="__span-5-7"><a id="__codelineno-5-7" name="__codelineno-5-7" href="#__codelineno-5-7"></a><span class="na">StandardOutput</span><span class="o">=</span><span class="s">null</span>
</span><span id="__span-5-8"><a id="__codelineno-5-8" name="__codelineno-5-8" href="#__codelineno-5-8"></a>
</span><span id="__span-5-9"><a id="__codelineno-5-9" name="__codelineno-5-9" href="#__codelineno-5-9"></a><span class="k">[Install]</span>
</span><span id="__span-5-10"><a id="__codelineno-5-10" name="__codelineno-5-10" href="#__codelineno-5-10"></a><span class="na">WantedBy</span><span class="o">=</span><span class="s">multi-user.target</span>
</span></code></pre></div>
<p>Then enable and start the services in <code>systemd</code>:</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-6-1"><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a><span class="gp"># </span>systemctl<span class="w"> </span><span class="nb">enable</span><span class="w"> </span>conmon.service
</span><span id="__span-6-2"><a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a><span class="gp"># </span>systemctl<span class="w"> </span>daemon-reload
</span><span id="__span-6-3"><a id="__codelineno-6-3" name="__codelineno-6-3" href="#__codelineno-6-3"></a><span class="gp"># </span>systemctl<span class="w"> </span>start<span class="w"> </span>conmon.service
</span><span id="__span-6-4"><a id="__codelineno-6-4" name="__codelineno-6-4" href="#__codelineno-6-4"></a><span class="gp"># </span>systemctl<span class="w"> </span>status<span class="w"> </span>conmon.service
</span></code></pre></div>
<p>If not already adjusted, add at least the following lines
to <code>/etc/hosts</code> so that <code>lexicon</code> is reachable:</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-7-1"><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a><span class="go">192.168.0.6     lexicon</span>
</span></code></pre></div>
<h4 id="hardware-sensors">Hardware Sensors</h4>
<p>All hardware sensors are supported out of the box:</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-8-1"><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a><span class="gp"># </span>sensors<span class="w"> </span>-A
</span><span id="__span-8-2"><a id="__codelineno-8-2" name="__codelineno-8-2" href="#__codelineno-8-2"></a><span class="go">iwlwifi_1-virtual-0</span>
</span><span id="__span-8-3"><a id="__codelineno-8-3" name="__codelineno-8-3" href="#__codelineno-8-3"></a><span class="go">temp1:        +37.0°C  </span>
</span><span id="__span-8-4"><a id="__codelineno-8-4" name="__codelineno-8-4" href="#__codelineno-8-4"></a>
</span><span id="__span-8-5"><a id="__codelineno-8-5" name="__codelineno-8-5" href="#__codelineno-8-5"></a><span class="go">ucsi_source_psy_USBC000:001-isa-0000</span>
</span><span id="__span-8-6"><a id="__codelineno-8-6" name="__codelineno-8-6" href="#__codelineno-8-6"></a><span class="go">in0:           0.00 V  (min =  +0.00 V, max =  +0.00 V)</span>
</span><span id="__span-8-7"><a id="__codelineno-8-7" name="__codelineno-8-7" href="#__codelineno-8-7"></a><span class="go">curr1:         0.00 A  (max =  +0.00 A)</span>
</span><span id="__span-8-8"><a id="__codelineno-8-8" name="__codelineno-8-8" href="#__codelineno-8-8"></a>
</span><span id="__span-8-9"><a id="__codelineno-8-9" name="__codelineno-8-9" href="#__codelineno-8-9"></a><span class="go">acpitz-acpi-0</span>
</span><span id="__span-8-10"><a id="__codelineno-8-10" name="__codelineno-8-10" href="#__codelineno-8-10"></a><span class="go">temp1:        +43.0°C  </span>
</span><span id="__span-8-11"><a id="__codelineno-8-11" name="__codelineno-8-11" href="#__codelineno-8-11"></a>
</span><span id="__span-8-12"><a id="__codelineno-8-12" name="__codelineno-8-12" href="#__codelineno-8-12"></a><span class="go">coretemp-isa-0000</span>
</span><span id="__span-8-13"><a id="__codelineno-8-13" name="__codelineno-8-13" href="#__codelineno-8-13"></a><span class="go">Package id 0:  +43.0°C  (high = +100.0°C, crit = +100.0°C)</span>
</span><span id="__span-8-14"><a id="__codelineno-8-14" name="__codelineno-8-14" href="#__codelineno-8-14"></a><span class="go">Core 0:        +36.0°C  (high = +100.0°C, crit = +100.0°C)</span>
</span><span id="__span-8-15"><a id="__codelineno-8-15" name="__codelineno-8-15" href="#__codelineno-8-15"></a><span class="go">Core 4:        +34.0°C  (high = +100.0°C, crit = +100.0°C)</span>
</span><span id="__span-8-16"><a id="__codelineno-8-16" name="__codelineno-8-16" href="#__codelineno-8-16"></a><span class="go">Core 8:        +35.0°C  (high = +100.0°C, crit = +100.0°C)</span>
</span><span id="__span-8-17"><a id="__codelineno-8-17" name="__codelineno-8-17" href="#__codelineno-8-17"></a><span class="go">Core 12:       +34.0°C  (high = +100.0°C, crit = +100.0°C)</span>
</span><span id="__span-8-18"><a id="__codelineno-8-18" name="__codelineno-8-18" href="#__codelineno-8-18"></a><span class="go">Core 16:       +40.0°C  (high = +100.0°C, crit = +100.0°C)</span>
</span><span id="__span-8-19"><a id="__codelineno-8-19" name="__codelineno-8-19" href="#__codelineno-8-19"></a><span class="go">Core 17:       +40.0°C  (high = +100.0°C, crit = +100.0°C)</span>
</span><span id="__span-8-20"><a id="__codelineno-8-20" name="__codelineno-8-20" href="#__codelineno-8-20"></a><span class="go">Core 18:       +40.0°C  (high = +100.0°C, crit = +100.0°C)</span>
</span><span id="__span-8-21"><a id="__codelineno-8-21" name="__codelineno-8-21" href="#__codelineno-8-21"></a><span class="go">Core 19:       +40.0°C  (high = +100.0°C, crit = +100.0°C)</span>
</span><span id="__span-8-22"><a id="__codelineno-8-22" name="__codelineno-8-22" href="#__codelineno-8-22"></a><span class="go">Core 20:       +42.0°C  (high = +100.0°C, crit = +100.0°C)</span>
</span><span id="__span-8-23"><a id="__codelineno-8-23" name="__codelineno-8-23" href="#__codelineno-8-23"></a><span class="go">Core 21:       +42.0°C  (high = +100.0°C, crit = +100.0°C)</span>
</span><span id="__span-8-24"><a id="__codelineno-8-24" name="__codelineno-8-24" href="#__codelineno-8-24"></a><span class="go">Core 22:       +41.0°C  (high = +100.0°C, crit = +100.0°C)</span>
</span><span id="__span-8-25"><a id="__codelineno-8-25" name="__codelineno-8-25" href="#__codelineno-8-25"></a><span class="go">Core 23:       +41.0°C  (high = +100.0°C, crit = +100.0°C)</span>
</span><span id="__span-8-26"><a id="__codelineno-8-26" name="__codelineno-8-26" href="#__codelineno-8-26"></a>
</span><span id="__span-8-27"><a id="__codelineno-8-27" name="__codelineno-8-27" href="#__codelineno-8-27"></a><span class="go">ucsi_source_psy_USBC000:002-isa-0000</span>
</span><span id="__span-8-28"><a id="__codelineno-8-28" name="__codelineno-8-28" href="#__codelineno-8-28"></a><span class="go">in0:           0.00 V  (min =  +0.00 V, max =  +0.00 V)</span>
</span><span id="__span-8-29"><a id="__codelineno-8-29" name="__codelineno-8-29" href="#__codelineno-8-29"></a><span class="go">curr1:         3.00 A  (max =  +0.00 A)</span>
</span><span id="__span-8-30"><a id="__codelineno-8-30" name="__codelineno-8-30" href="#__codelineno-8-30"></a>
</span><span id="__span-8-31"><a id="__codelineno-8-31" name="__codelineno-8-31" href="#__codelineno-8-31"></a><span class="go">nvme-pci-0100</span>
</span><span id="__span-8-32"><a id="__codelineno-8-32" name="__codelineno-8-32" href="#__codelineno-8-32"></a><span class="go">Composite:    +25.9°C  (low  = -20.1°C, high = +83.8°C)</span>
</span><span id="__span-8-33"><a id="__codelineno-8-33" name="__codelineno-8-33" href="#__codelineno-8-33"></a><span class="go">                       (crit = +88.8°C)</span>
</span><span id="__span-8-34"><a id="__codelineno-8-34" name="__codelineno-8-34" href="#__codelineno-8-34"></a><span class="go">Sensor 2:     +64.8°C  </span>
</span></code></pre></div>
<p>There is no need to load the <code>drivetemp</code> kernel module because
the only storage in this Nuc PC are NVMe drives, which already
show up as the <code>nvme-pci-0100</code> controller above.</p>
<h2 id="system-configuration">System Configuration</h2>
<p>The above having covered <strong>installing</strong> software, there are still
system configurations that need to be tweaked.</p>
<h3 id="apt-respositories-clean-up">APT respositories clean-up</h3>
<p>Ubuntu Studio 24.04 seems to consistently need a little
<a href="../../../09/14/ubuntu-studio-2404-on-computer-for-a-young-artist/#apt-respositories-clean-up">APT respositories clean-up</a>; just comment out the last line
in <code>/etc/apt/sources.list.d/dvd.list</code> to let <code>noble-security</code> be
defined (only) in <code>ubuntu.sources</code>.</p>
<h3 id="ubuntu-pro">Ubuntu Pro</h3>
<p>When updating the system with <code>apt full-upgrade -y</code> a notice comes
up about additional security updates:</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-9-1"><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a><span class="go">Get more security updates through Ubuntu Pro with 'esm-apps' enabled:</span>
</span><span id="__span-9-2"><a id="__codelineno-9-2" name="__codelineno-9-2" href="#__codelineno-9-2"></a><span class="go">  libdcmtk17t64 libcjson1 libavdevice60 ffmpeg libpostproc57 libavcodec60</span>
</span><span id="__span-9-3"><a id="__codelineno-9-3" name="__codelineno-9-3" href="#__codelineno-9-3"></a><span class="go">  libavutil58 libswscale7 libswresample4 libavformat60 libavfilter9</span>
</span><span id="__span-9-4"><a id="__codelineno-9-4" name="__codelineno-9-4" href="#__codelineno-9-4"></a><span class="go">Learn more about Ubuntu Pro at https://ubuntu.com/pro</span>
</span></code></pre></div>
<p>This being a new system, indeed it's not attached to an Ubuntu Pro
account (the old system was):</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-10-1"><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a><span class="gp"># </span>pro<span class="w"> </span>security-status
</span><span id="__span-10-2"><a id="__codelineno-10-2" name="__codelineno-10-2" href="#__codelineno-10-2"></a><span class="go">3131 packages installed:</span>
</span><span id="__span-10-3"><a id="__codelineno-10-3" name="__codelineno-10-3" href="#__codelineno-10-3"></a><span class="go">     1589 packages from Ubuntu Main/Restricted repository</span>
</span><span id="__span-10-4"><a id="__codelineno-10-4" name="__codelineno-10-4" href="#__codelineno-10-4"></a><span class="go">     1539 packages from Ubuntu Universe/Multiverse repository</span>
</span><span id="__span-10-5"><a id="__codelineno-10-5" name="__codelineno-10-5" href="#__codelineno-10-5"></a><span class="go">     3 packages from third parties</span>
</span><span id="__span-10-6"><a id="__codelineno-10-6" name="__codelineno-10-6" href="#__codelineno-10-6"></a>
</span><span id="__span-10-7"><a id="__codelineno-10-7" name="__codelineno-10-7" href="#__codelineno-10-7"></a><span class="go">To get more information about the packages, run</span>
</span><span id="__span-10-8"><a id="__codelineno-10-8" name="__codelineno-10-8" href="#__codelineno-10-8"></a><span class="go">    pro security-status --help</span>
</span><span id="__span-10-9"><a id="__codelineno-10-9" name="__codelineno-10-9" href="#__codelineno-10-9"></a><span class="go">for a list of available options.</span>
</span><span id="__span-10-10"><a id="__codelineno-10-10" name="__codelineno-10-10" href="#__codelineno-10-10"></a>
</span><span id="__span-10-11"><a id="__codelineno-10-11" name="__codelineno-10-11" href="#__codelineno-10-11"></a><span class="go">This machine is receiving security patching for Ubuntu Main/Restricted</span>
</span><span id="__span-10-12"><a id="__codelineno-10-12" name="__codelineno-10-12" href="#__codelineno-10-12"></a><span class="go">repository until 2029.</span>
</span><span id="__span-10-13"><a id="__codelineno-10-13" name="__codelineno-10-13" href="#__codelineno-10-13"></a><span class="go">This machine is NOT attached to an Ubuntu Pro subscription.</span>
</span><span id="__span-10-14"><a id="__codelineno-10-14" name="__codelineno-10-14" href="#__codelineno-10-14"></a>
</span><span id="__span-10-15"><a id="__codelineno-10-15" name="__codelineno-10-15" href="#__codelineno-10-15"></a><span class="go">Ubuntu Pro with 'esm-infra' enabled provides security updates for</span>
</span><span id="__span-10-16"><a id="__codelineno-10-16" name="__codelineno-10-16" href="#__codelineno-10-16"></a><span class="go">Main/Restricted packages until 2034.</span>
</span><span id="__span-10-17"><a id="__codelineno-10-17" name="__codelineno-10-17" href="#__codelineno-10-17"></a>
</span><span id="__span-10-18"><a id="__codelineno-10-18" name="__codelineno-10-18" href="#__codelineno-10-18"></a><span class="go">Ubuntu Pro with 'esm-apps' enabled provides security updates for</span>
</span><span id="__span-10-19"><a id="__codelineno-10-19" name="__codelineno-10-19" href="#__codelineno-10-19"></a><span class="go">Universe/Multiverse packages until 2034. There are 11 pending security updates.</span>
</span><span id="__span-10-20"><a id="__codelineno-10-20" name="__codelineno-10-20" href="#__codelineno-10-20"></a>
</span><span id="__span-10-21"><a id="__codelineno-10-21" name="__codelineno-10-21" href="#__codelineno-10-21"></a><span class="go">Try Ubuntu Pro with a free personal subscription on up to 5 machines.</span>
</span><span id="__span-10-22"><a id="__codelineno-10-22" name="__codelineno-10-22" href="#__codelineno-10-22"></a><span class="go">Learn more at https://ubuntu.com/pro</span>
</span></code></pre></div>
<p>After creating an Ubuntu account a token is available to use with
<code>pro attach</code>:</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-11-1"><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a><span class="gp"># </span>pro<span class="w"> </span>attach<span class="w"> </span>...
</span><span id="__span-11-2"><a id="__codelineno-11-2" name="__codelineno-11-2" href="#__codelineno-11-2"></a><span class="go">Enabling Ubuntu Pro: ESM Apps</span>
</span><span id="__span-11-3"><a id="__codelineno-11-3" name="__codelineno-11-3" href="#__codelineno-11-3"></a><span class="go">Ubuntu Pro: ESM Apps enabled</span>
</span><span id="__span-11-4"><a id="__codelineno-11-4" name="__codelineno-11-4" href="#__codelineno-11-4"></a><span class="go">Enabling Ubuntu Pro: ESM Infra</span>
</span><span id="__span-11-5"><a id="__codelineno-11-5" name="__codelineno-11-5" href="#__codelineno-11-5"></a><span class="go">Ubuntu Pro: ESM Infra enabled</span>
</span><span id="__span-11-6"><a id="__codelineno-11-6" name="__codelineno-11-6" href="#__codelineno-11-6"></a><span class="go">Enabling Livepatch</span>
</span><span id="__span-11-7"><a id="__codelineno-11-7" name="__codelineno-11-7" href="#__codelineno-11-7"></a><span class="go">Livepatch enabled</span>
</span><span id="__span-11-8"><a id="__codelineno-11-8" name="__codelineno-11-8" href="#__codelineno-11-8"></a><span class="go">This machine is now attached to 'Ubuntu Pro - free personal subscription'</span>
</span><span id="__span-11-9"><a id="__codelineno-11-9" name="__codelineno-11-9" href="#__codelineno-11-9"></a>
</span><span id="__span-11-10"><a id="__codelineno-11-10" name="__codelineno-11-10" href="#__codelineno-11-10"></a><span class="go">SERVICE          ENTITLED  STATUS       DESCRIPTION</span>
</span><span id="__span-11-11"><a id="__codelineno-11-11" name="__codelineno-11-11" href="#__codelineno-11-11"></a><span class="go">anbox-cloud      yes       disabled     Scalable Android in the cloud</span>
</span><span id="__span-11-12"><a id="__codelineno-11-12" name="__codelineno-11-12" href="#__codelineno-11-12"></a><span class="go">esm-apps         yes       enabled      Expanded Security Maintenance for Applications</span>
</span><span id="__span-11-13"><a id="__codelineno-11-13" name="__codelineno-11-13" href="#__codelineno-11-13"></a><span class="go">esm-infra        yes       enabled      Expanded Security Maintenance for Infrastructure</span>
</span><span id="__span-11-14"><a id="__codelineno-11-14" name="__codelineno-11-14" href="#__codelineno-11-14"></a><span class="go">landscape        yes       disabled     Management and administration tool for Ubuntu</span>
</span><span id="__span-11-15"><a id="__codelineno-11-15" name="__codelineno-11-15" href="#__codelineno-11-15"></a><span class="go">livepatch        yes       warning      Current kernel is not covered by livepatch</span>
</span><span id="__span-11-16"><a id="__codelineno-11-16" name="__codelineno-11-16" href="#__codelineno-11-16"></a><span class="go">realtime-kernel* yes       disabled     Ubuntu kernel with PREEMPT_RT patches integrated</span>
</span><span id="__span-11-17"><a id="__codelineno-11-17" name="__codelineno-11-17" href="#__codelineno-11-17"></a>
</span><span id="__span-11-18"><a id="__codelineno-11-18" name="__codelineno-11-18" href="#__codelineno-11-18"></a><span class="go"> * Service has variants</span>
</span><span id="__span-11-19"><a id="__codelineno-11-19" name="__codelineno-11-19" href="#__codelineno-11-19"></a>
</span><span id="__span-11-20"><a id="__codelineno-11-20" name="__codelineno-11-20" href="#__codelineno-11-20"></a><span class="go">NOTICES</span>
</span><span id="__span-11-21"><a id="__codelineno-11-21" name="__codelineno-11-21" href="#__codelineno-11-21"></a><span class="go">Operation in progress: pro attach</span>
</span><span id="__span-11-22"><a id="__codelineno-11-22" name="__codelineno-11-22" href="#__codelineno-11-22"></a><span class="go">The current kernel (6.8.0-47-lowlatency, x86_64) is not covered by livepatch.</span>
</span><span id="__span-11-23"><a id="__codelineno-11-23" name="__codelineno-11-23" href="#__codelineno-11-23"></a><span class="go">Covered kernels are listed here: https://ubuntu.com/security/livepatch/docs/kernels</span>
</span><span id="__span-11-24"><a id="__codelineno-11-24" name="__codelineno-11-24" href="#__codelineno-11-24"></a><span class="go">Either switch to a covered kernel or `sudo pro disable livepatch` to dismiss this warning.</span>
</span><span id="__span-11-25"><a id="__codelineno-11-25" name="__codelineno-11-25" href="#__codelineno-11-25"></a>
</span><span id="__span-11-26"><a id="__codelineno-11-26" name="__codelineno-11-26" href="#__codelineno-11-26"></a><span class="go">For a list of all Ubuntu Pro services and variants, run 'pro status --all'</span>
</span><span id="__span-11-27"><a id="__codelineno-11-27" name="__codelineno-11-27" href="#__codelineno-11-27"></a><span class="go">Enable services with: pro enable &lt;service&gt;</span>
</span><span id="__span-11-28"><a id="__codelineno-11-28" name="__codelineno-11-28" href="#__codelineno-11-28"></a>
</span><span id="__span-11-29"><a id="__codelineno-11-29" name="__codelineno-11-29" href="#__codelineno-11-29"></a><span class="go">     Account: ponder.stibbons@uu.am</span>
</span><span id="__span-11-30"><a id="__codelineno-11-30" name="__codelineno-11-30" href="#__codelineno-11-30"></a><span class="go">Subscription: Ubuntu Pro - free personal subscription</span>
</span></code></pre></div>
<p>Now the system can be updated <em>again</em> with <code>apt full-upgrade -y</code>
to receive those additional security updates:</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-12-1"><a id="__codelineno-12-1" name="__codelineno-12-1" href="#__codelineno-12-1"></a><span class="gp"># </span>apt<span class="w"> </span>full-upgrade<span class="w"> </span>-y
</span><span id="__span-12-2"><a id="__codelineno-12-2" name="__codelineno-12-2" href="#__codelineno-12-2"></a><span class="go">Reading package lists... Done</span>
</span><span id="__span-12-3"><a id="__codelineno-12-3" name="__codelineno-12-3" href="#__codelineno-12-3"></a><span class="go">Building dependency tree... Done</span>
</span><span id="__span-12-4"><a id="__codelineno-12-4" name="__codelineno-12-4" href="#__codelineno-12-4"></a><span class="go">Reading state information... Done</span>
</span><span id="__span-12-5"><a id="__codelineno-12-5" name="__codelineno-12-5" href="#__codelineno-12-5"></a><span class="go">Calculating upgrade... Done</span>
</span><span id="__span-12-6"><a id="__codelineno-12-6" name="__codelineno-12-6" href="#__codelineno-12-6"></a><span class="go">The following upgrades have been deferred due to phasing:</span>
</span><span id="__span-12-7"><a id="__codelineno-12-7" name="__codelineno-12-7" href="#__codelineno-12-7"></a><span class="go">  krb5-locales libboost-chrono1.83.0t64 libboost-filesystem1.83.0</span>
</span><span id="__span-12-8"><a id="__codelineno-12-8" name="__codelineno-12-8" href="#__codelineno-12-8"></a><span class="go">  libboost-iostreams1.83.0 libboost-locale1.83.0</span>
</span><span id="__span-12-9"><a id="__codelineno-12-9" name="__codelineno-12-9" href="#__codelineno-12-9"></a><span class="go">  libboost-program-options1.83.0 libboost-thread1.83.0 libgssapi-krb5-2</span>
</span><span id="__span-12-10"><a id="__codelineno-12-10" name="__codelineno-12-10" href="#__codelineno-12-10"></a><span class="go">  libk5crypto3 libkrb5-3 libkrb5support0 libldap-common libldap2</span>
</span><span id="__span-12-11"><a id="__codelineno-12-11" name="__codelineno-12-11" href="#__codelineno-12-11"></a><span class="go">  python3-distupgrade ubuntu-release-upgrader-core</span>
</span><span id="__span-12-12"><a id="__codelineno-12-12" name="__codelineno-12-12" href="#__codelineno-12-12"></a><span class="go">  ubuntu-release-upgrader-qt</span>
</span><span id="__span-12-13"><a id="__codelineno-12-13" name="__codelineno-12-13" href="#__codelineno-12-13"></a><span class="go">The following packages will be upgraded:</span>
</span><span id="__span-12-14"><a id="__codelineno-12-14" name="__codelineno-12-14" href="#__codelineno-12-14"></a><span class="go">  ffmpeg libavcodec60 libavdevice60 libavfilter9 libavformat60 libavutil58</span>
</span><span id="__span-12-15"><a id="__codelineno-12-15" name="__codelineno-12-15" href="#__codelineno-12-15"></a><span class="go">  libcjson1 libdcmtk17t64 libpostproc57 libswresample4 libswscale7</span>
</span><span id="__span-12-16"><a id="__codelineno-12-16" name="__codelineno-12-16" href="#__codelineno-12-16"></a><span class="go">11 upgraded, 0 newly installed, 0 to remove and 16 not upgraded.</span>
</span><span id="__span-12-17"><a id="__codelineno-12-17" name="__codelineno-12-17" href="#__codelineno-12-17"></a><span class="go">11 esm-apps security updates</span>
</span><span id="__span-12-18"><a id="__codelineno-12-18" name="__codelineno-12-18" href="#__codelineno-12-18"></a><span class="go">Need to get 19.3 MB of archives.</span>
</span><span id="__span-12-19"><a id="__codelineno-12-19" name="__codelineno-12-19" href="#__codelineno-12-19"></a><span class="go">After this operation, 9216 B of additional disk space will be used.</span>
</span></code></pre></div>
<h3 id="make-dmesg-non-privileged">Make <code>dmesg</code> non-privileged</h3>
<p>Since Ubuntu 22.04, <code>dmesg</code> has become a privileged operation
by default:</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-13-1"><a id="__codelineno-13-1" name="__codelineno-13-1" href="#__codelineno-13-1"></a><span class="gp">$ </span>dmesg
</span><span id="__span-13-2"><a id="__codelineno-13-2" name="__codelineno-13-2" href="#__codelineno-13-2"></a><span class="go">dmesg: read kernel buffer failed: Operation not permitted</span>
</span></code></pre></div>
<p>This is controlled by </p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-14-1"><a id="__codelineno-14-1" name="__codelineno-14-1" href="#__codelineno-14-1"></a><span class="gp"># </span>sysctl<span class="w"> </span>kernel.dmesg_restrict
</span><span id="__span-14-2"><a id="__codelineno-14-2" name="__codelineno-14-2" href="#__codelineno-14-2"></a><span class="go">kernel.dmesg_restrict = 1</span>
</span></code></pre></div>
<p>To revert this default, and make it permanent
(<a href="https://archived.forum.manjaro.org/t/why-did-dmesg-become-a-priveleged-operation-suddenly/86468/3">source</a>):</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-15-1"><a id="__codelineno-15-1" name="__codelineno-15-1" href="#__codelineno-15-1"></a><span class="gp"># </span><span class="nb">echo</span><span class="w"> </span><span class="s1">'kernel.dmesg_restrict=0'</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>tee<span class="w"> </span>-a<span class="w"> </span>/etc/sysctl.d/99-sysctl.conf
</span></code></pre></div>
<h3 id="weekly-btrfs-scrub">Weekly btrfs scrub</h3>
<p>To keep BTRFS file systems healthy, it is recommended to
<a href="http://marc.merlins.org/perso/btrfs/post_2014-03-19_Btrfs-Tips_-Btrfs-Scrub-and-Btrfs-Filesystem-Repair.html">run a weekly scrub</a>
to check everything for consistency. For this, I run
<a href="https://marc.merlins.org/linux/scripts/btrfs-scrub">the script</a>
from crontab every Saturday night.</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-16-1"><a id="__codelineno-16-1" name="__codelineno-16-1" href="#__codelineno-16-1"></a><span class="gp"># </span>wget<span class="w"> </span>-O<span class="w"> </span>/usr/local/bin/btrfs-scrub-all<span class="w"> </span><span class="se">\</span>
</span><span id="__span-16-2"><a id="__codelineno-16-2" name="__codelineno-16-2" href="#__codelineno-16-2"></a><span class="w">  </span>http://marc.merlins.org/linux/scripts/btrfs-scrub
</span><span id="__span-16-3"><a id="__codelineno-16-3" name="__codelineno-16-3" href="#__codelineno-16-3"></a>
</span><span id="__span-16-4"><a id="__codelineno-16-4" name="__codelineno-16-4" href="#__codelineno-16-4"></a><span class="gp"># </span>crontab<span class="w"> </span>-e
</span><span id="__span-16-5"><a id="__codelineno-16-5" name="__codelineno-16-5" href="#__codelineno-16-5"></a><span class="go">...</span>
</span><span id="__span-16-6"><a id="__codelineno-16-6" name="__codelineno-16-6" href="#__codelineno-16-6"></a><span class="gp"># </span>m<span class="w"> </span>h<span class="w">  </span>dom<span class="w"> </span>mon<span class="w"> </span>dow<span class="w">   </span><span class="nb">command</span>
</span><span id="__span-16-7"><a id="__codelineno-16-7" name="__codelineno-16-7" href="#__codelineno-16-7"></a><span class="go">50 2 * * 6 /usr/local/bin/btrfs-scrub-all</span>
</span></code></pre></div>
<p><a href="https://marc.merlins.org/">Marc MERLIN</a> keeps the script updated,
so each systme may benefit from a few modifications, e.g.
1. Remove tests for laptop battery status, when running on a PC.
2. Set the <code>BTRFS_SCRUB_SKIP</code> to filter out partitions to skip.</p>
<div class="language-bash highlight"><table class="highlighttable"><tbody><tr><th colspan="2" class="filename"><span class="filename">/usr/local/bin/btrfs-scrub-all</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-17-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-17-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-17-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-17-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-17-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-17-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-17-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-17-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-17-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-17-10">10</a></span>
<span class="normal"><a href="#__codelineno-17-11">11</a></span>
<span class="normal"><a href="#__codelineno-17-12">12</a></span>
<span class="normal"><a href="#__codelineno-17-13">13</a></span>
<span class="normal"><a href="#__codelineno-17-14">14</a></span>
<span class="normal"><a href="#__codelineno-17-15">15</a></span>
<span class="normal"><a href="#__codelineno-17-16">16</a></span>
<span class="normal"><a href="#__codelineno-17-17">17</a></span>
<span class="normal"><a href="#__codelineno-17-18">18</a></span>
<span class="normal"><a href="#__codelineno-17-19">19</a></span>
<span class="normal"><a href="#__codelineno-17-20">20</a></span>
<span class="normal"><a href="#__codelineno-17-21">21</a></span>
<span class="normal"><a href="#__codelineno-17-22">22</a></span>
<span class="normal"><a href="#__codelineno-17-23">23</a></span>
<span class="normal"><a href="#__codelineno-17-24">24</a></span>
<span class="normal"><a href="#__codelineno-17-25">25</a></span>
<span class="normal"><a href="#__codelineno-17-26">26</a></span>
<span class="normal"><a href="#__codelineno-17-27">27</a></span>
<span class="normal"><a href="#__codelineno-17-28">28</a></span>
<span class="normal"><a href="#__codelineno-17-29">29</a></span>
<span class="normal"><a href="#__codelineno-17-30">30</a></span>
<span class="normal"><a href="#__codelineno-17-31">31</a></span>
<span class="normal"><a href="#__codelineno-17-32">32</a></span>
<span class="normal"><a href="#__codelineno-17-33">33</a></span>
<span class="normal"><a href="#__codelineno-17-34">34</a></span>
<span class="normal"><a href="#__codelineno-17-35">35</a></span>
<span class="normal"><a href="#__codelineno-17-36">36</a></span>
<span class="normal"><a href="#__codelineno-17-37">37</a></span>
<span class="normal"><a href="#__codelineno-17-38">38</a></span>
<span class="normal"><a href="#__codelineno-17-39">39</a></span>
<span class="normal"><a href="#__codelineno-17-40">40</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-17-1"><a id="__codelineno-17-1" name="__codelineno-17-1"></a><span class="ch">#! /bin/bash</span>
</span><span id="__span-17-2"><a id="__codelineno-17-2" name="__codelineno-17-2"></a>
</span><span id="__span-17-3"><a id="__codelineno-17-3" name="__codelineno-17-3"></a><span class="c1"># By Marc MERLIN &lt;marc_soft@merlins.org&gt; 2014/03/20</span>
</span><span id="__span-17-4"><a id="__codelineno-17-4" name="__codelineno-17-4"></a><span class="c1"># License: Apache-2.0</span>
</span><span id="__span-17-5"><a id="__codelineno-17-5" name="__codelineno-17-5"></a><span class="c1"># http://marc.merlins.org/perso/btrfs/post_2014-03-19_Btrfs-Tips_-Btrfs-Scrub-and-Btrfs-Filesystem-Repair.html</span>
</span><span id="__span-17-6"><a id="__codelineno-17-6" name="__codelineno-17-6"></a>
</span><span id="__span-17-7"><a id="__codelineno-17-7" name="__codelineno-17-7"></a>which<span class="w"> </span>btrfs<span class="w"> </span>&gt;/dev/null<span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nb">exit</span><span class="w"> </span><span class="m">0</span>
</span><span id="__span-17-8"><a id="__codelineno-17-8" name="__codelineno-17-8"></a><span class="nb">export</span><span class="w"> </span><span class="nv">PATH</span><span class="o">=</span>/usr/local/bin:/sbin:<span class="nv">$PATH</span>
</span><span id="__span-17-9"><a id="__codelineno-17-9" name="__codelineno-17-9"></a>
</span><span id="__span-17-10"><a id="__codelineno-17-10" name="__codelineno-17-10"></a><span class="nv">FILTER</span><span class="o">=</span><span class="s1">'(^Dumping|balancing, usage)'</span>
</span><span id="__span-17-11"><a id="__codelineno-17-11" name="__codelineno-17-11"></a><span class="nv">BTRFS_SCRUB_SKIP</span><span class="o">=</span><span class="s2">"sda"</span>
</span><span id="__span-17-12"><a id="__codelineno-17-12" name="__codelineno-17-12"></a><span class="nb">source</span><span class="w"> </span>/etc/btrfs_config<span class="w"> </span><span class="m">2</span>&gt;/dev/null
</span><span id="__span-17-13"><a id="__codelineno-17-13" name="__codelineno-17-13"></a><span class="nb">test</span><span class="w"> </span>-n<span class="w"> </span><span class="s2">"</span><span class="nv">$DEVS</span><span class="s2">"</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nv">DEVS</span><span class="o">=</span><span class="k">$(</span>grep<span class="w"> </span><span class="s1">'\&lt;btrfs\&gt;'</span><span class="w"> </span>/proc/mounts<span class="w"> </span><span class="p">|</span><span class="w"> </span>awk<span class="w"> </span><span class="s1">'{ print $1 }'</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>sort<span class="w"> </span>-u<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>-v<span class="w"> </span><span class="nv">$BTRFS_SCRUB_SKIP</span><span class="k">)</span>
</span><span id="__span-17-14"><a id="__codelineno-17-14" name="__codelineno-17-14"></a><span class="k">for</span><span class="w"> </span>btrfs<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="nv">$DEVS</span>
</span><span id="__span-17-15"><a id="__codelineno-17-15" name="__codelineno-17-15"></a><span class="k">do</span>
</span><span id="__span-17-16"><a id="__codelineno-17-16" name="__codelineno-17-16"></a><span class="w">    </span>tail<span class="w"> </span>-n<span class="w"> </span><span class="m">0</span><span class="w"> </span>-f<span class="w"> </span>/var/log/syslog<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span><span class="s2">"BTRFS"</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>-Ev<span class="w"> </span><span class="s1">'(disk space caching is enabled|unlinked .* orphans|turning on discard|device label .* devid .* transid|enabling SSD mode|BTRFS: has skinny extents|BTRFS: device label|BTRFS info )'</span><span class="w"> </span><span class="p">&amp;</span>
</span><span id="__span-17-17"><a id="__codelineno-17-17" name="__codelineno-17-17"></a><span class="w">    </span><span class="nv">mountpoint</span><span class="o">=</span><span class="s2">"</span><span class="k">$(</span>grep<span class="w"> </span><span class="s2">"</span><span class="nv">$btrfs</span><span class="s2">"</span><span class="w"> </span>/proc/mounts<span class="w"> </span><span class="p">|</span><span class="w"> </span>awk<span class="w"> </span><span class="s1">'{ print $2 }'</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>sort<span class="w"> </span><span class="p">|</span><span class="w"> </span>head<span class="w"> </span>-1<span class="k">)</span><span class="s2">"</span>
</span><span id="__span-17-18"><a id="__codelineno-17-18" name="__codelineno-17-18"></a><span class="w">    </span>logger<span class="w"> </span>-s<span class="w"> </span><span class="s2">"Quick Metadata and Data Balance of </span><span class="nv">$mountpoint</span><span class="s2"> (</span><span class="nv">$btrfs</span><span class="s2">)"</span><span class="w"> </span>&gt;<span class="p">&amp;</span><span class="m">2</span>
</span><span id="__span-17-19"><a id="__codelineno-17-19" name="__codelineno-17-19"></a><span class="w">    </span><span class="c1"># Even in 4.3 kernels, you can still get in places where balance</span>
</span><span id="__span-17-20"><a id="__codelineno-17-20" name="__codelineno-17-20"></a><span class="w">    </span><span class="c1"># won't work (no place left, until you run a -m0 one first)</span>
</span><span id="__span-17-21"><a id="__codelineno-17-21" name="__codelineno-17-21"></a><span class="w">    </span><span class="c1"># I'm told that proactively rebalancing metadata may not be a good idea.</span>
</span><span id="__span-17-22"><a id="__codelineno-17-22" name="__codelineno-17-22"></a><span class="w">    </span><span class="c1">#btrfs balance start -musage=20 -v $mountpoint 2&gt;&amp;1 | grep -Ev "$FILTER"</span>
</span><span id="__span-17-23"><a id="__codelineno-17-23" name="__codelineno-17-23"></a><span class="w">    </span><span class="c1"># but a null rebalance should help corner cases:</span>
</span><span id="__span-17-24"><a id="__codelineno-17-24" name="__codelineno-17-24"></a><span class="w">    </span>sleep<span class="w"> </span><span class="m">10</span>
</span><span id="__span-17-25"><a id="__codelineno-17-25" name="__codelineno-17-25"></a><span class="w">    </span>btrfs<span class="w"> </span>balance<span class="w"> </span>start<span class="w"> </span>-musage<span class="o">=</span><span class="m">0</span><span class="w"> </span>-v<span class="w"> </span><span class="nv">$mountpoint</span><span class="w"> </span><span class="m">2</span>&gt;<span class="p">&amp;</span><span class="m">1</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>-Ev<span class="w"> </span><span class="s2">"</span><span class="nv">$FILTER</span><span class="s2">"</span>
</span><span id="__span-17-26"><a id="__codelineno-17-26" name="__codelineno-17-26"></a><span class="w">    </span><span class="c1"># After metadata, let's do data:</span>
</span><span id="__span-17-27"><a id="__codelineno-17-27" name="__codelineno-17-27"></a><span class="w">    </span>sleep<span class="w"> </span><span class="m">10</span>
</span><span id="__span-17-28"><a id="__codelineno-17-28" name="__codelineno-17-28"></a><span class="w">    </span>btrfs<span class="w"> </span>balance<span class="w"> </span>start<span class="w"> </span>-dusage<span class="o">=</span><span class="m">0</span><span class="w"> </span>-v<span class="w"> </span><span class="nv">$mountpoint</span><span class="w"> </span><span class="m">2</span>&gt;<span class="p">&amp;</span><span class="m">1</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>-Ev<span class="w"> </span><span class="s2">"</span><span class="nv">$FILTER</span><span class="s2">"</span>
</span><span id="__span-17-29"><a id="__codelineno-17-29" name="__codelineno-17-29"></a><span class="w">    </span>sleep<span class="w"> </span><span class="m">10</span>
</span><span id="__span-17-30"><a id="__codelineno-17-30" name="__codelineno-17-30"></a><span class="w">    </span>btrfs<span class="w"> </span>balance<span class="w"> </span>start<span class="w"> </span>-dusage<span class="o">=</span><span class="m">20</span><span class="w"> </span>-v<span class="w"> </span><span class="nv">$mountpoint</span><span class="w"> </span><span class="m">2</span>&gt;<span class="p">&amp;</span><span class="m">1</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>-Ev<span class="w"> </span><span class="s2">"</span><span class="nv">$FILTER</span><span class="s2">"</span>
</span><span id="__span-17-31"><a id="__codelineno-17-31" name="__codelineno-17-31"></a><span class="w">    </span><span class="c1"># And now we do scrub. Note that scrub can fail with "no space left</span>
</span><span id="__span-17-32"><a id="__codelineno-17-32" name="__codelineno-17-32"></a><span class="w">    </span><span class="c1"># on device" if you're very out of balance.</span>
</span><span id="__span-17-33"><a id="__codelineno-17-33" name="__codelineno-17-33"></a><span class="w">    </span>logger<span class="w"> </span>-s<span class="w"> </span><span class="s2">"Starting scrub of </span><span class="nv">$mountpoint</span><span class="s2">"</span><span class="w"> </span>&gt;<span class="p">&amp;</span><span class="m">2</span>
</span><span id="__span-17-34"><a id="__codelineno-17-34" name="__codelineno-17-34"></a><span class="w">    </span><span class="nb">echo</span><span class="w"> </span>btrfs<span class="w"> </span>scrub<span class="w"> </span>start<span class="w"> </span>-Bd<span class="w"> </span><span class="nv">$mountpoint</span>
</span><span id="__span-17-35"><a id="__codelineno-17-35" name="__codelineno-17-35"></a><span class="w">    </span><span class="c1"># -r is read only, but won't fix a redundant array.</span>
</span><span id="__span-17-36"><a id="__codelineno-17-36" name="__codelineno-17-36"></a><span class="w">    </span><span class="c1">#ionice -c 3 nice -10 btrfs scrub start -Bdr $mountpoint</span>
</span><span id="__span-17-37"><a id="__codelineno-17-37" name="__codelineno-17-37"></a><span class="w">    </span><span class="nb">time</span><span class="w"> </span>ionice<span class="w"> </span>-c<span class="w"> </span><span class="m">3</span><span class="w"> </span>nice<span class="w"> </span>-10<span class="w"> </span>btrfs<span class="w"> </span>scrub<span class="w"> </span>start<span class="w"> </span>-Bd<span class="w"> </span><span class="nv">$mountpoint</span>
</span><span id="__span-17-38"><a id="__codelineno-17-38" name="__codelineno-17-38"></a><span class="w">    </span>pkill<span class="w"> </span>-f<span class="w"> </span><span class="s1">'tail -n 0 -f /var/log/syslog'</span>
</span><span id="__span-17-39"><a id="__codelineno-17-39" name="__codelineno-17-39"></a><span class="w">    </span>logger<span class="w"> </span><span class="s2">"Ended scrub of </span><span class="nv">$mountpoint</span><span class="s2">"</span><span class="w"> </span>&gt;<span class="p">&amp;</span><span class="m">2</span>
</span><span id="__span-17-40"><a id="__codelineno-17-40" name="__codelineno-17-40"></a><span class="k">done</span>
</span></code></pre></div></td></tr></tbody></table></div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Setting <code>BTRFS_SCRUB_SKIP="sda"</code> prevents Btrfs balancing from running
on USB external storage if attached; not really necessary, but the
script fails if this variable is left empty.</p>
</div>
<div class="language-console highlight"><pre><span></span><code><span id="__span-18-1"><a id="__codelineno-18-1" name="__codelineno-18-1" href="#__codelineno-18-1"></a><span class="gp"># </span>/usr/local/bin/btrfs-scrub-all
</span><span id="__span-18-2"><a id="__codelineno-18-2" name="__codelineno-18-2" href="#__codelineno-18-2"></a><span class="go">&lt;13&gt;Nov 17 22:23:49 root: Quick Metadata and Data Balance of /home (/dev/nvme0n1p4)</span>
</span><span id="__span-18-3"><a id="__codelineno-18-3" name="__codelineno-18-3" href="#__codelineno-18-3"></a><span class="go">Done, had to relocate 0 out of 1536 chunks</span>
</span><span id="__span-18-4"><a id="__codelineno-18-4" name="__codelineno-18-4" href="#__codelineno-18-4"></a><span class="go">Done, had to relocate 0 out of 1536 chunks</span>
</span><span id="__span-18-5"><a id="__codelineno-18-5" name="__codelineno-18-5" href="#__codelineno-18-5"></a><span class="go">Done, had to relocate 0 out of 1536 chunks</span>
</span><span id="__span-18-6"><a id="__codelineno-18-6" name="__codelineno-18-6" href="#__codelineno-18-6"></a><span class="go">&lt;13&gt;Nov 17 22:24:19 root: Starting scrub of /home</span>
</span><span id="__span-18-7"><a id="__codelineno-18-7" name="__codelineno-18-7" href="#__codelineno-18-7"></a><span class="go">btrfs scrub start -Bd /home</span>
</span><span id="__span-18-8"><a id="__codelineno-18-8" name="__codelineno-18-8" href="#__codelineno-18-8"></a><span class="go">Starting scrub on devid 1</span>
</span><span id="__span-18-9"><a id="__codelineno-18-9" name="__codelineno-18-9" href="#__codelineno-18-9"></a>
</span><span id="__span-18-10"><a id="__codelineno-18-10" name="__codelineno-18-10" href="#__codelineno-18-10"></a><span class="go">Scrub device /dev/nvme0n1p4 (id 1) done</span>
</span><span id="__span-18-11"><a id="__codelineno-18-11" name="__codelineno-18-11" href="#__codelineno-18-11"></a><span class="go">Scrub started:    Sun Nov 17 22:24:19 2024</span>
</span><span id="__span-18-12"><a id="__codelineno-18-12" name="__codelineno-18-12" href="#__codelineno-18-12"></a><span class="go">Status:           finished</span>
</span><span id="__span-18-13"><a id="__codelineno-18-13" name="__codelineno-18-13" href="#__codelineno-18-13"></a><span class="go">Duration:         0:06:50</span>
</span><span id="__span-18-14"><a id="__codelineno-18-14" name="__codelineno-18-14" href="#__codelineno-18-14"></a><span class="go">Total to scrub:   1.48TiB</span>
</span><span id="__span-18-15"><a id="__codelineno-18-15" name="__codelineno-18-15" href="#__codelineno-18-15"></a><span class="go">Rate:             3.71GiB/s</span>
</span><span id="__span-18-16"><a id="__codelineno-18-16" name="__codelineno-18-16" href="#__codelineno-18-16"></a><span class="go">Error summary:    no errors found</span>
</span><span id="__span-18-17"><a id="__codelineno-18-17" name="__codelineno-18-17" href="#__codelineno-18-17"></a>
</span><span id="__span-18-18"><a id="__codelineno-18-18" name="__codelineno-18-18" href="#__codelineno-18-18"></a><span class="go">real    6m49.944s</span>
</span><span id="__span-18-19"><a id="__codelineno-18-19" name="__codelineno-18-19" href="#__codelineno-18-19"></a><span class="go">user    0m0.002s</span>
</span><span id="__span-18-20"><a id="__codelineno-18-20" name="__codelineno-18-20" href="#__codelineno-18-20"></a><span class="go">sys     4m41.299s</span>
</span></code></pre></div>
<p>The whole process takes about 7 minutes with the 4TB NVMe SSD about
43% full, with 1.5T used.</p>
<p><a class="glightbox" data-type="image" data-width="auto" data-height="auto" href="../../../../media/2024-11-15-ubuntu-studio-24-04-on-super-tuna-nuc-pc/super-tuna-last-15-min-with-btrfs-scrub.png" data-desc-position="bottom"><img alt="Resources used on a 7-minute run of btrfs scrub" src="../../../../media/2024-11-15-ubuntu-studio-24-04-on-super-tuna-nuc-pc/super-tuna-last-15-min-with-btrfs-scrub.png"></a></p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The weekly Btrfs scrub doesn't seem to really need <code>inn</code> or any
of its dependencies, so this installation step was <strong>skipped</strong>:</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-19-1"><a id="__codelineno-19-1" name="__codelineno-19-1" href="#__codelineno-19-1"></a><span class="gp"># </span>apt<span class="w"> </span>install<span class="w"> </span>inn<span class="w"> </span>-y
</span></code></pre></div>
</div>
<h3 id="make-sddm-look-good">Make SDDM Look Good</h3>
<p>Ubuntu Studio 24.04 uses 
<a href="https://wiki.archlinux.org/title/SDDM">Simple Desktop Display Manager (SDDM)</a>
(<a href="https://github.com/sddm/sddm">sddm/sddm</a> in GitHub)
which is quite good looking out of the box, but I like to
customize this for each computer.</p>
<p>For most computers my favorite SDDM theme is
<a href="https://store.kde.org/p/1361460">Breeze-Noir-Dark</a>,
which I like to install system-wide.</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-20-1"><a id="__codelineno-20-1" name="__codelineno-20-1" href="#__codelineno-20-1"></a><span class="gp"># </span>unzip<span class="w"> </span>-d<span class="w"> </span>/usr/share/sddm/themes<span class="w"> </span>Breeze-Noir-Dark.zip
</span></code></pre></div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Action icons won’t render if the directory name is changed. If needed,
change the directory name in the <code>iconSource</code> fields in <code>Main.qml</code> to
match final directory name so icons show. This is not the only thing
that breaks when changing the directory name.</p>
</div>
<p>Other than installing this theme, all I really change in it
is the background image to use 
<a href="https://www.nme.com/news/music/bts-jin-surprises-fans-super-tuna-birthday-celebration-3111626">Super Tuna (1920x1080)</a>.</p>
<p><a class="glightbox" data-type="image" data-width="auto" data-height="auto" href="../../../../media/2024-11-15-ubuntu-studio-24-04-on-super-tuna-nuc-pc/Super-Tuna.jpg" data-desc-position="bottom"><img alt="Homage to The Most Popular Tuna Ever" src="../../../../media/2024-11-15-ubuntu-studio-24-04-on-super-tuna-nuc-pc/Super-Tuna.jpg"></a></p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-21-1"><a id="__codelineno-21-1" name="__codelineno-21-1" href="#__codelineno-21-1"></a><span class="gp"># </span>mv<span class="w"> </span>Super-Tuna.jpg<span class="w"> </span><span class="se">\</span>
</span><span id="__span-21-2"><a id="__codelineno-21-2" name="__codelineno-21-2" href="#__codelineno-21-2"></a><span class="w">  </span>/usr/share/sddm/themes/Breeze-Noir-Dark/
</span><span id="__span-21-3"><a id="__codelineno-21-3" name="__codelineno-21-3" href="#__codelineno-21-3"></a><span class="gp"># </span><span class="nb">cd</span><span class="w"> </span>/usr/share/sddm/themes/Breeze-Noir-Dark/
</span><span id="__span-21-4"><a id="__codelineno-21-4" name="__codelineno-21-4" href="#__codelineno-21-4"></a>
</span><span id="__span-21-5"><a id="__codelineno-21-5" name="__codelineno-21-5" href="#__codelineno-21-5"></a><span class="gp"># </span>vi<span class="w"> </span>theme.conf
</span><span id="__span-21-6"><a id="__codelineno-21-6" name="__codelineno-21-6" href="#__codelineno-21-6"></a><span class="go">[General]</span>
</span><span id="__span-21-7"><a id="__codelineno-21-7" name="__codelineno-21-7" href="#__codelineno-21-7"></a><span class="go">type=image</span>
</span><span id="__span-21-8"><a id="__codelineno-21-8" name="__codelineno-21-8" href="#__codelineno-21-8"></a><span class="go">color=#132e43</span>
</span><span id="__span-21-9"><a id="__codelineno-21-9" name="__codelineno-21-9" href="#__codelineno-21-9"></a><span class="go">background=/usr/share/sddm/themes/Breeze-Noir-Dark/Super-Tuna.jpg</span>
</span><span id="__span-21-10"><a id="__codelineno-21-10" name="__codelineno-21-10" href="#__codelineno-21-10"></a>
</span><span id="__span-21-11"><a id="__codelineno-21-11" name="__codelineno-21-11" href="#__codelineno-21-11"></a><span class="gp"># </span>vi<span class="w"> </span>theme.conf.user
</span><span id="__span-21-12"><a id="__codelineno-21-12" name="__codelineno-21-12" href="#__codelineno-21-12"></a><span class="go">[General]</span>
</span><span id="__span-21-13"><a id="__codelineno-21-13" name="__codelineno-21-13" href="#__codelineno-21-13"></a><span class="go">type=image</span>
</span><span id="__span-21-14"><a id="__codelineno-21-14" name="__codelineno-21-14" href="#__codelineno-21-14"></a><span class="go">background=Super-Tuna.jpg</span>
</span></code></pre></div>
<p><strong>Additionally</strong>, as this is new in Ubuntu 24.04, the theme has to
be selected by adding a <code>[Theme]</code> section in the system config
in <code>/usr/lib/sddm/sddm.conf.d/ubuntustudio.conf</code></p>
<div class="language-ini highlight"><pre><span></span><code><span id="__span-22-1"><a id="__codelineno-22-1" name="__codelineno-22-1" href="#__codelineno-22-1"></a><span class="k">[General]</span>
</span><span id="__span-22-2"><a id="__codelineno-22-2" name="__codelineno-22-2" href="#__codelineno-22-2"></a><span class="na">InputMethod</span><span class="o">=</span>
</span><span id="__span-22-3"><a id="__codelineno-22-3" name="__codelineno-22-3" href="#__codelineno-22-3"></a>
</span><span id="__span-22-4"><a id="__codelineno-22-4" name="__codelineno-22-4" href="#__codelineno-22-4"></a><span class="k">[Theme]</span>
</span><span id="__span-22-5"><a id="__codelineno-22-5" name="__codelineno-22-5" href="#__codelineno-22-5"></a><span class="na">Current</span><span class="o">=</span><span class="s">"Breeze-Noir-Dark"</span>
</span><span id="__span-22-6"><a id="__codelineno-22-6" name="__codelineno-22-6" href="#__codelineno-22-6"></a><span class="na">EnableAvatars</span><span class="o">=</span><span class="s">True</span>
</span></code></pre></div>
<p><a href="https://superuser.com/questions/1720931/how-to-configure-sddm-in-kubuntu-22-04-where-is-config-file">Reportedly</a>,
you have to <strong>create</strong> the <code>/etc/sddm.conf.d</code> directory to add
the <em>Local configuration</em> file that allows setting the theme:</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-23-1"><a id="__codelineno-23-1" name="__codelineno-23-1" href="#__codelineno-23-1"></a><span class="gp"># </span>mkdir<span class="w"> </span>/etc/sddm.conf.d
</span><span id="__span-23-2"><a id="__codelineno-23-2" name="__codelineno-23-2" href="#__codelineno-23-2"></a><span class="gp"># </span>vi<span class="w"> </span>/etc/sddm.conf.d/ubuntustudio.conf
</span></code></pre></div>
<p>Besides setting the theme, it is also good to limit the range of
user ids so that only human users show up:</p>
<div class="language-ini highlight"><pre><span></span><code><span id="__span-24-1"><a id="__codelineno-24-1" name="__codelineno-24-1" href="#__codelineno-24-1"></a><span class="k">[Theme]</span>
</span><span id="__span-24-2"><a id="__codelineno-24-2" name="__codelineno-24-2" href="#__codelineno-24-2"></a><span class="na">Current</span><span class="o">=</span><span class="s">Breeze-Noir-Dark</span>
</span><span id="__span-24-3"><a id="__codelineno-24-3" name="__codelineno-24-3" href="#__codelineno-24-3"></a>
</span><span id="__span-24-4"><a id="__codelineno-24-4" name="__codelineno-24-4" href="#__codelineno-24-4"></a><span class="k">[Users]</span>
</span><span id="__span-24-5"><a id="__codelineno-24-5" name="__codelineno-24-5" href="#__codelineno-24-5"></a><span class="na">MaximumUid</span><span class="o">=</span><span class="s">1001</span>
</span><span id="__span-24-6"><a id="__codelineno-24-6" name="__codelineno-24-6" href="#__codelineno-24-6"></a><span class="na">MinimumUid</span><span class="o">=</span><span class="s">1000</span>
</span></code></pre></div>
<h3 id="bluetooth-controller">Bluetooth controller</h3>
<p>The following shows up in <code>dmesg</code>:</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-25-1"><a id="__codelineno-25-1" name="__codelineno-25-1" href="#__codelineno-25-1"></a><span class="go">Bluetooth: Core ver 2.22</span>
</span><span id="__span-25-2"><a id="__codelineno-25-2" name="__codelineno-25-2" href="#__codelineno-25-2"></a><span class="go">NET: Registered PF_BLUETOOTH protocol family</span>
</span><span id="__span-25-3"><a id="__codelineno-25-3" name="__codelineno-25-3" href="#__codelineno-25-3"></a><span class="go">Bluetooth: HCI device and connection manager initialized</span>
</span><span id="__span-25-4"><a id="__codelineno-25-4" name="__codelineno-25-4" href="#__codelineno-25-4"></a><span class="go">Bluetooth: HCI socket layer initialized</span>
</span><span id="__span-25-5"><a id="__codelineno-25-5" name="__codelineno-25-5" href="#__codelineno-25-5"></a><span class="go">Bluetooth: L2CAP socket layer initialized</span>
</span><span id="__span-25-6"><a id="__codelineno-25-6" name="__codelineno-25-6" href="#__codelineno-25-6"></a><span class="go">Bluetooth: SCO socket layer initialized</span>
</span><span id="__span-25-7"><a id="__codelineno-25-7" name="__codelineno-25-7" href="#__codelineno-25-7"></a><span class="go">Bluetooth: hci0: Device revision is 0</span>
</span><span id="__span-25-8"><a id="__codelineno-25-8" name="__codelineno-25-8" href="#__codelineno-25-8"></a><span class="go">Bluetooth: hci0: Secure boot is enabled</span>
</span><span id="__span-25-9"><a id="__codelineno-25-9" name="__codelineno-25-9" href="#__codelineno-25-9"></a><span class="go">Bluetooth: hci0: OTP lock is enabled</span>
</span><span id="__span-25-10"><a id="__codelineno-25-10" name="__codelineno-25-10" href="#__codelineno-25-10"></a><span class="go">Bluetooth: hci0: API lock is enabled</span>
</span><span id="__span-25-11"><a id="__codelineno-25-11" name="__codelineno-25-11" href="#__codelineno-25-11"></a><span class="go">Bluetooth: hci0: Debug lock is disabled</span>
</span><span id="__span-25-12"><a id="__codelineno-25-12" name="__codelineno-25-12" href="#__codelineno-25-12"></a><span class="go">Bluetooth: hci0: Minimum firmware build 1 week 10 2014</span>
</span><span id="__span-25-13"><a id="__codelineno-25-13" name="__codelineno-25-13" href="#__codelineno-25-13"></a><span class="go">Bluetooth: hci0: Bootloader timestamp 2019.40 buildtype 1 build 38</span>
</span><span id="__span-25-14"><a id="__codelineno-25-14" name="__codelineno-25-14" href="#__codelineno-25-14"></a><span class="go">Bluetooth: hci0: DSM reset method type: 0x00</span>
</span><span id="__span-25-15"><a id="__codelineno-25-15" name="__codelineno-25-15" href="#__codelineno-25-15"></a><span class="go">Bluetooth: hci0: Found device firmware: intel/ibt-0040-0041.sfi</span>
</span><span id="__span-25-16"><a id="__codelineno-25-16" name="__codelineno-25-16" href="#__codelineno-25-16"></a><span class="go">Bluetooth: hci0: Boot Address: 0x100800</span>
</span><span id="__span-25-17"><a id="__codelineno-25-17" name="__codelineno-25-17" href="#__codelineno-25-17"></a><span class="go">Bluetooth: hci0: Firmware Version: 60-48.23</span>
</span><span id="__span-25-18"><a id="__codelineno-25-18" name="__codelineno-25-18" href="#__codelineno-25-18"></a><span class="go">Bluetooth: BNEP (Ethernet Emulation) ver 1.3</span>
</span><span id="__span-25-19"><a id="__codelineno-25-19" name="__codelineno-25-19" href="#__codelineno-25-19"></a><span class="go">Bluetooth: BNEP filters: protocol multicast</span>
</span><span id="__span-25-20"><a id="__codelineno-25-20" name="__codelineno-25-20" href="#__codelineno-25-20"></a><span class="go">Bluetooth: BNEP socket layer initialized</span>
</span><span id="__span-25-21"><a id="__codelineno-25-21" name="__codelineno-25-21" href="#__codelineno-25-21"></a><span class="go">Bluetooth: hci0: Waiting for firmware download to complete</span>
</span><span id="__span-25-22"><a id="__codelineno-25-22" name="__codelineno-25-22" href="#__codelineno-25-22"></a><span class="go">Bluetooth: hci0: Firmware loaded in 1536493 usecs</span>
</span><span id="__span-25-23"><a id="__codelineno-25-23" name="__codelineno-25-23" href="#__codelineno-25-23"></a><span class="go">Bluetooth: hci0: Waiting for device to boot</span>
</span><span id="__span-25-24"><a id="__codelineno-25-24" name="__codelineno-25-24" href="#__codelineno-25-24"></a><span class="go">Bluetooth: hci0: Device booted in 15625 usecs</span>
</span><span id="__span-25-25"><a id="__codelineno-25-25" name="__codelineno-25-25" href="#__codelineno-25-25"></a><span class="go">Bluetooth: hci0: Malformed MSFT vendor event: 0x02</span>
</span><span id="__span-25-26"><a id="__codelineno-25-26" name="__codelineno-25-26" href="#__codelineno-25-26"></a><span class="go">Bluetooth: hci0: Found Intel DDC parameters: intel/ibt-0040-0041.ddc</span>
</span><span id="__span-25-27"><a id="__codelineno-25-27" name="__codelineno-25-27" href="#__codelineno-25-27"></a><span class="go">Bluetooth: hci0: Applying Intel DDC parameters completed</span>
</span><span id="__span-25-28"><a id="__codelineno-25-28" name="__codelineno-25-28" href="#__codelineno-25-28"></a><span class="go">Bluetooth: hci0: Firmware timestamp 2023.48 buildtype 1 build 75324</span>
</span><span id="__span-25-29"><a id="__codelineno-25-29" name="__codelineno-25-29" href="#__codelineno-25-29"></a><span class="go">Bluetooth: hci0: Firmware SHA1: 0x23bac558</span>
</span><span id="__span-25-30"><a id="__codelineno-25-30" name="__codelineno-25-30" href="#__codelineno-25-30"></a><span class="go">Bluetooth: MGMT ver 1.22</span>
</span></code></pre></div>
<h4 id="bluetooth-headphones">Bluetooth headphones</h4>
<p>Pairing headphones (Bose QuietComfort SE) was quick and easy. As a fun
bonus, every time the PC connects to the headphones an audible notification
announced <em>connected to super tuna</em> which is fun.</p>
<h2 id="kernel-memory-leak">Kernel memory leak</h2>
<p>Only in this Nuc PC is Ubuntu Studio 24.04 showing a huge memory leak
and it seems to be in the kernel rather than in any application/s:</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-26-1"><a id="__codelineno-26-1" name="__codelineno-26-1" href="#__codelineno-26-1"></a><span class="gp"># </span>free<span class="w"> </span>-h
</span><span id="__span-26-2"><a id="__codelineno-26-2" name="__codelineno-26-2" href="#__codelineno-26-2"></a><span class="go">               total        used        free      shared  buff/cache   available</span>
</span><span id="__span-26-3"><a id="__codelineno-26-3" name="__codelineno-26-3" href="#__codelineno-26-3"></a><span class="go">Mem:            30Gi        25Gi       1.6Gi       190Mi       4.2Gi       5.0Gi</span>
</span><span id="__span-26-4"><a id="__codelineno-26-4" name="__codelineno-26-4" href="#__codelineno-26-4"></a><span class="go">Swap:          8.0Gi       256Ki       8.0Gi</span>
</span></code></pre></div>
<p>This could have been caused by transferring 1.5 TB of data over the
network, but normally that would increase only the buff/cache usage
and that is not the case here. It is the <em>actually</em> <code>used</code> memory
that has been growing steadily over hours and is only released upon
rebooting:</p>
<p><a class="glightbox" data-type="image" data-width="auto" data-height="auto" href="../../../../media/2024-11-15-ubuntu-studio-24-04-on-super-tuna-nuc-pc/super-tuna-last-9-h.png" data-desc-position="bottom"><img alt="Memory usage in the last 9 hours" src="../../../../media/2024-11-15-ubuntu-studio-24-04-on-super-tuna-nuc-pc/super-tuna-last-9-h.png"></a></p>
<details class="note">
<summary>Red herring: <code>fluidsynth</code></summary>
<p>Killing the most memory intensive process had previously made no dent:</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-27-1"><a id="__codelineno-27-1" name="__codelineno-27-1" href="#__codelineno-27-1"></a><span class="gp"># </span>ps<span class="w"> </span>-ax<span class="w"> </span>-eo<span class="w"> </span>user,pid,pcpu:5,pmem:5,rss:8<span class="o">=</span>R-MEM,vsz:10<span class="o">=</span>V-MEM,tty:6<span class="o">=</span>TTY,stat:5,bsdstart:7,bsdtime:7,args<span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="o">(</span><span class="nb">read</span><span class="w"> </span>h<span class="p">;</span><span class="w"> </span><span class="nb">echo</span><span class="w"> </span><span class="s2">"</span><span class="nv">$h</span><span class="s2">"</span><span class="p">;</span><span class="w"> </span>sort<span class="w"> </span>-nr<span class="w"> </span>-k<span class="w"> </span><span class="m">4</span><span class="o">)</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>head<span class="w"> </span>-10<span class="w"> </span><span class="p">|</span><span class="w"> </span>less<span class="w"> </span>-SEX
</span><span id="__span-27-2"><a id="__codelineno-27-2" name="__codelineno-27-2" href="#__codelineno-27-2"></a><span class="go">USER         PID  %CPU  %MEM    R-MEM      V-MEM TTY    STAT    START    TIME COMMAND</span>
</span><span id="__span-27-3"><a id="__codelineno-27-3" name="__codelineno-27-3" href="#__codelineno-27-3"></a><span class="go">root     2661652   0.5   0.7   246360    1568376 ?      SLsl    07:57    0:13 /usr/bin/fluidsynth -is /usr/share/sounds/sf3/default-GM.sf3 HOME=/ro&gt;</span>
</span><span id="__span-27-4"><a id="__codelineno-27-4" name="__codelineno-27-4" href="#__codelineno-27-4"></a><span class="go">sddm     2405392   0.2   0.4   158060    1140264 ?      Sl      00:48    1:03 /usr/bin/sddm-greeter --socket /tmp/sddm-:0-KPzxxr --theme /usr/share&gt;</span>
</span><span id="__span-27-5"><a id="__codelineno-27-5" name="__codelineno-27-5" href="#__codelineno-27-5"></a><span class="go">colord     12644   0.0   0.3   120748     425728 ?      Ssl     00:40    0:00 /usr/libexec/colord LANG=es_ES.UTF-8 PATH=/usr/local/sbin:/usr/local/&gt;</span>
</span><span id="__span-27-6"><a id="__codelineno-27-6" name="__codelineno-27-6" href="#__codelineno-27-6"></a><span class="go">root     2381522   0.0   0.2    83072     763252 tty2   Ssl+    00:47    0:14 /usr/lib/xorg/Xorg -nolisten tcp -background none -seat seat0 vt2 -au&gt;</span>
</span><span id="__span-27-7"><a id="__codelineno-27-7" name="__codelineno-27-7" href="#__codelineno-27-7"></a><span class="go">root         481   0.0   0.2    75596     137064 ?      S&lt;s     00:40    0:19 /usr/lib/systemd/systemd-journald LANG=es_ES.UTF-8 PATH=/usr/local/sb&gt;</span>
</span><span id="__span-27-8"><a id="__codelineno-27-8" name="__codelineno-27-8" href="#__codelineno-27-8"></a><span class="go">root       14132   0.0   0.1    40788     477384 ?      Ssl     00:54    0:01 /usr/libexec/fwupd/fwupd LANG=es_ES.UTF-8 PATH=/usr/local/sbin:/usr/l&gt;</span>
</span><span id="__span-27-9"><a id="__codelineno-27-9" name="__codelineno-27-9" href="#__codelineno-27-9"></a><span class="go">root        1680   0.0   0.1    33252    2731468 ?      Ssl     00:40    0:02 /usr/lib/snapd/snapd LANG=es_ES.UTF-8 PATH=/usr/local/sbin:/usr/local&gt;</span>
</span><span id="__span-27-10"><a id="__codelineno-27-10" name="__codelineno-27-10" href="#__codelineno-27-10"></a><span class="go">minidlna    1645   0.0   0.1    36224     336280 ?      SLsl    00:40    0:00 /usr/sbin/minidlnad -f /etc/minidlna.conf -P /run/minidlna/minidlna.p&gt;</span>
</span><span id="__span-27-11"><a id="__codelineno-27-11" name="__codelineno-27-11" href="#__codelineno-27-11"></a><span class="go">debian-+   30046   0.3   0.1    61244    1252000 ?      Ssl     00:40    1:26 /usr/bin/tor --defaults-torrc /usr/share/tor/tor-service-defaults-tor&gt;</span>
</span><span id="__span-27-12"><a id="__codelineno-27-12" name="__codelineno-27-12" href="#__codelineno-27-12"></a>
</span><span id="__span-27-13"><a id="__codelineno-27-13" name="__codelineno-27-13" href="#__codelineno-27-13"></a><span class="gp"># </span>killall<span class="w"> </span>/usr/bin/fluidsynth
</span><span id="__span-27-14"><a id="__codelineno-27-14" name="__codelineno-27-14" href="#__codelineno-27-14"></a><span class="gp"># </span>ps<span class="w"> </span>-ax<span class="w"> </span>-eo<span class="w"> </span>user,pid,pcpu:5,pmem:5,rss:8<span class="o">=</span>R-MEM,vsz:10<span class="o">=</span>V-MEM,tty:6<span class="o">=</span>TTY,stat:5,bsdstart:7,bsdtime:7,args<span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="o">(</span><span class="nb">read</span><span class="w"> </span>h<span class="p">;</span><span class="w"> </span><span class="nb">echo</span><span class="w"> </span><span class="s2">"</span><span class="nv">$h</span><span class="s2">"</span><span class="p">;</span><span class="w"> </span>sort<span class="w"> </span>-nr<span class="w"> </span>-k<span class="w"> </span><span class="m">4</span><span class="o">)</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>head<span class="w"> </span>-10<span class="w"> </span><span class="p">|</span><span class="w"> </span>less<span class="w"> </span>-SEX
</span><span id="__span-27-15"><a id="__codelineno-27-15" name="__codelineno-27-15" href="#__codelineno-27-15"></a><span class="go">USER         PID  %CPU  %MEM    R-MEM      V-MEM TTY    STAT    START    TIME COMMAND</span>
</span><span id="__span-27-16"><a id="__codelineno-27-16" name="__codelineno-27-16" href="#__codelineno-27-16"></a><span class="go">sddm     2405392   0.2   0.4   158060    1140328 ?      Sl      00:48    1:04 /usr/bin/sddm-greeter --socket /tmp/sddm-:0-KPzxxr --theme /usr/share&gt;</span>
</span><span id="__span-27-17"><a id="__codelineno-27-17" name="__codelineno-27-17" href="#__codelineno-27-17"></a><span class="go">colord     12644   0.0   0.3   120748     425728 ?      Ssl     00:40    0:00 /usr/libexec/colord LANG=es_ES.UTF-8 PATH=/usr/local/sbin:/usr/local/&gt;</span>
</span><span id="__span-27-18"><a id="__codelineno-27-18" name="__codelineno-27-18" href="#__codelineno-27-18"></a><span class="go">root     2381522   0.0   0.2    83072     763252 tty2   Ssl+    00:47    0:14 /usr/lib/xorg/Xorg -nolisten tcp -background none -seat seat0 vt2 -au&gt;</span>
</span><span id="__span-27-19"><a id="__codelineno-27-19" name="__codelineno-27-19" href="#__codelineno-27-19"></a><span class="go">root         481   0.0   0.2    76236     137064 ?      S&lt;s     00:40    0:19 /usr/lib/systemd/systemd-journald LANG=es_ES.UTF-8 PATH=/usr/local/sb&gt;</span>
</span><span id="__span-27-20"><a id="__codelineno-27-20" name="__codelineno-27-20" href="#__codelineno-27-20"></a><span class="go">root       14132   0.0   0.1    40788     477384 ?      Ssl     00:54    0:01 /usr/libexec/fwupd/fwupd LANG=es_ES.UTF-8 PATH=/usr/local/sbin:/usr/l&gt;</span>
</span><span id="__span-27-21"><a id="__codelineno-27-21" name="__codelineno-27-21" href="#__codelineno-27-21"></a><span class="go">root        1680   0.0   0.1    33252    2731468 ?      Ssl     00:40    0:02 /usr/lib/snapd/snapd LANG=es_ES.UTF-8 PATH=/usr/local/sbin:/usr/local&gt;</span>
</span><span id="__span-27-22"><a id="__codelineno-27-22" name="__codelineno-27-22" href="#__codelineno-27-22"></a><span class="go">minidlna    1645   0.0   0.1    36224     336280 ?      SLsl    00:40    0:00 /usr/sbin/minidlnad -f /etc/minidlna.conf -P /run/minidlna/minidlna.p&gt;</span>
</span><span id="__span-27-23"><a id="__codelineno-27-23" name="__codelineno-27-23" href="#__codelineno-27-23"></a><span class="go">debian-+   30046   0.3   0.1    61244    1252000 ?      Ssl     00:40    1:27 /usr/bin/tor --defaults-torrc /usr/share/tor/tor-service-defaults-tor&gt;</span>
</span><span id="__span-27-24"><a id="__codelineno-27-24" name="__codelineno-27-24" href="#__codelineno-27-24"></a><span class="go">vnstat      5498   0.0   0.0     3584       5476 ?      Ss      00:40    0:03 /usr/sbin/vnstatd -n LANG=es_ES.UTF-8 PATH=/usr/local/sbin:/usr/local&gt;</span>
</span><span id="__span-27-25"><a id="__codelineno-27-25" name="__codelineno-27-25" href="#__codelineno-27-25"></a>
</span><span id="__span-27-26"><a id="__codelineno-27-26" name="__codelineno-27-26" href="#__codelineno-27-26"></a><span class="gp"># </span>free<span class="w"> </span>-h
</span><span id="__span-27-27"><a id="__codelineno-27-27" name="__codelineno-27-27" href="#__codelineno-27-27"></a><span class="go">              total        used        free      shared  buff/cache   available</span>
</span><span id="__span-27-28"><a id="__codelineno-27-28" name="__codelineno-27-28" href="#__codelineno-27-28"></a><span class="go">Mem:            30Gi        27Gi       3.6Gi       188Mi       1.0Gi       3.8Gi</span>
</span><span id="__span-27-29"><a id="__codelineno-27-29" name="__codelineno-27-29" href="#__codelineno-27-29"></a><span class="go">Swap:          8.0Gi       256Ki       8.0Gi</span>
</span></code></pre></div>
<p>That <code>fluidsynth</code> process may have been a leftover from having started <code>ardour</code>
earlier, but this was not really a problematic case of
<a href="https://askubuntu.com/questions/1446116/fluidsynth-starting-automatically-on-boot-login-freezing-connected-how-to-so">Fluidsynth Starting Automatically On Boot; Login Freezing</a>.</p>
</details>
<details class="note">
<summary>Red herring: <code>drop_caches</code></summary>
<p>The trick in <a href="https://www.linuxatemyram.com/">linuxatemyram.com</a>
to drop caches did not help:</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-28-1"><a id="__codelineno-28-1" name="__codelineno-28-1" href="#__codelineno-28-1"></a><span class="gp"># </span><span class="nb">echo</span><span class="w"> </span><span class="m">3</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>sudo<span class="w"> </span>tee<span class="w"> </span>/proc/sys/vm/drop_caches
</span><span id="__span-28-2"><a id="__codelineno-28-2" name="__codelineno-28-2" href="#__codelineno-28-2"></a><span class="go">3</span>
</span><span id="__span-28-3"><a id="__codelineno-28-3" name="__codelineno-28-3" href="#__codelineno-28-3"></a>
</span><span id="__span-28-4"><a id="__codelineno-28-4" name="__codelineno-28-4" href="#__codelineno-28-4"></a><span class="gp"># </span>free<span class="w"> </span>-h
</span><span id="__span-28-5"><a id="__codelineno-28-5" name="__codelineno-28-5" href="#__codelineno-28-5"></a><span class="go">              total        used        free      shared  buff/cache   available</span>
</span><span id="__span-28-6"><a id="__codelineno-28-6" name="__codelineno-28-6" href="#__codelineno-28-6"></a><span class="go">Mem:            30Gi        26Gi       4.5Gi       188Mi       781Mi       4.6Gi</span>
</span><span id="__span-28-7"><a id="__codelineno-28-7" name="__codelineno-28-7" href="#__codelineno-28-7"></a><span class="go">Swap:          8.0Gi       256Ki       8.0Gi</span>
</span><span id="__span-28-8"><a id="__codelineno-28-8" name="__codelineno-28-8" href="#__codelineno-28-8"></a>
</span><span id="__span-28-9"><a id="__codelineno-28-9" name="__codelineno-28-9" href="#__codelineno-28-9"></a><span class="gp"># </span>free<span class="w"> </span>-m
</span><span id="__span-28-10"><a id="__codelineno-28-10" name="__codelineno-28-10" href="#__codelineno-28-10"></a><span class="go">              total        used        free      shared  buff/cache   available</span>
</span><span id="__span-28-11"><a id="__codelineno-28-11" name="__codelineno-28-11" href="#__codelineno-28-11"></a><span class="go">Mem:           31645       27081        4200         186        1013        4563</span>
</span><span id="__span-28-12"><a id="__codelineno-28-12" name="__codelineno-28-12" href="#__codelineno-28-12"></a><span class="go">Swap:           8191           0        8191</span>
</span></code></pre></div>
<p>Indeed this only releases the <code>buff/cache</code> memory, not that which is <code>used</code>:</p>
<p><a class="glightbox" data-type="image" data-width="auto" data-height="auto" href="../../../../media/2024-11-15-ubuntu-studio-24-04-on-super-tuna-nuc-pc/super-tuna-last-15-min.png" data-desc-position="bottom"><img alt="Memory usage in the last 15 minutes" src="../../../../media/2024-11-15-ubuntu-studio-24-04-on-super-tuna-nuc-pc/super-tuna-last-15-min.png"></a></p>
<p>There was another hint somewhere (Red Hat Oracle documentation)
about the number of "huge pages" but that is already set to zero:</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-29-1"><a id="__codelineno-29-1" name="__codelineno-29-1" href="#__codelineno-29-1"></a><span class="gp"># </span>cat<span class="w"> </span>/proc/sys/vm/nr_hugepages<span class="w"> </span>
</span><span id="__span-29-2"><a id="__codelineno-29-2" name="__codelineno-29-2" href="#__codelineno-29-2"></a><span class="go">0</span>
</span></code></pre></div>
</details>
<h3 id="suspect-driver-i915">Suspect driver: <code>i915</code></h3>
<p>After a wider and deeper investigation
(see ~1500 lines in <a href="../../../../media/2024-11-15-ubuntu-studio-24-04-on-super-tuna-nuc-pc/2024-11-16-14-50.txt">this log</a>)
it looks like a memory leak bug in the <code>i915</code> driver:</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-30-1"><a id="__codelineno-30-1" name="__codelineno-30-1" href="#__codelineno-30-1"></a><span class="gp"># </span>apt<span class="w"> </span>install<span class="w"> </span>smem<span class="w"> </span>-y
</span><span id="__span-30-2"><a id="__codelineno-30-2" name="__codelineno-30-2" href="#__codelineno-30-2"></a>
</span><span id="__span-30-3"><a id="__codelineno-30-3" name="__codelineno-30-3" href="#__codelineno-30-3"></a><span class="gp"># </span>smem<span class="w"> </span>-twk
</span><span id="__span-30-4"><a id="__codelineno-30-4" name="__codelineno-30-4" href="#__codelineno-30-4"></a><span class="go">Area                           Used      Cache   Noncache </span>
</span><span id="__span-30-5"><a id="__codelineno-30-5" name="__codelineno-30-5" href="#__codelineno-30-5"></a><span class="go">firmware/hardware                 0          0          0 </span>
</span><span id="__span-30-6"><a id="__codelineno-30-6" name="__codelineno-30-6" href="#__codelineno-30-6"></a><span class="go">kernel image                      0          0          0 </span>
</span><span id="__span-30-7"><a id="__codelineno-30-7" name="__codelineno-30-7" href="#__codelineno-30-7"></a><span class="go">kernel dynamic memory         18.7G       3.1G      15.5G </span>
</span><span id="__span-30-8"><a id="__codelineno-30-8" name="__codelineno-30-8" href="#__codelineno-30-8"></a><span class="go">userspace memory               2.4G       1.2G       1.3G </span>
</span><span id="__span-30-9"><a id="__codelineno-30-9" name="__codelineno-30-9" href="#__codelineno-30-9"></a><span class="go">free memory                    9.8G       9.8G          0 </span>
</span><span id="__span-30-10"><a id="__codelineno-30-10" name="__codelineno-30-10" href="#__codelineno-30-10"></a><span class="go">----------------------------------------------------------</span>
</span><span id="__span-30-11"><a id="__codelineno-30-11" name="__codelineno-30-11" href="#__codelineno-30-11"></a><span class="go">                              30.9G      14.1G      16.8G </span>
</span><span id="__span-30-12"><a id="__codelineno-30-12" name="__codelineno-30-12" href="#__codelineno-30-12"></a>
</span><span id="__span-30-13"><a id="__codelineno-30-13" name="__codelineno-30-13" href="#__codelineno-30-13"></a><span class="gp"># </span>smem<span class="w"> </span>-wp
</span><span id="__span-30-14"><a id="__codelineno-30-14" name="__codelineno-30-14" href="#__codelineno-30-14"></a><span class="go">Area                           Used      Cache   Noncache </span>
</span><span id="__span-30-15"><a id="__codelineno-30-15" name="__codelineno-30-15" href="#__codelineno-30-15"></a><span class="go">firmware/hardware             0.00%      0.00%      0.00% </span>
</span><span id="__span-30-16"><a id="__codelineno-30-16" name="__codelineno-30-16" href="#__codelineno-30-16"></a><span class="go">kernel image                  0.00%      0.00%      0.00% </span>
</span><span id="__span-30-17"><a id="__codelineno-30-17" name="__codelineno-30-17" href="#__codelineno-30-17"></a><span class="go">kernel dynamic memory        58.94%     10.13%     48.81% </span>
</span><span id="__span-30-18"><a id="__codelineno-30-18" name="__codelineno-30-18" href="#__codelineno-30-18"></a><span class="go">userspace memory              7.24%      3.05%      4.19% </span>
</span><span id="__span-30-19"><a id="__codelineno-30-19" name="__codelineno-30-19" href="#__codelineno-30-19"></a><span class="go">free memory                  33.81%     33.81%      0.00% </span>
</span><span id="__span-30-20"><a id="__codelineno-30-20" name="__codelineno-30-20" href="#__codelineno-30-20"></a>
</span><span id="__span-30-21"><a id="__codelineno-30-21" name="__codelineno-30-21" href="#__codelineno-30-21"></a><span class="gp"># </span>lsmod<span class="w"> </span><span class="p">|</span><span class="w"> </span>sort<span class="w"> </span>-nr<span class="w"> </span>-k<span class="w"> </span><span class="m">2</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>head
</span><span id="__span-30-22"><a id="__codelineno-30-22" name="__codelineno-30-22" href="#__codelineno-30-22"></a><span class="go">i915                 4284416  69</span>
</span><span id="__span-30-23"><a id="__codelineno-30-23" name="__codelineno-30-23" href="#__codelineno-30-23"></a><span class="go">xe                   2711552  0</span>
</span><span id="__span-30-24"><a id="__codelineno-30-24" name="__codelineno-30-24" href="#__codelineno-30-24"></a><span class="go">btrfs                2015232  1</span>
</span><span id="__span-30-25"><a id="__codelineno-30-25" name="__codelineno-30-25" href="#__codelineno-30-25"></a><span class="go">mac80211             1720320  1 iwlmvm</span>
</span><span id="__span-30-26"><a id="__codelineno-30-26" name="__codelineno-30-26" href="#__codelineno-30-26"></a><span class="go">kvm                  1409024  1 kvm_intel</span>
</span><span id="__span-30-27"><a id="__codelineno-30-27" name="__codelineno-30-27" href="#__codelineno-30-27"></a><span class="go">cfg80211             1323008  3 iwlmvm,iwlwifi,mac80211</span>
</span><span id="__span-30-28"><a id="__codelineno-30-28" name="__codelineno-30-28" href="#__codelineno-30-28"></a><span class="go">bluetooth            1028096  71 btrtl,btmtk,btintel,btbcm,bnep,btusb,rfcomm</span>
</span><span id="__span-30-29"><a id="__codelineno-30-29" name="__codelineno-30-29" href="#__codelineno-30-29"></a><span class="go">iwlmvm                868352  0</span>
</span><span id="__span-30-30"><a id="__codelineno-30-30" name="__codelineno-30-30" href="#__codelineno-30-30"></a><span class="go">iwlwifi               598016  1 iwlmvm</span>
</span><span id="__span-30-31"><a id="__codelineno-30-31" name="__codelineno-30-31" href="#__codelineno-30-31"></a><span class="go">thunderbolt           516096  0</span>
</span><span id="__span-30-32"><a id="__codelineno-30-32" name="__codelineno-30-32" href="#__codelineno-30-32"></a>
</span><span id="__span-30-33"><a id="__codelineno-30-33" name="__codelineno-30-33" href="#__codelineno-30-33"></a><span class="gp"># </span>uname<span class="w"> </span>-a
</span><span id="__span-30-34"><a id="__codelineno-30-34" name="__codelineno-30-34" href="#__codelineno-30-34"></a><span class="go">Linux super-tuna 6.8.0-47-lowlatency #47.1-Ubuntu SMP PREEMPT_DYNAMIC Mon Oct  7 15:01:17 UTC 2024 x86_64 x86_64 x86_64 GNU/Linux</span>
</span><span id="__span-30-35"><a id="__codelineno-30-35" name="__codelineno-30-35" href="#__codelineno-30-35"></a>
</span><span id="__span-30-36"><a id="__codelineno-30-36" name="__codelineno-30-36" href="#__codelineno-30-36"></a><span class="gp"># </span>lspci<span class="w"> </span>-nnk
</span><span id="__span-30-37"><a id="__codelineno-30-37" name="__codelineno-30-37" href="#__codelineno-30-37"></a><span class="go">00:00.0 Host bridge [0600]: Intel Corporation Raptor Lake-P/U 4p+8e cores Host Bridge/DRAM Controller [8086:a707]</span>
</span><span id="__span-30-38"><a id="__codelineno-30-38" name="__codelineno-30-38" href="#__codelineno-30-38"></a><span class="go">        DeviceName: Onboard - Other</span>
</span><span id="__span-30-39"><a id="__codelineno-30-39" name="__codelineno-30-39" href="#__codelineno-30-39"></a><span class="go">        Subsystem: Intel Corporation Raptor Lake-P/U 4p+8e cores Host Bridge/DRAM Controller [8086:3037]</span>
</span><span id="__span-30-40"><a id="__codelineno-30-40" name="__codelineno-30-40" href="#__codelineno-30-40"></a><span class="go">        Kernel driver in use: igen6_edac</span>
</span><span id="__span-30-41"><a id="__codelineno-30-41" name="__codelineno-30-41" href="#__codelineno-30-41"></a><span class="go">        Kernel modules: igen6_edac</span>
</span><span id="__span-30-42"><a id="__codelineno-30-42" name="__codelineno-30-42" href="#__codelineno-30-42"></a><span class="go">00:02.0 VGA compatible controller [0300]: Intel Corporation Raptor Lake-P [UHD Graphics] [8086:a720] (rev 04)</span>
</span><span id="__span-30-43"><a id="__codelineno-30-43" name="__codelineno-30-43" href="#__codelineno-30-43"></a><span class="go">        DeviceName: Onboard - Video</span>
</span><span id="__span-30-44"><a id="__codelineno-30-44" name="__codelineno-30-44" href="#__codelineno-30-44"></a><span class="go">        Subsystem: Intel Corporation Raptor Lake-P [UHD Graphics] [8086:3037]</span>
</span><span id="__span-30-45"><a id="__codelineno-30-45" name="__codelineno-30-45" href="#__codelineno-30-45"></a><span class="go">        Kernel driver in use: i915</span>
</span><span id="__span-30-46"><a id="__codelineno-30-46" name="__codelineno-30-46" href="#__codelineno-30-46"></a><span class="go">        Kernel modules: i915, xe</span>
</span></code></pre></div>
<p>Since the <code>i915</code> and <code>xe</code> drivers are taking more memory than
all others, it looked like this could be a case of memory leak
in the driver (e.g. like
<a href="https://github.com/strongtz/i915-sriov-dkms/issues/137">strongtz/i915-sriov-dkms issue #137</a>).
However, this system is using the "vanilla" <code>i915</code> drivers and,
after the memory has been released by rebooting the system,
the drivers still show about the same size:</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-31-1"><a id="__codelineno-31-1" name="__codelineno-31-1" href="#__codelineno-31-1"></a><span class="gp"># </span>smem<span class="w"> </span>-twk
</span><span id="__span-31-2"><a id="__codelineno-31-2" name="__codelineno-31-2" href="#__codelineno-31-2"></a><span class="go">Area                           Used      Cache   Noncache </span>
</span><span id="__span-31-3"><a id="__codelineno-31-3" name="__codelineno-31-3" href="#__codelineno-31-3"></a><span class="go">firmware/hardware                 0          0          0 </span>
</span><span id="__span-31-4"><a id="__codelineno-31-4" name="__codelineno-31-4" href="#__codelineno-31-4"></a><span class="go">kernel image                      0          0          0 </span>
</span><span id="__span-31-5"><a id="__codelineno-31-5" name="__codelineno-31-5" href="#__codelineno-31-5"></a><span class="go">kernel dynamic memory          3.6G       2.1G       1.5G </span>
</span><span id="__span-31-6"><a id="__codelineno-31-6" name="__codelineno-31-6" href="#__codelineno-31-6"></a><span class="go">userspace memory               1.6G     499.5M       1.1G </span>
</span><span id="__span-31-7"><a id="__codelineno-31-7" name="__codelineno-31-7" href="#__codelineno-31-7"></a><span class="go">free memory                   25.7G      25.7G          0 </span>
</span><span id="__span-31-8"><a id="__codelineno-31-8" name="__codelineno-31-8" href="#__codelineno-31-8"></a><span class="go">----------------------------------------------------------</span>
</span><span id="__span-31-9"><a id="__codelineno-31-9" name="__codelineno-31-9" href="#__codelineno-31-9"></a><span class="go">                              30.9G      28.3G       2.6G </span>
</span><span id="__span-31-10"><a id="__codelineno-31-10" name="__codelineno-31-10" href="#__codelineno-31-10"></a>
</span><span id="__span-31-11"><a id="__codelineno-31-11" name="__codelineno-31-11" href="#__codelineno-31-11"></a><span class="gp"># </span>smem<span class="w"> </span>-wp
</span><span id="__span-31-12"><a id="__codelineno-31-12" name="__codelineno-31-12" href="#__codelineno-31-12"></a><span class="go">Area                           Used      Cache   Noncache </span>
</span><span id="__span-31-13"><a id="__codelineno-31-13" name="__codelineno-31-13" href="#__codelineno-31-13"></a><span class="go">firmware/hardware             0.00%      0.00%      0.00% </span>
</span><span id="__span-31-14"><a id="__codelineno-31-14" name="__codelineno-31-14" href="#__codelineno-31-14"></a><span class="go">kernel image                  0.00%      0.00%      0.00% </span>
</span><span id="__span-31-15"><a id="__codelineno-31-15" name="__codelineno-31-15" href="#__codelineno-31-15"></a><span class="go">kernel dynamic memory        11.84%      6.79%      5.05% </span>
</span><span id="__span-31-16"><a id="__codelineno-31-16" name="__codelineno-31-16" href="#__codelineno-31-16"></a><span class="go">userspace memory              5.08%      1.58%      3.50% </span>
</span><span id="__span-31-17"><a id="__codelineno-31-17" name="__codelineno-31-17" href="#__codelineno-31-17"></a><span class="go">free memory                  83.07%     83.07%      0.00%</span>
</span><span id="__span-31-18"><a id="__codelineno-31-18" name="__codelineno-31-18" href="#__codelineno-31-18"></a>
</span><span id="__span-31-19"><a id="__codelineno-31-19" name="__codelineno-31-19" href="#__codelineno-31-19"></a><span class="gp"># </span>lsmod<span class="w"> </span><span class="p">|</span><span class="w"> </span>sort<span class="w"> </span>-nr<span class="w"> </span>-k<span class="w"> </span><span class="m">2</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>head
</span><span id="__span-31-20"><a id="__codelineno-31-20" name="__codelineno-31-20" href="#__codelineno-31-20"></a><span class="go">i915                 4284416  60</span>
</span><span id="__span-31-21"><a id="__codelineno-31-21" name="__codelineno-31-21" href="#__codelineno-31-21"></a><span class="go">xe                   2711552  0</span>
</span><span id="__span-31-22"><a id="__codelineno-31-22" name="__codelineno-31-22" href="#__codelineno-31-22"></a><span class="go">btrfs                2015232  1</span>
</span><span id="__span-31-23"><a id="__codelineno-31-23" name="__codelineno-31-23" href="#__codelineno-31-23"></a><span class="go">mac80211             1720320  1 iwlmvm</span>
</span><span id="__span-31-24"><a id="__codelineno-31-24" name="__codelineno-31-24" href="#__codelineno-31-24"></a><span class="go">kvm                  1409024  1 kvm_intel</span>
</span><span id="__span-31-25"><a id="__codelineno-31-25" name="__codelineno-31-25" href="#__codelineno-31-25"></a><span class="go">cfg80211             1323008  3 iwlmvm,iwlwifi,mac80211</span>
</span><span id="__span-31-26"><a id="__codelineno-31-26" name="__codelineno-31-26" href="#__codelineno-31-26"></a><span class="go">bluetooth            1028096  44 btrtl,btmtk,btintel,btbcm,bnep,btusb,rfcomm</span>
</span><span id="__span-31-27"><a id="__codelineno-31-27" name="__codelineno-31-27" href="#__codelineno-31-27"></a><span class="go">iwlmvm                868352  0</span>
</span><span id="__span-31-28"><a id="__codelineno-31-28" name="__codelineno-31-28" href="#__codelineno-31-28"></a><span class="go">iwlwifi               598016  1 iwlmvm</span>
</span><span id="__span-31-29"><a id="__codelineno-31-29" name="__codelineno-31-29" href="#__codelineno-31-29"></a><span class="go">thunderbolt           516096  0</span>
</span></code></pre></div>
<p>The fix for
<a href="https://github.com/strongtz/i915-sriov-dkms/issues/137">strongtz/i915-sriov-dkms issue #137</a>
seems to be
<a href="https://github.com/strongtz/i915-sriov-dkms/pull/204/commits/de9f8627a82a13b4b0c7e283eac539cd6c40f409">strongtz/i915-sriov-dkms PR #204</a>
but that looks like a non-trivial change.</p>
<p>There is also a one-line patch to
<a href="https://patchwork.kernel.org/project/intel-gfx/patch/BYAPR03MB4168C6D020B750EAF8021731ADE22@BYAPR03MB4168.namprd03.prod.outlook.com/">Fix memory leak by correcting cache object name in error handler</a>
from May 2024 and is not yet applied to the source file
<code>drivers/gpu/drm/i915/i915_scheduler.c</code> in the
<code>linux-source-6.8.0</code> package. This one seems a more likely fix,
and a much simpler change to implement.</p>
<p>The patch apperas to have been
<a href="https://lore.kernel.org/lkml/Z1DNlAPvPNtgpMXO@ashyti-mobl2.lan/T/">resent in late November, 2024</a>,
<a href="https://gbmc.googlesource.com/linux/+/2828e5808bcd5aae7fdcd169cac1efa2701fa2dd">committed in early December</a>,
and that may be related to the patch not being (yet) available in the
6.8.0-47 and 6.8.0-49 kernels. The patch may be included in later kernels,
but after an update in early January, 2025 the kernel updated to 6.8.0-51
and yet the linux-source-6.8.0 package on version 6.8.0-<strong>51</strong>.52 still
does not have the patched applied.</p>
<div class="admonition todo">
<p class="admonition-title">Todo</p>
<p><a href="https://wiki.ubuntu.com/Kernel/BuildYourOwnKernel">BuildYourOwnKernel</a>
with the patched applied, see if that helps.</p>
</div>
<h3 id="maybe-somewhere-else">Maybe somewhere else?</h3>
<p>If the <code>i915</code> is not behind this memory leak, the one other lead from
<a href="../../../../media/2024-11-15-ubuntu-studio-24-04-on-super-tuna-nuc-pc/2024-11-16-14-50.txt">this log</a> is, by far, the largest
user of kernel memory is <code>kmalloc-rnd-07-8k</code>:</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-32-1"><a id="__codelineno-32-1" name="__codelineno-32-1" href="#__codelineno-32-1"></a><span class="gp"># </span>slabtop<span class="w"> </span>-o<span class="w"> </span><span class="p">|</span><span class="w"> </span>head<span class="w"> </span>-10
</span><span id="__span-32-2"><a id="__codelineno-32-2" name="__codelineno-32-2" href="#__codelineno-32-2"></a><span class="go"> Active / Total Objects (% used)    : 3424282 / 3461230 (98,9%)</span>
</span><span id="__span-32-3"><a id="__codelineno-32-3" name="__codelineno-32-3" href="#__codelineno-32-3"></a><span class="go"> Active / Total Slabs (% used)      : 507294 / 507294 (100,0%)</span>
</span><span id="__span-32-4"><a id="__codelineno-32-4" name="__codelineno-32-4" href="#__codelineno-32-4"></a><span class="go"> Active / Total Caches (% used)     : 341 / 386 (88,3%)</span>
</span><span id="__span-32-5"><a id="__codelineno-32-5" name="__codelineno-32-5" href="#__codelineno-32-5"></a><span class="go"> Active / Total Size (% used)       : 15543458,94K / 15549019,20K (100,0%)</span>
</span><span id="__span-32-6"><a id="__codelineno-32-6" name="__codelineno-32-6" href="#__codelineno-32-6"></a><span class="go"> Minimum / Average / Maximum Object : 0,01K / 4,49K / 10,25K</span>
</span><span id="__span-32-7"><a id="__codelineno-32-7" name="__codelineno-32-7" href="#__codelineno-32-7"></a>
</span><span id="__span-32-8"><a id="__codelineno-32-8" name="__codelineno-32-8" href="#__codelineno-32-8"></a><span class="go">  OBJS ACTIVE USE OBJ SIZE SLABS OBJ/SLAB CACHE SIZE NAME                     </span>
</span><span id="__span-32-9"><a id="__codelineno-32-9" name="__codelineno-32-9" href="#__codelineno-32-9"></a><span class="go">1901280 1901280 100%    8,00K 475320        4  15210240K kmalloc-rnd-07-8k</span>
</span><span id="__span-32-10"><a id="__codelineno-32-10" name="__codelineno-32-10" href="#__codelineno-32-10"></a><span class="go"> 170310  170106  99%    0,19K   4055       42     32440K dentry</span>
</span><span id="__span-32-11"><a id="__codelineno-32-11" name="__codelineno-32-11" href="#__codelineno-32-11"></a><span class="go"> 162825  162299  99%    0,10K   4175       39     16700K buffer_head</span>
</span></code></pre></div>
<p>That's a whooping <strong>14.5 GB</strong> used only by <code>kmalloc-rnd-07-8k</code>, which is
released only after a reboot (although soon enough back up to nearly 2 GB):</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-33-1"><a id="__codelineno-33-1" name="__codelineno-33-1" href="#__codelineno-33-1"></a><span class="gp"># </span>slabtop<span class="w"> </span>-o<span class="w"> </span><span class="p">|</span><span class="w"> </span>head<span class="w"> </span>-10
</span><span id="__span-33-2"><a id="__codelineno-33-2" name="__codelineno-33-2" href="#__codelineno-33-2"></a><span class="go"> Active / Total Objects (% used)    : 1413878 / 1435036 (98.5%)</span>
</span><span id="__span-33-3"><a id="__codelineno-33-3" name="__codelineno-33-3" href="#__codelineno-33-3"></a><span class="go"> Active / Total Slabs (% used)      : 87550 / 87550 (100.0%)</span>
</span><span id="__span-33-4"><a id="__codelineno-33-4" name="__codelineno-33-4" href="#__codelineno-33-4"></a><span class="go"> Active / Total Caches (% used)     : 338 / 386 (87.6%)</span>
</span><span id="__span-33-5"><a id="__codelineno-33-5" name="__codelineno-33-5" href="#__codelineno-33-5"></a><span class="go"> Active / Total Size (% used)       : 2300293.48K / 2306032.96K (99.8%)</span>
</span><span id="__span-33-6"><a id="__codelineno-33-6" name="__codelineno-33-6" href="#__codelineno-33-6"></a><span class="go"> Minimum / Average / Maximum Object : 0.01K / 1.61K / 10.25K</span>
</span><span id="__span-33-7"><a id="__codelineno-33-7" name="__codelineno-33-7" href="#__codelineno-33-7"></a>
</span><span id="__span-33-8"><a id="__codelineno-33-8" name="__codelineno-33-8" href="#__codelineno-33-8"></a><span class="go">  OBJS ACTIVE  USE OBJ SIZE  SLABS OBJ/SLAB CACHE SIZE NAME                   </span>
</span><span id="__span-33-9"><a id="__codelineno-33-9" name="__codelineno-33-9" href="#__codelineno-33-9"></a><span class="go">256376 256376 100%    8.00K  64094        4   2051008K kmalloc-rnd-12-8k      </span>
</span><span id="__span-33-10"><a id="__codelineno-33-10" name="__codelineno-33-10" href="#__codelineno-33-10"></a><span class="go">114996 114394  99%    0.19K   2738       42     21904K dentry                 </span>
</span><span id="__span-33-11"><a id="__codelineno-33-11" name="__codelineno-33-11" href="#__codelineno-33-11"></a><span class="go"> 73100  72807  99%    0.05K    860       85      3440K shared_policy_node     </span>
</span></code></pre></div>
<p>There is nothing like this on <code>rapture</code>, where <code>kmalloc-rnd-07-8k</code> is only 512K:</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-34-1"><a id="__codelineno-34-1" name="__codelineno-34-1" href="#__codelineno-34-1"></a><span class="gp">root@rapture:~# </span>slabtop<span class="w"> </span>-o<span class="w"> </span><span class="p">|</span><span class="w"> </span>head<span class="w"> </span>-10
</span><span id="__span-34-2"><a id="__codelineno-34-2" name="__codelineno-34-2" href="#__codelineno-34-2"></a><span class="go"> Active / Total Objects (% used)    : 7453076 / 7724162 (96.5%)</span>
</span><span id="__span-34-3"><a id="__codelineno-34-3" name="__codelineno-34-3" href="#__codelineno-34-3"></a><span class="go"> Active / Total Slabs (% used)      : 178099 / 178099 (100.0%)</span>
</span><span id="__span-34-4"><a id="__codelineno-34-4" name="__codelineno-34-4" href="#__codelineno-34-4"></a><span class="go"> Active / Total Caches (% used)     : 338 / 385 (87.8%)</span>
</span><span id="__span-34-5"><a id="__codelineno-34-5" name="__codelineno-34-5" href="#__codelineno-34-5"></a><span class="go"> Active / Total Size (% used)       : 2520903.59K / 2613929.42K (96.4%)</span>
</span><span id="__span-34-6"><a id="__codelineno-34-6" name="__codelineno-34-6" href="#__codelineno-34-6"></a><span class="go"> Minimum / Average / Maximum Object : 0.01K / 0.34K / 32.54K</span>
</span><span id="__span-34-7"><a id="__codelineno-34-7" name="__codelineno-34-7" href="#__codelineno-34-7"></a>
</span><span id="__span-34-8"><a id="__codelineno-34-8" name="__codelineno-34-8" href="#__codelineno-34-8"></a><span class="go">  OBJS ACTIVE  USE OBJ SIZE  SLABS OBJ/SLAB CACHE SIZE NAME                   </span>
</span><span id="__span-34-9"><a id="__codelineno-34-9" name="__codelineno-34-9" href="#__codelineno-34-9"></a><span class="go">1435392 1434726  99%    0.19K  34176       42    273408K dentry                 </span>
</span><span id="__span-34-10"><a id="__codelineno-34-10" name="__codelineno-34-10" href="#__codelineno-34-10"></a><span class="go">1334925 1332417  99%    0.05K  15705       85     62820K shared_policy_node     </span>
</span><span id="__span-34-11"><a id="__codelineno-34-11" name="__codelineno-34-11" href="#__codelineno-34-11"></a><span class="go">1063179 1063179 100%    1.06K  35928       30   1149696K btrfs_inode            </span>
</span><span id="__span-34-12"><a id="__codelineno-34-12" name="__codelineno-34-12" href="#__codelineno-34-12"></a>
</span><span id="__span-34-13"><a id="__codelineno-34-13" name="__codelineno-34-13" href="#__codelineno-34-13"></a><span class="gp"># </span>slabtop<span class="w"> </span>-o<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>kmalloc-rnd-12-8k
</span><span id="__span-34-14"><a id="__codelineno-34-14" name="__codelineno-34-14" href="#__codelineno-34-14"></a><span class="go">      64     64 100%    8.00K     16        4       512K kmalloc-rnd-12-8k </span>
</span></code></pre></div>
<p>To compare again, the biggest user of kernel dynamic memory is</p>
<ul>
<li><code>btrfs_inode</code> in <code>rapture</code>, with 1,149,792K after a good 20 hours up</li>
<li><code>kmalloc-rnd-12-8k</code> in <code>super-tuna</code>, with 2,391,360K after barely 1 hour up</li>
</ul>
<p><strong>5 hours later</strong> <code>kmalloc-rnd-12-8k</code> in <code>super-tuna</code> is up <strong>13.71 GB</strong>
again, which amounts for most of the <code>SUnreclaim</code> memory.</p>
<details class="terminal">
<summary><code>kmalloc-rnd-12-8k</code> up 13.7 GB, <code>SUnreclaim</code> up 15.3 GB.</summary>
<div class="language-console highlight"><pre><span></span><code><span id="__span-35-1"><a id="__codelineno-35-1" name="__codelineno-35-1" href="#__codelineno-35-1"></a><span class="gp"># </span>smem<span class="w"> </span>-twk
</span><span id="__span-35-2"><a id="__codelineno-35-2" name="__codelineno-35-2" href="#__codelineno-35-2"></a><span class="go">Area                           Used      Cache   Noncache </span>
</span><span id="__span-35-3"><a id="__codelineno-35-3" name="__codelineno-35-3" href="#__codelineno-35-3"></a><span class="go">firmware/hardware                 0          0          0 </span>
</span><span id="__span-35-4"><a id="__codelineno-35-4" name="__codelineno-35-4" href="#__codelineno-35-4"></a><span class="go">kernel image                      0          0          0 </span>
</span><span id="__span-35-5"><a id="__codelineno-35-5" name="__codelineno-35-5" href="#__codelineno-35-5"></a><span class="go">kernel dynamic memory         16.4G       2.2G      14.2G </span>
</span><span id="__span-35-6"><a id="__codelineno-35-6" name="__codelineno-35-6" href="#__codelineno-35-6"></a><span class="go">userspace memory               1.6G     534.1M       1.1G </span>
</span><span id="__span-35-7"><a id="__codelineno-35-7" name="__codelineno-35-7" href="#__codelineno-35-7"></a><span class="go">free memory                   12.9G      12.9G          0 </span>
</span><span id="__span-35-8"><a id="__codelineno-35-8" name="__codelineno-35-8" href="#__codelineno-35-8"></a><span class="go">----------------------------------------------------------</span>
</span><span id="__span-35-9"><a id="__codelineno-35-9" name="__codelineno-35-9" href="#__codelineno-35-9"></a><span class="go">                              30.9G      15.6G      15.3G </span>
</span><span id="__span-35-10"><a id="__codelineno-35-10" name="__codelineno-35-10" href="#__codelineno-35-10"></a><span class="gp"># </span>smem<span class="w"> </span>-wp
</span><span id="__span-35-11"><a id="__codelineno-35-11" name="__codelineno-35-11" href="#__codelineno-35-11"></a><span class="go">Area                           Used      Cache   Noncache </span>
</span><span id="__span-35-12"><a id="__codelineno-35-12" name="__codelineno-35-12" href="#__codelineno-35-12"></a><span class="go">firmware/hardware             0.00%      0.00%      0.00% </span>
</span><span id="__span-35-13"><a id="__codelineno-35-13" name="__codelineno-35-13" href="#__codelineno-35-13"></a><span class="go">kernel image                  0.00%      0.00%      0.00% </span>
</span><span id="__span-35-14"><a id="__codelineno-35-14" name="__codelineno-35-14" href="#__codelineno-35-14"></a><span class="go">kernel dynamic memory        53.19%      7.08%     46.11% </span>
</span><span id="__span-35-15"><a id="__codelineno-35-15" name="__codelineno-35-15" href="#__codelineno-35-15"></a><span class="go">userspace memory              5.24%      1.69%      3.55% </span>
</span><span id="__span-35-16"><a id="__codelineno-35-16" name="__codelineno-35-16" href="#__codelineno-35-16"></a><span class="go">free memory                  41.57%     41.57%      0.00% </span>
</span><span id="__span-35-17"><a id="__codelineno-35-17" name="__codelineno-35-17" href="#__codelineno-35-17"></a>
</span><span id="__span-35-18"><a id="__codelineno-35-18" name="__codelineno-35-18" href="#__codelineno-35-18"></a><span class="gp"># </span>lsmod<span class="w"> </span><span class="p">|</span><span class="w"> </span>sort<span class="w"> </span>-nr<span class="w"> </span>-k<span class="w"> </span><span class="m">2</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>head<span class="w"> </span>-3
</span><span id="__span-35-19"><a id="__codelineno-35-19" name="__codelineno-35-19" href="#__codelineno-35-19"></a><span class="go">i915                 4284416  59</span>
</span><span id="__span-35-20"><a id="__codelineno-35-20" name="__codelineno-35-20" href="#__codelineno-35-20"></a><span class="go">xe                   2711552  0</span>
</span><span id="__span-35-21"><a id="__codelineno-35-21" name="__codelineno-35-21" href="#__codelineno-35-21"></a><span class="go">btrfs                2015232  1</span>
</span><span id="__span-35-22"><a id="__codelineno-35-22" name="__codelineno-35-22" href="#__codelineno-35-22"></a>
</span><span id="__span-35-23"><a id="__codelineno-35-23" name="__codelineno-35-23" href="#__codelineno-35-23"></a><span class="gp"># </span>slabtop<span class="w"> </span>-o<span class="w"> </span><span class="p">|</span><span class="w"> </span>sort<span class="w"> </span>-r<span class="w"> </span>-n<span class="w"> </span>-k<span class="w"> </span><span class="m">7</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>head<span class="w"> </span>-10
</span><span id="__span-35-24"><a id="__codelineno-35-24" name="__codelineno-35-24" href="#__codelineno-35-24"></a><span class="go">1797400 1797400 100%    8.00K 449350        4  14379200K kmalloc-rnd-12-8k      </span>
</span><span id="__span-35-25"><a id="__codelineno-35-25" name="__codelineno-35-25" href="#__codelineno-35-25"></a><span class="go">22302  22302 100%    1.16K    826       27     26432K ext4_inode_cache       </span>
</span><span id="__span-35-26"><a id="__codelineno-35-26" name="__codelineno-35-26" href="#__codelineno-35-26"></a><span class="go">117432 116955  99%    0.19K   2796       42     22368K dentry                 </span>
</span><span id="__span-35-27"><a id="__codelineno-35-27" name="__codelineno-35-27" href="#__codelineno-35-27"></a><span class="go">22900  22835  99%    0.62K    916       25     14656K inode_cache            </span>
</span><span id="__span-35-28"><a id="__codelineno-35-28" name="__codelineno-35-28" href="#__codelineno-35-28"></a><span class="go">20944  20925  99%    0.57K    748       28     11968K radix_tree_node        </span>
</span><span id="__span-35-29"><a id="__codelineno-35-29" name="__codelineno-35-29" href="#__codelineno-35-29"></a><span class="go">72324  69525  96%    0.14K   2583       28     10332K kernfs_node_cache      </span>
</span><span id="__span-35-30"><a id="__codelineno-35-30" name="__codelineno-35-30" href="#__codelineno-35-30"></a><span class="go">  954    946  99%   10.25K    318        3     10176K task_struct            </span>
</span><span id="__span-35-31"><a id="__codelineno-35-31" name="__codelineno-35-31" href="#__codelineno-35-31"></a><span class="go">13754  13041  94%    0.70K    299       46      9568K proc_inode_cache       </span>
</span><span id="__span-35-32"><a id="__codelineno-35-32" name="__codelineno-35-32" href="#__codelineno-35-32"></a><span class="go">48510  47450  97%    0.19K   1155       42      9240K cred_jar               </span>
</span><span id="__span-35-33"><a id="__codelineno-35-33" name="__codelineno-35-33" href="#__codelineno-35-33"></a><span class="go">85137  85137 100%    0.10K   2183       39      8732K buffer_head     </span>
</span><span id="__span-35-34"><a id="__codelineno-35-34" name="__codelineno-35-34" href="#__codelineno-35-34"></a>
</span><span id="__span-35-35"><a id="__codelineno-35-35" name="__codelineno-35-35" href="#__codelineno-35-35"></a><span class="gp"># </span>cat<span class="w"> </span>/proc/slabinfo<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span><span class="s2">"kmalloc-rnd-12-8k"</span>
</span><span id="__span-35-36"><a id="__codelineno-35-36" name="__codelineno-35-36" href="#__codelineno-35-36"></a><span class="go">kmalloc-rnd-12-8k 1962444 1962444   8192    4    8 : tunables    0    0    0 : slabdata 490611 490611      0</span>
</span><span id="__span-35-37"><a id="__codelineno-35-37" name="__codelineno-35-37" href="#__codelineno-35-37"></a>
</span><span id="__span-35-38"><a id="__codelineno-35-38" name="__codelineno-35-38" href="#__codelineno-35-38"></a><span class="gp"># </span>head<span class="w"> </span>-3<span class="w"> </span>/proc/slabinfo<span class="p">;</span><span class="w"> </span>cat<span class="w"> </span>/proc/slabinfo<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span><span class="s2">"kmalloc-rnd-12-8k"</span>
</span><span id="__span-35-39"><a id="__codelineno-35-39" name="__codelineno-35-39" href="#__codelineno-35-39"></a><span class="go">slabinfo - version: 2.1</span>
</span><span id="__span-35-40"><a id="__codelineno-35-40" name="__codelineno-35-40" href="#__codelineno-35-40"></a><span class="gp"># </span>name<span class="w">            </span>&lt;active_objs&gt;<span class="w"> </span>&lt;num_objs&gt;<span class="w"> </span>&lt;objsize&gt;<span class="w"> </span>&lt;objperslab&gt;<span class="w"> </span>&lt;pagesperslab&gt;<span class="w"> </span>:<span class="w"> </span>tunables<span class="w"> </span>&lt;limit&gt;<span class="w"> </span>&lt;batchcount&gt;<span class="w"> </span>&lt;sharedfactor&gt;<span class="w"> </span>:<span class="w"> </span>slabdata<span class="w"> </span>&lt;active_slabs&gt;<span class="w"> </span>&lt;num_slabs&gt;<span class="w"> </span>&lt;sharedavail&gt;
</span><span id="__span-35-41"><a id="__codelineno-35-41" name="__codelineno-35-41" href="#__codelineno-35-41"></a><span class="go">QIPCRTR               78     78    832   39    8 : tunables    0    0    0 : slabdata      2      2      0</span>
</span><span id="__span-35-42"><a id="__codelineno-35-42" name="__codelineno-35-42" href="#__codelineno-35-42"></a><span class="go">kmalloc-rnd-12-8k 1963068 1963068   8192    4    8 : tunables    0    0    0 : slabdata 490767 490767      0</span>
</span><span id="__span-35-43"><a id="__codelineno-35-43" name="__codelineno-35-43" href="#__codelineno-35-43"></a>
</span><span id="__span-35-44"><a id="__codelineno-35-44" name="__codelineno-35-44" href="#__codelineno-35-44"></a><span class="gp"># </span>free<span class="w"> </span>-h
</span><span id="__span-35-45"><a id="__codelineno-35-45" name="__codelineno-35-45" href="#__codelineno-35-45"></a><span class="go">              total        used        free      shared  buff/cache   available</span>
</span><span id="__span-35-46"><a id="__codelineno-35-46" name="__codelineno-35-46" href="#__codelineno-35-46"></a><span class="go">Mem:            30Gi        17Gi        11Gi       748Mi       2.7Gi        13Gi</span>
</span><span id="__span-35-47"><a id="__codelineno-35-47" name="__codelineno-35-47" href="#__codelineno-35-47"></a><span class="go">Swap:          8.0Gi          0B       8.0Gi</span>
</span><span id="__span-35-48"><a id="__codelineno-35-48" name="__codelineno-35-48" href="#__codelineno-35-48"></a>
</span><span id="__span-35-49"><a id="__codelineno-35-49" name="__codelineno-35-49" href="#__codelineno-35-49"></a><span class="gp"># </span>cat<span class="w"> </span>/proc/meminfo<span class="w"> </span>
</span><span id="__span-35-50"><a id="__codelineno-35-50" name="__codelineno-35-50" href="#__codelineno-35-50"></a><span class="go">MemTotal:       32404656 kB</span>
</span><span id="__span-35-51"><a id="__codelineno-35-51" name="__codelineno-35-51" href="#__codelineno-35-51"></a><span class="go">MemFree:        12123032 kB</span>
</span><span id="__span-35-52"><a id="__codelineno-35-52" name="__codelineno-35-52" href="#__codelineno-35-52"></a><span class="go">MemAvailable:   13785908 kB</span>
</span><span id="__span-35-53"><a id="__codelineno-35-53" name="__codelineno-35-53" href="#__codelineno-35-53"></a><span class="go">Buffers:          137656 kB</span>
</span><span id="__span-35-54"><a id="__codelineno-35-54" name="__codelineno-35-54" href="#__codelineno-35-54"></a><span class="go">Cached:          2610480 kB</span>
</span><span id="__span-35-55"><a id="__codelineno-35-55" name="__codelineno-35-55" href="#__codelineno-35-55"></a><span class="go">SwapCached:            0 kB</span>
</span><span id="__span-35-56"><a id="__codelineno-35-56" name="__codelineno-35-56" href="#__codelineno-35-56"></a><span class="go">Active:          1825832 kB</span>
</span><span id="__span-35-57"><a id="__codelineno-35-57" name="__codelineno-35-57" href="#__codelineno-35-57"></a><span class="go">Inactive:        1126328 kB</span>
</span><span id="__span-35-58"><a id="__codelineno-35-58" name="__codelineno-35-58" href="#__codelineno-35-58"></a><span class="go">Active(anon):     970752 kB</span>
</span><span id="__span-35-59"><a id="__codelineno-35-59" name="__codelineno-35-59" href="#__codelineno-35-59"></a><span class="go">Inactive(anon):        0 kB</span>
</span><span id="__span-35-60"><a id="__codelineno-35-60" name="__codelineno-35-60" href="#__codelineno-35-60"></a><span class="go">Active(file):     855080 kB</span>
</span><span id="__span-35-61"><a id="__codelineno-35-61" name="__codelineno-35-61" href="#__codelineno-35-61"></a><span class="go">Inactive(file):  1126328 kB</span>
</span><span id="__span-35-62"><a id="__codelineno-35-62" name="__codelineno-35-62" href="#__codelineno-35-62"></a><span class="go">Unevictable:      940008 kB</span>
</span><span id="__span-35-63"><a id="__codelineno-35-63" name="__codelineno-35-63" href="#__codelineno-35-63"></a><span class="go">Mlocked:          212356 kB</span>
</span><span id="__span-35-64"><a id="__codelineno-35-64" name="__codelineno-35-64" href="#__codelineno-35-64"></a><span class="go">SwapTotal:       8388604 kB</span>
</span><span id="__span-35-65"><a id="__codelineno-35-65" name="__codelineno-35-65" href="#__codelineno-35-65"></a><span class="go">SwapFree:        8388604 kB</span>
</span><span id="__span-35-66"><a id="__codelineno-35-66" name="__codelineno-35-66" href="#__codelineno-35-66"></a><span class="go">Zswap:                 0 kB</span>
</span><span id="__span-35-67"><a id="__codelineno-35-67" name="__codelineno-35-67" href="#__codelineno-35-67"></a><span class="go">Zswapped:              0 kB</span>
</span><span id="__span-35-68"><a id="__codelineno-35-68" name="__codelineno-35-68" href="#__codelineno-35-68"></a><span class="go">Dirty:               256 kB</span>
</span><span id="__span-35-69"><a id="__codelineno-35-69" name="__codelineno-35-69" href="#__codelineno-35-69"></a><span class="go">Writeback:             0 kB</span>
</span><span id="__span-35-70"><a id="__codelineno-35-70" name="__codelineno-35-70" href="#__codelineno-35-70"></a><span class="go">AnonPages:       1143976 kB</span>
</span><span id="__span-35-71"><a id="__codelineno-35-71" name="__codelineno-35-71" href="#__codelineno-35-71"></a><span class="go">Mapped:           548812 kB</span>
</span><span id="__span-35-72"><a id="__codelineno-35-72" name="__codelineno-35-72" href="#__codelineno-35-72"></a><span class="go">Shmem:            766728 kB</span>
</span><span id="__span-35-73"><a id="__codelineno-35-73" name="__codelineno-35-73" href="#__codelineno-35-73"></a><span class="go">KReclaimable:     101908 kB</span>
</span><span id="__span-35-74"><a id="__codelineno-35-74" name="__codelineno-35-74" href="#__codelineno-35-74"></a><span class="go">Slab:           16161044 kB</span>
</span><span id="__span-35-75"><a id="__codelineno-35-75" name="__codelineno-35-75" href="#__codelineno-35-75"></a><span class="go">SReclaimable:     101908 kB</span>
</span><span id="__span-35-76"><a id="__codelineno-35-76" name="__codelineno-35-76" href="#__codelineno-35-76"></a><span class="go">SUnreclaim:     16059136 kB</span>
</span><span id="__span-35-77"><a id="__codelineno-35-77" name="__codelineno-35-77" href="#__codelineno-35-77"></a><span class="go">KernelStack:       13280 kB</span>
</span><span id="__span-35-78"><a id="__codelineno-35-78" name="__codelineno-35-78" href="#__codelineno-35-78"></a><span class="go">PageTables:        27176 kB</span>
</span><span id="__span-35-79"><a id="__codelineno-35-79" name="__codelineno-35-79" href="#__codelineno-35-79"></a><span class="go">...</span>
</span></code></pre></div>
</details>
<p>Google web search shows a single search result for <code>"kmalloc-rnd-12-8k"</code>
<a href="https://discussion.fedoraproject.org/t/kernel-memory-leak-fedora-40-nvidia-drivers-ollama/135038/29">which does not lead to a conclusive solution</a>.</p>
<h3 id="maybe-gone-after-reinstalling">Maybe gone after reinstalling?</h3>
<p>Out of frustation with this opaque memory leak and a few other details,
decided to reinstall Ubuntu Studio 24.04 anew.</p>
<p>Along the way had to
<a href="https://www.intel.com/content/www/us/en/support/articles/000005636/intel-nuc.html">update the BIOS</a>
(to version 33) because until that update the systen would not boot
from the USB start-up disk, even though it had booted from it only minutes ago.</p>
<p>Eventually, most to fhe above setup was restored and yet the memory leak
was no longer happening:</p>
<p><a class="glightbox" data-type="image" data-width="auto" data-height="auto" href="../../../../media/2024-11-15-ubuntu-studio-24-04-on-super-tuna-nuc-pc/super-tuna-2-h-with-memory-leak.png" data-desc-position="bottom"><img alt="Memory usage in a 2-hour period with memory leak" src="../../../../media/2024-11-15-ubuntu-studio-24-04-on-super-tuna-nuc-pc/super-tuna-2-h-with-memory-leak.png"></a></p>
<p>Moreover, it seems the CPU cores are running visibly cooler now:</p>
<p><a class="glightbox" data-type="image" data-width="auto" data-height="auto" href="../../../../media/2024-11-15-ubuntu-studio-24-04-on-super-tuna-nuc-pc/super-tuna-2-h-without-memory-leak.png" data-desc-position="bottom"><img alt="Memory usage in a 2-hour period withou memory leak" src="../../../../media/2024-11-15-ubuntu-studio-24-04-on-super-tuna-nuc-pc/super-tuna-2-h-without-memory-leak.png"></a></p>
<h4 id="but-why">But Why?</h4>
<p>A few things were different when reinstalling the system.</p>
<p>First, the system language was left as its default value: English.
This <em>should</em> be irrelevant, but when the system locazation affects
everything down to the output from commands, it might just happen that
different number format and/or translated messages may trigger bugs.</p>
<h3 id="not-gone-after-reinstalling"><strong>Not</strong> gone after reinstalling</h3>
<p>The (or <em>a</em>) memory leak is still there, even if only it grows slowly enough
that it takes about 3 days to reach the point where almost all 32 GB of RAM
are taken up by <code>SUnreclaim</code> and the biggest memory hoarder is, by far,
<code>kmalloc-rnd-11-8k</code>:</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-36-1"><a id="__codelineno-36-1" name="__codelineno-36-1" href="#__codelineno-36-1"></a><span class="gp"># </span>cat<span class="w"> </span>/proc/meminfo
</span><span id="__span-36-2"><a id="__codelineno-36-2" name="__codelineno-36-2" href="#__codelineno-36-2"></a><span class="go">...</span>
</span><span id="__span-36-3"><a id="__codelineno-36-3" name="__codelineno-36-3" href="#__codelineno-36-3"></a><span class="go">Slab:           31814260 kB</span>
</span><span id="__span-36-4"><a id="__codelineno-36-4" name="__codelineno-36-4" href="#__codelineno-36-4"></a><span class="go">SReclaimable:      50868 kB</span>
</span><span id="__span-36-5"><a id="__codelineno-36-5" name="__codelineno-36-5" href="#__codelineno-36-5"></a><span class="go">SUnreclaim:     31763392 kB</span>
</span><span id="__span-36-6"><a id="__codelineno-36-6" name="__codelineno-36-6" href="#__codelineno-36-6"></a><span class="go">...</span>
</span><span id="__span-36-7"><a id="__codelineno-36-7" name="__codelineno-36-7" href="#__codelineno-36-7"></a>
</span><span id="__span-36-8"><a id="__codelineno-36-8" name="__codelineno-36-8" href="#__codelineno-36-8"></a><span class="gp"># </span>slabtop<span class="w"> </span>-o<span class="w"> </span><span class="p">|</span><span class="w"> </span>head<span class="w"> </span>-10
</span><span id="__span-36-9"><a id="__codelineno-36-9" name="__codelineno-36-9" href="#__codelineno-36-9"></a><span class="go"> Active / Total Objects (% used)    : 4817156 / 5002245 (96.3%)</span>
</span><span id="__span-36-10"><a id="__codelineno-36-10" name="__codelineno-36-10" href="#__codelineno-36-10"></a><span class="go"> Active / Total Slabs (% used)      : 1032290 / 1032290 (100.0%)</span>
</span><span id="__span-36-11"><a id="__codelineno-36-11" name="__codelineno-36-11" href="#__codelineno-36-11"></a><span class="go"> Active / Total Caches (% used)     : 342 / 386 (88.6%)</span>
</span><span id="__span-36-12"><a id="__codelineno-36-12" name="__codelineno-36-12" href="#__codelineno-36-12"></a><span class="go"> Active / Total Size (% used)       : 31637718.69K / 31682510.83K (99.9%)</span>
</span><span id="__span-36-13"><a id="__codelineno-36-13" name="__codelineno-36-13" href="#__codelineno-36-13"></a><span class="go"> Minimum / Average / Maximum Object : 0.01K / 6.33K / 10.25K</span>
</span><span id="__span-36-14"><a id="__codelineno-36-14" name="__codelineno-36-14" href="#__codelineno-36-14"></a>
</span><span id="__span-36-15"><a id="__codelineno-36-15" name="__codelineno-36-15" href="#__codelineno-36-15"></a><span class="go">  OBJS ACTIVE  USE OBJ SIZE  SLABS OBJ/SLAB CACHE SIZE NAME                   </span>
</span><span id="__span-36-16"><a id="__codelineno-36-16" name="__codelineno-36-16" href="#__codelineno-36-16"></a><span class="go">3931151 3931151 100%    8.00K 1010822        4  32346304K kmalloc-rnd-11-8k      </span>
</span><span id="__span-36-17"><a id="__codelineno-36-17" name="__codelineno-36-17" href="#__codelineno-36-17"></a><span class="go"> 71145  36213  50%    0.05K    837       85      3348K shared_policy_node     </span>
</span><span id="__span-36-18"><a id="__codelineno-36-18" name="__codelineno-36-18" href="#__codelineno-36-18"></a><span class="go"> 67928  67790  99%    0.14K   2426       28      9704K kernfs_node_cache      </span>
</span><span id="__span-36-19"><a id="__codelineno-36-19" name="__codelineno-36-19" href="#__codelineno-36-19"></a>
</span><span id="__span-36-20"><a id="__codelineno-36-20" name="__codelineno-36-20" href="#__codelineno-36-20"></a><span class="gp"># </span>cat<span class="w"> </span>/proc/slabinfo<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span><span class="s2">"kmalloc-rnd-11-8k"</span>
</span><span id="__span-36-21"><a id="__codelineno-36-21" name="__codelineno-36-21" href="#__codelineno-36-21"></a><span class="go">kmalloc-rnd-11-8k 3931772 3931772   8192    4    8 : tunables    0    0    0 : slabdata 1011434 1011434      0</span>
</span><span id="__span-36-22"><a id="__codelineno-36-22" name="__codelineno-36-22" href="#__codelineno-36-22"></a>
</span><span id="__span-36-23"><a id="__codelineno-36-23" name="__codelineno-36-23" href="#__codelineno-36-23"></a><span class="gp"># </span>head<span class="w"> </span>-3<span class="w"> </span>/proc/slabinfo<span class="p">;</span><span class="w"> </span>cat<span class="w"> </span>/proc/slabinfo<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>kmalloc-rnd-11-8k
</span><span id="__span-36-24"><a id="__codelineno-36-24" name="__codelineno-36-24" href="#__codelineno-36-24"></a><span class="go">slabinfo - version: 2.1</span>
</span><span id="__span-36-25"><a id="__codelineno-36-25" name="__codelineno-36-25" href="#__codelineno-36-25"></a><span class="gp"># </span>name<span class="w">            </span>&lt;active_objs&gt;<span class="w"> </span>&lt;num_objs&gt;<span class="w"> </span>&lt;objsize&gt;<span class="w"> </span>&lt;objperslab&gt;<span class="w"> </span>&lt;pagesperslab&gt;<span class="w"> </span>:<span class="w"> </span>tunables<span class="w"> </span>&lt;limit&gt;<span class="w"> </span>&lt;batchcount&gt;<span class="w"> </span>&lt;sharedfactor&gt;<span class="w"> </span>:<span class="w"> </span>slabdata<span class="w"> </span>&lt;active_slabs&gt;<span class="w"> </span>&lt;num_slabs&gt;<span class="w"> </span>&lt;sharedavail&gt;
</span><span id="__span-36-26"><a id="__codelineno-36-26" name="__codelineno-36-26" href="#__codelineno-36-26"></a><span class="go">QIPCRTR               78     78    832   39    8 : tunables    0    0    0 : slabdata      2      2      0</span>
</span><span id="__span-36-27"><a id="__codelineno-36-27" name="__codelineno-36-27" href="#__codelineno-36-27"></a><span class="go">kmalloc-rnd-11-8k 3931887 3931887   8192    4    8 : tunables    0    0    0 : slabdata 1011528 1011528      0</span>
</span></code></pre></div>
<details class="terminal">
<summary>Repeat run or debug commands above shows about the same.</summary>
<div class="language-console highlight"><pre><span></span><code><span id="__span-37-1"><a id="__codelineno-37-1" name="__codelineno-37-1" href="#__codelineno-37-1"></a><span class="gp"># </span>free<span class="w"> </span>-h
</span><span id="__span-37-2"><a id="__codelineno-37-2" name="__codelineno-37-2" href="#__codelineno-37-2"></a><span class="go">              total        used        free      shared  buff/cache   available</span>
</span><span id="__span-37-3"><a id="__codelineno-37-3" name="__codelineno-37-3" href="#__codelineno-37-3"></a><span class="go">Mem:            30Gi        30Gi       291Mi        61Mi       152Mi        73Mi</span>
</span><span id="__span-37-4"><a id="__codelineno-37-4" name="__codelineno-37-4" href="#__codelineno-37-4"></a><span class="go">Swap:          8.0Gi       271Mi       7.7Gi</span>
</span><span id="__span-37-5"><a id="__codelineno-37-5" name="__codelineno-37-5" href="#__codelineno-37-5"></a>
</span><span id="__span-37-6"><a id="__codelineno-37-6" name="__codelineno-37-6" href="#__codelineno-37-6"></a><span class="gp"># </span>ps<span class="w"> </span>-ax<span class="w"> </span>-eo<span class="w"> </span>user,pid,pcpu:5,pmem:5,rss:8<span class="o">=</span>R-MEM,vsz:10<span class="o">=</span>V-MEM,tty:6<span class="o">=</span>TTY,stat:5,bsdstart:7,bsdtime:7,args<span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="o">(</span><span class="nb">read</span><span class="w"> </span>h<span class="p">;</span><span class="w"> </span><span class="nb">echo</span><span class="w"> </span><span class="s2">"</span><span class="nv">$h</span><span class="s2">"</span><span class="p">;</span><span class="w"> </span>sort<span class="w"> </span>-nr<span class="w"> </span>-k<span class="w"> </span><span class="m">4</span><span class="o">)</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>head<span class="w"> </span>-10<span class="w"> </span><span class="p">|</span><span class="w"> </span>less<span class="w"> </span>-SEX
</span><span id="__span-37-7"><a id="__codelineno-37-7" name="__codelineno-37-7" href="#__codelineno-37-7"></a><span class="go">USER         PID  %CPU  %MEM    R-MEM      V-MEM TTY    STAT    START    TIME COMMAND</span>
</span><span id="__span-37-8"><a id="__codelineno-37-8" name="__codelineno-37-8" href="#__codelineno-37-8"></a><span class="go">vnstat      2707   0.0   0.0     1536       5516 ?      Ss     Jan  5    0:17 /usr/sbin/vnstatd -n LANG=en_US.UTF-8 PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/snap/bin USER=vnstat LOGNAME=vnstat HOME=/var/lib/vnstat INVOCATION_ID=ac8c9f302e5444b691575435a6157b99 JOURNAL_STREAM=8:29855 STATE_DIRECTORY=/var/lib/vnstat SYSTEMD_EXEC_PID=2707 MEMORY_PRESSURE_WATCH=/sy&gt;</span>
</span><span id="__span-37-9"><a id="__codelineno-37-9" name="__codelineno-37-9" href="#__codelineno-37-9"></a><span class="go">systemd+    1201   0.0   0.0     1152      91044 ?      Ssl    Jan  5    0:01 /usr/lib/systemd/systemd-timesyncd LANG=en_US.UTF-8 PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/snap/bin NOTIFY_SOCKET=/run/systemd/notify WATCHDOG_PID=1201 WATCHDOG_USEC=180000000 USER=systemd-timesync LOGNAME=systemd-timesync INVOCATION_ID=9f337859e19249b2977af8bb586f2c94 JOURNAL_STREA&gt;</span>
</span><span id="__span-37-10"><a id="__codelineno-37-10" name="__codelineno-37-10" href="#__codelineno-37-10"></a><span class="go">systemd+    1196   0.0   0.0      384      22008 ?      Ss     Jan  5    0:48 /usr/lib/systemd/systemd-resolved LANG=en_US.UTF-8 PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/snap/bin NOTIFY_SOCKET=/run/systemd/notify WATCHDOG_PID=1196 WATCHDOG_USEC=180000000 USER=systemd-resolve LOGNAME=systemd-resolve INVOCATION_ID=5707dd899b2541a289e315ed6616d70c JOURNAL_STREAM=8&gt;</span>
</span><span id="__span-37-11"><a id="__codelineno-37-11" name="__codelineno-37-11" href="#__codelineno-37-11"></a><span class="go">syslog      1787   0.0   0.0      640     222508 ?      Ssl    Jan  5    0:02 /usr/sbin/rsyslogd -n -iNONE LANG=en_US.UTF-8 PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/snap/bin NOTIFY_SOCKET=/run/systemd/notify LISTEN_PID=1787 LISTEN_FDS=1 LISTEN_FDNAMES=syslog.socket USER=root INVOCATION_ID=94eeaa8f349e456fa5df905f17729693 JOURNAL_STREAM=8:29727 SYSTEMD_EXEC_PID=&gt;</span>
</span><span id="__span-37-12"><a id="__codelineno-37-12" name="__codelineno-37-12" href="#__codelineno-37-12"></a><span class="go">rtkit       3291   0.0   0.0     1024      22940 ?      SNsl   Jan  5    0:04 /usr/libexec/rtkit-daemon LANG=en_US.UTF-8 PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/snap/bin NOTIFY_SOCKET=/run/systemd/notify USER=root INVOCATION_ID=6e9a99b6e2ab44019c666b2ae4b886cc JOURNAL_STREAM=8:21269 SYSTEMD_EXEC_PID=3291 MEMORY_PRESSURE_WATCH=/sys/fs/cgroup/system.slice/rtkit-&gt;</span>
</span><span id="__span-37-13"><a id="__codelineno-37-13" name="__codelineno-37-13" href="#__codelineno-37-13"></a><span class="go">root          99   0.2   0.0        0          0 ?      S      Jan  5   11:40 [ksoftirqd/15]</span>
</span><span id="__span-37-14"><a id="__codelineno-37-14" name="__codelineno-37-14" href="#__codelineno-37-14"></a><span class="go">root         984   0.0   0.0        0          0 ?      I&lt;     Jan  5    0:00 [kworker/R-btrfs]</span>
</span><span id="__span-37-15"><a id="__codelineno-37-15" name="__codelineno-37-15" href="#__codelineno-37-15"></a><span class="go">root         983   0.0   0.0        0          0 ?      I&lt;     Jan  5    0:00 [kworker/R-btrfs]</span>
</span><span id="__span-37-16"><a id="__codelineno-37-16" name="__codelineno-37-16" href="#__codelineno-37-16"></a><span class="go">root         982   0.0   0.0        0          0 ?      I&lt;     Jan  5    0:00 [kworker/R-btrfs]</span>
</span><span id="__span-37-17"><a id="__codelineno-37-17" name="__codelineno-37-17" href="#__codelineno-37-17"></a>
</span><span id="__span-37-18"><a id="__codelineno-37-18" name="__codelineno-37-18" href="#__codelineno-37-18"></a><span class="gp"># </span><span class="nb">echo</span><span class="w"> </span><span class="m">3</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>tee<span class="w"> </span>/proc/sys/vm/drop_caches
</span><span id="__span-37-19"><a id="__codelineno-37-19" name="__codelineno-37-19" href="#__codelineno-37-19"></a><span class="go">3</span>
</span><span id="__span-37-20"><a id="__codelineno-37-20" name="__codelineno-37-20" href="#__codelineno-37-20"></a>
</span><span id="__span-37-21"><a id="__codelineno-37-21" name="__codelineno-37-21" href="#__codelineno-37-21"></a><span class="gp"># </span>free<span class="w"> </span>-h
</span><span id="__span-37-22"><a id="__codelineno-37-22" name="__codelineno-37-22" href="#__codelineno-37-22"></a><span class="go">              total        used        free      shared  buff/cache   available</span>
</span><span id="__span-37-23"><a id="__codelineno-37-23" name="__codelineno-37-23" href="#__codelineno-37-23"></a><span class="go">Mem:            30Gi        30Gi       245Mi        87Mi       187Mi        32Mi</span>
</span><span id="__span-37-24"><a id="__codelineno-37-24" name="__codelineno-37-24" href="#__codelineno-37-24"></a><span class="go">Swap:          8.0Gi       257Mi       7.7Gi</span>
</span><span id="__span-37-25"><a id="__codelineno-37-25" name="__codelineno-37-25" href="#__codelineno-37-25"></a>
</span><span id="__span-37-26"><a id="__codelineno-37-26" name="__codelineno-37-26" href="#__codelineno-37-26"></a><span class="gp"># </span>free<span class="w"> </span>-m
</span><span id="__span-37-27"><a id="__codelineno-37-27" name="__codelineno-37-27" href="#__codelineno-37-27"></a><span class="go">              total        used        free      shared  buff/cache   available</span>
</span><span id="__span-37-28"><a id="__codelineno-37-28" name="__codelineno-37-28" href="#__codelineno-37-28"></a><span class="go">Mem:           31645       31594         269          79         166          50</span>
</span><span id="__span-37-29"><a id="__codelineno-37-29" name="__codelineno-37-29" href="#__codelineno-37-29"></a><span class="go">Swap:           8191         265        7926</span>
</span><span id="__span-37-30"><a id="__codelineno-37-30" name="__codelineno-37-30" href="#__codelineno-37-30"></a>
</span><span id="__span-37-31"><a id="__codelineno-37-31" name="__codelineno-37-31" href="#__codelineno-37-31"></a><span class="gp"># </span>sync
</span><span id="__span-37-32"><a id="__codelineno-37-32" name="__codelineno-37-32" href="#__codelineno-37-32"></a>
</span><span id="__span-37-33"><a id="__codelineno-37-33" name="__codelineno-37-33" href="#__codelineno-37-33"></a><span class="gp"># </span>cat<span class="w"> </span>/proc/sys/vm/nr_hugepages
</span><span id="__span-37-34"><a id="__codelineno-37-34" name="__codelineno-37-34" href="#__codelineno-37-34"></a><span class="go">0</span>
</span><span id="__span-37-35"><a id="__codelineno-37-35" name="__codelineno-37-35" href="#__codelineno-37-35"></a>
</span><span id="__span-37-36"><a id="__codelineno-37-36" name="__codelineno-37-36" href="#__codelineno-37-36"></a><span class="gp"># </span>smem<span class="w"> </span>-twk
</span><span id="__span-37-37"><a id="__codelineno-37-37" name="__codelineno-37-37" href="#__codelineno-37-37"></a><span class="go">Area                           Used      Cache   Noncache </span>
</span><span id="__span-37-38"><a id="__codelineno-37-38" name="__codelineno-37-38" href="#__codelineno-37-38"></a><span class="go">firmware/hardware                 0          0          0 </span>
</span><span id="__span-37-39"><a id="__codelineno-37-39" name="__codelineno-37-39" href="#__codelineno-37-39"></a><span class="go">kernel image                      0          0          0 </span>
</span><span id="__span-37-40"><a id="__codelineno-37-40" name="__codelineno-37-40" href="#__codelineno-37-40"></a><span class="go">kernel dynamic memory         30.6G     155.9M      30.4G </span>
</span><span id="__span-37-41"><a id="__codelineno-37-41" name="__codelineno-37-41" href="#__codelineno-37-41"></a><span class="go">userspace memory              39.4M      19.6M      19.8M </span>
</span><span id="__span-37-42"><a id="__codelineno-37-42" name="__codelineno-37-42" href="#__codelineno-37-42"></a><span class="go">free memory                  278.6M     278.6M          0 </span>
</span><span id="__span-37-43"><a id="__codelineno-37-43" name="__codelineno-37-43" href="#__codelineno-37-43"></a><span class="go">----------------------------------------------------------</span>
</span><span id="__span-37-44"><a id="__codelineno-37-44" name="__codelineno-37-44" href="#__codelineno-37-44"></a><span class="go">                              30.9G     454.1M      30.5G </span>
</span><span id="__span-37-45"><a id="__codelineno-37-45" name="__codelineno-37-45" href="#__codelineno-37-45"></a>
</span><span id="__span-37-46"><a id="__codelineno-37-46" name="__codelineno-37-46" href="#__codelineno-37-46"></a><span class="gp"># </span>smem<span class="w"> </span>-wp
</span><span id="__span-37-47"><a id="__codelineno-37-47" name="__codelineno-37-47" href="#__codelineno-37-47"></a><span class="go">Area                           Used      Cache   Noncache </span>
</span><span id="__span-37-48"><a id="__codelineno-37-48" name="__codelineno-37-48" href="#__codelineno-37-48"></a><span class="go">firmware/hardware             0.00%      0.00%      0.00% </span>
</span><span id="__span-37-49"><a id="__codelineno-37-49" name="__codelineno-37-49" href="#__codelineno-37-49"></a><span class="go">kernel image                  0.00%      0.00%      0.00% </span>
</span><span id="__span-37-50"><a id="__codelineno-37-50" name="__codelineno-37-50" href="#__codelineno-37-50"></a><span class="go">kernel dynamic memory        99.00%      0.43%     98.57% </span>
</span><span id="__span-37-51"><a id="__codelineno-37-51" name="__codelineno-37-51" href="#__codelineno-37-51"></a><span class="go">userspace memory              0.13%      0.06%      0.07% </span>
</span><span id="__span-37-52"><a id="__codelineno-37-52" name="__codelineno-37-52" href="#__codelineno-37-52"></a><span class="go">free memory                   0.86%      0.86%      0.00% </span>
</span><span id="__span-37-53"><a id="__codelineno-37-53" name="__codelineno-37-53" href="#__codelineno-37-53"></a>
</span><span id="__span-37-54"><a id="__codelineno-37-54" name="__codelineno-37-54" href="#__codelineno-37-54"></a><span class="gp"># </span>lsmod<span class="w"> </span><span class="p">|</span><span class="w"> </span>sort<span class="w"> </span>-nr<span class="w"> </span>-k<span class="w"> </span><span class="m">2</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>head
</span><span id="__span-37-55"><a id="__codelineno-37-55" name="__codelineno-37-55" href="#__codelineno-37-55"></a><span class="go">i915                 4292608  27</span>
</span><span id="__span-37-56"><a id="__codelineno-37-56" name="__codelineno-37-56" href="#__codelineno-37-56"></a><span class="go">xe                   2715648  0</span>
</span><span id="__span-37-57"><a id="__codelineno-37-57" name="__codelineno-37-57" href="#__codelineno-37-57"></a><span class="go">btrfs                2019328  1</span>
</span><span id="__span-37-58"><a id="__codelineno-37-58" name="__codelineno-37-58" href="#__codelineno-37-58"></a><span class="go">mac80211             1720320  1 iwlmvm</span>
</span><span id="__span-37-59"><a id="__codelineno-37-59" name="__codelineno-37-59" href="#__codelineno-37-59"></a><span class="go">kvm                  1409024  1 kvm_intel</span>
</span><span id="__span-37-60"><a id="__codelineno-37-60" name="__codelineno-37-60" href="#__codelineno-37-60"></a><span class="go">cfg80211             1323008  3 iwlmvm,iwlwifi,mac80211</span>
</span><span id="__span-37-61"><a id="__codelineno-37-61" name="__codelineno-37-61" href="#__codelineno-37-61"></a><span class="go">bluetooth            1028096  34 btrtl,btmtk,btintel,btbcm,bnep,btusb,rfcomm</span>
</span><span id="__span-37-62"><a id="__codelineno-37-62" name="__codelineno-37-62" href="#__codelineno-37-62"></a><span class="go">iwlmvm                872448  0</span>
</span><span id="__span-37-63"><a id="__codelineno-37-63" name="__codelineno-37-63" href="#__codelineno-37-63"></a><span class="go">iwlwifi               598016  1 iwlmvm</span>
</span><span id="__span-37-64"><a id="__codelineno-37-64" name="__codelineno-37-64" href="#__codelineno-37-64"></a><span class="go">thunderbolt           516096  0</span>
</span><span id="__span-37-65"><a id="__codelineno-37-65" name="__codelineno-37-65" href="#__codelineno-37-65"></a>
</span><span id="__span-37-66"><a id="__codelineno-37-66" name="__codelineno-37-66" href="#__codelineno-37-66"></a><span class="gp"># </span>uname<span class="w"> </span>-a
</span><span id="__span-37-67"><a id="__codelineno-37-67" name="__codelineno-37-67" href="#__codelineno-37-67"></a><span class="go">Linux super-tuna 6.8.0-49-lowlatency #49.1-Ubuntu SMP PREEMPT_DYNAMIC Sun Nov 10 10:00:36 UTC 2024 x86_64 x86_64 x86_64 GNU/Linux</span>
</span><span id="__span-37-68"><a id="__codelineno-37-68" name="__codelineno-37-68" href="#__codelineno-37-68"></a>
</span><span id="__span-37-69"><a id="__codelineno-37-69" name="__codelineno-37-69" href="#__codelineno-37-69"></a><span class="gp"># </span>slabtop<span class="w"> </span>-o<span class="w"> </span><span class="p">|</span><span class="w"> </span>head<span class="w"> </span>-10
</span><span id="__span-37-70"><a id="__codelineno-37-70" name="__codelineno-37-70" href="#__codelineno-37-70"></a><span class="go">Active / Total Objects (% used)    : 4817156 / 5002245 (96.3%)</span>
</span><span id="__span-37-71"><a id="__codelineno-37-71" name="__codelineno-37-71" href="#__codelineno-37-71"></a><span class="go">Active / Total Slabs (% used)      : 1032290 / 1032290 (100.0%)</span>
</span><span id="__span-37-72"><a id="__codelineno-37-72" name="__codelineno-37-72" href="#__codelineno-37-72"></a><span class="go">Active / Total Caches (% used)     : 342 / 386 (88.6%)</span>
</span><span id="__span-37-73"><a id="__codelineno-37-73" name="__codelineno-37-73" href="#__codelineno-37-73"></a><span class="go">Active / Total Size (% used)       : 31637718.69K / 31682510.83K (99.9%)</span>
</span><span id="__span-37-74"><a id="__codelineno-37-74" name="__codelineno-37-74" href="#__codelineno-37-74"></a><span class="go">Minimum / Average / Maximum Object : 0.01K / 6.33K / 10.25K</span>
</span><span id="__span-37-75"><a id="__codelineno-37-75" name="__codelineno-37-75" href="#__codelineno-37-75"></a>
</span><span id="__span-37-76"><a id="__codelineno-37-76" name="__codelineno-37-76" href="#__codelineno-37-76"></a><span class="go">  OBJS ACTIVE  USE OBJ SIZE  SLABS OBJ/SLAB CACHE SIZE NAME                   </span>
</span><span id="__span-37-77"><a id="__codelineno-37-77" name="__codelineno-37-77" href="#__codelineno-37-77"></a><span class="go">3931151 3931151 100%    8.00K 1010822        4  32346304K kmalloc-rnd-11-8k      </span>
</span><span id="__span-37-78"><a id="__codelineno-37-78" name="__codelineno-37-78" href="#__codelineno-37-78"></a><span class="go">71145  36213  50%    0.05K    837       85      3348K shared_policy_node     </span>
</span><span id="__span-37-79"><a id="__codelineno-37-79" name="__codelineno-37-79" href="#__codelineno-37-79"></a><span class="go">67928  67790  99%    0.14K   2426       28      9704K kernfs_node_cache      </span>
</span><span id="__span-37-80"><a id="__codelineno-37-80" name="__codelineno-37-80" href="#__codelineno-37-80"></a>
</span><span id="__span-37-81"><a id="__codelineno-37-81" name="__codelineno-37-81" href="#__codelineno-37-81"></a><span class="gp"># </span>cat<span class="w"> </span>/proc/slabinfo<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span><span class="s2">"kmalloc-rnd-11-8k"</span>
</span><span id="__span-37-82"><a id="__codelineno-37-82" name="__codelineno-37-82" href="#__codelineno-37-82"></a><span class="go">kmalloc-rnd-11-8k 3931772 3931772   8192    4    8 : tunables    0    0    0 : slabdata 1011434 1011434      0</span>
</span><span id="__span-37-83"><a id="__codelineno-37-83" name="__codelineno-37-83" href="#__codelineno-37-83"></a>
</span><span id="__span-37-84"><a id="__codelineno-37-84" name="__codelineno-37-84" href="#__codelineno-37-84"></a><span class="gp"># </span>head<span class="w"> </span>-3<span class="w"> </span>/proc/slabinfo<span class="p">;</span><span class="w"> </span>cat<span class="w"> </span>/proc/slabinfo<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>kmalloc-rnd-11-8k
</span><span id="__span-37-85"><a id="__codelineno-37-85" name="__codelineno-37-85" href="#__codelineno-37-85"></a><span class="go">slabinfo - version: 2.1</span>
</span><span id="__span-37-86"><a id="__codelineno-37-86" name="__codelineno-37-86" href="#__codelineno-37-86"></a><span class="gp"># </span>name<span class="w">            </span>&lt;active_objs&gt;<span class="w"> </span>&lt;num_objs&gt;<span class="w"> </span>&lt;objsize&gt;<span class="w"> </span>&lt;objperslab&gt;<span class="w"> </span>&lt;pagesperslab&gt;<span class="w"> </span>:<span class="w"> </span>tunables<span class="w"> </span>&lt;limit&gt;<span class="w"> </span>&lt;batchcount&gt;<span class="w"> </span>&lt;sharedfactor&gt;<span class="w"> </span>:<span class="w"> </span>slabdata<span class="w"> </span>&lt;active_slabs&gt;<span class="w"> </span>&lt;num_slabs&gt;<span class="w"> </span>&lt;sharedavail&gt;
</span><span id="__span-37-87"><a id="__codelineno-37-87" name="__codelineno-37-87" href="#__codelineno-37-87"></a><span class="go">QIPCRTR               78     78    832   39    8 : tunables    0    0    0 : slabdata      2      2      0</span>
</span><span id="__span-37-88"><a id="__codelineno-37-88" name="__codelineno-37-88" href="#__codelineno-37-88"></a><span class="go">kmalloc-rnd-11-8k 3931887 3931887   8192    4    8 : tunables    0    0    0 : slabdata 1011528 1011528      0</span>
</span><span id="__span-37-89"><a id="__codelineno-37-89" name="__codelineno-37-89" href="#__codelineno-37-89"></a>
</span><span id="__span-37-90"><a id="__codelineno-37-90" name="__codelineno-37-90" href="#__codelineno-37-90"></a><span class="gp"># </span>cat<span class="w"> </span>/proc/meminfo
</span><span id="__span-37-91"><a id="__codelineno-37-91" name="__codelineno-37-91" href="#__codelineno-37-91"></a><span class="go">MemTotal:       32404500 kB</span>
</span><span id="__span-37-92"><a id="__codelineno-37-92" name="__codelineno-37-92" href="#__codelineno-37-92"></a><span class="go">MemFree:          283740 kB</span>
</span><span id="__span-37-93"><a id="__codelineno-37-93" name="__codelineno-37-93" href="#__codelineno-37-93"></a><span class="go">MemAvailable:      60448 kB</span>
</span><span id="__span-37-94"><a id="__codelineno-37-94" name="__codelineno-37-94" href="#__codelineno-37-94"></a><span class="go">Buffers:            2388 kB</span>
</span><span id="__span-37-95"><a id="__codelineno-37-95" name="__codelineno-37-95" href="#__codelineno-37-95"></a><span class="go">Cached:           102356 kB</span>
</span><span id="__span-37-96"><a id="__codelineno-37-96" name="__codelineno-37-96" href="#__codelineno-37-96"></a><span class="go">SwapCached:         9336 kB</span>
</span><span id="__span-37-97"><a id="__codelineno-37-97" name="__codelineno-37-97" href="#__codelineno-37-97"></a><span class="go">Active:            21592 kB</span>
</span><span id="__span-37-98"><a id="__codelineno-37-98" name="__codelineno-37-98" href="#__codelineno-37-98"></a><span class="go">Inactive:          33280 kB</span>
</span><span id="__span-37-99"><a id="__codelineno-37-99" name="__codelineno-37-99" href="#__codelineno-37-99"></a><span class="go">Active(anon):       7320 kB</span>
</span><span id="__span-37-100"><a id="__codelineno-37-100" name="__codelineno-37-100" href="#__codelineno-37-100"></a><span class="go">Inactive(anon):     6100 kB</span>
</span><span id="__span-37-101"><a id="__codelineno-37-101" name="__codelineno-37-101" href="#__codelineno-37-101"></a><span class="go">Active(file):      14272 kB</span>
</span><span id="__span-37-102"><a id="__codelineno-37-102" name="__codelineno-37-102" href="#__codelineno-37-102"></a><span class="go">Inactive(file):    27180 kB</span>
</span><span id="__span-37-103"><a id="__codelineno-37-103" name="__codelineno-37-103" href="#__codelineno-37-103"></a><span class="go">Unevictable:       62500 kB</span>
</span><span id="__span-37-104"><a id="__codelineno-37-104" name="__codelineno-37-104" href="#__codelineno-37-104"></a><span class="go">Mlocked:              16 kB</span>
</span><span id="__span-37-105"><a id="__codelineno-37-105" name="__codelineno-37-105" href="#__codelineno-37-105"></a><span class="go">SwapTotal:       8388604 kB</span>
</span><span id="__span-37-106"><a id="__codelineno-37-106" name="__codelineno-37-106" href="#__codelineno-37-106"></a><span class="go">SwapFree:        8105176 kB</span>
</span><span id="__span-37-107"><a id="__codelineno-37-107" name="__codelineno-37-107" href="#__codelineno-37-107"></a><span class="go">Zswap:                 0 kB</span>
</span><span id="__span-37-108"><a id="__codelineno-37-108" name="__codelineno-37-108" href="#__codelineno-37-108"></a><span class="go">Zswapped:              0 kB</span>
</span><span id="__span-37-109"><a id="__codelineno-37-109" name="__codelineno-37-109" href="#__codelineno-37-109"></a><span class="go">Dirty:               552 kB</span>
</span><span id="__span-37-110"><a id="__codelineno-37-110" name="__codelineno-37-110" href="#__codelineno-37-110"></a><span class="go">Writeback:             0 kB</span>
</span><span id="__span-37-111"><a id="__codelineno-37-111" name="__codelineno-37-111" href="#__codelineno-37-111"></a><span class="go">AnonPages:         10912 kB</span>
</span><span id="__span-37-112"><a id="__codelineno-37-112" name="__codelineno-37-112" href="#__codelineno-37-112"></a><span class="go">Mapped:            18372 kB</span>
</span><span id="__span-37-113"><a id="__codelineno-37-113" name="__codelineno-37-113" href="#__codelineno-37-113"></a><span class="go">Shmem:             63280 kB</span>
</span><span id="__span-37-114"><a id="__codelineno-37-114" name="__codelineno-37-114" href="#__codelineno-37-114"></a><span class="go">KReclaimable:      50868 kB</span>
</span><span id="__span-37-115"><a id="__codelineno-37-115" name="__codelineno-37-115" href="#__codelineno-37-115"></a><span class="go">Slab:           31814260 kB</span>
</span><span id="__span-37-116"><a id="__codelineno-37-116" name="__codelineno-37-116" href="#__codelineno-37-116"></a><span class="go">SReclaimable:      50868 kB</span>
</span><span id="__span-37-117"><a id="__codelineno-37-117" name="__codelineno-37-117" href="#__codelineno-37-117"></a><span class="go">SUnreclaim:     31763392 kB</span>
</span><span id="__span-37-118"><a id="__codelineno-37-118" name="__codelineno-37-118" href="#__codelineno-37-118"></a><span class="go">KernelStack:        9344 kB</span>
</span><span id="__span-37-119"><a id="__codelineno-37-119" name="__codelineno-37-119" href="#__codelineno-37-119"></a><span class="go">PageTables:        10260 kB</span>
</span><span id="__span-37-120"><a id="__codelineno-37-120" name="__codelineno-37-120" href="#__codelineno-37-120"></a><span class="go">SecPageTables:         0 kB</span>
</span><span id="__span-37-121"><a id="__codelineno-37-121" name="__codelineno-37-121" href="#__codelineno-37-121"></a><span class="go">NFS_Unstable:          0 kB</span>
</span><span id="__span-37-122"><a id="__codelineno-37-122" name="__codelineno-37-122" href="#__codelineno-37-122"></a><span class="go">Bounce:                0 kB</span>
</span><span id="__span-37-123"><a id="__codelineno-37-123" name="__codelineno-37-123" href="#__codelineno-37-123"></a><span class="go">WritebackTmp:          0 kB</span>
</span><span id="__span-37-124"><a id="__codelineno-37-124" name="__codelineno-37-124" href="#__codelineno-37-124"></a><span class="go">CommitLimit:    24590852 kB</span>
</span><span id="__span-37-125"><a id="__codelineno-37-125" name="__codelineno-37-125" href="#__codelineno-37-125"></a><span class="go">Committed_AS:    1989136 kB</span>
</span><span id="__span-37-126"><a id="__codelineno-37-126" name="__codelineno-37-126" href="#__codelineno-37-126"></a><span class="go">VmallocTotal:   34359738367 kB</span>
</span><span id="__span-37-127"><a id="__codelineno-37-127" name="__codelineno-37-127" href="#__codelineno-37-127"></a><span class="go">VmallocUsed:       50920 kB</span>
</span><span id="__span-37-128"><a id="__codelineno-37-128" name="__codelineno-37-128" href="#__codelineno-37-128"></a><span class="go">VmallocChunk:          0 kB</span>
</span><span id="__span-37-129"><a id="__codelineno-37-129" name="__codelineno-37-129" href="#__codelineno-37-129"></a><span class="go">Percpu:            21888 kB</span>
</span><span id="__span-37-130"><a id="__codelineno-37-130" name="__codelineno-37-130" href="#__codelineno-37-130"></a><span class="go">HardwareCorrupted:     0 kB</span>
</span><span id="__span-37-131"><a id="__codelineno-37-131" name="__codelineno-37-131" href="#__codelineno-37-131"></a><span class="go">AnonHugePages:         0 kB</span>
</span><span id="__span-37-132"><a id="__codelineno-37-132" name="__codelineno-37-132" href="#__codelineno-37-132"></a><span class="go">ShmemHugePages:     8192 kB</span>
</span><span id="__span-37-133"><a id="__codelineno-37-133" name="__codelineno-37-133" href="#__codelineno-37-133"></a><span class="go">ShmemPmdMapped:        0 kB</span>
</span><span id="__span-37-134"><a id="__codelineno-37-134" name="__codelineno-37-134" href="#__codelineno-37-134"></a><span class="go">FileHugePages:         0 kB</span>
</span><span id="__span-37-135"><a id="__codelineno-37-135" name="__codelineno-37-135" href="#__codelineno-37-135"></a><span class="go">FilePmdMapped:         0 kB</span>
</span><span id="__span-37-136"><a id="__codelineno-37-136" name="__codelineno-37-136" href="#__codelineno-37-136"></a><span class="go">Unaccepted:            0 kB</span>
</span><span id="__span-37-137"><a id="__codelineno-37-137" name="__codelineno-37-137" href="#__codelineno-37-137"></a><span class="go">HugePages_Total:       0</span>
</span><span id="__span-37-138"><a id="__codelineno-37-138" name="__codelineno-37-138" href="#__codelineno-37-138"></a><span class="go">HugePages_Free:        0</span>
</span><span id="__span-37-139"><a id="__codelineno-37-139" name="__codelineno-37-139" href="#__codelineno-37-139"></a><span class="go">HugePages_Rsvd:        0</span>
</span><span id="__span-37-140"><a id="__codelineno-37-140" name="__codelineno-37-140" href="#__codelineno-37-140"></a><span class="go">HugePages_Surp:        0</span>
</span><span id="__span-37-141"><a id="__codelineno-37-141" name="__codelineno-37-141" href="#__codelineno-37-141"></a><span class="go">Hugepagesize:       2048 kB</span>
</span><span id="__span-37-142"><a id="__codelineno-37-142" name="__codelineno-37-142" href="#__codelineno-37-142"></a><span class="go">Hugetlb:               0 kB</span>
</span><span id="__span-37-143"><a id="__codelineno-37-143" name="__codelineno-37-143" href="#__codelineno-37-143"></a><span class="go">DirectMap4k:      315792 kB</span>
</span><span id="__span-37-144"><a id="__codelineno-37-144" name="__codelineno-37-144" href="#__codelineno-37-144"></a><span class="go">DirectMap2M:     8658944 kB</span>
</span><span id="__span-37-145"><a id="__codelineno-37-145" name="__codelineno-37-145" href="#__codelineno-37-145"></a><span class="go">DirectMap1G:    25165824 kB</span>
</span></code></pre></div>
</details>
<details class="quote">
<summary><a href="https://blogs.oracle.com/linux/post/understanding-linux-kernel-memory-statistics">Understanding Linux Kernel Memory Statistics</a> explains these values:</summary>
<h4 id="byte-level-memory-vmalloc">Byte-level memory: VMalloc</h4>
<h5 id="slab-allocator">Slab allocator</h5>
<p>The kernel uses various data structures in different kernel components and
drivers. Some examples are <code>struct mm_struct</code> used for each process's address
space and <code>struct buffer_head</code> used in filesystem I/O.
The Slab allocator manages caches of commonly used objects kept in an
initialized state available to be used later. This saves time for allocating,
initialising, and freeing objects.</p>
<p>The following statistics offer insights into the Slab allocator’s impact.</p>
<ul>
<li><code>Slab</code> is the total memory used by all Slab caches.</li>
<li><code>SReclaimable is</code> the amount of the Slab that might be reclaimed 
    (such as cache objects like dentry).</li>
<li><code>SUnreclaim</code> is the opposite. When unreclaimable slab memory takes up a
    high percentage of the total memory, system performance may be affected.</li>
</ul>
<div class="language-text highlight"><pre><span></span><code><span id="__span-38-1"><a id="__codelineno-38-1" name="__codelineno-38-1" href="#__codelineno-38-1"></a>Slab:            1622084 kB
</span><span id="__span-38-2"><a id="__codelineno-38-2" name="__codelineno-38-2" href="#__codelineno-38-2"></a>SReclaimable:    1000692 kB
</span><span id="__span-38-3"><a id="__codelineno-38-3" name="__codelineno-38-3" href="#__codelineno-38-3"></a>SUnreclaim:       621392 kB
</span></code></pre></div>
<p>Slab memory can grow when a kernel component or a driver requests memory
but fails to release the memory properly, which is a typical memory leak
case. Delving deeper into the specifics of <code>/proc/slabinfo</code> is crucial
for identifying the particular slab object that has accumulated substantial
memory usage.</p>
<p>...</p>
<p>For byte-level memory, <code>kmalloc</code> and <code>vmalloc</code> are involved. <code>kmalloc</code>
allocates physically contiguous memory regions, while <code>vmalloc</code> handles
memory blocks that may not be available in contiguous memory regions.</p>
</details>
<h3 id="debug-memory-leak">Debug memory leak</h3>
<p>If applying the <code>i915</code> patch does not help, the next step would be to do a
<a href="https://elinux.org/Kernel_dynamic_memory_analysis">Kernel dynamic memory analysis</a>
to find out what is leaking memory.</p>
<p>This should be relatively easy since <code>/sys/kernel/debug/tracing/trace</code>
is already present, although it only contains the headers. To enable
tracing of memory events, add this to kernel parameters:</p>
<div class="language-ini highlight"><pre><span></span><code><span id="__span-39-1"><a id="__codelineno-39-1" name="__codelineno-39-1" href="#__codelineno-39-1"></a><span class="na">trace_event</span><span class="o">=</span><span class="s">kmem:kmalloc,kmem:kmem_cache_alloc,kmem:kfree,kmem:kmem_cache_free</span>
</span></code></pre></div>
<p>This can be done by adding <code>/etc/default/grub.d/trace.cfg</code> with</p>
<div class="language-ini highlight"><pre><span></span><code><span id="__span-40-1"><a id="__codelineno-40-1" name="__codelineno-40-1" href="#__codelineno-40-1"></a><span class="c1"># Enable tracing of memory events</span>
</span><span id="__span-40-2"><a id="__codelineno-40-2" name="__codelineno-40-2" href="#__codelineno-40-2"></a><span class="na">GRUB_CMDLINE_LINUX_DEFAULT</span><span class="o">=</span><span class="s">"$GRUB_CMDLINE_LINUX_DEFAULT trace_event=kmem:kmalloc,kmem:kmem_cache_alloc,kmem:kfree,kmem:kmem_cache_free"</span>
</span></code></pre></div>
<p>After 2 days running with this, there are 745,033 lines in
<code>/sys/kernel/debug/tracing/trace</code> but it is not entirely clear what callsites
they point to:</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-41-1"><a id="__codelineno-41-1" name="__codelineno-41-1" href="#__codelineno-41-1"></a><span class="gp"># </span>grep<span class="w"> </span>alloc<span class="w"> </span>kmem.log<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>--color<span class="o">=</span>no<span class="w"> </span>-o<span class="w"> </span><span class="s1">'call_site=[a-zA-Z_0-9]*'</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>sed<span class="w"> </span><span class="s1">'s/call_site=//'</span><span class="w"> </span>&gt;<span class="w"> </span>kmem.txt
</span><span id="__span-41-2"><a id="__codelineno-41-2" name="__codelineno-41-2" href="#__codelineno-41-2"></a><span class="gp"># </span>sort<span class="w"> </span>kmem.txt<span class="w"> </span><span class="p">|</span><span class="w"> </span>uniq<span class="w"> </span>-c<span class="w"> </span><span class="p">|</span><span class="w"> </span>sort<span class="w"> </span>-nr<span class="w"> </span><span class="p">|</span><span class="w"> </span>head
</span><span id="__span-41-3"><a id="__codelineno-41-3" name="__codelineno-41-3" href="#__codelineno-41-3"></a><span class="go"> 138686 vm_area_dup</span>
</span><span id="__span-41-4"><a id="__codelineno-41-4" name="__codelineno-41-4" href="#__codelineno-41-4"></a><span class="go">  92207 anon_vma_clone</span>
</span><span id="__span-41-5"><a id="__codelineno-41-5" name="__codelineno-41-5" href="#__codelineno-41-5"></a><span class="go">  77047 getname_flags</span>
</span><span id="__span-41-6"><a id="__codelineno-41-6" name="__codelineno-41-6" href="#__codelineno-41-6"></a><span class="go">  75840 alloc_buffer_head</span>
</span><span id="__span-41-7"><a id="__codelineno-41-7" name="__codelineno-41-7" href="#__codelineno-41-7"></a><span class="go">  64657 vm_area_alloc</span>
</span><span id="__span-41-8"><a id="__codelineno-41-8" name="__codelineno-41-8" href="#__codelineno-41-8"></a><span class="go">  58102 mas_alloc_nodes</span>
</span><span id="__span-41-9"><a id="__codelineno-41-9" name="__codelineno-41-9" href="#__codelineno-41-9"></a><span class="go">  49660 __alloc_skb</span>
</span><span id="__span-41-10"><a id="__codelineno-41-10" name="__codelineno-41-10" href="#__codelineno-41-10"></a><span class="go">  44111 security_file_alloc</span>
</span><span id="__span-41-11"><a id="__codelineno-41-11" name="__codelineno-41-11" href="#__codelineno-41-11"></a><span class="go">  44111 alloc_empty_file</span>
</span><span id="__span-41-12"><a id="__codelineno-41-12" name="__codelineno-41-12" href="#__codelineno-41-12"></a><span class="go">  42981 anon_vma_fork</span>
</span><span id="__span-41-13"><a id="__codelineno-41-13" name="__codelineno-41-13" href="#__codelineno-41-13"></a><span class="go">  26055 __anon_vma_prepare</span>
</span><span id="__span-41-14"><a id="__codelineno-41-14" name="__codelineno-41-14" href="#__codelineno-41-14"></a><span class="go">  19385 i915_gem_do_execbuffer</span>
</span><span id="__span-41-15"><a id="__codelineno-41-15" name="__codelineno-41-15" href="#__codelineno-41-15"></a><span class="go">  10631 kvmalloc_node</span>
</span><span id="__span-41-16"><a id="__codelineno-41-16" name="__codelineno-41-16" href="#__codelineno-41-16"></a><span class="go">   9379 seq_open</span>
</span><span id="__span-41-17"><a id="__codelineno-41-17" name="__codelineno-41-17" href="#__codelineno-41-17"></a><span class="go">   8660 single_open</span>
</span><span id="__span-41-18"><a id="__codelineno-41-18" name="__codelineno-41-18" href="#__codelineno-41-18"></a><span class="go">   7014 drm_syncobj_array_wait_timeout</span>
</span><span id="__span-41-19"><a id="__codelineno-41-19" name="__codelineno-41-19" href="#__codelineno-41-19"></a><span class="go">   7014 drm_syncobj_array_find</span>
</span><span id="__span-41-20"><a id="__codelineno-41-20" name="__codelineno-41-20" href="#__codelineno-41-20"></a><span class="go">   6537 jbd2__journal_start</span>
</span><span id="__span-41-21"><a id="__codelineno-41-21" name="__codelineno-41-21" href="#__codelineno-41-21"></a><span class="go">   3071 __d_alloc</span>
</span><span id="__span-41-22"><a id="__codelineno-41-22" name="__codelineno-41-22" href="#__codelineno-41-22"></a><span class="go">   2765 prepare_creds</span>
</span><span id="__span-41-23"><a id="__codelineno-41-23" name="__codelineno-41-23" href="#__codelineno-41-23"></a><span class="go">   2763 security_prepare_creds</span>
</span><span id="__span-41-24"><a id="__codelineno-41-24" name="__codelineno-41-24" href="#__codelineno-41-24"></a><span class="go">   2648 security_inode_alloc</span>
</span><span id="__span-41-25"><a id="__codelineno-41-25" name="__codelineno-41-25" href="#__codelineno-41-25"></a><span class="go">   2527 kmalloc_reserve</span>
</span><span id="__span-41-26"><a id="__codelineno-41-26" name="__codelineno-41-26" href="#__codelineno-41-26"></a><span class="go">   2518 load_elf_binary</span>
</span><span id="__span-41-27"><a id="__codelineno-41-27" name="__codelineno-41-27" href="#__codelineno-41-27"></a><span class="go">   2517 load_elf_phdrs</span>
</span><span id="__span-41-28"><a id="__codelineno-41-28" name="__codelineno-41-28" href="#__codelineno-41-28"></a><span class="go">   2430 alloc_pipe_info</span>
</span><span id="__span-41-29"><a id="__codelineno-41-29" name="__codelineno-41-29" href="#__codelineno-41-29"></a><span class="go">   2361 krealloc</span>
</span><span id="__span-41-30"><a id="__codelineno-41-30" name="__codelineno-41-30" href="#__codelineno-41-30"></a><span class="go">   2102 alloc_extent_state</span>
</span><span id="__span-41-31"><a id="__codelineno-41-31" name="__codelineno-41-31" href="#__codelineno-41-31"></a><span class="go">   1883 genl_family_rcv_msg_attrs_parse</span>
</span><span id="__span-41-32"><a id="__codelineno-41-32" name="__codelineno-41-32" href="#__codelineno-41-32"></a><span class="go">   1804 memcg_alloc_slab_cgroups</span>
</span><span id="__span-41-33"><a id="__codelineno-41-33" name="__codelineno-41-33" href="#__codelineno-41-33"></a><span class="go">   1512 dup_task_struct</span>
</span><span id="__span-41-34"><a id="__codelineno-41-34" name="__codelineno-41-34" href="#__codelineno-41-34"></a><span class="go">   1509 security_task_alloc</span>
</span><span id="__span-41-35"><a id="__codelineno-41-35" name="__codelineno-41-35" href="#__codelineno-41-35"></a><span class="go">   1509 audit_alloc</span>
</span><span id="__span-41-36"><a id="__codelineno-41-36" name="__codelineno-41-36" href="#__codelineno-41-36"></a><span class="go">   1507 mas_dup_build</span>
</span><span id="__span-41-37"><a id="__codelineno-41-37" name="__codelineno-41-37" href="#__codelineno-41-37"></a><span class="go">   1507 dup_mm</span>
</span><span id="__span-41-38"><a id="__codelineno-41-38" name="__codelineno-41-38" href="#__codelineno-41-38"></a><span class="go">   1507 copy_signal</span>
</span><span id="__span-41-39"><a id="__codelineno-41-39" name="__codelineno-41-39" href="#__codelineno-41-39"></a><span class="go">   1507 copy_sighand</span>
</span><span id="__span-41-40"><a id="__codelineno-41-40" name="__codelineno-41-40" href="#__codelineno-41-40"></a><span class="go">   1506 dup_fd</span>
</span><span id="__span-41-41"><a id="__codelineno-41-41" name="__codelineno-41-41" href="#__codelineno-41-41"></a><span class="go">   1506 copy_fs_struct</span>
</span><span id="__span-41-42"><a id="__codelineno-41-42" name="__codelineno-41-42" href="#__codelineno-41-42"></a><span class="go">   1494 alloc_pid</span>
</span><span id="__span-41-43"><a id="__codelineno-41-43" name="__codelineno-41-43" href="#__codelineno-41-43"></a><span class="go">   1400 alloc_vmap_area</span>
</span><span id="__span-41-44"><a id="__codelineno-41-44" name="__codelineno-41-44" href="#__codelineno-41-44"></a><span class="go">   1350 proc_alloc_inode</span>
</span><span id="__span-41-45"><a id="__codelineno-41-45" name="__codelineno-41-45" href="#__codelineno-41-45"></a><span class="go">   1302 getname_kernel</span>
</span><span id="__span-41-46"><a id="__codelineno-41-46" name="__codelineno-41-46" href="#__codelineno-41-46"></a><span class="go">   1264 xas_alloc</span>
</span><span id="__span-41-47"><a id="__codelineno-41-47" name="__codelineno-41-47" href="#__codelineno-41-47"></a><span class="go">   1253 mm_alloc</span>
</span><span id="__span-41-48"><a id="__codelineno-41-48" name="__codelineno-41-48" href="#__codelineno-41-48"></a><span class="go">   1253 alloc_bprm</span>
</span><span id="__span-41-49"><a id="__codelineno-41-49" name="__codelineno-41-49" href="#__codelineno-41-49"></a><span class="go">   1215 alloc_inode</span>
</span><span id="__span-41-50"><a id="__codelineno-41-50" name="__codelineno-41-50" href="#__codelineno-41-50"></a><span class="go">   1173 __i915_request_create</span>
</span><span id="__span-41-51"><a id="__codelineno-41-51" name="__codelineno-41-51" href="#__codelineno-41-51"></a><span class="go">   1171 drm_syncobj_create</span>
</span><span id="__span-41-52"><a id="__codelineno-41-52" name="__codelineno-41-52" href="#__codelineno-41-52"></a><span class="go">   1171 add_fence_array</span>
</span><span id="__span-41-53"><a id="__codelineno-41-53" name="__codelineno-41-53" href="#__codelineno-41-53"></a><span class="go">    865 sg_kmalloc</span>
</span><span id="__span-41-54"><a id="__codelineno-41-54" name="__codelineno-41-54" href="#__codelineno-41-54"></a><span class="go">    831 mempool_alloc_slab</span>
</span><span id="__span-41-55"><a id="__codelineno-41-55" name="__codelineno-41-55" href="#__codelineno-41-55"></a><span class="go">    804 i915_vma_resource_alloc</span>
</span><span id="__span-41-56"><a id="__codelineno-41-56" name="__codelineno-41-56" href="#__codelineno-41-56"></a><span class="go">    798 drm_atomic_state_init</span>
</span><span id="__span-41-57"><a id="__codelineno-41-57" name="__codelineno-41-57" href="#__codelineno-41-57"></a><span class="go">    797 vma_create</span>
</span></code></pre></div>
<p>It seems one would really need to
<a href="https://elinux.org/Kernel_dynamic_memory_analysis#Obtaining_accurate_call_sites_.28or_The_painstaking_task_of_wrestling_against_gcc.29">wrestle against gcc</a>
to obtain accurate callsites. Moreover, the script to analyze this file
(<a href="https://github.com/ezequielgarcia/kmem-probe-framework/blob/master/post-process/trace_analyze.py"><code>trace_analyze.py</code></a>)
is from 2012 and writen in Python 2.</p>
<p>Alternative methods:</p>
<ul>
<li><a href="https://www.kernel.org/doc/html/v4.10/dev-tools/kmemleak.html">Kernel Memory Leak Detector</a> would require enabling <code>CONFIG_DEBUG_KMEMLEAK</code>
    when compling a new kernel, because <code>/sys/kernel/debug/kmemleakls</code>
    is not present.</li>
<li><a href="https://github.com/euspectre/kedr/wiki">euspectre/kedr</a> seems more
    involved, based on its
    <a href="https://github.com/euspectre/kedr/wiki/kedr_manual_getting_started">step-by-step tutorial</a>.</li>
</ul>
<h3 id="disable-swap">Disable swap</h3>
<p>Swap was disabled by commenting out the corresponding line in <code>/etc/fstab</code>.</p>
<p>The memory leak was detected when the Chrome browser started crashing
consistently despite running only one tab on one web application, and
eventually even SSH sessions where crashing and at that point it seems
the availability of swap lead the system to go into thrashing, because
at that point essentially all the RAM was taken up and Chrome could no
longer allocate enough memory:</p>
<p><a class="glightbox" data-type="image" data-width="auto" data-height="auto" href="../../../../media/2024-11-15-ubuntu-studio-24-04-on-super-tuna-nuc-pc/super-tuna-ram-full-after-chrome-crash.png" data-desc-position="bottom"><img alt="Heavy I/O suggests thrashing happened for several minutes" src="../../../../media/2024-11-15-ubuntu-studio-24-04-on-super-tuna-nuc-pc/super-tuna-ram-full-after-chrome-crash.png"></a></p>
<p>In the 82 hours the system had been running until it was no longer stable,
the memory leak had squeezed Chrome (and eventually everything else) out of
all available memory:</p>
<p><a class="glightbox" data-type="image" data-width="auto" data-height="auto" href="../../../../media/2024-11-15-ubuntu-studio-24-04-on-super-tuna-nuc-pc/super-tuna-user-ram-full-after-82-hours.png" data-desc-position="bottom"><img alt="Per-application memory usage shows chrome losing ability to allocate memory after 82 hours" src="../../../../media/2024-11-15-ubuntu-studio-24-04-on-super-tuna-nuc-pc/super-tuna-user-ram-full-after-82-hours.png"></a>
<a class="glightbox" data-type="image" data-width="auto" data-height="auto" href="../../../../media/2024-11-15-ubuntu-studio-24-04-on-super-tuna-nuc-pc/super-tuna-ram-full-after-82-hours.png" data-desc-position="bottom"><img alt="System-wide memory usage shows all memory used and nothing available after 82 hours" src="../../../../media/2024-11-15-ubuntu-studio-24-04-on-super-tuna-nuc-pc/super-tuna-ram-full-after-82-hours.png"></a></p>
<p>This could have been detected earlier, since the <em>used</em> RAM had already
grown to 14 GB in the first 24 hours:</p>
<p><a class="glightbox" data-type="image" data-width="auto" data-height="auto" href="../../../../media/2024-11-15-ubuntu-studio-24-04-on-super-tuna-nuc-pc/super-tuna-ram-up-14G-after-24-hours.png" data-desc-position="bottom"><img alt="System-wide memory usage up to 14 GB in the first 24 hours" src="../../../../media/2024-11-15-ubuntu-studio-24-04-on-super-tuna-nuc-pc/super-tuna-ram-up-14G-after-24-hours.png"></a></p>
<p>Such a memory leak did not afect
<a href="../../../12/27/ubuntu-studio-2404-on-raven-gaming-pc-and-more/">Raven</a>
even afte 7 days running the same Ubuntu Studio 24.04, installed from the
same USB media following the same process, running the same desktop and
even more applications; but that PC has an NVidia card, like most others.</p>
<p><a class="glightbox" data-type="image" data-width="auto" data-height="auto" href="../../../../media/2024-11-15-ubuntu-studio-24-04-on-super-tuna-nuc-pc/raven-ram-full-after-96-hours.png" data-desc-position="bottom"><img alt="System-wide memory usage stays at healthy levels after several days" src="../../../../media/2024-11-15-ubuntu-studio-24-04-on-super-tuna-nuc-pc/raven-ram-full-after-96-hours.png"></a></p>
<h2 id="remove-cups">Remove CUPS</h2>
<p>On several occassions <code>cupsd</code> had suddently gone up to 200% CPU usage
and stayed up there for 30+ minutes with no sign of and end to come.</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-42-1"><a id="__codelineno-42-1" name="__codelineno-42-1" href="#__codelineno-42-1"></a><span class="go">root        5512  0.0  0.0   2892  1664 ?        Ss   Nov16   0:00 /bin/sh /snap/cups/1067/scripts/run-cupsd</span>
</span><span id="__span-42-2"><a id="__codelineno-42-2" name="__codelineno-42-2" href="#__codelineno-42-2"></a><span class="go">root        9582  0.0  0.0  63780 12032 ?        S    Nov16   0:00 cupsd -f -s /var/snap/cups/common/etc/cups/cups-files.conf -c /var/snap/cups/common/etc/cups/cupsd.conf</span>
</span><span id="__span-42-3"><a id="__codelineno-42-3" name="__codelineno-42-3" href="#__codelineno-42-3"></a><span class="go">root     3659053  0.0  0.0   7160  2048 pts/2    S+   00:29   0:00 grep --color=auto cupsd</span>
</span><span id="__span-42-4"><a id="__codelineno-42-4" name="__codelineno-42-4" href="#__codelineno-42-4"></a><span class="go">root     3689314  194  0.0 184064 12416 ?        Rsl  00:00  56:44 /usr/sbin/cupsd -l</span>
</span></code></pre></div>
<p>This PC won't have any printers connected to it, so CUPS can be removed:</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-43-1"><a id="__codelineno-43-1" name="__codelineno-43-1" href="#__codelineno-43-1"></a><span class="gp"># </span>snap<span class="w"> </span>services
</span><span id="__span-43-2"><a id="__codelineno-43-2" name="__codelineno-43-2" href="#__codelineno-43-2"></a><span class="go">Service                                              Startup   Current   Notes</span>
</span><span id="__span-43-3"><a id="__codelineno-43-3" name="__codelineno-43-3" href="#__codelineno-43-3"></a><span class="go">canonical-livepatch.canonical-livepatchd             enabled   active    -</span>
</span><span id="__span-43-4"><a id="__codelineno-43-4" name="__codelineno-43-4" href="#__codelineno-43-4"></a><span class="go">chromium.daemon                                      disabled  inactive  -</span>
</span><span id="__span-43-5"><a id="__codelineno-43-5" name="__codelineno-43-5" href="#__codelineno-43-5"></a><span class="go">cups.cups-browsed                                    enabled   active    -</span>
</span><span id="__span-43-6"><a id="__codelineno-43-6" name="__codelineno-43-6" href="#__codelineno-43-6"></a><span class="go">cups.cupsd                                           enabled   active    -</span>
</span><span id="__span-43-7"><a id="__codelineno-43-7" name="__codelineno-43-7" href="#__codelineno-43-7"></a><span class="go">firmware-updater.firmware-notifier                   enabled   -         user,timer-activated</span>
</span><span id="__span-43-8"><a id="__codelineno-43-8" name="__codelineno-43-8" href="#__codelineno-43-8"></a><span class="go">firmware-updater.firmware-updater-app                enabled   -         user,dbus-activated</span>
</span><span id="__span-43-9"><a id="__codelineno-43-9" name="__codelineno-43-9" href="#__codelineno-43-9"></a><span class="go">snapd-desktop-integration.snapd-desktop-integration  enabled   -         user</span>
</span><span id="__span-43-10"><a id="__codelineno-43-10" name="__codelineno-43-10" href="#__codelineno-43-10"></a>
</span><span id="__span-43-11"><a id="__codelineno-43-11" name="__codelineno-43-11" href="#__codelineno-43-11"></a><span class="gp"># </span>snap<span class="w"> </span>stop<span class="w"> </span>cups
</span><span id="__span-43-12"><a id="__codelineno-43-12" name="__codelineno-43-12" href="#__codelineno-43-12"></a><span class="go">Stopped.</span>
</span><span id="__span-43-13"><a id="__codelineno-43-13" name="__codelineno-43-13" href="#__codelineno-43-13"></a>
</span><span id="__span-43-14"><a id="__codelineno-43-14" name="__codelineno-43-14" href="#__codelineno-43-14"></a><span class="gp"># </span>snap<span class="w"> </span>disable<span class="w"> </span>cups
</span><span id="__span-43-15"><a id="__codelineno-43-15" name="__codelineno-43-15" href="#__codelineno-43-15"></a><span class="go">cups disabled</span>
</span><span id="__span-43-16"><a id="__codelineno-43-16" name="__codelineno-43-16" href="#__codelineno-43-16"></a>
</span><span id="__span-43-17"><a id="__codelineno-43-17" name="__codelineno-43-17" href="#__codelineno-43-17"></a><span class="gp"># </span>ps<span class="w"> </span>aux<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>cupsd
</span><span id="__span-43-18"><a id="__codelineno-43-18" name="__codelineno-43-18" href="#__codelineno-43-18"></a><span class="go">root     1865839  0.0  0.0  39304 12544 ?        Ss   00:00   0:00 /usr/sbin/cupsd -l</span>
</span><span id="__span-43-19"><a id="__codelineno-43-19" name="__codelineno-43-19" href="#__codelineno-43-19"></a><span class="go">root     2208813  0.0  0.0   9144  1920 pts/1    S+   00:24   0:00 grep --color=auto cupsd</span>
</span><span id="__span-43-20"><a id="__codelineno-43-20" name="__codelineno-43-20" href="#__codelineno-43-20"></a>
</span><span id="__span-43-21"><a id="__codelineno-43-21" name="__codelineno-43-21" href="#__codelineno-43-21"></a><span class="gp"># </span>tail<span class="w"> </span>-f<span class="w"> </span>/var/log/cups/*log<span class="w">  </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>-v<span class="w"> </span>pam_unix
</span><span id="__span-43-22"><a id="__codelineno-43-22" name="__codelineno-43-22" href="#__codelineno-43-22"></a><span class="go">==&gt; /var/log/cups/access_log &lt;==</span>
</span><span id="__span-43-23"><a id="__codelineno-43-23" name="__codelineno-43-23" href="#__codelineno-43-23"></a><span class="go">localhost - - [09/Jan/2025:00:00:00 +0100] "POST / HTTP/1.1" 200 357 Create-Printer-Subscriptions successful-ok</span>
</span><span id="__span-43-24"><a id="__codelineno-43-24" name="__codelineno-43-24" href="#__codelineno-43-24"></a><span class="go">localhost - - [09/Jan/2025:00:00:00 +0100] "POST / HTTP/1.1" 200 176 Create-Printer-Subscriptions successful-ok</span>
</span><span id="__span-43-25"><a id="__codelineno-43-25" name="__codelineno-43-25" href="#__codelineno-43-25"></a><span class="go">localhost - - [09/Jan/2025:00:00:05 +0100] "POST /admin/ HTTP/1.1" 401 0 - -</span>
</span><span id="__span-43-26"><a id="__codelineno-43-26" name="__codelineno-43-26" href="#__codelineno-43-26"></a><span class="go">localhost - cups-browsed [09/Jan/2025:00:00:05 +0100] "POST /admin/ HTTP/1.1" 200 181 CUPS-Delete-Printer client-error-not-found</span>
</span><span id="__span-43-27"><a id="__codelineno-43-27" name="__codelineno-43-27" href="#__codelineno-43-27"></a><span class="go">localhost - - [09/Jan/2025:00:23:29 +0100] "POST / HTTP/1.1" 401 120 Cancel-Subscription successful-ok</span>
</span><span id="__span-43-28"><a id="__codelineno-43-28" name="__codelineno-43-28" href="#__codelineno-43-28"></a><span class="go">localhost - root [09/Jan/2025:00:23:29 +0100] "POST / HTTP/1.1" 200 120 Cancel-Subscription successful-ok</span>
</span><span id="__span-43-29"><a id="__codelineno-43-29" name="__codelineno-43-29" href="#__codelineno-43-29"></a>
</span><span id="__span-43-30"><a id="__codelineno-43-30" name="__codelineno-43-30" href="#__codelineno-43-30"></a><span class="go">==&gt; /var/log/cups/error_log &lt;==</span>
</span><span id="__span-43-31"><a id="__codelineno-43-31" name="__codelineno-43-31" href="#__codelineno-43-31"></a>
</span><span id="__span-43-32"><a id="__codelineno-43-32" name="__codelineno-43-32" href="#__codelineno-43-32"></a><span class="gp"># </span>snap<span class="w"> </span>services
</span><span id="__span-43-33"><a id="__codelineno-43-33" name="__codelineno-43-33" href="#__codelineno-43-33"></a><span class="go">Service                                              Startup   Current   Notes</span>
</span><span id="__span-43-34"><a id="__codelineno-43-34" name="__codelineno-43-34" href="#__codelineno-43-34"></a><span class="go">canonical-livepatch.canonical-livepatchd             enabled   active    -</span>
</span><span id="__span-43-35"><a id="__codelineno-43-35" name="__codelineno-43-35" href="#__codelineno-43-35"></a><span class="go">chromium.daemon                                      disabled  inactive  -</span>
</span><span id="__span-43-36"><a id="__codelineno-43-36" name="__codelineno-43-36" href="#__codelineno-43-36"></a><span class="go">cups.cups-browsed                                    disabled  inactive  -</span>
</span><span id="__span-43-37"><a id="__codelineno-43-37" name="__codelineno-43-37" href="#__codelineno-43-37"></a><span class="go">cups.cupsd                                           disabled  inactive  -</span>
</span><span id="__span-43-38"><a id="__codelineno-43-38" name="__codelineno-43-38" href="#__codelineno-43-38"></a><span class="go">firmware-updater.firmware-notifier                   enabled   -         user,timer-activated</span>
</span><span id="__span-43-39"><a id="__codelineno-43-39" name="__codelineno-43-39" href="#__codelineno-43-39"></a><span class="go">firmware-updater.firmware-updater-app                enabled   -         user,dbus-activated</span>
</span><span id="__span-43-40"><a id="__codelineno-43-40" name="__codelineno-43-40" href="#__codelineno-43-40"></a><span class="go">snapd-desktop-integration.snapd-desktop-integration  enabled   -         user</span>
</span><span id="__span-43-41"><a id="__codelineno-43-41" name="__codelineno-43-41" href="#__codelineno-43-41"></a>
</span><span id="__span-43-42"><a id="__codelineno-43-42" name="__codelineno-43-42" href="#__codelineno-43-42"></a><span class="gp"># </span>systemctl<span class="w"> </span>stop<span class="w"> </span>cups.service
</span><span id="__span-43-43"><a id="__codelineno-43-43" name="__codelineno-43-43" href="#__codelineno-43-43"></a>
</span><span id="__span-43-44"><a id="__codelineno-43-44" name="__codelineno-43-44" href="#__codelineno-43-44"></a><span class="gp"># </span>ps<span class="w"> </span>aux<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>cupsd
</span><span id="__span-43-45"><a id="__codelineno-43-45" name="__codelineno-43-45" href="#__codelineno-43-45"></a><span class="go">root     2271225  0.0  0.0   9144  2176 pts/1    S+   00:29   0:00 grep --color=auto cupsd</span>
</span></code></pre></div>
<p>This issue repeated after reinstalling, lasting for up to 90 minutes:</p>
<p><a class="glightbox" data-type="image" data-width="auto" data-height="auto" href="../../../../media/2024-11-15-ubuntu-studio-24-04-on-super-tuna-nuc-pc/super-tuna-cupsd-cpu-200.png" data-desc-position="bottom"><img alt="cupsd stays at 200% CPU for 90 minutes" src="../../../../media/2024-11-15-ubuntu-studio-24-04-on-super-tuna-nuc-pc/super-tuna-cupsd-cpu-200.png"></a></p>
<h2 id="december-2025-follow-up">December 2025 Follow-up</h2>
<p>Over time not only needs the system a daily reboot to flush the memory leak, but also the
whole system feels laggy and sluggish and specially playing videos on YouTube and
switching to/from full-screen. There are two main routes to try: the newer <code>xe</code> driver,
or if that leads to worse problems, updating BIOS and kernel to much newer versions.</p>
<h3 id="tweak-google-chrome">Tweak Google Chrome</h3>
<p>The following adjustments to Google Chrome are recommended independently of which driver
is used (<code>i915</code> or <code>xe</code>).</p>
<h4 id="disable-gpu-override">Disable GPU override</h4>
<p>Google Chrome tends to avoid GPUs that are not deemed stable or mature enough, even though
oftentime they actually are quite good enough. To disable this behavior:</p>
<ul>
<li>Check <code>chrome://gpu</code> and see if <strong>Canvas</strong> is reported as
    <em>Software only, hardware acceleration unavailable</em>, which usually means Chrome has
    blocklisted the GPU.</li>
<li>Go to <code>chrome://flags</code> and set the flat for <strong>Override software rendering list</strong>
    to <strong>Enabled</strong>; restart Chrome.</li>
</ul>
<h4 id="install-the-h264ify-extension">Install the <code>h264ify</code> extension</h4>
<p>After installing the <a href="https://chromewebstore.google.com/detail/h264ify/aleakchihdccplidncghkekgioiakgal?hl=en&amp;pli=1">h264ify extension</a>
in Chrome, YouTube "Stats for nerds" shows the codecs used are <strong>avc</strong> and <strong>mp4a</strong>. This
does seem to make playback smoother than previously with codecs <strong>av01</strong> and  <strong>opus</strong>.</p>
<h3 id="switching-to-the-xe-driver">Switching to the <code>xe</code> driver</h3>
<p>The above behavior with system-wide a steady climb in kernel dynamic memory—strongly
suggested a kernel-level memory leak associated with the Intel graphics driver.
In Ubuntu 24.04 (Noble Numbat), 13th Generation Intel CPUs (i5-1340P) can use either the
legacy <code>i915</code> driver or the newer, modern <code>xe</code> driver. The <code>lsmod</code> output shows both are
loaded, but <code>i915</code> has 60 active references while <code>xe</code> has 0, confirming the system is
relying on the older driver.</p>
<p>The <code>xe</code> driver was designed from the ground up for modern Intel hardware (Tiger Lake and
newer) and is increasingly the focus for performance and stability fixes in 2025.
Switching the driver should help resolve the memory leak.</p>
<p>Identify the PCI ID of the GPU:</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-44-1"><a id="__codelineno-44-1" name="__codelineno-44-1" href="#__codelineno-44-1"></a><span class="gp">$ </span>lspci<span class="w"> </span>-nn<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>VGA
</span><span id="__span-44-2"><a id="__codelineno-44-2" name="__codelineno-44-2" href="#__codelineno-44-2"></a><span class="go">00:02.0 VGA compatible controller [0300]: Intel Corporation Raptor Lake-P [UHD Graphics] [8086:a720] (rev 04)</span>
</span></code></pre></div>
<p>The ID is the second part of the hex code in brackets: <code>a720</code>.</p>
<p>Update <code>/etc/default/grub</code> to add the options to <code>GRUB_CMDLINE_LINUX_DEFAULT</code> to force the
<code>xe</code> driver to detect the GPU instead of the <code>i915</code> driver:</p>
<div class="language-ini highlight"><pre><span></span><code><span id="__span-45-1"><a id="__codelineno-45-1" name="__codelineno-45-1" href="#__codelineno-45-1"></a><span class="na">GRUB_CMDLINE_LINUX_DEFAULT</span><span class="o">=</span><span class="s">"quiet splash i915.force_probe=!a720 xe.force_probe=a720"</span>
</span></code></pre></div>
<p>Update GRUB and reboot:</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-46-1"><a id="__codelineno-46-1" name="__codelineno-46-1" href="#__codelineno-46-1"></a><span class="gp"># </span>update-grub
</span><span id="__span-46-2"><a id="__codelineno-46-2" name="__codelineno-46-2" href="#__codelineno-46-2"></a><span class="gp"># </span>shutdowh<span class="w"> </span>-r<span class="w"> </span>now<span class="w"> </span>
</span></code></pre></div>
<p>After rebooting, <code>lsmod</code> shows the <code>xe</code> driver is now the one with active usage, while
<code>i915</code> has <strong>0</strong>:</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-47-1"><a id="__codelineno-47-1" name="__codelineno-47-1" href="#__codelineno-47-1"></a><span class="gp"># </span>lsmod<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>-E<span class="w"> </span><span class="s1">'i915|xe'</span>
</span><span id="__span-47-2"><a id="__codelineno-47-2" name="__codelineno-47-2" href="#__codelineno-47-2"></a><span class="hll"><span class="go">xe                   2732032  47</span>
</span></span><span id="__span-47-3"><a id="__codelineno-47-3" name="__codelineno-47-3" href="#__codelineno-47-3"></a><span class="go">drm_gpuvm              45056  1 xe</span>
</span><span id="__span-47-4"><a id="__codelineno-47-4" name="__codelineno-47-4" href="#__codelineno-47-4"></a><span class="go">drm_exec               12288  2 drm_gpuvm,xe</span>
</span><span id="__span-47-5"><a id="__codelineno-47-5" name="__codelineno-47-5" href="#__codelineno-47-5"></a><span class="go">gpu_sched              61440  1 xe</span>
</span><span id="__span-47-6"><a id="__codelineno-47-6" name="__codelineno-47-6" href="#__codelineno-47-6"></a><span class="go">drm_suballoc_helper    16384  1 xe</span>
</span><span id="__span-47-7"><a id="__codelineno-47-7" name="__codelineno-47-7" href="#__codelineno-47-7"></a><span class="go">drm_ttm_helper         12288  1 xe</span>
</span><span id="__span-47-8"><a id="__codelineno-47-8" name="__codelineno-47-8" href="#__codelineno-47-8"></a><span class="hll"><span class="go">i915                 4300800  0</span>
</span></span><span id="__span-47-9"><a id="__codelineno-47-9" name="__codelineno-47-9" href="#__codelineno-47-9"></a><span class="go">drm_buddy              20480  2 xe,i915</span>
</span><span id="__span-47-10"><a id="__codelineno-47-10" name="__codelineno-47-10" href="#__codelineno-47-10"></a><span class="go">ttm                   110592  3 drm_ttm_helper,xe,i915</span>
</span><span id="__span-47-11"><a id="__codelineno-47-11" name="__codelineno-47-11" href="#__codelineno-47-11"></a><span class="go">drm_display_helper    237568  2 xe,i915</span>
</span><span id="__span-47-12"><a id="__codelineno-47-12" name="__codelineno-47-12" href="#__codelineno-47-12"></a><span class="go">cec                    94208  3 drm_display_helper,xe,i915</span>
</span><span id="__span-47-13"><a id="__codelineno-47-13" name="__codelineno-47-13" href="#__codelineno-47-13"></a><span class="go">i2c_algo_bit           16384  2 xe,i915</span>
</span><span id="__span-47-14"><a id="__codelineno-47-14" name="__codelineno-47-14" href="#__codelineno-47-14"></a><span class="go">video                  77824  4 asus_wmi,asus_nb_wmi,xe,i915</span>
</span></code></pre></div>
<h4 id="gpu-monitoring">GPU monitoring</h4>
<p>After switching to the <code>xe</code> driver <code>intel_gpu_top</code> no longer works:</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-48-1"><a id="__codelineno-48-1" name="__codelineno-48-1" href="#__codelineno-48-1"></a><span class="gp"># </span>intel_gpu_top<span class="w"> </span>
</span><span id="__span-48-2"><a id="__codelineno-48-2" name="__codelineno-48-2" href="#__codelineno-48-2"></a><span class="go">No device filter specified and no discrete/integrated i915 devices found</span>
</span></code></pre></div>
<p>The <code>intel_gpu_top</code> utility is hard-coded to work with the legacy <code>i915</code> driver and does
not natively support the newer <code>xe</code> driver. Instead, <code>nvtop</code> (Neat Videocard TOP) can be
used as the most effective replacement for monitoring your GPU while using the <code>xe</code>
driver. However, even <code>nvtop</code> needs to be pretty recent to detect this GPU, so it must
be installed from <code>snap</code> rather than the Ubuntu repository.</p>
<p>By default <code>nvtop</code> shows a nice UI with charts, but it can also be used to export data
in JSON format:</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-49-1"><a id="__codelineno-49-1" name="__codelineno-49-1" href="#__codelineno-49-1"></a><span class="gp"># </span>nvtop<span class="w"> </span>-s
</span><span id="__span-49-2"><a id="__codelineno-49-2" name="__codelineno-49-2" href="#__codelineno-49-2"></a><span class="go">[</span>
</span><span id="__span-49-3"><a id="__codelineno-49-3" name="__codelineno-49-3" href="#__codelineno-49-3"></a><span class="go">  {</span>
</span><span id="__span-49-4"><a id="__codelineno-49-4" name="__codelineno-49-4" href="#__codelineno-49-4"></a><span class="go">   "device_name": "Raptor Lake-P (UHD Graphics)",</span>
</span><span id="__span-49-5"><a id="__codelineno-49-5" name="__codelineno-49-5" href="#__codelineno-49-5"></a><span class="go">   "gpu_clock": "333MHz",</span>
</span><span id="__span-49-6"><a id="__codelineno-49-6" name="__codelineno-49-6" href="#__codelineno-49-6"></a><span class="go">   "mem_clock": null,</span>
</span><span id="__span-49-7"><a id="__codelineno-49-7" name="__codelineno-49-7" href="#__codelineno-49-7"></a><span class="go">   "temp": null,</span>
</span><span id="__span-49-8"><a id="__codelineno-49-8" name="__codelineno-49-8" href="#__codelineno-49-8"></a><span class="go">   "fan_speed": "CPU Fan",</span>
</span><span id="__span-49-9"><a id="__codelineno-49-9" name="__codelineno-49-9" href="#__codelineno-49-9"></a><span class="go">   "power_draw": null,</span>
</span><span id="__span-49-10"><a id="__codelineno-49-10" name="__codelineno-49-10" href="#__codelineno-49-10"></a><span class="go">   "gpu_util": null,</span>
</span><span id="__span-49-11"><a id="__codelineno-49-11" name="__codelineno-49-11" href="#__codelineno-49-11"></a><span class="go">   "mem_util": "3%"</span>
</span><span id="__span-49-12"><a id="__codelineno-49-12" name="__codelineno-49-12" href="#__codelineno-49-12"></a><span class="go">  }</span>
</span><span id="__span-49-13"><a id="__codelineno-49-13" name="__codelineno-49-13" href="#__codelineno-49-13"></a><span class="go">]</span>
</span></code></pre></div>
<p>The only useful metric available are <code>gpu_clock</code> and <code>mem_util</code>; the <code>fan_speed</code> seems to
merely refer to the fact that there is no separate fan for the GPU and the other metrics
are not available.</p>
<p>Unlike <code>nvtop</code>, <code>vainfo</code> remains unable to find this GPU:</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-50-1"><a id="__codelineno-50-1" name="__codelineno-50-1" href="#__codelineno-50-1"></a><span class="gp"># </span><span class="nb">export</span><span class="w"> </span><span class="nv">LIBVA_DRIVER_NAME</span><span class="o">=</span>iHD
</span><span id="__span-50-2"><a id="__codelineno-50-2" name="__codelineno-50-2" href="#__codelineno-50-2"></a><span class="gp"># </span>vainfo<span class="w"> </span>--display<span class="w"> </span>drm<span class="w"> </span>--device<span class="w"> </span>/dev/dri/renderD128
</span><span id="__span-50-3"><a id="__codelineno-50-3" name="__codelineno-50-3" href="#__codelineno-50-3"></a><span class="go">libva info: VA-API version 1.20.0</span>
</span><span id="__span-50-4"><a id="__codelineno-50-4" name="__codelineno-50-4" href="#__codelineno-50-4"></a><span class="go">libva info: User environment variable requested driver 'iHD'</span>
</span><span id="__span-50-5"><a id="__codelineno-50-5" name="__codelineno-50-5" href="#__codelineno-50-5"></a><span class="go">libva info: Trying to open /usr/lib/x86_64-linux-gnu/dri/iHD_drv_video.so</span>
</span><span id="__span-50-6"><a id="__codelineno-50-6" name="__codelineno-50-6" href="#__codelineno-50-6"></a><span class="go">libva info: Found init function __vaDriverInit_1_20</span>
</span><span id="__span-50-7"><a id="__codelineno-50-7" name="__codelineno-50-7" href="#__codelineno-50-7"></a><span class="go">libva error: /usr/lib/x86_64-linux-gnu/dri/iHD_drv_video.so init failed</span>
</span><span id="__span-50-8"><a id="__codelineno-50-8" name="__codelineno-50-8" href="#__codelineno-50-8"></a><span class="go">libva info: va_openDriver() returns 18</span>
</span><span id="__span-50-9"><a id="__codelineno-50-9" name="__codelineno-50-9" href="#__codelineno-50-9"></a><span class="go">vaInitialize failed with error code 18 (invalid parameter),exit</span>
</span></code></pre></div>
<h3 id="install-va-driver-non-free">Install VA driver non-free</h3>
<p>There is a lot of lagging in the browser, because the system is currently using
Software Rendering (CPU-only) to decode and display video. Even though the <code>xe</code> kernel
driver is loaded, the userspace software (Chrome, <code>vainfo</code>, <code>nvtop</code>) cannot access the
GPU's hardware acceleration features because the driver interface is not correctly
initialized, and this was because Ubuntu did not install the <code>non-free</code> driver.</p>
<p>Install the <code>intel-media-va-driver-non-free</code> driver <strong>and reboot</strong>:</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-51-1"><a id="__codelineno-51-1" name="__codelineno-51-1" href="#__codelineno-51-1"></a><span class="gp"># </span>apt<span class="w"> </span>install<span class="w"> </span>intel-media-va-driver-non-free<span class="w"> </span>-y
</span><span id="__span-51-2"><a id="__codelineno-51-2" name="__codelineno-51-2" href="#__codelineno-51-2"></a><span class="go">Reading package lists... Done</span>
</span><span id="__span-51-3"><a id="__codelineno-51-3" name="__codelineno-51-3" href="#__codelineno-51-3"></a><span class="go">Building dependency tree... Done</span>
</span><span id="__span-51-4"><a id="__codelineno-51-4" name="__codelineno-51-4" href="#__codelineno-51-4"></a><span class="go">Reading state information... Done</span>
</span><span id="__span-51-5"><a id="__codelineno-51-5" name="__codelineno-51-5" href="#__codelineno-51-5"></a><span class="go">The following packages will be REMOVED:</span>
</span><span id="__span-51-6"><a id="__codelineno-51-6" name="__codelineno-51-6" href="#__codelineno-51-6"></a><span class="go">  intel-media-va-driver</span>
</span><span id="__span-51-7"><a id="__codelineno-51-7" name="__codelineno-51-7" href="#__codelineno-51-7"></a><span class="go">The following NEW packages will be installed:</span>
</span><span id="__span-51-8"><a id="__codelineno-51-8" name="__codelineno-51-8" href="#__codelineno-51-8"></a><span class="go">  intel-media-va-driver-non-free</span>
</span><span id="__span-51-9"><a id="__codelineno-51-9" name="__codelineno-51-9" href="#__codelineno-51-9"></a><span class="go">0 upgraded, 1 newly installed, 1 to remove and 0 not upgraded.</span>
</span><span id="__span-51-10"><a id="__codelineno-51-10" name="__codelineno-51-10" href="#__codelineno-51-10"></a><span class="go">Need to get 0 B/8,784 kB of archives.</span>
</span><span id="__span-51-11"><a id="__codelineno-51-11" name="__codelineno-51-11" href="#__codelineno-51-11"></a><span class="go">After this operation, 22.5 MB of additional disk space will be used.</span>
</span><span id="__span-51-12"><a id="__codelineno-51-12" name="__codelineno-51-12" href="#__codelineno-51-12"></a><span class="go">dpkg: intel-media-va-driver:amd64: dependency problems, but removing anyway as you requested:</span>
</span><span id="__span-51-13"><a id="__codelineno-51-13" name="__codelineno-51-13" href="#__codelineno-51-13"></a><span class="go"> va-driver-all:amd64 depends on intel-media-va-driver | intel-media-va-driver-non-free; however:</span>
</span><span id="__span-51-14"><a id="__codelineno-51-14" name="__codelineno-51-14" href="#__codelineno-51-14"></a><span class="go">  Package intel-media-va-driver:amd64 is to be removed.</span>
</span><span id="__span-51-15"><a id="__codelineno-51-15" name="__codelineno-51-15" href="#__codelineno-51-15"></a><span class="go">  Package intel-media-va-driver-non-free is not installed.</span>
</span><span id="__span-51-16"><a id="__codelineno-51-16" name="__codelineno-51-16" href="#__codelineno-51-16"></a>
</span><span id="__span-51-17"><a id="__codelineno-51-17" name="__codelineno-51-17" href="#__codelineno-51-17"></a><span class="gp gp-VirtualEnv">(Reading database ... 470408 files and directories currently installed.)</span>
</span><span id="__span-51-18"><a id="__codelineno-51-18" name="__codelineno-51-18" href="#__codelineno-51-18"></a><span class="go">Removing intel-media-va-driver:amd64 (24.1.0+dfsg1-1ubuntu0.1) ...</span>
</span><span id="__span-51-19"><a id="__codelineno-51-19" name="__codelineno-51-19" href="#__codelineno-51-19"></a><span class="go">Selecting previously unselected package intel-media-va-driver-non-free:amd64.</span>
</span><span id="__span-51-20"><a id="__codelineno-51-20" name="__codelineno-51-20" href="#__codelineno-51-20"></a><span class="gp gp-VirtualEnv">(Reading database ... 470404 files and directories currently installed.)</span>
</span><span id="__span-51-21"><a id="__codelineno-51-21" name="__codelineno-51-21" href="#__codelineno-51-21"></a><span class="go">Preparing to unpack .../intel-media-va-driver-non-free_24.1.0+ds1-1_amd64.deb ...</span>
</span><span id="__span-51-22"><a id="__codelineno-51-22" name="__codelineno-51-22" href="#__codelineno-51-22"></a><span class="go">Unpacking intel-media-va-driver-non-free:amd64 (24.1.0+ds1-1) ...</span>
</span><span id="__span-51-23"><a id="__codelineno-51-23" name="__codelineno-51-23" href="#__codelineno-51-23"></a><span class="go">Setting up intel-media-va-driver-non-free:amd64 (24.1.0+ds1-1) ...</span>
</span></code></pre></div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>"Non-free" in this context refers to licensing, not cost or security risk. This
package includes proprietary binary blobs (media kernels) required to fully unlock
hardware acceleration for modern Intel features like AV1 and improved H.264/HEVC
performance on 13th Gen chips. Standard Ubuntu/Debian repositories provide the "free"
version by default, which often lacks the firmware or features needed to initialize
the iHD driver correctly on newer Xe-based hardware. </p>
</div>
<h3 id="reinstall-linux-firmware">Reinstall <code>linux-firmware</code></h3>
<p>Ensure firmware is current, the <code>xe</code> driver depends on specific GUC/HUC firmware blobs:</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-52-1"><a id="__codelineno-52-1" name="__codelineno-52-1" href="#__codelineno-52-1"></a><span class="gp"># </span>apt<span class="w"> </span>install<span class="w"> </span>--reinstall<span class="w"> </span>linux-firmware.
</span></code></pre></div>
<h3 id="grant-access-to-devdri">Grant access to /dev/dri</h3>
<p>Confirm Driver Ownership: Run ls -l /dev/dri. Ensure your user is part of the video and render groups: sudo usermod -aG video,render $USER (re-log after this).</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-53-1"><a id="__codelineno-53-1" name="__codelineno-53-1" href="#__codelineno-53-1"></a><span class="gp"># </span>ls<span class="w"> </span>-l<span class="w"> </span>/dev/dri
</span><span id="__span-53-2"><a id="__codelineno-53-2" name="__codelineno-53-2" href="#__codelineno-53-2"></a><span class="go">total 0</span>
</span><span id="__span-53-3"><a id="__codelineno-53-3" name="__codelineno-53-3" href="#__codelineno-53-3"></a><span class="go">drwxr-xr-x  2 root root         80 Dec 23 14:02 by-path</span>
</span><span id="__span-53-4"><a id="__codelineno-53-4" name="__codelineno-53-4" href="#__codelineno-53-4"></a><span class="go">crw-rw----+ 1 root video  226,   1 Dec 23 14:02 card1</span>
</span><span id="__span-53-5"><a id="__codelineno-53-5" name="__codelineno-53-5" href="#__codelineno-53-5"></a><span class="go">crw-rw----+ 1 root render 226, 128 Dec 23 14:02 renderD128</span>
</span><span id="__span-53-6"><a id="__codelineno-53-6" name="__codelineno-53-6" href="#__codelineno-53-6"></a>
</span><span id="__span-53-7"><a id="__codelineno-53-7" name="__codelineno-53-7" href="#__codelineno-53-7"></a><span class="gp"># </span>usermod<span class="w"> </span>-aG<span class="w"> </span>video,render<span class="w"> </span><span class="nv">$USER</span>
</span></code></pre></div>
<h3 id="graphical-glitches">Graphical glitches</h3>
<p>Unfortunately, once the XE driver was finally in full effect, it lead to a terrible issue
with flickering colors and a reduced palette. It started relativel subtle but then became
a lot more prominent and started affecting even the geometry of windows borders.</p>
<p>The issue started happening after adding the user to the <code>video,render</code> groups and
reinstalling <code>linux-firmware</code>, both followed by a single reboot. While Chrome appeared to
be working better, with several features using GPU acceleration, the graphical glitches
rendered the system essentiall unusable.</p>
<h4 id="disable-panel-self-refresh">Disable Panel Self Refresh</h4>
<p>Panel Self Refresh (PSR) is a common cause of flickering on Intel Xe/UHD graphics.
This can be disabled by adding <code>xe.enable_psr=0</code> to the kernel parameters in
<code>/etc/default/grub</code>:</p>
<div class="language-ini highlight"><pre><span></span><code><span id="__span-54-1"><a id="__codelineno-54-1" name="__codelineno-54-1" href="#__codelineno-54-1"></a><span class="na">GRUB_CMDLINE_LINUX_DEFAULT</span><span class="o">=</span><span class="s">"quiet splash i915.force_probe=!a720 xe.force_probe=a720 xe.enable_psr=0"</span>
</span></code></pre></div>
<p>After updating GRUB (<code>update-grub</code>) and rebooting, the issue was only partially
mitigated; it stopped the worst color flickering, which was happening on the login
screen, but when playing YouTube videos it showed washed out colors with some contour
lines and subtle gradients being replaced with very saturated colors.</p>
<h4 id="toggle-iommu-for-graphics">Toggle IOMMU for Graphics</h4>
<p>Some users have reported that disabling IOMMU specifically for the integrated graphics
solves persistent flickering in Ubuntu 24.04. This can be done by adding 
<code>intel_iommu=igfx_off</code> to the kernel parameters in <code>/etc/default/grub</code>:</p>
<div class="language-ini highlight"><pre><span></span><code><span id="__span-55-1"><a id="__codelineno-55-1" name="__codelineno-55-1" href="#__codelineno-55-1"></a><span class="na">GRUB_CMDLINE_LINUX_DEFAULT</span><span class="o">=</span><span class="s">"quiet splash i915.force_probe=!a720 xe.force_probe=a720 xe.enable_psr=0 intel_iommu=igfx_off"</span>
</span></code></pre></div>
<p>After updating GRUB (<code>update-grub</code>) and rebooting, the issue of color flickering seemed
to have been fully mitited. However, the output from <code>xrandr --prop</code> showed the display
(<code>DP-1</code>) was using an <strong>Automatic Broadcast RGB</strong> setting. On many monitors, especially
portable ones like the connected to the USB-C/DisplayPort (a Verbatim M14), "Automatic"
defaults to <strong>Limited range (16-235)</strong> and this causes the washed-out colors and banding.</p>
<details class="terminal">
<summary>Output from <code>xrandr --prop</code> for <code>DP-1</code></summary>
<div class="language-console highlight"><pre><span></span><code><span id="__span-56-1"><a id="__codelineno-56-1" name="__codelineno-56-1" href="#__codelineno-56-1"></a><span class="gp">$ </span>xrandr<span class="w"> </span>--prop
</span><span id="__span-56-2"><a id="__codelineno-56-2" name="__codelineno-56-2" href="#__codelineno-56-2"></a><span class="go">Screen 0: minimum 320 x 200, current 1920 x 1080, maximum 16384 x 16384</span>
</span><span id="__span-56-3"><a id="__codelineno-56-3" name="__codelineno-56-3" href="#__codelineno-56-3"></a><span class="go">...</span>
</span><span id="__span-56-4"><a id="__codelineno-56-4" name="__codelineno-56-4" href="#__codelineno-56-4"></a><span class="go">DP-1 connected primary 1920x1080+0+0 (normal left inverted right x axis y axis) 230mm x 270mm</span>
</span><span id="__span-56-5"><a id="__codelineno-56-5" name="__codelineno-56-5" href="#__codelineno-56-5"></a><span class="go">        _KDE_SCREEN_INDEX: 1 </span>
</span><span id="__span-56-6"><a id="__codelineno-56-6" name="__codelineno-56-6" href="#__codelineno-56-6"></a><span class="go">        EDID: </span>
</span><span id="__span-56-7"><a id="__codelineno-56-7" name="__codelineno-56-7" href="#__codelineno-56-7"></a><span class="go">                00ffffffffffff004a8b010001000000</span>
</span><span id="__span-56-8"><a id="__codelineno-56-8" name="__codelineno-56-8" href="#__codelineno-56-8"></a><span class="go">                08210104b5171b783bee91a3544c9926</span>
</span><span id="__span-56-9"><a id="__codelineno-56-9" name="__codelineno-56-9" href="#__codelineno-56-9"></a><span class="go">                0f5054210800d1c08180a9c0d1c00101</span>
</span><span id="__span-56-10"><a id="__codelineno-56-10" name="__codelineno-56-10" href="#__codelineno-56-10"></a><span class="go">                010101010101023a801871382d40582c</span>
</span><span id="__span-56-11"><a id="__codelineno-56-11" name="__codelineno-56-11" href="#__codelineno-56-11"></a><span class="go">                2500e60e0100001e000000ff0064656d</span>
</span><span id="__span-56-12"><a id="__codelineno-56-12" name="__codelineno-56-12" href="#__codelineno-56-12"></a><span class="go">                6f7365742d310a202020000000fc0056</span>
</span><span id="__span-56-13"><a id="__codelineno-56-13" name="__codelineno-56-13" href="#__codelineno-56-13"></a><span class="go">                6572626174696d204d31340a000000fd</span>
</span><span id="__span-56-14"><a id="__codelineno-56-14" name="__codelineno-56-14" href="#__codelineno-56-14"></a><span class="go">                00283d545411010a202020202020011f</span>
</span><span id="__span-56-15"><a id="__codelineno-56-15" name="__codelineno-56-15" href="#__codelineno-56-15"></a><span class="go">                02031ff2440104021023097f07830100</span>
</span><span id="__span-56-16"><a id="__codelineno-56-16" name="__codelineno-56-16" href="#__codelineno-56-16"></a><span class="go">                00e305c000e200c0e606050162622802</span>
</span><span id="__span-56-17"><a id="__codelineno-56-17" name="__codelineno-56-17" href="#__codelineno-56-17"></a><span class="go">                3a801871382d40582c4500e60e010000</span>
</span><span id="__span-56-18"><a id="__codelineno-56-18" name="__codelineno-56-18" href="#__codelineno-56-18"></a><span class="go">                1e000000000000000000000000000000</span>
</span><span id="__span-56-19"><a id="__codelineno-56-19" name="__codelineno-56-19" href="#__codelineno-56-19"></a><span class="go">                00000000000000000000000000000000</span>
</span><span id="__span-56-20"><a id="__codelineno-56-20" name="__codelineno-56-20" href="#__codelineno-56-20"></a><span class="go">                00000000000000000000000000000000</span>
</span><span id="__span-56-21"><a id="__codelineno-56-21" name="__codelineno-56-21" href="#__codelineno-56-21"></a><span class="go">                00000000000000000000000000000000</span>
</span><span id="__span-56-22"><a id="__codelineno-56-22" name="__codelineno-56-22" href="#__codelineno-56-22"></a><span class="go">                0000000000000000000000000000006b</span>
</span><span id="__span-56-23"><a id="__codelineno-56-23" name="__codelineno-56-23" href="#__codelineno-56-23"></a><span class="go">        HDCP Content Type: HDCP Type0 </span>
</span><span id="__span-56-24"><a id="__codelineno-56-24" name="__codelineno-56-24" href="#__codelineno-56-24"></a><span class="go">                supported: HDCP Type0, HDCP Type1</span>
</span><span id="__span-56-25"><a id="__codelineno-56-25" name="__codelineno-56-25" href="#__codelineno-56-25"></a><span class="go">        Content Protection: Undesired </span>
</span><span id="__span-56-26"><a id="__codelineno-56-26" name="__codelineno-56-26" href="#__codelineno-56-26"></a><span class="go">                supported: Undesired, Desired, Enabled</span>
</span><span id="__span-56-27"><a id="__codelineno-56-27" name="__codelineno-56-27" href="#__codelineno-56-27"></a><span class="go">        vrr_capable: 0 </span>
</span><span id="__span-56-28"><a id="__codelineno-56-28" name="__codelineno-56-28" href="#__codelineno-56-28"></a><span class="go">                range: (0, 1)</span>
</span><span id="__span-56-29"><a id="__codelineno-56-29" name="__codelineno-56-29" href="#__codelineno-56-29"></a><span class="go">        Colorspace: Default </span>
</span><span id="__span-56-30"><a id="__codelineno-56-30" name="__codelineno-56-30" href="#__codelineno-56-30"></a><span class="go">                supported: Default, BT709_YCC, XVYCC_601, XVYCC_709, SYCC_601, opYCC_601, opRGB, BT2020_CYCC, BT2020_RGB, BT2020_YCC, DCI-P3_RGB_D65, RGB_WIDE_FIXED, RGB_WIDE_FLOAT, BT601_YCC</span>
</span><span id="__span-56-31"><a id="__codelineno-56-31" name="__codelineno-56-31" href="#__codelineno-56-31"></a><span class="go">        max bpc: 12 </span>
</span><span id="__span-56-32"><a id="__codelineno-56-32" name="__codelineno-56-32" href="#__codelineno-56-32"></a><span class="go">                range: (6, 12)</span>
</span><span id="__span-56-33"><a id="__codelineno-56-33" name="__codelineno-56-33" href="#__codelineno-56-33"></a><span class="go">        Broadcast RGB: Automatic </span>
</span><span id="__span-56-34"><a id="__codelineno-56-34" name="__codelineno-56-34" href="#__codelineno-56-34"></a><span class="go">                supported: Automatic, Full, Limited 16:235</span>
</span><span id="__span-56-35"><a id="__codelineno-56-35" name="__codelineno-56-35" href="#__codelineno-56-35"></a><span class="go">        audio: auto </span>
</span><span id="__span-56-36"><a id="__codelineno-56-36" name="__codelineno-56-36" href="#__codelineno-56-36"></a><span class="go">                supported: force-dvi, off, auto, on</span>
</span><span id="__span-56-37"><a id="__codelineno-56-37" name="__codelineno-56-37" href="#__codelineno-56-37"></a><span class="go">        subconnector: Native </span>
</span><span id="__span-56-38"><a id="__codelineno-56-38" name="__codelineno-56-38" href="#__codelineno-56-38"></a><span class="go">                supported: Unknown, VGA, DVI-D, HDMI, DP, Wireless, Native</span>
</span><span id="__span-56-39"><a id="__codelineno-56-39" name="__codelineno-56-39" href="#__codelineno-56-39"></a><span class="go">        link-status: Good </span>
</span><span id="__span-56-40"><a id="__codelineno-56-40" name="__codelineno-56-40" href="#__codelineno-56-40"></a><span class="go">                supported: Good, Bad</span>
</span><span id="__span-56-41"><a id="__codelineno-56-41" name="__codelineno-56-41" href="#__codelineno-56-41"></a><span class="go">        CTM: 0 1 0 0 0 0 0 0 0 1 0 0 0 0 0 0 </span>
</span><span id="__span-56-42"><a id="__codelineno-56-42" name="__codelineno-56-42" href="#__codelineno-56-42"></a><span class="go">                0 1 </span>
</span><span id="__span-56-43"><a id="__codelineno-56-43" name="__codelineno-56-43" href="#__codelineno-56-43"></a><span class="go">        CONNECTOR_ID: 250 </span>
</span><span id="__span-56-44"><a id="__codelineno-56-44" name="__codelineno-56-44" href="#__codelineno-56-44"></a><span class="go">                supported: 250</span>
</span><span id="__span-56-45"><a id="__codelineno-56-45" name="__codelineno-56-45" href="#__codelineno-56-45"></a><span class="go">        non-desktop: 0 </span>
</span><span id="__span-56-46"><a id="__codelineno-56-46" name="__codelineno-56-46" href="#__codelineno-56-46"></a><span class="go">                range: (0, 1)</span>
</span><span id="__span-56-47"><a id="__codelineno-56-47" name="__codelineno-56-47" href="#__codelineno-56-47"></a><span class="go">  1920x1080     60.00*+  60.00    59.94  </span>
</span><span id="__span-56-48"><a id="__codelineno-56-48" name="__codelineno-56-48" href="#__codelineno-56-48"></a><span class="go">  1600x900      60.00  </span>
</span><span id="__span-56-49"><a id="__codelineno-56-49" name="__codelineno-56-49" href="#__codelineno-56-49"></a><span class="go">  1280x1024     60.02  </span>
</span><span id="__span-56-50"><a id="__codelineno-56-50" name="__codelineno-56-50" href="#__codelineno-56-50"></a><span class="go">  1280x720      60.00    59.94  </span>
</span><span id="__span-56-51"><a id="__codelineno-56-51" name="__codelineno-56-51" href="#__codelineno-56-51"></a><span class="go">  1024x768      60.00  </span>
</span><span id="__span-56-52"><a id="__codelineno-56-52" name="__codelineno-56-52" href="#__codelineno-56-52"></a><span class="go">  800x600       60.32  </span>
</span><span id="__span-56-53"><a id="__codelineno-56-53" name="__codelineno-56-53" href="#__codelineno-56-53"></a><span class="go">  720x480       60.00    59.94  </span>
</span><span id="__span-56-54"><a id="__codelineno-56-54" name="__codelineno-56-54" href="#__codelineno-56-54"></a><span class="go">  640x480       60.00    59.94  </span>
</span><span id="__span-56-55"><a id="__codelineno-56-55" name="__codelineno-56-55" href="#__codelineno-56-55"></a><span class="go">...</span>
</span></code></pre></div>
</details>
<p>These issues should be mitigated immediately with the following commands:</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-57-1"><a id="__codelineno-57-1" name="__codelineno-57-1" href="#__codelineno-57-1"></a><span class="gp">$ </span>xrandr<span class="w"> </span>--output<span class="w"> </span>DP-1<span class="w"> </span>--set<span class="w"> </span><span class="s2">"Broadcast RGB"</span><span class="w"> </span><span class="s2">"Full"</span>
</span><span id="__span-57-2"><a id="__codelineno-57-2" name="__codelineno-57-2" href="#__codelineno-57-2"></a><span class="gp">$ </span>xrandr<span class="w"> </span>--output<span class="w"> </span>DP-1<span class="w"> </span>--set<span class="w"> </span><span class="s2">"max bpc"</span><span class="w"> </span><span class="m">8</span>
</span></code></pre></div>
<p>To make the changes permanent, create <code>/etc/X11/xorg.conf.d/20-intel.conf</code> with:</p>
<div class="language-ini highlight"><pre><span></span><code><span id="__span-58-1"><a id="__codelineno-58-1" name="__codelineno-58-1" href="#__codelineno-58-1"></a><span class="na">Section "Device"</span>
</span><span id="__span-58-2"><a id="__codelineno-58-2" name="__codelineno-58-2" href="#__codelineno-58-2"></a><span class="w">    </span><span class="na">Identifier  "Intel Graphics"</span>
</span><span id="__span-58-3"><a id="__codelineno-58-3" name="__codelineno-58-3" href="#__codelineno-58-3"></a><span class="w">    </span><span class="na">Driver      "intel"</span>
</span><span id="__span-58-4"><a id="__codelineno-58-4" name="__codelineno-58-4" href="#__codelineno-58-4"></a><span class="w">    </span><span class="na">Option      "AccelMethod"  "sna"</span>
</span><span id="__span-58-5"><a id="__codelineno-58-5" name="__codelineno-58-5" href="#__codelineno-58-5"></a><span class="w">    </span><span class="na">Option      "BroadcastRGB" "Full"</span>
</span><span id="__span-58-6"><a id="__codelineno-58-6" name="__codelineno-58-6" href="#__codelineno-58-6"></a><span class="na">EndSection</span>
</span></code></pre></div>
<p>After this change colors finally looked okay, but it came at the cost of a huge drop in
performance; it was now absolutely terrible when playing videos on YouTube, the UI was
sluggish again, and CPU usage was a lot higher while GPU usage seemed to be zero.</p>
<h3 id="roolback-to-i915">Roolback to <code>i915</code></h3>
<p>Having run out of workarounds to make the <code>xe</code> driver work well, it was time to revert
back to the <code>i915</code> driver, by updating the kernel command line to:</p>
<div class="language-ini highlight"><pre><span></span><code><span id="__span-59-1"><a id="__codelineno-59-1" name="__codelineno-59-1" href="#__codelineno-59-1"></a><span class="na">GRUB_CMDLINE_LINUX_DEFAULT</span><span class="o">=</span><span class="s">"quiet splash i915.force_probe=a720 intel_iommu=igfx_off"</span>
</span></code></pre></div>
<p>After updating GRUB and rebooting, there are still more changes to make, to ensure the
correct kernel and Xorg drivers are used at all times.</p>
<p>To ensure the <code>xe</code> driver does not intefer by traing to claim harware elements, prevent
it from loading by creating <code>/etc/modprobe.d/blacklist-xe.conf</code> with</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-60-1"><a id="__codelineno-60-1" name="__codelineno-60-1" href="#__codelineno-60-1"></a>blacklist xe
</span></code></pre></div>
<p>This change requires first running <code>update-initramfs</code> before rebooting.</p>
<p>To always use the correct <code>iHD</code> driver, add the following to <code>/etc/environment</code>:</p>
<div class="language-ini highlight"><pre><span></span><code><span id="__span-61-1"><a id="__codelineno-61-1" name="__codelineno-61-1" href="#__codelineno-61-1"></a><span class="na">LIBVA_DRIVER_NAME</span><span class="o">=</span><span class="s">iHD</span>
</span></code></pre></div>
<p>After reverting to the <code>i915</code> driver, the system falls back to software rendering
(<code>llvmpipe</code> as reported by <code>glxinfo | grep "OpenGL renderer"</code>) instead of the standard
hardware-accelerated <code>i915</code> driver.</p>
<p>Because the system has been switching drivers, the compiled shader cache for <code>llvmpipe</code>
or <code>xe</code> might be interfering with the <code>i915</code> driver initialization. To avoid this,
clear the Mesa Cache:</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-62-1"><a id="__codelineno-62-1" name="__codelineno-62-1" href="#__codelineno-62-1"></a><span class="go">rm -rf ~/.cache/mesa_shader_cache</span>
</span></code></pre></div>
<p>Remove the Manual X11 Config previosly added:</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-63-1"><a id="__codelineno-63-1" name="__codelineno-63-1" href="#__codelineno-63-1"></a><span class="go">rm -rf /etc/X11/xorg.conf.d/20-intel.conf</span>
</span></code></pre></div>
<p>After all the above changes are in effect, <code>glxinfo | grep "OpenGL renderer"</code> shows
again the intel driver is used for hardware-accelerated rendering. Google Chrome feels a
lot snappier too, no longer constantly sluggish. AS a plus, <code>intel_gpu_top</code> works again.</p>
<h4 id="summary-of-changes">Summary of changes</h4>
<p>At this point it seems only the following changes remain in effect:</p>
<ol>
<li>Kernel command line includes the <code>intel_iommu=igfx_off</code> parameter (via GRUB config).</li>
<li>The <code>intel-media-va-driver-non-free</code> driver is installed and in use.</li>
<li>The <code>xe</code> kernel driver is not loaded at all.</li>
<li>Chrome is no longer blocklisting the GPU.</li>
<li>The <strong>h264ify</strong> extension is installed in Google Chrome.</li>
<li>The user belongs to the <code>video</code> and <code>render</code> groups.</li>
</ol>
<p>Back to the original problem (memory leak in the i915 driver), would now be the time to disable GUC/HUC? (adding i915.enable_guc=0 to GRUB)</p>
<h3 id="future-plans">Future Plans</h3>
<p>Having restored performance with the <code>i915</code> driver, it is not recommended time to disable
GuC/HuC (with the <code>i915.enable_guc=0</code> kernel parameter) unless the memory leak returns.</p>
<p>On 13th Gen Intel i5-1340P (Raptor Lake), the GuC (Graphics MicroController) is 
responsible for critical power management and scheduling. Disabling it may re-introduce
the sluggishness or high CPU usage, by shifting tasks from the GPU back to the CPU.</p>
<p>If the memory leak is no longer observed, one explanation may be that those "leak-like"
symptoms were actually DMA/IOMMU memory fragmentation issues. These would then have been
resolved by loading the kernel with the <code>intel_iommu=igfx_off</code> parameter.</p>
<p>In contrast, disabling the GuC/HuC (with <code>enable_guc=0</code>) is, on Raptor Lake and newer
CPUS, "legacy" troubleshooting that may cause the system to lose hardware-accelerated
video decoding (VA-API) in Chrome, even if the driver is loaded.</p>
<h4 id="disable-panel-self-refresh_1">Disable Panel Self Refresh</h4>
<p>If the leak persists, adding <code>i915.enable_psr=0</code> to the kernel command line in GRUB to
disable PSR, while leaving GuC enabled, may be a better workaround. Panel Self Refresh is
a more frequent cause of "ghost" memory usage than GuC on 13th Gen hardware.</p>
<h4 id="update-bios-microcode">Update BIOS &amp; Microcode</h4>
<p>For 13th Gen NUCs, the most critical fix for "unusual" driver behavior and stability
is the <code>0x12F</code> microcode update (or newer). Updating the BIOS to the latest version
should mitigate hardware-level voltage instability that can mimic driver memory leaks.</p>
<p><a href="https://www.asus.com/supportonly/nuc13anhi7/helpdesk_bios/">Product Support For NUC 13 Pro Mini PC</a>
shows the latest BIOS Version release is <strong>v0039</strong> from September 4, 2025.
The current BIOS Version release is <strong>v0033</strong> from August 7, 2024:</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-64-1"><a id="__codelineno-64-1" name="__codelineno-64-1" href="#__codelineno-64-1"></a><span class="gp"># </span>dmidecode<span class="w"> </span>-s<span class="w"> </span>bios-version
</span><span id="__span-64-2"><a id="__codelineno-64-2" name="__codelineno-64-2" href="#__codelineno-64-2"></a><span class="go">ANRPL357.0033.2024.0716.1113</span>
</span></code></pre></div>
<p>To update the firmware, all it takes is a USB stick and a few minutes:</p>
<ol>
<li>Download the file from <a href="https://www.asus.com/supportonly/nuc13anhi7/helpdesk_bios/">https://www.asus.com/supportonly/nuc13anhi7/helpdesk_bios/</a></li>
<li>Extract the <code>ANRPL357.0039.CAP</code> file and write it to a FAT32-formatted USB drive.</li>
<li>Restart the NUC and press <strong>F7</strong> screen to enter the <strong>Flash Update tool</strong>.</li>
<li>Select the file and confirm. <strong>Do not power off</strong> during the 2–5 minute process.</li>
</ol>
<p>The latest Microcode for Raptor Lake is <code>0x4129</code> and that is the one already in the
system:</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-65-1"><a id="__codelineno-65-1" name="__codelineno-65-1" href="#__codelineno-65-1"></a><span class="gp"># </span>dmesg<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>-i<span class="w"> </span>microcode
</span><span id="__span-65-2"><a id="__codelineno-65-2" name="__codelineno-65-2" href="#__codelineno-65-2"></a><span class="go">[    1.810277] microcode: Current revision: 0x00004129</span>
</span><span id="__span-65-3"><a id="__codelineno-65-3" name="__codelineno-65-3" href="#__codelineno-65-3"></a><span class="go">[    1.810278] microcode: Updated early from: 0x00004121</span>
</span></code></pre></div>
<p>The <code>0x4129</code> revision is a recent release addressing high-severity security
vulnerabilities documented in
<a href="https://www.intel.com/content/www/us/en/security-center/advisory/intel-sa-01249.html">Intel-SA-01249/01313</a>.</p>
<h4 id="2026-update-linux-kernel-614">2026 Update: Linux kernel 6.14</h4>
<p>In the end, the solution was a lot simpler than all the above, after enough time passed.</p>
<p>Ubuntu 24.04 defaults to a very old kernel (6.8.0) but at this time, nearly a year
later, the system can be upgraded to the much newer kernel 6.14 which had several
memory management fixes for Raptor Lake backported.</p>
<details class="note">
<summary>3 methods to update the kernel on a NUC.</summary>
<p>To update the kernel on a NUC, where secure boot cannot be disabled, thus requiring
the kernel to be signed, there are two easy options and a hard one:</p>
<ol>
<li>
<p><strong>Use the Official HWE Kernel (Easiest &amp; Safest).</strong><br>
    The Hardware Enablement (HWE) stack provides newer kernels that are fully signed and officially supported by Canonical. Currently the HWE stack for Ubuntu 24.04 has
    advanced to Linux the <strong>6.14</strong> branch (<code>6.14.0-37.37~24.04.1</code>):</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-66-1"><a id="__codelineno-66-1" name="__codelineno-66-1" href="#__codelineno-66-1"></a><span class="c1"># apt install --install-recommends linux-generic-hwe-24.04</span>
</span></code></pre></div>
<p>This kernel is automatically signed by Ubuntu, meaning it will boot immediately
with Secure Boot active. </p>
</li>
<li>
<p><strong>Use the OEM Kernel (For NUC Stability).</strong><br>
    NUC hardware often qualifies for the "OEM" track, which carries earlier access
    to drivers and hardware-specific fixes. These are also fully signed by
    Canonical. Currently the OEM track for Ubuntu 24.04 offers slighly newer
    patches in the <strong>6.14</strong> branch (<code>6.14.0-1018.18</code>):</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-67-1"><a id="__codelineno-67-1" name="__codelineno-67-1" href="#__codelineno-67-1"></a><span class="c1"># apt install linux-oem-24.04</span>
</span></code></pre></div>
</li>
<li>
<p><strong>Manual Signing of Mainline Kernels (Advanced).</strong><br>
    If a vanilla kernel like 6.8.12 or a bleeding-edge version not yet in HWE is
    needed, this must be done using a tool like <code>mainline</code> and then manually
    signing it so the UEFI firmware trusts it.</p>
<ol>
<li>
<p><strong>Install the Mainline Tool:</strong></p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-68-1"><a id="__codelineno-68-1" name="__codelineno-68-1" href="#__codelineno-68-1"></a><span class="c1"># add-apt-repository ppa:cappelikan/ppa</span>
</span><span id="__span-68-2"><a id="__codelineno-68-2" name="__codelineno-68-2" href="#__codelineno-68-2"></a><span class="c1"># apt update &amp;&amp; sudo apt install mainline</span>
</span></code></pre></div>
</li>
<li>
<p><strong>Generate a Signing Key (MOK):</strong></p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-69-1"><a id="__codelineno-69-1" name="__codelineno-69-1" href="#__codelineno-69-1"></a><span class="c1"># openssl req -new -x509 -newkey rsa:2048 -keyout MOK.priv -outform DER -out MOK.der -nodes -days 36500 -subj "/CN=Your Name/"</span>
</span><span id="__span-69-2"><a id="__codelineno-69-2" name="__codelineno-69-2" href="#__codelineno-69-2"></a><span class="c1"># mokutil --import MOK.der</span>
</span></code></pre></div>
<p>This will prompt for a password. After rebooting, this must be selected via
<strong>Enroll MOK</strong> in the blue <strong>MOKManager</strong> screen and enter the password.</p>
</li>
<li>
<p><strong>Install and Sign the Kernel:</strong></p>
<p>After installing a kernel via the <code>mainline</code> app, sign the <code>vmlinuz</code> binary:</p>
<p>Convert key to PEM for <code>sbsign</code></p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-70-1"><a id="__codelineno-70-1" name="__codelineno-70-1" href="#__codelineno-70-1"></a><span class="c1"># openssl x509 -in MOK.der -inform DER -outform PEM -out MOK.pem</span>
</span></code></pre></div>
<p>Sign the kernel (<strong>replace <code>[VERSION]</code></strong>)</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-71-1"><a id="__codelineno-71-1" name="__codelineno-71-1" href="#__codelineno-71-1"></a><span class="c1"># sbsign --key MOK.priv --cert MOK.pem /boot/vmlinuz-[VERSION]-generic --output /boot/vmlinuz-[VERSION]-generic.signed</span>
</span></code></pre></div>
<p>Overwrite the original kernel with the signed version</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-72-1"><a id="__codelineno-72-1" name="__codelineno-72-1" href="#__codelineno-72-1"></a><span class="c1"># mv /boot/vmlinuz-[VERSION]-generic.signed /boot/vmlinuz-[VERSION]-generic</span>
</span><span id="__span-72-2"><a id="__codelineno-72-2" name="__codelineno-72-2" href="#__codelineno-72-2"></a><span class="c1"># update-grub</span>
</span></code></pre></div>
</li>
</ol>
</li>
</ol>
</details>
<p>The easiest method turned out to be a good solution; install the HWE kernel:</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-73-1"><a id="__codelineno-73-1" name="__codelineno-73-1" href="#__codelineno-73-1"></a><span class="gp"># </span>apt<span class="w"> </span>install<span class="w"> </span>linux-generic-hwe-24.04<span class="w"> </span>-y
</span></code></pre></div>
<p>In case the new kernel does not become the new default, adjust <code>/etc/default/grub</code> so
that it will show the menu to allow choosing a specific kernel and then remember that
choice as the default for subsequent reboots:</p>
<div class="language-ini highlight"><span class="filename">/etc/default/grub</span><pre><span></span><code><span id="__span-74-1"><a id="__codelineno-74-1" name="__codelineno-74-1" href="#__codelineno-74-1"></a><span class="na">GRUB_DEFAULT</span><span class="o">=</span><span class="s">saved</span>
</span><span id="__span-74-2"><a id="__codelineno-74-2" name="__codelineno-74-2" href="#__codelineno-74-2"></a><span class="na">GRUB_SAVEDEFAULT</span><span class="o">=</span><span class="s">true</span>
</span><span id="__span-74-3"><a id="__codelineno-74-3" name="__codelineno-74-3" href="#__codelineno-74-3"></a><span class="na">GRUB_TIMEOUT_STYLE</span><span class="o">=</span><span class="s">menu</span>
</span><span id="__span-74-4"><a id="__codelineno-74-4" name="__codelineno-74-4" href="#__codelineno-74-4"></a><span class="na">GRUB_TIMEOUT</span><span class="o">=</span><span class="s">10</span>
</span><span id="__span-74-5"><a id="__codelineno-74-5" name="__codelineno-74-5" href="#__codelineno-74-5"></a><span class="na">GRUB_DISTRIBUTOR</span><span class="o">=</span><span class="s">`( . /etc/os-release</span><span class="c1">; echo ${NAME:-Ubuntu} ) 2&gt;/dev/null || echo Ubuntu`</span>
</span><span id="__span-74-6"><a id="__codelineno-74-6" name="__codelineno-74-6" href="#__codelineno-74-6"></a><span class="na">GRUB_CMDLINE_LINUX_DEFAULT</span><span class="o">=</span><span class="s">"quiet splash i915.force_probe=a720 intel_iommu=igfx_off"</span>
</span><span id="__span-74-7"><a id="__codelineno-74-7" name="__codelineno-74-7" href="#__codelineno-74-7"></a><span class="na">GRUB_CMDLINE_LINUX</span><span class="o">=</span><span class="s">""</span>
</span></code></pre></div>
<p>Update GRUB and restart, then choose the new kernel.</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-75-1"><a id="__codelineno-75-1" name="__codelineno-75-1" href="#__codelineno-75-1"></a><span class="gp"># </span>vi<span class="w"> </span>/etc/default/grub
</span><span id="__span-75-2"><a id="__codelineno-75-2" name="__codelineno-75-2" href="#__codelineno-75-2"></a><span class="gp"># </span>update-grub
</span><span id="__span-75-3"><a id="__codelineno-75-3" name="__codelineno-75-3" href="#__codelineno-75-3"></a><span class="go">Sourcing file `/etc/default/grub'</span>
</span><span id="__span-75-4"><a id="__codelineno-75-4" name="__codelineno-75-4" href="#__codelineno-75-4"></a><span class="go">Sourcing file `/etc/default/grub.d/trace.cfg'</span>
</span><span id="__span-75-5"><a id="__codelineno-75-5" name="__codelineno-75-5" href="#__codelineno-75-5"></a><span class="go">Sourcing file `/etc/default/grub.d/ubuntustudio.cfg'</span>
</span><span id="__span-75-6"><a id="__codelineno-75-6" name="__codelineno-75-6" href="#__codelineno-75-6"></a><span class="go">Generating grub configuration file ...</span>
</span><span id="__span-75-7"><a id="__codelineno-75-7" name="__codelineno-75-7" href="#__codelineno-75-7"></a><span class="go">Found linux image: /boot/vmlinuz-6.8.0-90-lowlatency</span>
</span><span id="__span-75-8"><a id="__codelineno-75-8" name="__codelineno-75-8" href="#__codelineno-75-8"></a><span class="go">Found initrd image: /boot/initrd.img-6.8.0-90-lowlatency</span>
</span><span id="__span-75-9"><a id="__codelineno-75-9" name="__codelineno-75-9" href="#__codelineno-75-9"></a><span class="go">Found linux image: /boot/vmlinuz-6.14.0-37-generic</span>
</span><span id="__span-75-10"><a id="__codelineno-75-10" name="__codelineno-75-10" href="#__codelineno-75-10"></a><span class="go">Found initrd image: /boot/initrd.img-6.14.0-37-generic</span>
</span><span id="__span-75-11"><a id="__codelineno-75-11" name="__codelineno-75-11" href="#__codelineno-75-11"></a><span class="go">Found memtest86+ 64bit EFI image: /boot/memtest86+x64.efi</span>
</span><span id="__span-75-12"><a id="__codelineno-75-12" name="__codelineno-75-12" href="#__codelineno-75-12"></a><span class="go">Warning: os-prober will not be executed to detect other bootable partitions.</span>
</span><span id="__span-75-13"><a id="__codelineno-75-13" name="__codelineno-75-13" href="#__codelineno-75-13"></a><span class="go">Systems on them will not be added to the GRUB boot configuration.</span>
</span><span id="__span-75-14"><a id="__codelineno-75-14" name="__codelineno-75-14" href="#__codelineno-75-14"></a><span class="go">Check GRUB_DISABLE_OS_PROBER documentation entry.</span>
</span><span id="__span-75-15"><a id="__codelineno-75-15" name="__codelineno-75-15" href="#__codelineno-75-15"></a><span class="go">Adding boot menu entry for UEFI Firmware Settings ...</span>
</span><span id="__span-75-16"><a id="__codelineno-75-16" name="__codelineno-75-16" href="#__codelineno-75-16"></a><span class="go">done</span>
</span></code></pre></div>
<p>To make the new kernel the all-time default, set <code>GRUB_DEFAULT</code> to the index number
of the desired option as obtained from <code>/boot/grub/grub.cfg</code></p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-76-1"><a id="__codelineno-76-1" name="__codelineno-76-1" href="#__codelineno-76-1"></a><span class="gp"># </span>awk<span class="w"> </span>-F<span class="s2">"'"</span><span class="w"> </span><span class="s1">'/menuentry / &amp;&amp; /with Linux/ {print i++ " : " $2}'</span><span class="w"> </span>/boot/grub/grub.cfg
</span><span id="__span-76-2"><a id="__codelineno-76-2" name="__codelineno-76-2" href="#__codelineno-76-2"></a><span class="go">0 : Ubuntu, with Linux 6.8.0-90-lowlatency</span>
</span><span id="__span-76-3"><a id="__codelineno-76-3" name="__codelineno-76-3" href="#__codelineno-76-3"></a><span class="go">1 : Ubuntu, with Linux 6.8.0-90-lowlatency (recovery mode)</span>
</span><span id="__span-76-4"><a id="__codelineno-76-4" name="__codelineno-76-4" href="#__codelineno-76-4"></a><span class="go">2 : Ubuntu, with Linux 6.14.0-37-generic</span>
</span><span id="__span-76-5"><a id="__codelineno-76-5" name="__codelineno-76-5" href="#__codelineno-76-5"></a><span class="go">3 : Ubuntu, with Linux 6.14.0-37-generic (recovery mode)</span>
</span></code></pre></div>







  
  



  


  



<script src="https://giscus.app/client.js" data-repo="stibbons1990/hex" data-repo-id="R_kgDOKXTsSg" data-category="Announcements" data-category-id="DIC_kwDOKXTsSs4CqHDX" data-mapping="pathname" data-strict="0" data-reactions-enabled="1" data-emit-metadata="1" data-input-position="top" data-theme="preferred_color_scheme" data-lang="en" crossorigin="anonymous" async>
</script>

      
    </article>
  </div>

          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"></path></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
    
      
        
      
      <nav class="md-footer__inner md-grid" aria-label="Footer">
        
          
          <a href="../../03/ubuntu-studio-2404-on-rapture-gaming-pc-and-more/" class="md-footer__link md-footer__link--prev" aria-label="Previous: Ubuntu Studio 24.04 on Rapture, Gaming PC (and more)">
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"></path></svg>
            </div>
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Previous
              </span>
              <div class="md-ellipsis">
                Ubuntu Studio 24.04 on Rapture, Gaming PC (and more)
              </div>
            </div>
          </a>
        
        
          
          <a href="../../../12/03/starting-a-blog-with-mkdocs-material-on-github-pages/" class="md-footer__link md-footer__link--next" aria-label="Next: Starting a blog with mkdocs-material on GitHub pages">
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Next
              </span>
              <div class="md-ellipsis">
                Starting a blog with mkdocs-material on GitHub pages
              </div>
            </div>
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11z"></path></svg>
            </div>
          </a>
        
      </nav>
    
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright © 2019-2025 Ponder Stibbons
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      
      <script id="__config" type="application/json">{"annotate": null, "base": "../../../../..", "features": ["content.code.copy", "navigation.expand", "navigation.footer", "navigation.top", "search.highlight", "search.suggest"], "search": "../../../../../assets/javascripts/workers/search.2c215733.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../../../../assets/javascripts/bundle.79ae519e.min.js"></script>
      
    
  
<script id="init-glightbox">const lightbox = GLightbox({"touchNavigation": true, "loop": false, "zoomable": true, "draggable": true, "openEffect": "zoom", "closeEffect": "zoom", "slideEffect": "slide"});
document$.subscribe(()=>{ lightbox.reload(); });
</script></body></html>