<!DOCTYPE html><html lang="en" class="no-js"><head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://stibbons1990.github.io/hex/blog/2024/12/28/continuous-monitoring-for-tp-link-tapo-devices/">
      
      
        <link rel="prev" href="../../27/ubuntu-studio-2404-on-raven-gaming-pc-and-more/">
      
      
        <link rel="next" href="../../31/migrating-unifi-controller-to-kubernetes/">
      
      
        
      
      
      <link rel="icon" href="../../../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.7.1">
    
    
      
        <title>Continuous Monitoring for TP-Link Tapo devices - Inadvisably Applied Magic</title>
      
    
    
      <link rel="stylesheet" href="../../../../../assets/stylesheets/main.484c7ddc.min.css">
      
        
        <link rel="stylesheet" href="../../../../../assets/stylesheets/palette.ab4e12ef.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&amp;display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../../../../stylesheets/extra.css">
    
    <script>__md_scope=new URL("../../../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      
  


  
  

<script id="__analytics">function __md_analytics(){function e(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],e("js",new Date),e("config","G-Y167L3ZVGY"),document.addEventListener("DOMContentLoaded",(function(){document.forms.search&&document.forms.search.query.addEventListener("blur",(function(){this.value&&e("event","search",{search_term:this.value})}));document$.subscribe((function(){var t=document.forms.feedback;if(void 0!==t)for(var a of t.querySelectorAll("[type=submit]"))a.addEventListener("click",(function(a){a.preventDefault();var n=document.location.pathname,d=this.getAttribute("data-md-value");e("event","feedback",{page:n,data:d}),t.firstElementChild.disabled=!0;var r=t.querySelector(".md-feedback__note [data-md-value='"+d+"']");r&&(r.hidden=!1)})),t.hidden=!1})),location$.subscribe((function(t){e("config","G-Y167L3ZVGY",{page_path:t.pathname})}))}));var t=document.createElement("script");t.async=!0,t.src="https://www.googletagmanager.com/gtag/js?id=G-Y167L3ZVGY",document.getElementById("__analytics").insertAdjacentElement("afterEnd",t)}</script>
  
    <script>"undefined"!=typeof __md_analytics&&__md_analytics()</script>
  

    
    
  <link href="../../../../../assets/stylesheets/glightbox.min.css" rel="stylesheet"><script src="../../../../../assets/javascripts/glightbox.min.js"></script><style id="glightbox-style">
            html.glightbox-open { overflow: initial; height: 100%; }
            .gslide-title { margin-top: 0px; user-select: text; }
            .gslide-desc { color: #666; user-select: text; }
            .gslide-image img { background: white; }
            .gscrollbar-fixer { padding-right: 15px; }
            .gdesc-inner { font-size: 0.75rem; }
            body[data-md-color-scheme="slate"] .gdesc-inner { background: var(--md-default-bg-color); }
            body[data-md-color-scheme="slate"] .gslide-title { color: var(--md-default-fg-color); }
            body[data-md-color-scheme="slate"] .gslide-desc { color: var(--md-default-fg-color); }
        </style></head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="slate" data-md-color-primary="deep-purple" data-md-color-accent="green">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#monitoring-for-tapo-devices" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../../../.." title="Inadvisably Applied Magic" class="md-header__button md-logo" aria-label="Inadvisably Applied Magic" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="m64 400 85.7-208.2c17-41.3 47.8-75.3 87.2-96.3l146.9-78.3c12.3-6.6 26.5 4.7 23 18.2l-37.2 142.4c-1.1 4.1-1.6 8.3-1.6 12.6 0 6.3 1.2 12.6 3.6 18.5L448 400H240.9l11.8-35.4 40.4-13.5c6.5-2.2 10.9-8.3 10.9-15.2s-4.4-13-10.9-15.2l-40.4-13.5-13.5-40.4c-2.2-6.4-8.3-10.8-15.2-10.8s-13 4.4-15.2 10.9l-13.5 40.4-40.4 13.5c-6.5 2.2-10.9 8.3-10.9 15.2s4.4 13 10.9 15.2l40.4 13.5 11.8 35.4H64zm215.6-258.5c-1.1-3.3-4.1-5.5-7.6-5.5s-6.5 2.2-7.6 5.5l-6.7 20.2-20.2 6.7c-3.3 1.1-5.5 4.1-5.5 7.6s2.2 6.5 5.5 7.6l20.2 6.7 6.7 20.2c1.1 3.3 4.1 5.5 7.6 5.5s6.5-2.2 7.6-5.5l6.7-20.2 20.2-6.7c3.3-1.1 5.5-4.1 5.5-7.6s-2.2-6.5-5.5-7.6l-20.2-6.7zM32 448h448c17.7 0 32 14.3 32 32s-14.3 32-32 32H32c-17.7 0-32-14.3-32-32s14.3-32 32-32"></path></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"></path></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Inadvisably Applied Magic
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Continuous Monitoring for TP-Link Tapo devices
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="deep-purple" data-md-color-accent="green" aria-label="Dark mode" type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 7a5 5 0 0 1 5 5 5 5 0 0 1-5 5 5 5 0 0 1-5-5 5 5 0 0 1 5-5m0 2a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3m0-7 2.39 3.42C13.65 5.15 12.84 5 12 5s-1.65.15-2.39.42zM3.34 7l4.16-.35A7.2 7.2 0 0 0 5.94 8.5c-.44.74-.69 1.5-.83 2.29zm.02 10 1.76-3.77a7.131 7.131 0 0 0 2.38 4.14zM20.65 7l-1.77 3.79a7.02 7.02 0 0 0-2.38-4.15zm-.01 10-4.14.36c.59-.51 1.12-1.14 1.54-1.86.42-.73.69-1.5.83-2.29zM12 22l-2.41-3.44c.74.27 1.55.44 2.41.44.82 0 1.63-.17 2.37-.44z"></path></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="deep-purple" data-md-color-accent="green" aria-label="Light mode" type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m17.75 4.09-2.53 1.94.91 3.06-2.63-1.81-2.63 1.81.91-3.06-2.53-1.94L12.44 4l1.06-3 1.06 3zm3.5 6.91-1.64 1.25.59 1.98-1.7-1.17-1.7 1.17.59-1.98L15.75 11l2.06-.05L18.5 9l.69 1.95zm-2.28 4.95c.83-.08 1.72 1.1 1.19 1.85-.32.45-.66.87-1.08 1.27C15.17 23 8.84 23 4.94 19.07c-3.91-3.9-3.91-10.24 0-14.14.4-.4.82-.76 1.27-1.08.75-.53 1.93.36 1.85 1.19-.27 2.86.69 5.83 2.89 8.02a9.96 9.96 0 0 0 8.02 2.89m-1.64 2.02a12.08 12.08 0 0 1-7.8-3.47c-2.17-2.19-3.33-5-3.49-7.82-2.81 3.14-2.7 7.96.31 10.98 3.02 3.01 7.84 3.12 10.98.31"></path></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"></path></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"></path></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"></path></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"></path></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
                
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" hidden>
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../../../.." title="Inadvisably Applied Magic" class="md-nav__button md-logo" aria-label="Inadvisably Applied Magic" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="m64 400 85.7-208.2c17-41.3 47.8-75.3 87.2-96.3l146.9-78.3c12.3-6.6 26.5 4.7 23 18.2l-37.2 142.4c-1.1 4.1-1.6 8.3-1.6 12.6 0 6.3 1.2 12.6 3.6 18.5L448 400H240.9l11.8-35.4 40.4-13.5c6.5-2.2 10.9-8.3 10.9-15.2s-4.4-13-10.9-15.2l-40.4-13.5-13.5-40.4c-2.2-6.4-8.3-10.8-15.2-10.8s-13 4.4-15.2 10.9l-13.5 40.4-40.4 13.5c-6.5 2.2-10.9 8.3-10.9 15.2s4.4 13 10.9 15.2l40.4 13.5 11.8 35.4H64zm215.6-258.5c-1.1-3.3-4.1-5.5-7.6-5.5s-6.5 2.2-7.6 5.5l-6.7 20.2-20.2 6.7c-3.3 1.1-5.5 4.1-5.5 7.6s2.2 6.5 5.5 7.6l20.2 6.7 6.7 20.2c1.1 3.3 4.1 5.5 7.6 5.5s6.5-2.2 7.6-5.5l6.7-20.2 20.2-6.7c3.3-1.1 5.5-4.1 5.5-7.6s-2.2-6.5-5.5-7.6l-20.2-6.7zM32 448h448c17.7 0 32 14.3 32 32s-14.3 32-32 32H32c-17.7 0-32-14.3-32-32s14.3-32 32-32"></path></svg>

    </a>
    Inadvisably Applied Magic
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    About This Place
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_2">
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Projects
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    Projects
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../projects/conmon/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Continuous Monitoring
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../projects/self-hosting/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Self-hosting
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      <a href="../../../../" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Unexpected Linux Adventures
  

    
  </span>
  
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
                
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#monitoring-for-tapo-devices" class="md-nav__link">
    <span class="md-ellipsis">
      
        Monitoring for Tapo devices
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Monitoring for Tapo devices">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#smart-actions" class="md-nav__link">
    <span class="md-ellipsis">
      
        Smart Actions
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#implementation" class="md-nav__link">
    <span class="md-ellipsis">
      
        Implementation
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Implementation">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#failing-gracefully" class="md-nav__link">
    <span class="md-ellipsis">
      
        Failing gracefully
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#always-on-appliances" class="md-nav__link">
    <span class="md-ellipsis">
      
        Always-on appliances
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#rarely-on-appliances" class="md-nav__link">
    <span class="md-ellipsis">
      
        Rarely-on appliances
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Rarely-on appliances">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#adjustable-appliances" class="md-nav__link">
    <span class="md-ellipsis">
      
        Adjustable appliances
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#a-more-long-term-database" class="md-nav__link">
    <span class="md-ellipsis">
      
        A more long-term database
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="A more long-term database">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#copy-measurements-over" class="md-nav__link">
    <span class="md-ellipsis">
      
        Copy measurements over
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#import-older-historical-data" class="md-nav__link">
    <span class="md-ellipsis">
      
        Import older historical data
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#future-improvements" class="md-nav__link">
    <span class="md-ellipsis">
      
        Future improvements
      
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
  <div class="md-content md-content--post" data-md-component="content">
    <div class="md-sidebar md-sidebar--post" data-md-component="sidebar" data-md-type="navigation">
      <div class="md-sidebar__scrollwrap">
        <div class="md-sidebar__inner md-post">
          <nav class="md-nav md-nav--primary">
            <div class="md-post__back">
              <div class="md-nav__title md-nav__container">
                <a href="../../../../" class="md-nav__link">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"></path></svg>
                  <span class="md-ellipsis">
                    Back to index
                  </span>
                </a>
              </div>
            </div>
            
            <ul class="md-post__meta md-nav__list">
              <li class="md-nav__item md-nav__item--section">
                <div class="md-post__title">
                  <span class="md-ellipsis">
                    Metadata
                  </span>
                </div>
                <nav class="md-nav">
                  <ul class="md-nav__list">
                    <li class="md-nav__item">
                      <div class="md-nav__link">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 19H5V8h14m-3-7v2H8V1H6v2H5c-1.11 0-2 .89-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V5a2 2 0 0 0-2-2h-1V1m-1 11h-5v5h5z"></path></svg>
                        <time datetime="2024-12-28 00:00:00+00:00" class="md-ellipsis">December 28, 2024</time>
                      </div>
                    </li>
                    
                    
                      <li class="md-nav__item">
                        <div class="md-nav__link">
                          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9 3v15h3V3zm3 2 4 13 3-1-4-13zM5 5v13h3V5zM3 19v2h18v-2z"></path></svg>
                          <span class="md-ellipsis">
                            in
                            
                              <a href="../../../../category/monitoring/">monitoring</a>, 
                              <a href="../../../../category/python/">python</a>, 
                              <a href="../../../../category/tapo/">tapo</a></span>
                        </div>
                      </li>
                    
                    
                      
                      <li class="md-nav__item">
                        <div class="md-nav__link">
                          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 20a8 8 0 0 0 8-8 8 8 0 0 0-8-8 8 8 0 0 0-8 8 8 8 0 0 0 8 8m0-18a10 10 0 0 1 10 10 10 10 0 0 1-10 10C6.47 22 2 17.5 2 12A10 10 0 0 1 12 2m.5 5v5.25l4.5 2.67-.75 1.23L11 13V7z"></path></svg>
                          <span class="md-ellipsis">
                            
                              10 min read
                            
                          </span>
                        </div>
                      </li>
                    
                  </ul>
                </nav>
              </li>
            </ul>
            
          </nav>
          
        </div>
      </div>
    </div>
    <article class="md-content__inner md-typeset">
      
        
  




  <h1>Continuous Monitoring for TP-Link Tapo devices</h1>

<p>In an old house with aging electrical wiring and a limited power contract, keeping power
consumption in check is quite necessary and can be a bit of a challenge. Some appliances are
very power-hungry for short periods of time, at unpredictable times throughout the day,
while others are running constantly and add up to a baseline that quietly takes a chunk
of the power budget.</p>
<p>A decent way to keep an eye on power consumption is offered by the
<a href="https://www.tapo.com/en/">TP-Link Tapo</a> line of products, in particular their smart plugs
with energy monitoring and temperature and humidity sensors. These devices are relatively
easy to setup, reliable, discrete and not too expensive... although they do add up <em>fast</em>!</p>
<p>For all the smart features in these devices and the companion app, there is no way to
have a panoramic view of <em>aggregated</em> power consumption broken down by device, or to
configure thresholds based on the <em>aggregated</em> power consumption from all appliances.
Such panoramic view was not hard to implement by building on the
<a href="../../../../../projects/conmon/">Continuous Monitoring</a> solution previously built for monigoring
computing resources (already monitoring temperatures and power consumption).</p>
<p><a class="glightbox" data-type="image" data-width="auto" data-height="auto" href="../../../../media/2024-12-28-continuous-monitoring-for-tp-link-tapo-devices/tapo-monitoring-grafana-dashboard.png" data-desc-position="bottom"><img alt="Monitoring dashboard for Tapo devices showing current and historic power use and temperatures" src="../../../../media/2024-12-28-continuous-monitoring-for-tp-link-tapo-devices/tapo-monitoring-grafana-dashboard.png"></a></p>
<!-- more -->

<h2 id="monitoring-for-tapo-devices">Monitoring for Tapo devices</h2>
<p>Monitoring of these devices can be implemented, at least in Rust or Python, using the
Unofficial Tapo API Client at
<a href="https://github.com/mihai-dinculescu/tapo/?tab=readme-ov-file#tapo">github.com/mihai-dinculescu/tapo</a>.
This library has been tested with many devices, including all those already in use in
this house and those that may be used in the future:</p>
<ul>
<li><a href="https://www.tapo.com/en/product/smart-hub/tapo-h100/">H100</a>
    <em>Smart Hub with Chime</em> located in the office, where its powered by an UPS
    for 24x7 availability and <em>very conveniently</em> close to me, so I can hear it chime. </li>
<li><a href="https://www.tapo.com/en/product/smart-sensor/tapo-t100/v1/">T100</a>
    <em>Smart Motion Sensor</em> hanging around the front door, to alert me when someone is
    coming up the house, in case I don't hear the bell.</li>
<li><a href="https://www.tapo.com/en/product/smart-sensor/tapo-t310/v1/">T310</a>
    <em>Smart Temperature &amp; Humidity Sensor</em>, needed in most rooms around the house,
    because in a house with multiple floors and different exposure to sun and wind,
    temperature and humidity <em>do</em> vary greatly across rooms.</li>
<li><a href="https://www.tapo.com/en/product/smart-plug/tapo-p100/v1/">P100</a>
    <em>Mini Smart Wi-Fi Socket</em> <strong>without</strong> <em>Energy Monitoring</em>, ordered by mistake
    and not yet of great use; there are no low-power appliances wanting remote control.</li>
<li><a href="https://www.tapo.com/en/product/smart-plug/tapo-p110/v1/">P110</a>
    <em>Mini Smart Wi-Fi Socket, Energy Monitoring</em>, slightly cheaper and bulkier than...</li>
<li><a href="https://www.tapo.com/en/product/smart-plug/tapo-p115/v1/">P115</a>
    <em>Mini Smart Wi-Fi Socket, Energy Monitoring</em>, by far my favorite monitoring and
    remote control device, slightly more expensive than the P110 but fits <em>anywhere</em>.</li>
<li><a href="https://www.tp-link.com/uk/home-networking/smart-plug/tapo-p304m/">P304M</a>
    <em>Smart Wi-Fi Power Strip, Energy Monitoring</em>, apparently only available in the UK
    as of the end of 2024 but hopefully available in more regions soon. This would make
    a great replacement for P110/P115 devices in a few places where multiple appliances
    require separate remote control.</li>
<li><a href="https://www.tapo.com/en/product/smart-light-bulb/tapo-l900-5/">L900-5</a>
    <em>Smart Wi-Fi Light Strip (5 m.)</em>, or maybe even</li>
<li><a href="https://www.tapo.com/en/product/smart-light-bulb/tapo-l930-5/">L930-5</a>
    <em>Smart Wi-Fi Light Strip, Multicolor</em> may be the one to brighten up my office. </li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The Python library under 
<a href="https://github.com/mihai-dinculescu/tapo/tree/main/tapo-py"><code>tapo-py</code></a> does not
(yet) support a few interesting features of the
<a href="https://www.tapo.com/en/product/smart-hub/tapo-h100/">H100</a>
<em>Smart Hub with Chime</em>, namely those that would allow sounding (and stopping) alarms.</p>
</div>
<p>The Python library can be installed via <code>pip</code>, along with a couple of other
<a href="../../../../../projects/conmon/#python-dependencies">Python dependencies</a>.</p>
<h3 id="smart-actions">Smart Actions</h3>
<p>The companion app supports creating <em>Smart Actions</em> to make these devices work together,
such as making the hub sound an alarm when the motion sensor is triggered, or turning a
plug on/off when the temperature and/or humidity in a room crosses a threshold.</p>
<p>Although this is not connected directly with the monitoring of power consumption,
it inspires me to think of <em>smart</em><em>er</em><em> actions</em>:</p>
<ul>
<li>Turn off the boilder if total power use exceeds a threshold, so the total power
    consumption won't exceed the limited power contract.</li>
<li>Sound a chime when power consumption from an appliance matches a specific pattern,
    this can be used to detect when the washing machine has finished.</li>
<li>Sound an alarm when total power consumption crosses a threshold, because this can
    <em>and does</em> happen surprisingly often (a few times per day).</li>
</ul>
<p>These may lead me to go down the rabbit hole of
<a href="https://www.home-assistant.io/">Home Assistant</a>, although support for Tapo devices in
the <a href="https://www.home-assistant.io/integrations/tplink">TP-Link Smart Home</a> integration
seems to be missing all sensors, those are supported only by a separate integration at
<a href="https://github.com/petretiandrea/home-assistant-tapo-p100">github.com/petretiandrea/home-assistant-tapo-p100</a>.</p>
<h2 id="implementation">Implementation</h2>
<p>Tapo devices sample values every 2 seconds, although this is only clearly advertised
for the temperature and humidity sensors. However, for a simple start, sampling once
per minute will be enough and makes it possible to run the monitoring script simply
from root's crontab:</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="gp">root@raven:~# </span>crontab<span class="w"> </span>-l
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a><span class="gp"># </span>m<span class="w"> </span>h<span class="w">  </span>dom<span class="w"> </span>mon<span class="w"> </span>dow<span class="w">   </span><span class="nb">command</span>
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a><span class="go">  * * * * * /usr/local/bin/conmon-tapo.py</span>
</span></code></pre></div>
<p>Thus the <a href="../../../../../projects/conmon/#conmon-tapopy"><code>conmon-tapo.py</code></a> script reports
temperature, humidity and power use every minute, for those devices listed in the a
configuration file like <a href="../../../../../projects/conmon/#tapoyaml"><code>tapo.yaml</code></a>.</p>
<p>The code is based on several Python examples under
<a href="https://github.com/mihai-dinculescu/tapo/tree/main/tapo-py/examples"><code>tapo-py/examples</code></a>,
in particular:</p>
<ul>
<li><a href="https://github.com/mihai-dinculescu/tapo/blob/main/tapo-py/examples/tapo_h100.py#L21"><code>get_child_device_list()</code></a>
    to get the list of devices paired with a hub, e.g. temperature and humidity sensors.</li>
<li><a href="https://github.com/mihai-dinculescu/tapo/blob/main/tapo-py/examples/tapo_h100.py#L87C55-L87C87"><code>get_temperature_humidity_records()</code></a>
    to get values from temperature and humidity sensors.</li>
<li><a href="https://github.com/mihai-dinculescu/tapo/blob/main/tapo-py/examples/tapo_p110.py#L34"><code>get_current_power()</code></a>
    to get values from smart plugs with energy monitoring.</li>
</ul>
<p><a href="../../../../../projects/conmon/#conmon-tapopy"><code>conmon-tapo.py</code></a> runs through 4 steps each time:</p>
<ol>
<li>Load a list of devices (with IP addresses) and other settings from a configuration file.</li>
<li>Poll the devices for their latest values. Skip those that are unreadable.</li>
<li>Synthesize measurements for <em>fake</em> devices; as encoded in the configuration file.</li>
<li>Post measurements to an InfluxDB server,
    <a href="../../../../../projects/conmon/#__codelineno-11-114">tagged with the hostname</a> to
    differentiate devices across sites.</li>
</ol>
<p>The tapo app allows creating multiple "homes" and "rooms" to track the location of
each device, but these attributes are not included in the device information returned
by <code>get_device_info()</code>.</p>
<details class="json">
<summary>Expand to see an example <code>device_info</code> result.</summary>
<div class="language-json highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a><span class="err">Device</span><span class="w"> </span><span class="err">i</span><span class="kc">nf</span><span class="err">o</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a><span class="w">    </span><span class="nt">"at_low_battery"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span>
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a><span class="w">    </span><span class="nt">"avatar"</span><span class="p">:</span><span class="w"> </span><span class="s2">"balcony"</span><span class="p">,</span>
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4" href="#__codelineno-1-4"></a><span class="w">    </span><span class="nt">"bind_count"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span>
</span><span id="__span-1-5"><a id="__codelineno-1-5" name="__codelineno-1-5" href="#__codelineno-1-5"></a><span class="w">    </span><span class="nt">"category"</span><span class="p">:</span><span class="w"> </span><span class="s2">"subg.trigger.temp-hmdt-sensor"</span><span class="p">,</span>
</span><span id="__span-1-6"><a id="__codelineno-1-6" name="__codelineno-1-6" href="#__codelineno-1-6"></a><span class="w">    </span><span class="nt">"current_humidity"</span><span class="p">:</span><span class="w"> </span><span class="mi">81</span><span class="p">,</span>
</span><span id="__span-1-7"><a id="__codelineno-1-7" name="__codelineno-1-7" href="#__codelineno-1-7"></a><span class="w">    </span><span class="nt">"current_humidity_exception"</span><span class="p">:</span><span class="w"> </span><span class="mi">21</span><span class="p">,</span>
</span><span id="__span-1-8"><a id="__codelineno-1-8" name="__codelineno-1-8" href="#__codelineno-1-8"></a><span class="w">    </span><span class="nt">"current_temp"</span><span class="p">:</span><span class="w"> </span><span class="mf">13.199999809265137</span><span class="p">,</span>
</span><span id="__span-1-9"><a id="__codelineno-1-9" name="__codelineno-1-9" href="#__codelineno-1-9"></a><span class="w">    </span><span class="nt">"current_temp_exception"</span><span class="p">:</span><span class="w"> </span><span class="mf">-6.800000190734863</span><span class="p">,</span>
</span><span id="__span-1-10"><a id="__codelineno-1-10" name="__codelineno-1-10" href="#__codelineno-1-10"></a><span class="w">    </span><span class="nt">"device_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"802EB916B90AEB800E30246DF68C303322310766"</span><span class="p">,</span>
</span><span id="__span-1-11"><a id="__codelineno-1-11" name="__codelineno-1-11" href="#__codelineno-1-11"></a><span class="w">    </span><span class="nt">"fw_ver"</span><span class="p">:</span><span class="w"> </span><span class="s2">"1.5.0 Build 230105 Rel.150707"</span><span class="p">,</span>
</span><span id="__span-1-12"><a id="__codelineno-1-12" name="__codelineno-1-12" href="#__codelineno-1-12"></a><span class="w">    </span><span class="nt">"hw_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2AE1228C7CE042A310FC70EA70D7A788"</span><span class="p">,</span>
</span><span id="__span-1-13"><a id="__codelineno-1-13" name="__codelineno-1-13" href="#__codelineno-1-13"></a><span class="w">    </span><span class="nt">"hw_ver"</span><span class="p">:</span><span class="w"> </span><span class="s2">"1.0"</span><span class="p">,</span>
</span><span id="__span-1-14"><a id="__codelineno-1-14" name="__codelineno-1-14" href="#__codelineno-1-14"></a><span class="w">    </span><span class="nt">"jamming_rssi"</span><span class="p">:</span><span class="w"> </span><span class="mi">-116</span><span class="p">,</span>
</span><span id="__span-1-15"><a id="__codelineno-1-15" name="__codelineno-1-15" href="#__codelineno-1-15"></a><span class="w">    </span><span class="nt">"jamming_signal_level"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span>
</span><span id="__span-1-16"><a id="__codelineno-1-16" name="__codelineno-1-16" href="#__codelineno-1-16"></a><span class="w">    </span><span class="nt">"lastOnboardingTimestamp"</span><span class="p">:</span><span class="w"> </span><span class="mi">1723047115</span><span class="p">,</span>
</span><span id="__span-1-17"><a id="__codelineno-1-17" name="__codelineno-1-17" href="#__codelineno-1-17"></a><span class="w">    </span><span class="nt">"mac"</span><span class="p">:</span><span class="w"> </span><span class="s2">"98254A51E05C"</span><span class="p">,</span>
</span><span id="__span-1-18"><a id="__codelineno-1-18" name="__codelineno-1-18" href="#__codelineno-1-18"></a><span class="w">    </span><span class="nt">"nickname"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Exterior"</span><span class="p">,</span>
</span><span id="__span-1-19"><a id="__codelineno-1-19" name="__codelineno-1-19" href="#__codelineno-1-19"></a><span class="w">    </span><span class="nt">"oem_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"02F7CFFC203A7E622F6EA84BBB74C68F"</span><span class="p">,</span>
</span><span id="__span-1-20"><a id="__codelineno-1-20" name="__codelineno-1-20" href="#__codelineno-1-20"></a><span class="w">    </span><span class="nt">"parent_device_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"802D84BECDA15417AA1BD7CF881AEE6622451CF8"</span><span class="p">,</span>
</span><span id="__span-1-21"><a id="__codelineno-1-21" name="__codelineno-1-21" href="#__codelineno-1-21"></a><span class="w">    </span><span class="nt">"region"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Europe/Madrid"</span><span class="p">,</span>
</span><span id="__span-1-22"><a id="__codelineno-1-22" name="__codelineno-1-22" href="#__codelineno-1-22"></a><span class="w">    </span><span class="nt">"report_interval"</span><span class="p">:</span><span class="w"> </span><span class="mi">16</span><span class="p">,</span>
</span><span id="__span-1-23"><a id="__codelineno-1-23" name="__codelineno-1-23" href="#__codelineno-1-23"></a><span class="w">    </span><span class="nt">"rssi"</span><span class="p">:</span><span class="w"> </span><span class="mi">-86</span><span class="p">,</span>
</span><span id="__span-1-24"><a id="__codelineno-1-24" name="__codelineno-1-24" href="#__codelineno-1-24"></a><span class="w">    </span><span class="nt">"signal_level"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span>
</span><span id="__span-1-25"><a id="__codelineno-1-25" name="__codelineno-1-25" href="#__codelineno-1-25"></a><span class="w">    </span><span class="nt">"specs"</span><span class="p">:</span><span class="w"> </span><span class="s2">"EU"</span><span class="p">,</span>
</span><span id="__span-1-26"><a id="__codelineno-1-26" name="__codelineno-1-26" href="#__codelineno-1-26"></a><span class="w">    </span><span class="nt">"status"</span><span class="p">:</span><span class="w"> </span><span class="s2">"online"</span><span class="p">,</span>
</span><span id="__span-1-27"><a id="__codelineno-1-27" name="__codelineno-1-27" href="#__codelineno-1-27"></a><span class="w">    </span><span class="nt">"status_follow_edge"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span>
</span><span id="__span-1-28"><a id="__codelineno-1-28" name="__codelineno-1-28" href="#__codelineno-1-28"></a><span class="w">    </span><span class="nt">"temp_unit"</span><span class="p">:</span><span class="w"> </span><span class="s2">"celsius"</span><span class="p">,</span>
</span><span id="__span-1-29"><a id="__codelineno-1-29" name="__codelineno-1-29" href="#__codelineno-1-29"></a><span class="w">    </span><span class="nt">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"SMART.TAPOSENSOR"</span>
</span><span id="__span-1-30"><a id="__codelineno-1-30" name="__codelineno-1-30" href="#__codelineno-1-30"></a><span class="p">}</span>
</span></code></pre></div>
</details>
<h3 id="failing-gracefully">Failing gracefully</h3>
<p>The Python library relies on client applications to handle any and all exceptions,
which can sometimes lead to very crypt stack traces. See
<a href="../../../../../projects/conmon/#device-ip-dependencies">Device IP dependencies</a>
for those encountered so far, <em>Trying to read a P115 like it was an H100</em> produced a
particularly unique stack trace.</p>
<p>Such exceptions can be triggered by power loss (devide not reachable) or their IP
addresses changing (device refusing connection or causing other errors). Since all
those are events that <em>do</em> happen and not entirely under control, the script has a
very largey <code>try-expect-else</code> block to simply skip devices whenever fetching data fails.
If the device was only temporarly unavailable, its values will be fetched next time.</p>
<p>When devices have their IP address changed, it is necessary to update the configuration
files to update the relevant <code>devices[].ip</code> values. There is a feature request to
<a href="https://github.com/mihai-dinculescu/tapo/issues/208">Support client.getDeviceList</a>
so that devices can be detected when their IP addresses change; in the mean time,
<a href="https://github.com/mihai-dinculescu/tapo/issues/208#issuecomment-2173995264">this comment</a>
provides a few ideas to implement device discovery.</p>
<h3 id="always-on-appliances">Always-on appliances</h3>
<p>There are several appliances in the house that operate essentially 24x7 with a fairly
constant power consumption. A common example in humid climates are dehumidifiers running
constantly, with a power consumption typically between 150 and 300 W. Computers also have
relativly constant power consumption, except during periods of high CPU or GPU load.</p>
<p>Instead of having all these appliances <em>actually</em> monitored with a dedicated smart plug
with energy monitoring (P110 or P115), they can be <em>hard-coded</em> in the configuration
file under <code>always_on</code>.</p>
<p>This can be used for appliances that go on and off at regular intervals, such as a
refrigerator that runs the compressor for about 10 minutes every 20-30 minutes,
consuming about 80 W each time. This is only the low-power cycle to maintain the
internal temperature. When the refrigerator is not opened; the compressor will run
for a longer time and/or draw more power (about 400 W) when the refrigerator is
refilled with groceries that are not cold.</p>
<h3 id="rarely-on-appliances">Rarely-on appliances</h3>
<p>Smaller appliances that are used sporadically are not monitored at all, but they also
tend to be significantly power-hungry (especially in the kitchen). This is where the
<em>available power</em> metric comes in handy: substract the total current power consumption
from the contracted power rate, then compare this difference with what the appliance
will need.</p>
<p><em>What what will appliance X need?</em> This can be measured with one of the P110 or P115
plugs once or twice to get a reading of each of these appliance's <em>typical power needs</em>,
then a simple paper note stuck on the appliance with the number should serve as a reminder
to check whether there is currently enough power available.</p>
<h4 id="adjustable-appliances">Adjustable appliances</h4>
<p>Electric heaters, hair dryers and other power-hungry, adjustable appliances would need
a slightly bigger paper note stuck on them to indicate what their power consumption is
depending on each adjustable setting. Some appliances don't really need this though,
for instance a small toaster will draw the same power (e.g. 750 W) while it's on, its
adjustment changing only the <em>duration</em>.</p>
<p>This <em>should be practical enough</em> thanks to how well the dashboard shows on mobile screens: </p>
<p><a class="glightbox" data-type="image" data-width="auto" data-height="auto" href="../../../../media/2024-12-28-continuous-monitoring-for-tp-link-tapo-devices/tapo-monitoring-grafana-dashboard-on-phone.png" data-desc-position="bottom"><img alt="Monitoring dashboard for Tapo devices showing current and historic power use and temperatures" src="../../../../media/2024-12-28-continuous-monitoring-for-tp-link-tapo-devices/tapo-monitoring-grafana-dashboard-on-phone.png"></a></p>
<h2 id="a-more-long-term-database">A more long-term database</h2>
<p>InfluxDB database for <a href="../../../../../projects/conmon/">Continuous Monitoring</a> was set up with a
<a href="../../../04/20/monitoring-with-influxdb-and-grafana-on-kubernetes/#conmon-migration">`30 days retention policy</a>
which would not be enough to capture long-term trends from sensors data.
At times it was found also slightly too, a more generous 90 days should do nicely,
after all the current database takes only 1.3 GB of disk space.</p>
<p>For the monitoring of temperature, humidity and power consumption, create a new database
(e.g. <code>home</code>) with a much larger retention policy of <strong>5 years</strong>:</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a><span class="gp">$ </span>influx<span class="w"> </span>-host<span class="w"> </span>localhost<span class="w"> </span>-port<span class="w"> </span><span class="m">30086</span><span class="w"> </span>-username<span class="w"> </span>admin<span class="w"> </span>-password<span class="w"> </span>xxxxxxxxxx
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a><span class="go">Connected to http://localhost:30086 version 1.8.10</span>
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a><span class="go">InfluxDB shell version: 1.6.7~rc0</span>
</span><span id="__span-2-4"><a id="__codelineno-2-4" name="__codelineno-2-4" href="#__codelineno-2-4"></a>
</span><span id="__span-2-5"><a id="__codelineno-2-5" name="__codelineno-2-5" href="#__codelineno-2-5"></a><span class="go">&gt; CREATE DATABASE home</span>
</span><span id="__span-2-6"><a id="__codelineno-2-6" name="__codelineno-2-6" href="#__codelineno-2-6"></a><span class="go">&gt; USE home</span>
</span><span id="__span-2-7"><a id="__codelineno-2-7" name="__codelineno-2-7" href="#__codelineno-2-7"></a><span class="go">Using database home</span>
</span><span id="__span-2-8"><a id="__codelineno-2-8" name="__codelineno-2-8" href="#__codelineno-2-8"></a><span class="go">&gt; CREATE RETENTION POLICY "5_years" ON "home" DURATION 2000d REPLICATION 1</span>
</span><span id="__span-2-9"><a id="__codelineno-2-9" name="__codelineno-2-9" href="#__codelineno-2-9"></a><span class="go">&gt; ALTER RETENTION POLICY "5_years" on "home" DURATION 2000d REPLICATION 1 DEFAULT</span>
</span><span id="__span-2-10"><a id="__codelineno-2-10" name="__codelineno-2-10" href="#__codelineno-2-10"></a><span class="go">&gt; SHOW RETENTION POLICIES ON home</span>
</span><span id="__span-2-11"><a id="__codelineno-2-11" name="__codelineno-2-11" href="#__codelineno-2-11"></a><span class="go">name    duration   shardGroupDuration replicaN default</span>
</span><span id="__span-2-12"><a id="__codelineno-2-12" name="__codelineno-2-12" href="#__codelineno-2-12"></a><span class="go">----    --------   ------------------ -------- -------</span>
</span><span id="__span-2-13"><a id="__codelineno-2-13" name="__codelineno-2-13" href="#__codelineno-2-13"></a><span class="go">autogen 0s         168h0m0s           1        false</span>
</span><span id="__span-2-14"><a id="__codelineno-2-14" name="__codelineno-2-14" href="#__codelineno-2-14"></a><span class="go">5_years 48000h0m0s 168h0m0s           1        true</span>
</span><span id="__span-2-15"><a id="__codelineno-2-15" name="__codelineno-2-15" href="#__codelineno-2-15"></a>
</span><span id="__span-2-16"><a id="__codelineno-2-16" name="__codelineno-2-16" href="#__codelineno-2-16"></a><span class="go">&gt; USE monitoring</span>
</span><span id="__span-2-17"><a id="__codelineno-2-17" name="__codelineno-2-17" href="#__codelineno-2-17"></a><span class="go">Using database monitoring</span>
</span><span id="__span-2-18"><a id="__codelineno-2-18" name="__codelineno-2-18" href="#__codelineno-2-18"></a><span class="go">&gt; CREATE RETENTION POLICY "90_days" ON "monitoring" DURATION 90d REPLICATION 1</span>
</span><span id="__span-2-19"><a id="__codelineno-2-19" name="__codelineno-2-19" href="#__codelineno-2-19"></a><span class="go">&gt; ALTER RETENTION POLICY "90_days" on "monitoring" DURATION 90d REPLICATION 1 DEFAULT</span>
</span><span id="__span-2-20"><a id="__codelineno-2-20" name="__codelineno-2-20" href="#__codelineno-2-20"></a><span class="go">&gt; SHOW RETENTION POLICIES ON monitoring</span>
</span><span id="__span-2-21"><a id="__codelineno-2-21" name="__codelineno-2-21" href="#__codelineno-2-21"></a><span class="go">name    duration  shardGroupDuration replicaN default</span>
</span><span id="__span-2-22"><a id="__codelineno-2-22" name="__codelineno-2-22" href="#__codelineno-2-22"></a><span class="go">----    --------  ------------------ -------- -------</span>
</span><span id="__span-2-23"><a id="__codelineno-2-23" name="__codelineno-2-23" href="#__codelineno-2-23"></a><span class="go">autogen 0s        168h0m0s           1        false</span>
</span><span id="__span-2-24"><a id="__codelineno-2-24" name="__codelineno-2-24" href="#__codelineno-2-24"></a><span class="go">90_days 2160h0m0s 24h0m0s            1        true</span>
</span></code></pre></div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p><strong>Do NOT <code>DROP RETENTION POLICY</code></strong> before copying measurements over to the new one,
otherwise <a href="https://docs.influxdata.com/influxdb/v1/query_language/manage-database/#delete-retention-policies-with-drop-retention-policy"><code>DROP RETENTION POLICY</code></a>
<strong>will permanently delete all measurements</strong> and data stored in the retention policy.</p>
</div>
<p>With the new database ready, all that is left to do is update the configuration file to set
<code>influxdb.database: "home"</code> and the script will immediately start pushing measurements to
the new database, because the configuration file is reloaded on every run.</p>
<h3 id="copy-measurements-over">Copy measurements over</h3>
<p>Old measurements are still in the <code>monitoring</code> database, leaving the graphs empty until new
data fills them back in. In the mean time, it is possible to
<a href="https://community.influxdata.com/t/copy-measurment-to-another-db-with-new-measurment-name/20459/9">copy measurments across databases</a>
using
<a href="https://docs.influxdata.com/influxdb/v1/query_language/explore-data/#the-into-clause">the INTO clause</a>:</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a><span class="gp">$ </span>influx<span class="w"> </span>-host<span class="w"> </span>localhost<span class="w"> </span>-port<span class="w"> </span><span class="m">30086</span><span class="w"> </span>-username<span class="w"> </span>admin<span class="w"> </span>-password<span class="w"> </span>xxxxxxxxxx
</span><span id="__span-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a><span class="go">Connected to http://localhost:30086 version 1.8.10</span>
</span><span id="__span-3-3"><a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a><span class="go">InfluxDB shell version: 1.6.7~rc0</span>
</span><span id="__span-3-4"><a id="__codelineno-3-4" name="__codelineno-3-4" href="#__codelineno-3-4"></a>
</span><span id="__span-3-5"><a id="__codelineno-3-5" name="__codelineno-3-5" href="#__codelineno-3-5"></a><span class="go">&gt; USE home</span>
</span><span id="__span-3-6"><a id="__codelineno-3-6" name="__codelineno-3-6" href="#__codelineno-3-6"></a><span class="go">Using database home</span>
</span><span id="__span-3-7"><a id="__codelineno-3-7" name="__codelineno-3-7" href="#__codelineno-3-7"></a>
</span><span id="__span-3-8"><a id="__codelineno-3-8" name="__codelineno-3-8" href="#__codelineno-3-8"></a><span class="go">&gt; show MEASUREMENTS</span>
</span><span id="__span-3-9"><a id="__codelineno-3-9" name="__codelineno-3-9" href="#__codelineno-3-9"></a><span class="go">name: measurements</span>
</span><span id="__span-3-10"><a id="__codelineno-3-10" name="__codelineno-3-10" href="#__codelineno-3-10"></a><span class="go">name</span>
</span><span id="__span-3-11"><a id="__codelineno-3-11" name="__codelineno-3-11" href="#__codelineno-3-11"></a><span class="go">----</span>
</span><span id="__span-3-12"><a id="__codelineno-3-12" name="__codelineno-3-12" href="#__codelineno-3-12"></a><span class="go">inet_down</span>
</span><span id="__span-3-13"><a id="__codelineno-3-13" name="__codelineno-3-13" href="#__codelineno-3-13"></a><span class="go">inet_ping</span>
</span><span id="__span-3-14"><a id="__codelineno-3-14" name="__codelineno-3-14" href="#__codelineno-3-14"></a><span class="go">inet_up</span>
</span><span id="__span-3-15"><a id="__codelineno-3-15" name="__codelineno-3-15" href="#__codelineno-3-15"></a><span class="go">tapo_current_power</span>
</span><span id="__span-3-16"><a id="__codelineno-3-16" name="__codelineno-3-16" href="#__codelineno-3-16"></a><span class="go">tapo_humidity</span>
</span><span id="__span-3-17"><a id="__codelineno-3-17" name="__codelineno-3-17" href="#__codelineno-3-17"></a><span class="go">tapo_temperature</span>
</span><span id="__span-3-18"><a id="__codelineno-3-18" name="__codelineno-3-18" href="#__codelineno-3-18"></a>
</span><span id="__span-3-19"><a id="__codelineno-3-19" name="__codelineno-3-19" href="#__codelineno-3-19"></a><span class="go">&gt; SELECT * INTO "home"."5_years"."tapo_current_power" FROM "monitoring"."90_days"."tapo_current_power" GROUP BY *</span>
</span><span id="__span-3-20"><a id="__codelineno-3-20" name="__codelineno-3-20" href="#__codelineno-3-20"></a><span class="go">name: result</span>
</span><span id="__span-3-21"><a id="__codelineno-3-21" name="__codelineno-3-21" href="#__codelineno-3-21"></a><span class="go">time written</span>
</span><span id="__span-3-22"><a id="__codelineno-3-22" name="__codelineno-3-22" href="#__codelineno-3-22"></a><span class="go">---- -------</span>
</span><span id="__span-3-23"><a id="__codelineno-3-23" name="__codelineno-3-23" href="#__codelineno-3-23"></a><span class="go">0    210</span>
</span><span id="__span-3-24"><a id="__codelineno-3-24" name="__codelineno-3-24" href="#__codelineno-3-24"></a>
</span><span id="__span-3-25"><a id="__codelineno-3-25" name="__codelineno-3-25" href="#__codelineno-3-25"></a><span class="go">&gt; SELECT * INTO "home"."5_years"."tapo_humidity" FROM "monitoring"."90_days"."tapo_humidity" GROUP BY *</span>
</span><span id="__span-3-26"><a id="__codelineno-3-26" name="__codelineno-3-26" href="#__codelineno-3-26"></a><span class="go">name: result</span>
</span><span id="__span-3-27"><a id="__codelineno-3-27" name="__codelineno-3-27" href="#__codelineno-3-27"></a><span class="go">time written</span>
</span><span id="__span-3-28"><a id="__codelineno-3-28" name="__codelineno-3-28" href="#__codelineno-3-28"></a><span class="go">---- -------</span>
</span><span id="__span-3-29"><a id="__codelineno-3-29" name="__codelineno-3-29" href="#__codelineno-3-29"></a><span class="go">0    85</span>
</span><span id="__span-3-30"><a id="__codelineno-3-30" name="__codelineno-3-30" href="#__codelineno-3-30"></a>
</span><span id="__span-3-31"><a id="__codelineno-3-31" name="__codelineno-3-31" href="#__codelineno-3-31"></a><span class="go">&gt; SELECT * INTO "home"."5_years"."tapo_temperature" FROM "monitoring"."90_days"."tapo_temperature" GROUP BY *</span>
</span><span id="__span-3-32"><a id="__codelineno-3-32" name="__codelineno-3-32" href="#__codelineno-3-32"></a><span class="go">name: result</span>
</span><span id="__span-3-33"><a id="__codelineno-3-33" name="__codelineno-3-33" href="#__codelineno-3-33"></a><span class="go">time written</span>
</span><span id="__span-3-34"><a id="__codelineno-3-34" name="__codelineno-3-34" href="#__codelineno-3-34"></a><span class="go">---- -------</span>
</span><span id="__span-3-35"><a id="__codelineno-3-35" name="__codelineno-3-35" href="#__codelineno-3-35"></a><span class="go">0    85</span>
</span></code></pre></div>
<p>That should make the charts look less empty, having copied data back to 12/28 23:00:35.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If that seems like a suspiciously small amount of data, it's because it is.
See that warning up there about <strong>not</strong> dropping a retention policy?
<em>Ask me how I know.</em></p>
</div>
<h2 id="import-older-historical-data">Import older historical data</h2>
<p>It is possible to
<a href="https://www.tapo.com/en/faq/606/">export history data from Tapo temperature &amp; humidity sensor</a>
and receive CSV files via e-mail. In terms of retention policy and granularity, <em>data is
stored for up to 2 calendar years</em> but <em>when the interval is set to 1 minute, only the data
for the most recent month can be exported</em>. Still good enough to see seasonal patterns.</p>
<p>There is also an option to export energy monitoring data, but it is much more limited:
"all" energy data that can be exported (via e-mail in <code>.xls</code> files) is limited to the
last 24 hours in 15-minute intervals and the last 7 days in 1-hour intervals. </p>
<p>Both options to export data send files that do not contain any reference as to
<em>which device</em> the data is from. It is thus necessary to organize those files in
some way that allows recovering those details later; each file needs to be mapped
to the <code>model</code> and <code>nickname</code> of the relevant device. Since the <code>model</code> is only a
single word, the files can be stored in directories named after the <code>model</code> and
<code>nickname</code> separated by a blank space, e.g.</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a>T315 Exterior/
</span><span id="__span-4-2"><a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a>    1-min.csv  15-min.csv
</span><span id="__span-4-3"><a id="__codelineno-4-3" name="__codelineno-4-3" href="#__codelineno-4-3"></a>P115 PC/
</span><span id="__span-4-4"><a id="__codelineno-4-4" name="__codelineno-4-4" href="#__codelineno-4-4"></a>    'Energy Usage.xls'   Power.xls
</span></code></pre></div>
<p>This will require a new script to load data from these CSV and XLS files and push
measurements to InfluxDB. For the time being, having exported all available data
once the above setup is stable, this can be left for later as part of...</p>
<h2 id="future-improvements">Future improvements</h2>
<p>These are ideas to implement in the future, <em>very roughly</em> sorted by priority:</p>
<ol>
<li>Create script to <em>react</em> to the total power consumption going above a threshold by
    turning off the less critical appliances (e.g. a boiler) to keep the more critical
    appliances running.</li>
<li>Add monitoring for devices with <code>at_low_battery: true</code> (poll daily).</li>
<li>Ingest historical data from exported CSV and XLS files from the Tapo app.</li>
<li>Add support daily periods on <code>always_on</code> (e.g. always on during the night).<ul>
<li><a href="https://www.tapo.com/en/product/smart-plug/tapo-p100/v1/">P100</a>
    <em>Mini Smart Wi-Fi Socket</em> <strong>without</strong> <em>Energy Monitoring</em> devices may be useful
    to make a couple of appliances go off/on at a fixed schedule.</li>
</ul>
</li>
<li>Make the script adapt its <em>reporting rate</em>; but report only very 1 minute when
    there are no changes, to skip repeated values within each sensible tolerances.<ul>
<li><a href="https://www.tapo.com/en/product/smart-sensor/tapo-t310/v1/#tapo-product-spec">T310</a>
    <em>Smart Temperature &amp; Humidity Sensor</em> specifies <em>Accuracy: 0.3 C, 3% RH</em>
    but monitoring so far shows the sensors are <em>precise</em> enough to keep
    measurements steady over time, so we can use the <em>reporting accuracy</em> of
    <strong>0.1 C, 1% RH</strong>.</li>
<li><a href="https://www.tapo.com/en/product/smart-plug/tapo-p115/v1/#tapo-product-spec">P115</a>
    <em>Mini Smart Wi-Fi Socket, Energy Monitoring</em> does not specify the accuracy of
    measurements, so again we can use the <em>reporting accuracy</em> of 1 W for values
    under 1000 W and 10 W for values above 1000 W, of simply <strong>10 W</strong> for all values.</li>
</ul>
</li>
<li>Make the script adapt its <em>polling rate</em>; start polling every 2 seconds,
    then adjust to each device's <code>report_interval</code>.</li>
<li>Add discovery of new devices to cope with IP address changes.</li>
<li>Create script to export minimal data over to Pi Pico or ESP32.</li>
<li>Find a way to update the list of <code>always_on</code> devices on demand.</li>
</ol>







  
  



  


  



<script src="https://giscus.app/client.js" data-repo="stibbons1990/hex" data-repo-id="R_kgDOKXTsSg" data-category="Announcements" data-category-id="DIC_kwDOKXTsSs4CqHDX" data-mapping="pathname" data-strict="0" data-reactions-enabled="1" data-emit-metadata="1" data-input-position="top" data-theme="preferred_color_scheme" data-lang="en" crossorigin="anonymous" async>
</script>

      
    </article>
  </div>

          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"></path></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
    
      
        
      
      <nav class="md-footer__inner md-grid" aria-label="Footer">
        
          
          <a href="../../27/ubuntu-studio-2404-on-raven-gaming-pc-and-more/" class="md-footer__link md-footer__link--prev" aria-label="Previous: Ubuntu Studio 24.04 on Raven, Gaming PC (and more)">
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"></path></svg>
            </div>
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Previous
              </span>
              <div class="md-ellipsis">
                Ubuntu Studio 24.04 on Raven, Gaming PC (and more)
              </div>
            </div>
          </a>
        
        
          
          <a href="../../31/migrating-unifi-controller-to-kubernetes/" class="md-footer__link md-footer__link--next" aria-label="Next: Migrating UniFi Controller to Kubernetes">
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Next
              </span>
              <div class="md-ellipsis">
                Migrating UniFi Controller to Kubernetes
              </div>
            </div>
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11z"></path></svg>
            </div>
          </a>
        
      </nav>
    
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright  2019-2025 Ponder Stibbons
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      
      <script id="__config" type="application/json">{"annotate": null, "base": "../../../../..", "features": ["content.code.copy", "navigation.expand", "navigation.footer", "navigation.top", "search.highlight", "search.suggest"], "search": "../../../../../assets/javascripts/workers/search.2c215733.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../../../../assets/javascripts/bundle.79ae519e.min.js"></script>
      
    
  
<script id="init-glightbox">const lightbox = GLightbox({"touchNavigation": true, "loop": false, "zoomable": true, "draggable": true, "openEffect": "zoom", "closeEffect": "zoom", "slideEffect": "slide"});
document$.subscribe(()=>{ lightbox.reload(); });
</script></body></html>