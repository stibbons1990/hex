
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://stibbons1990.github.io/hex/blog/2023/03/25/single-node-kubernetes-cluster-on-ubuntu-server-lexicon.html">
      
      
        <link rel="prev" href="../../../2022/11/12/ubuntu-studio-2204-on-computer-for-a-young-artist.html">
      
      
        <link rel="next" href="../../05/29/running-visual-studio-code-server-on-kubernetes.html">
      
      
      <link rel="icon" href="../../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.16">
    
    
      
        <title>Single-node Kubernetes cluster on Ubuntu Server (lexicon) - Inadvisably Applied Magic</title>
      
    
    
      <link rel="stylesheet" href="../../../../assets/stylesheets/main.7e37652d.min.css">
      
        
        <link rel="stylesheet" href="../../../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../../../stylesheets/extra.css">
    
    <script>__md_scope=new URL("../../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      
  


  
  

<script id="__analytics">function __md_analytics(){function e(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],e("js",new Date),e("config","G-Y167L3ZVGY"),document.addEventListener("DOMContentLoaded",(function(){document.forms.search&&document.forms.search.query.addEventListener("blur",(function(){this.value&&e("event","search",{search_term:this.value})}));document$.subscribe((function(){var t=document.forms.feedback;if(void 0!==t)for(var a of t.querySelectorAll("[type=submit]"))a.addEventListener("click",(function(a){a.preventDefault();var n=document.location.pathname,d=this.getAttribute("data-md-value");e("event","feedback",{page:n,data:d}),t.firstElementChild.disabled=!0;var r=t.querySelector(".md-feedback__note [data-md-value='"+d+"']");r&&(r.hidden=!1)})),t.hidden=!1})),location$.subscribe((function(t){e("config","G-Y167L3ZVGY",{page_path:t.pathname})}))}));var t=document.createElement("script");t.async=!0,t.src="https://www.googletagmanager.com/gtag/js?id=G-Y167L3ZVGY",document.getElementById("__analytics").insertAdjacentElement("afterEnd",t)}</script>
  
    <script>"undefined"!=typeof __md_analytics&&__md_analytics()</script>
  

    
    
    
   <link href="../../../../assets/stylesheets/glightbox.min.css" rel="stylesheet"/><style>
    html.glightbox-open { overflow: initial; height: 100%; }
    .gslide-title { margin-top: 0px; user-select: text; }
    .gslide-desc { color: #666; user-select: text; }
    .gslide-image img { background: white; }
    .gscrollbar-fixer { padding-right: 15px; }
    .gdesc-inner { font-size: 0.75rem; }
    body[data-md-color-scheme="slate"] .gdesc-inner { background: var(--md-default-bg-color);}
    body[data-md-color-scheme="slate"] .gslide-title { color: var(--md-default-fg-color);}
    body[data-md-color-scheme="slate"] .gslide-desc { color: var(--md-default-fg-color);}</style> <script src="../../../../assets/javascripts/glightbox.min.js"></script></head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="slate" data-md-color-primary="deep-purple" data-md-color-accent="green">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#docker" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../../../index.html" title="Inadvisably Applied Magic" class="md-header__button md-logo" aria-label="Inadvisably Applied Magic" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path fill="currentColor" d="m64 400 85.7-208.2c17-41.3 47.8-75.3 87.2-96.3l146.9-78.3c12.3-6.6 26.5 4.7 23 18.2l-37.2 142.4c-1.1 4.1-1.6 8.3-1.6 12.6 0 6.3 1.2 12.6 3.6 18.5L448 400H240.9l11.8-35.4 40.4-13.5c6.5-2.2 10.9-8.3 10.9-15.2s-4.4-13-10.9-15.2l-40.4-13.5-13.5-40.4c-2.2-6.4-8.3-10.8-15.2-10.8s-13 4.4-15.2 10.9l-13.5 40.4-40.4 13.5c-6.5 2.2-10.9 8.3-10.9 15.2s4.4 13 10.9 15.2l40.4 13.5 11.8 35.4H64zm215.6-258.5c-1.1-3.3-4.1-5.5-7.6-5.5s-6.5 2.2-7.6 5.5l-6.7 20.2-20.2 6.7c-3.3 1.1-5.5 4.1-5.5 7.6s2.2 6.5 5.5 7.6l20.2 6.7 6.7 20.2c1.1 3.3 4.1 5.5 7.6 5.5s6.5-2.2 7.6-5.5l6.7-20.2 20.2-6.7c3.3-1.1 5.5-4.1 5.5-7.6s-2.2-6.5-5.5-7.6l-20.2-6.7zM32 448h448c17.7 0 32 14.3 32 32s-14.3 32-32 32H32c-17.7 0-32-14.3-32-32s14.3-32 32-32"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Inadvisably Applied Magic
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Single-node Kubernetes cluster on Ubuntu Server (lexicon)
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="deep-purple" data-md-color-accent="green"  aria-label="Dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 7a5 5 0 0 1 5 5 5 5 0 0 1-5 5 5 5 0 0 1-5-5 5 5 0 0 1 5-5m0 2a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3m0-7 2.39 3.42C13.65 5.15 12.84 5 12 5s-1.65.15-2.39.42zM3.34 7l4.16-.35A7.2 7.2 0 0 0 5.94 8.5c-.44.74-.69 1.5-.83 2.29zm.02 10 1.76-3.77a7.131 7.131 0 0 0 2.38 4.14zM20.65 7l-1.77 3.79a7.02 7.02 0 0 0-2.38-4.15zm-.01 10-4.14.36c.59-.51 1.12-1.14 1.54-1.86.42-.73.69-1.5.83-2.29zM12 22l-2.41-3.44c.74.27 1.55.44 2.41.44.82 0 1.63-.17 2.37-.44z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="deep-purple" data-md-color-accent="green"  aria-label="Light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m17.75 4.09-2.53 1.94.91 3.06-2.63-1.81-2.63 1.81.91-3.06-2.53-1.94L12.44 4l1.06-3 1.06 3zm3.5 6.91-1.64 1.25.59 1.98-1.7-1.17-1.7 1.17.59-1.98L15.75 11l2.06-.05L18.5 9l.69 1.95zm-2.28 4.95c.83-.08 1.72 1.1 1.19 1.85-.32.45-.66.87-1.08 1.27C15.17 23 8.84 23 4.94 19.07c-3.91-3.9-3.91-10.24 0-14.14.4-.4.82-.76 1.27-1.08.75-.53 1.93.36 1.85 1.19-.27 2.86.69 5.83 2.89 8.02a9.96 9.96 0 0 0 8.02 2.89m-1.64 2.02a12.08 12.08 0 0 1-7.8-3.47c-2.17-2.19-3.33-5-3.49-7.82-2.81 3.14-2.7 7.96.31 10.98 3.02 3.01 7.84 3.12 10.98.31"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
                
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" hidden>
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../../../index.html" title="Inadvisably Applied Magic" class="md-nav__button md-logo" aria-label="Inadvisably Applied Magic" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path fill="currentColor" d="m64 400 85.7-208.2c17-41.3 47.8-75.3 87.2-96.3l146.9-78.3c12.3-6.6 26.5 4.7 23 18.2l-37.2 142.4c-1.1 4.1-1.6 8.3-1.6 12.6 0 6.3 1.2 12.6 3.6 18.5L448 400H240.9l11.8-35.4 40.4-13.5c6.5-2.2 10.9-8.3 10.9-15.2s-4.4-13-10.9-15.2l-40.4-13.5-13.5-40.4c-2.2-6.4-8.3-10.8-15.2-10.8s-13 4.4-15.2 10.9l-13.5 40.4-40.4 13.5c-6.5 2.2-10.9 8.3-10.9 15.2s4.4 13 10.9 15.2l40.4 13.5 11.8 35.4H64zm215.6-258.5c-1.1-3.3-4.1-5.5-7.6-5.5s-6.5 2.2-7.6 5.5l-6.7 20.2-20.2 6.7c-3.3 1.1-5.5 4.1-5.5 7.6s2.2 6.5 5.5 7.6l20.2 6.7 6.7 20.2c1.1 3.3 4.1 5.5 7.6 5.5s6.5-2.2 7.6-5.5l6.7-20.2 20.2-6.7c3.3-1.1 5.5-4.1 5.5-7.6s-2.2-6.5-5.5-7.6l-20.2-6.7zM32 448h448c17.7 0 32 14.3 32 32s-14.3 32-32 32H32c-17.7 0-32-14.3-32-32s14.3-32 32-32"/></svg>

    </a>
    Inadvisably Applied Magic
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../index.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    About This Place
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Projects
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Projects
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../projects/conmon.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Continuous Monitoring
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../projects/self-hosting.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Self-hosting
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      <a href="../../../index.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Unexpected Linux Adventures
    
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
                
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#docker" class="md-nav__link">
    <span class="md-ellipsis">
      Docker
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Docker">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#storage-requirements" class="md-nav__link">
    <span class="md-ellipsis">
      Storage Requirements
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Storage Requirements">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#discard-unused-images" class="md-nav__link">
    <span class="md-ellipsis">
      Discard Unused Images
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#important-tweak-for-btrfs" class="md-nav__link">
    <span class="md-ellipsis">
      Important Tweak for BTRFS
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Important Tweak for BTRFS">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ask-me-how-i-know" class="md-nav__link">
    <span class="md-ellipsis">
      Ask Me How I Know
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#kubernetes" class="md-nav__link">
    <span class="md-ellipsis">
      Kubernetes
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Kubernetes">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#networking-setup" class="md-nav__link">
    <span class="md-ellipsis">
      Networking Setup
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#migration-to-containerd" class="md-nav__link">
    <span class="md-ellipsis">
      Migration to containerd
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bootstrap" class="md-nav__link">
    <span class="md-ellipsis">
      Bootstrap
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Bootstrap">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#enable-systemd-cgroups" class="md-nav__link">
    <span class="md-ellipsis">
      Enable systemd cgroups
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#network-plugin" class="md-nav__link">
    <span class="md-ellipsis">
      Network Plugin
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#add-worker-nodes" class="md-nav__link">
    <span class="md-ellipsis">
      Add Worker Nodes
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#metallb-load-balancer" class="md-nav__link">
    <span class="md-ellipsis">
      MetalLB Load Balancer
    </span>
  </a>
  
    <nav class="md-nav" aria-label="MetalLB Load Balancer">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#test-metallb" class="md-nav__link">
    <span class="md-ellipsis">
      Test MetalLB
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ingress-controller" class="md-nav__link">
    <span class="md-ellipsis">
      Ingress Controller
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dashboard" class="md-nav__link">
    <span class="md-ellipsis">
      Dashboard
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#localpath-pv-provisioner" class="md-nav__link">
    <span class="md-ellipsis">
      LocalPath PV provisioner
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#https-with-lets-encrypt" class="md-nav__link">
    <span class="md-ellipsis">
      HTTPS with Let's Encrypt
    </span>
  </a>
  
    <nav class="md-nav" aria-label="HTTPS with Let&#39;s Encrypt">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#host-os-setup" class="md-nav__link">
    <span class="md-ellipsis">
      Host OS setup
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Host OS setup">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#renewal-automated" class="md-nav__link">
    <span class="md-ellipsis">
      Renewal (automated)
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#kubernetes-setup" class="md-nav__link">
    <span class="md-ellipsis">
      Kubernetes setup
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Kubernetes setup">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#install-lets-encrypt-certificate-as-a-secret" class="md-nav__link">
    <span class="md-ellipsis">
      Install Let’s Encrypt certificate as a secret
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#add-ingress-for-the-first-pod" class="md-nav__link">
    <span class="md-ellipsis">
      Add Ingress for the first pod
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#add-ingress-for-kubernetes-dashboard" class="md-nav__link">
    <span class="md-ellipsis">
      Add Ingress for Kubernetes Dashboard
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#monthly-renewal-of-certificates-manual" class="md-nav__link">
    <span class="md-ellipsis">
      Monthly renewal of certificates (manual)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#monthly-renewal-of-certificates-automated" class="md-nav__link">
    <span class="md-ellipsis">
      Monthly renewal of certificates (automated)
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
  <div class="md-content md-content--post" data-md-component="content">
    <div class="md-sidebar md-sidebar--post" data-md-component="sidebar" data-md-type="navigation">
      <div class="md-sidebar__scrollwrap">
        <div class="md-sidebar__inner md-post">
          <nav class="md-nav md-nav--primary">
            <div class="md-post__back">
              <div class="md-nav__title md-nav__container">
                <a href="../../../index.html" class="md-nav__link">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
                  <span class="md-ellipsis">
                    Back to index
                  </span>
                </a>
              </div>
            </div>
            
            <ul class="md-post__meta md-nav__list">
              <li class="md-nav__item md-nav__item--section">
                <div class="md-post__title">
                  <span class="md-ellipsis">
                    Metadata
                  </span>
                </div>
                <nav class="md-nav">
                  <ul class="md-nav__list">
                    <li class="md-nav__item">
                      <div class="md-nav__link">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 19H5V8h14m-3-7v2H8V1H6v2H5c-1.11 0-2 .89-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V5a2 2 0 0 0-2-2h-1V1m-1 11h-5v5h5z"/></svg>
                        <time datetime="2023-03-25 00:00:00+00:00" class="md-ellipsis">March 25, 2023</time>
                      </div>
                    </li>
                    
                    
                      <li class="md-nav__item">
                        <div class="md-nav__link">
                          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9 3v15h3V3zm3 2 4 13 3-1-4-13zM5 5v13h3V5zM3 19v2h18v-2z"/></svg>
                          <span class="md-ellipsis">
                            in
                            
                              <a href="../../../category/ubuntu.html">ubuntu</a>, 
                              <a href="../../../category/server.html">Server</a>, 
                              <a href="../../../category/linux.html">linux</a>, 
                              <a href="../../../category/kubernetes.html">kubernetes</a>, 
                              <a href="../../../category/docker.html">docker</a></span>
                        </div>
                      </li>
                    
                    
                      
                      <li class="md-nav__item">
                        <div class="md-nav__link">
                          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 20a8 8 0 0 0 8-8 8 8 0 0 0-8-8 8 8 0 0 0-8 8 8 8 0 0 0 8 8m0-18a10 10 0 0 1 10 10 10 10 0 0 1-10 10C6.47 22 2 17.5 2 12A10 10 0 0 1 12 2m.5 5v5.25l4.5 2.67-.75 1.23L11 13V7z"/></svg>
                          <span class="md-ellipsis">
                            
                              48 min read
                            
                          </span>
                        </div>
                      </li>
                    
                  </ul>
                </nav>
              </li>
            </ul>
            
          </nav>
          
        </div>
      </div>
    </div>
    <article class="md-content__inner md-typeset">
      
        
  




  <h1>Single-node Kubernetes cluster on Ubuntu Server (lexicon)</h1>

<p>After playing around with a few Docker containers and Docker
compose, I decided it was time to dive into Kubernetes.
But I only have one server:
<a href="../../../2022/07/03/low-effort-homelab-server-with-ubuntu-server-on-intel-nuc.html">lexicon</a>.</p>
<p>For the most part I followed
<a href="https://computingforgeeks.com/">Computing for Geeks</a>'
article
<a href="https://computingforgeeks.com/install-kubernetes-cluster-ubuntu-jammy/">Install Kubernetes Cluster on Ubuntu 22.04 using kubeadm</a>,
while taking some bits from
<a href="https://linuxconfig.org/how-to-install-kubernetes-on-ubuntu-22-04-jammy-jellyfish-linux">How to install Kubernetes on Ubuntu 22.04 Jammy Jellyfish Linux</a>
(from <a href="https://linuxconfig.org/">LinuxConfig</a>)
and
<a href="https://www.linuxtechi.com/install-kubernetes-on-ubuntu-22-04/">How to Install Kubernetes Cluster on Ubuntu 22.04</a>
(from <a href="https://www.linuxtechi.com/">LinuxTechi</a>).</p>
<!-- more -->

<h2 id="docker">Docker</h2>
<p>Since this was my first experience with containers, it all
started by
<a href="https://docs.docker.com/engine/install/ubuntu/#install-using-the-repository">installing docker</a>
and
<a href="https://docker-curriculum.com/">playing around with it</a>.</p>
<p>Installing Docker is probably <em>not required</em> to the later
installation of Kubernetes, but it did influence my journey.</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="gp"># </span>apt<span class="w"> </span>update
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a><span class="gp"># </span>apt<span class="w"> </span>install<span class="w"> </span>-y<span class="w"> </span>ca-certificates<span class="w"> </span>curl<span class="w"> </span>gnupg<span class="w"> </span>lsb-release
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a><span class="gp"># </span>curl<span class="w"> </span>-fsSL<span class="w"> </span>https://download.docker.com/linux/ubuntu/gpg<span class="w"> </span><span class="se">\</span>
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a><span class="w">  </span><span class="p">|</span><span class="w"> </span>gpg<span class="w"> </span>--dearmor<span class="w"> </span>-o<span class="w"> </span>/usr/share/keyrings/docker.gpg
</span><span id="__span-0-5"><a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a><span class="gp"># </span><span class="nv">arch</span><span class="o">=</span><span class="k">$(</span>dpkg<span class="w"> </span>--print-architecture<span class="k">)</span>
</span><span id="__span-0-6"><a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a><span class="gp"># </span><span class="nv">signed_by</span><span class="o">=</span>signed-by<span class="o">=</span>/usr/share/keyrings/docker.gpg
</span><span id="__span-0-7"><a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a><span class="gp"># </span><span class="nv">url</span><span class="o">=</span>https://download.docker.com/linux/ubuntu
</span><span id="__span-0-8"><a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a><span class="gp"># </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;deb [arch=</span><span class="nv">$arch</span><span class="s2"> </span><span class="nv">$signed_by</span><span class="s2">] </span><span class="nv">$url</span><span class="s2"> </span><span class="k">$(</span>lsb_release<span class="w"> </span>-cs<span class="k">)</span><span class="s2"> stable&quot;</span><span class="w"> </span><span class="se">\</span>
</span><span id="__span-0-9"><a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a><span class="w">  </span>&gt;<span class="w"> </span>/etc/apt/sources.list.d/docker.list<span class="w"> </span>&gt;<span class="w"> </span>/dev/null
</span><span id="__span-0-10"><a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a><span class="gp"># </span>apt<span class="w"> </span>update
</span><span id="__span-0-11"><a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a><span class="gp"># </span>apt<span class="w"> </span>install<span class="w"> </span>-y<span class="w"> </span>docker-ce<span class="w"> </span>docker-ce-cli<span class="w"> </span>containerd.io<span class="w"> </span>docker-compose-plugin
</span></code></pre></div>
<p>To check the basic Docker components work:</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a><span class="gp"># </span>docker<span class="w"> </span>run<span class="w"> </span>hello-world
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a><span class="go">Unable to find image &#39;hello-world:latest&#39; locally</span>
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a><span class="go">latest: Pulling from library/hello-world</span>
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4" href="#__codelineno-1-4"></a><span class="go">2db29710123e: Pull complete </span>
</span><span id="__span-1-5"><a id="__codelineno-1-5" name="__codelineno-1-5" href="#__codelineno-1-5"></a><span class="go">Digest: sha256:aa0cc8055b82dc2509bed2e19b275c8f463506616377219d9642221ab53cf9fe</span>
</span><span id="__span-1-6"><a id="__codelineno-1-6" name="__codelineno-1-6" href="#__codelineno-1-6"></a><span class="go">Status: Downloaded newer image for hello-world:latest</span>
</span><span id="__span-1-7"><a id="__codelineno-1-7" name="__codelineno-1-7" href="#__codelineno-1-7"></a>
</span><span id="__span-1-8"><a id="__codelineno-1-8" name="__codelineno-1-8" href="#__codelineno-1-8"></a><span class="go">Hello from Docker!</span>
</span><span id="__span-1-9"><a id="__codelineno-1-9" name="__codelineno-1-9" href="#__codelineno-1-9"></a><span class="go">This message shows that your installation appears to be working correctly.</span>
</span><span id="__span-1-10"><a id="__codelineno-1-10" name="__codelineno-1-10" href="#__codelineno-1-10"></a>
</span><span id="__span-1-11"><a id="__codelineno-1-11" name="__codelineno-1-11" href="#__codelineno-1-11"></a><span class="go">To generate this message, Docker took the following steps:</span>
</span><span id="__span-1-12"><a id="__codelineno-1-12" name="__codelineno-1-12" href="#__codelineno-1-12"></a><span class="go"> 1. The Docker client contacted the Docker daemon.</span>
</span><span id="__span-1-13"><a id="__codelineno-1-13" name="__codelineno-1-13" href="#__codelineno-1-13"></a><span class="go"> 2. The Docker daemon pulled the &quot;hello-world&quot; image from the Docker Hub.</span>
</span><span id="__span-1-14"><a id="__codelineno-1-14" name="__codelineno-1-14" href="#__codelineno-1-14"></a><span class="go">    (amd64)</span>
</span><span id="__span-1-15"><a id="__codelineno-1-15" name="__codelineno-1-15" href="#__codelineno-1-15"></a><span class="go"> 3. The Docker daemon created a new container from that image which runs the</span>
</span><span id="__span-1-16"><a id="__codelineno-1-16" name="__codelineno-1-16" href="#__codelineno-1-16"></a><span class="go">    executable that produces the output you are currently reading.</span>
</span><span id="__span-1-17"><a id="__codelineno-1-17" name="__codelineno-1-17" href="#__codelineno-1-17"></a><span class="go"> 4. The Docker daemon streamed that output to the Docker client, which sent it</span>
</span><span id="__span-1-18"><a id="__codelineno-1-18" name="__codelineno-1-18" href="#__codelineno-1-18"></a><span class="go">    to your terminal.</span>
</span><span id="__span-1-19"><a id="__codelineno-1-19" name="__codelineno-1-19" href="#__codelineno-1-19"></a>
</span><span id="__span-1-20"><a id="__codelineno-1-20" name="__codelineno-1-20" href="#__codelineno-1-20"></a><span class="go">To try something more ambitious, you can run an Ubuntu container with:</span>
</span><span id="__span-1-21"><a id="__codelineno-1-21" name="__codelineno-1-21" href="#__codelineno-1-21"></a><span class="gp"> $ </span>docker<span class="w"> </span>run<span class="w"> </span>-it<span class="w"> </span>ubuntu<span class="w"> </span>bash
</span><span id="__span-1-22"><a id="__codelineno-1-22" name="__codelineno-1-22" href="#__codelineno-1-22"></a>
</span><span id="__span-1-23"><a id="__codelineno-1-23" name="__codelineno-1-23" href="#__codelineno-1-23"></a><span class="go">Share images, automate workflows, and more with a free Docker ID:</span>
</span><span id="__span-1-24"><a id="__codelineno-1-24" name="__codelineno-1-24" href="#__codelineno-1-24"></a><span class="go"> https://hub.docker.com/</span>
</span><span id="__span-1-25"><a id="__codelineno-1-25" name="__codelineno-1-25" href="#__codelineno-1-25"></a>
</span><span id="__span-1-26"><a id="__codelineno-1-26" name="__codelineno-1-26" href="#__codelineno-1-26"></a><span class="go">For more examples and ideas, visit:</span>
</span><span id="__span-1-27"><a id="__codelineno-1-27" name="__codelineno-1-27" href="#__codelineno-1-27"></a><span class="go"> https://docs.docker.com/get-started/</span>
</span></code></pre></div>
<h3 id="storage-requirements">Storage Requirements</h3>
<p>Docker images are store under <code>/var/lib/docker</code> by default,
this may not be a good location if the root partition is not
very big. In my case, most of the disk space is given to the
<code>/home</code> partition, so that's where I
<a href="https://github.com/IronicBadger/til/blob/master/docker/change-docker-root.md#option-3---createmodify-a-json-config-file-even-better-way">moved Docker images</a>.</p>
<p>First stop the Docker runtime service and move the files:</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a><span class="gp"># </span>systemctl<span class="w"> </span>stop<span class="w"> </span>docker.service
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a><span class="gp"># </span>systemctl<span class="w"> </span>stop<span class="w"> </span>docker.socket
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a><span class="gp"># </span>systemctl<span class="w"> </span>stop<span class="w"> </span>containerd.service
</span><span id="__span-2-4"><a id="__codelineno-2-4" name="__codelineno-2-4" href="#__codelineno-2-4"></a><span class="gp"># </span>mkdir<span class="w"> </span>/home/lib
</span><span id="__span-2-5"><a id="__codelineno-2-5" name="__codelineno-2-5" href="#__codelineno-2-5"></a><span class="gp"># </span><span class="nb">time</span><span class="w"> </span>cp<span class="w"> </span>-a<span class="w"> </span>/var/lib/docker/<span class="w"> </span>/home/lib
</span><span id="__span-2-6"><a id="__codelineno-2-6" name="__codelineno-2-6" href="#__codelineno-2-6"></a><span class="gp"># </span>find<span class="w"> </span>/home/lib/docker<span class="w"> </span><span class="se">\</span>
</span><span id="__span-2-7"><a id="__codelineno-2-7" name="__codelineno-2-7" href="#__codelineno-2-7"></a><span class="w">  </span>-name<span class="w"> </span>config.v2.json<span class="w"> </span><span class="se">\</span>
</span><span id="__span-2-8"><a id="__codelineno-2-8" name="__codelineno-2-8" href="#__codelineno-2-8"></a><span class="w">  </span>-exec<span class="w"> </span>sed<span class="w"> </span>-i<span class="w"> </span><span class="s1">&#39;s:/var/lib/:/home/lib/:g&#39;</span><span class="w"> </span><span class="o">{}</span><span class="w"> </span><span class="se">\;</span>
</span><span id="__span-2-9"><a id="__codelineno-2-9" name="__codelineno-2-9" href="#__codelineno-2-9"></a><span class="gp"># </span>containerd<span class="w"> </span>config<span class="w"> </span>default<span class="w"> </span><span class="p">|</span><span class="w"> </span>sed<span class="w"> </span><span class="s1">&#39;s:var/lib:home/lib:&#39;</span><span class="w"> </span><span class="se">\</span>
</span><span id="__span-2-10"><a id="__codelineno-2-10" name="__codelineno-2-10" href="#__codelineno-2-10"></a><span class="gp">&gt; </span>/etc/containerd/config.toml
</span></code></pre></div>
<p>Once files are moved, edit <code>/etc/docker/daemon.json</code> to point
the Docker runtime service to the new location:</p>
<div class="language-json highlight"><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a><span class="p">{</span>
</span><span id="__span-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a><span class="w">  </span><span class="nt">&quot;data-root&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;/home/lib/docker&quot;</span><span class="p">,</span>
</span><span id="__span-3-3"><a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a><span class="w">  </span><span class="err">...</span>
</span><span id="__span-3-4"><a id="__codelineno-3-4" name="__codelineno-3-4" href="#__codelineno-3-4"></a><span class="p">}</span>
</span></code></pre></div>
<p>Finally, start the service again and check the change has
taken effect:</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a><span class="gp"># </span>systemctl<span class="w"> </span>start<span class="w"> </span>docker.socket
</span><span id="__span-4-2"><a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a><span class="gp"># </span>systemctl<span class="w"> </span>start<span class="w"> </span>docker.service
</span><span id="__span-4-3"><a id="__codelineno-4-3" name="__codelineno-4-3" href="#__codelineno-4-3"></a><span class="gp"># </span>systemctl<span class="w"> </span>start<span class="w"> </span>containerd.service
</span><span id="__span-4-4"><a id="__codelineno-4-4" name="__codelineno-4-4" href="#__codelineno-4-4"></a><span class="gp"># </span>docker<span class="w"> </span>info<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span><span class="s1">&#39;Docker Root Dir&#39;</span>
</span><span id="__span-4-5"><a id="__codelineno-4-5" name="__codelineno-4-5" href="#__codelineno-4-5"></a><span class="go"> Docker Root Dir: /home/lib/docker</span>
</span></code></pre></div>
<h4 id="discard-unused-images">Discard Unused Images</h4>
<p>Over time, storage usage of <code>/home/lib/containerd</code>
will grow with stale images. These can be cleaned
up manually with <code>crictl rmi --prune</code> pointing it
to the correct endpoint:</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a><span class="gp"># </span>du<span class="w"> </span>-sh<span class="w"> </span>/home/lib/containerd/
</span><span id="__span-5-2"><a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a><span class="go">109G    /home/lib/containerd/</span>
</span><span id="__span-5-3"><a id="__codelineno-5-3" name="__codelineno-5-3" href="#__codelineno-5-3"></a><span class="gp"># </span>crictl<span class="w"> </span><span class="se">\</span>
</span><span id="__span-5-4"><a id="__codelineno-5-4" name="__codelineno-5-4" href="#__codelineno-5-4"></a><span class="w">  </span>-r<span class="w"> </span>unix:///run/containerd/containerd.sock<span class="w"> </span><span class="se">\</span>
</span><span id="__span-5-5"><a id="__codelineno-5-5" name="__codelineno-5-5" href="#__codelineno-5-5"></a><span class="w">  </span>rmi<span class="w"> </span>--prune
</span><span id="__span-5-6"><a id="__codelineno-5-6" name="__codelineno-5-6" href="#__codelineno-5-6"></a><span class="go">Deleted: registry.k8s.io/pause:3.9</span>
</span><span id="__span-5-7"><a id="__codelineno-5-7" name="__codelineno-5-7" href="#__codelineno-5-7"></a><span class="gp"># </span>du<span class="w"> </span>-sh<span class="w"> </span>/home/lib/containerd/
</span><span id="__span-5-8"><a id="__codelineno-5-8" name="__codelineno-5-8" href="#__codelineno-5-8"></a><span class="go">8.1G    /home/lib/containerd/</span>
</span></code></pre></div>
<p>The same can be achieved on an on-going basis by
adjusting the <code>ImageGCHighThresholdPercent</code> setting
to trigger Kubernetes' built-in garbage collection:</p>
<p>Setting this threshold involves
<a href="https://kubernetes.io/docs/tasks/administer-cluster/kubeadm/kubeadm-reconfigure/#updating-the-kubeletconfiguration">updating the <code>KubeletConfiguration</code></a>:</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-6-1"><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a><span class="gp">$ </span>kubectl<span class="w"> </span>edit<span class="w"> </span>cm<span class="w"> </span>-n<span class="w"> </span>kube-system<span class="w"> </span>kubelet-config
</span></code></pre></div>
<p>Find the <code>imageMinimumGCAge</code> variable and add the
threshold for garbage collection under it; very
carefully using the exact same blank characters
for indentation (otherwise the YAML is invalid):</p>
<div class="language-yaml highlight"><pre><span></span><code><span id="__span-7-1"><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a><span class="w">    </span><span class="nt">imageMinimumGCAge</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0s</span>
</span><span id="__span-7-2"><a id="__codelineno-7-2" name="__codelineno-7-2" href="#__codelineno-7-2"></a><span class="w">    </span><span class="nt">imageGCLowThresholdPercent</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">65</span>
</span><span id="__span-7-3"><a id="__codelineno-7-3" name="__codelineno-7-3" href="#__codelineno-7-3"></a><span class="w">    </span><span class="nt">imageGCHighThresholdPercent</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">70</span>
</span></code></pre></div>
<p>Run <code>kubeadm upgrade</code> as below to download the latest
<code>kubelet-config</code> ConfigMap contents into the local
file <code>/var/lib/kubelet/config.yaml</code> and restart the
<code>kubelet</code> service:</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-8-1"><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a><span class="gp"># </span>kubeadm<span class="w"> </span>upgrade<span class="w"> </span>node<span class="w"> </span>phase<span class="w"> </span>kubelet-config
</span><span id="__span-8-2"><a id="__codelineno-8-2" name="__codelineno-8-2" href="#__codelineno-8-2"></a><span class="go">[upgrade] Reading configuration from the cluster...</span>
</span><span id="__span-8-3"><a id="__codelineno-8-3" name="__codelineno-8-3" href="#__codelineno-8-3"></a><span class="go">[upgrade] FYI: You can look at this config file with &#39;kubectl -n kube-system get cm kubeadm-config -o yaml&#39;</span>
</span><span id="__span-8-4"><a id="__codelineno-8-4" name="__codelineno-8-4" href="#__codelineno-8-4"></a><span class="go">[kubelet-start] Writing kubelet configuration to file &quot;/var/lib/kubelet/config.yaml&quot;</span>
</span><span id="__span-8-5"><a id="__codelineno-8-5" name="__codelineno-8-5" href="#__codelineno-8-5"></a><span class="go">[upgrade] The configuration for this node was successfully updated!</span>
</span><span id="__span-8-6"><a id="__codelineno-8-6" name="__codelineno-8-6" href="#__codelineno-8-6"></a><span class="go">[upgrade] Now you should go ahead and upgrade the kubelet package using your package manager.</span>
</span><span id="__span-8-7"><a id="__codelineno-8-7" name="__codelineno-8-7" href="#__codelineno-8-7"></a>
</span><span id="__span-8-8"><a id="__codelineno-8-8" name="__codelineno-8-8" href="#__codelineno-8-8"></a><span class="gp"># </span>systemctl<span class="w"> </span>restart<span class="w"> </span>kubelet
</span></code></pre></div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This may not be effective when the images are not in the root partition.</p>
</div>
<p><a href="https://github.com/containerd/containerd/discussions/6295#discussioncomment-1718081">It also possible</a>
to set <code>discard_unpacked_layers: true</code> on the CRI
plugin configuration (<code>/etc/containerd/config.toml</code>)
so that it discards the compressed layer data after
unpacking images. This data is only really needed if
you are going to unpack the image again.</p>
<h3 id="important-tweak-for-btrfs">Important Tweak for BTRFS</h3>
<p><a href="https://github.com/moby/moby/issues/27653">Docker gradually exhausts disk space on BTRFS #27653</a>.
This was a known issue since October <strong>2016</strong>,
and was closed in August 2023 with no plan to fix:</p>
<blockquote>
<p>There are no improvements planned in this area (BTRFS graph
driver). containerd BTRFS is where future improvements
might go. The overlay2 graph driver or overlayfs
snapshotter is recommended for all users.</p>
</blockquote>
<p>Docker still defaults to using its <code>btrfs</code> driver, so this
should be changed early on to avoid problems.</p>
<p><strong>Warning</strong>: doing this later on will likely
result in losing all Docker images.
<a href="#ask-me-how-i-know">Ask Me How I Know</a>.</p>
<p>First stop the Docker runtime service and move the files:</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-9-1"><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a><span class="gp"># </span>systemctl<span class="w"> </span>stop<span class="w"> </span>docker.service
</span><span id="__span-9-2"><a id="__codelineno-9-2" name="__codelineno-9-2" href="#__codelineno-9-2"></a><span class="gp"># </span>systemctl<span class="w"> </span>stop<span class="w"> </span>docker.socket
</span><span id="__span-9-3"><a id="__codelineno-9-3" name="__codelineno-9-3" href="#__codelineno-9-3"></a><span class="gp"># </span>systemctl<span class="w"> </span>stop<span class="w"> </span>containerd.service
</span></code></pre></div>
<p>Once files are moved, edit <code>/etc/docker/daemon.json</code> to
<a href="https://github.com/moby/moby/issues/27653#issuecomment-1435749535">override storage driver</a>
as recommended:</p>
<div class="language-json highlight"><pre><span></span><code><span id="__span-10-1"><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a><span class="p">{</span>
</span><span id="__span-10-2"><a id="__codelineno-10-2" name="__codelineno-10-2" href="#__codelineno-10-2"></a><span class="w">  </span><span class="err">...</span>
</span><span id="__span-10-3"><a id="__codelineno-10-3" name="__codelineno-10-3" href="#__codelineno-10-3"></a><span class="w">  </span><span class="nt">&quot;storage-driver&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;overlay2&quot;</span>
</span><span id="__span-10-4"><a id="__codelineno-10-4" name="__codelineno-10-4" href="#__codelineno-10-4"></a><span class="p">}</span>
</span></code></pre></div>
<p>Finally, start the service again and check the change has
taken effect:</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-11-1"><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a><span class="gp"># </span>systemctl<span class="w"> </span>start<span class="w"> </span>docker.socket
</span><span id="__span-11-2"><a id="__codelineno-11-2" name="__codelineno-11-2" href="#__codelineno-11-2"></a><span class="gp"># </span>systemctl<span class="w"> </span>start<span class="w"> </span>docker.service
</span><span id="__span-11-3"><a id="__codelineno-11-3" name="__codelineno-11-3" href="#__codelineno-11-3"></a><span class="gp"># </span>systemctl<span class="w"> </span>start<span class="w"> </span>containerd.service
</span><span id="__span-11-4"><a id="__codelineno-11-4" name="__codelineno-11-4" href="#__codelineno-11-4"></a><span class="gp"># </span>docker<span class="w"> </span>info<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span><span class="s1">&#39;Storage Driver&#39;</span>
</span><span id="__span-11-5"><a id="__codelineno-11-5" name="__codelineno-11-5" href="#__codelineno-11-5"></a><span class="go"> Storage Driver: overlay2</span>
</span></code></pre></div>
<h4 id="ask-me-how-i-know">Ask Me How I Know</h4>
<p>I learned about the above issues the hard way, and it
resulted in losing all Docker images.</p>
<p>One day I found the root filesystem was nearly 100% full.</p>
<p>Pruning didn’t help much until I stopped all leftover clusters from previous exercises, and even then it only helped a bit:</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-12-1"><a id="__codelineno-12-1" name="__codelineno-12-1" href="#__codelineno-12-1"></a><span class="gp"># </span>docker<span class="w"> </span>image<span class="w"> </span>prune<span class="w"> </span>-a<span class="w"> </span>-f
</span><span id="__span-12-2"><a id="__codelineno-12-2" name="__codelineno-12-2" href="#__codelineno-12-2"></a><span class="go">...</span>
</span><span id="__span-12-3"><a id="__codelineno-12-3" name="__codelineno-12-3" href="#__codelineno-12-3"></a><span class="go">Total reclaimed space: 2.244GB</span>
</span></code></pre></div>
<p>This reclaimed enough to bring
<code>/var/lib/docker/btrfs/subvolumes</code> down from 49G to 8.7G;
and the root filesystem went down to 78%.
At this point there were only 2 images running: code-server
and gitea. Stopped them, moved their volume’s <code>_data</code>
directories to another partition (under <code>/home/docker</code>),
updated their <code>docker-compose</code> files and it was all good.
Then stopped them again and removed all docker volumes,
except the only one that was in use.</p>
<p>With that, the root filesystem went down to 69%. Then used
this trick to remove all the subvolumes not in use; and got
the root filesystem down to 66%.
But all that was only a temporary relief; the partition
would quickly fill up again without overriding the storage
driver to use <code>overlay2</code>.</p>
<h2 id="kubernetes">Kubernetes</h2>
<p>The core components of Kubernetes can be installed via APT:</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-13-1"><a id="__codelineno-13-1" name="__codelineno-13-1" href="#__codelineno-13-1"></a><span class="gp"># </span>apt<span class="w"> </span>update
</span><span id="__span-13-2"><a id="__codelineno-13-2" name="__codelineno-13-2" href="#__codelineno-13-2"></a><span class="gp"># </span>apt<span class="w"> </span>full-upgrade
</span><span id="__span-13-3"><a id="__codelineno-13-3" name="__codelineno-13-3" href="#__codelineno-13-3"></a><span class="gp"># </span>curl<span class="w"> </span>-fsSLo<span class="w"> </span><span class="se">\</span>
</span><span id="__span-13-4"><a id="__codelineno-13-4" name="__codelineno-13-4" href="#__codelineno-13-4"></a><span class="w">  </span>/etc/apt/keyrings/kubernetes-archive-keyring.gpg<span class="w"> </span><span class="se">\</span>
</span><span id="__span-13-5"><a id="__codelineno-13-5" name="__codelineno-13-5" href="#__codelineno-13-5"></a><span class="w">  </span>https://packages.cloud.google.com/apt/doc/apt-key.gpg
</span><span id="__span-13-6"><a id="__codelineno-13-6" name="__codelineno-13-6" href="#__codelineno-13-6"></a><span class="gp"># </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;deb [signed-by=/etc/apt/keyrings/kubernetes-archive-keyring.gpg] https://apt.kubernetes.io/ kubernetes-xenial main&quot;</span><span class="w"> </span><span class="se">\</span>
</span><span id="__span-13-7"><a id="__codelineno-13-7" name="__codelineno-13-7" href="#__codelineno-13-7"></a><span class="w">  </span>&gt;<span class="w"> </span>/etc/apt/sources.list.d/kubernetes.list
</span><span id="__span-13-8"><a id="__codelineno-13-8" name="__codelineno-13-8" href="#__codelineno-13-8"></a><span class="gp"># </span>apt-get<span class="w"> </span>update
</span><span id="__span-13-9"><a id="__codelineno-13-9" name="__codelineno-13-9" href="#__codelineno-13-9"></a><span class="gp"># </span>apt-get<span class="w"> </span>install<span class="w"> </span>-y<span class="w"> </span>wget<span class="w"> </span>curl<span class="w"> </span>vim<span class="w"> </span>git<span class="w"> </span>kubelet<span class="w"> </span>kubeadm<span class="w"> </span>kubectl
</span><span id="__span-13-10"><a id="__codelineno-13-10" name="__codelineno-13-10" href="#__codelineno-13-10"></a><span class="gp"># </span>kubectl<span class="w"> </span>version<span class="w"> </span>--output<span class="o">=</span>yaml
</span><span id="__span-13-11"><a id="__codelineno-13-11" name="__codelineno-13-11" href="#__codelineno-13-11"></a><span class="go">clientVersion:</span>
</span><span id="__span-13-12"><a id="__codelineno-13-12" name="__codelineno-13-12" href="#__codelineno-13-12"></a><span class="go">  buildDate: &quot;2023-03-15T13:40:17Z&quot;</span>
</span><span id="__span-13-13"><a id="__codelineno-13-13" name="__codelineno-13-13" href="#__codelineno-13-13"></a><span class="go">  compiler: gc</span>
</span><span id="__span-13-14"><a id="__codelineno-13-14" name="__codelineno-13-14" href="#__codelineno-13-14"></a><span class="go">  gitCommit: 9e644106593f3f4aa98f8a84b23db5fa378900bd</span>
</span><span id="__span-13-15"><a id="__codelineno-13-15" name="__codelineno-13-15" href="#__codelineno-13-15"></a><span class="go">  gitTreeState: clean</span>
</span><span id="__span-13-16"><a id="__codelineno-13-16" name="__codelineno-13-16" href="#__codelineno-13-16"></a><span class="go">  gitVersion: v1.26.3</span>
</span><span id="__span-13-17"><a id="__codelineno-13-17" name="__codelineno-13-17" href="#__codelineno-13-17"></a><span class="go">  goVersion: go1.19.7</span>
</span><span id="__span-13-18"><a id="__codelineno-13-18" name="__codelineno-13-18" href="#__codelineno-13-18"></a><span class="go">  major: &quot;1&quot;</span>
</span><span id="__span-13-19"><a id="__codelineno-13-19" name="__codelineno-13-19" href="#__codelineno-13-19"></a><span class="go">  minor: &quot;26&quot;</span>
</span><span id="__span-13-20"><a id="__codelineno-13-20" name="__codelineno-13-20" href="#__codelineno-13-20"></a><span class="go">  platform: linux/amd64</span>
</span><span id="__span-13-21"><a id="__codelineno-13-21" name="__codelineno-13-21" href="#__codelineno-13-21"></a><span class="go">kustomizeVersion: v4.5.7</span>
</span></code></pre></div>
<p>The following command should be able to connect to the
Kubernetes <code>etcd</code> service now; you <em>might</em> need to run this
as root, or not:</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-14-1"><a id="__codelineno-14-1" name="__codelineno-14-1" href="#__codelineno-14-1"></a><span class="gp">$ </span>kubeadm<span class="w"> </span>version
</span><span id="__span-14-2"><a id="__codelineno-14-2" name="__codelineno-14-2" href="#__codelineno-14-2"></a><span class="go">kubeadm version: &amp;version.Info{Major:&quot;1&quot;, Minor:&quot;26&quot;, GitVersion:&quot;v1.26.1&quot;, GitCommit:&quot;8f94681cd294aa8cfd3407b8191f6c70214973a4&quot;, GitTreeState:&quot;clean&quot;, BuildDate:&quot;2023-01-18T15:56:50Z&quot;, GoVersion:&quot;go1.19.5&quot;, Compiler:&quot;gc&quot;, Platform:&quot;linux/amd64&quot;}</span>
</span></code></pre></div>
<h3 id="networking-setup">Networking Setup</h3>
<p>The following steps were not necessary. Enabling IP forwarding and NAT is not necessary in Ubuntu 22.04 server, it is all already enabled by default apparently.</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-15-1"><a id="__codelineno-15-1" name="__codelineno-15-1" href="#__codelineno-15-1"></a><span class="gp"># </span>modprobe<span class="w"> </span>overlay
</span><span id="__span-15-2"><a id="__codelineno-15-2" name="__codelineno-15-2" href="#__codelineno-15-2"></a><span class="gp"># </span>modprobe<span class="w"> </span>br_netfilter
</span><span id="__span-15-3"><a id="__codelineno-15-3" name="__codelineno-15-3" href="#__codelineno-15-3"></a><span class="gp"># </span>tee<span class="w"> </span>/etc/sysctl.d/kubernetes.conf&lt;&lt;EOF
</span><span id="__span-15-4"><a id="__codelineno-15-4" name="__codelineno-15-4" href="#__codelineno-15-4"></a><span class="go">net.bridge.bridge-nf-call-ip6tables = 1</span>
</span><span id="__span-15-5"><a id="__codelineno-15-5" name="__codelineno-15-5" href="#__codelineno-15-5"></a><span class="go">net.bridge.bridge-nf-call-iptables = 1</span>
</span><span id="__span-15-6"><a id="__codelineno-15-6" name="__codelineno-15-6" href="#__codelineno-15-6"></a><span class="go">net.ipv4.ip_forward = 1</span>
</span><span id="__span-15-7"><a id="__codelineno-15-7" name="__codelineno-15-7" href="#__codelineno-15-7"></a><span class="go">EOF</span>
</span><span id="__span-15-8"><a id="__codelineno-15-8" name="__codelineno-15-8" href="#__codelineno-15-8"></a><span class="gp"># </span>sysctl<span class="w"> </span>--system
</span></code></pre></div>
<p>The result, which can be checked upfront to confirm that the
above steps are not necessary, can be checked with:</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-16-1"><a id="__codelineno-16-1" name="__codelineno-16-1" href="#__codelineno-16-1"></a><span class="gp"># </span>lsmod<span class="w"> </span><span class="p">|</span><span class="w"> </span>egrep<span class="w"> </span><span class="s1">&#39;overlay|bridge&#39;</span>
</span><span id="__span-16-2"><a id="__codelineno-16-2" name="__codelineno-16-2" href="#__codelineno-16-2"></a><span class="go">bridge                307200  1 br_netfilter</span>
</span><span id="__span-16-3"><a id="__codelineno-16-3" name="__codelineno-16-3" href="#__codelineno-16-3"></a><span class="go">stp                    16384  1 bridge</span>
</span><span id="__span-16-4"><a id="__codelineno-16-4" name="__codelineno-16-4" href="#__codelineno-16-4"></a><span class="go">llc                    16384  2 bridge,stp</span>
</span><span id="__span-16-5"><a id="__codelineno-16-5" name="__codelineno-16-5" href="#__codelineno-16-5"></a><span class="go">overlay               151552  0</span>
</span><span id="__span-16-6"><a id="__codelineno-16-6" name="__codelineno-16-6" href="#__codelineno-16-6"></a><span class="gp"># </span>sysctl<span class="w"> </span>-a<span class="w"> </span><span class="p">|</span><span class="w"> </span>egrep<span class="w"> </span><span class="s1">&#39;net.ipv4.ip_forward |net.bridge.bridge-nf-call-ip&#39;</span>
</span><span id="__span-16-7"><a id="__codelineno-16-7" name="__codelineno-16-7" href="#__codelineno-16-7"></a><span class="go">net.bridge.bridge-nf-call-ip6tables = 1</span>
</span><span id="__span-16-8"><a id="__codelineno-16-8" name="__codelineno-16-8" href="#__codelineno-16-8"></a><span class="go">net.bridge.bridge-nf-call-iptables = 1</span>
</span><span id="__span-16-9"><a id="__codelineno-16-9" name="__codelineno-16-9" href="#__codelineno-16-9"></a><span class="go">net.ipv4.ip_forward = 1</span>
</span></code></pre></div>
<h3 id="migration-to-containerd">Migration to <code>containerd</code></h3>
<p>Normally, the next step would be to install a container
runtime, with the options being
*  <a href="https://www.docker.com/">Docker</a>, the <em>original</em> one.
*  <a href="https://cri-o.io/">CRI-O</a>, a <em>lightweight</em> option.
*  <a href="https://containerd.io/">containerd</a>, an industry-standard.</p>
<p>Docker and containerd were already installed as part of the
above first steps with Docker, Dockershim was deprecated in
Kubernetes 1.24 and the above step installed Kubernetes 1.26.</p>
<p>If we were already running Kubernetes (<code>kubelet</code>) with Docker
CE, at this point we’d have to point <code>kubelet</code> to containerd
by updating the flags in
<code>/etc/systemd/system/kubelet.service.d/10-kubeadm.conf</code> or 
<code>/var/lib/kubelet/kubeadm-flags.env</code> to</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-17-1"><a id="__codelineno-17-1" name="__codelineno-17-1" href="#__codelineno-17-1"></a><span class="go">--container-runtime=remote </span>
</span><span id="__span-17-2"><a id="__codelineno-17-2" name="__codelineno-17-2" href="#__codelineno-17-2"></a><span class="go">--container-runtimeendpoint=unix:///run/containerd/containerd.sock&quot;</span>
</span></code></pre></div>
<p>But since we’re starting from scratch, we’ll do that from
<code>kubeadm</code> later:</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-18-1"><a id="__codelineno-18-1" name="__codelineno-18-1" href="#__codelineno-18-1"></a><span class="gp"># </span>systemctl<span class="w"> </span><span class="nb">enable</span><span class="w"> </span>kubelet
</span><span id="__span-18-2"><a id="__codelineno-18-2" name="__codelineno-18-2" href="#__codelineno-18-2"></a><span class="gp"># </span>systemctl<span class="w"> </span>status<span class="w"> </span>kubelet
</span><span id="__span-18-3"><a id="__codelineno-18-3" name="__codelineno-18-3" href="#__codelineno-18-3"></a><span class="go">● kubelet.service - kubelet: The Kubernetes Node Agent</span>
</span><span id="__span-18-4"><a id="__codelineno-18-4" name="__codelineno-18-4" href="#__codelineno-18-4"></a><span class="go">     Loaded: loaded (/lib/systemd/system/kubelet.service; enabled; vendor preset: enabled)</span>
</span><span id="__span-18-5"><a id="__codelineno-18-5" name="__codelineno-18-5" href="#__codelineno-18-5"></a><span class="go">    Drop-In: /etc/systemd/system/kubelet.service.d</span>
</span><span id="__span-18-6"><a id="__codelineno-18-6" name="__codelineno-18-6" href="#__codelineno-18-6"></a><span class="go">             └─10-kubeadm.conf</span>
</span><span id="__span-18-7"><a id="__codelineno-18-7" name="__codelineno-18-7" href="#__codelineno-18-7"></a><span class="go">     Active: activating (auto-restart) (Result: exit-code) since Wed 2023-03-22 22:28:17 CET; 8s ago</span>
</span><span id="__span-18-8"><a id="__codelineno-18-8" name="__codelineno-18-8" href="#__codelineno-18-8"></a>
</span><span id="__span-18-9"><a id="__codelineno-18-9" name="__codelineno-18-9" href="#__codelineno-18-9"></a><span class="gp"># </span>kubeadm<span class="w"> </span>config<span class="w"> </span>images<span class="w"> </span>pull<span class="w"> </span><span class="se">\</span>
</span><span id="__span-18-10"><a id="__codelineno-18-10" name="__codelineno-18-10" href="#__codelineno-18-10"></a><span class="w">  </span>--cri-socket<span class="w"> </span>unix:/run/containerd/containerd.sock
</span><span id="__span-18-11"><a id="__codelineno-18-11" name="__codelineno-18-11" href="#__codelineno-18-11"></a><span class="go">[config/images] Pulled registry.k8s.io/kube-apiserver:v1.26.3</span>
</span><span id="__span-18-12"><a id="__codelineno-18-12" name="__codelineno-18-12" href="#__codelineno-18-12"></a><span class="go">[config/images] Pulled registry.k8s.io/kube-controller-manager:v1.26.3</span>
</span><span id="__span-18-13"><a id="__codelineno-18-13" name="__codelineno-18-13" href="#__codelineno-18-13"></a><span class="go">[config/images] Pulled registry.k8s.io/kube-scheduler:v1.26.3</span>
</span><span id="__span-18-14"><a id="__codelineno-18-14" name="__codelineno-18-14" href="#__codelineno-18-14"></a><span class="go">[config/images] Pulled registry.k8s.io/kube-proxy:v1.26.3</span>
</span><span id="__span-18-15"><a id="__codelineno-18-15" name="__codelineno-18-15" href="#__codelineno-18-15"></a><span class="go">[config/images] Pulled registry.k8s.io/pause:3.9</span>
</span><span id="__span-18-16"><a id="__codelineno-18-16" name="__codelineno-18-16" href="#__codelineno-18-16"></a><span class="go">[config/images] Pulled registry.k8s.io/etcd:3.5.6-0</span>
</span><span id="__span-18-17"><a id="__codelineno-18-17" name="__codelineno-18-17" href="#__codelineno-18-17"></a><span class="go">[config/images] Pulled registry.k8s.io/coredns/coredns:v1.9.3</span>
</span></code></pre></div>
<h3 id="bootstrap">Bootstrap</h3>
<p>For a single-node cluster, bootstrap it in the simplest way:</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-19-1"><a id="__codelineno-19-1" name="__codelineno-19-1" href="#__codelineno-19-1"></a><span class="gp"># </span>kubeadm<span class="w"> </span>init<span class="w"> </span><span class="se">\</span>
</span><span id="__span-19-2"><a id="__codelineno-19-2" name="__codelineno-19-2" href="#__codelineno-19-2"></a><span class="w">  </span>--pod-network-cidr<span class="o">=</span><span class="m">10</span>.244.0.0/16<span class="w"> </span><span class="se">\</span>
</span><span id="__span-19-3"><a id="__codelineno-19-3" name="__codelineno-19-3" href="#__codelineno-19-3"></a><span class="w">  </span>--cri-socket<span class="w"> </span>unix:/run/containerd/containerd.sock
</span><span id="__span-19-4"><a id="__codelineno-19-4" name="__codelineno-19-4" href="#__codelineno-19-4"></a><span class="go">[init] Using Kubernetes version: v1.26.3</span>
</span><span id="__span-19-5"><a id="__codelineno-19-5" name="__codelineno-19-5" href="#__codelineno-19-5"></a><span class="go">[preflight] Running pre-flight checks</span>
</span><span id="__span-19-6"><a id="__codelineno-19-6" name="__codelineno-19-6" href="#__codelineno-19-6"></a><span class="go">[preflight] Pulling images required for setting up a Kubernetes cluster</span>
</span><span id="__span-19-7"><a id="__codelineno-19-7" name="__codelineno-19-7" href="#__codelineno-19-7"></a><span class="go">[preflight] This might take a minute or two, depending on the speed of your internet connection</span>
</span><span id="__span-19-8"><a id="__codelineno-19-8" name="__codelineno-19-8" href="#__codelineno-19-8"></a><span class="go">[preflight] You can also perform this action in beforehand using &#39;kubeadm config images pull&#39;</span>
</span><span id="__span-19-9"><a id="__codelineno-19-9" name="__codelineno-19-9" href="#__codelineno-19-9"></a><span class="go">[certs] Using certificateDir folder &quot;/etc/kubernetes/pki&quot;</span>
</span><span id="__span-19-10"><a id="__codelineno-19-10" name="__codelineno-19-10" href="#__codelineno-19-10"></a><span class="go">[certs] Generating &quot;ca&quot; certificate and key</span>
</span><span id="__span-19-11"><a id="__codelineno-19-11" name="__codelineno-19-11" href="#__codelineno-19-11"></a><span class="go">[certs] Generating &quot;apiserver&quot; certificate and key</span>
</span><span id="__span-19-12"><a id="__codelineno-19-12" name="__codelineno-19-12" href="#__codelineno-19-12"></a><span class="go">[certs] apiserver serving cert is signed for DNS names [kubernetes kubernetes.default kubernetes.default.svc kubernetes.default.svc.cluster.local lexicon] and IPs [10.96.0.1 10.0.0.6]</span>
</span><span id="__span-19-13"><a id="__codelineno-19-13" name="__codelineno-19-13" href="#__codelineno-19-13"></a><span class="go">[certs] Generating &quot;apiserver-kubelet-client&quot; certificate and key</span>
</span><span id="__span-19-14"><a id="__codelineno-19-14" name="__codelineno-19-14" href="#__codelineno-19-14"></a><span class="go">[certs] Generating &quot;front-proxy-ca&quot; certificate and key</span>
</span><span id="__span-19-15"><a id="__codelineno-19-15" name="__codelineno-19-15" href="#__codelineno-19-15"></a><span class="go">[certs] Generating &quot;front-proxy-client&quot; certificate and key</span>
</span><span id="__span-19-16"><a id="__codelineno-19-16" name="__codelineno-19-16" href="#__codelineno-19-16"></a><span class="go">[certs] Generating &quot;etcd/ca&quot; certificate and key</span>
</span><span id="__span-19-17"><a id="__codelineno-19-17" name="__codelineno-19-17" href="#__codelineno-19-17"></a><span class="go">[certs] Generating &quot;etcd/server&quot; certificate and key</span>
</span><span id="__span-19-18"><a id="__codelineno-19-18" name="__codelineno-19-18" href="#__codelineno-19-18"></a><span class="go">[certs] etcd/server serving cert is signed for DNS names [lexicon localhost] and IPs [10.0.0.6 127.0.0.1 ::1]</span>
</span><span id="__span-19-19"><a id="__codelineno-19-19" name="__codelineno-19-19" href="#__codelineno-19-19"></a><span class="go">[certs] Generating &quot;etcd/peer&quot; certificate and key</span>
</span><span id="__span-19-20"><a id="__codelineno-19-20" name="__codelineno-19-20" href="#__codelineno-19-20"></a><span class="go">[certs] etcd/peer serving cert is signed for DNS names [lexicon localhost] and IPs [10.0.0.6 127.0.0.1 ::1]</span>
</span><span id="__span-19-21"><a id="__codelineno-19-21" name="__codelineno-19-21" href="#__codelineno-19-21"></a><span class="go">[certs] Generating &quot;etcd/healthcheck-client&quot; certificate and key</span>
</span><span id="__span-19-22"><a id="__codelineno-19-22" name="__codelineno-19-22" href="#__codelineno-19-22"></a><span class="go">[certs] Generating &quot;apiserver-etcd-client&quot; certificate and key</span>
</span><span id="__span-19-23"><a id="__codelineno-19-23" name="__codelineno-19-23" href="#__codelineno-19-23"></a><span class="go">[certs] Generating &quot;sa&quot; key and public key</span>
</span><span id="__span-19-24"><a id="__codelineno-19-24" name="__codelineno-19-24" href="#__codelineno-19-24"></a><span class="go">[kubeconfig] Using kubeconfig folder &quot;/etc/kubernetes&quot;</span>
</span><span id="__span-19-25"><a id="__codelineno-19-25" name="__codelineno-19-25" href="#__codelineno-19-25"></a><span class="go">[kubeconfig] Writing &quot;admin.conf&quot; kubeconfig file</span>
</span><span id="__span-19-26"><a id="__codelineno-19-26" name="__codelineno-19-26" href="#__codelineno-19-26"></a><span class="go">[kubeconfig] Writing &quot;kubelet.conf&quot; kubeconfig file</span>
</span><span id="__span-19-27"><a id="__codelineno-19-27" name="__codelineno-19-27" href="#__codelineno-19-27"></a><span class="go">[kubeconfig] Writing &quot;controller-manager.conf&quot; kubeconfig file</span>
</span><span id="__span-19-28"><a id="__codelineno-19-28" name="__codelineno-19-28" href="#__codelineno-19-28"></a><span class="go">[kubeconfig] Writing &quot;scheduler.conf&quot; kubeconfig file</span>
</span><span id="__span-19-29"><a id="__codelineno-19-29" name="__codelineno-19-29" href="#__codelineno-19-29"></a><span class="go">[kubelet-start] Writing kubelet environment file with flags to file &quot;/var/lib/kubelet/kubeadm-flags.env&quot;</span>
</span><span id="__span-19-30"><a id="__codelineno-19-30" name="__codelineno-19-30" href="#__codelineno-19-30"></a><span class="go">[kubelet-start] Writing kubelet configuration to file &quot;/var/lib/kubelet/config.yaml&quot;</span>
</span><span id="__span-19-31"><a id="__codelineno-19-31" name="__codelineno-19-31" href="#__codelineno-19-31"></a><span class="go">[kubelet-start] Starting the kubelet</span>
</span><span id="__span-19-32"><a id="__codelineno-19-32" name="__codelineno-19-32" href="#__codelineno-19-32"></a><span class="go">[control-plane] Using manifest folder &quot;/etc/kubernetes/manifests&quot;</span>
</span><span id="__span-19-33"><a id="__codelineno-19-33" name="__codelineno-19-33" href="#__codelineno-19-33"></a><span class="go">[control-plane] Creating static Pod manifest for &quot;kube-apiserver&quot;</span>
</span><span id="__span-19-34"><a id="__codelineno-19-34" name="__codelineno-19-34" href="#__codelineno-19-34"></a><span class="go">[control-plane] Creating static Pod manifest for &quot;kube-controller-manager&quot;</span>
</span><span id="__span-19-35"><a id="__codelineno-19-35" name="__codelineno-19-35" href="#__codelineno-19-35"></a><span class="go">[control-plane] Creating static Pod manifest for &quot;kube-scheduler&quot;</span>
</span><span id="__span-19-36"><a id="__codelineno-19-36" name="__codelineno-19-36" href="#__codelineno-19-36"></a><span class="go">[etcd] Creating static Pod manifest for local etcd in &quot;/etc/kubernetes/manifests&quot;</span>
</span><span id="__span-19-37"><a id="__codelineno-19-37" name="__codelineno-19-37" href="#__codelineno-19-37"></a><span class="go">[wait-control-plane] Waiting for the kubelet to boot up the control plane as static Pods from directory &quot;/etc/kubernetes/manifests&quot;. This can take up to 4m0s</span>
</span><span id="__span-19-38"><a id="__codelineno-19-38" name="__codelineno-19-38" href="#__codelineno-19-38"></a><span class="go">[apiclient] All control plane components are healthy after 6.505763 seconds</span>
</span><span id="__span-19-39"><a id="__codelineno-19-39" name="__codelineno-19-39" href="#__codelineno-19-39"></a><span class="go">[upload-config] Storing the configuration used in ConfigMap &quot;kubeadm-config&quot; in the &quot;kube-system&quot; Namespace</span>
</span><span id="__span-19-40"><a id="__codelineno-19-40" name="__codelineno-19-40" href="#__codelineno-19-40"></a><span class="go">[kubelet] Creating a ConfigMap &quot;kubelet-config&quot; in namespace kube-system with the configuration for the kubelets in the cluster</span>
</span><span id="__span-19-41"><a id="__codelineno-19-41" name="__codelineno-19-41" href="#__codelineno-19-41"></a><span class="go">[upload-certs] Skipping phase. Please see --upload-certs</span>
</span><span id="__span-19-42"><a id="__codelineno-19-42" name="__codelineno-19-42" href="#__codelineno-19-42"></a><span class="go">[mark-control-plane] Marking the node lexicon as control-plane by adding the labels: [node-role.kubernetes.io/control-plane node.kubernetes.io/exclude-from-external-load-balancers]</span>
</span><span id="__span-19-43"><a id="__codelineno-19-43" name="__codelineno-19-43" href="#__codelineno-19-43"></a><span class="go">[mark-control-plane] Marking the node lexicon as control-plane by adding the taints [node-role.kubernetes.io/control-plane:NoSchedule]</span>
</span><span id="__span-19-44"><a id="__codelineno-19-44" name="__codelineno-19-44" href="#__codelineno-19-44"></a><span class="go">[bootstrap-token] Using token: 8gotcn.nco65l9atfr0l77c</span>
</span><span id="__span-19-45"><a id="__codelineno-19-45" name="__codelineno-19-45" href="#__codelineno-19-45"></a><span class="go">[bootstrap-token] Configuring bootstrap tokens, cluster-info ConfigMap, RBAC Roles</span>
</span><span id="__span-19-46"><a id="__codelineno-19-46" name="__codelineno-19-46" href="#__codelineno-19-46"></a><span class="go">[bootstrap-token] Configured RBAC rules to allow Node Bootstrap tokens to get nodes</span>
</span><span id="__span-19-47"><a id="__codelineno-19-47" name="__codelineno-19-47" href="#__codelineno-19-47"></a><span class="go">[bootstrap-token] Configured RBAC rules to allow Node Bootstrap tokens to post CSRs in order for nodes to get long term certificate credentials</span>
</span><span id="__span-19-48"><a id="__codelineno-19-48" name="__codelineno-19-48" href="#__codelineno-19-48"></a><span class="go">[bootstrap-token] Configured RBAC rules to allow the csrapprover controller automatically approve CSRs from a Node Bootstrap Token</span>
</span><span id="__span-19-49"><a id="__codelineno-19-49" name="__codelineno-19-49" href="#__codelineno-19-49"></a><span class="go">[bootstrap-token] Configured RBAC rules to allow certificate rotation for all node client certificates in the cluster</span>
</span><span id="__span-19-50"><a id="__codelineno-19-50" name="__codelineno-19-50" href="#__codelineno-19-50"></a><span class="go">[bootstrap-token] Creating the &quot;cluster-info&quot; ConfigMap in the &quot;kube-public&quot; namespace</span>
</span><span id="__span-19-51"><a id="__codelineno-19-51" name="__codelineno-19-51" href="#__codelineno-19-51"></a><span class="go">[kubelet-finalize] Updating &quot;/etc/kubernetes/kubelet.conf&quot; to point to a rotatable kubelet client certificate and key</span>
</span><span id="__span-19-52"><a id="__codelineno-19-52" name="__codelineno-19-52" href="#__codelineno-19-52"></a><span class="go">[addons] Applied essential addon: CoreDNS</span>
</span><span id="__span-19-53"><a id="__codelineno-19-53" name="__codelineno-19-53" href="#__codelineno-19-53"></a><span class="go">[addons] Applied essential addon: kube-proxy</span>
</span><span id="__span-19-54"><a id="__codelineno-19-54" name="__codelineno-19-54" href="#__codelineno-19-54"></a>
</span><span id="__span-19-55"><a id="__codelineno-19-55" name="__codelineno-19-55" href="#__codelineno-19-55"></a><span class="go">Your Kubernetes control-plane has initialized successfully!</span>
</span><span id="__span-19-56"><a id="__codelineno-19-56" name="__codelineno-19-56" href="#__codelineno-19-56"></a>
</span><span id="__span-19-57"><a id="__codelineno-19-57" name="__codelineno-19-57" href="#__codelineno-19-57"></a><span class="go">To start using your cluster, you need to run the following as a regular user:</span>
</span><span id="__span-19-58"><a id="__codelineno-19-58" name="__codelineno-19-58" href="#__codelineno-19-58"></a>
</span><span id="__span-19-59"><a id="__codelineno-19-59" name="__codelineno-19-59" href="#__codelineno-19-59"></a><span class="go">  mkdir -p $HOME/.kube</span>
</span><span id="__span-19-60"><a id="__codelineno-19-60" name="__codelineno-19-60" href="#__codelineno-19-60"></a><span class="go">  sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config</span>
</span><span id="__span-19-61"><a id="__codelineno-19-61" name="__codelineno-19-61" href="#__codelineno-19-61"></a><span class="go">  sudo chown $(id -u):$(id -g) $HOME/.kube/config</span>
</span><span id="__span-19-62"><a id="__codelineno-19-62" name="__codelineno-19-62" href="#__codelineno-19-62"></a>
</span><span id="__span-19-63"><a id="__codelineno-19-63" name="__codelineno-19-63" href="#__codelineno-19-63"></a><span class="go">Alternatively, if you are the root user, you can run:</span>
</span><span id="__span-19-64"><a id="__codelineno-19-64" name="__codelineno-19-64" href="#__codelineno-19-64"></a>
</span><span id="__span-19-65"><a id="__codelineno-19-65" name="__codelineno-19-65" href="#__codelineno-19-65"></a><span class="go">  export KUBECONFIG=/etc/kubernetes/admin.conf</span>
</span><span id="__span-19-66"><a id="__codelineno-19-66" name="__codelineno-19-66" href="#__codelineno-19-66"></a>
</span><span id="__span-19-67"><a id="__codelineno-19-67" name="__codelineno-19-67" href="#__codelineno-19-67"></a><span class="go">You should now deploy a pod network to the cluster.</span>
</span><span id="__span-19-68"><a id="__codelineno-19-68" name="__codelineno-19-68" href="#__codelineno-19-68"></a><span class="go">Run &quot;kubectl apply -f [podnetwork].yaml&quot; with one of the options listed at:</span>
</span><span id="__span-19-69"><a id="__codelineno-19-69" name="__codelineno-19-69" href="#__codelineno-19-69"></a><span class="go">  https://kubernetes.io/docs/concepts/cluster-administration/addons/</span>
</span><span id="__span-19-70"><a id="__codelineno-19-70" name="__codelineno-19-70" href="#__codelineno-19-70"></a>
</span><span id="__span-19-71"><a id="__codelineno-19-71" name="__codelineno-19-71" href="#__codelineno-19-71"></a><span class="go">Then you can join any number of worker nodes by running the following on each as root:</span>
</span><span id="__span-19-72"><a id="__codelineno-19-72" name="__codelineno-19-72" href="#__codelineno-19-72"></a>
</span><span id="__span-19-73"><a id="__codelineno-19-73" name="__codelineno-19-73" href="#__codelineno-19-73"></a><span class="go">kubeadm join 10.0.0.6:6443 --token 8gotcn.nco65l9atfr0l77c \</span>
</span><span id="__span-19-74"><a id="__codelineno-19-74" name="__codelineno-19-74" href="#__codelineno-19-74"></a><span class="go">        --discovery-token-ca-cert-hash \</span>
</span><span id="__span-19-75"><a id="__codelineno-19-75" name="__codelineno-19-75" href="#__codelineno-19-75"></a><span class="go">  sha256:40002a46e8b15a41883d4d35fa68cef6ff2203fe79095da867b56a090abafa1a</span>
</span></code></pre></div>
<p>Confirm the flag is sent in
<code>/var/lib/kubelet/kubeadm-flags.env</code>
to use the desired container runtime:</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-20-1"><a id="__codelineno-20-1" name="__codelineno-20-1" href="#__codelineno-20-1"></a><span class="gp"># </span>grep<span class="w"> </span>container-runtime<span class="w"> </span>/var/lib/kubelet/kubeadm-flags.env
</span><span id="__span-20-2"><a id="__codelineno-20-2" name="__codelineno-20-2" href="#__codelineno-20-2"></a><span class="go">KUBELET_KUBEADM_ARGS=&quot;--container-runtime-endpoint=unix:/run/containerd/containerd.sock --pod-infra-container-image=registry.k8s.io/pause:3.9&quot;</span>
</span></code></pre></div>
<p>Check the customer status; as <code>root</code> one can simply point
<code>KUBECONFIG</code> to the cluster's <code>admin.conf</code>:</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-21-1"><a id="__codelineno-21-1" name="__codelineno-21-1" href="#__codelineno-21-1"></a><span class="gp"># </span><span class="nb">export</span><span class="w"> </span><span class="nv">KUBECONFIG</span><span class="o">=</span>/etc/kubernetes/admin.conf
</span><span id="__span-21-2"><a id="__codelineno-21-2" name="__codelineno-21-2" href="#__codelineno-21-2"></a><span class="gp"># </span>kubectl<span class="w"> </span>cluster-info
</span><span id="__span-21-3"><a id="__codelineno-21-3" name="__codelineno-21-3" href="#__codelineno-21-3"></a><span class="go">Kubernetes control plane is running at https://10.0.0.6:6443</span>
</span><span id="__span-21-4"><a id="__codelineno-21-4" name="__codelineno-21-4" href="#__codelineno-21-4"></a><span class="go">CoreDNS is running at https://10.0.0.6:6443/api/v1/namespaces/kube-system/services/kube-dns:dns/proxy</span>
</span><span id="__span-21-5"><a id="__codelineno-21-5" name="__codelineno-21-5" href="#__codelineno-21-5"></a>
</span><span id="__span-21-6"><a id="__codelineno-21-6" name="__codelineno-21-6" href="#__codelineno-21-6"></a><span class="go">To further debug and diagnose cluster problems, use &#39;kubectl cluster-info dump&#39;.</span>
</span></code></pre></div>
<p>To run <code>kubectl</code> as non-root, make a copy of that file under
your own <code>~/.kube</code> directory:</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-22-1"><a id="__codelineno-22-1" name="__codelineno-22-1" href="#__codelineno-22-1"></a><span class="gp">$ </span>mkdir<span class="w"> </span><span class="nv">$HOME</span>/.kube
</span><span id="__span-22-2"><a id="__codelineno-22-2" name="__codelineno-22-2" href="#__codelineno-22-2"></a><span class="gp">$ </span>sudo<span class="w"> </span>cp<span class="w"> </span>-f<span class="w"> </span>/etc/kubernetes/admin.conf<span class="w"> </span><span class="nv">$HOME</span>/.kube/config
</span><span id="__span-22-3"><a id="__codelineno-22-3" name="__codelineno-22-3" href="#__codelineno-22-3"></a><span class="gp">$ </span>sudo<span class="w"> </span>chown<span class="w"> </span><span class="k">$(</span>id<span class="w"> </span>-u<span class="k">)</span>:<span class="k">$(</span>id<span class="w"> </span>-g<span class="k">)</span><span class="w"> </span><span class="nv">$HOME</span>/.kube/config
</span><span id="__span-22-4"><a id="__codelineno-22-4" name="__codelineno-22-4" href="#__codelineno-22-4"></a><span class="gp">$ </span>ls<span class="w"> </span>-l<span class="w"> </span><span class="nv">$HOME</span>/.kube/config
</span><span id="__span-22-5"><a id="__codelineno-22-5" name="__codelineno-22-5" href="#__codelineno-22-5"></a><span class="go">-rw------- 1 coder coder 5659 Feb 19   2023 /home/coder/.kube/config</span>
</span><span id="__span-22-6"><a id="__codelineno-22-6" name="__codelineno-22-6" href="#__codelineno-22-6"></a>
</span><span id="__span-22-7"><a id="__codelineno-22-7" name="__codelineno-22-7" href="#__codelineno-22-7"></a><span class="gp">$ </span>kubectl<span class="w"> </span>cluster-info
</span><span id="__span-22-8"><a id="__codelineno-22-8" name="__codelineno-22-8" href="#__codelineno-22-8"></a><span class="go">Kubernetes control plane is running at https://10.0.0.6:6443</span>
</span><span id="__span-22-9"><a id="__codelineno-22-9" name="__codelineno-22-9" href="#__codelineno-22-9"></a><span class="go">CoreDNS is running at https://10.0.0.6:6443/api/v1/namespaces/kube-system/services/kube-dns:dns/proxy</span>
</span><span id="__span-22-10"><a id="__codelineno-22-10" name="__codelineno-22-10" href="#__codelineno-22-10"></a>
</span><span id="__span-22-11"><a id="__codelineno-22-11" name="__codelineno-22-11" href="#__codelineno-22-11"></a><span class="go">To further debug and diagnose cluster problems, use &#39;kubectl cluster-info dump&#39;.</span>
</span></code></pre></div>
<h4 id="enable-systemd-cgroups">Enable systemd cgroups</h4>
<p>Containerd defauls to disabling systemd cgroups, which causes
the cluster to go into a crash-loop, making <code>kubectl</code> fail:</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-23-1"><a id="__codelineno-23-1" name="__codelineno-23-1" href="#__codelineno-23-1"></a><span class="go">E0322 22:45:47.847433 1825724 memcache.go:265] couldn&#39;t get current server API group list:</span>
</span><span id="__span-23-2"><a id="__codelineno-23-2" name="__codelineno-23-2" href="#__codelineno-23-2"></a><span class="go">Get &quot;https://10.0.0.6:6443/api?timeout=32s&quot;: dial tcp 10.0.0.6:6443: connect: connection refused</span>
</span></code></pre></div>
<p>In this scenario <code>etcd</code> will not be listening on port 6443 (check with <code>netstat -na</code>) and <code>journalctl</code> will show lots of
errors, starting with:</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-24-1"><a id="__codelineno-24-1" name="__codelineno-24-1" href="#__codelineno-24-1"></a><span class="gp"># </span>journalctl<span class="w"> </span>-xe<span class="w"> </span><span class="p">|</span><span class="w"> </span>egrep<span class="w"> </span>-i<span class="w"> </span><span class="s1">&#39;container|docker|kube|clust&#39;</span>
</span><span id="__span-24-2"><a id="__codelineno-24-2" name="__codelineno-24-2" href="#__codelineno-24-2"></a><span class="go">Mar 22 22:46:50 lexicon kubelet[1658461]: E0322 22:46:50.716943 1658461 pod_workers.go:965]</span>
</span><span id="__span-24-3"><a id="__codelineno-24-3" name="__codelineno-24-3" href="#__codelineno-24-3"></a><span class="go">&quot;Error syncing pod, skipping&quot; err=&quot;failed to \&quot;StartContainer\&quot; for \&quot;kube-apiserver\&quot; with CrashLoopBackOff:</span>
</span><span id="__span-24-4"><a id="__codelineno-24-4" name="__codelineno-24-4" href="#__codelineno-24-4"></a><span class="go">\&quot;back-off 5m0s restarting failed container=kube-apiserver</span>
</span><span id="__span-24-5"><a id="__codelineno-24-5" name="__codelineno-24-5" href="#__codelineno-24-5"></a><span class="go">pod=kube-apiserver-lexicon_kube-system(b003695d86b7fa8a74df14eff26934a5)\&quot;&quot;</span>
</span><span id="__span-24-6"><a id="__codelineno-24-6" name="__codelineno-24-6" href="#__codelineno-24-6"></a><span class="go">pod=&quot;kube-system/kube-apiserver-lexicon&quot; podUID=b003695d86b7fa8a74df14eff26934a5</span>
</span></code></pre></div>
<p>This <code>CrashLoopBackOff</code> error is a sign of 
<a href="https://github.com/containerd/containerd/issues/6009">containerd issue #6009</a>. To fix the problem,
<a href="https://github.com/containerd/containerd/issues/6009#issuecomment-1121672553">the workaround</a>
is to set <code>SystemdCgroup = true</code> in
<code>/etc/containerd/config.toml</code> and restart the cluster with</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-25-1"><a id="__codelineno-25-1" name="__codelineno-25-1" href="#__codelineno-25-1"></a><span class="gp"># </span>systemctl<span class="w"> </span>restart<span class="w"> </span>containerd
</span><span id="__span-25-2"><a id="__codelineno-25-2" name="__codelineno-25-2" href="#__codelineno-25-2"></a><span class="gp"># </span>systemctl<span class="w"> </span>restart<span class="w"> </span>kubelet
</span></code></pre></div>
<h3 id="network-plugin">Network Plugin</h3>
<p>A Kubernetes cluster needs a simple layer 3 network for nodes
to communicate (even for a single-node cluster):</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-26-1"><a id="__codelineno-26-1" name="__codelineno-26-1" href="#__codelineno-26-1"></a><span class="gp">$ </span>wget<span class="w"> </span>https://raw.githubusercontent.com/flannel-io/flannel/master/Documentation/kube-flannel.yml
</span><span id="__span-26-2"><a id="__codelineno-26-2" name="__codelineno-26-2" href="#__codelineno-26-2"></a>
</span><span id="__span-26-3"><a id="__codelineno-26-3" name="__codelineno-26-3" href="#__codelineno-26-3"></a><span class="gp">$ </span>kubectl<span class="w"> </span>apply<span class="w"> </span>-f<span class="w"> </span>kube-flannel.yml
</span><span id="__span-26-4"><a id="__codelineno-26-4" name="__codelineno-26-4" href="#__codelineno-26-4"></a><span class="go">namespace/kube-flannel created</span>
</span><span id="__span-26-5"><a id="__codelineno-26-5" name="__codelineno-26-5" href="#__codelineno-26-5"></a><span class="go">clusterrole.rbac.authorization.k8s.io/flannel created</span>
</span><span id="__span-26-6"><a id="__codelineno-26-6" name="__codelineno-26-6" href="#__codelineno-26-6"></a><span class="go">clusterrolebinding.rbac.authorization.k8s.io/flannel created</span>
</span><span id="__span-26-7"><a id="__codelineno-26-7" name="__codelineno-26-7" href="#__codelineno-26-7"></a><span class="go">serviceaccount/flannel created</span>
</span><span id="__span-26-8"><a id="__codelineno-26-8" name="__codelineno-26-8" href="#__codelineno-26-8"></a><span class="go">configmap/kube-flannel-cfg created</span>
</span><span id="__span-26-9"><a id="__codelineno-26-9" name="__codelineno-26-9" href="#__codelineno-26-9"></a><span class="go">daemonset.apps/kube-flannel-ds created</span>
</span><span id="__span-26-10"><a id="__codelineno-26-10" name="__codelineno-26-10" href="#__codelineno-26-10"></a>
</span><span id="__span-26-11"><a id="__codelineno-26-11" name="__codelineno-26-11" href="#__codelineno-26-11"></a><span class="gp">$ </span>kubectl<span class="w"> </span>get<span class="w"> </span>pods<span class="w"> </span>-n<span class="w"> </span>kube-flannel
</span><span id="__span-26-12"><a id="__codelineno-26-12" name="__codelineno-26-12" href="#__codelineno-26-12"></a><span class="go">NAME                    READY   STATUS    RESTARTS   AGE</span>
</span><span id="__span-26-13"><a id="__codelineno-26-13" name="__codelineno-26-13" href="#__codelineno-26-13"></a><span class="go">kube-flannel-ds-nrrg6   1/1     Running   0          22s</span>
</span></code></pre></div>
<h3 id="add-worker-nodes">Add Worker Nodes</h3>
<p>First, confirm the master node is ready:</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-27-1"><a id="__codelineno-27-1" name="__codelineno-27-1" href="#__codelineno-27-1"></a><span class="gp">$ </span>kubectl<span class="w"> </span>get<span class="w"> </span>nodes<span class="w"> </span>-o<span class="w"> </span>wide
</span><span id="__span-27-2"><a id="__codelineno-27-2" name="__codelineno-27-2" href="#__codelineno-27-2"></a><span class="go">NAME      STATUS   ROLES           AGE   VERSION   INTERNAL-IP   EXTERNAL-IP   OS-IMAGE             KERNEL-VERSION      CONTAINER-RUNTIME</span>
</span><span id="__span-27-3"><a id="__codelineno-27-3" name="__codelineno-27-3" href="#__codelineno-27-3"></a><span class="go">lexicon   Ready    control-plane   9d    v1.26.3   10.0.0.6      &lt;none&gt;        Ubuntu 22.04.2 LTS   5.15.0-69-generic   containerd://1.6.19</span>
</span></code></pre></div>
<p>At this point, for a
<a href="https://github.com/calebhailey/homelab/issues/3">single-node cluster</a>,
the command provided by <code>kubeadm init</code> is used to add the
same system as a worker:</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-28-1"><a id="__codelineno-28-1" name="__codelineno-28-1" href="#__codelineno-28-1"></a><span class="gp"># </span>kubeadm<span class="w"> </span>join<span class="w"> </span><span class="m">10</span>.0.0.6:6443<span class="w"> </span>--token<span class="w"> </span>8gotcn.nco65l9atfr0l77c<span class="w"> </span><span class="se">\</span>
</span><span id="__span-28-2"><a id="__codelineno-28-2" name="__codelineno-28-2" href="#__codelineno-28-2"></a><span class="w">        </span>--discovery-token-ca-cert-hash<span class="w"> </span><span class="se">\</span>
</span><span id="__span-28-3"><a id="__codelineno-28-3" name="__codelineno-28-3" href="#__codelineno-28-3"></a><span class="w">  </span>sha256:40002a46e8b15a41883d4d35fa68cef6ff2203fe79095da867b56a090abafa1a
</span><span id="__span-28-4"><a id="__codelineno-28-4" name="__codelineno-28-4" href="#__codelineno-28-4"></a><span class="go">[preflight] Running pre-flight checks</span>
</span><span id="__span-28-5"><a id="__codelineno-28-5" name="__codelineno-28-5" href="#__codelineno-28-5"></a><span class="go">error execution phase preflight: [preflight] Some fatal errors occurred:</span>
</span><span id="__span-28-6"><a id="__codelineno-28-6" name="__codelineno-28-6" href="#__codelineno-28-6"></a><span class="go">        [ERROR FileAvailable--etc-kubernetes-kubelet.conf]: /etc/kubernetes/kubelet.conf already exists</span>
</span><span id="__span-28-7"><a id="__codelineno-28-7" name="__codelineno-28-7" href="#__codelineno-28-7"></a><span class="go">        [ERROR Port-10250]: Port 10250 is in use</span>
</span><span id="__span-28-8"><a id="__codelineno-28-8" name="__codelineno-28-8" href="#__codelineno-28-8"></a><span class="go">        [ERROR FileAvailable--etc-kubernetes-pki-ca.crt]: /etc/kubernetes/pki/ca.crt already exists</span>
</span><span id="__span-28-9"><a id="__codelineno-28-9" name="__codelineno-28-9" href="#__codelineno-28-9"></a><span class="go">[preflight] If you know what you are doing, you can make a check non-fatal with `--ignore-preflight-errors=...`</span>
</span><span id="__span-28-10"><a id="__codelineno-28-10" name="__codelineno-28-10" href="#__codelineno-28-10"></a><span class="go">To see the stack trace of this error execute with --v=5 or higher</span>
</span></code></pre></div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><code>kubeadm join</code> <strong>must</strong> be run as <code>root</code>.</p>
</div>
<p>At first the <code>kubeadm join</code> above fails because a Kubernetes
cluster <em>is not supposed</em> to have the same system work as
both master and worker.
This manifests as the node being <em>tainted</em>:</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-29-1"><a id="__codelineno-29-1" name="__codelineno-29-1" href="#__codelineno-29-1"></a><span class="gp">$ </span>kubectl<span class="w"> </span>describe<span class="w"> </span>node<span class="w"> </span>lexicon
</span><span id="__span-29-2"><a id="__codelineno-29-2" name="__codelineno-29-2" href="#__codelineno-29-2"></a><span class="go">Name:               lexicon</span>
</span><span id="__span-29-3"><a id="__codelineno-29-3" name="__codelineno-29-3" href="#__codelineno-29-3"></a><span class="go">Roles:              control-plane</span>
</span><span id="__span-29-4"><a id="__codelineno-29-4" name="__codelineno-29-4" href="#__codelineno-29-4"></a><span class="go">...</span>
</span><span id="__span-29-5"><a id="__codelineno-29-5" name="__codelineno-29-5" href="#__codelineno-29-5"></a><span class="go">Taints:             node-role.kubernetes.io/control-plane:NoSchedule</span>
</span><span id="__span-29-6"><a id="__codelineno-29-6" name="__codelineno-29-6" href="#__codelineno-29-6"></a><span class="go">Unschedulable:      false</span>
</span></code></pre></div>
<p>For a single-node cluster the only option appears to be
<a href="https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/create-cluster-kubeadm/#control-plane-node-isolation">Control plane node isolation</a>
as recommended in 
<a href="https://github.com/calebhailey/homelab/issues/3">github.com/calebhailey/homelab/issues/3</a>. After this, there is no taint:</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-30-1"><a id="__codelineno-30-1" name="__codelineno-30-1" href="#__codelineno-30-1"></a><span class="gp">$ </span>kubectl<span class="w"> </span>taint<span class="w"> </span>nodes<span class="w"> </span>--all<span class="w"> </span><span class="se">\</span>
</span><span id="__span-30-2"><a id="__codelineno-30-2" name="__codelineno-30-2" href="#__codelineno-30-2"></a><span class="w">  </span>node-role.kubernetes.io/control-plane-node/lexicon<span class="w"> </span>untainted
</span><span id="__span-30-3"><a id="__codelineno-30-3" name="__codelineno-30-3" href="#__codelineno-30-3"></a>
</span><span id="__span-30-4"><a id="__codelineno-30-4" name="__codelineno-30-4" href="#__codelineno-30-4"></a><span class="gp">$ </span>kubectl<span class="w"> </span>describe<span class="w"> </span>node<span class="w"> </span>lexicon
</span><span id="__span-30-5"><a id="__codelineno-30-5" name="__codelineno-30-5" href="#__codelineno-30-5"></a><span class="go">Name:               lexicon</span>
</span><span id="__span-30-6"><a id="__codelineno-30-6" name="__codelineno-30-6" href="#__codelineno-30-6"></a><span class="go">Roles:              control-plane</span>
</span><span id="__span-30-7"><a id="__codelineno-30-7" name="__codelineno-30-7" href="#__codelineno-30-7"></a><span class="go">Labels:             beta.kubernetes.io/arch=amd64</span>
</span><span id="__span-30-8"><a id="__codelineno-30-8" name="__codelineno-30-8" href="#__codelineno-30-8"></a><span class="go">                    beta.kubernetes.io/os=linux</span>
</span><span id="__span-30-9"><a id="__codelineno-30-9" name="__codelineno-30-9" href="#__codelineno-30-9"></a><span class="go">                    kubernetes.io/arch=amd64</span>
</span><span id="__span-30-10"><a id="__codelineno-30-10" name="__codelineno-30-10" href="#__codelineno-30-10"></a><span class="go">                    kubernetes.io/hostname=lexicon</span>
</span><span id="__span-30-11"><a id="__codelineno-30-11" name="__codelineno-30-11" href="#__codelineno-30-11"></a><span class="go">                    kubernetes.io/os=linux</span>
</span><span id="__span-30-12"><a id="__codelineno-30-12" name="__codelineno-30-12" href="#__codelineno-30-12"></a><span class="go">                    node-role.kubernetes.io/control-plane=</span>
</span><span id="__span-30-13"><a id="__codelineno-30-13" name="__codelineno-30-13" href="#__codelineno-30-13"></a><span class="go">                    node.kubernetes.io/exclude-from-external-load-balancers=</span>
</span><span id="__span-30-14"><a id="__codelineno-30-14" name="__codelineno-30-14" href="#__codelineno-30-14"></a><span class="go">Annotations:        flannel.alpha.coreos.com/backend-data: {&quot;VNI&quot;:1,&quot;VtepMAC&quot;:&quot;32:ae:4c:6b:5d:6f&quot;}</span>
</span><span id="__span-30-15"><a id="__codelineno-30-15" name="__codelineno-30-15" href="#__codelineno-30-15"></a><span class="go">                    flannel.alpha.coreos.com/backend-type: vxlan</span>
</span><span id="__span-30-16"><a id="__codelineno-30-16" name="__codelineno-30-16" href="#__codelineno-30-16"></a><span class="go">                    flannel.alpha.coreos.com/kube-subnet-manager: true</span>
</span><span id="__span-30-17"><a id="__codelineno-30-17" name="__codelineno-30-17" href="#__codelineno-30-17"></a><span class="go">                    flannel.alpha.coreos.com/public-ip: 10.0.0.6</span>
</span><span id="__span-30-18"><a id="__codelineno-30-18" name="__codelineno-30-18" href="#__codelineno-30-18"></a><span class="go">                    kubeadm.alpha.kubernetes.io/cri-socket: unix:/run/containerd/containerd.sock</span>
</span><span id="__span-30-19"><a id="__codelineno-30-19" name="__codelineno-30-19" href="#__codelineno-30-19"></a><span class="go">                    node.alpha.kubernetes.io/ttl: 0</span>
</span><span id="__span-30-20"><a id="__codelineno-30-20" name="__codelineno-30-20" href="#__codelineno-30-20"></a><span class="go">                    volumes.kubernetes.io/controller-managed-attach-detach: true</span>
</span><span id="__span-30-21"><a id="__codelineno-30-21" name="__codelineno-30-21" href="#__codelineno-30-21"></a><span class="go">CreationTimestamp:  Wed, 22 Mar 2023 22:37:43 +0100</span>
</span><span id="__span-30-22"><a id="__codelineno-30-22" name="__codelineno-30-22" href="#__codelineno-30-22"></a><span class="go">Taints:             &lt;none&gt;</span>
</span></code></pre></div>
<p>At this point the Kubernetes cluster is up and running and can
be tested deploying a test application:</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-31-1"><a id="__codelineno-31-1" name="__codelineno-31-1" href="#__codelineno-31-1"></a><span class="gp">$ </span>kubectl<span class="w"> </span>apply<span class="w"> </span>-f<span class="w"> </span>https://k8s.io/examples/pods/commands.yaml
</span><span id="__span-31-2"><a id="__codelineno-31-2" name="__codelineno-31-2" href="#__codelineno-31-2"></a>
</span><span id="__span-31-3"><a id="__codelineno-31-3" name="__codelineno-31-3" href="#__codelineno-31-3"></a><span class="gp">$ </span>kubectl<span class="w"> </span>events<span class="w"> </span>pods
</span><span id="__span-31-4"><a id="__codelineno-31-4" name="__codelineno-31-4" href="#__codelineno-31-4"></a><span class="go">LAST SEEN   TYPE     REASON      OBJECT             MESSAGE</span>
</span><span id="__span-31-5"><a id="__codelineno-31-5" name="__codelineno-31-5" href="#__codelineno-31-5"></a><span class="go">44m         Normal   NodeReady   Node/lexicon       Node lexicon status is now: NodeReady</span>
</span><span id="__span-31-6"><a id="__codelineno-31-6" name="__codelineno-31-6" href="#__codelineno-31-6"></a><span class="go">27s         Normal   Scheduled   Pod/command-demo   Successfully assigned default/command-demo to lexicon</span>
</span><span id="__span-31-7"><a id="__codelineno-31-7" name="__codelineno-31-7" href="#__codelineno-31-7"></a><span class="go">27s         Normal   Pulling     Pod/command-demo   Pulling image &quot;debian&quot;</span>
</span><span id="__span-31-8"><a id="__codelineno-31-8" name="__codelineno-31-8" href="#__codelineno-31-8"></a><span class="go">21s         Normal   Pulled      Pod/command-demo   Successfully pulled image &quot;debian&quot; in 5.452640392s (5.452649743s including waiting)</span>
</span><span id="__span-31-9"><a id="__codelineno-31-9" name="__codelineno-31-9" href="#__codelineno-31-9"></a><span class="go">21s         Normal   Created     Pod/command-demo   Created container command-demo-container</span>
</span><span id="__span-31-10"><a id="__codelineno-31-10" name="__codelineno-31-10" href="#__codelineno-31-10"></a><span class="go">21s         Normal   Started     Pod/command-demo   Started container command-demo-container</span>
</span></code></pre></div>
<h3 id="metallb-load-balancer">MetalLB Load Balancer</h3>
<p>The <a href="https://computingforgeeks.com/deploy-metallb-load-balancer-on-kubernetes/">MetalLB Load Balancer</a>
is going to be necessary for the <a href="#dashboard">Dashboard</a>
and future applications, to expose individual services via
open ports on the server (<code>NodePort</code>) or virtual IP addresses.</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-32-1"><a id="__codelineno-32-1" name="__codelineno-32-1" href="#__codelineno-32-1"></a><span class="gp">$ </span>wget<span class="w"> </span><span class="se">\</span>
</span><span id="__span-32-2"><a id="__codelineno-32-2" name="__codelineno-32-2" href="#__codelineno-32-2"></a><span class="gp">https://raw.githubusercontent.com/metallb/metallb/v$</span>MetalLB_RTAG/config/manifests/metallb-native.yaml
</span><span id="__span-32-3"><a id="__codelineno-32-3" name="__codelineno-32-3" href="#__codelineno-32-3"></a>
</span><span id="__span-32-4"><a id="__codelineno-32-4" name="__codelineno-32-4" href="#__codelineno-32-4"></a><span class="gp">$ </span>kubectl<span class="w"> </span>apply<span class="w"> </span>-f<span class="w"> </span>metallb-native.yaml
</span><span id="__span-32-5"><a id="__codelineno-32-5" name="__codelineno-32-5" href="#__codelineno-32-5"></a><span class="go">namespace/metallb-system created</span>
</span><span id="__span-32-6"><a id="__codelineno-32-6" name="__codelineno-32-6" href="#__codelineno-32-6"></a><span class="go">customresourcedefinition.apiextensions.k8s.io/addresspools.metallb.io created</span>
</span><span id="__span-32-7"><a id="__codelineno-32-7" name="__codelineno-32-7" href="#__codelineno-32-7"></a><span class="go">customresourcedefinition.apiextensions.k8s.io/bfdprofiles.metallb.io created</span>
</span><span id="__span-32-8"><a id="__codelineno-32-8" name="__codelineno-32-8" href="#__codelineno-32-8"></a><span class="go">customresourcedefinition.apiextensions.k8s.io/bgpadvertisements.metallb.io created</span>
</span><span id="__span-32-9"><a id="__codelineno-32-9" name="__codelineno-32-9" href="#__codelineno-32-9"></a><span class="go">customresourcedefinition.apiextensions.k8s.io/bgppeers.metallb.io created</span>
</span><span id="__span-32-10"><a id="__codelineno-32-10" name="__codelineno-32-10" href="#__codelineno-32-10"></a><span class="go">customresourcedefinition.apiextensions.k8s.io/communities.metallb.io created</span>
</span><span id="__span-32-11"><a id="__codelineno-32-11" name="__codelineno-32-11" href="#__codelineno-32-11"></a><span class="go">customresourcedefinition.apiextensions.k8s.io/ipaddresspools.metallb.io created</span>
</span><span id="__span-32-12"><a id="__codelineno-32-12" name="__codelineno-32-12" href="#__codelineno-32-12"></a><span class="go">customresourcedefinition.apiextensions.k8s.io/l2advertisements.metallb.io created</span>
</span><span id="__span-32-13"><a id="__codelineno-32-13" name="__codelineno-32-13" href="#__codelineno-32-13"></a><span class="go">serviceaccount/controller created</span>
</span><span id="__span-32-14"><a id="__codelineno-32-14" name="__codelineno-32-14" href="#__codelineno-32-14"></a><span class="go">serviceaccount/speaker created</span>
</span><span id="__span-32-15"><a id="__codelineno-32-15" name="__codelineno-32-15" href="#__codelineno-32-15"></a><span class="go">role.rbac.authorization.k8s.io/controller created</span>
</span><span id="__span-32-16"><a id="__codelineno-32-16" name="__codelineno-32-16" href="#__codelineno-32-16"></a><span class="go">role.rbac.authorization.k8s.io/pod-lister created</span>
</span><span id="__span-32-17"><a id="__codelineno-32-17" name="__codelineno-32-17" href="#__codelineno-32-17"></a><span class="go">clusterrole.rbac.authorization.k8s.io/metallb-system:controller created</span>
</span><span id="__span-32-18"><a id="__codelineno-32-18" name="__codelineno-32-18" href="#__codelineno-32-18"></a><span class="go">clusterrole.rbac.authorization.k8s.io/metallb-system:speaker created</span>
</span><span id="__span-32-19"><a id="__codelineno-32-19" name="__codelineno-32-19" href="#__codelineno-32-19"></a><span class="go">rolebinding.rbac.authorization.k8s.io/controller created</span>
</span><span id="__span-32-20"><a id="__codelineno-32-20" name="__codelineno-32-20" href="#__codelineno-32-20"></a><span class="go">rolebinding.rbac.authorization.k8s.io/pod-lister created</span>
</span><span id="__span-32-21"><a id="__codelineno-32-21" name="__codelineno-32-21" href="#__codelineno-32-21"></a><span class="go">clusterrolebinding.rbac.authorization.k8s.io/metallb-system:controller created</span>
</span><span id="__span-32-22"><a id="__codelineno-32-22" name="__codelineno-32-22" href="#__codelineno-32-22"></a><span class="go">clusterrolebinding.rbac.authorization.k8s.io/metallb-system:speaker created</span>
</span><span id="__span-32-23"><a id="__codelineno-32-23" name="__codelineno-32-23" href="#__codelineno-32-23"></a><span class="go">secret/webhook-server-cert created</span>
</span><span id="__span-32-24"><a id="__codelineno-32-24" name="__codelineno-32-24" href="#__codelineno-32-24"></a><span class="go">service/webhook-service created</span>
</span><span id="__span-32-25"><a id="__codelineno-32-25" name="__codelineno-32-25" href="#__codelineno-32-25"></a><span class="go">deployment.apps/controller created</span>
</span><span id="__span-32-26"><a id="__codelineno-32-26" name="__codelineno-32-26" href="#__codelineno-32-26"></a><span class="go">daemonset.apps/speaker created</span>
</span><span id="__span-32-27"><a id="__codelineno-32-27" name="__codelineno-32-27" href="#__codelineno-32-27"></a><span class="go">validatingwebhookconfiguration.admissionregistration.k8s.io/metallb-webhook-configuration created</span>
</span></code></pre></div>
<p>After a few seconds the deployment should have the controller
and speaker running:</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-33-1"><a id="__codelineno-33-1" name="__codelineno-33-1" href="#__codelineno-33-1"></a><span class="gp">$ </span>kubectl<span class="w"> </span>get<span class="w"> </span>all<span class="w"> </span>-n<span class="w"> </span>metallb-system<span class="w"> </span>
</span><span id="__span-33-2"><a id="__codelineno-33-2" name="__codelineno-33-2" href="#__codelineno-33-2"></a><span class="go">NAME                              READY   STATUS    RESTARTS   AGE</span>
</span><span id="__span-33-3"><a id="__codelineno-33-3" name="__codelineno-33-3" href="#__codelineno-33-3"></a><span class="go">pod/controller-68bf958bf9-kzcfg   1/1     Running   0          32s</span>
</span><span id="__span-33-4"><a id="__codelineno-33-4" name="__codelineno-33-4" href="#__codelineno-33-4"></a><span class="go">pod/speaker-78bvh                 1/1     Running   0          32s</span>
</span><span id="__span-33-5"><a id="__codelineno-33-5" name="__codelineno-33-5" href="#__codelineno-33-5"></a>
</span><span id="__span-33-6"><a id="__codelineno-33-6" name="__codelineno-33-6" href="#__codelineno-33-6"></a><span class="go">NAME                      TYPE        CLUSTER-IP     EXTERNAL-IP   PORT(S)   AGE</span>
</span><span id="__span-33-7"><a id="__codelineno-33-7" name="__codelineno-33-7" href="#__codelineno-33-7"></a><span class="go">service/webhook-service   ClusterIP   10.96.89.141   &lt;none&gt;        443/TCP   32s</span>
</span><span id="__span-33-8"><a id="__codelineno-33-8" name="__codelineno-33-8" href="#__codelineno-33-8"></a>
</span><span id="__span-33-9"><a id="__codelineno-33-9" name="__codelineno-33-9" href="#__codelineno-33-9"></a><span class="go">NAME                     DESIRED   CURRENT   READY   UP-TO-DATE   AVAILABLE   NODE SELECTOR            AGE</span>
</span><span id="__span-33-10"><a id="__codelineno-33-10" name="__codelineno-33-10" href="#__codelineno-33-10"></a><span class="go">daemonset.apps/speaker   1         1         1       1            1           kubernetes.io/os=linux   32s</span>
</span><span id="__span-33-11"><a id="__codelineno-33-11" name="__codelineno-33-11" href="#__codelineno-33-11"></a>
</span><span id="__span-33-12"><a id="__codelineno-33-12" name="__codelineno-33-12" href="#__codelineno-33-12"></a><span class="go">NAME                         READY   UP-TO-DATE   AVAILABLE   AGE</span>
</span><span id="__span-33-13"><a id="__codelineno-33-13" name="__codelineno-33-13" href="#__codelineno-33-13"></a><span class="go">deployment.apps/controller   1/1     1            1           32s</span>
</span><span id="__span-33-14"><a id="__codelineno-33-14" name="__codelineno-33-14" href="#__codelineno-33-14"></a>
</span><span id="__span-33-15"><a id="__codelineno-33-15" name="__codelineno-33-15" href="#__codelineno-33-15"></a><span class="go">NAME                                    DESIRED   CURRENT   READY   AGE</span>
</span><span id="__span-33-16"><a id="__codelineno-33-16" name="__codelineno-33-16" href="#__codelineno-33-16"></a><span class="go">replicaset.apps/controller-68bf958bf9   1         1         1       32s</span>
</span><span id="__span-33-17"><a id="__codelineno-33-17" name="__codelineno-33-17" href="#__codelineno-33-17"></a>
</span><span id="__span-33-18"><a id="__codelineno-33-18" name="__codelineno-33-18" href="#__codelineno-33-18"></a><span class="gp">$ </span>kubectl<span class="w"> </span>get<span class="w"> </span>pods<span class="w"> </span>-n<span class="w"> </span>metallb-system<span class="w"> </span>
</span><span id="__span-33-19"><a id="__codelineno-33-19" name="__codelineno-33-19" href="#__codelineno-33-19"></a><span class="go">NAME                          READY   STATUS    RESTARTS   AGE</span>
</span><span id="__span-33-20"><a id="__codelineno-33-20" name="__codelineno-33-20" href="#__codelineno-33-20"></a><span class="go">controller-68bf958bf9-kzcfg   1/1     Running   0          92s</span>
</span><span id="__span-33-21"><a id="__codelineno-33-21" name="__codelineno-33-21" href="#__codelineno-33-21"></a><span class="go">speaker-78bvh                 1/1     Running   0          92s</span>
</span></code></pre></div>
<p>At this point the components are idle waiting for a working
<a href="https://metallb.universe.tf/configuration/">configuration</a>;
edit <code>ipaddress_pools.yaml</code> to set a range of IP addresses:</p>
<div class="language-yaml highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">ipaddress_pools.yaml</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-34-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-34-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-34-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-34-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-34-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-34-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-34-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-34-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-34-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-34-10">10</a></span>
<span class="normal"><a href="#__codelineno-34-11">11</a></span>
<span class="normal"><a href="#__codelineno-34-12">12</a></span>
<span class="normal"><a href="#__codelineno-34-13">13</a></span>
<span class="normal"><a href="#__codelineno-34-14">14</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-34-1"><a id="__codelineno-34-1" name="__codelineno-34-1"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">metallb.io/v1beta1</span>
</span><span id="__span-34-2"><a id="__codelineno-34-2" name="__codelineno-34-2"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">IPAddressPool</span>
</span><span id="__span-34-3"><a id="__codelineno-34-3" name="__codelineno-34-3"></a><span class="nt">metadata</span><span class="p">:</span>
</span><span id="__span-34-4"><a id="__codelineno-34-4" name="__codelineno-34-4"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">production</span>
</span><span id="__span-34-5"><a id="__codelineno-34-5" name="__codelineno-34-5"></a><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">metallb-system</span>
</span><span id="__span-34-6"><a id="__codelineno-34-6" name="__codelineno-34-6"></a><span class="nt">spec</span><span class="p">:</span>
</span><span id="__span-34-7"><a id="__codelineno-34-7" name="__codelineno-34-7"></a><span class="w">  </span><span class="nt">addresses</span><span class="p">:</span>
</span><span id="__span-34-8"><a id="__codelineno-34-8" name="__codelineno-34-8"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">192.168.0.122-192.168.0.140</span>
</span><span id="__span-34-9"><a id="__codelineno-34-9" name="__codelineno-34-9"></a><span class="nn">---</span>
</span><span id="__span-34-10"><a id="__codelineno-34-10" name="__codelineno-34-10"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">metallb.io/v1beta1</span>
</span><span id="__span-34-11"><a id="__codelineno-34-11" name="__codelineno-34-11"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">L2Advertisement</span>
</span><span id="__span-34-12"><a id="__codelineno-34-12" name="__codelineno-34-12"></a><span class="nt">metadata</span><span class="p">:</span>
</span><span id="__span-34-13"><a id="__codelineno-34-13" name="__codelineno-34-13"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">l2-advert</span>
</span><span id="__span-34-14"><a id="__codelineno-34-14" name="__codelineno-34-14"></a><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">metallb-system</span>
</span></code></pre></div></td></tr></table></div>
<p>The range <strong>192.168.0.122-192.168.0.140</strong> is based on the
local DHCP server being configured to lease 228 addresses
starting with 192.168.0.2. The current active leases are
reserved so they don’t change, and the range 122-140 are
just not leased so far. The reason to use IPs from the leased
range is that the router only allows adding port forwarding
rules for those. This range is intentionally on the same
network range and subnet as the DHCP server so that no
routing is required to reach MetalLB IP addresses.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Layer 2 mode does not require the IPs to be bound
to the network interfaces of your worker nodes. It works by
responding to ARP requests on your local network directly,
to give the machine’s MAC address to clients.</p>
</div>
<div class="language-console highlight"><pre><span></span><code><span id="__span-35-1"><a id="__codelineno-35-1" name="__codelineno-35-1" href="#__codelineno-35-1"></a><span class="gp">$ </span>kubectl<span class="w"> </span>apply<span class="w"> </span>-f<span class="w"> </span>ipaddress_pools.yaml<span class="w"> </span>
</span><span id="__span-35-2"><a id="__codelineno-35-2" name="__codelineno-35-2" href="#__codelineno-35-2"></a><span class="go">ipaddresspool.metallb.io/production created</span>
</span><span id="__span-35-3"><a id="__codelineno-35-3" name="__codelineno-35-3" href="#__codelineno-35-3"></a><span class="go">l2advertisement.metallb.io/l2-advert created</span>
</span><span id="__span-35-4"><a id="__codelineno-35-4" name="__codelineno-35-4" href="#__codelineno-35-4"></a>
</span><span id="__span-35-5"><a id="__codelineno-35-5" name="__codelineno-35-5" href="#__codelineno-35-5"></a><span class="gp">$ </span>kubectl<span class="w"> </span>get<span class="w"> </span>ipaddresspool.metallb.io<span class="w"> </span>-n<span class="w"> </span>metallb-system
</span><span id="__span-35-6"><a id="__codelineno-35-6" name="__codelineno-35-6" href="#__codelineno-35-6"></a><span class="go">NAME         AUTO ASSIGN   AVOID BUGGY IPS   ADDRESSES</span>
</span><span id="__span-35-7"><a id="__codelineno-35-7" name="__codelineno-35-7" href="#__codelineno-35-7"></a><span class="go">production   true          false             [&quot;192.168.0.122-192.168.0.140&quot;]</span>
</span><span id="__span-35-8"><a id="__codelineno-35-8" name="__codelineno-35-8" href="#__codelineno-35-8"></a>
</span><span id="__span-35-9"><a id="__codelineno-35-9" name="__codelineno-35-9" href="#__codelineno-35-9"></a><span class="gp">$ </span>kubectl<span class="w"> </span>get<span class="w"> </span>l2advertisement.metallb.io<span class="w"> </span>-n<span class="w"> </span>metallb-system
</span><span id="__span-35-10"><a id="__codelineno-35-10" name="__codelineno-35-10" href="#__codelineno-35-10"></a><span class="go">NAME        IPADDRESSPOOLS   IPADDRESSPOOL SELECTORS   INTERFACES</span>
</span><span id="__span-35-11"><a id="__codelineno-35-11" name="__codelineno-35-11" href="#__codelineno-35-11"></a><span class="go">l2-advert                                              </span>
</span><span id="__span-35-12"><a id="__codelineno-35-12" name="__codelineno-35-12" href="#__codelineno-35-12"></a>
</span><span id="__span-35-13"><a id="__codelineno-35-13" name="__codelineno-35-13" href="#__codelineno-35-13"></a><span class="gp">$ </span>kubectl<span class="w"> </span>describe<span class="w"> </span>ipaddresspool.metallb.io<span class="w"> </span>production<span class="w"> </span>-n<span class="w"> </span>metallb-system
</span><span id="__span-35-14"><a id="__codelineno-35-14" name="__codelineno-35-14" href="#__codelineno-35-14"></a><span class="go">Name:         production</span>
</span><span id="__span-35-15"><a id="__codelineno-35-15" name="__codelineno-35-15" href="#__codelineno-35-15"></a><span class="go">Namespace:    metallb-system</span>
</span><span id="__span-35-16"><a id="__codelineno-35-16" name="__codelineno-35-16" href="#__codelineno-35-16"></a><span class="go">API Version:  metallb.io/v1beta1</span>
</span><span id="__span-35-17"><a id="__codelineno-35-17" name="__codelineno-35-17" href="#__codelineno-35-17"></a><span class="go">Kind:         IPAddressPool</span>
</span><span id="__span-35-18"><a id="__codelineno-35-18" name="__codelineno-35-18" href="#__codelineno-35-18"></a><span class="go">Spec:</span>
</span><span id="__span-35-19"><a id="__codelineno-35-19" name="__codelineno-35-19" href="#__codelineno-35-19"></a><span class="go">  Addresses:</span>
</span><span id="__span-35-20"><a id="__codelineno-35-20" name="__codelineno-35-20" href="#__codelineno-35-20"></a><span class="go">    192.168.0.122-192.168.0.140</span>
</span></code></pre></div>
<h4 id="test-metallb">Test MetalLB</h4>
<p>To test the load balancer with a demo web, create a 
deployment with <code>web-app-demo.yaml</code> as follows:</p>
<div class="language-yaml highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">web-app-demo.yaml</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-36-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-36-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-36-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-36-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-36-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-36-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-36-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-36-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-36-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-36-10">10</a></span>
<span class="normal"><a href="#__codelineno-36-11">11</a></span>
<span class="normal"><a href="#__codelineno-36-12">12</a></span>
<span class="normal"><a href="#__codelineno-36-13">13</a></span>
<span class="normal"><a href="#__codelineno-36-14">14</a></span>
<span class="normal"><a href="#__codelineno-36-15">15</a></span>
<span class="normal"><a href="#__codelineno-36-16">16</a></span>
<span class="normal"><a href="#__codelineno-36-17">17</a></span>
<span class="normal"><a href="#__codelineno-36-18">18</a></span>
<span class="normal"><a href="#__codelineno-36-19">19</a></span>
<span class="normal"><a href="#__codelineno-36-20">20</a></span>
<span class="normal"><a href="#__codelineno-36-21">21</a></span>
<span class="normal"><a href="#__codelineno-36-22">22</a></span>
<span class="normal"><a href="#__codelineno-36-23">23</a></span>
<span class="normal"><a href="#__codelineno-36-24">24</a></span>
<span class="normal"><a href="#__codelineno-36-25">25</a></span>
<span class="normal"><a href="#__codelineno-36-26">26</a></span>
<span class="normal"><a href="#__codelineno-36-27">27</a></span>
<span class="normal"><a href="#__codelineno-36-28">28</a></span>
<span class="normal"><a href="#__codelineno-36-29">29</a></span>
<span class="normal"><a href="#__codelineno-36-30">30</a></span>
<span class="normal"><a href="#__codelineno-36-31">31</a></span>
<span class="normal"><a href="#__codelineno-36-32">32</a></span>
<span class="normal"><a href="#__codelineno-36-33">33</a></span>
<span class="normal"><a href="#__codelineno-36-34">34</a></span>
<span class="normal"><a href="#__codelineno-36-35">35</a></span>
<span class="normal"><a href="#__codelineno-36-36">36</a></span>
<span class="normal"><a href="#__codelineno-36-37">37</a></span>
<span class="normal"><a href="#__codelineno-36-38">38</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-36-1"><a id="__codelineno-36-1" name="__codelineno-36-1"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
</span><span id="__span-36-2"><a id="__codelineno-36-2" name="__codelineno-36-2"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Namespace</span>
</span><span id="__span-36-3"><a id="__codelineno-36-3" name="__codelineno-36-3"></a><span class="nt">metadata</span><span class="p">:</span>
</span><span id="__span-36-4"><a id="__codelineno-36-4" name="__codelineno-36-4"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">web</span>
</span><span id="__span-36-5"><a id="__codelineno-36-5" name="__codelineno-36-5"></a><span class="nn">---</span>
</span><span id="__span-36-6"><a id="__codelineno-36-6" name="__codelineno-36-6"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">apps/v1</span>
</span><span id="__span-36-7"><a id="__codelineno-36-7" name="__codelineno-36-7"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Deployment</span>
</span><span id="__span-36-8"><a id="__codelineno-36-8" name="__codelineno-36-8"></a><span class="nt">metadata</span><span class="p">:</span>
</span><span id="__span-36-9"><a id="__codelineno-36-9" name="__codelineno-36-9"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">web-server</span>
</span><span id="__span-36-10"><a id="__codelineno-36-10" name="__codelineno-36-10"></a><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">web</span>
</span><span id="__span-36-11"><a id="__codelineno-36-11" name="__codelineno-36-11"></a><span class="nt">spec</span><span class="p">:</span>
</span><span id="__span-36-12"><a id="__codelineno-36-12" name="__codelineno-36-12"></a><span class="w">  </span><span class="nt">selector</span><span class="p">:</span>
</span><span id="__span-36-13"><a id="__codelineno-36-13" name="__codelineno-36-13"></a><span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span>
</span><span id="__span-36-14"><a id="__codelineno-36-14" name="__codelineno-36-14"></a><span class="w">      </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">web</span>
</span><span id="__span-36-15"><a id="__codelineno-36-15" name="__codelineno-36-15"></a><span class="w">  </span><span class="nt">template</span><span class="p">:</span>
</span><span id="__span-36-16"><a id="__codelineno-36-16" name="__codelineno-36-16"></a><span class="w">    </span><span class="nt">metadata</span><span class="p">:</span>
</span><span id="__span-36-17"><a id="__codelineno-36-17" name="__codelineno-36-17"></a><span class="w">      </span><span class="nt">labels</span><span class="p">:</span>
</span><span id="__span-36-18"><a id="__codelineno-36-18" name="__codelineno-36-18"></a><span class="w">        </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">web</span>
</span><span id="__span-36-19"><a id="__codelineno-36-19" name="__codelineno-36-19"></a><span class="w">    </span><span class="nt">spec</span><span class="p">:</span>
</span><span id="__span-36-20"><a id="__codelineno-36-20" name="__codelineno-36-20"></a><span class="w">      </span><span class="nt">containers</span><span class="p">:</span>
</span><span id="__span-36-21"><a id="__codelineno-36-21" name="__codelineno-36-21"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">httpd</span>
</span><span id="__span-36-22"><a id="__codelineno-36-22" name="__codelineno-36-22"></a><span class="w">        </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">httpd:alpine</span>
</span><span id="__span-36-23"><a id="__codelineno-36-23" name="__codelineno-36-23"></a><span class="w">        </span><span class="nt">ports</span><span class="p">:</span>
</span><span id="__span-36-24"><a id="__codelineno-36-24" name="__codelineno-36-24"></a><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">containerPort</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">80</span>
</span><span id="__span-36-25"><a id="__codelineno-36-25" name="__codelineno-36-25"></a><span class="nn">---</span>
</span><span id="__span-36-26"><a id="__codelineno-36-26" name="__codelineno-36-26"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
</span><span id="__span-36-27"><a id="__codelineno-36-27" name="__codelineno-36-27"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Service</span>
</span><span id="__span-36-28"><a id="__codelineno-36-28" name="__codelineno-36-28"></a><span class="nt">metadata</span><span class="p">:</span>
</span><span id="__span-36-29"><a id="__codelineno-36-29" name="__codelineno-36-29"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">web-server-service</span>
</span><span id="__span-36-30"><a id="__codelineno-36-30" name="__codelineno-36-30"></a><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">web</span>
</span><span id="__span-36-31"><a id="__codelineno-36-31" name="__codelineno-36-31"></a><span class="nt">spec</span><span class="p">:</span>
</span><span id="__span-36-32"><a id="__codelineno-36-32" name="__codelineno-36-32"></a><span class="w">  </span><span class="nt">selector</span><span class="p">:</span>
</span><span id="__span-36-33"><a id="__codelineno-36-33" name="__codelineno-36-33"></a><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">web</span>
</span><span id="__span-36-34"><a id="__codelineno-36-34" name="__codelineno-36-34"></a><span class="w">  </span><span class="nt">ports</span><span class="p">:</span>
</span><span id="__span-36-35"><a id="__codelineno-36-35" name="__codelineno-36-35"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">TCP</span>
</span><span id="__span-36-36"><a id="__codelineno-36-36" name="__codelineno-36-36"></a><span class="w">      </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">80</span>
</span><span id="__span-36-37"><a id="__codelineno-36-37" name="__codelineno-36-37"></a><span class="w">      </span><span class="nt">targetPort</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">80</span>
</span><span id="__span-36-38"><a id="__codelineno-36-38" name="__codelineno-36-38"></a><span class="w">  </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">LoadBalancer</span>
</span></code></pre></div></td></tr></table></div>
<div class="language-console highlight"><pre><span></span><code><span id="__span-37-1"><a id="__codelineno-37-1" name="__codelineno-37-1" href="#__codelineno-37-1"></a><span class="gp">$ </span>kubectl<span class="w"> </span>apply<span class="w"> </span>-f<span class="w"> </span>web-app-demo.yaml
</span><span id="__span-37-2"><a id="__codelineno-37-2" name="__codelineno-37-2" href="#__codelineno-37-2"></a><span class="gp">$ </span>kubectl<span class="w"> </span>get<span class="w"> </span>all<span class="w"> </span>-n<span class="w"> </span>web
</span><span id="__span-37-3"><a id="__codelineno-37-3" name="__codelineno-37-3" href="#__codelineno-37-3"></a><span class="go">NAME                              READY   STATUS    RESTARTS   AGE</span>
</span><span id="__span-37-4"><a id="__codelineno-37-4" name="__codelineno-37-4" href="#__codelineno-37-4"></a><span class="go">pod/web-server-5879949fb7-4c6r9   1/1     Running   0          26s</span>
</span><span id="__span-37-5"><a id="__codelineno-37-5" name="__codelineno-37-5" href="#__codelineno-37-5"></a>
</span><span id="__span-37-6"><a id="__codelineno-37-6" name="__codelineno-37-6" href="#__codelineno-37-6"></a><span class="go">NAME                         TYPE           CLUSTER-IP      EXTERNAL-IP     PORT(S)        AGE</span>
</span><span id="__span-37-7"><a id="__codelineno-37-7" name="__codelineno-37-7" href="#__codelineno-37-7"></a><span class="go">service/web-server-service   LoadBalancer   10.111.32.131   192.168.0.122   80:32468/TCP   3s</span>
</span><span id="__span-37-8"><a id="__codelineno-37-8" name="__codelineno-37-8" href="#__codelineno-37-8"></a>
</span><span id="__span-37-9"><a id="__codelineno-37-9" name="__codelineno-37-9" href="#__codelineno-37-9"></a><span class="go">NAME                         READY   UP-TO-DATE   AVAILABLE   AGE</span>
</span><span id="__span-37-10"><a id="__codelineno-37-10" name="__codelineno-37-10" href="#__codelineno-37-10"></a><span class="go">deployment.apps/web-server   1/1     1            1           26s</span>
</span><span id="__span-37-11"><a id="__codelineno-37-11" name="__codelineno-37-11" href="#__codelineno-37-11"></a>
</span><span id="__span-37-12"><a id="__codelineno-37-12" name="__codelineno-37-12" href="#__codelineno-37-12"></a><span class="go">NAME                                    DESIRED   CURRENT   READY   AGE</span>
</span><span id="__span-37-13"><a id="__codelineno-37-13" name="__codelineno-37-13" href="#__codelineno-37-13"></a><span class="go">replicaset.apps/web-server-5879949fb7   1         1         1       26s</span>
</span><span id="__span-37-14"><a id="__codelineno-37-14" name="__codelineno-37-14" href="#__codelineno-37-14"></a>
</span><span id="__span-37-15"><a id="__codelineno-37-15" name="__codelineno-37-15" href="#__codelineno-37-15"></a><span class="gp">$ </span>curl<span class="w"> </span>http://192.168.0.122/
</span><span id="__span-37-16"><a id="__codelineno-37-16" name="__codelineno-37-16" href="#__codelineno-37-16"></a><span class="go">&lt;html&gt;&lt;body&gt;&lt;h1&gt;It works!&lt;/h1&gt;&lt;/body&gt;&lt;/html&gt;</span>
</span></code></pre></div>
<p>This only works from other hosts in the local network when
using an IP range in the same subnet, otherwise requests will
time out.</p>
<p>Also, this is not enough to make this IP’s port 80 reachable
from other networks. Adding a port forwarding rule in the
router to redirect port 12080 externally to port 80 on
192.168.0.122  works in that requests are forwarded to the
right port, but then requests are rejected.</p>
<h3 id="ingress-controller">Ingress Controller</h3>
<p>In addition to the load balancer, I also wanted to
<a href="https://computingforgeeks.com/deploy-nginx-ingress-controller-on-kubernetes-using-helm-chart/">deploy Nginx Ingress Controller</a>
to redirect HTTPS requests to different services.</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-38-1"><a id="__codelineno-38-1" name="__codelineno-38-1" href="#__codelineno-38-1"></a><span class="gp">$ </span><span class="nv">controller_tag</span><span class="o">=</span><span class="k">$(</span>curl<span class="w"> </span>-s<span class="w"> </span>https://api.github.com/repos/kubernetes/ingress-nginx/releases/latest<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>tag_name<span class="w"> </span><span class="p">|</span><span class="w"> </span>cut<span class="w"> </span>-d<span class="w"> </span><span class="s1">&#39;&quot;&#39;</span><span class="w"> </span>-f<span class="w"> </span><span class="m">4</span><span class="k">)</span>
</span><span id="__span-38-2"><a id="__codelineno-38-2" name="__codelineno-38-2" href="#__codelineno-38-2"></a><span class="gp">$ </span>wget<span class="w"> </span>-O<span class="w"> </span>nginx-ingress-controller-deploy.yaml<span class="w"> </span><span class="se">\</span>
</span><span id="__span-38-3"><a id="__codelineno-38-3" name="__codelineno-38-3" href="#__codelineno-38-3"></a><span class="w">  </span>https://raw.githubusercontent.com/kubernetes/ingress-nginx/<span class="si">${</span><span class="nv">controller_tag</span><span class="si">}</span>/deploy/static/provider/baremetal/deploy.yaml
</span><span id="__span-38-4"><a id="__codelineno-38-4" name="__codelineno-38-4" href="#__codelineno-38-4"></a><span class="gp">$ </span>sed<span class="w"> </span>-i<span class="w"> </span><span class="s1">&#39;s/type: NodePort/type: LoadBalancer/g&#39;</span><span class="w"> </span>nginx-ingress-controller-deploy.yaml
</span></code></pre></div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Since we already have <a href="#metallb-load-balancer">MetalLB</a>
configured with a range of IP addresses, change <strong>line 365</strong>
in <code>nginx-ingress-controller-deploy.yaml</code> to
<code>type: LoadBalancer</code> so that it gets an External IP.</p>
</div>
<div class="language-console highlight"><pre><span></span><code><span id="__span-39-1"><a id="__codelineno-39-1" name="__codelineno-39-1" href="#__codelineno-39-1"></a><span class="gp">$ </span>kubectl<span class="w"> </span>apply<span class="w"> </span>-f<span class="w"> </span>nginx-ingress-controller-deploy.yaml
</span><span id="__span-39-2"><a id="__codelineno-39-2" name="__codelineno-39-2" href="#__codelineno-39-2"></a><span class="go">namespace/ingress-nginx created</span>
</span><span id="__span-39-3"><a id="__codelineno-39-3" name="__codelineno-39-3" href="#__codelineno-39-3"></a><span class="go">serviceaccount/ingress-nginx created</span>
</span><span id="__span-39-4"><a id="__codelineno-39-4" name="__codelineno-39-4" href="#__codelineno-39-4"></a><span class="go">serviceaccount/ingress-nginx-admission created</span>
</span><span id="__span-39-5"><a id="__codelineno-39-5" name="__codelineno-39-5" href="#__codelineno-39-5"></a><span class="go">role.rbac.authorization.k8s.io/ingress-nginx created</span>
</span><span id="__span-39-6"><a id="__codelineno-39-6" name="__codelineno-39-6" href="#__codelineno-39-6"></a><span class="go">role.rbac.authorization.k8s.io/ingress-nginx-admission created</span>
</span><span id="__span-39-7"><a id="__codelineno-39-7" name="__codelineno-39-7" href="#__codelineno-39-7"></a><span class="go">clusterrole.rbac.authorization.k8s.io/ingress-nginx created</span>
</span><span id="__span-39-8"><a id="__codelineno-39-8" name="__codelineno-39-8" href="#__codelineno-39-8"></a><span class="go">clusterrole.rbac.authorization.k8s.io/ingress-nginx-admission created</span>
</span><span id="__span-39-9"><a id="__codelineno-39-9" name="__codelineno-39-9" href="#__codelineno-39-9"></a><span class="go">rolebinding.rbac.authorization.k8s.io/ingress-nginx created</span>
</span><span id="__span-39-10"><a id="__codelineno-39-10" name="__codelineno-39-10" href="#__codelineno-39-10"></a><span class="go">rolebinding.rbac.authorization.k8s.io/ingress-nginx-admission created</span>
</span><span id="__span-39-11"><a id="__codelineno-39-11" name="__codelineno-39-11" href="#__codelineno-39-11"></a><span class="go">clusterrolebinding.rbac.authorization.k8s.io/ingress-nginx created</span>
</span><span id="__span-39-12"><a id="__codelineno-39-12" name="__codelineno-39-12" href="#__codelineno-39-12"></a><span class="go">clusterrolebinding.rbac.authorization.k8s.io/ingress-nginx-admission created</span>
</span><span id="__span-39-13"><a id="__codelineno-39-13" name="__codelineno-39-13" href="#__codelineno-39-13"></a><span class="go">configmap/ingress-nginx-controller created</span>
</span><span id="__span-39-14"><a id="__codelineno-39-14" name="__codelineno-39-14" href="#__codelineno-39-14"></a><span class="go">service/ingress-nginx-controller created</span>
</span><span id="__span-39-15"><a id="__codelineno-39-15" name="__codelineno-39-15" href="#__codelineno-39-15"></a><span class="go">service/ingress-nginx-controller-admission created</span>
</span><span id="__span-39-16"><a id="__codelineno-39-16" name="__codelineno-39-16" href="#__codelineno-39-16"></a><span class="go">deployment.apps/ingress-nginx-controller created</span>
</span><span id="__span-39-17"><a id="__codelineno-39-17" name="__codelineno-39-17" href="#__codelineno-39-17"></a><span class="go">job.batch/ingress-nginx-admission-create created</span>
</span><span id="__span-39-18"><a id="__codelineno-39-18" name="__codelineno-39-18" href="#__codelineno-39-18"></a><span class="go">job.batch/ingress-nginx-admission-patch created</span>
</span><span id="__span-39-19"><a id="__codelineno-39-19" name="__codelineno-39-19" href="#__codelineno-39-19"></a><span class="go">ingressclass.networking.k8s.io/nginx created</span>
</span><span id="__span-39-20"><a id="__codelineno-39-20" name="__codelineno-39-20" href="#__codelineno-39-20"></a><span class="go">validatingwebhookconfiguration.admissionregistration.k8s.io/ingress-nginx-admission created</span>
</span><span id="__span-39-21"><a id="__codelineno-39-21" name="__codelineno-39-21" href="#__codelineno-39-21"></a>
</span><span id="__span-39-22"><a id="__codelineno-39-22" name="__codelineno-39-22" href="#__codelineno-39-22"></a><span class="gp">$ </span>kubectl<span class="w"> </span>get<span class="w"> </span>all<span class="w"> </span>-n<span class="w"> </span>ingress-nginx
</span><span id="__span-39-23"><a id="__codelineno-39-23" name="__codelineno-39-23" href="#__codelineno-39-23"></a><span class="go">NAME                                            READY   STATUS      RESTARTS   AGE</span>
</span><span id="__span-39-24"><a id="__codelineno-39-24" name="__codelineno-39-24" href="#__codelineno-39-24"></a><span class="go">pod/ingress-nginx-admission-create-wjzv4        0/1     Completed   0          107s</span>
</span><span id="__span-39-25"><a id="__codelineno-39-25" name="__codelineno-39-25" href="#__codelineno-39-25"></a><span class="go">pod/ingress-nginx-admission-patch-lcj2j         0/1     Completed   1          107s</span>
</span><span id="__span-39-26"><a id="__codelineno-39-26" name="__codelineno-39-26" href="#__codelineno-39-26"></a><span class="go">pod/ingress-nginx-controller-6b58ffdc97-2k2hk   1/1     Running     0          107s</span>
</span><span id="__span-39-27"><a id="__codelineno-39-27" name="__codelineno-39-27" href="#__codelineno-39-27"></a>
</span><span id="__span-39-28"><a id="__codelineno-39-28" name="__codelineno-39-28" href="#__codelineno-39-28"></a><span class="go">NAME                                         TYPE           CLUSTER-IP       EXTERNAL-IP     PORT(S)                      AGE</span>
</span><span id="__span-39-29"><a id="__codelineno-39-29" name="__codelineno-39-29" href="#__codelineno-39-29"></a><span class="go">service/ingress-nginx-controller             LoadBalancer   10.100.229.186   192.168.0.122   80:31137/TCP,443:31838/TCP   6s</span>
</span><span id="__span-39-30"><a id="__codelineno-39-30" name="__codelineno-39-30" href="#__codelineno-39-30"></a><span class="go">service/ingress-nginx-controller-admission   ClusterIP      10.99.206.192    &lt;none&gt;          443/TCP                      6s</span>
</span><span id="__span-39-31"><a id="__codelineno-39-31" name="__codelineno-39-31" href="#__codelineno-39-31"></a>
</span><span id="__span-39-32"><a id="__codelineno-39-32" name="__codelineno-39-32" href="#__codelineno-39-32"></a><span class="go">NAME                                       READY   UP-TO-DATE   AVAILABLE   AGE</span>
</span><span id="__span-39-33"><a id="__codelineno-39-33" name="__codelineno-39-33" href="#__codelineno-39-33"></a><span class="go">deployment.apps/ingress-nginx-controller   1/1     1            1           107s</span>
</span><span id="__span-39-34"><a id="__codelineno-39-34" name="__codelineno-39-34" href="#__codelineno-39-34"></a>
</span><span id="__span-39-35"><a id="__codelineno-39-35" name="__codelineno-39-35" href="#__codelineno-39-35"></a><span class="go">NAME                                                  DESIRED   CURRENT   READY   AGE</span>
</span><span id="__span-39-36"><a id="__codelineno-39-36" name="__codelineno-39-36" href="#__codelineno-39-36"></a><span class="go">replicaset.apps/ingress-nginx-controller-6b58ffdc97   1         1         1       107s</span>
</span><span id="__span-39-37"><a id="__codelineno-39-37" name="__codelineno-39-37" href="#__codelineno-39-37"></a>
</span><span id="__span-39-38"><a id="__codelineno-39-38" name="__codelineno-39-38" href="#__codelineno-39-38"></a><span class="go">NAME                                       COMPLETIONS   DURATION   AGE</span>
</span><span id="__span-39-39"><a id="__codelineno-39-39" name="__codelineno-39-39" href="#__codelineno-39-39"></a><span class="go">job.batch/ingress-nginx-admission-create   1/1           7s         107s</span>
</span><span id="__span-39-40"><a id="__codelineno-39-40" name="__codelineno-39-40" href="#__codelineno-39-40"></a><span class="go">job.batch/ingress-nginx-admission-patch    1/1           8s         107s</span>
</span></code></pre></div>
<h3 id="dashboard">Dashboard</h3>
<p><a href="https://computingforgeeks.com/how-to-install-kubernetes-dashboard-with-nodeport/">Installing the Kubernetes Dashboard</a></p>
<p>Download the manifest and change spec.type to LoadBalancer so it gets an External IP from MetalLB:</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-40-1"><a id="__codelineno-40-1" name="__codelineno-40-1" href="#__codelineno-40-1"></a><span class="gp">$ </span><span class="nv">VER</span><span class="o">=</span><span class="k">$(</span>curl<span class="w"> </span>-s<span class="w"> </span>https://api.github.com/repos/kubernetes/dashboard/releases/latest<span class="p">|</span>grep<span class="w"> </span>tag_name<span class="p">|</span>cut<span class="w"> </span>-d<span class="w"> </span><span class="s1">&#39;&quot;&#39;</span><span class="w"> </span>-f<span class="w"> </span><span class="m">4</span><span class="k">)</span>
</span><span id="__span-40-2"><a id="__codelineno-40-2" name="__codelineno-40-2" href="#__codelineno-40-2"></a><span class="gp">$ </span><span class="nb">echo</span><span class="w"> </span><span class="nv">$VER</span>
</span><span id="__span-40-3"><a id="__codelineno-40-3" name="__codelineno-40-3" href="#__codelineno-40-3"></a><span class="go">v2.7.0</span>
</span><span id="__span-40-4"><a id="__codelineno-40-4" name="__codelineno-40-4" href="#__codelineno-40-4"></a><span class="gp">$ </span>wget<span class="w"> </span>-O<span class="w"> </span>kubernetes-dashboard.yaml<span class="w"> </span><span class="se">\</span>
</span><span id="__span-40-5"><a id="__codelineno-40-5" name="__codelineno-40-5" href="#__codelineno-40-5"></a><span class="w">  </span>https://raw.githubusercontent.com/kubernetes/dashboard/<span class="nv">$VER</span>/aio/deploy/recommended.yaml<span class="w"> </span>
</span></code></pre></div>
<p>To make the dashboard easily available in the local network,
edit <code>kubernetes-dashboard.yaml</code> (around line 40) to set the
service to <code>LoadBalancer</code>:</p>
<div class="language-yaml highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">kubernetes-dashboard.yaml</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-41-36">36</a></span>
<span class="normal"><a href="#__codelineno-41-37">37</a></span>
<span class="normal"><a href="#__codelineno-41-38">38</a></span>
<span class="normal"><a href="#__codelineno-41-39">39</a></span>
<span class="normal"><a href="#__codelineno-41-40">40</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-41-36"><a id="__codelineno-41-36" name="__codelineno-41-36"></a><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">kubernetes-dashboard</span>
</span><span id="__span-41-37"><a id="__codelineno-41-37" name="__codelineno-41-37"></a><span class="nt">spec</span><span class="p">:</span>
</span><span id="__span-41-38"><a id="__codelineno-41-38" name="__codelineno-41-38"></a><span class="hll"><span class="w">  </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">LoadBalancer</span>
</span></span><span id="__span-41-39"><a id="__codelineno-41-39" name="__codelineno-41-39"></a><span class="w">  </span><span class="nt">ports</span><span class="p">:</span>
</span><span id="__span-41-40"><a id="__codelineno-41-40" name="__codelineno-41-40"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">443</span>
</span></code></pre></div></td></tr></table></div>
<p>Then deploy the Dashboard:</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-42-1"><a id="__codelineno-42-1" name="__codelineno-42-1" href="#__codelineno-42-1"></a><span class="gp">$ </span>kubectl<span class="w"> </span>apply<span class="w"> </span>-f<span class="w"> </span>kubernetes-dashboard.yaml
</span><span id="__span-42-2"><a id="__codelineno-42-2" name="__codelineno-42-2" href="#__codelineno-42-2"></a><span class="go">namespace/kubernetes-dashboard created</span>
</span><span id="__span-42-3"><a id="__codelineno-42-3" name="__codelineno-42-3" href="#__codelineno-42-3"></a><span class="go">serviceaccount/kubernetes-dashboard created</span>
</span><span id="__span-42-4"><a id="__codelineno-42-4" name="__codelineno-42-4" href="#__codelineno-42-4"></a><span class="go">service/kubernetes-dashboard created</span>
</span><span id="__span-42-5"><a id="__codelineno-42-5" name="__codelineno-42-5" href="#__codelineno-42-5"></a><span class="go">secret/kubernetes-dashboard-certs created</span>
</span><span id="__span-42-6"><a id="__codelineno-42-6" name="__codelineno-42-6" href="#__codelineno-42-6"></a><span class="go">secret/kubernetes-dashboard-csrf created</span>
</span><span id="__span-42-7"><a id="__codelineno-42-7" name="__codelineno-42-7" href="#__codelineno-42-7"></a><span class="go">secret/kubernetes-dashboard-key-holder created</span>
</span><span id="__span-42-8"><a id="__codelineno-42-8" name="__codelineno-42-8" href="#__codelineno-42-8"></a><span class="go">configmap/kubernetes-dashboard-settings created</span>
</span><span id="__span-42-9"><a id="__codelineno-42-9" name="__codelineno-42-9" href="#__codelineno-42-9"></a><span class="go">role.rbac.authorization.k8s.io/kubernetes-dashboard created</span>
</span><span id="__span-42-10"><a id="__codelineno-42-10" name="__codelineno-42-10" href="#__codelineno-42-10"></a><span class="go">clusterrole.rbac.authorization.k8s.io/kubernetes-dashboard created</span>
</span><span id="__span-42-11"><a id="__codelineno-42-11" name="__codelineno-42-11" href="#__codelineno-42-11"></a><span class="go">rolebinding.rbac.authorization.k8s.io/kubernetes-dashboard created</span>
</span><span id="__span-42-12"><a id="__codelineno-42-12" name="__codelineno-42-12" href="#__codelineno-42-12"></a><span class="go">clusterrolebinding.rbac.authorization.k8s.io/kubernetes-dashboard created</span>
</span><span id="__span-42-13"><a id="__codelineno-42-13" name="__codelineno-42-13" href="#__codelineno-42-13"></a><span class="go">deployment.apps/kubernetes-dashboard created</span>
</span><span id="__span-42-14"><a id="__codelineno-42-14" name="__codelineno-42-14" href="#__codelineno-42-14"></a><span class="go">service/dashboard-metrics-scraper created</span>
</span><span id="__span-42-15"><a id="__codelineno-42-15" name="__codelineno-42-15" href="#__codelineno-42-15"></a><span class="go">deployment.apps/dashboard-metrics-scraper created</span>
</span><span id="__span-42-16"><a id="__codelineno-42-16" name="__codelineno-42-16" href="#__codelineno-42-16"></a>
</span><span id="__span-42-17"><a id="__codelineno-42-17" name="__codelineno-42-17" href="#__codelineno-42-17"></a><span class="gp">$ </span>kubectl<span class="w"> </span>get<span class="w"> </span>all<span class="w"> </span>-n<span class="w"> </span>kubernetes-dashboard
</span><span id="__span-42-18"><a id="__codelineno-42-18" name="__codelineno-42-18" href="#__codelineno-42-18"></a><span class="go">NAME                                            READY   STATUS    RESTARTS   AGE</span>
</span><span id="__span-42-19"><a id="__codelineno-42-19" name="__codelineno-42-19" href="#__codelineno-42-19"></a><span class="go">pod/dashboard-metrics-scraper-7bc864c59-6k5tm   1/1     Running   0          33s</span>
</span><span id="__span-42-20"><a id="__codelineno-42-20" name="__codelineno-42-20" href="#__codelineno-42-20"></a><span class="go">pod/kubernetes-dashboard-6c7ccbcf87-qd5cg       1/1     Running   0          33s</span>
</span><span id="__span-42-21"><a id="__codelineno-42-21" name="__codelineno-42-21" href="#__codelineno-42-21"></a>
</span><span id="__span-42-22"><a id="__codelineno-42-22" name="__codelineno-42-22" href="#__codelineno-42-22"></a><span class="go">NAME                                TYPE           CLUSTER-IP      EXTERNAL-IP     PORT(S)         AGE</span>
</span><span id="__span-42-23"><a id="__codelineno-42-23" name="__codelineno-42-23" href="#__codelineno-42-23"></a><span class="go">service/dashboard-metrics-scraper   ClusterIP      10.98.87.20     &lt;none&gt;          8000/TCP        33s</span>
</span><span id="__span-42-24"><a id="__codelineno-42-24" name="__codelineno-42-24" href="#__codelineno-42-24"></a><span class="go">service/kubernetes-dashboard        LoadBalancer   10.99.222.155   192.168.0.123   443:31490/TCP   33s</span>
</span><span id="__span-42-25"><a id="__codelineno-42-25" name="__codelineno-42-25" href="#__codelineno-42-25"></a>
</span><span id="__span-42-26"><a id="__codelineno-42-26" name="__codelineno-42-26" href="#__codelineno-42-26"></a><span class="go">NAME                                        READY   UP-TO-DATE   AVAILABLE   AGE</span>
</span><span id="__span-42-27"><a id="__codelineno-42-27" name="__codelineno-42-27" href="#__codelineno-42-27"></a><span class="go">deployment.apps/dashboard-metrics-scraper   1/1     1            1           33s</span>
</span><span id="__span-42-28"><a id="__codelineno-42-28" name="__codelineno-42-28" href="#__codelineno-42-28"></a><span class="go">deployment.apps/kubernetes-dashboard        1/1     1            1           33s</span>
</span><span id="__span-42-29"><a id="__codelineno-42-29" name="__codelineno-42-29" href="#__codelineno-42-29"></a>
</span><span id="__span-42-30"><a id="__codelineno-42-30" name="__codelineno-42-30" href="#__codelineno-42-30"></a><span class="go">NAME                                                  DESIRED   CURRENT   READY   AGE</span>
</span><span id="__span-42-31"><a id="__codelineno-42-31" name="__codelineno-42-31" href="#__codelineno-42-31"></a><span class="go">replicaset.apps/dashboard-metrics-scraper-7bc864c59   1         1         1       33s</span>
</span><span id="__span-42-32"><a id="__codelineno-42-32" name="__codelineno-42-32" href="#__codelineno-42-32"></a><span class="go">replicaset.apps/kubernetes-dashboard-6c7ccbcf87       1         1         1       33s</span>
</span></code></pre></div>
<p>At this the dashboard is available at https://192.168.0.123/</p>
<h3 id="localpath-pv-provisioner">LocalPath PV provisioner</h3>
<p>By default, a Kubernetes cluster is not set up to provide
storage to pods. The recommended way is to use
<a href="https://kubernetes.io/docs/concepts/storage/persistent-volumes/#dynamic">dynamic volume provisioning</a>,
which is not currently enabled: <code>kube-apiserver</code> is running
with only <code>--enable-admission-plugins=NodeRestriction</code> which
means we need to enable the <code>DefaultStorageClass</code>
<a href="https://kubernetes.io/docs/reference/access-authn-authz/admission-controllers/#defaultstorageclass">admission controller</a>
on the API server, by updating this flag in line
20 of <code>/etc/kubernetes/manifests/kube-apiserver.yaml</code></p>
<p>Next, we need to create
<a href="https://kubernetes.io/docs/concepts/storage/persistent-volumes/">persistent volumes</a>
and <strong>mark a storage class as default</strong>.
Gitlab recommends setting <code>reclaimPolicy</code> to <code>Retain</code>.</p>
<blockquote>
<p>The name of a <code>StorageClass</code> object is significant, and is
how users can request a particular class. Administrators
set the name and other parameters of a class when first
creating <code>StorageClass</code> objects, and the objects cannot be
updated once they are created.</p>
</blockquote>
<p>To use
<a href="https://kubernetes.io/docs/concepts/storage/storage-classes/#local">Local</a>
volumes, will support <code>WaitForFirstConsumer</code> with
pre-created <code>PersistentVolume</code> binding, but not dynamic
provisioning.</p>
<p>For an easy way, we use the <em>Local Path Provisioner</em> from
<a href="https://www.rancher.com/">rancher.io</a>
with <code>/home/k8s/local-path-storage</code></p>
<p>To add a default storage class, I followed
<a href="https://computingforgeeks.com/">Computing for Geeks</a>'
article
<a href="https://computingforgeeks.com/dynamic-hostpath-pv-creation-in-kubernetes-using-local-path-provisioner/">Dynamic hostPath PV Creation in Kubernetes using Local Path Provisioner</a>.</p>
<p>First, the cluster needs to be enabled for dynamic volume
provisioning, which means making sure <code>kube-apiserver</code> is
running with
<code>--enable-admission-plugins=DefaultStorageClass</code> to enable
the <code>DefaultStorageClass</code> admission controller, by updating
this flag in line 20 of 
<code>/etc/kubernetes/manifests/kube-apiserver.yaml</code>
and restarting the <code>kubelet</code> service:</p>
<div class="language-yaml highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">kube-apiserver.yaml</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-43-12">12</a></span>
<span class="normal"><a href="#__codelineno-43-13">13</a></span>
<span class="normal"><a href="#__codelineno-43-14">14</a></span>
<span class="normal"><a href="#__codelineno-43-15">15</a></span>
<span class="normal"><a href="#__codelineno-43-16">16</a></span>
<span class="normal"><a href="#__codelineno-43-17">17</a></span>
<span class="normal"><a href="#__codelineno-43-18">18</a></span>
<span class="normal"><a href="#__codelineno-43-19">19</a></span>
<span class="normal"><a href="#__codelineno-43-20">20</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-43-12"><a id="__codelineno-43-12" name="__codelineno-43-12"></a><span class="nt">spec</span><span class="p">:</span>
</span><span id="__span-43-13"><a id="__codelineno-43-13" name="__codelineno-43-13"></a><span class="w">  </span><span class="nt">containers</span><span class="p">:</span>
</span><span id="__span-43-14"><a id="__codelineno-43-14" name="__codelineno-43-14"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">command</span><span class="p">:</span>
</span><span id="__span-43-15"><a id="__codelineno-43-15" name="__codelineno-43-15"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">kube-apiserver</span>
</span><span id="__span-43-16"><a id="__codelineno-43-16" name="__codelineno-43-16"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">--advertise-address=10.0.0.6</span>
</span><span id="__span-43-17"><a id="__codelineno-43-17" name="__codelineno-43-17"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">--allow-privileged=true</span>
</span><span id="__span-43-18"><a id="__codelineno-43-18" name="__codelineno-43-18"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">--authorization-mode=Node,RBAC</span>
</span><span id="__span-43-19"><a id="__codelineno-43-19" name="__codelineno-43-19"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">--client-ca-file=/etc/kubernetes/pki/ca.crt</span>
</span><span id="__span-43-20"><a id="__codelineno-43-20" name="__codelineno-43-20"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">--enable-admission-plugins=NodeRestriction,DefaultStorageClass</span>
</span></code></pre></div></td></tr></table></div>
<div class="language-console highlight"><pre><span></span><code><span id="__span-44-1"><a id="__codelineno-44-1" name="__codelineno-44-1" href="#__codelineno-44-1"></a><span class="gp"># </span>systemctl<span class="w"> </span>restart<span class="w"> </span>kubelet.service
</span></code></pre></div>
<p>Create a directory in the a file system where there is plenty of space:</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-45-1"><a id="__codelineno-45-1" name="__codelineno-45-1" href="#__codelineno-45-1"></a><span class="gp"># </span>mkdir<span class="w"> </span>/home/k8s/local-path-storage
</span><span id="__span-45-2"><a id="__codelineno-45-2" name="__codelineno-45-2" href="#__codelineno-45-2"></a><span class="gp"># </span>chmod<span class="w"> </span><span class="m">1777</span><span class="w"> </span>/home/k8s/local-path-storage
</span></code></pre></div>
<p>Create a deployment with Rancher’s PV provisioner, with the annotation to make it the default storage class and create a
deployment, e.g. <code>local-path-storage-as-default-class.yaml</code></p>
<details class="k8s">
<summary>Kubernetes deployment: <code>local-path-storage-as-default-class.yaml</code></summary>
<div class="language-yaml highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">local-path-storage-as-default-class.yaml</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-46-1">  1</a></span>
<span class="normal"><a href="#__codelineno-46-2">  2</a></span>
<span class="normal"><a href="#__codelineno-46-3">  3</a></span>
<span class="normal"><a href="#__codelineno-46-4">  4</a></span>
<span class="normal"><a href="#__codelineno-46-5">  5</a></span>
<span class="normal"><a href="#__codelineno-46-6">  6</a></span>
<span class="normal"><a href="#__codelineno-46-7">  7</a></span>
<span class="normal"><a href="#__codelineno-46-8">  8</a></span>
<span class="normal"><a href="#__codelineno-46-9">  9</a></span>
<span class="normal"><a href="#__codelineno-46-10"> 10</a></span>
<span class="normal"><a href="#__codelineno-46-11"> 11</a></span>
<span class="normal"><a href="#__codelineno-46-12"> 12</a></span>
<span class="normal"><a href="#__codelineno-46-13"> 13</a></span>
<span class="normal"><a href="#__codelineno-46-14"> 14</a></span>
<span class="normal"><a href="#__codelineno-46-15"> 15</a></span>
<span class="normal"><a href="#__codelineno-46-16"> 16</a></span>
<span class="normal"><a href="#__codelineno-46-17"> 17</a></span>
<span class="normal"><a href="#__codelineno-46-18"> 18</a></span>
<span class="normal"><a href="#__codelineno-46-19"> 19</a></span>
<span class="normal"><a href="#__codelineno-46-20"> 20</a></span>
<span class="normal"><a href="#__codelineno-46-21"> 21</a></span>
<span class="normal"><a href="#__codelineno-46-22"> 22</a></span>
<span class="normal"><a href="#__codelineno-46-23"> 23</a></span>
<span class="normal"><a href="#__codelineno-46-24"> 24</a></span>
<span class="normal"><a href="#__codelineno-46-25"> 25</a></span>
<span class="normal"><a href="#__codelineno-46-26"> 26</a></span>
<span class="normal"><a href="#__codelineno-46-27"> 27</a></span>
<span class="normal"><a href="#__codelineno-46-28"> 28</a></span>
<span class="normal"><a href="#__codelineno-46-29"> 29</a></span>
<span class="normal"><a href="#__codelineno-46-30"> 30</a></span>
<span class="normal"><a href="#__codelineno-46-31"> 31</a></span>
<span class="normal"><a href="#__codelineno-46-32"> 32</a></span>
<span class="normal"><a href="#__codelineno-46-33"> 33</a></span>
<span class="normal"><a href="#__codelineno-46-34"> 34</a></span>
<span class="normal"><a href="#__codelineno-46-35"> 35</a></span>
<span class="normal"><a href="#__codelineno-46-36"> 36</a></span>
<span class="normal"><a href="#__codelineno-46-37"> 37</a></span>
<span class="normal"><a href="#__codelineno-46-38"> 38</a></span>
<span class="normal"><a href="#__codelineno-46-39"> 39</a></span>
<span class="normal"><a href="#__codelineno-46-40"> 40</a></span>
<span class="normal"><a href="#__codelineno-46-41"> 41</a></span>
<span class="normal"><a href="#__codelineno-46-42"> 42</a></span>
<span class="normal"><a href="#__codelineno-46-43"> 43</a></span>
<span class="normal"><a href="#__codelineno-46-44"> 44</a></span>
<span class="normal"><a href="#__codelineno-46-45"> 45</a></span>
<span class="normal"><a href="#__codelineno-46-46"> 46</a></span>
<span class="normal"><a href="#__codelineno-46-47"> 47</a></span>
<span class="normal"><a href="#__codelineno-46-48"> 48</a></span>
<span class="normal"><a href="#__codelineno-46-49"> 49</a></span>
<span class="normal"><a href="#__codelineno-46-50"> 50</a></span>
<span class="normal"><a href="#__codelineno-46-51"> 51</a></span>
<span class="normal"><a href="#__codelineno-46-52"> 52</a></span>
<span class="normal"><a href="#__codelineno-46-53"> 53</a></span>
<span class="normal"><a href="#__codelineno-46-54"> 54</a></span>
<span class="normal"><a href="#__codelineno-46-55"> 55</a></span>
<span class="normal"><a href="#__codelineno-46-56"> 56</a></span>
<span class="normal"><a href="#__codelineno-46-57"> 57</a></span>
<span class="normal"><a href="#__codelineno-46-58"> 58</a></span>
<span class="normal"><a href="#__codelineno-46-59"> 59</a></span>
<span class="normal"><a href="#__codelineno-46-60"> 60</a></span>
<span class="normal"><a href="#__codelineno-46-61"> 61</a></span>
<span class="normal"><a href="#__codelineno-46-62"> 62</a></span>
<span class="normal"><a href="#__codelineno-46-63"> 63</a></span>
<span class="normal"><a href="#__codelineno-46-64"> 64</a></span>
<span class="normal"><a href="#__codelineno-46-65"> 65</a></span>
<span class="normal"><a href="#__codelineno-46-66"> 66</a></span>
<span class="normal"><a href="#__codelineno-46-67"> 67</a></span>
<span class="normal"><a href="#__codelineno-46-68"> 68</a></span>
<span class="normal"><a href="#__codelineno-46-69"> 69</a></span>
<span class="normal"><a href="#__codelineno-46-70"> 70</a></span>
<span class="normal"><a href="#__codelineno-46-71"> 71</a></span>
<span class="normal"><a href="#__codelineno-46-72"> 72</a></span>
<span class="normal"><a href="#__codelineno-46-73"> 73</a></span>
<span class="normal"><a href="#__codelineno-46-74"> 74</a></span>
<span class="normal"><a href="#__codelineno-46-75"> 75</a></span>
<span class="normal"><a href="#__codelineno-46-76"> 76</a></span>
<span class="normal"><a href="#__codelineno-46-77"> 77</a></span>
<span class="normal"><a href="#__codelineno-46-78"> 78</a></span>
<span class="normal"><a href="#__codelineno-46-79"> 79</a></span>
<span class="normal"><a href="#__codelineno-46-80"> 80</a></span>
<span class="normal"><a href="#__codelineno-46-81"> 81</a></span>
<span class="normal"><a href="#__codelineno-46-82"> 82</a></span>
<span class="normal"><a href="#__codelineno-46-83"> 83</a></span>
<span class="normal"><a href="#__codelineno-46-84"> 84</a></span>
<span class="normal"><a href="#__codelineno-46-85"> 85</a></span>
<span class="normal"><a href="#__codelineno-46-86"> 86</a></span>
<span class="normal"><a href="#__codelineno-46-87"> 87</a></span>
<span class="normal"><a href="#__codelineno-46-88"> 88</a></span>
<span class="normal"><a href="#__codelineno-46-89"> 89</a></span>
<span class="normal"><a href="#__codelineno-46-90"> 90</a></span>
<span class="normal"><a href="#__codelineno-46-91"> 91</a></span>
<span class="normal"><a href="#__codelineno-46-92"> 92</a></span>
<span class="normal"><a href="#__codelineno-46-93"> 93</a></span>
<span class="normal"><a href="#__codelineno-46-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-46-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-46-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-46-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-46-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-46-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-46-100">100</a></span>
<span class="normal"><a href="#__codelineno-46-101">101</a></span>
<span class="normal"><a href="#__codelineno-46-102">102</a></span>
<span class="normal"><a href="#__codelineno-46-103">103</a></span>
<span class="normal"><a href="#__codelineno-46-104">104</a></span>
<span class="normal"><a href="#__codelineno-46-105">105</a></span>
<span class="normal"><a href="#__codelineno-46-106">106</a></span>
<span class="normal"><a href="#__codelineno-46-107">107</a></span>
<span class="normal"><a href="#__codelineno-46-108">108</a></span>
<span class="normal"><a href="#__codelineno-46-109">109</a></span>
<span class="normal"><a href="#__codelineno-46-110">110</a></span>
<span class="normal"><a href="#__codelineno-46-111">111</a></span>
<span class="normal"><a href="#__codelineno-46-112">112</a></span>
<span class="normal"><a href="#__codelineno-46-113">113</a></span>
<span class="normal"><a href="#__codelineno-46-114">114</a></span>
<span class="normal"><a href="#__codelineno-46-115">115</a></span>
<span class="normal"><a href="#__codelineno-46-116">116</a></span>
<span class="normal"><a href="#__codelineno-46-117">117</a></span>
<span class="normal"><a href="#__codelineno-46-118">118</a></span>
<span class="normal"><a href="#__codelineno-46-119">119</a></span>
<span class="normal"><a href="#__codelineno-46-120">120</a></span>
<span class="normal"><a href="#__codelineno-46-121">121</a></span>
<span class="normal"><a href="#__codelineno-46-122">122</a></span>
<span class="normal"><a href="#__codelineno-46-123">123</a></span>
<span class="normal"><a href="#__codelineno-46-124">124</a></span>
<span class="normal"><a href="#__codelineno-46-125">125</a></span>
<span class="normal"><a href="#__codelineno-46-126">126</a></span>
<span class="normal"><a href="#__codelineno-46-127">127</a></span>
<span class="normal"><a href="#__codelineno-46-128">128</a></span>
<span class="normal"><a href="#__codelineno-46-129">129</a></span>
<span class="normal"><a href="#__codelineno-46-130">130</a></span>
<span class="normal"><a href="#__codelineno-46-131">131</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-46-1"><a id="__codelineno-46-1" name="__codelineno-46-1"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
</span><span id="__span-46-2"><a id="__codelineno-46-2" name="__codelineno-46-2"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Namespace</span>
</span><span id="__span-46-3"><a id="__codelineno-46-3" name="__codelineno-46-3"></a><span class="nt">metadata</span><span class="p">:</span>
</span><span id="__span-46-4"><a id="__codelineno-46-4" name="__codelineno-46-4"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">local-path-storage</span>
</span><span id="__span-46-5"><a id="__codelineno-46-5" name="__codelineno-46-5"></a>
</span><span id="__span-46-6"><a id="__codelineno-46-6" name="__codelineno-46-6"></a><span class="nn">---</span>
</span><span id="__span-46-7"><a id="__codelineno-46-7" name="__codelineno-46-7"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
</span><span id="__span-46-8"><a id="__codelineno-46-8" name="__codelineno-46-8"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ServiceAccount</span>
</span><span id="__span-46-9"><a id="__codelineno-46-9" name="__codelineno-46-9"></a><span class="nt">metadata</span><span class="p">:</span>
</span><span id="__span-46-10"><a id="__codelineno-46-10" name="__codelineno-46-10"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">local-path-provisioner-service-account</span>
</span><span id="__span-46-11"><a id="__codelineno-46-11" name="__codelineno-46-11"></a><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">local-path-storage</span>
</span><span id="__span-46-12"><a id="__codelineno-46-12" name="__codelineno-46-12"></a>
</span><span id="__span-46-13"><a id="__codelineno-46-13" name="__codelineno-46-13"></a><span class="nn">---</span>
</span><span id="__span-46-14"><a id="__codelineno-46-14" name="__codelineno-46-14"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">rbac.authorization.k8s.io/v1</span>
</span><span id="__span-46-15"><a id="__codelineno-46-15" name="__codelineno-46-15"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ClusterRole</span>
</span><span id="__span-46-16"><a id="__codelineno-46-16" name="__codelineno-46-16"></a><span class="nt">metadata</span><span class="p">:</span>
</span><span id="__span-46-17"><a id="__codelineno-46-17" name="__codelineno-46-17"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">local-path-provisioner-role</span>
</span><span id="__span-46-18"><a id="__codelineno-46-18" name="__codelineno-46-18"></a><span class="nt">rules</span><span class="p">:</span>
</span><span id="__span-46-19"><a id="__codelineno-46-19" name="__codelineno-46-19"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">apiGroups</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="w"> </span><span class="p p-Indicator">]</span>
</span><span id="__span-46-20"><a id="__codelineno-46-20" name="__codelineno-46-20"></a><span class="w">    </span><span class="nt">resources</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="w"> </span><span class="s">&quot;nodes&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;persistentvolumeclaims&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;configmaps&quot;</span><span class="w"> </span><span class="p p-Indicator">]</span>
</span><span id="__span-46-21"><a id="__codelineno-46-21" name="__codelineno-46-21"></a><span class="w">    </span><span class="nt">verbs</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="w"> </span><span class="s">&quot;get&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;list&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;watch&quot;</span><span class="w"> </span><span class="p p-Indicator">]</span>
</span><span id="__span-46-22"><a id="__codelineno-46-22" name="__codelineno-46-22"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">apiGroups</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="w"> </span><span class="p p-Indicator">]</span>
</span><span id="__span-46-23"><a id="__codelineno-46-23" name="__codelineno-46-23"></a><span class="w">    </span><span class="nt">resources</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="w"> </span><span class="s">&quot;endpoints&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;persistentvolumes&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;pods&quot;</span><span class="w"> </span><span class="p p-Indicator">]</span>
</span><span id="__span-46-24"><a id="__codelineno-46-24" name="__codelineno-46-24"></a><span class="w">    </span><span class="nt">verbs</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="w"> </span><span class="s">&quot;*&quot;</span><span class="w"> </span><span class="p p-Indicator">]</span>
</span><span id="__span-46-25"><a id="__codelineno-46-25" name="__codelineno-46-25"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">apiGroups</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="w"> </span><span class="p p-Indicator">]</span>
</span><span id="__span-46-26"><a id="__codelineno-46-26" name="__codelineno-46-26"></a><span class="w">    </span><span class="nt">resources</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="w"> </span><span class="s">&quot;events&quot;</span><span class="w"> </span><span class="p p-Indicator">]</span>
</span><span id="__span-46-27"><a id="__codelineno-46-27" name="__codelineno-46-27"></a><span class="w">    </span><span class="nt">verbs</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="w"> </span><span class="s">&quot;create&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;patch&quot;</span><span class="w"> </span><span class="p p-Indicator">]</span>
</span><span id="__span-46-28"><a id="__codelineno-46-28" name="__codelineno-46-28"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">apiGroups</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="w"> </span><span class="s">&quot;storage.k8s.io&quot;</span><span class="w"> </span><span class="p p-Indicator">]</span>
</span><span id="__span-46-29"><a id="__codelineno-46-29" name="__codelineno-46-29"></a><span class="w">    </span><span class="nt">resources</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="w"> </span><span class="s">&quot;storageclasses&quot;</span><span class="w"> </span><span class="p p-Indicator">]</span>
</span><span id="__span-46-30"><a id="__codelineno-46-30" name="__codelineno-46-30"></a><span class="w">    </span><span class="nt">verbs</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="w"> </span><span class="s">&quot;get&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;list&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;watch&quot;</span><span class="w"> </span><span class="p p-Indicator">]</span>
</span><span id="__span-46-31"><a id="__codelineno-46-31" name="__codelineno-46-31"></a>
</span><span id="__span-46-32"><a id="__codelineno-46-32" name="__codelineno-46-32"></a><span class="nn">---</span>
</span><span id="__span-46-33"><a id="__codelineno-46-33" name="__codelineno-46-33"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">rbac.authorization.k8s.io/v1</span>
</span><span id="__span-46-34"><a id="__codelineno-46-34" name="__codelineno-46-34"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ClusterRoleBinding</span>
</span><span id="__span-46-35"><a id="__codelineno-46-35" name="__codelineno-46-35"></a><span class="nt">metadata</span><span class="p">:</span>
</span><span id="__span-46-36"><a id="__codelineno-46-36" name="__codelineno-46-36"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">local-path-provisioner-bind</span>
</span><span id="__span-46-37"><a id="__codelineno-46-37" name="__codelineno-46-37"></a><span class="nt">roleRef</span><span class="p">:</span>
</span><span id="__span-46-38"><a id="__codelineno-46-38" name="__codelineno-46-38"></a><span class="w">  </span><span class="nt">apiGroup</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">rbac.authorization.k8s.io</span>
</span><span id="__span-46-39"><a id="__codelineno-46-39" name="__codelineno-46-39"></a><span class="w">  </span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ClusterRole</span>
</span><span id="__span-46-40"><a id="__codelineno-46-40" name="__codelineno-46-40"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">local-path-provisioner-role</span>
</span><span id="__span-46-41"><a id="__codelineno-46-41" name="__codelineno-46-41"></a><span class="nt">subjects</span><span class="p">:</span>
</span><span id="__span-46-42"><a id="__codelineno-46-42" name="__codelineno-46-42"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ServiceAccount</span>
</span><span id="__span-46-43"><a id="__codelineno-46-43" name="__codelineno-46-43"></a><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">local-path-provisioner-service-account</span>
</span><span id="__span-46-44"><a id="__codelineno-46-44" name="__codelineno-46-44"></a><span class="w">    </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">local-path-storage</span>
</span><span id="__span-46-45"><a id="__codelineno-46-45" name="__codelineno-46-45"></a>
</span><span id="__span-46-46"><a id="__codelineno-46-46" name="__codelineno-46-46"></a><span class="nn">---</span>
</span><span id="__span-46-47"><a id="__codelineno-46-47" name="__codelineno-46-47"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">apps/v1</span>
</span><span id="__span-46-48"><a id="__codelineno-46-48" name="__codelineno-46-48"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Deployment</span>
</span><span id="__span-46-49"><a id="__codelineno-46-49" name="__codelineno-46-49"></a><span class="nt">metadata</span><span class="p">:</span>
</span><span id="__span-46-50"><a id="__codelineno-46-50" name="__codelineno-46-50"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">local-path-provisioner</span>
</span><span id="__span-46-51"><a id="__codelineno-46-51" name="__codelineno-46-51"></a><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">local-path-storage</span>
</span><span id="__span-46-52"><a id="__codelineno-46-52" name="__codelineno-46-52"></a><span class="nt">spec</span><span class="p">:</span>
</span><span id="__span-46-53"><a id="__codelineno-46-53" name="__codelineno-46-53"></a><span class="w">  </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1</span>
</span><span id="__span-46-54"><a id="__codelineno-46-54" name="__codelineno-46-54"></a><span class="w">  </span><span class="nt">selector</span><span class="p">:</span>
</span><span id="__span-46-55"><a id="__codelineno-46-55" name="__codelineno-46-55"></a><span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span>
</span><span id="__span-46-56"><a id="__codelineno-46-56" name="__codelineno-46-56"></a><span class="w">      </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">local-path-provisioner</span>
</span><span id="__span-46-57"><a id="__codelineno-46-57" name="__codelineno-46-57"></a><span class="w">  </span><span class="nt">template</span><span class="p">:</span>
</span><span id="__span-46-58"><a id="__codelineno-46-58" name="__codelineno-46-58"></a><span class="w">    </span><span class="nt">metadata</span><span class="p">:</span>
</span><span id="__span-46-59"><a id="__codelineno-46-59" name="__codelineno-46-59"></a><span class="w">      </span><span class="nt">labels</span><span class="p">:</span>
</span><span id="__span-46-60"><a id="__codelineno-46-60" name="__codelineno-46-60"></a><span class="w">        </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">local-path-provisioner</span>
</span><span id="__span-46-61"><a id="__codelineno-46-61" name="__codelineno-46-61"></a><span class="w">    </span><span class="nt">spec</span><span class="p">:</span>
</span><span id="__span-46-62"><a id="__codelineno-46-62" name="__codelineno-46-62"></a><span class="w">      </span><span class="nt">serviceAccountName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">local-path-provisioner-service-account</span>
</span><span id="__span-46-63"><a id="__codelineno-46-63" name="__codelineno-46-63"></a><span class="w">      </span><span class="nt">containers</span><span class="p">:</span>
</span><span id="__span-46-64"><a id="__codelineno-46-64" name="__codelineno-46-64"></a><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">local-path-provisioner</span>
</span><span id="__span-46-65"><a id="__codelineno-46-65" name="__codelineno-46-65"></a><span class="w">          </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">rancher/local-path-provisioner:master-head</span>
</span><span id="__span-46-66"><a id="__codelineno-46-66" name="__codelineno-46-66"></a><span class="w">          </span><span class="nt">imagePullPolicy</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">IfNotPresent</span>
</span><span id="__span-46-67"><a id="__codelineno-46-67" name="__codelineno-46-67"></a><span class="w">          </span><span class="nt">command</span><span class="p">:</span>
</span><span id="__span-46-68"><a id="__codelineno-46-68" name="__codelineno-46-68"></a><span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">local-path-provisioner</span>
</span><span id="__span-46-69"><a id="__codelineno-46-69" name="__codelineno-46-69"></a><span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">--debug</span>
</span><span id="__span-46-70"><a id="__codelineno-46-70" name="__codelineno-46-70"></a><span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">start</span>
</span><span id="__span-46-71"><a id="__codelineno-46-71" name="__codelineno-46-71"></a><span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">--config</span>
</span><span id="__span-46-72"><a id="__codelineno-46-72" name="__codelineno-46-72"></a><span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/etc/config/config.json</span>
</span><span id="__span-46-73"><a id="__codelineno-46-73" name="__codelineno-46-73"></a><span class="w">          </span><span class="nt">volumeMounts</span><span class="p">:</span>
</span><span id="__span-46-74"><a id="__codelineno-46-74" name="__codelineno-46-74"></a><span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">config-volume</span>
</span><span id="__span-46-75"><a id="__codelineno-46-75" name="__codelineno-46-75"></a><span class="w">              </span><span class="nt">mountPath</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/etc/config/</span>
</span><span id="__span-46-76"><a id="__codelineno-46-76" name="__codelineno-46-76"></a><span class="w">          </span><span class="nt">env</span><span class="p">:</span>
</span><span id="__span-46-77"><a id="__codelineno-46-77" name="__codelineno-46-77"></a><span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">POD_NAMESPACE</span>
</span><span id="__span-46-78"><a id="__codelineno-46-78" name="__codelineno-46-78"></a><span class="w">              </span><span class="nt">valueFrom</span><span class="p">:</span>
</span><span id="__span-46-79"><a id="__codelineno-46-79" name="__codelineno-46-79"></a><span class="w">                </span><span class="nt">fieldRef</span><span class="p">:</span>
</span><span id="__span-46-80"><a id="__codelineno-46-80" name="__codelineno-46-80"></a><span class="w">                  </span><span class="nt">fieldPath</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">metadata.namespace</span>
</span><span id="__span-46-81"><a id="__codelineno-46-81" name="__codelineno-46-81"></a><span class="w">      </span><span class="nt">volumes</span><span class="p">:</span>
</span><span id="__span-46-82"><a id="__codelineno-46-82" name="__codelineno-46-82"></a><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">config-volume</span>
</span><span id="__span-46-83"><a id="__codelineno-46-83" name="__codelineno-46-83"></a><span class="w">          </span><span class="nt">configMap</span><span class="p">:</span>
</span><span id="__span-46-84"><a id="__codelineno-46-84" name="__codelineno-46-84"></a><span class="w">            </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">local-path-config</span>
</span><span id="__span-46-85"><a id="__codelineno-46-85" name="__codelineno-46-85"></a>
</span><span id="__span-46-86"><a id="__codelineno-46-86" name="__codelineno-46-86"></a><span class="nn">---</span>
</span><span id="__span-46-87"><a id="__codelineno-46-87" name="__codelineno-46-87"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">storage.k8s.io/v1</span>
</span><span id="__span-46-88"><a id="__codelineno-46-88" name="__codelineno-46-88"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">StorageClass</span>
</span><span id="__span-46-89"><a id="__codelineno-46-89" name="__codelineno-46-89"></a><span class="nt">metadata</span><span class="p">:</span>
</span><span id="__span-46-90"><a id="__codelineno-46-90" name="__codelineno-46-90"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">local-path</span>
</span><span id="__span-46-91"><a id="__codelineno-46-91" name="__codelineno-46-91"></a><span class="w">  </span><span class="nt">annotations</span><span class="p">:</span>
</span><span id="__span-46-92"><a id="__codelineno-46-92" name="__codelineno-46-92"></a><span class="w">    </span><span class="nt">storageclass.kubernetes.io/is-default-class</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;true&quot;</span>
</span><span id="__span-46-93"><a id="__codelineno-46-93" name="__codelineno-46-93"></a><span class="nt">provisioner</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">rancher.io/local-path</span>
</span><span id="__span-46-94"><a id="__codelineno-46-94" name="__codelineno-46-94"></a><span class="nt">allowVolumeExpansion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
</span><span id="__span-46-95"><a id="__codelineno-46-95" name="__codelineno-46-95"></a><span class="nt">volumeBindingMode</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">WaitForFirstConsumer</span>
</span><span id="__span-46-96"><a id="__codelineno-46-96" name="__codelineno-46-96"></a><span class="nt">reclaimPolicy</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Retain</span>
</span><span id="__span-46-97"><a id="__codelineno-46-97" name="__codelineno-46-97"></a>
</span><span id="__span-46-98"><a id="__codelineno-46-98" name="__codelineno-46-98"></a><span class="nn">---</span>
</span><span id="__span-46-99"><a id="__codelineno-46-99" name="__codelineno-46-99"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ConfigMap</span>
</span><span id="__span-46-100"><a id="__codelineno-46-100" name="__codelineno-46-100"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
</span><span id="__span-46-101"><a id="__codelineno-46-101" name="__codelineno-46-101"></a><span class="nt">metadata</span><span class="p">:</span>
</span><span id="__span-46-102"><a id="__codelineno-46-102" name="__codelineno-46-102"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">local-path-config</span>
</span><span id="__span-46-103"><a id="__codelineno-46-103" name="__codelineno-46-103"></a><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">local-path-storage</span>
</span><span id="__span-46-104"><a id="__codelineno-46-104" name="__codelineno-46-104"></a><span class="nt">data</span><span class="p">:</span>
</span><span id="__span-46-105"><a id="__codelineno-46-105" name="__codelineno-46-105"></a><span class="w">  </span><span class="nt">config.json</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|-</span>
</span><span id="__span-46-106"><a id="__codelineno-46-106" name="__codelineno-46-106"></a><span class="w">    </span><span class="no">{</span>
</span><span id="__span-46-107"><a id="__codelineno-46-107" name="__codelineno-46-107"></a><span class="w">            </span><span class="no">&quot;nodePathMap&quot;:[</span>
</span><span id="__span-46-108"><a id="__codelineno-46-108" name="__codelineno-46-108"></a><span class="w">            </span><span class="no">{</span>
</span><span id="__span-46-109"><a id="__codelineno-46-109" name="__codelineno-46-109"></a><span class="w">                    </span><span class="no">&quot;node&quot;:&quot;DEFAULT_PATH_FOR_NON_LISTED_NODES&quot;,</span>
</span><span id="__span-46-110"><a id="__codelineno-46-110" name="__codelineno-46-110"></a><span class="w">                    </span><span class="no">&quot;paths&quot;:[&quot;/home/k8s/local-path-storage&quot;]</span>
</span><span id="__span-46-111"><a id="__codelineno-46-111" name="__codelineno-46-111"></a><span class="w">            </span><span class="no">}</span>
</span><span id="__span-46-112"><a id="__codelineno-46-112" name="__codelineno-46-112"></a><span class="w">            </span><span class="no">]</span>
</span><span id="__span-46-113"><a id="__codelineno-46-113" name="__codelineno-46-113"></a><span class="w">    </span><span class="no">}</span>
</span><span id="__span-46-114"><a id="__codelineno-46-114" name="__codelineno-46-114"></a><span class="w">  </span><span class="nt">setup</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|-</span>
</span><span id="__span-46-115"><a id="__codelineno-46-115" name="__codelineno-46-115"></a><span class="w">    </span><span class="no">#!/bin/sh</span>
</span><span id="__span-46-116"><a id="__codelineno-46-116" name="__codelineno-46-116"></a><span class="w">    </span><span class="no">set -eu</span>
</span><span id="__span-46-117"><a id="__codelineno-46-117" name="__codelineno-46-117"></a><span class="w">    </span><span class="no">mkdir -m 0777 -p &quot;$VOL_DIR&quot;</span>
</span><span id="__span-46-118"><a id="__codelineno-46-118" name="__codelineno-46-118"></a><span class="w">  </span><span class="nt">teardown</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|-</span>
</span><span id="__span-46-119"><a id="__codelineno-46-119" name="__codelineno-46-119"></a><span class="w">    </span><span class="no">#!/bin/sh</span>
</span><span id="__span-46-120"><a id="__codelineno-46-120" name="__codelineno-46-120"></a><span class="w">    </span><span class="no">set -eu</span>
</span><span id="__span-46-121"><a id="__codelineno-46-121" name="__codelineno-46-121"></a><span class="w">    </span><span class="no">rm -rf &quot;$VOL_DIR&quot;</span>
</span><span id="__span-46-122"><a id="__codelineno-46-122" name="__codelineno-46-122"></a><span class="w">  </span><span class="nt">helperPod.yaml</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|-</span>
</span><span id="__span-46-123"><a id="__codelineno-46-123" name="__codelineno-46-123"></a><span class="w">    </span><span class="no">apiVersion: v1</span>
</span><span id="__span-46-124"><a id="__codelineno-46-124" name="__codelineno-46-124"></a><span class="w">    </span><span class="no">kind: Pod</span>
</span><span id="__span-46-125"><a id="__codelineno-46-125" name="__codelineno-46-125"></a><span class="w">    </span><span class="no">metadata:</span>
</span><span id="__span-46-126"><a id="__codelineno-46-126" name="__codelineno-46-126"></a><span class="w">      </span><span class="no">name: helper-pod</span>
</span><span id="__span-46-127"><a id="__codelineno-46-127" name="__codelineno-46-127"></a><span class="w">    </span><span class="no">spec:</span>
</span><span id="__span-46-128"><a id="__codelineno-46-128" name="__codelineno-46-128"></a><span class="w">      </span><span class="no">containers:</span>
</span><span id="__span-46-129"><a id="__codelineno-46-129" name="__codelineno-46-129"></a><span class="w">      </span><span class="no">- name: helper-pod</span>
</span><span id="__span-46-130"><a id="__codelineno-46-130" name="__codelineno-46-130"></a><span class="w">        </span><span class="no">image: busybox</span>
</span><span id="__span-46-131"><a id="__codelineno-46-131" name="__codelineno-46-131"></a><span class="w">        </span><span class="no">imagePullPolicy: IfNotPresent</span>
</span></code></pre></div></td></tr></table></div>
</details>
<div class="language-console highlight"><pre><span></span><code><span id="__span-47-1"><a id="__codelineno-47-1" name="__codelineno-47-1" href="#__codelineno-47-1"></a><span class="gp">$ </span>kubectl<span class="w"> </span>apply<span class="w"> </span>-f<span class="w"> </span><span class="se">\</span>
</span><span id="__span-47-2"><a id="__codelineno-47-2" name="__codelineno-47-2" href="#__codelineno-47-2"></a><span class="w">  </span>local-path-storage-as-default-class.yaml
</span><span id="__span-47-3"><a id="__codelineno-47-3" name="__codelineno-47-3" href="#__codelineno-47-3"></a><span class="go">namespace/local-path-storage created</span>
</span><span id="__span-47-4"><a id="__codelineno-47-4" name="__codelineno-47-4" href="#__codelineno-47-4"></a><span class="go">serviceaccount/local-path-provisioner-service-account created</span>
</span><span id="__span-47-5"><a id="__codelineno-47-5" name="__codelineno-47-5" href="#__codelineno-47-5"></a><span class="go">clusterrole.rbac.authorization.k8s.io/local-path-provisioner-role created</span>
</span><span id="__span-47-6"><a id="__codelineno-47-6" name="__codelineno-47-6" href="#__codelineno-47-6"></a><span class="go">clusterrolebinding.rbac.authorization.k8s.io/local-path-provisioner-bind created</span>
</span><span id="__span-47-7"><a id="__codelineno-47-7" name="__codelineno-47-7" href="#__codelineno-47-7"></a><span class="go">deployment.apps/local-path-provisioner created</span>
</span><span id="__span-47-8"><a id="__codelineno-47-8" name="__codelineno-47-8" href="#__codelineno-47-8"></a><span class="go">storageclass.storage.k8s.io/local-path created</span>
</span><span id="__span-47-9"><a id="__codelineno-47-9" name="__codelineno-47-9" href="#__codelineno-47-9"></a><span class="go">configmap/local-path-config created</span>
</span><span id="__span-47-10"><a id="__codelineno-47-10" name="__codelineno-47-10" href="#__codelineno-47-10"></a>
</span><span id="__span-47-11"><a id="__codelineno-47-11" name="__codelineno-47-11" href="#__codelineno-47-11"></a><span class="gp">$ </span>kubectl<span class="w"> </span>get<span class="w"> </span>storageclass<span class="w"> </span>
</span><span id="__span-47-12"><a id="__codelineno-47-12" name="__codelineno-47-12" href="#__codelineno-47-12"></a><span class="go">NAME                   PROVISIONER             RECLAIMPOLICY   VOLUMEBINDINGMODE      ALLOWVOLUMEEXPANSION   AGE</span>
</span><span id="__span-47-13"><a id="__codelineno-47-13" name="__codelineno-47-13" href="#__codelineno-47-13"></a><span class="go">local-path (default)   rancher.io/local-path   Retain          WaitForFirstConsumer   true                   11s</span>
</span></code></pre></div>
<h3 id="https-with-lets-encrypt">HTTPS with Let's Encrypt</h3>
<p>Enabling HTTPS and configuring SSL certificates with
<a href="https://letsencrypt.org/getting-started/">Let's Encrypt</a>
requires running
<a href="https://certbot.eff.org/instructions?ws=other&amp;os=ubuntufocal">Certbot</a>
to confirm/certify control of the web host. Since nothing
is listening on port 80, this should be pretty easy.
The certificate should be for a specific subdomain
(e.g. <code>ssl.uu.am</code>) which will be mapped to the IP,
then other subdomains redirect to specific ports.</p>
<h4 id="host-os-setup">Host OS setup</h4>
<p><a href="https://www.server-world.info/en/note?os=Ubuntu_22.04&amp;p=ssl&amp;f=2">Install certbot</a>
and request a certificate for <code>ssl.uu.am</code></p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-48-1"><a id="__codelineno-48-1" name="__codelineno-48-1" href="#__codelineno-48-1"></a><span class="gp"># </span>apt<span class="w"> </span>install<span class="w"> </span>-y<span class="w"> </span>certbot
</span><span id="__span-48-2"><a id="__codelineno-48-2" name="__codelineno-48-2" href="#__codelineno-48-2"></a><span class="gp"># </span>certbot<span class="w"> </span>certonly<span class="w"> </span>--standalone<span class="w"> </span>-d<span class="w"> </span>ssl.uu.am
</span><span id="__span-48-3"><a id="__codelineno-48-3" name="__codelineno-48-3" href="#__codelineno-48-3"></a><span class="go">Saving debug log to /var/log/letsencrypt/letsencrypt.log</span>
</span><span id="__span-48-4"><a id="__codelineno-48-4" name="__codelineno-48-4" href="#__codelineno-48-4"></a><span class="go">Enter email address (used for urgent renewal and security notices)</span>
</span><span id="__span-48-5"><a id="__codelineno-48-5" name="__codelineno-48-5" href="#__codelineno-48-5"></a><span class="go"> (Enter &#39;c&#39; to cancel): root@uu.am</span>
</span><span id="__span-48-6"><a id="__codelineno-48-6" name="__codelineno-48-6" href="#__codelineno-48-6"></a><span class="go">...</span>
</span><span id="__span-48-7"><a id="__codelineno-48-7" name="__codelineno-48-7" href="#__codelineno-48-7"></a>
</span><span id="__span-48-8"><a id="__codelineno-48-8" name="__codelineno-48-8" href="#__codelineno-48-8"></a><span class="gp"># </span>ls<span class="w"> </span>-l<span class="w"> </span>/etc/letsencrypt/live/ssl.uu.am/
</span><span id="__span-48-9"><a id="__codelineno-48-9" name="__codelineno-48-9" href="#__codelineno-48-9"></a><span class="go">total 20</span>
</span><span id="__span-48-10"><a id="__codelineno-48-10" name="__codelineno-48-10" href="#__codelineno-48-10"></a><span class="go">lrwxrwxrwx 1 root root  38 Feb 13 22:00 cert.pem -&gt; ../../archive/ssl.uu.am/cert1.pem</span>
</span><span id="__span-48-11"><a id="__codelineno-48-11" name="__codelineno-48-11" href="#__codelineno-48-11"></a><span class="go">lrwxrwxrwx 1 root root  39 Feb 13 22:00 chain.pem -&gt; ../../archive/ssl.uu.am/chain1.pem</span>
</span><span id="__span-48-12"><a id="__codelineno-48-12" name="__codelineno-48-12" href="#__codelineno-48-12"></a><span class="go">lrwxrwxrwx 1 root root  43 Feb 13 22:00 fullchain.pem -&gt; ../../archive/ssl.uu.am/fullchain1.pem</span>
</span><span id="__span-48-13"><a id="__codelineno-48-13" name="__codelineno-48-13" href="#__codelineno-48-13"></a><span class="go">lrwxrwxrwx 1 root root  41 Feb 13 22:00 privkey.pem -&gt; ../../archive/ssl.uu.am/privkey1.pem</span>
</span><span id="__span-48-14"><a id="__codelineno-48-14" name="__codelineno-48-14" href="#__codelineno-48-14"></a><span class="go">-rw-r--r-- 1 root root 692 Feb 13 22:00 README</span>
</span><span id="__span-48-15"><a id="__codelineno-48-15" name="__codelineno-48-15" href="#__codelineno-48-15"></a>
</span><span id="__span-48-16"><a id="__codelineno-48-16" name="__codelineno-48-16" href="#__codelineno-48-16"></a><span class="gp"># </span>cat<span class="w"> </span>/etc/letsencrypt/live/ssl.uu.am/README
</span><span id="__span-48-17"><a id="__codelineno-48-17" name="__codelineno-48-17" href="#__codelineno-48-17"></a><span class="go">This directory contains your keys and certificates.</span>
</span><span id="__span-48-18"><a id="__codelineno-48-18" name="__codelineno-48-18" href="#__codelineno-48-18"></a>
</span><span id="__span-48-19"><a id="__codelineno-48-19" name="__codelineno-48-19" href="#__codelineno-48-19"></a><span class="go">`privkey.pem`  : the private key for your certificate.</span>
</span><span id="__span-48-20"><a id="__codelineno-48-20" name="__codelineno-48-20" href="#__codelineno-48-20"></a><span class="go">`fullchain.pem`: the certificate file used in most server software.</span>
</span><span id="__span-48-21"><a id="__codelineno-48-21" name="__codelineno-48-21" href="#__codelineno-48-21"></a><span class="go">`chain.pem`    : used for OCSP stapling in Nginx &gt;=1.3.7.</span>
</span><span id="__span-48-22"><a id="__codelineno-48-22" name="__codelineno-48-22" href="#__codelineno-48-22"></a><span class="go">`cert.pem`     : will break many server configurations, and should not be used</span>
</span><span id="__span-48-23"><a id="__codelineno-48-23" name="__codelineno-48-23" href="#__codelineno-48-23"></a><span class="go">                 without reading further documentation (see link below).</span>
</span><span id="__span-48-24"><a id="__codelineno-48-24" name="__codelineno-48-24" href="#__codelineno-48-24"></a>
</span><span id="__span-48-25"><a id="__codelineno-48-25" name="__codelineno-48-25" href="#__codelineno-48-25"></a><span class="go">WARNING: DO NOT MOVE OR RENAME THESE FILES!</span>
</span><span id="__span-48-26"><a id="__codelineno-48-26" name="__codelineno-48-26" href="#__codelineno-48-26"></a><span class="go">         Certbot expects these files to remain in this location in order</span>
</span><span id="__span-48-27"><a id="__codelineno-48-27" name="__codelineno-48-27" href="#__codelineno-48-27"></a><span class="go">         to function properly!</span>
</span><span id="__span-48-28"><a id="__codelineno-48-28" name="__codelineno-48-28" href="#__codelineno-48-28"></a>
</span><span id="__span-48-29"><a id="__codelineno-48-29" name="__codelineno-48-29" href="#__codelineno-48-29"></a><span class="go">We recommend not moving these files. For more information, see the Certbot</span>
</span><span id="__span-48-30"><a id="__codelineno-48-30" name="__codelineno-48-30" href="#__codelineno-48-30"></a><span class="go">User Guide at https://certbot.eff.org/docs/using.html#where-are-my-certificates.</span>
</span></code></pre></div>
<p>Actual files are in <code>/etc/letsencrypt/archive/ssl.uu.am/</code>
but have numbered names (e.g. cert1.pem) while the links in
<code>/etc/letsencrypt/live/ssl.uu.am/</code> will have constant file
names (e.g. <code>cert.pem</code>).</p>
<h5 id="renewal-automated">Renewal (automated)</h5>
<p>The <code>certbot</code> package installs a service and a timer to
renew certificates every 30 days, trying 2x daily:</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-49-1"><a id="__codelineno-49-1" name="__codelineno-49-1" href="#__codelineno-49-1"></a><span class="gp"># </span>systemctl<span class="w"> </span>status<span class="w"> </span>certbot.timer<span class="w"> </span>
</span><span id="__span-49-2"><a id="__codelineno-49-2" name="__codelineno-49-2" href="#__codelineno-49-2"></a><span class="go">● certbot.timer - Run certbot twice daily</span>
</span><span id="__span-49-3"><a id="__codelineno-49-3" name="__codelineno-49-3" href="#__codelineno-49-3"></a><span class="go">     Loaded: loaded (/lib/systemd/system/certbot.timer; enabled; vendor preset: enabled)</span>
</span><span id="__span-49-4"><a id="__codelineno-49-4" name="__codelineno-49-4" href="#__codelineno-49-4"></a><span class="go">     Active: active (running) since Sun 2023-04-16 13:42:11 CEST; 2s ago</span>
</span><span id="__span-49-5"><a id="__codelineno-49-5" name="__codelineno-49-5" href="#__codelineno-49-5"></a><span class="go">    Trigger: n/a</span>
</span><span id="__span-49-6"><a id="__codelineno-49-6" name="__codelineno-49-6" href="#__codelineno-49-6"></a><span class="go">   Triggers: ● certbot.service</span>
</span><span id="__span-49-7"><a id="__codelineno-49-7" name="__codelineno-49-7" href="#__codelineno-49-7"></a>
</span><span id="__span-49-8"><a id="__codelineno-49-8" name="__codelineno-49-8" href="#__codelineno-49-8"></a><span class="go">Apr 16 13:42:11 lexicon systemd[1]: Stopped Run certbot twice daily.</span>
</span><span id="__span-49-9"><a id="__codelineno-49-9" name="__codelineno-49-9" href="#__codelineno-49-9"></a><span class="go">Apr 16 13:42:11 lexicon systemd[1]: Stopping Run certbot twice daily...</span>
</span><span id="__span-49-10"><a id="__codelineno-49-10" name="__codelineno-49-10" href="#__codelineno-49-10"></a><span class="go">Apr 16 13:42:11 lexicon systemd[1]: Started Run certbot twice daily.</span>
</span><span id="__span-49-11"><a id="__codelineno-49-11" name="__codelineno-49-11" href="#__codelineno-49-11"></a>
</span><span id="__span-49-12"><a id="__codelineno-49-12" name="__codelineno-49-12" href="#__codelineno-49-12"></a><span class="gp"># </span>systemctl<span class="w"> </span>status<span class="w"> </span>certbot.service<span class="w"> </span>
</span><span id="__span-49-13"><a id="__codelineno-49-13" name="__codelineno-49-13" href="#__codelineno-49-13"></a><span class="go">● certbot.service - Certbot</span>
</span><span id="__span-49-14"><a id="__codelineno-49-14" name="__codelineno-49-14" href="#__codelineno-49-14"></a><span class="go">     Loaded: loaded (/lib/systemd/system/certbot.service; static)</span>
</span><span id="__span-49-15"><a id="__codelineno-49-15" name="__codelineno-49-15" href="#__codelineno-49-15"></a><span class="go">     Active: activating (start) since Sun 2023-04-16 13:42:11 CEST; 10s ago</span>
</span><span id="__span-49-16"><a id="__codelineno-49-16" name="__codelineno-49-16" href="#__codelineno-49-16"></a><span class="go">TriggeredBy: ● certbot.timer</span>
</span><span id="__span-49-17"><a id="__codelineno-49-17" name="__codelineno-49-17" href="#__codelineno-49-17"></a><span class="go">       Docs: file:///usr/share/doc/python-certbot-doc/html/index.html</span>
</span><span id="__span-49-18"><a id="__codelineno-49-18" name="__codelineno-49-18" href="#__codelineno-49-18"></a><span class="go">             https://certbot.eff.org/docs</span>
</span><span id="__span-49-19"><a id="__codelineno-49-19" name="__codelineno-49-19" href="#__codelineno-49-19"></a><span class="go">   Main PID: 2015732 (certbot)</span>
</span><span id="__span-49-20"><a id="__codelineno-49-20" name="__codelineno-49-20" href="#__codelineno-49-20"></a><span class="go">      Tasks: 1 (limit: 37940)</span>
</span><span id="__span-49-21"><a id="__codelineno-49-21" name="__codelineno-49-21" href="#__codelineno-49-21"></a><span class="go">     Memory: 32.2M</span>
</span><span id="__span-49-22"><a id="__codelineno-49-22" name="__codelineno-49-22" href="#__codelineno-49-22"></a><span class="go">        CPU: 256ms</span>
</span><span id="__span-49-23"><a id="__codelineno-49-23" name="__codelineno-49-23" href="#__codelineno-49-23"></a><span class="go">     CGroup: /system.slice/certbot.service</span>
</span><span id="__span-49-24"><a id="__codelineno-49-24" name="__codelineno-49-24" href="#__codelineno-49-24"></a><span class="go">             └─2015732 /usr/bin/python3 /usr/bin/certbot -q renew</span>
</span><span id="__span-49-25"><a id="__codelineno-49-25" name="__codelineno-49-25" href="#__codelineno-49-25"></a>
</span><span id="__span-49-26"><a id="__codelineno-49-26" name="__codelineno-49-26" href="#__codelineno-49-26"></a><span class="go">Apr 16 13:42:11 lexicon systemd[1]: Starting Certbot...</span>
</span></code></pre></div>
<p>For this to work long-term, the external port 80 must be
forwarded to the hosts’ IP.
If this forward is removed at some point (e.g. forwarded
to another IP), the renewal will fail:</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-50-1"><a id="__codelineno-50-1" name="__codelineno-50-1" href="#__codelineno-50-1"></a><span class="gp"># </span>systemctl<span class="w"> </span>status<span class="w"> </span>certbot.service<span class="w"> </span>
</span><span id="__span-50-2"><a id="__codelineno-50-2" name="__codelineno-50-2" href="#__codelineno-50-2"></a><span class="go">× certbot.service - Certbot</span>
</span><span id="__span-50-3"><a id="__codelineno-50-3" name="__codelineno-50-3" href="#__codelineno-50-3"></a><span class="go">     Loaded: loaded (/lib/systemd/system/certbot.service; static)</span>
</span><span id="__span-50-4"><a id="__codelineno-50-4" name="__codelineno-50-4" href="#__codelineno-50-4"></a><span class="go">     Active: failed (Result: exit-code) since Sun 2023-04-16 04:53:14 CEST; 8h ago</span>
</span><span id="__span-50-5"><a id="__codelineno-50-5" name="__codelineno-50-5" href="#__codelineno-50-5"></a><span class="go">TriggeredBy: ● certbot.timer</span>
</span><span id="__span-50-6"><a id="__codelineno-50-6" name="__codelineno-50-6" href="#__codelineno-50-6"></a><span class="go">       Docs: file:///usr/share/doc/python-certbot-doc/html/index.html</span>
</span><span id="__span-50-7"><a id="__codelineno-50-7" name="__codelineno-50-7" href="#__codelineno-50-7"></a><span class="go">             https://certbot.eff.org/docs</span>
</span><span id="__span-50-8"><a id="__codelineno-50-8" name="__codelineno-50-8" href="#__codelineno-50-8"></a><span class="go">    Process: 279698 ExecStart=/usr/bin/certbot -q renew (code=exited, status=1/FAILURE)</span>
</span><span id="__span-50-9"><a id="__codelineno-50-9" name="__codelineno-50-9" href="#__codelineno-50-9"></a><span class="go">   Main PID: 279698 (code=exited, status=1/FAILURE)</span>
</span><span id="__span-50-10"><a id="__codelineno-50-10" name="__codelineno-50-10" href="#__codelineno-50-10"></a><span class="go">        CPU: 632ms</span>
</span><span id="__span-50-11"><a id="__codelineno-50-11" name="__codelineno-50-11" href="#__codelineno-50-11"></a>
</span><span id="__span-50-12"><a id="__codelineno-50-12" name="__codelineno-50-12" href="#__codelineno-50-12"></a><span class="go">Apr 16 04:50:22 lexicon systemd[1]: Starting Certbot...</span>
</span><span id="__span-50-13"><a id="__codelineno-50-13" name="__codelineno-50-13" href="#__codelineno-50-13"></a><span class="go">Apr 16 04:53:14 lexicon certbot[279698]: Failed to renew certificate ssl.uu.am with error: Some challenges have&gt;</span>
</span><span id="__span-50-14"><a id="__codelineno-50-14" name="__codelineno-50-14" href="#__codelineno-50-14"></a><span class="go">Apr 16 04:53:14 lexicon certbot[279698]: All renewals failed. The following certificates could not be renewed:</span>
</span><span id="__span-50-15"><a id="__codelineno-50-15" name="__codelineno-50-15" href="#__codelineno-50-15"></a><span class="go">Apr 16 04:53:14 lexicon certbot[279698]:   /etc/letsencrypt/live/ssl.uu.am/fullchain.pem (failure)</span>
</span><span id="__span-50-16"><a id="__codelineno-50-16" name="__codelineno-50-16" href="#__codelineno-50-16"></a><span class="go">Apr 16 04:53:14 lexicon certbot[279698]: 1 renew failure(s), 0 parse failure(s)</span>
</span><span id="__span-50-17"><a id="__codelineno-50-17" name="__codelineno-50-17" href="#__codelineno-50-17"></a><span class="go">Apr 16 04:53:14 lexicon systemd[1]: certbot.service: Main process exited, code=exited, status=1/FAILURE</span>
</span><span id="__span-50-18"><a id="__codelineno-50-18" name="__codelineno-50-18" href="#__codelineno-50-18"></a><span class="go">Apr 16 04:53:14 lexicon systemd[1]: certbot.service: Failed with result &#39;exit-code&#39;.</span>
</span><span id="__span-50-19"><a id="__codelineno-50-19" name="__codelineno-50-19" href="#__codelineno-50-19"></a><span class="go">Apr 16 04:53:14 lexicon systemd[1]: Failed to start Certbot.</span>
</span></code></pre></div>
<p>To fix this, restore the port forwarding and
<strong>restart the timer</strong> (not the service):</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-51-1"><a id="__codelineno-51-1" name="__codelineno-51-1" href="#__codelineno-51-1"></a><span class="gp"># </span>systemctl<span class="w"> </span>restart<span class="w"> </span>certbot.timer<span class="w"> </span>
</span><span id="__span-51-2"><a id="__codelineno-51-2" name="__codelineno-51-2" href="#__codelineno-51-2"></a><span class="gp"># </span>systemctl<span class="w"> </span>status<span class="w"> </span>certbot.timer<span class="w"> </span>
</span><span id="__span-51-3"><a id="__codelineno-51-3" name="__codelineno-51-3" href="#__codelineno-51-3"></a><span class="go">● certbot.timer - Run certbot twice daily</span>
</span><span id="__span-51-4"><a id="__codelineno-51-4" name="__codelineno-51-4" href="#__codelineno-51-4"></a><span class="go">     Loaded: loaded (/lib/systemd/system/certbot.timer; enabled; vendor preset: enabled)</span>
</span><span id="__span-51-5"><a id="__codelineno-51-5" name="__codelineno-51-5" href="#__codelineno-51-5"></a><span class="go">     Active: active (running) since Sun 2023-04-16 13:42:11 CEST; 2s ago</span>
</span><span id="__span-51-6"><a id="__codelineno-51-6" name="__codelineno-51-6" href="#__codelineno-51-6"></a><span class="go">    Trigger: n/a</span>
</span><span id="__span-51-7"><a id="__codelineno-51-7" name="__codelineno-51-7" href="#__codelineno-51-7"></a><span class="go">   Triggers: ● certbot.service</span>
</span></code></pre></div>
<p>After a while (random delay under 10 minutes) there should be a lot of activity logged in
<code>/var/log/letsencrypt/letsencrypt.log</code>
ending with</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-52-1"><a id="__codelineno-52-1" name="__codelineno-52-1" href="#__codelineno-52-1"></a>2023-04-16 13:49:44,607:DEBUG:certbot._internal.renewal:no renewal failures
</span></code></pre></div>
<h4 id="kubernetes-setup">Kubernetes setup</h4>
<p>Having a successful setup to
<a href="#https-with-lets-encrypt">Enable HTTPS with Let's Encrypt</a>,
the question is how to set up Nginx reverse proxy.</p>
<p>We have an <a href="#ingress-controller">Ingress Controller</a>
already configured with a MetalLB IP 192.168.0.122
listening on ports 80 and 443. We can forward external port
443 to this IP so we have the same page/s on (not yet
secure)
<a href="https://192.168.0.121/">https://192.168.0.121/</a>
and
<a href="https://ssl.uu.am/">https://ssl.uu.am/</a>
(just Nginx 404 now).</p>
<p>Need to make 2 big changes to the Nginx controller:</p>
<ol>
<li><a href="#install-lets-encrypt-certificate-as-a-secret">Install Let’s Encrypt certificate as a secret</a></li>
<li><a href="#add-ingress-for-the-first-pod">Add Ingress for the first pod</a></li>
</ol>
<h5 id="install-lets-encrypt-certificate-as-a-secret">Install Let’s Encrypt certificate as a secret</h5>
<p>Need to add a secret in the <code>ingress-nginx</code> namespace with
the Let’s Encrypt certificate. Otherwise,
if nothing else is found, Nginx will use the default
"Kubernetes Ingress Controller Fake Certificate".</p>
<p>How to add the certificate as a secret?</p>
<p><a href="https://www.howtogeek.com/devops/how-to-install-kubernetes-cert-manager-and-configure-lets-encrypt/">How to Install Kubernetes Cert-Manager and Configure Let’s Encrypt</a>
is based on
<a href="https://cert-manager.io/v1.3-docs/tutorials/acme/ingress/">Securing NGINX-ingress</a>
which we could follow starting from
<a href="https://cert-manager.io/v1.3-docs/tutorials/acme/ingress/#step-5---deploy-cert-manager">Step 5 - Deploy Cert Manager</a>
by installing directly in
<a href="https://cert-manager.io/v1.3-docs/installation/kubernetes/">Kubernetes</a>
(with or without Helm).
Install the latest version of cert-manager using Helm:</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-53-1"><a id="__codelineno-53-1" name="__codelineno-53-1" href="#__codelineno-53-1"></a><span class="gp">$ </span>helm<span class="w"> </span>repo<span class="w"> </span>add<span class="w"> </span>jetstack<span class="w"> </span>https://charts.jetstack.io
</span><span id="__span-53-2"><a id="__codelineno-53-2" name="__codelineno-53-2" href="#__codelineno-53-2"></a><span class="gp">$ </span>helm<span class="w"> </span>repo<span class="w"> </span>update
</span><span id="__span-53-3"><a id="__codelineno-53-3" name="__codelineno-53-3" href="#__codelineno-53-3"></a><span class="gp">$ </span>helm<span class="w"> </span>install<span class="w"> </span>cert-manager<span class="w"> </span>jetstack/cert-manager<span class="w"> </span><span class="se">\</span>
</span><span id="__span-53-4"><a id="__codelineno-53-4" name="__codelineno-53-4" href="#__codelineno-53-4"></a><span class="w">  </span>--namespace<span class="w"> </span>cert-manager<span class="w"> </span><span class="se">\</span>
</span><span id="__span-53-5"><a id="__codelineno-53-5" name="__codelineno-53-5" href="#__codelineno-53-5"></a><span class="w">  </span>--create-namespace<span class="w"> </span><span class="se">\</span>
</span><span id="__span-53-6"><a id="__codelineno-53-6" name="__codelineno-53-6" href="#__codelineno-53-6"></a><span class="w">  </span>--version<span class="w"> </span>v1.11.0<span class="w"> </span><span class="se">\</span>
</span><span id="__span-53-7"><a id="__codelineno-53-7" name="__codelineno-53-7" href="#__codelineno-53-7"></a><span class="w">  </span>--set<span class="w"> </span><span class="nv">installCRDs</span><span class="o">=</span><span class="nb">true</span>
</span><span id="__span-53-8"><a id="__codelineno-53-8" name="__codelineno-53-8" href="#__codelineno-53-8"></a><span class="go">NAME: cert-manager</span>
</span><span id="__span-53-9"><a id="__codelineno-53-9" name="__codelineno-53-9" href="#__codelineno-53-9"></a><span class="go">LAST DEPLOYED: Sun Apr 16 15:25:25 2023</span>
</span><span id="__span-53-10"><a id="__codelineno-53-10" name="__codelineno-53-10" href="#__codelineno-53-10"></a><span class="go">NAMESPACE: cert-manager</span>
</span><span id="__span-53-11"><a id="__codelineno-53-11" name="__codelineno-53-11" href="#__codelineno-53-11"></a><span class="go">STATUS: deployed</span>
</span><span id="__span-53-12"><a id="__codelineno-53-12" name="__codelineno-53-12" href="#__codelineno-53-12"></a><span class="go">REVISION: 1</span>
</span><span id="__span-53-13"><a id="__codelineno-53-13" name="__codelineno-53-13" href="#__codelineno-53-13"></a><span class="go">TEST SUITE: None</span>
</span><span id="__span-53-14"><a id="__codelineno-53-14" name="__codelineno-53-14" href="#__codelineno-53-14"></a><span class="go">NOTES:</span>
</span><span id="__span-53-15"><a id="__codelineno-53-15" name="__codelineno-53-15" href="#__codelineno-53-15"></a><span class="go">cert-manager v1.11.0 has been deployed successfully!</span>
</span><span id="__span-53-16"><a id="__codelineno-53-16" name="__codelineno-53-16" href="#__codelineno-53-16"></a>
</span><span id="__span-53-17"><a id="__codelineno-53-17" name="__codelineno-53-17" href="#__codelineno-53-17"></a><span class="go">In order to begin issuing certificates, you will need to set up a ClusterIssuer</span>
</span><span id="__span-53-18"><a id="__codelineno-53-18" name="__codelineno-53-18" href="#__codelineno-53-18"></a><span class="go">or Issuer resource (for example, by creating a &#39;letsencrypt-staging&#39; issuer).</span>
</span><span id="__span-53-19"><a id="__codelineno-53-19" name="__codelineno-53-19" href="#__codelineno-53-19"></a>
</span><span id="__span-53-20"><a id="__codelineno-53-20" name="__codelineno-53-20" href="#__codelineno-53-20"></a><span class="go">More information on the different types of issuers and how to configure them</span>
</span><span id="__span-53-21"><a id="__codelineno-53-21" name="__codelineno-53-21" href="#__codelineno-53-21"></a><span class="go">can be found in our documentation:</span>
</span><span id="__span-53-22"><a id="__codelineno-53-22" name="__codelineno-53-22" href="#__codelineno-53-22"></a>
</span><span id="__span-53-23"><a id="__codelineno-53-23" name="__codelineno-53-23" href="#__codelineno-53-23"></a><span class="go">https://cert-manager.io/docs/configuration/</span>
</span><span id="__span-53-24"><a id="__codelineno-53-24" name="__codelineno-53-24" href="#__codelineno-53-24"></a>
</span><span id="__span-53-25"><a id="__codelineno-53-25" name="__codelineno-53-25" href="#__codelineno-53-25"></a><span class="go">For information on how to configure cert-manager to automatically provision</span>
</span><span id="__span-53-26"><a id="__codelineno-53-26" name="__codelineno-53-26" href="#__codelineno-53-26"></a><span class="go">Certificates for Ingress resources, take a look at the `ingress-shim`</span>
</span><span id="__span-53-27"><a id="__codelineno-53-27" name="__codelineno-53-27" href="#__codelineno-53-27"></a><span class="go">documentation:</span>
</span><span id="__span-53-28"><a id="__codelineno-53-28" name="__codelineno-53-28" href="#__codelineno-53-28"></a>
</span><span id="__span-53-29"><a id="__codelineno-53-29" name="__codelineno-53-29" href="#__codelineno-53-29"></a><span class="go">https://cert-manager.io/docs/usage/ingress/</span>
</span><span id="__span-53-30"><a id="__codelineno-53-30" name="__codelineno-53-30" href="#__codelineno-53-30"></a>
</span><span id="__span-53-31"><a id="__codelineno-53-31" name="__codelineno-53-31" href="#__codelineno-53-31"></a><span class="gp">$ </span>kubectl<span class="w"> </span>get<span class="w"> </span>all<span class="w"> </span>-n<span class="w"> </span>cert-manager
</span><span id="__span-53-32"><a id="__codelineno-53-32" name="__codelineno-53-32" href="#__codelineno-53-32"></a><span class="go">NAME                                           READY   STATUS    RESTARTS   AGE</span>
</span><span id="__span-53-33"><a id="__codelineno-53-33" name="__codelineno-53-33" href="#__codelineno-53-33"></a><span class="go">pod/cert-manager-64f9f45d6f-qx4hs              1/1     Running   0          4m29s</span>
</span><span id="__span-53-34"><a id="__codelineno-53-34" name="__codelineno-53-34" href="#__codelineno-53-34"></a><span class="go">pod/cert-manager-cainjector-56bbdd5c47-ltjgx   1/1     Running   0          4m29s</span>
</span><span id="__span-53-35"><a id="__codelineno-53-35" name="__codelineno-53-35" href="#__codelineno-53-35"></a><span class="go">pod/cert-manager-webhook-d4f4545d7-tf4l6       1/1     Running   0          4m29s</span>
</span><span id="__span-53-36"><a id="__codelineno-53-36" name="__codelineno-53-36" href="#__codelineno-53-36"></a>
</span><span id="__span-53-37"><a id="__codelineno-53-37" name="__codelineno-53-37" href="#__codelineno-53-37"></a><span class="go">NAME                           TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)    AGE</span>
</span><span id="__span-53-38"><a id="__codelineno-53-38" name="__codelineno-53-38" href="#__codelineno-53-38"></a><span class="go">service/cert-manager           ClusterIP   10.110.150.206   &lt;none&gt;        9402/TCP   4m29s</span>
</span><span id="__span-53-39"><a id="__codelineno-53-39" name="__codelineno-53-39" href="#__codelineno-53-39"></a><span class="go">service/cert-manager-webhook   ClusterIP   10.107.245.49    &lt;none&gt;        443/TCP    4m29s</span>
</span><span id="__span-53-40"><a id="__codelineno-53-40" name="__codelineno-53-40" href="#__codelineno-53-40"></a>
</span><span id="__span-53-41"><a id="__codelineno-53-41" name="__codelineno-53-41" href="#__codelineno-53-41"></a><span class="go">NAME                                      READY   UP-TO-DATE   AVAILABLE   AGE</span>
</span><span id="__span-53-42"><a id="__codelineno-53-42" name="__codelineno-53-42" href="#__codelineno-53-42"></a><span class="go">deployment.apps/cert-manager              1/1     1            1           4m29s</span>
</span><span id="__span-53-43"><a id="__codelineno-53-43" name="__codelineno-53-43" href="#__codelineno-53-43"></a><span class="go">deployment.apps/cert-manager-cainjector   1/1     1            1           4m29s</span>
</span><span id="__span-53-44"><a id="__codelineno-53-44" name="__codelineno-53-44" href="#__codelineno-53-44"></a><span class="go">deployment.apps/cert-manager-webhook      1/1     1            1           4m29s</span>
</span><span id="__span-53-45"><a id="__codelineno-53-45" name="__codelineno-53-45" href="#__codelineno-53-45"></a>
</span><span id="__span-53-46"><a id="__codelineno-53-46" name="__codelineno-53-46" href="#__codelineno-53-46"></a><span class="go">NAME                                                 DESIRED   CURRENT   READY   AGE</span>
</span><span id="__span-53-47"><a id="__codelineno-53-47" name="__codelineno-53-47" href="#__codelineno-53-47"></a><span class="go">replicaset.apps/cert-manager-64f9f45d6f              1         1         1       4m29s</span>
</span><span id="__span-53-48"><a id="__codelineno-53-48" name="__codelineno-53-48" href="#__codelineno-53-48"></a><span class="go">replicaset.apps/cert-manager-cainjector-56bbdd5c47   1         1         1       4m29s</span>
</span><span id="__span-53-49"><a id="__codelineno-53-49" name="__codelineno-53-49" href="#__codelineno-53-49"></a><span class="go">replicaset.apps/cert-manager-webhook-d4f4545d7       1         1         1       4m29s</span>
</span></code></pre></div>
<p>Everything seems to be running fine, but just in case
<a href="https://cert-manager.io/v1.3-docs/installation/kubernetes/#verifying-the-installation">verify the installation</a>
by creating a test cert.</p>
<p>Assuming that works,
<a href="https://cert-manager.io/v1.3-docs/usage/kubectl-plugin/">install the Kubectl plugin</a>;
get the latest release from
<a href="https://github.com/cert-manager/cert-manager/releases/">github.com/cert-manager/cert-manager</a>
to match the Helm chart installed.</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-54-1"><a id="__codelineno-54-1" name="__codelineno-54-1" href="#__codelineno-54-1"></a><span class="gp">$ </span>curl<span class="w"> </span>-L<span class="w"> </span>-o<span class="w"> </span>kubectl-cert-manager.tar.gz<span class="w"> </span><span class="se">\</span>
</span><span id="__span-54-2"><a id="__codelineno-54-2" name="__codelineno-54-2" href="#__codelineno-54-2"></a><span class="w">  </span>https://github.com/cert-manager/cert-manager/releases/download/v1.11.0/kubectl-cert_manager-linux-amd64.tar.gz
</span><span id="__span-54-3"><a id="__codelineno-54-3" name="__codelineno-54-3" href="#__codelineno-54-3"></a><span class="gp">$ </span>tar<span class="w"> </span>xfz<span class="w"> </span>kubectl-cert-manager.tar.gz<span class="w"> </span>
</span><span id="__span-54-4"><a id="__codelineno-54-4" name="__codelineno-54-4" href="#__codelineno-54-4"></a><span class="gp">$ </span>sudo<span class="w"> </span>install<span class="w"> </span>-m<span class="w"> </span><span class="m">755</span><span class="w"> </span>kubectl-cert_manager<span class="w"> </span>/usr/local/bin/
</span><span id="__span-54-5"><a id="__codelineno-54-5" name="__codelineno-54-5" href="#__codelineno-54-5"></a><span class="gp">$ </span>kubectl<span class="w"> </span>cert-manager<span class="w"> </span>check<span class="w"> </span>api
</span><span id="__span-54-6"><a id="__codelineno-54-6" name="__codelineno-54-6" href="#__codelineno-54-6"></a><span class="go">The cert-manager API is ready</span>
</span></code></pre></div>
<p>Create a <code>ClusterIssuer</code> which applies across all Ingress
resources in the cluster, by deploying the following
<code>cert-manager-issuer.yml</code></p>
<div class="language-yaml highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">cert-manager-issuer.yml</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-55-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-55-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-55-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-55-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-55-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-55-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-55-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-55-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-55-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-55-10">10</a></span>
<span class="normal"><a href="#__codelineno-55-11">11</a></span>
<span class="normal"><a href="#__codelineno-55-12">12</a></span>
<span class="normal"><a href="#__codelineno-55-13">13</a></span>
<span class="normal"><a href="#__codelineno-55-14">14</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-55-1"><a id="__codelineno-55-1" name="__codelineno-55-1"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cert-manager.io/v1</span>
</span><span id="__span-55-2"><a id="__codelineno-55-2" name="__codelineno-55-2"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ClusterIssuer</span>
</span><span id="__span-55-3"><a id="__codelineno-55-3" name="__codelineno-55-3"></a><span class="nt">metadata</span><span class="p">:</span>
</span><span id="__span-55-4"><a id="__codelineno-55-4" name="__codelineno-55-4"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">letsencrypt-prod</span>
</span><span id="__span-55-5"><a id="__codelineno-55-5" name="__codelineno-55-5"></a><span class="nt">spec</span><span class="p">:</span>
</span><span id="__span-55-6"><a id="__codelineno-55-6" name="__codelineno-55-6"></a><span class="w">  </span><span class="nt">acme</span><span class="p">:</span>
</span><span id="__span-55-7"><a id="__codelineno-55-7" name="__codelineno-55-7"></a><span class="w">    </span><span class="nt">server</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">https://acme-v02.api.letsencrypt.org/directory</span>
</span><span id="__span-55-8"><a id="__codelineno-55-8" name="__codelineno-55-8"></a><span class="w">    </span><span class="nt">email</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">root@uu.ma</span>
</span><span id="__span-55-9"><a id="__codelineno-55-9" name="__codelineno-55-9"></a><span class="w">    </span><span class="nt">privateKeySecretRef</span><span class="p">:</span>
</span><span id="__span-55-10"><a id="__codelineno-55-10" name="__codelineno-55-10"></a><span class="w">      </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">letsencrypt-prod</span>
</span><span id="__span-55-11"><a id="__codelineno-55-11" name="__codelineno-55-11"></a><span class="w">    </span><span class="nt">solvers</span><span class="p">:</span>
</span><span id="__span-55-12"><a id="__codelineno-55-12" name="__codelineno-55-12"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">http01</span><span class="p">:</span>
</span><span id="__span-55-13"><a id="__codelineno-55-13" name="__codelineno-55-13"></a><span class="w">          </span><span class="nt">ingress</span><span class="p">:</span>
</span><span id="__span-55-14"><a id="__codelineno-55-14" name="__codelineno-55-14"></a><span class="w">            </span><span class="nt">class</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nginx</span>
</span></code></pre></div></td></tr></table></div>
<div class="language-console highlight"><pre><span></span><code><span id="__span-56-1"><a id="__codelineno-56-1" name="__codelineno-56-1" href="#__codelineno-56-1"></a><span class="gp">$ </span>kubectl<span class="w"> </span>create<span class="w"> </span>-f<span class="w"> </span>cert-manager-issuer.yml
</span><span id="__span-56-2"><a id="__codelineno-56-2" name="__codelineno-56-2" href="#__codelineno-56-2"></a><span class="go">clusterissuer.cert-manager.io/letsencrypt-prod created</span>
</span><span id="__span-56-3"><a id="__codelineno-56-3" name="__codelineno-56-3" href="#__codelineno-56-3"></a><span class="gp">$ </span>kubectl<span class="w"> </span>describe<span class="w"> </span>clusterissuer.cert-manager.io/letsencrypt-prod
</span><span id="__span-56-4"><a id="__codelineno-56-4" name="__codelineno-56-4" href="#__codelineno-56-4"></a><span class="go">Name:         letsencrypt-prod</span>
</span><span id="__span-56-5"><a id="__codelineno-56-5" name="__codelineno-56-5" href="#__codelineno-56-5"></a><span class="go">Namespace:    </span>
</span><span id="__span-56-6"><a id="__codelineno-56-6" name="__codelineno-56-6" href="#__codelineno-56-6"></a><span class="go">Labels:       &lt;none&gt;</span>
</span><span id="__span-56-7"><a id="__codelineno-56-7" name="__codelineno-56-7" href="#__codelineno-56-7"></a><span class="go">Annotations:  &lt;none&gt;</span>
</span><span id="__span-56-8"><a id="__codelineno-56-8" name="__codelineno-56-8" href="#__codelineno-56-8"></a><span class="go">API Version:  cert-manager.io/v1</span>
</span><span id="__span-56-9"><a id="__codelineno-56-9" name="__codelineno-56-9" href="#__codelineno-56-9"></a><span class="go">Kind:         ClusterIssuer</span>
</span><span id="__span-56-10"><a id="__codelineno-56-10" name="__codelineno-56-10" href="#__codelineno-56-10"></a><span class="go">Metadata:</span>
</span><span id="__span-56-11"><a id="__codelineno-56-11" name="__codelineno-56-11" href="#__codelineno-56-11"></a><span class="go">  Creation Timestamp:  2023-04-16T14:11:19Z</span>
</span><span id="__span-56-12"><a id="__codelineno-56-12" name="__codelineno-56-12" href="#__codelineno-56-12"></a><span class="go">  Generation:          1</span>
</span><span id="__span-56-13"><a id="__codelineno-56-13" name="__codelineno-56-13" href="#__codelineno-56-13"></a><span class="go">  Resource Version:    3171554</span>
</span><span id="__span-56-14"><a id="__codelineno-56-14" name="__codelineno-56-14" href="#__codelineno-56-14"></a><span class="go">  UID:                 2176e44f-421a-498c-935b-34e71a21cae1</span>
</span><span id="__span-56-15"><a id="__codelineno-56-15" name="__codelineno-56-15" href="#__codelineno-56-15"></a><span class="go">Spec:</span>
</span><span id="__span-56-16"><a id="__codelineno-56-16" name="__codelineno-56-16" href="#__codelineno-56-16"></a><span class="go">  Acme:</span>
</span><span id="__span-56-17"><a id="__codelineno-56-17" name="__codelineno-56-17" href="#__codelineno-56-17"></a><span class="go">    Email:            root@uu.ma</span>
</span><span id="__span-56-18"><a id="__codelineno-56-18" name="__codelineno-56-18" href="#__codelineno-56-18"></a><span class="go">    Preferred Chain:  </span>
</span><span id="__span-56-19"><a id="__codelineno-56-19" name="__codelineno-56-19" href="#__codelineno-56-19"></a><span class="go">    Private Key Secret Ref:</span>
</span><span id="__span-56-20"><a id="__codelineno-56-20" name="__codelineno-56-20" href="#__codelineno-56-20"></a><span class="go">      Name:  letsencrypt-prod</span>
</span><span id="__span-56-21"><a id="__codelineno-56-21" name="__codelineno-56-21" href="#__codelineno-56-21"></a><span class="go">    Server:  https://acme-v02.api.letsencrypt.org/directory</span>
</span><span id="__span-56-22"><a id="__codelineno-56-22" name="__codelineno-56-22" href="#__codelineno-56-22"></a><span class="go">    Solvers:</span>
</span><span id="__span-56-23"><a id="__codelineno-56-23" name="__codelineno-56-23" href="#__codelineno-56-23"></a><span class="go">      http01:</span>
</span><span id="__span-56-24"><a id="__codelineno-56-24" name="__codelineno-56-24" href="#__codelineno-56-24"></a><span class="go">        Ingress:</span>
</span><span id="__span-56-25"><a id="__codelineno-56-25" name="__codelineno-56-25" href="#__codelineno-56-25"></a><span class="go">          Class:  nginx</span>
</span><span id="__span-56-26"><a id="__codelineno-56-26" name="__codelineno-56-26" href="#__codelineno-56-26"></a><span class="go">Status:</span>
</span><span id="__span-56-27"><a id="__codelineno-56-27" name="__codelineno-56-27" href="#__codelineno-56-27"></a><span class="go">  Acme:</span>
</span><span id="__span-56-28"><a id="__codelineno-56-28" name="__codelineno-56-28" href="#__codelineno-56-28"></a><span class="go">    Last Registered Email:  root@uu.ma</span>
</span><span id="__span-56-29"><a id="__codelineno-56-29" name="__codelineno-56-29" href="#__codelineno-56-29"></a><span class="go">    Uri:                    https://acme-v02.api.letsencrypt.org/acme/acct/1063900577</span>
</span><span id="__span-56-30"><a id="__codelineno-56-30" name="__codelineno-56-30" href="#__codelineno-56-30"></a><span class="go">  Conditions:</span>
</span><span id="__span-56-31"><a id="__codelineno-56-31" name="__codelineno-56-31" href="#__codelineno-56-31"></a><span class="go">    Last Transition Time:  2023-04-16T14:11:20Z</span>
</span><span id="__span-56-32"><a id="__codelineno-56-32" name="__codelineno-56-32" href="#__codelineno-56-32"></a><span class="go">    Message:               The ACME account was registered with the ACME server</span>
</span><span id="__span-56-33"><a id="__codelineno-56-33" name="__codelineno-56-33" href="#__codelineno-56-33"></a><span class="go">    Observed Generation:   1</span>
</span><span id="__span-56-34"><a id="__codelineno-56-34" name="__codelineno-56-34" href="#__codelineno-56-34"></a><span class="go">    Reason:                ACMEAccountRegistered</span>
</span><span id="__span-56-35"><a id="__codelineno-56-35" name="__codelineno-56-35" href="#__codelineno-56-35"></a><span class="go">    Status:                True</span>
</span><span id="__span-56-36"><a id="__codelineno-56-36" name="__codelineno-56-36" href="#__codelineno-56-36"></a><span class="go">    Type:                  Ready</span>
</span></code></pre></div>
<h5 id="add-ingress-for-the-first-pod">Add Ingress for the first pod</h5>
<p>Now that we have <code>cert-manager</code> running in the cluster,
lets see how to update Ingress resources to request a
production certificate. Do this by changing the value
of the <code>cert-manager.io/cluster-issuer</code> annotation to
<code>letsencrypt-prod</code> (the <code>ClusterIssuer</code> above).</p>
<p>The example that follows shows the <em>rather bumpy</em>
journe of adding HTTPS to a pod running Gitea.</p>
<p>One way to do this would be using kubectl to apply the
change in Gitea's own Ingress (<code>vi gitea-ingress.yml</code>):</p>
<div class="language-yaml highlight"><pre><span></span><code><span id="__span-57-1"><a id="__codelineno-57-1" name="__codelineno-57-1" href="#__codelineno-57-1"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">networking.k8s.io/v1</span>
</span><span id="__span-57-2"><a id="__codelineno-57-2" name="__codelineno-57-2" href="#__codelineno-57-2"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Ingress</span>
</span><span id="__span-57-3"><a id="__codelineno-57-3" name="__codelineno-57-3" href="#__codelineno-57-3"></a><span class="nt">metadata</span><span class="p">:</span>
</span><span id="__span-57-4"><a id="__codelineno-57-4" name="__codelineno-57-4" href="#__codelineno-57-4"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">gitea-ingress</span>
</span><span id="__span-57-5"><a id="__codelineno-57-5" name="__codelineno-57-5" href="#__codelineno-57-5"></a><span class="w">  </span><span class="nt">annotations</span><span class="p">:</span>
</span><span id="__span-57-6"><a id="__codelineno-57-6" name="__codelineno-57-6" href="#__codelineno-57-6"></a><span class="w">    </span><span class="nt">cert-manager.io/cluster-issuer</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">letsencrypt-prod</span>
</span><span id="__span-57-7"><a id="__codelineno-57-7" name="__codelineno-57-7" href="#__codelineno-57-7"></a><span class="nt">spec</span><span class="p">:</span>
</span><span id="__span-57-8"><a id="__codelineno-57-8" name="__codelineno-57-8" href="#__codelineno-57-8"></a><span class="w">  </span><span class="nt">ingressClassName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nginx</span>
</span><span id="__span-57-9"><a id="__codelineno-57-9" name="__codelineno-57-9" href="#__codelineno-57-9"></a><span class="w">  </span><span class="nt">rules</span><span class="p">:</span>
</span><span id="__span-57-10"><a id="__codelineno-57-10" name="__codelineno-57-10" href="#__codelineno-57-10"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">host</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;git.ssl.uu.am&quot;</span>
</span><span id="__span-57-11"><a id="__codelineno-57-11" name="__codelineno-57-11" href="#__codelineno-57-11"></a><span class="w">      </span><span class="nt">http</span><span class="p">:</span>
</span><span id="__span-57-12"><a id="__codelineno-57-12" name="__codelineno-57-12" href="#__codelineno-57-12"></a><span class="w">        </span><span class="nt">paths</span><span class="p">:</span>
</span><span id="__span-57-13"><a id="__codelineno-57-13" name="__codelineno-57-13" href="#__codelineno-57-13"></a><span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/</span>
</span><span id="__span-57-14"><a id="__codelineno-57-14" name="__codelineno-57-14" href="#__codelineno-57-14"></a><span class="w">            </span><span class="nt">pathType</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Prefix</span>
</span><span id="__span-57-15"><a id="__codelineno-57-15" name="__codelineno-57-15" href="#__codelineno-57-15"></a><span class="w">            </span><span class="nt">backend</span><span class="p">:</span>
</span><span id="__span-57-16"><a id="__codelineno-57-16" name="__codelineno-57-16" href="#__codelineno-57-16"></a><span class="w">              </span><span class="nt">service</span><span class="p">:</span>
</span><span id="__span-57-17"><a id="__codelineno-57-17" name="__codelineno-57-17" href="#__codelineno-57-17"></a><span class="w">                </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">gitea-http</span>
</span><span id="__span-57-18"><a id="__codelineno-57-18" name="__codelineno-57-18" href="#__codelineno-57-18"></a><span class="w">                </span><span class="nt">port</span><span class="p">:</span>
</span><span id="__span-57-19"><a id="__codelineno-57-19" name="__codelineno-57-19" href="#__codelineno-57-19"></a><span class="w">                  </span><span class="nt">number</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">3000</span>
</span><span id="__span-57-20"><a id="__codelineno-57-20" name="__codelineno-57-20" href="#__codelineno-57-20"></a><span class="w">  </span><span class="nt">tls</span><span class="p">:</span>
</span><span id="__span-57-21"><a id="__codelineno-57-21" name="__codelineno-57-21" href="#__codelineno-57-21"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">secretName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">tls-secret</span>
</span><span id="__span-57-22"><a id="__codelineno-57-22" name="__codelineno-57-22" href="#__codelineno-57-22"></a><span class="w">      </span><span class="nt">hosts</span><span class="p">:</span>
</span><span id="__span-57-23"><a id="__codelineno-57-23" name="__codelineno-57-23" href="#__codelineno-57-23"></a><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;git.ssl.uu.am&quot;</span>
</span></code></pre></div>
<div class="language-console highlight"><pre><span></span><code><span id="__span-58-1"><a id="__codelineno-58-1" name="__codelineno-58-1" href="#__codelineno-58-1"></a><span class="gp">$ </span>kubectl<span class="w"> </span>-n<span class="w"> </span>gitea<span class="w"> </span>apply<span class="w"> </span>-f<span class="w"> </span>gitea-ingress.yml
</span></code></pre></div>
<p>Better yet, it should be possible to incorporate this
into values passed to the Gitea Helm chart, applying
the changes to <code>gitea-values.yaml</code> as follows:</p>
<div class="language-yaml highlight"><pre><span></span><code><span id="__span-59-1"><a id="__codelineno-59-1" name="__codelineno-59-1" href="#__codelineno-59-1"></a><span class="nt">ingress</span><span class="p">:</span>
</span><span id="__span-59-2"><a id="__codelineno-59-2" name="__codelineno-59-2" href="#__codelineno-59-2"></a><span class="w">  </span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
</span><span id="__span-59-3"><a id="__codelineno-59-3" name="__codelineno-59-3" href="#__codelineno-59-3"></a><span class="w">  </span><span class="nt">className</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nginx</span>
</span><span id="__span-59-4"><a id="__codelineno-59-4" name="__codelineno-59-4" href="#__codelineno-59-4"></a><span class="w">  </span><span class="nt">annotations</span><span class="p">:</span>
</span><span id="__span-59-5"><a id="__codelineno-59-5" name="__codelineno-59-5" href="#__codelineno-59-5"></a><span class="w">    </span><span class="nt">cert-manager.io/cluster-issuer</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">letsencrypt-prod</span>
</span><span id="__span-59-6"><a id="__codelineno-59-6" name="__codelineno-59-6" href="#__codelineno-59-6"></a><span class="w">    </span><span class="nt">kubernetes.io/tls-acme</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;true&quot;</span>
</span><span id="__span-59-7"><a id="__codelineno-59-7" name="__codelineno-59-7" href="#__codelineno-59-7"></a><span class="w">  </span><span class="nt">hosts</span><span class="p">:</span>
</span><span id="__span-59-8"><a id="__codelineno-59-8" name="__codelineno-59-8" href="#__codelineno-59-8"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">host</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">git.ssl.uu.am</span>
</span><span id="__span-59-9"><a id="__codelineno-59-9" name="__codelineno-59-9" href="#__codelineno-59-9"></a><span class="w">      </span><span class="nt">paths</span><span class="p">:</span>
</span><span id="__span-59-10"><a id="__codelineno-59-10" name="__codelineno-59-10" href="#__codelineno-59-10"></a><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/</span>
</span><span id="__span-59-11"><a id="__codelineno-59-11" name="__codelineno-59-11" href="#__codelineno-59-11"></a><span class="w">          </span><span class="nt">pathType</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Prefix</span>
</span><span id="__span-59-12"><a id="__codelineno-59-12" name="__codelineno-59-12" href="#__codelineno-59-12"></a><span class="w">  </span><span class="nt">tls</span><span class="p">:</span>
</span><span id="__span-59-13"><a id="__codelineno-59-13" name="__codelineno-59-13" href="#__codelineno-59-13"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">secretName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">tls-secret</span>
</span><span id="__span-59-14"><a id="__codelineno-59-14" name="__codelineno-59-14" href="#__codelineno-59-14"></a><span class="w">      </span><span class="nt">hosts</span><span class="p">:</span>
</span><span id="__span-59-15"><a id="__codelineno-59-15" name="__codelineno-59-15" href="#__codelineno-59-15"></a><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;git.ssl.uu.am&quot;</span>
</span></code></pre></div>
<div class="language-console highlight"><pre><span></span><code><span id="__span-60-1"><a id="__codelineno-60-1" name="__codelineno-60-1" href="#__codelineno-60-1"></a><span class="gp">$ </span>helm<span class="w"> </span>install<span class="w"> </span>gitea<span class="w"> </span>gitea-charts/gitea<span class="w"> </span><span class="se">\</span>
</span><span id="__span-60-2"><a id="__codelineno-60-2" name="__codelineno-60-2" href="#__codelineno-60-2"></a><span class="w">  </span>--create-namespace<span class="w"> </span><span class="se">\</span>
</span><span id="__span-60-3"><a id="__codelineno-60-3" name="__codelineno-60-3" href="#__codelineno-60-3"></a><span class="w">  </span>--namespace<span class="o">=</span>gitea<span class="w"> </span><span class="se">\</span>
</span><span id="__span-60-4"><a id="__codelineno-60-4" name="__codelineno-60-4" href="#__codelineno-60-4"></a><span class="w">  </span>--values<span class="o">=</span>gitea-values.yaml<span class="w"> </span><span class="se">\</span>
</span><span id="__span-60-5"><a id="__codelineno-60-5" name="__codelineno-60-5" href="#__codelineno-60-5"></a><span class="w">  </span>--dry-run<span class="w"> </span>--debug
</span><span id="__span-60-6"><a id="__codelineno-60-6" name="__codelineno-60-6" href="#__codelineno-60-6"></a><span class="gp"># </span>Source:<span class="w"> </span>gitea/templates/gitea/ingress.yaml
</span><span id="__span-60-7"><a id="__codelineno-60-7" name="__codelineno-60-7" href="#__codelineno-60-7"></a><span class="go">apiVersion: networking.k8s.io/v1</span>
</span><span id="__span-60-8"><a id="__codelineno-60-8" name="__codelineno-60-8" href="#__codelineno-60-8"></a><span class="go">kind: Ingress</span>
</span><span id="__span-60-9"><a id="__codelineno-60-9" name="__codelineno-60-9" href="#__codelineno-60-9"></a><span class="go">metadata:</span>
</span><span id="__span-60-10"><a id="__codelineno-60-10" name="__codelineno-60-10" href="#__codelineno-60-10"></a><span class="go">  name: gitea</span>
</span><span id="__span-60-11"><a id="__codelineno-60-11" name="__codelineno-60-11" href="#__codelineno-60-11"></a><span class="go">  labels:</span>
</span><span id="__span-60-12"><a id="__codelineno-60-12" name="__codelineno-60-12" href="#__codelineno-60-12"></a><span class="go">    helm.sh/chart: gitea-8.1.0</span>
</span><span id="__span-60-13"><a id="__codelineno-60-13" name="__codelineno-60-13" href="#__codelineno-60-13"></a><span class="go">    app: gitea</span>
</span><span id="__span-60-14"><a id="__codelineno-60-14" name="__codelineno-60-14" href="#__codelineno-60-14"></a><span class="go">    app.kubernetes.io/name: gitea</span>
</span><span id="__span-60-15"><a id="__codelineno-60-15" name="__codelineno-60-15" href="#__codelineno-60-15"></a><span class="go">    app.kubernetes.io/instance: gitea</span>
</span><span id="__span-60-16"><a id="__codelineno-60-16" name="__codelineno-60-16" href="#__codelineno-60-16"></a><span class="go">    app.kubernetes.io/version: &quot;1.19.1&quot;</span>
</span><span id="__span-60-17"><a id="__codelineno-60-17" name="__codelineno-60-17" href="#__codelineno-60-17"></a><span class="go">    version: &quot;1.19.1&quot;</span>
</span><span id="__span-60-18"><a id="__codelineno-60-18" name="__codelineno-60-18" href="#__codelineno-60-18"></a><span class="go">    app.kubernetes.io/managed-by: Helm</span>
</span><span id="__span-60-19"><a id="__codelineno-60-19" name="__codelineno-60-19" href="#__codelineno-60-19"></a><span class="go">  annotations:</span>
</span><span id="__span-60-20"><a id="__codelineno-60-20" name="__codelineno-60-20" href="#__codelineno-60-20"></a><span class="go">    cert-manager.io/cluster-issuer: letsencrypt-prod</span>
</span><span id="__span-60-21"><a id="__codelineno-60-21" name="__codelineno-60-21" href="#__codelineno-60-21"></a><span class="go">    kubernetes.io/ingress.class: nginx</span>
</span><span id="__span-60-22"><a id="__codelineno-60-22" name="__codelineno-60-22" href="#__codelineno-60-22"></a><span class="go">    kubernetes.io/tls-acme: &quot;true&quot;</span>
</span><span id="__span-60-23"><a id="__codelineno-60-23" name="__codelineno-60-23" href="#__codelineno-60-23"></a><span class="go">spec:</span>
</span><span id="__span-60-24"><a id="__codelineno-60-24" name="__codelineno-60-24" href="#__codelineno-60-24"></a><span class="go">  rules:</span>
</span><span id="__span-60-25"><a id="__codelineno-60-25" name="__codelineno-60-25" href="#__codelineno-60-25"></a><span class="go">    - host: &quot;git.ssl.uu.am&quot;</span>
</span><span id="__span-60-26"><a id="__codelineno-60-26" name="__codelineno-60-26" href="#__codelineno-60-26"></a><span class="go">      http:</span>
</span><span id="__span-60-27"><a id="__codelineno-60-27" name="__codelineno-60-27" href="#__codelineno-60-27"></a><span class="go">        paths:</span>
</span><span id="__span-60-28"><a id="__codelineno-60-28" name="__codelineno-60-28" href="#__codelineno-60-28"></a><span class="go">          - path: /</span>
</span><span id="__span-60-29"><a id="__codelineno-60-29" name="__codelineno-60-29" href="#__codelineno-60-29"></a><span class="go">            pathType: Prefix</span>
</span><span id="__span-60-30"><a id="__codelineno-60-30" name="__codelineno-60-30" href="#__codelineno-60-30"></a><span class="go">            backend:</span>
</span><span id="__span-60-31"><a id="__codelineno-60-31" name="__codelineno-60-31" href="#__codelineno-60-31"></a><span class="go">              service:</span>
</span><span id="__span-60-32"><a id="__codelineno-60-32" name="__codelineno-60-32" href="#__codelineno-60-32"></a><span class="go">                name: gitea-http</span>
</span><span id="__span-60-33"><a id="__codelineno-60-33" name="__codelineno-60-33" href="#__codelineno-60-33"></a><span class="go">                port:</span>
</span><span id="__span-60-34"><a id="__codelineno-60-34" name="__codelineno-60-34" href="#__codelineno-60-34"></a><span class="go">                  number: 3000</span>
</span><span id="__span-60-35"><a id="__codelineno-60-35" name="__codelineno-60-35" href="#__codelineno-60-35"></a>
</span><span id="__span-60-36"><a id="__codelineno-60-36" name="__codelineno-60-36" href="#__codelineno-60-36"></a><span class="gp">$ </span>helm<span class="w"> </span>install<span class="w"> </span>gitea<span class="w"> </span>gitea-charts/gitea<span class="w"> </span><span class="se">\</span>
</span><span id="__span-60-37"><a id="__codelineno-60-37" name="__codelineno-60-37" href="#__codelineno-60-37"></a><span class="w">  </span>--create-namespace<span class="w"> </span><span class="se">\</span>
</span><span id="__span-60-38"><a id="__codelineno-60-38" name="__codelineno-60-38" href="#__codelineno-60-38"></a><span class="w">  </span>--namespace<span class="o">=</span>gitea<span class="w"> </span><span class="se">\</span>
</span><span id="__span-60-39"><a id="__codelineno-60-39" name="__codelineno-60-39" href="#__codelineno-60-39"></a><span class="w">  </span>--values<span class="o">=</span>gitea-values.yaml<span class="w"> </span>
</span><span id="__span-60-40"><a id="__codelineno-60-40" name="__codelineno-60-40" href="#__codelineno-60-40"></a><span class="go">coalesce.go:175: warning: skipped value for memcached.initContainers: Not a table.</span>
</span><span id="__span-60-41"><a id="__codelineno-60-41" name="__codelineno-60-41" href="#__codelineno-60-41"></a><span class="go">NAME: gitea</span>
</span><span id="__span-60-42"><a id="__codelineno-60-42" name="__codelineno-60-42" href="#__codelineno-60-42"></a><span class="go">LAST DEPLOYED: Sun Apr 16 16:32:07 2023</span>
</span><span id="__span-60-43"><a id="__codelineno-60-43" name="__codelineno-60-43" href="#__codelineno-60-43"></a><span class="go">NAMESPACE: gitea</span>
</span><span id="__span-60-44"><a id="__codelineno-60-44" name="__codelineno-60-44" href="#__codelineno-60-44"></a><span class="go">STATUS: deployed</span>
</span><span id="__span-60-45"><a id="__codelineno-60-45" name="__codelineno-60-45" href="#__codelineno-60-45"></a><span class="go">REVISION: 1</span>
</span><span id="__span-60-46"><a id="__codelineno-60-46" name="__codelineno-60-46" href="#__codelineno-60-46"></a><span class="go">NOTES:</span>
</span><span id="__span-60-47"><a id="__codelineno-60-47" name="__codelineno-60-47" href="#__codelineno-60-47"></a><span class="go">1. Get the application URL by running these commands:</span>
</span><span id="__span-60-48"><a id="__codelineno-60-48" name="__codelineno-60-48" href="#__codelineno-60-48"></a><span class="go">  http://git.ssl.uu.am/</span>
</span><span id="__span-60-49"><a id="__codelineno-60-49" name="__codelineno-60-49" href="#__codelineno-60-49"></a>
</span><span id="__span-60-50"><a id="__codelineno-60-50" name="__codelineno-60-50" href="#__codelineno-60-50"></a><span class="gp">$ </span>kubectl<span class="w"> </span>get<span class="w"> </span>ingress<span class="w"> </span>-A
</span><span id="__span-60-51"><a id="__codelineno-60-51" name="__codelineno-60-51" href="#__codelineno-60-51"></a><span class="go">NAMESPACE   NAME    CLASS    HOSTS                ADDRESS    PORTS   AGE</span>
</span><span id="__span-60-52"><a id="__codelineno-60-52" name="__codelineno-60-52" href="#__codelineno-60-52"></a><span class="go">gitea       gitea   &lt;none&gt;   git.ssl.uu.am   10.0.0.6   80      20m</span>
</span><span id="__span-60-53"><a id="__codelineno-60-53" name="__codelineno-60-53" href="#__codelineno-60-53"></a>
</span><span id="__span-60-54"><a id="__codelineno-60-54" name="__codelineno-60-54" href="#__codelineno-60-54"></a><span class="gp">$ </span>kubectl<span class="w"> </span>get<span class="w"> </span>all<span class="w"> </span>-n<span class="w"> </span>gitea
</span><span id="__span-60-55"><a id="__codelineno-60-55" name="__codelineno-60-55" href="#__codelineno-60-55"></a><span class="go">NAME                                   READY   STATUS    RESTARTS   AGE</span>
</span><span id="__span-60-56"><a id="__codelineno-60-56" name="__codelineno-60-56" href="#__codelineno-60-56"></a><span class="go">pod/gitea-0                            1/1     Running   0          10m</span>
</span><span id="__span-60-57"><a id="__codelineno-60-57" name="__codelineno-60-57" href="#__codelineno-60-57"></a><span class="go">pod/gitea-memcached-6559f55668-s8nl6   1/1     Running   0          10m</span>
</span><span id="__span-60-58"><a id="__codelineno-60-58" name="__codelineno-60-58" href="#__codelineno-60-58"></a><span class="go">pod/gitea-postgresql-0                 1/1     Running   0          10m</span>
</span><span id="__span-60-59"><a id="__codelineno-60-59" name="__codelineno-60-59" href="#__codelineno-60-59"></a>
</span><span id="__span-60-60"><a id="__codelineno-60-60" name="__codelineno-60-60" href="#__codelineno-60-60"></a><span class="go">NAME                          TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)          AGE</span>
</span><span id="__span-60-61"><a id="__codelineno-60-61" name="__codelineno-60-61" href="#__codelineno-60-61"></a><span class="go">service/gitea-http            NodePort    10.100.158.203   &lt;none&gt;        3000:30080/TCP   10m</span>
</span><span id="__span-60-62"><a id="__codelineno-60-62" name="__codelineno-60-62" href="#__codelineno-60-62"></a><span class="go">service/gitea-memcached       ClusterIP   10.111.252.194   &lt;none&gt;        11211/TCP        10m</span>
</span><span id="__span-60-63"><a id="__codelineno-60-63" name="__codelineno-60-63" href="#__codelineno-60-63"></a><span class="go">service/gitea-postgresql      ClusterIP   10.96.77.223     &lt;none&gt;        5432/TCP         10m</span>
</span><span id="__span-60-64"><a id="__codelineno-60-64" name="__codelineno-60-64" href="#__codelineno-60-64"></a><span class="go">service/gitea-postgresql-hl   ClusterIP   None             &lt;none&gt;        5432/TCP         10m</span>
</span><span id="__span-60-65"><a id="__codelineno-60-65" name="__codelineno-60-65" href="#__codelineno-60-65"></a><span class="go">service/gitea-ssh             NodePort    10.105.190.218   &lt;none&gt;        22:30022/TCP     10m</span>
</span><span id="__span-60-66"><a id="__codelineno-60-66" name="__codelineno-60-66" href="#__codelineno-60-66"></a>
</span><span id="__span-60-67"><a id="__codelineno-60-67" name="__codelineno-60-67" href="#__codelineno-60-67"></a><span class="go">NAME                              READY   UP-TO-DATE   AVAILABLE   AGE</span>
</span><span id="__span-60-68"><a id="__codelineno-60-68" name="__codelineno-60-68" href="#__codelineno-60-68"></a><span class="go">deployment.apps/gitea-memcached   1/1     1            1           10m</span>
</span><span id="__span-60-69"><a id="__codelineno-60-69" name="__codelineno-60-69" href="#__codelineno-60-69"></a>
</span><span id="__span-60-70"><a id="__codelineno-60-70" name="__codelineno-60-70" href="#__codelineno-60-70"></a><span class="go">NAME                                         DESIRED   CURRENT   READY   AGE</span>
</span><span id="__span-60-71"><a id="__codelineno-60-71" name="__codelineno-60-71" href="#__codelineno-60-71"></a><span class="go">replicaset.apps/gitea-memcached-6559f55668   1         1         1       10m</span>
</span><span id="__span-60-72"><a id="__codelineno-60-72" name="__codelineno-60-72" href="#__codelineno-60-72"></a>
</span><span id="__span-60-73"><a id="__codelineno-60-73" name="__codelineno-60-73" href="#__codelineno-60-73"></a><span class="go">NAME                                READY   AGE</span>
</span><span id="__span-60-74"><a id="__codelineno-60-74" name="__codelineno-60-74" href="#__codelineno-60-74"></a><span class="go">statefulset.apps/gitea              1/1     10m</span>
</span><span id="__span-60-75"><a id="__codelineno-60-75" name="__codelineno-60-75" href="#__codelineno-60-75"></a><span class="go">statefulset.apps/gitea-postgresql   1/1     10m</span>
</span></code></pre></div>
<p>This doesn’t work: Ingress gitea doesn’t have a class
and points to port 80 (wrong, should be 3000) Nginx on
(external and node’s) port 443 hasn’t changed
(404 Not Found, fake cert).</p>
<p>Maybe the way to use this is to have Nginx
(somewhere else) point to this service’s port 80?</p>
<p>While we have Gitea already running,
we can try using kubectl to apply this change to
<code>gitea-ingress.yml</code>:</p>
<div class="language-yaml highlight"><pre><span></span><code><span id="__span-61-1"><a id="__codelineno-61-1" name="__codelineno-61-1" href="#__codelineno-61-1"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">networking.k8s.io/v1</span>
</span><span id="__span-61-2"><a id="__codelineno-61-2" name="__codelineno-61-2" href="#__codelineno-61-2"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Ingress</span>
</span><span id="__span-61-3"><a id="__codelineno-61-3" name="__codelineno-61-3" href="#__codelineno-61-3"></a><span class="nt">metadata</span><span class="p">:</span>
</span><span id="__span-61-4"><a id="__codelineno-61-4" name="__codelineno-61-4" href="#__codelineno-61-4"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">gitea-ingress</span>
</span><span id="__span-61-5"><a id="__codelineno-61-5" name="__codelineno-61-5" href="#__codelineno-61-5"></a><span class="w">  </span><span class="nt">annotations</span><span class="p">:</span>
</span><span id="__span-61-6"><a id="__codelineno-61-6" name="__codelineno-61-6" href="#__codelineno-61-6"></a><span class="w">    </span><span class="nt">cert-manager.io/cluster-issuer</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">letsencrypt-prod</span>
</span><span id="__span-61-7"><a id="__codelineno-61-7" name="__codelineno-61-7" href="#__codelineno-61-7"></a><span class="nt">spec</span><span class="p">:</span>
</span><span id="__span-61-8"><a id="__codelineno-61-8" name="__codelineno-61-8" href="#__codelineno-61-8"></a><span class="w">  </span><span class="nt">ingressClassName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nginx</span>
</span><span id="__span-61-9"><a id="__codelineno-61-9" name="__codelineno-61-9" href="#__codelineno-61-9"></a><span class="w">  </span><span class="nt">rules</span><span class="p">:</span>
</span><span id="__span-61-10"><a id="__codelineno-61-10" name="__codelineno-61-10" href="#__codelineno-61-10"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">host</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;git.ssl.uu.am&quot;</span>
</span><span id="__span-61-11"><a id="__codelineno-61-11" name="__codelineno-61-11" href="#__codelineno-61-11"></a><span class="w">      </span><span class="nt">http</span><span class="p">:</span>
</span><span id="__span-61-12"><a id="__codelineno-61-12" name="__codelineno-61-12" href="#__codelineno-61-12"></a><span class="w">        </span><span class="nt">paths</span><span class="p">:</span>
</span><span id="__span-61-13"><a id="__codelineno-61-13" name="__codelineno-61-13" href="#__codelineno-61-13"></a><span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/</span>
</span><span id="__span-61-14"><a id="__codelineno-61-14" name="__codelineno-61-14" href="#__codelineno-61-14"></a><span class="w">            </span><span class="nt">pathType</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Prefix</span>
</span><span id="__span-61-15"><a id="__codelineno-61-15" name="__codelineno-61-15" href="#__codelineno-61-15"></a><span class="w">            </span><span class="nt">backend</span><span class="p">:</span>
</span><span id="__span-61-16"><a id="__codelineno-61-16" name="__codelineno-61-16" href="#__codelineno-61-16"></a><span class="w">              </span><span class="nt">service</span><span class="p">:</span>
</span><span id="__span-61-17"><a id="__codelineno-61-17" name="__codelineno-61-17" href="#__codelineno-61-17"></a><span class="w">                </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">gitea-http</span>
</span><span id="__span-61-18"><a id="__codelineno-61-18" name="__codelineno-61-18" href="#__codelineno-61-18"></a><span class="w">                </span><span class="nt">port</span><span class="p">:</span>
</span><span id="__span-61-19"><a id="__codelineno-61-19" name="__codelineno-61-19" href="#__codelineno-61-19"></a><span class="w">                  </span><span class="nt">number</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">3000</span>
</span><span id="__span-61-20"><a id="__codelineno-61-20" name="__codelineno-61-20" href="#__codelineno-61-20"></a><span class="w">  </span><span class="nt">tls</span><span class="p">:</span>
</span><span id="__span-61-21"><a id="__codelineno-61-21" name="__codelineno-61-21" href="#__codelineno-61-21"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">secretName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">tls-secret</span>
</span><span id="__span-61-22"><a id="__codelineno-61-22" name="__codelineno-61-22" href="#__codelineno-61-22"></a><span class="w">      </span><span class="nt">hosts</span><span class="p">:</span>
</span><span id="__span-61-23"><a id="__codelineno-61-23" name="__codelineno-61-23" href="#__codelineno-61-23"></a><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;git.ssl.uu.am&quot;</span>
</span></code></pre></div>
<p>But this still doesn't work:</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-62-1"><a id="__codelineno-62-1" name="__codelineno-62-1" href="#__codelineno-62-1"></a><span class="gp">$ </span>kubectl<span class="w"> </span>-n<span class="w"> </span>gitea<span class="w"> </span>apply<span class="w"> </span>-f<span class="w"> </span>gitea-ingress.yml
</span><span id="__span-62-2"><a id="__codelineno-62-2" name="__codelineno-62-2" href="#__codelineno-62-2"></a><span class="go">Error from server (BadRequest): error when creating &quot;gitea-ingress.yml&quot;: admission webhook &quot;validate.nginx.ingress.kubernetes.io&quot; denied the request: host &quot;git.ssl.uu.am&quot; and path &quot;/&quot; is already defined in ingress gitea/gitea</span>
</span></code></pre></div>
<p>So we have to not try to add this directly to the Helm
chart, to avoid this conflict. Once that’s removed,
and Gitea reinstall (w/ Helm), we’re back at having an
Ingress entity jus like the one above:</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-63-1"><a id="__codelineno-63-1" name="__codelineno-63-1" href="#__codelineno-63-1"></a><span class="gp">$ </span>kubectl<span class="w"> </span>get<span class="w"> </span>ingress<span class="w"> </span>-A
</span><span id="__span-63-2"><a id="__codelineno-63-2" name="__codelineno-63-2" href="#__codelineno-63-2"></a><span class="go">NAMESPACE   NAME            CLASS   HOSTS                ADDRESS    PORTS   AGE</span>
</span><span id="__span-63-3"><a id="__codelineno-63-3" name="__codelineno-63-3" href="#__codelineno-63-3"></a><span class="go">gitea       gitea-ingress   nginx   git.ssl.uu.am   10.0.0.6   80      56m</span>
</span></code></pre></div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Creating <code>gitea-ingress</code> in the
<code>ingress-nginx</code> namespace won’t work because then
Nginx can’t find the gitea-http service, resulting in
HTTP 503 error at <a href="https://git.ssl.uu.am/">https://git.ssl.uu.am</a></p>
</div>
<div class="language-text highlight"><pre><span></span><code><span id="__span-64-1"><a id="__codelineno-64-1" name="__codelineno-64-1" href="#__codelineno-64-1"></a>W0416 15:55:11.088261       7 controller.go:1044] Error obtaining Endpoints for Service &quot;ingress-nginx/gitea-http&quot;: no object matching key &quot;ingress-nginx/gitea-http&quot; in local store
</span></code></pre></div>
<p>At this point it should be possible to hit the
external IP on port 443, which is forwarded to the
MetalLB IP, and get the Gitea home page at
<a href="https://git.ssl.uu.am/">https://git.ssl.uu.am</a></p>
<p>That partially works: we get to the Gitea service,
but still use the fake cert.</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-65-1"><a id="__codelineno-65-1" name="__codelineno-65-1" href="#__codelineno-65-1"></a><span class="gp">$ </span>kubectl<span class="w"> </span>-n<span class="w"> </span>ingress-nginx<span class="w"> </span>get<span class="w"> </span>pods<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>ingress-nginx-controller
</span><span id="__span-65-2"><a id="__codelineno-65-2" name="__codelineno-65-2" href="#__codelineno-65-2"></a><span class="go">ingress-nginx-controller-6b58ffdc97-rt5lm   1/1     Running     1 (4d12h ago)   14d</span>
</span><span id="__span-65-3"><a id="__codelineno-65-3" name="__codelineno-65-3" href="#__codelineno-65-3"></a>
</span><span id="__span-65-4"><a id="__codelineno-65-4" name="__codelineno-65-4" href="#__codelineno-65-4"></a><span class="gp">$ </span>kubectl<span class="w"> </span>-n<span class="w"> </span>ingress-nginx<span class="w"> </span>logs<span class="w"> </span>ingress-nginx-controller-6b58ffdc97-rt5lm<span class="w"> </span><span class="p">|</span><span class="w"> </span>tail<span class="w"> </span>-10
</span><span id="__span-65-5"><a id="__codelineno-65-5" name="__codelineno-65-5" href="#__codelineno-65-5"></a><span class="go">2023/04/16 16:08:53 [crit] 4655#4655: *6295724 SSL_do_handshake() failed (SSL: error:0A00006C:SSL routines::bad key share) while SSL handshaking, client: 10.244.0.1, server: 0.0.0.0:443</span>
</span><span id="__span-65-6"><a id="__codelineno-65-6" name="__codelineno-65-6" href="#__codelineno-65-6"></a><span class="go">10.244.0.1 - - [16/Apr/2023:16:49:42 +0000] &quot;GET / HTTP/2.0&quot; 200 13744 &quot;-&quot; &quot;Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/112.0.0.0 Safari/537.36&quot; 464 0.004 [gitea-gitea-http-3000] [] 10.244.0.252:3000 13757 0.003 200 1df33130aa3f23144c62d7eb91650dcc</span>
</span></code></pre></div>
<p>Not sure whether the SSL error there is caused by,
or causing, the use of the fake cert.</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-66-1"><a id="__codelineno-66-1" name="__codelineno-66-1" href="#__codelineno-66-1"></a><span class="gp">$ </span>kubectl<span class="w"> </span>-n<span class="w"> </span>gitea<span class="w"> </span>describe<span class="w"> </span>ingress<span class="w"> </span>gitea-ingress
</span><span id="__span-66-2"><a id="__codelineno-66-2" name="__codelineno-66-2" href="#__codelineno-66-2"></a><span class="go">Name:             gitea-ingress</span>
</span><span id="__span-66-3"><a id="__codelineno-66-3" name="__codelineno-66-3" href="#__codelineno-66-3"></a><span class="go">Labels:           &lt;none&gt;</span>
</span><span id="__span-66-4"><a id="__codelineno-66-4" name="__codelineno-66-4" href="#__codelineno-66-4"></a><span class="go">Namespace:        gitea</span>
</span><span id="__span-66-5"><a id="__codelineno-66-5" name="__codelineno-66-5" href="#__codelineno-66-5"></a><span class="go">Address:          10.0.0.6</span>
</span><span id="__span-66-6"><a id="__codelineno-66-6" name="__codelineno-66-6" href="#__codelineno-66-6"></a><span class="go">Ingress Class:    nginx</span>
</span><span id="__span-66-7"><a id="__codelineno-66-7" name="__codelineno-66-7" href="#__codelineno-66-7"></a><span class="go">Default backend:  &lt;default&gt;</span>
</span><span id="__span-66-8"><a id="__codelineno-66-8" name="__codelineno-66-8" href="#__codelineno-66-8"></a><span class="go">Rules:</span>
</span><span id="__span-66-9"><a id="__codelineno-66-9" name="__codelineno-66-9" href="#__codelineno-66-9"></a><span class="go">  Host                Path  Backends</span>
</span><span id="__span-66-10"><a id="__codelineno-66-10" name="__codelineno-66-10" href="#__codelineno-66-10"></a><span class="go">  ----                ----  --------</span>
</span><span id="__span-66-11"><a id="__codelineno-66-11" name="__codelineno-66-11" href="#__codelineno-66-11"></a><span class="go">  git.ssl.uu.am  </span>
</span><span id="__span-66-12"><a id="__codelineno-66-12" name="__codelineno-66-12" href="#__codelineno-66-12"></a><span class="go">                      /   gitea-http:3000 (10.244.0.252:3000)</span>
</span><span id="__span-66-13"><a id="__codelineno-66-13" name="__codelineno-66-13" href="#__codelineno-66-13"></a><span class="go">Annotations:          cert-manager.io/cluster-issuer: letsencrypt-prod</span>
</span><span id="__span-66-14"><a id="__codelineno-66-14" name="__codelineno-66-14" href="#__codelineno-66-14"></a><span class="go">Events:               &lt;none&gt;</span>
</span></code></pre></div>
<p><a href="https://docs.bitnami.com/kubernetes/infrastructure/cert-manager/configuration/secure-ingress-resources/">docs.bitnami.com/kubernetes/.../secure-ingress-resources</a>
looks like perhaps the cert-manager.io/cluster-issuer:
<code>letsencrypt-prod</code> annotation needs to go in the
ingress.class instead of each ingress resource</p>
<p>At this point, we the annotation to <code>nginx-ingress-controller-deploy.yaml</code> under line 601,
and check the diff and apply:</p>
<div class="language-yaml highlight"><pre><span></span><code><span id="__span-67-1"><a id="__codelineno-67-1" name="__codelineno-67-1" href="#__codelineno-67-1"></a><span class="w">  </span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">IngressClass</span>
</span><span id="__span-67-2"><a id="__codelineno-67-2" name="__codelineno-67-2" href="#__codelineno-67-2"></a><span class="w">  </span><span class="nt">metadata</span><span class="p">:</span>
</span><span id="__span-67-3"><a id="__codelineno-67-3" name="__codelineno-67-3" href="#__codelineno-67-3"></a><span class="w">    </span><span class="nt">annotations</span><span class="p">:</span>
</span><span id="__span-67-4"><a id="__codelineno-67-4" name="__codelineno-67-4" href="#__codelineno-67-4"></a><span class="w">      </span><span class="nt">cert-manager.io/cluster-issuer</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">letsencrypt-prod</span>
</span></code></pre></div>
<div class="language-console highlight"><pre><span></span><code><span id="__span-68-1"><a id="__codelineno-68-1" name="__codelineno-68-1" href="#__codelineno-68-1"></a><span class="gp">$ </span>kubectl<span class="w"> </span>diff<span class="w"> </span>-f<span class="w"> </span>nginx-ingress-controller-deploy.yaml<span class="w"> </span>
</span><span id="__span-68-2"><a id="__codelineno-68-2" name="__codelineno-68-2" href="#__codelineno-68-2"></a><span class="go">...</span>
</span><span id="__span-68-3"><a id="__codelineno-68-3" name="__codelineno-68-3" href="#__codelineno-68-3"></a><span class="go"> kind: IngressClass</span>
</span><span id="__span-68-4"><a id="__codelineno-68-4" name="__codelineno-68-4" href="#__codelineno-68-4"></a><span class="go"> metadata:</span>
</span><span id="__span-68-5"><a id="__codelineno-68-5" name="__codelineno-68-5" href="#__codelineno-68-5"></a><span class="go">   annotations:</span>
</span><span id="__span-68-6"><a id="__codelineno-68-6" name="__codelineno-68-6" href="#__codelineno-68-6"></a><span class="go">+    cert-manager.io/cluster-issuer: letsencrypt-prod</span>
</span><span id="__span-68-7"><a id="__codelineno-68-7" name="__codelineno-68-7" href="#__codelineno-68-7"></a><span class="go">...</span>
</span><span id="__span-68-8"><a id="__codelineno-68-8" name="__codelineno-68-8" href="#__codelineno-68-8"></a>
</span><span id="__span-68-9"><a id="__codelineno-68-9" name="__codelineno-68-9" href="#__codelineno-68-9"></a><span class="gp">$ </span>kubectl<span class="w"> </span>apply<span class="w"> </span>-f<span class="w"> </span>nginx-ingress-controller-deploy.yaml
</span><span id="__span-68-10"><a id="__codelineno-68-10" name="__codelineno-68-10" href="#__codelineno-68-10"></a><span class="gp">$ </span>kubectl<span class="w"> </span>-n<span class="w"> </span>ingress-nginx<span class="w"> </span>describe<span class="w"> </span>ingressclass.networking.k8s.io/nginx
</span><span id="__span-68-11"><a id="__codelineno-68-11" name="__codelineno-68-11" href="#__codelineno-68-11"></a><span class="go">Name:         nginx</span>
</span><span id="__span-68-12"><a id="__codelineno-68-12" name="__codelineno-68-12" href="#__codelineno-68-12"></a><span class="go">Labels:       app.kubernetes.io/component=controller</span>
</span><span id="__span-68-13"><a id="__codelineno-68-13" name="__codelineno-68-13" href="#__codelineno-68-13"></a><span class="go">              app.kubernetes.io/instance=ingress-nginx</span>
</span><span id="__span-68-14"><a id="__codelineno-68-14" name="__codelineno-68-14" href="#__codelineno-68-14"></a><span class="go">              app.kubernetes.io/name=ingress-nginx</span>
</span><span id="__span-68-15"><a id="__codelineno-68-15" name="__codelineno-68-15" href="#__codelineno-68-15"></a><span class="go">              app.kubernetes.io/part-of=ingress-nginx</span>
</span><span id="__span-68-16"><a id="__codelineno-68-16" name="__codelineno-68-16" href="#__codelineno-68-16"></a><span class="go">              app.kubernetes.io/version=1.7.0</span>
</span><span id="__span-68-17"><a id="__codelineno-68-17" name="__codelineno-68-17" href="#__codelineno-68-17"></a><span class="go">Annotations:  cert-manager.io/cluster-issuer: letsencrypt-prod</span>
</span><span id="__span-68-18"><a id="__codelineno-68-18" name="__codelineno-68-18" href="#__codelineno-68-18"></a><span class="go">Controller:   k8s.io/ingress-nginx</span>
</span><span id="__span-68-19"><a id="__codelineno-68-19" name="__codelineno-68-19" href="#__codelineno-68-19"></a><span class="go">Events:       &lt;none&gt;</span>
</span></code></pre></div>
<p>That doesn’t seem to make any difference, so we keep looking and find out we’re missing the tls section in <code>gitea-ingress.yml</code> which turned to be important:</p>
<div class="language-yaml highlight"><pre><span></span><code><span id="__span-69-1"><a id="__codelineno-69-1" name="__codelineno-69-1" href="#__codelineno-69-1"></a><span class="w">  </span><span class="nt">tls</span><span class="p">:</span>
</span><span id="__span-69-2"><a id="__codelineno-69-2" name="__codelineno-69-2" href="#__codelineno-69-2"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">secretName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">tls-secret</span>
</span><span id="__span-69-3"><a id="__codelineno-69-3" name="__codelineno-69-3" href="#__codelineno-69-3"></a><span class="w">      </span><span class="nt">hosts</span><span class="p">:</span>
</span><span id="__span-69-4"><a id="__codelineno-69-4" name="__codelineno-69-4" href="#__codelineno-69-4"></a><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;git.ssl.uu.am&quot;</span>
</span></code></pre></div>
<div class="language-console highlight"><pre><span></span><code><span id="__span-70-1"><a id="__codelineno-70-1" name="__codelineno-70-1" href="#__codelineno-70-1"></a><span class="gp">$ </span>kubectl<span class="w"> </span>-n<span class="w"> </span>gitea<span class="w"> </span>apply<span class="w"> </span>-f<span class="w"> </span>gitea/gitea-ingress.yml<span class="w"> </span>
</span><span id="__span-70-2"><a id="__codelineno-70-2" name="__codelineno-70-2" href="#__codelineno-70-2"></a><span class="go">ingress.networking.k8s.io/gitea-ingress configured</span>
</span><span id="__span-70-3"><a id="__codelineno-70-3" name="__codelineno-70-3" href="#__codelineno-70-3"></a>
</span><span id="__span-70-4"><a id="__codelineno-70-4" name="__codelineno-70-4" href="#__codelineno-70-4"></a><span class="gp">$ </span>kubectl<span class="w"> </span>-n<span class="w"> </span>gitea<span class="w"> </span>describe<span class="w"> </span>ingress<span class="w"> </span>gitea-ingress
</span><span id="__span-70-5"><a id="__codelineno-70-5" name="__codelineno-70-5" href="#__codelineno-70-5"></a><span class="go">Name:             gitea-ingress</span>
</span><span id="__span-70-6"><a id="__codelineno-70-6" name="__codelineno-70-6" href="#__codelineno-70-6"></a><span class="go">Labels:           &lt;none&gt;</span>
</span><span id="__span-70-7"><a id="__codelineno-70-7" name="__codelineno-70-7" href="#__codelineno-70-7"></a><span class="go">Namespace:        gitea</span>
</span><span id="__span-70-8"><a id="__codelineno-70-8" name="__codelineno-70-8" href="#__codelineno-70-8"></a><span class="go">Address:          10.0.0.6</span>
</span><span id="__span-70-9"><a id="__codelineno-70-9" name="__codelineno-70-9" href="#__codelineno-70-9"></a><span class="go">Ingress Class:    nginx</span>
</span><span id="__span-70-10"><a id="__codelineno-70-10" name="__codelineno-70-10" href="#__codelineno-70-10"></a><span class="go">Default backend:  &lt;default&gt;</span>
</span><span id="__span-70-11"><a id="__codelineno-70-11" name="__codelineno-70-11" href="#__codelineno-70-11"></a><span class="go">TLS:</span>
</span><span id="__span-70-12"><a id="__codelineno-70-12" name="__codelineno-70-12" href="#__codelineno-70-12"></a><span class="go">  tls-secret terminates git.ssl.uu.am</span>
</span><span id="__span-70-13"><a id="__codelineno-70-13" name="__codelineno-70-13" href="#__codelineno-70-13"></a><span class="go">Rules:</span>
</span><span id="__span-70-14"><a id="__codelineno-70-14" name="__codelineno-70-14" href="#__codelineno-70-14"></a><span class="go">  Host                Path  Backends</span>
</span><span id="__span-70-15"><a id="__codelineno-70-15" name="__codelineno-70-15" href="#__codelineno-70-15"></a><span class="go">  ----                ----  --------</span>
</span><span id="__span-70-16"><a id="__codelineno-70-16" name="__codelineno-70-16" href="#__codelineno-70-16"></a><span class="go">  git.ssl.uu.am</span>
</span><span id="__span-70-17"><a id="__codelineno-70-17" name="__codelineno-70-17" href="#__codelineno-70-17"></a><span class="go">                      /   gitea-http:3000 (10.244.0.252:3000)</span>
</span><span id="__span-70-18"><a id="__codelineno-70-18" name="__codelineno-70-18" href="#__codelineno-70-18"></a><span class="go">Annotations:          cert-manager.io/cluster-issuer: letsencrypt-prod</span>
</span><span id="__span-70-19"><a id="__codelineno-70-19" name="__codelineno-70-19" href="#__codelineno-70-19"></a><span class="go">Events:</span>
</span><span id="__span-70-20"><a id="__codelineno-70-20" name="__codelineno-70-20" href="#__codelineno-70-20"></a><span class="go">  Type    Reason             Age                 From                       Message</span>
</span><span id="__span-70-21"><a id="__codelineno-70-21" name="__codelineno-70-21" href="#__codelineno-70-21"></a><span class="go">  ----    ------             ----                ----                       -------</span>
</span><span id="__span-70-22"><a id="__codelineno-70-22" name="__codelineno-70-22" href="#__codelineno-70-22"></a><span class="go">  Normal  Sync               3s (x3 over 3h17m)  nginx-ingress-controller   Scheduled for sync</span>
</span><span id="__span-70-23"><a id="__codelineno-70-23" name="__codelineno-70-23" href="#__codelineno-70-23"></a><span class="go">  Normal  CreateCertificate  3s                  cert-manager-ingress-shim  Successfully created Certificate &quot;tls-secret&quot;</span>
</span></code></pre></div>
<p>We still get the fake cert on
<a href="https://git.ssl.uu.am/">https://git.ssl.uu.am</a>
(and it’s not the browser caching it).</p>
<p>The ingress controller is complaining that it can’t
find those tls-secret</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-71-1"><a id="__codelineno-71-1" name="__codelineno-71-1" href="#__codelineno-71-1"></a><span class="gp">$ </span>kubectl<span class="w"> </span>-n<span class="w"> </span>ingress-nginx<span class="w"> </span>logs<span class="w"> </span>ingress-nginx-controller-6b58ffdc97-rt5lm<span class="w"> </span><span class="p">|</span><span class="w"> </span>egrep<span class="w"> </span>-i<span class="w"> </span><span class="s1">&#39;ssl.*cert|ssl.*hand&#39;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>-v<span class="w"> </span>gitlab
</span><span id="__span-71-2"><a id="__codelineno-71-2" name="__codelineno-71-2" href="#__codelineno-71-2"></a><span class="go">I0412 04:07:33.044575       7 main.go:104] &quot;SSL fake certificate created&quot; file=&quot;/etc/ingress-controller/ssl/default-fake-certificate.pem&quot;</span>
</span><span id="__span-71-3"><a id="__codelineno-71-3" name="__codelineno-71-3" href="#__codelineno-71-3"></a><span class="go">I0412 04:07:33.075730       7 ssl.go:533] &quot;loading tls certificate&quot; path=&quot;/usr/local/certificates/cert&quot; key=&quot;/usr/local/certificates/key&quot;</span>
</span><span id="__span-71-4"><a id="__codelineno-71-4" name="__codelineno-71-4" href="#__codelineno-71-4"></a><span class="go">2023/04/16 12:41:20 [crit] 3974#3974: *6093931 SSL_do_handshake() failed (SSL: error:0A00006C:SSL routines::bad key share) while SSL handshaking, client: 10.244.0.1, server: 0.0.0.0:443</span>
</span><span id="__span-71-5"><a id="__codelineno-71-5" name="__codelineno-71-5" href="#__codelineno-71-5"></a><span class="go">2023/04/16 15:12:03 [crit] 4112#4112: *6240379 SSL_do_handshake() failed (SSL: error:0A00006C:SSL routines::bad key share) while SSL handshaking, client: 10.244.0.1, server: 0.0.0.0:443</span>
</span><span id="__span-71-6"><a id="__codelineno-71-6" name="__codelineno-71-6" href="#__codelineno-71-6"></a><span class="go">2023/04/16 16:08:53 [crit] 4655#4655: *6295724 SSL_do_handshake() failed (SSL: error:0A00006C:SSL routines::bad key share) while SSL handshaking, client: 10.244.0.1, server: 0.0.0.0:443</span>
</span><span id="__span-71-7"><a id="__codelineno-71-7" name="__codelineno-71-7" href="#__codelineno-71-7"></a><span class="go">W0416 19:13:29.051149       7 controller.go:1372] Error getting SSL certificate &quot;gitea/tls-secret&quot;: local SSL certificate gitea/tls-secret was not found. Using default certificate</span>
</span><span id="__span-71-8"><a id="__codelineno-71-8" name="__codelineno-71-8" href="#__codelineno-71-8"></a><span class="go">W0416 19:13:29.088408       7 backend_ssl.go:47] Error obtaining X.509 certificate: no object matching key &quot;gitea/tls-secret&quot; in local store</span>
</span><span id="__span-71-9"><a id="__codelineno-71-9" name="__codelineno-71-9" href="#__codelineno-71-9"></a><span class="go">...</span>
</span><span id="__span-71-10"><a id="__codelineno-71-10" name="__codelineno-71-10" href="#__codelineno-71-10"></a><span class="go">W0416 19:20:05.541182       7 controller.go:1372] Error getting SSL certificate &quot;kubernetes-dashboard/tls-secret&quot;: local SSL certificate kubernetes-dashboard/tls-secret was not found. Using default certificate</span>
</span><span id="__span-71-11"><a id="__codelineno-71-11" name="__codelineno-71-11" href="#__codelineno-71-11"></a><span class="go">W0416 19:20:05.573367       7 backend_ssl.go:47] Error obtaining X.509 certificate: no object matching key &quot;kubernetes-dashboard/tls-secret&quot; in local store</span>
</span></code></pre></div>
<p>The secrets do exist, do they not contain valid
certificates?</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-72-1"><a id="__codelineno-72-1" name="__codelineno-72-1" href="#__codelineno-72-1"></a><span class="gp">$ </span>kubectl<span class="w"> </span>-n<span class="w"> </span>gitea<span class="w"> </span>describe<span class="w"> </span>cert
</span><span id="__span-72-2"><a id="__codelineno-72-2" name="__codelineno-72-2" href="#__codelineno-72-2"></a><span class="go">Name:         tls-secret</span>
</span><span id="__span-72-3"><a id="__codelineno-72-3" name="__codelineno-72-3" href="#__codelineno-72-3"></a><span class="go">Namespace:    gitea</span>
</span><span id="__span-72-4"><a id="__codelineno-72-4" name="__codelineno-72-4" href="#__codelineno-72-4"></a><span class="go">Labels:       &lt;none&gt;</span>
</span><span id="__span-72-5"><a id="__codelineno-72-5" name="__codelineno-72-5" href="#__codelineno-72-5"></a><span class="go">Annotations:  &lt;none&gt;</span>
</span><span id="__span-72-6"><a id="__codelineno-72-6" name="__codelineno-72-6" href="#__codelineno-72-6"></a><span class="go">API Version:  cert-manager.io/v1</span>
</span><span id="__span-72-7"><a id="__codelineno-72-7" name="__codelineno-72-7" href="#__codelineno-72-7"></a><span class="go">Kind:         Certificate</span>
</span><span id="__span-72-8"><a id="__codelineno-72-8" name="__codelineno-72-8" href="#__codelineno-72-8"></a><span class="go">Metadata:</span>
</span><span id="__span-72-9"><a id="__codelineno-72-9" name="__codelineno-72-9" href="#__codelineno-72-9"></a><span class="go">  Creation Timestamp:  2023-04-16T19:13:29Z</span>
</span><span id="__span-72-10"><a id="__codelineno-72-10" name="__codelineno-72-10" href="#__codelineno-72-10"></a><span class="go">  Generation:          1</span>
</span><span id="__span-72-11"><a id="__codelineno-72-11" name="__codelineno-72-11" href="#__codelineno-72-11"></a><span class="go">  Owner References:</span>
</span><span id="__span-72-12"><a id="__codelineno-72-12" name="__codelineno-72-12" href="#__codelineno-72-12"></a><span class="go">    API Version:           networking.k8s.io/v1</span>
</span><span id="__span-72-13"><a id="__codelineno-72-13" name="__codelineno-72-13" href="#__codelineno-72-13"></a><span class="go">    Block Owner Deletion:  true</span>
</span><span id="__span-72-14"><a id="__codelineno-72-14" name="__codelineno-72-14" href="#__codelineno-72-14"></a><span class="go">    Controller:            true</span>
</span><span id="__span-72-15"><a id="__codelineno-72-15" name="__codelineno-72-15" href="#__codelineno-72-15"></a><span class="go">    Kind:                  Ingress</span>
</span><span id="__span-72-16"><a id="__codelineno-72-16" name="__codelineno-72-16" href="#__codelineno-72-16"></a><span class="go">    Name:                  gitea-ingress</span>
</span><span id="__span-72-17"><a id="__codelineno-72-17" name="__codelineno-72-17" href="#__codelineno-72-17"></a><span class="go">    UID:                   6e4dfaeb-23d8-4a24-906e-c457431f14e5</span>
</span><span id="__span-72-18"><a id="__codelineno-72-18" name="__codelineno-72-18" href="#__codelineno-72-18"></a><span class="go">  Resource Version:        3200901</span>
</span><span id="__span-72-19"><a id="__codelineno-72-19" name="__codelineno-72-19" href="#__codelineno-72-19"></a><span class="go">  UID:                     cb10b560-974f-4533-9eff-c5ff1a8d3933</span>
</span><span id="__span-72-20"><a id="__codelineno-72-20" name="__codelineno-72-20" href="#__codelineno-72-20"></a><span class="go">Spec:</span>
</span><span id="__span-72-21"><a id="__codelineno-72-21" name="__codelineno-72-21" href="#__codelineno-72-21"></a><span class="go">  Dns Names:</span>
</span><span id="__span-72-22"><a id="__codelineno-72-22" name="__codelineno-72-22" href="#__codelineno-72-22"></a><span class="go">    git.ssl.uu.am</span>
</span><span id="__span-72-23"><a id="__codelineno-72-23" name="__codelineno-72-23" href="#__codelineno-72-23"></a><span class="go">  Issuer Ref:</span>
</span><span id="__span-72-24"><a id="__codelineno-72-24" name="__codelineno-72-24" href="#__codelineno-72-24"></a><span class="go">    Group:      cert-manager.io</span>
</span><span id="__span-72-25"><a id="__codelineno-72-25" name="__codelineno-72-25" href="#__codelineno-72-25"></a><span class="go">    Kind:       ClusterIssuer</span>
</span><span id="__span-72-26"><a id="__codelineno-72-26" name="__codelineno-72-26" href="#__codelineno-72-26"></a><span class="go">    Name:       letsencrypt-prod</span>
</span><span id="__span-72-27"><a id="__codelineno-72-27" name="__codelineno-72-27" href="#__codelineno-72-27"></a><span class="go">  Secret Name:  tls-secret</span>
</span><span id="__span-72-28"><a id="__codelineno-72-28" name="__codelineno-72-28" href="#__codelineno-72-28"></a><span class="go">  Usages:</span>
</span><span id="__span-72-29"><a id="__codelineno-72-29" name="__codelineno-72-29" href="#__codelineno-72-29"></a><span class="go">    digital signature</span>
</span><span id="__span-72-30"><a id="__codelineno-72-30" name="__codelineno-72-30" href="#__codelineno-72-30"></a><span class="go">    key encipherment</span>
</span><span id="__span-72-31"><a id="__codelineno-72-31" name="__codelineno-72-31" href="#__codelineno-72-31"></a><span class="go">Status:</span>
</span><span id="__span-72-32"><a id="__codelineno-72-32" name="__codelineno-72-32" href="#__codelineno-72-32"></a><span class="go">  Conditions:</span>
</span><span id="__span-72-33"><a id="__codelineno-72-33" name="__codelineno-72-33" href="#__codelineno-72-33"></a><span class="go">    Last Transition Time:        2023-04-16T19:13:29Z</span>
</span><span id="__span-72-34"><a id="__codelineno-72-34" name="__codelineno-72-34" href="#__codelineno-72-34"></a><span class="go">    Message:                     Issuing certificate as Secret does not exist</span>
</span><span id="__span-72-35"><a id="__codelineno-72-35" name="__codelineno-72-35" href="#__codelineno-72-35"></a><span class="go">    Observed Generation:         1</span>
</span><span id="__span-72-36"><a id="__codelineno-72-36" name="__codelineno-72-36" href="#__codelineno-72-36"></a><span class="go">    Reason:                      DoesNotExist</span>
</span><span id="__span-72-37"><a id="__codelineno-72-37" name="__codelineno-72-37" href="#__codelineno-72-37"></a><span class="go">    Status:                      True</span>
</span><span id="__span-72-38"><a id="__codelineno-72-38" name="__codelineno-72-38" href="#__codelineno-72-38"></a><span class="go">    Type:                        Issuing</span>
</span><span id="__span-72-39"><a id="__codelineno-72-39" name="__codelineno-72-39" href="#__codelineno-72-39"></a><span class="go">    Last Transition Time:        2023-04-16T19:13:29Z</span>
</span><span id="__span-72-40"><a id="__codelineno-72-40" name="__codelineno-72-40" href="#__codelineno-72-40"></a><span class="go">    Message:                     Issuing certificate as Secret does not exist</span>
</span><span id="__span-72-41"><a id="__codelineno-72-41" name="__codelineno-72-41" href="#__codelineno-72-41"></a><span class="go">    Observed Generation:         1</span>
</span><span id="__span-72-42"><a id="__codelineno-72-42" name="__codelineno-72-42" href="#__codelineno-72-42"></a><span class="go">    Reason:                      DoesNotExist</span>
</span><span id="__span-72-43"><a id="__codelineno-72-43" name="__codelineno-72-43" href="#__codelineno-72-43"></a><span class="go">    Status:                      False</span>
</span><span id="__span-72-44"><a id="__codelineno-72-44" name="__codelineno-72-44" href="#__codelineno-72-44"></a><span class="go">    Type:                        Ready</span>
</span><span id="__span-72-45"><a id="__codelineno-72-45" name="__codelineno-72-45" href="#__codelineno-72-45"></a><span class="go">  Next Private Key Secret Name:  tls-secret-84npl</span>
</span><span id="__span-72-46"><a id="__codelineno-72-46" name="__codelineno-72-46" href="#__codelineno-72-46"></a><span class="go">Events:</span>
</span><span id="__span-72-47"><a id="__codelineno-72-47" name="__codelineno-72-47" href="#__codelineno-72-47"></a><span class="go">  Type    Reason     Age   From                                       Message</span>
</span><span id="__span-72-48"><a id="__codelineno-72-48" name="__codelineno-72-48" href="#__codelineno-72-48"></a><span class="go">  ----    ------     ----  ----                                       -------</span>
</span><span id="__span-72-49"><a id="__codelineno-72-49" name="__codelineno-72-49" href="#__codelineno-72-49"></a><span class="go">  Normal  Issuing    12m   cert-manager-certificates-trigger          Issuing certificate as Secret does not exist</span>
</span><span id="__span-72-50"><a id="__codelineno-72-50" name="__codelineno-72-50" href="#__codelineno-72-50"></a><span class="go">  Normal  Generated  12m   cert-manager-certificates-key-manager      Stored new private key in temporary Secret resource &quot;tls-secret-84npl&quot;</span>
</span><span id="__span-72-51"><a id="__codelineno-72-51" name="__codelineno-72-51" href="#__codelineno-72-51"></a><span class="go">  Normal  Requested  12m   cert-manager-certificates-request-manager  Created new CertificateRequest resource &quot;tls-secret-hm94m&quot;</span>
</span><span id="__span-72-52"><a id="__codelineno-72-52" name="__codelineno-72-52" href="#__codelineno-72-52"></a>
</span><span id="__span-72-53"><a id="__codelineno-72-53" name="__codelineno-72-53" href="#__codelineno-72-53"></a><span class="gp">$ </span>kubectl<span class="w"> </span>-n<span class="w"> </span>kubernetes-dashboard<span class="w"> </span>describe<span class="w"> </span>cert
</span><span id="__span-72-54"><a id="__codelineno-72-54" name="__codelineno-72-54" href="#__codelineno-72-54"></a><span class="go">Name:         tls-secret</span>
</span><span id="__span-72-55"><a id="__codelineno-72-55" name="__codelineno-72-55" href="#__codelineno-72-55"></a><span class="go">Namespace:    kubernetes-dashboard</span>
</span><span id="__span-72-56"><a id="__codelineno-72-56" name="__codelineno-72-56" href="#__codelineno-72-56"></a><span class="go">Labels:       &lt;none&gt;</span>
</span><span id="__span-72-57"><a id="__codelineno-72-57" name="__codelineno-72-57" href="#__codelineno-72-57"></a><span class="go">Annotations:  &lt;none&gt;</span>
</span><span id="__span-72-58"><a id="__codelineno-72-58" name="__codelineno-72-58" href="#__codelineno-72-58"></a><span class="go">API Version:  cert-manager.io/v1</span>
</span><span id="__span-72-59"><a id="__codelineno-72-59" name="__codelineno-72-59" href="#__codelineno-72-59"></a><span class="go">Kind:         Certificate</span>
</span><span id="__span-72-60"><a id="__codelineno-72-60" name="__codelineno-72-60" href="#__codelineno-72-60"></a><span class="go">Metadata:</span>
</span><span id="__span-72-61"><a id="__codelineno-72-61" name="__codelineno-72-61" href="#__codelineno-72-61"></a><span class="go">  Creation Timestamp:  2023-04-16T19:20:05Z</span>
</span><span id="__span-72-62"><a id="__codelineno-72-62" name="__codelineno-72-62" href="#__codelineno-72-62"></a><span class="go">  Generation:          1</span>
</span><span id="__span-72-63"><a id="__codelineno-72-63" name="__codelineno-72-63" href="#__codelineno-72-63"></a><span class="go">  Owner References:</span>
</span><span id="__span-72-64"><a id="__codelineno-72-64" name="__codelineno-72-64" href="#__codelineno-72-64"></a><span class="go">    API Version:           networking.k8s.io/v1</span>
</span><span id="__span-72-65"><a id="__codelineno-72-65" name="__codelineno-72-65" href="#__codelineno-72-65"></a><span class="go">    Block Owner Deletion:  true</span>
</span><span id="__span-72-66"><a id="__codelineno-72-66" name="__codelineno-72-66" href="#__codelineno-72-66"></a><span class="go">    Controller:            true</span>
</span><span id="__span-72-67"><a id="__codelineno-72-67" name="__codelineno-72-67" href="#__codelineno-72-67"></a><span class="go">    Kind:                  Ingress</span>
</span><span id="__span-72-68"><a id="__codelineno-72-68" name="__codelineno-72-68" href="#__codelineno-72-68"></a><span class="go">    Name:                  kubernetes-dashboard-ingress</span>
</span><span id="__span-72-69"><a id="__codelineno-72-69" name="__codelineno-72-69" href="#__codelineno-72-69"></a><span class="go">    UID:                   dd2d357c-6558-41fd-bb0c-5b7eb4dc36d5</span>
</span><span id="__span-72-70"><a id="__codelineno-72-70" name="__codelineno-72-70" href="#__codelineno-72-70"></a><span class="go">  Resource Version:        3201584</span>
</span><span id="__span-72-71"><a id="__codelineno-72-71" name="__codelineno-72-71" href="#__codelineno-72-71"></a><span class="go">  UID:                     09f28e55-bbfd-4b0b-a171-80502fa8c88b</span>
</span><span id="__span-72-72"><a id="__codelineno-72-72" name="__codelineno-72-72" href="#__codelineno-72-72"></a><span class="go">Spec:</span>
</span><span id="__span-72-73"><a id="__codelineno-72-73" name="__codelineno-72-73" href="#__codelineno-72-73"></a><span class="go">  Dns Names:</span>
</span><span id="__span-72-74"><a id="__codelineno-72-74" name="__codelineno-72-74" href="#__codelineno-72-74"></a><span class="go">    k8s.ssl.uu.am</span>
</span><span id="__span-72-75"><a id="__codelineno-72-75" name="__codelineno-72-75" href="#__codelineno-72-75"></a><span class="go">  Issuer Ref:</span>
</span><span id="__span-72-76"><a id="__codelineno-72-76" name="__codelineno-72-76" href="#__codelineno-72-76"></a><span class="go">    Group:      cert-manager.io</span>
</span><span id="__span-72-77"><a id="__codelineno-72-77" name="__codelineno-72-77" href="#__codelineno-72-77"></a><span class="go">    Kind:       ClusterIssuer</span>
</span><span id="__span-72-78"><a id="__codelineno-72-78" name="__codelineno-72-78" href="#__codelineno-72-78"></a><span class="go">    Name:       letsencrypt-prod</span>
</span><span id="__span-72-79"><a id="__codelineno-72-79" name="__codelineno-72-79" href="#__codelineno-72-79"></a><span class="go">  Secret Name:  tls-secret</span>
</span><span id="__span-72-80"><a id="__codelineno-72-80" name="__codelineno-72-80" href="#__codelineno-72-80"></a><span class="go">  Usages:</span>
</span><span id="__span-72-81"><a id="__codelineno-72-81" name="__codelineno-72-81" href="#__codelineno-72-81"></a><span class="go">    digital signature</span>
</span><span id="__span-72-82"><a id="__codelineno-72-82" name="__codelineno-72-82" href="#__codelineno-72-82"></a><span class="go">    key encipherment</span>
</span><span id="__span-72-83"><a id="__codelineno-72-83" name="__codelineno-72-83" href="#__codelineno-72-83"></a><span class="go">Status:</span>
</span><span id="__span-72-84"><a id="__codelineno-72-84" name="__codelineno-72-84" href="#__codelineno-72-84"></a><span class="go">  Conditions:</span>
</span><span id="__span-72-85"><a id="__codelineno-72-85" name="__codelineno-72-85" href="#__codelineno-72-85"></a><span class="go">    Last Transition Time:        2023-04-16T19:20:05Z</span>
</span><span id="__span-72-86"><a id="__codelineno-72-86" name="__codelineno-72-86" href="#__codelineno-72-86"></a><span class="go">    Message:                     Issuing certificate as Secret does not exist</span>
</span><span id="__span-72-87"><a id="__codelineno-72-87" name="__codelineno-72-87" href="#__codelineno-72-87"></a><span class="go">    Observed Generation:         1</span>
</span><span id="__span-72-88"><a id="__codelineno-72-88" name="__codelineno-72-88" href="#__codelineno-72-88"></a><span class="go">    Reason:                      DoesNotExist</span>
</span><span id="__span-72-89"><a id="__codelineno-72-89" name="__codelineno-72-89" href="#__codelineno-72-89"></a><span class="go">    Status:                      True</span>
</span><span id="__span-72-90"><a id="__codelineno-72-90" name="__codelineno-72-90" href="#__codelineno-72-90"></a><span class="go">    Type:                        Issuing</span>
</span><span id="__span-72-91"><a id="__codelineno-72-91" name="__codelineno-72-91" href="#__codelineno-72-91"></a><span class="go">    Last Transition Time:        2023-04-16T19:20:05Z</span>
</span><span id="__span-72-92"><a id="__codelineno-72-92" name="__codelineno-72-92" href="#__codelineno-72-92"></a><span class="go">    Message:                     Issuing certificate as Secret does not exist</span>
</span><span id="__span-72-93"><a id="__codelineno-72-93" name="__codelineno-72-93" href="#__codelineno-72-93"></a><span class="go">    Observed Generation:         1</span>
</span><span id="__span-72-94"><a id="__codelineno-72-94" name="__codelineno-72-94" href="#__codelineno-72-94"></a><span class="go">    Reason:                      DoesNotExist</span>
</span><span id="__span-72-95"><a id="__codelineno-72-95" name="__codelineno-72-95" href="#__codelineno-72-95"></a><span class="go">    Status:                      False</span>
</span><span id="__span-72-96"><a id="__codelineno-72-96" name="__codelineno-72-96" href="#__codelineno-72-96"></a><span class="go">    Type:                        Ready</span>
</span><span id="__span-72-97"><a id="__codelineno-72-97" name="__codelineno-72-97" href="#__codelineno-72-97"></a><span class="go">  Next Private Key Secret Name:  tls-secret-dbggr</span>
</span><span id="__span-72-98"><a id="__codelineno-72-98" name="__codelineno-72-98" href="#__codelineno-72-98"></a><span class="go">Events:</span>
</span><span id="__span-72-99"><a id="__codelineno-72-99" name="__codelineno-72-99" href="#__codelineno-72-99"></a><span class="go">  Type    Reason     Age   From                                       Message</span>
</span><span id="__span-72-100"><a id="__codelineno-72-100" name="__codelineno-72-100" href="#__codelineno-72-100"></a><span class="go">  ----    ------     ----  ----                                       -------</span>
</span><span id="__span-72-101"><a id="__codelineno-72-101" name="__codelineno-72-101" href="#__codelineno-72-101"></a><span class="go">  Normal  Issuing    6m    cert-manager-certificates-trigger          Issuing certificate as Secret does not exist</span>
</span><span id="__span-72-102"><a id="__codelineno-72-102" name="__codelineno-72-102" href="#__codelineno-72-102"></a><span class="go">  Normal  Generated  6m    cert-manager-certificates-key-manager      Stored new private key in temporary Secret resource &quot;tls-secret-dbggr&quot;</span>
</span><span id="__span-72-103"><a id="__codelineno-72-103" name="__codelineno-72-103" href="#__codelineno-72-103"></a><span class="go">  Normal  Requested  6m    cert-manager-certificates-request-manager  Created new CertificateRequest resource &quot;tls-secret-8w9rt&quot;</span>
</span></code></pre></div>
<p>Looking at
<a href="https://github.com/cert-manager/cert-manager/discussions/3066">Issuer not found #3066</a>,
it seems we have in-flight orders for certificates,
but are still waiting to receive them:</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-73-1"><a id="__codelineno-73-1" name="__codelineno-73-1" href="#__codelineno-73-1"></a><span class="gp">$ </span>kubectl<span class="w"> </span>-n<span class="w"> </span>gitea<span class="w"> </span>describe<span class="w"> </span>CertificateRequest<span class="w"> </span>tls-secret-hm94m
</span><span id="__span-73-2"><a id="__codelineno-73-2" name="__codelineno-73-2" href="#__codelineno-73-2"></a><span class="go">Name:         tls-secret-hm94m</span>
</span><span id="__span-73-3"><a id="__codelineno-73-3" name="__codelineno-73-3" href="#__codelineno-73-3"></a><span class="go">Namespace:    gitea</span>
</span><span id="__span-73-4"><a id="__codelineno-73-4" name="__codelineno-73-4" href="#__codelineno-73-4"></a><span class="go">Labels:       &lt;none&gt;</span>
</span><span id="__span-73-5"><a id="__codelineno-73-5" name="__codelineno-73-5" href="#__codelineno-73-5"></a><span class="go">Annotations:  cert-manager.io/certificate-name: tls-secret</span>
</span><span id="__span-73-6"><a id="__codelineno-73-6" name="__codelineno-73-6" href="#__codelineno-73-6"></a><span class="go">              cert-manager.io/certificate-revision: 1</span>
</span><span id="__span-73-7"><a id="__codelineno-73-7" name="__codelineno-73-7" href="#__codelineno-73-7"></a><span class="go">              cert-manager.io/private-key-secret-name: tls-secret-84npl</span>
</span><span id="__span-73-8"><a id="__codelineno-73-8" name="__codelineno-73-8" href="#__codelineno-73-8"></a><span class="go">API Version:  cert-manager.io/v1</span>
</span><span id="__span-73-9"><a id="__codelineno-73-9" name="__codelineno-73-9" href="#__codelineno-73-9"></a><span class="go">Kind:         CertificateRequest</span>
</span><span id="__span-73-10"><a id="__codelineno-73-10" name="__codelineno-73-10" href="#__codelineno-73-10"></a><span class="go">Metadata:</span>
</span><span id="__span-73-11"><a id="__codelineno-73-11" name="__codelineno-73-11" href="#__codelineno-73-11"></a><span class="go">  Creation Timestamp:  2023-04-16T19:13:29Z</span>
</span><span id="__span-73-12"><a id="__codelineno-73-12" name="__codelineno-73-12" href="#__codelineno-73-12"></a><span class="go">  Generate Name:       tls-secret-</span>
</span><span id="__span-73-13"><a id="__codelineno-73-13" name="__codelineno-73-13" href="#__codelineno-73-13"></a><span class="go">  Generation:          1</span>
</span><span id="__span-73-14"><a id="__codelineno-73-14" name="__codelineno-73-14" href="#__codelineno-73-14"></a><span class="go">  Owner References:</span>
</span><span id="__span-73-15"><a id="__codelineno-73-15" name="__codelineno-73-15" href="#__codelineno-73-15"></a><span class="go">    API Version:           cert-manager.io/v1</span>
</span><span id="__span-73-16"><a id="__codelineno-73-16" name="__codelineno-73-16" href="#__codelineno-73-16"></a><span class="go">    Block Owner Deletion:  true</span>
</span><span id="__span-73-17"><a id="__codelineno-73-17" name="__codelineno-73-17" href="#__codelineno-73-17"></a><span class="go">    Controller:            true</span>
</span><span id="__span-73-18"><a id="__codelineno-73-18" name="__codelineno-73-18" href="#__codelineno-73-18"></a><span class="go">    Kind:                  Certificate</span>
</span><span id="__span-73-19"><a id="__codelineno-73-19" name="__codelineno-73-19" href="#__codelineno-73-19"></a><span class="go">    Name:                  tls-secret</span>
</span><span id="__span-73-20"><a id="__codelineno-73-20" name="__codelineno-73-20" href="#__codelineno-73-20"></a><span class="go">    UID:                   cb10b560-974f-4533-9eff-c5ff1a8d3933</span>
</span><span id="__span-73-21"><a id="__codelineno-73-21" name="__codelineno-73-21" href="#__codelineno-73-21"></a><span class="go">  Resource Version:        3200917</span>
</span><span id="__span-73-22"><a id="__codelineno-73-22" name="__codelineno-73-22" href="#__codelineno-73-22"></a><span class="go">  UID:                     bb31c94f-fd83-4f62-9edc-5de1cc883b0a</span>
</span><span id="__span-73-23"><a id="__codelineno-73-23" name="__codelineno-73-23" href="#__codelineno-73-23"></a><span class="go">Spec:</span>
</span><span id="__span-73-24"><a id="__codelineno-73-24" name="__codelineno-73-24" href="#__codelineno-73-24"></a><span class="go">  Extra:</span>
</span><span id="__span-73-25"><a id="__codelineno-73-25" name="__codelineno-73-25" href="#__codelineno-73-25"></a><span class="go">    authentication.kubernetes.io/pod-name:</span>
</span><span id="__span-73-26"><a id="__codelineno-73-26" name="__codelineno-73-26" href="#__codelineno-73-26"></a><span class="go">      cert-manager-64f9f45d6f-qx4hs</span>
</span><span id="__span-73-27"><a id="__codelineno-73-27" name="__codelineno-73-27" href="#__codelineno-73-27"></a><span class="go">    authentication.kubernetes.io/pod-uid:</span>
</span><span id="__span-73-28"><a id="__codelineno-73-28" name="__codelineno-73-28" href="#__codelineno-73-28"></a><span class="go">      75a75d95-2318-4fc2-a3fa-0be649a24a31</span>
</span><span id="__span-73-29"><a id="__codelineno-73-29" name="__codelineno-73-29" href="#__codelineno-73-29"></a><span class="go">  Groups:</span>
</span><span id="__span-73-30"><a id="__codelineno-73-30" name="__codelineno-73-30" href="#__codelineno-73-30"></a><span class="go">    system:serviceaccounts</span>
</span><span id="__span-73-31"><a id="__codelineno-73-31" name="__codelineno-73-31" href="#__codelineno-73-31"></a><span class="go">    system:serviceaccounts:cert-manager</span>
</span><span id="__span-73-32"><a id="__codelineno-73-32" name="__codelineno-73-32" href="#__codelineno-73-32"></a><span class="go">    system:authenticated</span>
</span><span id="__span-73-33"><a id="__codelineno-73-33" name="__codelineno-73-33" href="#__codelineno-73-33"></a><span class="go">  Issuer Ref:</span>
</span><span id="__span-73-34"><a id="__codelineno-73-34" name="__codelineno-73-34" href="#__codelineno-73-34"></a><span class="go">    Group:  cert-manager.io</span>
</span><span id="__span-73-35"><a id="__codelineno-73-35" name="__codelineno-73-35" href="#__codelineno-73-35"></a><span class="go">    Kind:   ClusterIssuer</span>
</span><span id="__span-73-36"><a id="__codelineno-73-36" name="__codelineno-73-36" href="#__codelineno-73-36"></a><span class="go">    Name:   letsencrypt-prod</span>
</span><span id="__span-73-37"><a id="__codelineno-73-37" name="__codelineno-73-37" href="#__codelineno-73-37"></a><span class="go">  Request:  …S0K</span>
</span><span id="__span-73-38"><a id="__codelineno-73-38" name="__codelineno-73-38" href="#__codelineno-73-38"></a><span class="go">  UID:      088d0ec3-f284-4387-893c-e4a0eaa223e9</span>
</span><span id="__span-73-39"><a id="__codelineno-73-39" name="__codelineno-73-39" href="#__codelineno-73-39"></a><span class="go">  Usages:</span>
</span><span id="__span-73-40"><a id="__codelineno-73-40" name="__codelineno-73-40" href="#__codelineno-73-40"></a><span class="go">    digital signature</span>
</span><span id="__span-73-41"><a id="__codelineno-73-41" name="__codelineno-73-41" href="#__codelineno-73-41"></a><span class="go">    key encipherment</span>
</span><span id="__span-73-42"><a id="__codelineno-73-42" name="__codelineno-73-42" href="#__codelineno-73-42"></a><span class="go">  Username:  system:serviceaccount:cert-manager:cert-manager</span>
</span><span id="__span-73-43"><a id="__codelineno-73-43" name="__codelineno-73-43" href="#__codelineno-73-43"></a><span class="go">Status:</span>
</span><span id="__span-73-44"><a id="__codelineno-73-44" name="__codelineno-73-44" href="#__codelineno-73-44"></a><span class="go">  Conditions:</span>
</span><span id="__span-73-45"><a id="__codelineno-73-45" name="__codelineno-73-45" href="#__codelineno-73-45"></a><span class="go">    Last Transition Time:  2023-04-16T19:13:29Z</span>
</span><span id="__span-73-46"><a id="__codelineno-73-46" name="__codelineno-73-46" href="#__codelineno-73-46"></a><span class="go">    Message:               Certificate request has been approved by cert-manager.io</span>
</span><span id="__span-73-47"><a id="__codelineno-73-47" name="__codelineno-73-47" href="#__codelineno-73-47"></a><span class="go">    Reason:                cert-manager.io</span>
</span><span id="__span-73-48"><a id="__codelineno-73-48" name="__codelineno-73-48" href="#__codelineno-73-48"></a><span class="go">    Status:                True</span>
</span><span id="__span-73-49"><a id="__codelineno-73-49" name="__codelineno-73-49" href="#__codelineno-73-49"></a><span class="go">    Type:                  Approved</span>
</span><span id="__span-73-50"><a id="__codelineno-73-50" name="__codelineno-73-50" href="#__codelineno-73-50"></a><span class="go">    Last Transition Time:  2023-04-16T19:13:29Z</span>
</span><span id="__span-73-51"><a id="__codelineno-73-51" name="__codelineno-73-51" href="#__codelineno-73-51"></a><span class="go">    Message:               Waiting on certificate issuance from order gitea/tls-secret-hm94m-3966586170: &quot;pending&quot;</span>
</span><span id="__span-73-52"><a id="__codelineno-73-52" name="__codelineno-73-52" href="#__codelineno-73-52"></a><span class="go">    Reason:                Pending</span>
</span><span id="__span-73-53"><a id="__codelineno-73-53" name="__codelineno-73-53" href="#__codelineno-73-53"></a><span class="go">    Status:                False</span>
</span><span id="__span-73-54"><a id="__codelineno-73-54" name="__codelineno-73-54" href="#__codelineno-73-54"></a><span class="go">    Type:                  Ready</span>
</span><span id="__span-73-55"><a id="__codelineno-73-55" name="__codelineno-73-55" href="#__codelineno-73-55"></a><span class="go">Events:</span>
</span><span id="__span-73-56"><a id="__codelineno-73-56" name="__codelineno-73-56" href="#__codelineno-73-56"></a><span class="go">  Type    Reason              Age   From                                                Message</span>
</span><span id="__span-73-57"><a id="__codelineno-73-57" name="__codelineno-73-57" href="#__codelineno-73-57"></a><span class="go">  ----    ------              ----  ----                                                -------</span>
</span><span id="__span-73-58"><a id="__codelineno-73-58" name="__codelineno-73-58" href="#__codelineno-73-58"></a><span class="go">  Normal  WaitingForApproval  19m   cert-manager-certificaterequests-issuer-vault       Not signing CertificateRequest until it is Approved</span>
</span><span id="__span-73-59"><a id="__codelineno-73-59" name="__codelineno-73-59" href="#__codelineno-73-59"></a><span class="go">  Normal  WaitingForApproval  19m   cert-manager-certificaterequests-issuer-selfsigned  Not signing CertificateRequest until it is Approved</span>
</span><span id="__span-73-60"><a id="__codelineno-73-60" name="__codelineno-73-60" href="#__codelineno-73-60"></a><span class="go">  Normal  WaitingForApproval  19m   cert-manager-certificaterequests-issuer-venafi      Not signing CertificateRequest until it is Approved</span>
</span><span id="__span-73-61"><a id="__codelineno-73-61" name="__codelineno-73-61" href="#__codelineno-73-61"></a><span class="go">  Normal  WaitingForApproval  19m   cert-manager-certificaterequests-issuer-acme        Not signing CertificateRequest until it is Approved</span>
</span><span id="__span-73-62"><a id="__codelineno-73-62" name="__codelineno-73-62" href="#__codelineno-73-62"></a><span class="go">  Normal  WaitingForApproval  19m   cert-manager-certificaterequests-issuer-ca          Not signing CertificateRequest until it is Approved</span>
</span><span id="__span-73-63"><a id="__codelineno-73-63" name="__codelineno-73-63" href="#__codelineno-73-63"></a><span class="go">  Normal  cert-manager.io     19m   cert-manager-certificaterequests-approver           Certificate request has been approved by cert-manager.io</span>
</span><span id="__span-73-64"><a id="__codelineno-73-64" name="__codelineno-73-64" href="#__codelineno-73-64"></a><span class="go">  Normal  OrderCreated        19m   cert-manager-certificaterequests-issuer-acme        Created Order resource gitea/tls-secret-hm94m-3966586170</span>
</span><span id="__span-73-65"><a id="__codelineno-73-65" name="__codelineno-73-65" href="#__codelineno-73-65"></a>
</span><span id="__span-73-66"><a id="__codelineno-73-66" name="__codelineno-73-66" href="#__codelineno-73-66"></a><span class="gp">$ </span>kubectl<span class="w"> </span>-n<span class="w"> </span>kubernetes-dashboard<span class="w"> </span>describe<span class="w"> </span>CertificateRequest<span class="w"> </span>tls-secret-8w9rt
</span><span id="__span-73-67"><a id="__codelineno-73-67" name="__codelineno-73-67" href="#__codelineno-73-67"></a><span class="go">Name:         tls-secret-8w9rt</span>
</span><span id="__span-73-68"><a id="__codelineno-73-68" name="__codelineno-73-68" href="#__codelineno-73-68"></a><span class="go">Namespace:    kubernetes-dashboard</span>
</span><span id="__span-73-69"><a id="__codelineno-73-69" name="__codelineno-73-69" href="#__codelineno-73-69"></a><span class="go">Labels:       &lt;none&gt;</span>
</span><span id="__span-73-70"><a id="__codelineno-73-70" name="__codelineno-73-70" href="#__codelineno-73-70"></a><span class="go">Annotations:  cert-manager.io/certificate-name: tls-secret</span>
</span><span id="__span-73-71"><a id="__codelineno-73-71" name="__codelineno-73-71" href="#__codelineno-73-71"></a><span class="go">              cert-manager.io/certificate-revision: 1</span>
</span><span id="__span-73-72"><a id="__codelineno-73-72" name="__codelineno-73-72" href="#__codelineno-73-72"></a><span class="go">              cert-manager.io/private-key-secret-name: tls-secret-dbggr</span>
</span><span id="__span-73-73"><a id="__codelineno-73-73" name="__codelineno-73-73" href="#__codelineno-73-73"></a><span class="go">API Version:  cert-manager.io/v1</span>
</span><span id="__span-73-74"><a id="__codelineno-73-74" name="__codelineno-73-74" href="#__codelineno-73-74"></a><span class="go">Kind:         CertificateRequest</span>
</span><span id="__span-73-75"><a id="__codelineno-73-75" name="__codelineno-73-75" href="#__codelineno-73-75"></a><span class="go">Metadata:</span>
</span><span id="__span-73-76"><a id="__codelineno-73-76" name="__codelineno-73-76" href="#__codelineno-73-76"></a><span class="go">  Creation Timestamp:  2023-04-16T19:20:05Z</span>
</span><span id="__span-73-77"><a id="__codelineno-73-77" name="__codelineno-73-77" href="#__codelineno-73-77"></a><span class="go">  Generate Name:       tls-secret-</span>
</span><span id="__span-73-78"><a id="__codelineno-73-78" name="__codelineno-73-78" href="#__codelineno-73-78"></a><span class="go">  Generation:          1</span>
</span><span id="__span-73-79"><a id="__codelineno-73-79" name="__codelineno-73-79" href="#__codelineno-73-79"></a><span class="go">  Owner References:</span>
</span><span id="__span-73-80"><a id="__codelineno-73-80" name="__codelineno-73-80" href="#__codelineno-73-80"></a><span class="go">    API Version:           cert-manager.io/v1</span>
</span><span id="__span-73-81"><a id="__codelineno-73-81" name="__codelineno-73-81" href="#__codelineno-73-81"></a><span class="go">    Block Owner Deletion:  true</span>
</span><span id="__span-73-82"><a id="__codelineno-73-82" name="__codelineno-73-82" href="#__codelineno-73-82"></a><span class="go">    Controller:            true</span>
</span><span id="__span-73-83"><a id="__codelineno-73-83" name="__codelineno-73-83" href="#__codelineno-73-83"></a><span class="go">    Kind:                  Certificate</span>
</span><span id="__span-73-84"><a id="__codelineno-73-84" name="__codelineno-73-84" href="#__codelineno-73-84"></a><span class="go">    Name:                  tls-secret</span>
</span><span id="__span-73-85"><a id="__codelineno-73-85" name="__codelineno-73-85" href="#__codelineno-73-85"></a><span class="go">    UID:                   09f28e55-bbfd-4b0b-a171-80502fa8c88b</span>
</span><span id="__span-73-86"><a id="__codelineno-73-86" name="__codelineno-73-86" href="#__codelineno-73-86"></a><span class="go">  Resource Version:        3201600</span>
</span><span id="__span-73-87"><a id="__codelineno-73-87" name="__codelineno-73-87" href="#__codelineno-73-87"></a><span class="go">  UID:                     37fe511f-f278-4145-84f4-22d54a08f23b</span>
</span><span id="__span-73-88"><a id="__codelineno-73-88" name="__codelineno-73-88" href="#__codelineno-73-88"></a><span class="go">Spec:</span>
</span><span id="__span-73-89"><a id="__codelineno-73-89" name="__codelineno-73-89" href="#__codelineno-73-89"></a><span class="go">  Extra:</span>
</span><span id="__span-73-90"><a id="__codelineno-73-90" name="__codelineno-73-90" href="#__codelineno-73-90"></a><span class="go">    authentication.kubernetes.io/pod-name:</span>
</span><span id="__span-73-91"><a id="__codelineno-73-91" name="__codelineno-73-91" href="#__codelineno-73-91"></a><span class="go">      cert-manager-64f9f45d6f-qx4hs</span>
</span><span id="__span-73-92"><a id="__codelineno-73-92" name="__codelineno-73-92" href="#__codelineno-73-92"></a><span class="go">    authentication.kubernetes.io/pod-uid:</span>
</span><span id="__span-73-93"><a id="__codelineno-73-93" name="__codelineno-73-93" href="#__codelineno-73-93"></a><span class="go">      75a75d95-2318-4fc2-a3fa-0be649a24a31</span>
</span><span id="__span-73-94"><a id="__codelineno-73-94" name="__codelineno-73-94" href="#__codelineno-73-94"></a><span class="go">  Groups:</span>
</span><span id="__span-73-95"><a id="__codelineno-73-95" name="__codelineno-73-95" href="#__codelineno-73-95"></a><span class="go">    system:serviceaccounts</span>
</span><span id="__span-73-96"><a id="__codelineno-73-96" name="__codelineno-73-96" href="#__codelineno-73-96"></a><span class="go">    system:serviceaccounts:cert-manager</span>
</span><span id="__span-73-97"><a id="__codelineno-73-97" name="__codelineno-73-97" href="#__codelineno-73-97"></a><span class="go">    system:authenticated</span>
</span><span id="__span-73-98"><a id="__codelineno-73-98" name="__codelineno-73-98" href="#__codelineno-73-98"></a><span class="go">  Issuer Ref:</span>
</span><span id="__span-73-99"><a id="__codelineno-73-99" name="__codelineno-73-99" href="#__codelineno-73-99"></a><span class="go">    Group:  cert-manager.io</span>
</span><span id="__span-73-100"><a id="__codelineno-73-100" name="__codelineno-73-100" href="#__codelineno-73-100"></a><span class="go">    Kind:   ClusterIssuer</span>
</span><span id="__span-73-101"><a id="__codelineno-73-101" name="__codelineno-73-101" href="#__codelineno-73-101"></a><span class="go">    Name:   letsencrypt-prod</span>
</span><span id="__span-73-102"><a id="__codelineno-73-102" name="__codelineno-73-102" href="#__codelineno-73-102"></a><span class="go">  Request:  …S0K</span>
</span><span id="__span-73-103"><a id="__codelineno-73-103" name="__codelineno-73-103" href="#__codelineno-73-103"></a><span class="go">  UID:      088d0ec3-f284-4387-893c-e4a0eaa223e9</span>
</span><span id="__span-73-104"><a id="__codelineno-73-104" name="__codelineno-73-104" href="#__codelineno-73-104"></a><span class="go">  Usages:</span>
</span><span id="__span-73-105"><a id="__codelineno-73-105" name="__codelineno-73-105" href="#__codelineno-73-105"></a><span class="go">    digital signature</span>
</span><span id="__span-73-106"><a id="__codelineno-73-106" name="__codelineno-73-106" href="#__codelineno-73-106"></a><span class="go">    key encipherment</span>
</span><span id="__span-73-107"><a id="__codelineno-73-107" name="__codelineno-73-107" href="#__codelineno-73-107"></a><span class="go">  Username:  system:serviceaccount:cert-manager:cert-manager</span>
</span><span id="__span-73-108"><a id="__codelineno-73-108" name="__codelineno-73-108" href="#__codelineno-73-108"></a><span class="go">Status:</span>
</span><span id="__span-73-109"><a id="__codelineno-73-109" name="__codelineno-73-109" href="#__codelineno-73-109"></a><span class="go">  Conditions:</span>
</span><span id="__span-73-110"><a id="__codelineno-73-110" name="__codelineno-73-110" href="#__codelineno-73-110"></a><span class="go">    Last Transition Time:  2023-04-16T19:20:05Z</span>
</span><span id="__span-73-111"><a id="__codelineno-73-111" name="__codelineno-73-111" href="#__codelineno-73-111"></a><span class="go">    Message:               Certificate request has been approved by cert-manager.io</span>
</span><span id="__span-73-112"><a id="__codelineno-73-112" name="__codelineno-73-112" href="#__codelineno-73-112"></a><span class="go">    Reason:                cert-manager.io</span>
</span><span id="__span-73-113"><a id="__codelineno-73-113" name="__codelineno-73-113" href="#__codelineno-73-113"></a><span class="go">    Status:                True</span>
</span><span id="__span-73-114"><a id="__codelineno-73-114" name="__codelineno-73-114" href="#__codelineno-73-114"></a><span class="go">    Type:                  Approved</span>
</span><span id="__span-73-115"><a id="__codelineno-73-115" name="__codelineno-73-115" href="#__codelineno-73-115"></a><span class="go">    Last Transition Time:  2023-04-16T19:20:05Z</span>
</span><span id="__span-73-116"><a id="__codelineno-73-116" name="__codelineno-73-116" href="#__codelineno-73-116"></a><span class="go">    Message:               Waiting on certificate issuance from order kubernetes-dashboard/tls-secret-8w9rt-548771682: &quot;pending&quot;</span>
</span><span id="__span-73-117"><a id="__codelineno-73-117" name="__codelineno-73-117" href="#__codelineno-73-117"></a><span class="go">    Reason:                Pending</span>
</span><span id="__span-73-118"><a id="__codelineno-73-118" name="__codelineno-73-118" href="#__codelineno-73-118"></a><span class="go">    Status:                False</span>
</span><span id="__span-73-119"><a id="__codelineno-73-119" name="__codelineno-73-119" href="#__codelineno-73-119"></a><span class="go">    Type:                  Ready</span>
</span><span id="__span-73-120"><a id="__codelineno-73-120" name="__codelineno-73-120" href="#__codelineno-73-120"></a><span class="go">Events:</span>
</span><span id="__span-73-121"><a id="__codelineno-73-121" name="__codelineno-73-121" href="#__codelineno-73-121"></a><span class="go">  Type    Reason              Age   From                                                Message</span>
</span><span id="__span-73-122"><a id="__codelineno-73-122" name="__codelineno-73-122" href="#__codelineno-73-122"></a><span class="go">  ----    ------              ----  ----                                                -------</span>
</span><span id="__span-73-123"><a id="__codelineno-73-123" name="__codelineno-73-123" href="#__codelineno-73-123"></a><span class="go">  Normal  WaitingForApproval  13m   cert-manager-certificaterequests-issuer-ca          Not signing CertificateRequest until it is Approved</span>
</span><span id="__span-73-124"><a id="__codelineno-73-124" name="__codelineno-73-124" href="#__codelineno-73-124"></a><span class="go">  Normal  WaitingForApproval  13m   cert-manager-certificaterequests-issuer-acme        Not signing CertificateRequest until it is Approved</span>
</span><span id="__span-73-125"><a id="__codelineno-73-125" name="__codelineno-73-125" href="#__codelineno-73-125"></a><span class="go">  Normal  WaitingForApproval  13m   cert-manager-certificaterequests-issuer-selfsigned  Not signing CertificateRequest until it is Approved</span>
</span><span id="__span-73-126"><a id="__codelineno-73-126" name="__codelineno-73-126" href="#__codelineno-73-126"></a><span class="go">  Normal  WaitingForApproval  13m   cert-manager-certificaterequests-issuer-vault       Not signing CertificateRequest until it is Approved</span>
</span><span id="__span-73-127"><a id="__codelineno-73-127" name="__codelineno-73-127" href="#__codelineno-73-127"></a><span class="go">  Normal  WaitingForApproval  13m   cert-manager-certificaterequests-issuer-venafi      Not signing CertificateRequest until it is Approved</span>
</span><span id="__span-73-128"><a id="__codelineno-73-128" name="__codelineno-73-128" href="#__codelineno-73-128"></a><span class="go">  Normal  cert-manager.io     13m   cert-manager-certificaterequests-approver           Certificate request has been approved by cert-manager.io</span>
</span><span id="__span-73-129"><a id="__codelineno-73-129" name="__codelineno-73-129" href="#__codelineno-73-129"></a><span class="go">  Normal  OrderCreated        13m   cert-manager-certificaterequests-issuer-acme        Created Order resource kubernetes-dashboard/tls-secret-8w9rt-548771682</span>
</span><span id="__span-73-130"><a id="__codelineno-73-130" name="__codelineno-73-130" href="#__codelineno-73-130"></a><span class="go">  Normal  OrderPending        13m   cert-manager-certificaterequests-issuer-acme        Waiting on certificate issuance from order kubernetes-dashboard/tls-secret-8w9rt-548771682: &quot;&quot;</span>
</span><span id="__span-73-131"><a id="__codelineno-73-131" name="__codelineno-73-131" href="#__codelineno-73-131"></a>
</span><span id="__span-73-132"><a id="__codelineno-73-132" name="__codelineno-73-132" href="#__codelineno-73-132"></a><span class="gp">$ </span>kubectl<span class="w"> </span>describe<span class="w"> </span>clusterissuer<span class="w"> </span>letsencrypt-prod
</span><span id="__span-73-133"><a id="__codelineno-73-133" name="__codelineno-73-133" href="#__codelineno-73-133"></a><span class="go">Name:         letsencrypt-prod</span>
</span><span id="__span-73-134"><a id="__codelineno-73-134" name="__codelineno-73-134" href="#__codelineno-73-134"></a><span class="go">Namespace:    </span>
</span><span id="__span-73-135"><a id="__codelineno-73-135" name="__codelineno-73-135" href="#__codelineno-73-135"></a><span class="go">Labels:       &lt;none&gt;</span>
</span><span id="__span-73-136"><a id="__codelineno-73-136" name="__codelineno-73-136" href="#__codelineno-73-136"></a><span class="go">Annotations:  &lt;none&gt;</span>
</span><span id="__span-73-137"><a id="__codelineno-73-137" name="__codelineno-73-137" href="#__codelineno-73-137"></a><span class="go">API Version:  cert-manager.io/v1</span>
</span><span id="__span-73-138"><a id="__codelineno-73-138" name="__codelineno-73-138" href="#__codelineno-73-138"></a><span class="go">Kind:         ClusterIssuer</span>
</span><span id="__span-73-139"><a id="__codelineno-73-139" name="__codelineno-73-139" href="#__codelineno-73-139"></a><span class="go">Metadata:</span>
</span><span id="__span-73-140"><a id="__codelineno-73-140" name="__codelineno-73-140" href="#__codelineno-73-140"></a><span class="go">  Creation Timestamp:  2023-04-16T14:11:19Z</span>
</span><span id="__span-73-141"><a id="__codelineno-73-141" name="__codelineno-73-141" href="#__codelineno-73-141"></a><span class="go">  Generation:          1</span>
</span><span id="__span-73-142"><a id="__codelineno-73-142" name="__codelineno-73-142" href="#__codelineno-73-142"></a><span class="go">  Resource Version:    3171554</span>
</span><span id="__span-73-143"><a id="__codelineno-73-143" name="__codelineno-73-143" href="#__codelineno-73-143"></a><span class="go">  UID:                 2176e44f-421a-498c-935b-34e71a21cae1</span>
</span><span id="__span-73-144"><a id="__codelineno-73-144" name="__codelineno-73-144" href="#__codelineno-73-144"></a><span class="go">Spec:</span>
</span><span id="__span-73-145"><a id="__codelineno-73-145" name="__codelineno-73-145" href="#__codelineno-73-145"></a><span class="go">  Acme:</span>
</span><span id="__span-73-146"><a id="__codelineno-73-146" name="__codelineno-73-146" href="#__codelineno-73-146"></a><span class="go">    Email:            root@uu.am</span>
</span><span id="__span-73-147"><a id="__codelineno-73-147" name="__codelineno-73-147" href="#__codelineno-73-147"></a><span class="go">    Preferred Chain:  </span>
</span><span id="__span-73-148"><a id="__codelineno-73-148" name="__codelineno-73-148" href="#__codelineno-73-148"></a><span class="go">    Private Key Secret Ref:</span>
</span><span id="__span-73-149"><a id="__codelineno-73-149" name="__codelineno-73-149" href="#__codelineno-73-149"></a><span class="go">      Name:  letsencrypt-prod</span>
</span><span id="__span-73-150"><a id="__codelineno-73-150" name="__codelineno-73-150" href="#__codelineno-73-150"></a><span class="go">    Server:  https://acme-v02.api.letsencrypt.org/directory</span>
</span><span id="__span-73-151"><a id="__codelineno-73-151" name="__codelineno-73-151" href="#__codelineno-73-151"></a><span class="go">    Solvers:</span>
</span><span id="__span-73-152"><a id="__codelineno-73-152" name="__codelineno-73-152" href="#__codelineno-73-152"></a><span class="go">      http01:</span>
</span><span id="__span-73-153"><a id="__codelineno-73-153" name="__codelineno-73-153" href="#__codelineno-73-153"></a><span class="go">        Ingress:</span>
</span><span id="__span-73-154"><a id="__codelineno-73-154" name="__codelineno-73-154" href="#__codelineno-73-154"></a><span class="go">          Class:  nginx</span>
</span><span id="__span-73-155"><a id="__codelineno-73-155" name="__codelineno-73-155" href="#__codelineno-73-155"></a><span class="go">Status:</span>
</span><span id="__span-73-156"><a id="__codelineno-73-156" name="__codelineno-73-156" href="#__codelineno-73-156"></a><span class="go">  Acme:</span>
</span><span id="__span-73-157"><a id="__codelineno-73-157" name="__codelineno-73-157" href="#__codelineno-73-157"></a><span class="go">    Last Registered Email:  root@uu.am</span>
</span><span id="__span-73-158"><a id="__codelineno-73-158" name="__codelineno-73-158" href="#__codelineno-73-158"></a><span class="go">    Uri:                    https://acme-v02.api.letsencrypt.org/acme/acct/1063900577</span>
</span><span id="__span-73-159"><a id="__codelineno-73-159" name="__codelineno-73-159" href="#__codelineno-73-159"></a><span class="go">  Conditions:</span>
</span><span id="__span-73-160"><a id="__codelineno-73-160" name="__codelineno-73-160" href="#__codelineno-73-160"></a><span class="go">    Last Transition Time:  2023-04-16T14:11:20Z</span>
</span><span id="__span-73-161"><a id="__codelineno-73-161" name="__codelineno-73-161" href="#__codelineno-73-161"></a><span class="go">    Message:               The ACME account was registered with the ACME server</span>
</span><span id="__span-73-162"><a id="__codelineno-73-162" name="__codelineno-73-162" href="#__codelineno-73-162"></a><span class="go">    Observed Generation:   1</span>
</span><span id="__span-73-163"><a id="__codelineno-73-163" name="__codelineno-73-163" href="#__codelineno-73-163"></a><span class="go">    Reason:                ACMEAccountRegistered</span>
</span><span id="__span-73-164"><a id="__codelineno-73-164" name="__codelineno-73-164" href="#__codelineno-73-164"></a><span class="go">    Status:                True</span>
</span><span id="__span-73-165"><a id="__codelineno-73-165" name="__codelineno-73-165" href="#__codelineno-73-165"></a><span class="go">    Type:                  Ready</span>
</span><span id="__span-73-166"><a id="__codelineno-73-166" name="__codelineno-73-166" href="#__codelineno-73-166"></a><span class="go">Events:                    &lt;none&gt;</span>
</span></code></pre></div>
<p>The orders are pending, possibly because the self-check / challenge is failing due to incomplete network setup, i.e. not enough port forwardings:</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-74-1"><a id="__codelineno-74-1" name="__codelineno-74-1" href="#__codelineno-74-1"></a><span class="gp">$ </span>kubectl<span class="w"> </span>-n<span class="w"> </span>gitea<span class="w"> </span>get<span class="w"> </span>order<span class="w"> </span>tls-secret-hm94m-3966586170
</span><span id="__span-74-2"><a id="__codelineno-74-2" name="__codelineno-74-2" href="#__codelineno-74-2"></a><span class="go">NAME                          STATE     AGE</span>
</span><span id="__span-74-3"><a id="__codelineno-74-3" name="__codelineno-74-3" href="#__codelineno-74-3"></a><span class="go">tls-secret-hm94m-3966586170   pending   31m</span>
</span><span id="__span-74-4"><a id="__codelineno-74-4" name="__codelineno-74-4" href="#__codelineno-74-4"></a><span class="gp">$ </span>kubectl<span class="w"> </span>-n<span class="w"> </span>kubernetes-dashboard<span class="w"> </span>get<span class="w"> </span>order<span class="w"> </span>tls-secret-8w9rt-548771682
</span><span id="__span-74-5"><a id="__codelineno-74-5" name="__codelineno-74-5" href="#__codelineno-74-5"></a><span class="go">NAME                         STATE     AGE</span>
</span><span id="__span-74-6"><a id="__codelineno-74-6" name="__codelineno-74-6" href="#__codelineno-74-6"></a><span class="go">tls-secret-8w9rt-548771682   pending   24m</span>
</span></code></pre></div>
<p><a href="https://cert-manager.io/docs/troubleshooting/acme/#2-troubleshooting-orders">Troubleshooting Orders</a>
shows how to find the orders, their challenges and
why they are failing:</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-75-1"><a id="__codelineno-75-1" name="__codelineno-75-1" href="#__codelineno-75-1"></a><span class="gp">$ </span>kubectl<span class="w"> </span>-n<span class="w"> </span>gitea<span class="w"> </span>describe<span class="w"> </span>order<span class="w"> </span>tls-secret-hm94m-3966586170<span class="w"> </span><span class="p">|</span><span class="w"> </span>tail<span class="w"> </span>-4
</span><span id="__span-75-2"><a id="__codelineno-75-2" name="__codelineno-75-2" href="#__codelineno-75-2"></a><span class="go">Events:</span>
</span><span id="__span-75-3"><a id="__codelineno-75-3" name="__codelineno-75-3" href="#__codelineno-75-3"></a><span class="go">  Type    Reason   Age   From                 Message</span>
</span><span id="__span-75-4"><a id="__codelineno-75-4" name="__codelineno-75-4" href="#__codelineno-75-4"></a><span class="go">  ----    ------   ----  ----                 -------</span>
</span><span id="__span-75-5"><a id="__codelineno-75-5" name="__codelineno-75-5" href="#__codelineno-75-5"></a><span class="go">  Normal  Created  34m   cert-manager-orders  Created Challenge resource &quot;tls-secret-hm94m-3966586170-1941395475&quot; for domain &quot;git.ssl.uu.am&quot;</span>
</span><span id="__span-75-6"><a id="__codelineno-75-6" name="__codelineno-75-6" href="#__codelineno-75-6"></a>
</span><span id="__span-75-7"><a id="__codelineno-75-7" name="__codelineno-75-7" href="#__codelineno-75-7"></a><span class="gp">$ </span>kubectl<span class="w"> </span>-n<span class="w"> </span>gitea<span class="w"> </span>describe<span class="w"> </span>challenge<span class="w"> </span>tls-secret-hm94m-3966586170-1941395475<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>Reason:
</span><span id="__span-75-8"><a id="__codelineno-75-8" name="__codelineno-75-8" href="#__codelineno-75-8"></a><span class="go">  Reason:      Waiting for HTTP-01 challenge propagation: failed to perform self check GET request &#39;http://git.ssl.uu.am/.well-known/acme-challenge/cw9i3YCPZQmQXrofkEt4inKYr5x3fEc9wJ6R2ydpeAg&#39;: Get &quot;http://git.ssl.uu.am/.well-known/acme-challenge/cw9i3YCPZQmQXrofkEt4inKYr5x3fEc9wJ6R2ydpeAg&quot;: dial tcp 217.162.57.64:80: connect: connection refused</span>
</span><span id="__span-75-9"><a id="__codelineno-75-9" name="__codelineno-75-9" href="#__codelineno-75-9"></a>
</span><span id="__span-75-10"><a id="__codelineno-75-10" name="__codelineno-75-10" href="#__codelineno-75-10"></a><span class="gp">$ </span>kubectl<span class="w"> </span>-n<span class="w"> </span>kubernetes-dashboard<span class="w"> </span>describe<span class="w"> </span>order<span class="w"> </span>tls-secret-8w9rt-548771682<span class="w"> </span><span class="p">|</span><span class="w"> </span>tail<span class="w"> </span>-4
</span><span id="__span-75-11"><a id="__codelineno-75-11" name="__codelineno-75-11" href="#__codelineno-75-11"></a><span class="go">Events:</span>
</span><span id="__span-75-12"><a id="__codelineno-75-12" name="__codelineno-75-12" href="#__codelineno-75-12"></a><span class="go">  Type    Reason   Age   From                 Message</span>
</span><span id="__span-75-13"><a id="__codelineno-75-13" name="__codelineno-75-13" href="#__codelineno-75-13"></a><span class="go">  ----    ------   ----  ----                 -------</span>
</span><span id="__span-75-14"><a id="__codelineno-75-14" name="__codelineno-75-14" href="#__codelineno-75-14"></a><span class="go">  Normal  Created  28m   cert-manager-orders  Created Challenge resource &quot;tls-secret-8w9rt-548771682-3606431526&quot; for domain &quot;k8s.ssl.uu.am&quot;</span>
</span><span id="__span-75-15"><a id="__codelineno-75-15" name="__codelineno-75-15" href="#__codelineno-75-15"></a>
</span><span id="__span-75-16"><a id="__codelineno-75-16" name="__codelineno-75-16" href="#__codelineno-75-16"></a><span class="gp">$ </span>kubectl<span class="w"> </span>-n<span class="w"> </span>kubernetes-dashboard<span class="w"> </span>describe<span class="w"> </span>challenge<span class="w"> </span>tls-secret-8w9rt-548771682-3606431526<span class="w"> </span><span class="p">|</span>grep<span class="w"> </span>Reason:
</span><span id="__span-75-17"><a id="__codelineno-75-17" name="__codelineno-75-17" href="#__codelineno-75-17"></a><span class="go">  Reason:      Waiting for HTTP-01 challenge propagation: failed to perform self check GET request &#39;http://k8s.ssl.uu.am/.well-known/acme-challenge/Eu-aIJIbu4gRAqgRW2ZcPpGyVk9ZmIBFy23zDQNr14s&#39;: Get &quot;http://k8s.ssl.uu.am/.well-known/acme-challenge/Eu-aIJIbu4gRAqgRW2ZcPpGyVk9ZmIBFy23zDQNr14s&quot;: dial tcp 217.162.57.64:80: connect: connection refused</span>
</span></code></pre></div>
<p>The question is where to redirect that port 80 to;
currently it points to the node’s port 80.
Before trying to sort out that port 80 forwarding,
<a href="https://cert-manager.io/docs/troubleshooting/acme/#http01-troubleshooting">HTTP01 troubleshooting</a>
looks like we want to add 2 more annotations to the
Ingress resources in <code>gitea-ingress.yml</code> and
<code>kubernetes-dashboard-ingress.yaml</code>:</p>
<div class="language-yaml highlight"><pre><span></span><code><span id="__span-76-1"><a id="__codelineno-76-1" name="__codelineno-76-1" href="#__codelineno-76-1"></a><span class="nt">cert-manager.io/issue-temporary-certificate</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;true&quot;</span>
</span><span id="__span-76-2"><a id="__codelineno-76-2" name="__codelineno-76-2" href="#__codelineno-76-2"></a><span class="nt">acme.cert-manager.io/http01-edit-in-place</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;true&quot;</span>
</span></code></pre></div>
<p>Add these and re-apply:</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-77-1"><a id="__codelineno-77-1" name="__codelineno-77-1" href="#__codelineno-77-1"></a><span class="gp">$ </span>kubectl<span class="w"> </span>-n<span class="w"> </span>kubernetes-dashboard<span class="w"> </span>apply<span class="w"> </span>-f<span class="w">  </span>dashboard/kubernetes-dashboard-ingress.yaml
</span><span id="__span-77-2"><a id="__codelineno-77-2" name="__codelineno-77-2" href="#__codelineno-77-2"></a><span class="go">ingress.networking.k8s.io/kubernetes-dashboard-ingress configured</span>
</span><span id="__span-77-3"><a id="__codelineno-77-3" name="__codelineno-77-3" href="#__codelineno-77-3"></a>
</span><span id="__span-77-4"><a id="__codelineno-77-4" name="__codelineno-77-4" href="#__codelineno-77-4"></a><span class="gp">$ </span>kubectl<span class="w"> </span>-n<span class="w"> </span>gitea<span class="w"> </span>apply<span class="w"> </span>-f<span class="w"> </span>gitea-ingress.yml<span class="w"> </span>
</span><span id="__span-77-5"><a id="__codelineno-77-5" name="__codelineno-77-5" href="#__codelineno-77-5"></a><span class="go">ingress.networking.k8s.io/gitea-ingress configured</span>
</span></code></pre></div>
<p>That doesn’t help, at least not immediately,
so <strong>let’s sort out that port forwarding</strong>: 
the trick is to find each acme resolver and forward
external port 80 to its <code>NodePort</code>:</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-78-1"><a id="__codelineno-78-1" name="__codelineno-78-1" href="#__codelineno-78-1"></a><span class="gp">$ </span>kubectl<span class="w"> </span>-n<span class="w"> </span>gitea<span class="w"> </span>get<span class="w"> </span>svc<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>acme
</span><span id="__span-78-2"><a id="__codelineno-78-2" name="__codelineno-78-2" href="#__codelineno-78-2"></a><span class="go">cm-acme-http-solver-wmmvk   NodePort    10.103.37.86     &lt;none&gt;        8089:31544/TCP   51m</span>
</span></code></pre></div>
<p>More generally, for other cert managers:</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-79-1"><a id="__codelineno-79-1" name="__codelineno-79-1" href="#__codelineno-79-1"></a><span class="gp">$ </span>kubectl<span class="w"> </span>get<span class="w"> </span>svc<span class="w"> </span>-A<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>acme
</span><span id="__span-79-2"><a id="__codelineno-79-2" name="__codelineno-79-2" href="#__codelineno-79-2"></a><span class="go">code-server              cm-acme-http-solver-8n9ks                               NodePort       10.101.32.112    &lt;none&gt;          8089:32220/TCP                                                                                  3d19h</span>
</span><span id="__span-79-3"><a id="__codelineno-79-3" name="__codelineno-79-3" href="#__codelineno-79-3"></a><span class="go">kubernetes-dashboard     cm-acme-http-solver-b8l2x                               NodePort       10.100.2.141     &lt;none&gt;          8089:32328/TCP</span>
</span></code></pre></div>
<p>After that port was made accessible, the challenge disappears and the order is <strong>completed successfully</strong>:</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-80-1"><a id="__codelineno-80-1" name="__codelineno-80-1" href="#__codelineno-80-1"></a><span class="gp">$ </span>kubectl<span class="w"> </span>-n<span class="w"> </span>gitea<span class="w"> </span>describe<span class="w"> </span>order<span class="w"> </span>tls-secret-hm94m-3966586170<span class="w"> </span><span class="p">|</span><span class="w"> </span>tail<span class="w"> </span>-4
</span><span id="__span-80-2"><a id="__codelineno-80-2" name="__codelineno-80-2" href="#__codelineno-80-2"></a><span class="go">  Type    Reason    Age   From                 Message</span>
</span><span id="__span-80-3"><a id="__codelineno-80-3" name="__codelineno-80-3" href="#__codelineno-80-3"></a><span class="go">  ----    ------    ----  ----                 -------</span>
</span><span id="__span-80-4"><a id="__codelineno-80-4" name="__codelineno-80-4" href="#__codelineno-80-4"></a><span class="go">  Normal  Created   54m   cert-manager-orders  Created Challenge resource &quot;tls-secret-hm94m-3966586170-1941395475&quot; for domain &quot;git.ssl.uu.am&quot;</span>
</span><span id="__span-80-5"><a id="__codelineno-80-5" name="__codelineno-80-5" href="#__codelineno-80-5"></a><span class="go">  Normal  Complete  82s   cert-manager-orders  Order completed successfully</span>
</span><span id="__span-80-6"><a id="__codelineno-80-6" name="__codelineno-80-6" href="#__codelineno-80-6"></a>
</span><span id="__span-80-7"><a id="__codelineno-80-7" name="__codelineno-80-7" href="#__codelineno-80-7"></a><span class="gp">$ </span>kubectl<span class="w"> </span>-n<span class="w"> </span>gitea<span class="w"> </span>describe<span class="w"> </span>CertificateRequest<span class="w"> </span>tls-secret-hm94m
</span><span id="__span-80-8"><a id="__codelineno-80-8" name="__codelineno-80-8" href="#__codelineno-80-8"></a><span class="go">Name:         tls-secret-hm94m</span>
</span><span id="__span-80-9"><a id="__codelineno-80-9" name="__codelineno-80-9" href="#__codelineno-80-9"></a>
</span><span id="__span-80-10"><a id="__codelineno-80-10" name="__codelineno-80-10" href="#__codelineno-80-10"></a><span class="go">Status:</span>
</span><span id="__span-80-11"><a id="__codelineno-80-11" name="__codelineno-80-11" href="#__codelineno-80-11"></a><span class="go">  Certificate:  LS0…==</span>
</span><span id="__span-80-12"><a id="__codelineno-80-12" name="__codelineno-80-12" href="#__codelineno-80-12"></a><span class="go">  Conditions:</span>
</span><span id="__span-80-13"><a id="__codelineno-80-13" name="__codelineno-80-13" href="#__codelineno-80-13"></a><span class="go">    Last Transition Time:  2023-04-16T19:13:29Z</span>
</span><span id="__span-80-14"><a id="__codelineno-80-14" name="__codelineno-80-14" href="#__codelineno-80-14"></a><span class="go">    Message:               Certificate request has been approved by cert-manager.io</span>
</span><span id="__span-80-15"><a id="__codelineno-80-15" name="__codelineno-80-15" href="#__codelineno-80-15"></a><span class="go">    Reason:                cert-manager.io</span>
</span><span id="__span-80-16"><a id="__codelineno-80-16" name="__codelineno-80-16" href="#__codelineno-80-16"></a><span class="go">    Status:                True</span>
</span><span id="__span-80-17"><a id="__codelineno-80-17" name="__codelineno-80-17" href="#__codelineno-80-17"></a><span class="go">    Type:                  Approved</span>
</span><span id="__span-80-18"><a id="__codelineno-80-18" name="__codelineno-80-18" href="#__codelineno-80-18"></a><span class="go">    Last Transition Time:  2023-04-16T20:06:31Z</span>
</span><span id="__span-80-19"><a id="__codelineno-80-19" name="__codelineno-80-19" href="#__codelineno-80-19"></a><span class="go">    Message:               Certificate fetched from issuer successfully</span>
</span><span id="__span-80-20"><a id="__codelineno-80-20" name="__codelineno-80-20" href="#__codelineno-80-20"></a><span class="go">    Reason:                Issued</span>
</span><span id="__span-80-21"><a id="__codelineno-80-21" name="__codelineno-80-21" href="#__codelineno-80-21"></a><span class="go">    Status:                True</span>
</span><span id="__span-80-22"><a id="__codelineno-80-22" name="__codelineno-80-22" href="#__codelineno-80-22"></a><span class="go">    Type:                  Ready</span>
</span><span id="__span-80-23"><a id="__codelineno-80-23" name="__codelineno-80-23" href="#__codelineno-80-23"></a><span class="go">Events:</span>
</span><span id="__span-80-24"><a id="__codelineno-80-24" name="__codelineno-80-24" href="#__codelineno-80-24"></a><span class="go">...</span>
</span><span id="__span-80-25"><a id="__codelineno-80-25" name="__codelineno-80-25" href="#__codelineno-80-25"></a><span class="go">  Normal  CertificateIssued   2m35s  cert-manager-certificaterequests-issuer-acme        Certificate fetched from issuer successfully</span>
</span><span id="__span-80-26"><a id="__codelineno-80-26" name="__codelineno-80-26" href="#__codelineno-80-26"></a>
</span><span id="__span-80-27"><a id="__codelineno-80-27" name="__codelineno-80-27" href="#__codelineno-80-27"></a><span class="gp">$ </span>kubectl<span class="w"> </span>-n<span class="w"> </span>gitea<span class="w"> </span>describe<span class="w"> </span>cert
</span><span id="__span-80-28"><a id="__codelineno-80-28" name="__codelineno-80-28" href="#__codelineno-80-28"></a><span class="go">Name:         tls-secret</span>
</span><span id="__span-80-29"><a id="__codelineno-80-29" name="__codelineno-80-29" href="#__codelineno-80-29"></a><span class="go">Namespace:    gitea</span>
</span><span id="__span-80-30"><a id="__codelineno-80-30" name="__codelineno-80-30" href="#__codelineno-80-30"></a><span class="go">...</span>
</span><span id="__span-80-31"><a id="__codelineno-80-31" name="__codelineno-80-31" href="#__codelineno-80-31"></a><span class="go">Status:</span>
</span><span id="__span-80-32"><a id="__codelineno-80-32" name="__codelineno-80-32" href="#__codelineno-80-32"></a><span class="go">  Conditions:</span>
</span><span id="__span-80-33"><a id="__codelineno-80-33" name="__codelineno-80-33" href="#__codelineno-80-33"></a><span class="go">    Last Transition Time:  2023-04-16T20:06:31Z</span>
</span><span id="__span-80-34"><a id="__codelineno-80-34" name="__codelineno-80-34" href="#__codelineno-80-34"></a><span class="go">    Message:               Certificate is up to date and has not expired</span>
</span><span id="__span-80-35"><a id="__codelineno-80-35" name="__codelineno-80-35" href="#__codelineno-80-35"></a><span class="go">    Observed Generation:   1</span>
</span><span id="__span-80-36"><a id="__codelineno-80-36" name="__codelineno-80-36" href="#__codelineno-80-36"></a><span class="go">    Reason:                Ready</span>
</span><span id="__span-80-37"><a id="__codelineno-80-37" name="__codelineno-80-37" href="#__codelineno-80-37"></a><span class="go">    Status:                True</span>
</span><span id="__span-80-38"><a id="__codelineno-80-38" name="__codelineno-80-38" href="#__codelineno-80-38"></a><span class="go">    Type:                  Ready</span>
</span><span id="__span-80-39"><a id="__codelineno-80-39" name="__codelineno-80-39" href="#__codelineno-80-39"></a><span class="go">...</span>
</span><span id="__span-80-40"><a id="__codelineno-80-40" name="__codelineno-80-40" href="#__codelineno-80-40"></a><span class="go">Events:</span>
</span><span id="__span-80-41"><a id="__codelineno-80-41" name="__codelineno-80-41" href="#__codelineno-80-41"></a><span class="go">...</span>
</span><span id="__span-80-42"><a id="__codelineno-80-42" name="__codelineno-80-42" href="#__codelineno-80-42"></a><span class="go">  Normal  Issuing    5m    cert-manager-certificates-issuing          The certificate has been successfully issued</span>
</span></code></pre></div>
<p>Now we have certificates, and a new problem!</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-81-1"><a id="__codelineno-81-1" name="__codelineno-81-1" href="#__codelineno-81-1"></a><span class="gp">$ </span>kubectl<span class="w"> </span>-n<span class="w"> </span>ingress-nginx<span class="w"> </span>logs<span class="w"> </span>ingress-nginx-controller-6b58ffdc97-rt5lm<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>-C1<span class="w"> </span>error:0A00006C:SSL
</span><span id="__span-81-2"><a id="__codelineno-81-2" name="__codelineno-81-2" href="#__codelineno-81-2"></a><span class="go">10.244.0.1 - - [16/Apr/2023:20:08:27 +0000] &quot;GET / HTTP/1.1&quot; 200 13779 &quot;-&quot; &quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/110.0.0.0 Safari/537.36&quot; 742 0.003 [gitea-gitea-http-3000] [] 10.244.0.252:3000 13757 0.003 200 2ec12a59924906d8edd0900ff547afeb</span>
</span><span id="__span-81-3"><a id="__codelineno-81-3" name="__codelineno-81-3" href="#__codelineno-81-3"></a><span class="go">2023/04/16 20:08:32 [crit] 5747#5747: *6530552 SSL_do_handshake() failed (SSL: error:0A00006C:SSL routines::bad key share) while SSL handshaking, client: 10.244.0.1, server: 0.0.0.0:443</span>
</span><span id="__span-81-4"><a id="__codelineno-81-4" name="__codelineno-81-4" href="#__codelineno-81-4"></a><span class="go">10.244.0.1 - - [16/Apr/2023:20:10:55 +0000] &quot;GET / HTTP/2.0&quot; 200 36815 &quot;-&quot; &quot;Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/112.0.0.0 Safari/537.36&quot; 599 0.020 [gitea-gitea-http-3000] [] 10.244.0.252:3000 36828 0.020 200 566dde9f9d34e65ae66f7b1ff4efe1cd</span>
</span></code></pre></div>
<p>Maybe the only problem was impatience; left alone for a while and it works perfectly now 🙂</p>
<h5 id="add-ingress-for-kubernetes-dashboard">Add Ingress for Kubernetes Dashboard</h5>
<p>Once the above works, we can do the same for the
<a href="#dashboard">Kubernetes Dashboard</a>:</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-82-1"><a id="__codelineno-82-1" name="__codelineno-82-1" href="#__codelineno-82-1"></a><span class="gp">$ </span>kubectl<span class="w"> </span>-n<span class="w"> </span>kubernetes-dashboard<span class="w"> </span>get<span class="w"> </span>svc
</span><span id="__span-82-2"><a id="__codelineno-82-2" name="__codelineno-82-2" href="#__codelineno-82-2"></a><span class="go">NAME                        TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)         AGE</span>
</span><span id="__span-82-3"><a id="__codelineno-82-3" name="__codelineno-82-3" href="#__codelineno-82-3"></a><span class="go">dashboard-metrics-scraper   ClusterIP   10.96.35.216    &lt;none&gt;        8000/TCP        13d</span>
</span><span id="__span-82-4"><a id="__codelineno-82-4" name="__codelineno-82-4" href="#__codelineno-82-4"></a><span class="go">kubernetes-dashboard        NodePort    10.99.147.241   &lt;none&gt;        443:32000/TCP   13d</span>
</span></code></pre></div>
<p>Update <code>kubernetes-dashboard-ingress.yaml</code> like this:</p>
<div class="language-yaml highlight"><pre><span></span><code><span id="__span-83-1"><a id="__codelineno-83-1" name="__codelineno-83-1" href="#__codelineno-83-1"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">networking.k8s.io/v1</span>
</span><span id="__span-83-2"><a id="__codelineno-83-2" name="__codelineno-83-2" href="#__codelineno-83-2"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Ingress</span>
</span><span id="__span-83-3"><a id="__codelineno-83-3" name="__codelineno-83-3" href="#__codelineno-83-3"></a><span class="nt">metadata</span><span class="p">:</span>
</span><span id="__span-83-4"><a id="__codelineno-83-4" name="__codelineno-83-4" href="#__codelineno-83-4"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">kubernetes-dashboard-ingress</span>
</span><span id="__span-83-5"><a id="__codelineno-83-5" name="__codelineno-83-5" href="#__codelineno-83-5"></a><span class="w">  </span><span class="nt">annotations</span><span class="p">:</span>
</span><span id="__span-83-6"><a id="__codelineno-83-6" name="__codelineno-83-6" href="#__codelineno-83-6"></a><span class="w">    </span><span class="nt">cert-manager.io/cluster-issuer</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">letsencrypt-prod</span>
</span><span id="__span-83-7"><a id="__codelineno-83-7" name="__codelineno-83-7" href="#__codelineno-83-7"></a><span class="w">    </span><span class="nt">nginx.ingress.kubernetes.io/backend-protocol</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;HTTPS&quot;</span>
</span><span id="__span-83-8"><a id="__codelineno-83-8" name="__codelineno-83-8" href="#__codelineno-83-8"></a><span class="w">    </span><span class="nt">nginx.ingress.kubernetes.io/auth-tls-verify-client</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;false&quot;</span>
</span><span id="__span-83-9"><a id="__codelineno-83-9" name="__codelineno-83-9" href="#__codelineno-83-9"></a><span class="w">    </span><span class="nt">nginx.ingress.kubernetes.io/whitelist-source-range</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;10.244.0.0/16&quot;</span>
</span><span id="__span-83-10"><a id="__codelineno-83-10" name="__codelineno-83-10" href="#__codelineno-83-10"></a><span class="nt">spec</span><span class="p">:</span>
</span><span id="__span-83-11"><a id="__codelineno-83-11" name="__codelineno-83-11" href="#__codelineno-83-11"></a><span class="w">  </span><span class="nt">ingressClassName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nginx</span>
</span><span id="__span-83-12"><a id="__codelineno-83-12" name="__codelineno-83-12" href="#__codelineno-83-12"></a><span class="w">  </span><span class="nt">rules</span><span class="p">:</span>
</span><span id="__span-83-13"><a id="__codelineno-83-13" name="__codelineno-83-13" href="#__codelineno-83-13"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">host</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;k8s.ssl.uu.am&quot;</span>
</span><span id="__span-83-14"><a id="__codelineno-83-14" name="__codelineno-83-14" href="#__codelineno-83-14"></a><span class="w">      </span><span class="nt">http</span><span class="p">:</span>
</span><span id="__span-83-15"><a id="__codelineno-83-15" name="__codelineno-83-15" href="#__codelineno-83-15"></a><span class="w">        </span><span class="nt">paths</span><span class="p">:</span>
</span><span id="__span-83-16"><a id="__codelineno-83-16" name="__codelineno-83-16" href="#__codelineno-83-16"></a><span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/</span>
</span><span id="__span-83-17"><a id="__codelineno-83-17" name="__codelineno-83-17" href="#__codelineno-83-17"></a><span class="w">            </span><span class="nt">pathType</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Prefix</span>
</span><span id="__span-83-18"><a id="__codelineno-83-18" name="__codelineno-83-18" href="#__codelineno-83-18"></a><span class="w">            </span><span class="nt">backend</span><span class="p">:</span>
</span><span id="__span-83-19"><a id="__codelineno-83-19" name="__codelineno-83-19" href="#__codelineno-83-19"></a><span class="w">              </span><span class="nt">service</span><span class="p">:</span>
</span><span id="__span-83-20"><a id="__codelineno-83-20" name="__codelineno-83-20" href="#__codelineno-83-20"></a><span class="w">                </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">kubernetes-dashboard</span>
</span><span id="__span-83-21"><a id="__codelineno-83-21" name="__codelineno-83-21" href="#__codelineno-83-21"></a><span class="w">                </span><span class="nt">port</span><span class="p">:</span>
</span><span id="__span-83-22"><a id="__codelineno-83-22" name="__codelineno-83-22" href="#__codelineno-83-22"></a><span class="w">                  </span><span class="nt">number</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">8443</span>
</span></code></pre></div>
<div class="language-console highlight"><pre><span></span><code><span id="__span-84-1"><a id="__codelineno-84-1" name="__codelineno-84-1" href="#__codelineno-84-1"></a><span class="gp">$ </span>kubectl<span class="w"> </span>-n<span class="w"> </span>kubernetes-dashboard<span class="w"> </span><span class="se">\</span>
</span><span id="__span-84-2"><a id="__codelineno-84-2" name="__codelineno-84-2" href="#__codelineno-84-2"></a><span class="w">  </span>apply<span class="w"> </span>-f<span class="w"> </span>kubernetes-dashboard-ingress.yaml<span class="w"> </span>
</span><span id="__span-84-3"><a id="__codelineno-84-3" name="__codelineno-84-3" href="#__codelineno-84-3"></a><span class="go">ingress.networking.k8s.io/kubernetes-dashboard-ingress created</span>
</span><span id="__span-84-4"><a id="__codelineno-84-4" name="__codelineno-84-4" href="#__codelineno-84-4"></a>
</span><span id="__span-84-5"><a id="__codelineno-84-5" name="__codelineno-84-5" href="#__codelineno-84-5"></a><span class="gp">$ </span>kubectl<span class="w"> </span>-n<span class="w"> </span>kubernetes-dashboard<span class="w"> </span>get<span class="w"> </span>ingress
</span><span id="__span-84-6"><a id="__codelineno-84-6" name="__codelineno-84-6" href="#__codelineno-84-6"></a><span class="go">NAME                           CLASS   HOSTS                ADDRESS    PORTS   AGE</span>
</span><span id="__span-84-7"><a id="__codelineno-84-7" name="__codelineno-84-7" href="#__codelineno-84-7"></a><span class="go">kubernetes-dashboard-ingress   nginx   k8s.ssl.uu.am   10.0.0.6   80      3m50s</span>
</span><span id="__span-84-8"><a id="__codelineno-84-8" name="__codelineno-84-8" href="#__codelineno-84-8"></a>
</span><span id="__span-84-9"><a id="__codelineno-84-9" name="__codelineno-84-9" href="#__codelineno-84-9"></a><span class="gp">$ </span>kubectl<span class="w"> </span>-n<span class="w"> </span>kubernetes-dashboard<span class="w"> </span>describe<span class="w"> </span>ingress/kubernetes-dashboard-ingress
</span><span id="__span-84-10"><a id="__codelineno-84-10" name="__codelineno-84-10" href="#__codelineno-84-10"></a><span class="go">Name:             kubernetes-dashboard-ingress</span>
</span><span id="__span-84-11"><a id="__codelineno-84-11" name="__codelineno-84-11" href="#__codelineno-84-11"></a><span class="go">Labels:           &lt;none&gt;</span>
</span><span id="__span-84-12"><a id="__codelineno-84-12" name="__codelineno-84-12" href="#__codelineno-84-12"></a><span class="go">Namespace:        kubernetes-dashboard</span>
</span><span id="__span-84-13"><a id="__codelineno-84-13" name="__codelineno-84-13" href="#__codelineno-84-13"></a><span class="go">Address:          10.0.0.6</span>
</span><span id="__span-84-14"><a id="__codelineno-84-14" name="__codelineno-84-14" href="#__codelineno-84-14"></a><span class="go">Ingress Class:    nginx</span>
</span><span id="__span-84-15"><a id="__codelineno-84-15" name="__codelineno-84-15" href="#__codelineno-84-15"></a><span class="go">Default backend:  &lt;default&gt;</span>
</span><span id="__span-84-16"><a id="__codelineno-84-16" name="__codelineno-84-16" href="#__codelineno-84-16"></a><span class="go">TLS:</span>
</span><span id="__span-84-17"><a id="__codelineno-84-17" name="__codelineno-84-17" href="#__codelineno-84-17"></a><span class="go">  tls-secret terminates k8s.ssl.uu.am</span>
</span><span id="__span-84-18"><a id="__codelineno-84-18" name="__codelineno-84-18" href="#__codelineno-84-18"></a><span class="go">Rules:</span>
</span><span id="__span-84-19"><a id="__codelineno-84-19" name="__codelineno-84-19" href="#__codelineno-84-19"></a><span class="go">  Host                Path  Backends</span>
</span><span id="__span-84-20"><a id="__codelineno-84-20" name="__codelineno-84-20" href="#__codelineno-84-20"></a><span class="go">  ----                ----  --------</span>
</span><span id="__span-84-21"><a id="__codelineno-84-21" name="__codelineno-84-21" href="#__codelineno-84-21"></a><span class="go">  k8s.ssl.uu.am  </span>
</span><span id="__span-84-22"><a id="__codelineno-84-22" name="__codelineno-84-22" href="#__codelineno-84-22"></a><span class="go">                      /   kubernetes-dashboard:8443 (10.244.0.82:8443)</span>
</span><span id="__span-84-23"><a id="__codelineno-84-23" name="__codelineno-84-23" href="#__codelineno-84-23"></a><span class="go">Annotations:          cert-manager.io/cluster-issuer: letsencrypt-prod</span>
</span><span id="__span-84-24"><a id="__codelineno-84-24" name="__codelineno-84-24" href="#__codelineno-84-24"></a><span class="go">                      nginx.ingress.kubernetes.io/auth-tls-verify-client: false</span>
</span><span id="__span-84-25"><a id="__codelineno-84-25" name="__codelineno-84-25" href="#__codelineno-84-25"></a><span class="go">                      nginx.ingress.kubernetes.io/backend-protocol: HTTPS</span>
</span><span id="__span-84-26"><a id="__codelineno-84-26" name="__codelineno-84-26" href="#__codelineno-84-26"></a><span class="go">                      nginx.ingress.kubernetes.io/whitelist-source-range: 10.244.0.0/16</span>
</span><span id="__span-84-27"><a id="__codelineno-84-27" name="__codelineno-84-27" href="#__codelineno-84-27"></a><span class="go">Events:</span>
</span><span id="__span-84-28"><a id="__codelineno-84-28" name="__codelineno-84-28" href="#__codelineno-84-28"></a><span class="go">  Type    Reason             Age                 From                       Message</span>
</span><span id="__span-84-29"><a id="__codelineno-84-29" name="__codelineno-84-29" href="#__codelineno-84-29"></a><span class="go">  ----    ------             ----                ----                       -------</span>
</span><span id="__span-84-30"><a id="__codelineno-84-30" name="__codelineno-84-30" href="#__codelineno-84-30"></a><span class="go">  Normal  Sync               16s (x6 over 123m)  nginx-ingress-controller   Scheduled for sync</span>
</span><span id="__span-84-31"><a id="__codelineno-84-31" name="__codelineno-84-31" href="#__codelineno-84-31"></a><span class="go">  Normal  CreateCertificate  16s                 cert-manager-ingress-shim  Successfully created Certificate &quot;tls-secret&quot;</span>
</span><span id="__span-84-32"><a id="__codelineno-84-32" name="__codelineno-84-32" href="#__codelineno-84-32"></a>
</span><span id="__span-84-33"><a id="__codelineno-84-33" name="__codelineno-84-33" href="#__codelineno-84-33"></a><span class="gp">$ </span>kubectl<span class="w"> </span>get<span class="w"> </span>all<span class="w"> </span>-A<span class="w"> </span>-o<span class="w"> </span>wide<span class="w"> </span><span class="p">|</span><span class="w"> </span>egrep<span class="w"> </span><span class="m">10</span>.244.0.82
</span><span id="__span-84-34"><a id="__codelineno-84-34" name="__codelineno-84-34" href="#__codelineno-84-34"></a><span class="go">kubernetes-dashboard   pod/kubernetes-dashboard-6c7ccbcf87-vwxnt       1/1     Running     1 (4d13h ago)    13d     10.244.0.82    lexicon   &lt;none&gt;           &lt;none&gt;</span>
</span></code></pre></div>
<p>This does not yet work 100%:
- <a href="https://ssl.uu.am:32000/#/workloads?namespace=_all">ssl.uu.am:32000</a> works,
  port 32000 is forwarded to the correct <code>NodePort</code>
- <a href="https://k8s.uu.am/">k8s.uu.am</a> redirects there,
  with an HTTP redirect rule
- <a href="https://k8s.ssl.uu.am/#/workloads?namespace=_all">k8s.ssl.uu.am/</a>
  doesn’t work (HTTP ERROR 400)
- <code>k8s.ssl.uu.am</code> resolves to external IP, where port
   443 is forwarded to the
   <a href="#metallb-load-balancer">MetalLB</a> IP 192.168.0.122
   for <code>ingress-nginx-controller</code>.</p>
<p>Looking at the logs of the Nginx controller, it looks
like a problem with/in the Cluster internal network:</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-85-1"><a id="__codelineno-85-1" name="__codelineno-85-1" href="#__codelineno-85-1"></a><span class="gp">$ </span>kubectl<span class="w"> </span>-n<span class="w"> </span>ingress-nginx<span class="w"> </span>logs<span class="w"> </span>ingress-nginx-controller-6b58ffdc97-rt5lm<span class="w"> </span><span class="p">|</span><span class="w"> </span>tail<span class="w"> </span>-2
</span><span id="__span-85-2"><a id="__codelineno-85-2" name="__codelineno-85-2" href="#__codelineno-85-2"></a><span class="go">2023/04/16 17:26:40 [error] 4790#4790: *6371572 recv() failed (104: Connection reset by peer) while reading upstream, client: 10.244.0.1, server: k8s.ssl.uu.am, request: &quot;GET / HTTP/2.0&quot;, upstream: &quot;http://10.244.0.82:8443/&quot;, host: &quot;k8s.ssl.uu.am&quot;, referrer: &quot;https://www.google.com/&quot;</span>
</span><span id="__span-85-3"><a id="__codelineno-85-3" name="__codelineno-85-3" href="#__codelineno-85-3"></a><span class="go">10.244.0.1 - - [16/Apr/2023:17:26:40 +0000] &quot;GET / HTTP/2.0&quot; 400 48 &quot;https://www.google.com/&quot; &quot;Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/112.0.0.0 Safari/537.36&quot; 465 0.002 [kubernetes-dashboard-kubernetes-dashboard-443] [] 10.244.0.82:8443 48 0.002 400 c2e45b0dee94255bb284054654b987a4</span>
</span></code></pre></div>
<p>Tried mapping to port 8443 but still got the same error. The problem was that Nginx was trying to send HTTP requests to an HTTPS endpoint and the solution was to add more annotations in
<code>kubernetes-dashboard-ingress.yaml</code> and re-apply:</p>
<div class="language-yaml highlight"><pre><span></span><code><span id="__span-86-1"><a id="__codelineno-86-1" name="__codelineno-86-1" href="#__codelineno-86-1"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">networking.k8s.io/v1</span>
</span><span id="__span-86-2"><a id="__codelineno-86-2" name="__codelineno-86-2" href="#__codelineno-86-2"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Ingress</span>
</span><span id="__span-86-3"><a id="__codelineno-86-3" name="__codelineno-86-3" href="#__codelineno-86-3"></a><span class="nt">metadata</span><span class="p">:</span>
</span><span id="__span-86-4"><a id="__codelineno-86-4" name="__codelineno-86-4" href="#__codelineno-86-4"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">kubernetes-dashboard-ingress</span>
</span><span id="__span-86-5"><a id="__codelineno-86-5" name="__codelineno-86-5" href="#__codelineno-86-5"></a><span class="w">  </span><span class="nt">annotations</span><span class="p">:</span>
</span><span id="__span-86-6"><a id="__codelineno-86-6" name="__codelineno-86-6" href="#__codelineno-86-6"></a><span class="w">    </span><span class="nt">cert-manager.io/cluster-issuer</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">letsencrypt-prod</span>
</span><span id="__span-86-7"><a id="__codelineno-86-7" name="__codelineno-86-7" href="#__codelineno-86-7"></a><span class="w">    </span><span class="nt">nginx.ingress.kubernetes.io/backend-protocol</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;HTTPS&quot;</span>
</span><span id="__span-86-8"><a id="__codelineno-86-8" name="__codelineno-86-8" href="#__codelineno-86-8"></a><span class="w">    </span><span class="nt">nginx.ingress.kubernetes.io/auth-tls-verify-client</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;false&quot;</span>
</span><span id="__span-86-9"><a id="__codelineno-86-9" name="__codelineno-86-9" href="#__codelineno-86-9"></a><span class="w">    </span><span class="nt">nginx.ingress.kubernetes.io/whitelist-source-range</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;10.244.0.0/16&quot;</span>
</span></code></pre></div>
<p><a href="https://kubernetes.github.io/ingress-nginx/user-guide/nginx-configuration/annotations/#backend-certificate-authentication">These additional annotations</a>
might be necessary later,
but it’s not clear when or why:</p>
<div class="language-yaml highlight"><pre><span></span><code><span id="__span-87-1"><a id="__codelineno-87-1" name="__codelineno-87-1" href="#__codelineno-87-1"></a><span class="w">    </span><span class="nt">nginx.ingress.kubernetes.io/configuration-snippet</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|-</span>
</span><span id="__span-87-2"><a id="__codelineno-87-2" name="__codelineno-87-2" href="#__codelineno-87-2"></a><span class="w">      </span><span class="no">proxy_ssl_server_name on;</span>
</span><span id="__span-87-3"><a id="__codelineno-87-3" name="__codelineno-87-3" href="#__codelineno-87-3"></a><span class="w">      </span><span class="no">proxy_ssl_name $host;</span>
</span></code></pre></div>
<p>In the end, what was missing was the <code>tls</code> section and
after troubleshooting challenges, we got it to work.</p>
<p>Finally, we can have <a href="http://k8s.uu.am">http://k8s.uu.am</a>
redirect to 
<a href="https://k8s.ssl.uu.am/#/workloads?namespace=_all">k8s.ssl.uu.am</a>
which not only works but is also entirely safe! 🙂</p>
<h5 id="monthly-renewal-of-certificates-manual">Monthly renewal of certificates (manual)</h5>
<p>A <a href="#renewal-automated">montly renewal of certificates</a>
is scheduled for Kubernetes deployments, but then again
it will create challenges that can't be fulfilled until
port 80 on the public IP is forwarded to the right
node port, <em>one at a time</em>.</p>
<p>This can be automated by having port 80 on the public
IP permanently forwarded to the host port 80, which is
never listening, and then redirecting that port to the
node port for each <code>acme</code> resolver, one at a time.</p>
<p>To find <strong>all</strong> <code>acme</code> resolvers:</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-88-1"><a id="__codelineno-88-1" name="__codelineno-88-1" href="#__codelineno-88-1"></a><span class="gp">$ </span>kubectl<span class="w"> </span>get<span class="w"> </span>svc<span class="w"> </span>-A<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>acme
</span><span id="__span-88-2"><a id="__codelineno-88-2" name="__codelineno-88-2" href="#__codelineno-88-2"></a><span class="go">code-server              cm-acme-http-solver-8n9ks                               NodePort       10.101.32.112    &lt;none&gt;          8089:32220/TCP                                                                                  3d19h</span>
</span><span id="__span-88-3"><a id="__codelineno-88-3" name="__codelineno-88-3" href="#__codelineno-88-3"></a><span class="go">kubernetes-dashboard     cm-acme-http-solver-b8l2x                               NodePort       10.100.2.141     &lt;none&gt;          8089:32328/TCP</span>
</span></code></pre></div>
<p>In this situation, we'd want to forward port 32220 to
port 80 until the <code>acme</code> resolver listening on that
port is no longer running. Then forward port 32328 to
port 80 until the <code>acme</code> resolver listening on that
port is no longer running. And so on.</p>
<h5 id="monthly-renewal-of-certificates-automated">Monthly renewal of certificates (automated)</h5>
<p>Changing port forwarding on the router is very slow,
so instead we want to
<a href="https://stackoverflow.com/questions/65789509/kubernetes-how-to-change-service-ports-using-patch">change service ports using patch</a>
on those <code>cm-acme-http-solver</code> <em>services</em> to change
their <code>nodePort</code> to one the router is <em>always</em>
redirecting port 80 to.</p>
<p>Once the service is patched, the external connection
reaches the solver pod and the renewal is completed
very shortly, which then deletes the pod and service.</p>
<p>Running this in a crontab daily should do the job:</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-89-1"><a id="__codelineno-89-1" name="__codelineno-89-1" href="#__codelineno-89-1"></a><span class="ch">#!/bin/bash</span>
</span><span id="__span-89-2"><a id="__codelineno-89-2" name="__codelineno-89-2" href="#__codelineno-89-2"></a><span class="c1">#</span>
</span><span id="__span-89-3"><a id="__codelineno-89-3" name="__codelineno-89-3" href="#__codelineno-89-3"></a><span class="c1"># Patch the nodePort of running cert-manager renewal challenge, to listen</span>
</span><span id="__span-89-4"><a id="__codelineno-89-4" name="__codelineno-89-4" href="#__codelineno-89-4"></a><span class="c1"># on port 32080 which is the one the router is forwarding port 80 to.</span>
</span><span id="__span-89-5"><a id="__codelineno-89-5" name="__codelineno-89-5" href="#__codelineno-89-5"></a>
</span><span id="__span-89-6"><a id="__codelineno-89-6" name="__codelineno-89-6" href="#__codelineno-89-6"></a><span class="c1"># Check if there is a LetsEncrypt challenge resolver (acme) running.</span>
</span><span id="__span-89-7"><a id="__codelineno-89-7" name="__codelineno-89-7" href="#__codelineno-89-7"></a><span class="nb">export</span><span class="w"> </span><span class="nv">KUBECONFIG</span><span class="o">=</span>/etc/kubernetes/admin.conf
</span><span id="__span-89-8"><a id="__codelineno-89-8" name="__codelineno-89-8" href="#__codelineno-89-8"></a><span class="nv">nodeport</span><span class="o">=</span><span class="k">$(</span>kubectl<span class="w"> </span>get<span class="w"> </span>svc<span class="w"> </span>-A<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>acme<span class="w"> </span><span class="p">|</span><span class="w"> </span>awk<span class="w"> </span><span class="s1">&#39;{print $6}&#39;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>cut<span class="w"> </span>-f2<span class="w"> </span>-d:<span class="w"> </span><span class="p">|</span><span class="w"> </span>cut<span class="w"> </span>-f1<span class="w"> </span>-d/<span class="w"> </span><span class="p">|</span><span class="w"> </span>head<span class="w"> </span>-1<span class="k">)</span>
</span><span id="__span-89-9"><a id="__codelineno-89-9" name="__codelineno-89-9" href="#__codelineno-89-9"></a><span class="nv">namespace</span><span class="o">=</span><span class="k">$(</span>kubectl<span class="w"> </span>get<span class="w"> </span>svc<span class="w"> </span>-A<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>acme<span class="w"> </span><span class="p">|</span><span class="w"> </span>awk<span class="w"> </span><span class="s1">&#39;{print $1}&#39;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>head<span class="w"> </span>-1<span class="k">)</span>
</span><span id="__span-89-10"><a id="__codelineno-89-10" name="__codelineno-89-10" href="#__codelineno-89-10"></a><span class="nv">service</span><span class="o">=</span><span class="k">$(</span>kubectl<span class="w"> </span>get<span class="w"> </span>svc<span class="w"> </span>-A<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>acme<span class="w"> </span><span class="p">|</span><span class="w"> </span>awk<span class="w"> </span><span class="s1">&#39;{print $2}&#39;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>head<span class="w"> </span>-1<span class="k">)</span>
</span><span id="__span-89-11"><a id="__codelineno-89-11" name="__codelineno-89-11" href="#__codelineno-89-11"></a>
</span><span id="__span-89-12"><a id="__codelineno-89-12" name="__codelineno-89-12" href="#__codelineno-89-12"></a><span class="c1"># Patch the service to listen on port 32080 (set up in router).</span>
</span><span id="__span-89-13"><a id="__codelineno-89-13" name="__codelineno-89-13" href="#__codelineno-89-13"></a><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span>-n<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">namespace</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">]</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">[</span><span class="w"> </span>-n<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">service</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
</span><span id="__span-89-14"><a id="__codelineno-89-14" name="__codelineno-89-14" href="#__codelineno-89-14"></a><span class="w">    </span>kubectl<span class="w"> </span>-n<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">namespace</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span>patch<span class="w"> </span>service<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">service</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span>-p<span class="w"> </span><span class="s1">&#39;{&quot;spec&quot;:{&quot;ports&quot;: [{&quot;port&quot;: 8089, &quot;nodePort&quot;:32080}]}}&#39;</span>
</span><span id="__span-89-15"><a id="__codelineno-89-15" name="__codelineno-89-15" href="#__codelineno-89-15"></a><span class="k">fi</span>
</span></code></pre></div>
<div class="language-console highlight"><pre><span></span><code><span id="__span-90-1"><a id="__codelineno-90-1" name="__codelineno-90-1" href="#__codelineno-90-1"></a><span class="gp"># </span>crontab<span class="w"> </span>-e
</span><span id="__span-90-2"><a id="__codelineno-90-2" name="__codelineno-90-2" href="#__codelineno-90-2"></a><span class="gp"># </span>Hourly<span class="w"> </span>patch<span class="w"> </span>montly<span class="w"> </span>cert<span class="w"> </span>renewal<span class="w"> </span>solvers.
</span><span id="__span-90-3"><a id="__codelineno-90-3" name="__codelineno-90-3" href="#__codelineno-90-3"></a><span class="go">30 * * * * /root/bin/cert-renewal-port-fwd.sh</span>
</span></code></pre></div>







  
  



  


  



<script src="https://giscus.app/client.js"
        data-repo="stibbons1990/hex"
        data-repo-id="R_kgDOKXTsSg"
        data-category="Announcements"
        data-category-id="DIC_kwDOKXTsSs4CqHDX"
        data-mapping="pathname"
        data-strict="0"
        data-reactions-enabled="1"
        data-emit-metadata="1"
        data-input-position="top"
        data-theme="preferred_color_scheme"
        data-lang="en"
        crossorigin="anonymous"
        async>
</script>

      
    </article>
  </div>

          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
    
      
        
      
      <nav class="md-footer__inner md-grid" aria-label="Footer" >
        
          
          <a href="../../../2022/11/12/ubuntu-studio-2204-on-computer-for-a-young-artist.html" class="md-footer__link md-footer__link--prev" aria-label="Previous: Ubuntu Studio 22.04 on Computer, for a young artist">
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
            </div>
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Previous
              </span>
              <div class="md-ellipsis">
                Ubuntu Studio 22.04 on Computer, for a young artist
              </div>
            </div>
          </a>
        
        
          
          <a href="../../05/29/running-visual-studio-code-server-on-kubernetes.html" class="md-footer__link md-footer__link--next" aria-label="Next: Running Visual Studio Code Server on Kubernetes">
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Next
              </span>
              <div class="md-ellipsis">
                Running Visual Studio Code Server on Kubernetes
              </div>
            </div>
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11z"/></svg>
            </div>
          </a>
        
      </nav>
    
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright &copy; 2019-2025 Ponder Stibbons
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "../../../..", "features": ["content.code.copy", "navigation.expand", "navigation.footer", "navigation.top", "search.highlight", "search.suggest"], "search": "../../../../assets/javascripts/workers/search.d50fe291.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../../../assets/javascripts/bundle.50899def.min.js"></script>
      
    
  <script id="init-glightbox">const lightbox = GLightbox({"touchNavigation": true, "loop": false, "zoomable": true, "draggable": true, "openEffect": "zoom", "closeEffect": "zoom", "slideEffect": "slide"});
document$.subscribe(() => { lightbox.reload() });
</script></body>
</html>