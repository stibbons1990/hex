<!DOCTYPE html><html lang="en" class="no-js"><head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://stibbons1990.github.io/hex/blog/2025/02/22/home-assistant-on-kubernetes-on-raspberry-pi-5-alfred/">
      
      
        <link rel="prev" href="../../../01/10/upgrading-single-node-kubernetes-cluster-on-ubuntu-studio-2404-lexicon/">
      
      
        <link rel="next" href="../../../03/08/adopting-firefox-and-bitwarden-as-daily-drivers/">
      
      
        
      
      
      <link rel="icon" href="../../../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.7.1">
    
    
      
        <title>Home Assistant on Kubernetes on Raspberry Pi 5 (Alfred) - Inadvisably Applied Magic</title>
      
    
    
      <link rel="stylesheet" href="../../../../../assets/stylesheets/main.484c7ddc.min.css">
      
        
        <link rel="stylesheet" href="../../../../../assets/stylesheets/palette.ab4e12ef.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&amp;display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../../../../stylesheets/extra.css">
    
    <script>__md_scope=new URL("../../../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      
  


  
  

<script id="__analytics">function __md_analytics(){function e(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],e("js",new Date),e("config","G-Y167L3ZVGY"),document.addEventListener("DOMContentLoaded",(function(){document.forms.search&&document.forms.search.query.addEventListener("blur",(function(){this.value&&e("event","search",{search_term:this.value})}));document$.subscribe((function(){var t=document.forms.feedback;if(void 0!==t)for(var a of t.querySelectorAll("[type=submit]"))a.addEventListener("click",(function(a){a.preventDefault();var n=document.location.pathname,d=this.getAttribute("data-md-value");e("event","feedback",{page:n,data:d}),t.firstElementChild.disabled=!0;var r=t.querySelector(".md-feedback__note [data-md-value='"+d+"']");r&&(r.hidden=!1)})),t.hidden=!1})),location$.subscribe((function(t){e("config","G-Y167L3ZVGY",{page_path:t.pathname})}))}));var t=document.createElement("script");t.async=!0,t.src="https://www.googletagmanager.com/gtag/js?id=G-Y167L3ZVGY",document.getElementById("__analytics").insertAdjacentElement("afterEnd",t)}</script>
  
    <script>"undefined"!=typeof __md_analytics&&__md_analytics()</script>
  

    
    
  <link href="../../../../../assets/stylesheets/glightbox.min.css" rel="stylesheet"><script src="../../../../../assets/javascripts/glightbox.min.js"></script><style id="glightbox-style">
            html.glightbox-open { overflow: initial; height: 100%; }
            .gslide-title { margin-top: 0px; user-select: text; }
            .gslide-desc { color: #666; user-select: text; }
            .gslide-image img { background: white; }
            .gscrollbar-fixer { padding-right: 15px; }
            .gdesc-inner { font-size: 0.75rem; }
            body[data-md-color-scheme="slate"] .gdesc-inner { background: var(--md-default-bg-color); }
            body[data-md-color-scheme="slate"] .gslide-title { color: var(--md-default-fg-color); }
            body[data-md-color-scheme="slate"] .gslide-desc { color: var(--md-default-fg-color); }
        </style></head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="slate" data-md-color-primary="deep-purple" data-md-color-accent="green">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#hardware" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../../../.." title="Inadvisably Applied Magic" class="md-header__button md-logo" aria-label="Inadvisably Applied Magic" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="m64 400 85.7-208.2c17-41.3 47.8-75.3 87.2-96.3l146.9-78.3c12.3-6.6 26.5 4.7 23 18.2l-37.2 142.4c-1.1 4.1-1.6 8.3-1.6 12.6 0 6.3 1.2 12.6 3.6 18.5L448 400H240.9l11.8-35.4 40.4-13.5c6.5-2.2 10.9-8.3 10.9-15.2s-4.4-13-10.9-15.2l-40.4-13.5-13.5-40.4c-2.2-6.4-8.3-10.8-15.2-10.8s-13 4.4-15.2 10.9l-13.5 40.4-40.4 13.5c-6.5 2.2-10.9 8.3-10.9 15.2s4.4 13 10.9 15.2l40.4 13.5 11.8 35.4H64zm215.6-258.5c-1.1-3.3-4.1-5.5-7.6-5.5s-6.5 2.2-7.6 5.5l-6.7 20.2-20.2 6.7c-3.3 1.1-5.5 4.1-5.5 7.6s2.2 6.5 5.5 7.6l20.2 6.7 6.7 20.2c1.1 3.3 4.1 5.5 7.6 5.5s6.5-2.2 7.6-5.5l6.7-20.2 20.2-6.7c3.3-1.1 5.5-4.1 5.5-7.6s-2.2-6.5-5.5-7.6l-20.2-6.7zM32 448h448c17.7 0 32 14.3 32 32s-14.3 32-32 32H32c-17.7 0-32-14.3-32-32s14.3-32 32-32"></path></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"></path></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Inadvisably Applied Magic
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Home Assistant on Kubernetes on Raspberry Pi 5 (Alfred)
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="deep-purple" data-md-color-accent="green" aria-label="Dark mode" type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 7a5 5 0 0 1 5 5 5 5 0 0 1-5 5 5 5 0 0 1-5-5 5 5 0 0 1 5-5m0 2a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3m0-7 2.39 3.42C13.65 5.15 12.84 5 12 5s-1.65.15-2.39.42zM3.34 7l4.16-.35A7.2 7.2 0 0 0 5.94 8.5c-.44.74-.69 1.5-.83 2.29zm.02 10 1.76-3.77a7.131 7.131 0 0 0 2.38 4.14zM20.65 7l-1.77 3.79a7.02 7.02 0 0 0-2.38-4.15zm-.01 10-4.14.36c.59-.51 1.12-1.14 1.54-1.86.42-.73.69-1.5.83-2.29zM12 22l-2.41-3.44c.74.27 1.55.44 2.41.44.82 0 1.63-.17 2.37-.44z"></path></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="deep-purple" data-md-color-accent="green" aria-label="Light mode" type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m17.75 4.09-2.53 1.94.91 3.06-2.63-1.81-2.63 1.81.91-3.06-2.53-1.94L12.44 4l1.06-3 1.06 3zm3.5 6.91-1.64 1.25.59 1.98-1.7-1.17-1.7 1.17.59-1.98L15.75 11l2.06-.05L18.5 9l.69 1.95zm-2.28 4.95c.83-.08 1.72 1.1 1.19 1.85-.32.45-.66.87-1.08 1.27C15.17 23 8.84 23 4.94 19.07c-3.91-3.9-3.91-10.24 0-14.14.4-.4.82-.76 1.27-1.08.75-.53 1.93.36 1.85 1.19-.27 2.86.69 5.83 2.89 8.02a9.96 9.96 0 0 0 8.02 2.89m-1.64 2.02a12.08 12.08 0 0 1-7.8-3.47c-2.17-2.19-3.33-5-3.49-7.82-2.81 3.14-2.7 7.96.31 10.98 3.02 3.01 7.84 3.12 10.98.31"></path></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"></path></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"></path></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"></path></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"></path></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
                
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" hidden>
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../../../.." title="Inadvisably Applied Magic" class="md-nav__button md-logo" aria-label="Inadvisably Applied Magic" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="m64 400 85.7-208.2c17-41.3 47.8-75.3 87.2-96.3l146.9-78.3c12.3-6.6 26.5 4.7 23 18.2l-37.2 142.4c-1.1 4.1-1.6 8.3-1.6 12.6 0 6.3 1.2 12.6 3.6 18.5L448 400H240.9l11.8-35.4 40.4-13.5c6.5-2.2 10.9-8.3 10.9-15.2s-4.4-13-10.9-15.2l-40.4-13.5-13.5-40.4c-2.2-6.4-8.3-10.8-15.2-10.8s-13 4.4-15.2 10.9l-13.5 40.4-40.4 13.5c-6.5 2.2-10.9 8.3-10.9 15.2s4.4 13 10.9 15.2l40.4 13.5 11.8 35.4H64zm215.6-258.5c-1.1-3.3-4.1-5.5-7.6-5.5s-6.5 2.2-7.6 5.5l-6.7 20.2-20.2 6.7c-3.3 1.1-5.5 4.1-5.5 7.6s2.2 6.5 5.5 7.6l20.2 6.7 6.7 20.2c1.1 3.3 4.1 5.5 7.6 5.5s6.5-2.2 7.6-5.5l6.7-20.2 20.2-6.7c3.3-1.1 5.5-4.1 5.5-7.6s-2.2-6.5-5.5-7.6l-20.2-6.7zM32 448h448c17.7 0 32 14.3 32 32s-14.3 32-32 32H32c-17.7 0-32-14.3-32-32s14.3-32 32-32"></path></svg>

    </a>
    Inadvisably Applied Magic
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    About This Place
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_2">
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Projects
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    Projects
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../projects/conmon/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Continuous Monitoring
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../projects/self-hosting/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Self-hosting
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      <a href="../../../../" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Unexpected Linux Adventures
  

    
  </span>
  
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
                
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#hardware" class="md-nav__link">
    <span class="md-ellipsis">
      
        Hardware
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#install-to-nvme-ssd" class="md-nav__link">
    <span class="md-ellipsis">
      
        Install to NVMe SSD
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#system-configuration" class="md-nav__link">
    <span class="md-ellipsis">
      
        System Configuration
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="System Configuration">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#pcie-gen-3" class="md-nav__link">
    <span class="md-ellipsis">
      
        PCIe Gen 3
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#wifi-reconfiguration" class="md-nav__link">
    <span class="md-ellipsis">
      
        WiFi (re)configuration
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="WiFi (re)configuration">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#additional-wifi-networks" class="md-nav__link">
    <span class="md-ellipsis">
      
        Additional WiFi networks
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#retrospective-on-ip-address-assignment" class="md-nav__link">
    <span class="md-ellipsis">
      
        Retrospective on IP address assignment
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#fix-locales" class="md-nav__link">
    <span class="md-ellipsis">
      
        Fix locales
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#disable-swap" class="md-nav__link">
    <span class="md-ellipsis">
      
        Disable swap
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ssh-server" class="md-nav__link">
    <span class="md-ellipsis">
      
        SSH Server
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#disable-power-save-for-wifi" class="md-nav__link">
    <span class="md-ellipsis">
      
        Disable power save for WiFi
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#argon-case-scripts" class="md-nav__link">
    <span class="md-ellipsis">
      
        Argon case scripts
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Argon case scripts">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#failed-argon-installation" class="md-nav__link">
    <span class="md-ellipsis">
      
        Failed Argon installation
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#update-eeprom" class="md-nav__link">
    <span class="md-ellipsis">
      
        Update EEPROM
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#successful-argon-installation" class="md-nav__link">
    <span class="md-ellipsis">
      
        Successful Argon installation
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#essential-software" class="md-nav__link">
    <span class="md-ellipsis">
      
        Essential Software
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Essential Software">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#basic-packages" class="md-nav__link">
    <span class="md-ellipsis">
      
        Basic packages
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#continuous-monitoring" class="md-nav__link">
    <span class="md-ellipsis">
      
        Continuous Monitoring
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#fail2ban" class="md-nav__link">
    <span class="md-ellipsis">
      
        Fail2Ban
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#kubernetes" class="md-nav__link">
    <span class="md-ellipsis">
      
        Kubernetes
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Kubernetes">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#github-repository" class="md-nav__link">
    <span class="md-ellipsis">
      
        GitHub Repository
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#install-kubernetes" class="md-nav__link">
    <span class="md-ellipsis">
      
        Install Kubernetes
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Install Kubernetes">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#enable-the-kubelet-service" class="md-nav__link">
    <span class="md-ellipsis">
      
        Enable the kubelet service
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#install-container-runtime" class="md-nav__link">
    <span class="md-ellipsis">
      
        Install container runtime
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Install container runtime">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#networking-setup" class="md-nav__link">
    <span class="md-ellipsis">
      
        Networking setup
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#install-containerd" class="md-nav__link">
    <span class="md-ellipsis">
      
        Install containerd
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Install containerd">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#configure-containerd-for-kubernetes" class="md-nav__link">
    <span class="md-ellipsis">
      
        Configure containerd for Kubernetes
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bootstrap-with-kubeadm" class="md-nav__link">
    <span class="md-ellipsis">
      
        Bootstrap with kubeadm
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Bootstrap with kubeadm">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#initialize-control-plane" class="md-nav__link">
    <span class="md-ellipsis">
      
        Initialize control-plane
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Initialize control-plane">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#troubleshooting-bootstrap" class="md-nav__link">
    <span class="md-ellipsis">
      
        Troubleshooting Bootstrap
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#setup-kubectl-access" class="md-nav__link">
    <span class="md-ellipsis">
      
        Setup kubectl access
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#network-plugin" class="md-nav__link">
    <span class="md-ellipsis">
      
        Network plugin
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Network plugin">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#troubleshooting-flannel" class="md-nav__link">
    <span class="md-ellipsis">
      
        Troubleshooting Flannel
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#enable-single-node-cluster" class="md-nav__link">
    <span class="md-ellipsis">
      
        Enable single-node cluster
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Enable single-node cluster">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#test-pod-scheduling" class="md-nav__link">
    <span class="md-ellipsis">
      
        Test pod scheduling
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#metallb-load-balancer" class="md-nav__link">
    <span class="md-ellipsis">
      
        MetalLB Load Balancer
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="MetalLB Load Balancer">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#2026-upgrade-to-helm-chart" class="md-nav__link">
    <span class="md-ellipsis">
      
        2026 Upgrade to Helm chart
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#kubernetes-dashboard" class="md-nav__link">
    <span class="md-ellipsis">
      
        Kubernetes Dashboard
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Kubernetes Dashboard">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#troubleshooting-dashboard" class="md-nav__link">
    <span class="md-ellipsis">
      
        Troubleshooting Dashboard
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Troubleshooting Dashboard">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#custom-helm-values" class="md-nav__link">
    <span class="md-ellipsis">
      
        Custom Helm Values
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#alternatives-considered" class="md-nav__link">
    <span class="md-ellipsis">
      
        Alternatives considered
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#new-in-2026-headlamp" class="md-nav__link">
    <span class="md-ellipsis">
      
        New in 2026: Headlamp
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="New in 2026: Headlamp">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#token-bypass" class="md-nav__link">
    <span class="md-ellipsis">
      
        Token bypass
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ingress-controller" class="md-nav__link">
    <span class="md-ellipsis">
      
        Ingress Controller
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Ingress Controller">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#troubleshooting-ingress" class="md-nav__link">
    <span class="md-ellipsis">
      
        Troubleshooting Ingress
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#fix-metallb-speaker" class="md-nav__link">
    <span class="md-ellipsis">
      
        Fix MetalLB Speaker
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Fix MetalLB Speaker">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#remove-node-label-nodekubernetesioexclude-from-external-load-balancers" class="md-nav__link">
    <span class="md-ellipsis">
      
        Remove node label node.kubernetes.io/exclude-from-external-load-balancers
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#make-metallb-circumvent-the-node-label" class="md-nav__link">
    <span class="md-ellipsis">
      
        Make MetalLB circumvent the node label
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#allow-snippet-directives" class="md-nav__link">
    <span class="md-ellipsis">
      
        Allow snippet directives
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#kubernetes-dashboard-ingress" class="md-nav__link">
    <span class="md-ellipsis">
      
        Kubernetes Dashboard Ingress
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#more-flannel-troubleshooting" class="md-nav__link">
    <span class="md-ellipsis">
      
        More Flannel Troubleshooting
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#https-certificates" class="md-nav__link">
    <span class="md-ellipsis">
      
        HTTPS certificates
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="HTTPS certificates">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#install-cert-manager" class="md-nav__link">
    <span class="md-ellipsis">
      
        Install cert-manager
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#test-cert-manager" class="md-nav__link">
    <span class="md-ellipsis">
      
        Test cert-manager
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#configure-lets-encrypt" class="md-nav__link">
    <span class="md-ellipsis">
      
        Configure Let's Encrypt
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#secure-kubernetes-dashboard-ingress" class="md-nav__link">
    <span class="md-ellipsis">
      
        Secure Kubernetes Dashboard Ingress
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#automatic-renovation" class="md-nav__link">
    <span class="md-ellipsis">
      
        Automatic renovation
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cloudflare-tunnel" class="md-nav__link">
    <span class="md-ellipsis">
      
        Cloudflare Tunnel
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Cloudflare Tunnel">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#install-cloudflared" class="md-nav__link">
    <span class="md-ellipsis">
      
        Install cloudflared
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#create-a-tunnel" class="md-nav__link">
    <span class="md-ellipsis">
      
        Create a tunnel
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Create a tunnel">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#public-hostnames" class="md-nav__link">
    <span class="md-ellipsis">
      
        Public hostnames
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#troubleshooting-public-hostnames" class="md-nav__link">
    <span class="md-ellipsis">
      
        Troubleshooting public hostnames
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#lets-encrypt-via-tunnel" class="md-nav__link">
    <span class="md-ellipsis">
      
        Let's Encrypt via tunnel
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tailscale" class="md-nav__link">
    <span class="md-ellipsis">
      
        Tailscale
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#influxdb-and-grafana" class="md-nav__link">
    <span class="md-ellipsis">
      
        InfluxDB and Grafana
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="InfluxDB and Grafana">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#secure-influxdb" class="md-nav__link">
    <span class="md-ellipsis">
      
        Secure InfluxDB
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#grafana-dashboards" class="md-nav__link">
    <span class="md-ellipsis">
      
        Grafana Dashboards
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#home-assistant" class="md-nav__link">
    <span class="md-ellipsis">
      
        Home Assistant
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Home Assistant">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#base-deployment" class="md-nav__link">
    <span class="md-ellipsis">
      
        Base deployment
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Base deployment">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#caveat-on-reverse-proxies" class="md-nav__link">
    <span class="md-ellipsis">
      
        Caveat on reverse proxies
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#base-deployment-manifests" class="md-nav__link">
    <span class="md-ellipsis">
      
        Base deployment manifests
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#kustomized-deployment" class="md-nav__link">
    <span class="md-ellipsis">
      
        Kustomized deployment
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#prepare-remote-access" class="md-nav__link">
    <span class="md-ellipsis">
      
        Prepare remote access
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Prepare remote access">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#cloudflare" class="md-nav__link">
    <span class="md-ellipsis">
      
        Cloudflare
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tailscale_1" class="md-nav__link">
    <span class="md-ellipsis">
      
        Tailscale
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#deployment-start" class="md-nav__link">
    <span class="md-ellipsis">
      
        Deployment Start
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Deployment Start">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#deployment-in-lexicon" class="md-nav__link">
    <span class="md-ellipsis">
      
        Deployment in lexicon
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bluetooth-failed-setup" class="md-nav__link">
    <span class="md-ellipsis">
      
        Bluetooth failed setup
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#protect-critical-plugs" class="md-nav__link">
    <span class="md-ellipsis">
      
        Protect critical plugs
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#home-assistant-community-store" class="md-nav__link">
    <span class="md-ellipsis">
      
        Home Assistant Community Store
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Home Assistant Community Store">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#how-to-add-cards" class="md-nav__link">
    <span class="md-ellipsis">
      
        How to add cards
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#real-time-power-monitoring" class="md-nav__link">
    <span class="md-ellipsis">
      
        Real-time power monitoring
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Real-time power monitoring">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ha-tdv-bar" class="md-nav__link">
    <span class="md-ellipsis">
      
        ha-tdv-bar
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#mini-graph-card" class="md-nav__link">
    <span class="md-ellipsis">
      
        Mini Graph Card
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#multiple-cards-combined" class="md-nav__link">
    <span class="md-ellipsis">
      
        Multiple cards combined
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#a-better-bar-card" class="md-nav__link">
    <span class="md-ellipsis">
      
        A better bar card
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#influxdb" class="md-nav__link">
    <span class="md-ellipsis">
      
        InfluxDB
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#persist-configuration-in-configmap" class="md-nav__link">
    <span class="md-ellipsis">
      
        Persist configuration in ConfigMap
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#audiobookshelf" class="md-nav__link">
    <span class="md-ellipsis">
      
        Audiobookshelf
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Audiobookshelf">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#audiobookshelf-sync-scripts" class="md-nav__link">
    <span class="md-ellipsis">
      
        Audiobookshelf sync scripts
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#navidrome" class="md-nav__link">
    <span class="md-ellipsis">
      
        Navidrome
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#conclusion" class="md-nav__link">
    <span class="md-ellipsis">
      
        Conclusion
      
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
  <div class="md-content md-content--post" data-md-component="content">
    <div class="md-sidebar md-sidebar--post" data-md-component="sidebar" data-md-type="navigation">
      <div class="md-sidebar__scrollwrap">
        <div class="md-sidebar__inner md-post">
          <nav class="md-nav md-nav--primary">
            <div class="md-post__back">
              <div class="md-nav__title md-nav__container">
                <a href="../../../../" class="md-nav__link">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"></path></svg>
                  <span class="md-ellipsis">
                    Back to index
                  </span>
                </a>
              </div>
            </div>
            
            <ul class="md-post__meta md-nav__list">
              <li class="md-nav__item md-nav__item--section">
                <div class="md-post__title">
                  <span class="md-ellipsis">
                    Metadata
                  </span>
                </div>
                <nav class="md-nav">
                  <ul class="md-nav__list">
                    <li class="md-nav__item">
                      <div class="md-nav__link">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 19H5V8h14m-3-7v2H8V1H6v2H5c-1.11 0-2 .89-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V5a2 2 0 0 0-2-2h-1V1m-1 11h-5v5h5z"></path></svg>
                        <time datetime="2025-02-22 00:00:00+00:00" class="md-ellipsis">February 22, 2025</time>
                      </div>
                    </li>
                    
                    
                      <li class="md-nav__item">
                        <div class="md-nav__link">
                          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9 3v15h3V3zm3 2 4 13 3-1-4-13zM5 5v13h3V5zM3 19v2h18v-2z"></path></svg>
                          <span class="md-ellipsis">
                            in
                            
                              <a href="../../../../category/home-assistant/">home assistant</a>, 
                              <a href="../../../../category/kubernetes/">kubernetes</a>, 
                              <a href="../../../../category/linux/">linux</a>, 
                              <a href="../../../../category/raspberrypi/">raspberrypi</a>, 
                              <a href="../../../../category/server/">Server</a></span>
                        </div>
                      </li>
                    
                    
                      
                      <li class="md-nav__item">
                        <div class="md-nav__link">
                          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 20a8 8 0 0 0 8-8 8 8 0 0 0-8-8 8 8 0 0 0-8 8 8 8 0 0 0 8 8m0-18a10 10 0 0 1 10 10 10 10 0 0 1-10 10C6.47 22 2 17.5 2 12A10 10 0 0 1 12 2m.5 5v5.25l4.5 2.67-.75 1.23L11 13V7z"></path></svg>
                          <span class="md-ellipsis">
                            
                              128 min read
                            
                          </span>
                        </div>
                      </li>
                    
                  </ul>
                </nav>
              </li>
            </ul>
            
          </nav>
          
        </div>
      </div>
    </div>
    <article class="md-content__inner md-typeset">
      
        
  




  <h1>Home Assistant on Kubernetes on Raspberry Pi 5 (Alfred)</h1>

<p>That old house with aging electrical wiring, where last winter we needed
<a href="../../../../2024/12/28/continuous-monitoring-for-tp-link-tapo-devices/">Continuous Monitoring for TP-Link Tapo devices</a>
to keep power consumption in check at all times, could do with a more versatile
and capable setup, to at least partially automate the juggling involved in
keeping power consumption within the contracted capacity.</p>
<p><a href="https://www.home-assistant.io/">Home Assistant</a> should be a good way to scale
this up, but what that old house needs in the first place is a 24x7 system, so
here we go again to setup a brand new Raspberry Pi... enter <strong>Alfred</strong>, the new
housekeeper.</p>
<!-- more -->

<h2 id="hardware">Hardware</h2>
<p>Although it may be overkill for the initial few purposes, the hardware chosen
for this system is a rather generous setup to leave plenty of room for growth:</p>
<ul>
<li><a href="https://www.raspberrypi.com/products/raspberry-pi-5/">Raspberry Pi 5 8GB</a></li>
<li><a href="https://www.samsung.com/de/memory-storage/nvme-ssd/970-evo-plus-nvme-m-2-ssd-2tb-mz-v7s2t0bw/">Samsung 970 EVO Plus (2000 GB, M.2 2280)</a></li>
<li><a href="https://argon40.com/products/argon-one-v3-m-2-nvme-case">Argon ONE V3 M.2 NVME Raspberry Pi 5 Case</a></li>
</ul>
<p>This Argon ONE case is a bit tricky to assemble, it pays to follow the
instructions carefully and make sure the PCIe cable is connected the right way
and fully connected.</p>
<details class="terminal">
<summary>How this NVMe enclosure shows up in <code>dmesg</code>.</summary>
<div class="language-dmesg highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="m">[103602.068970] </span><span class="k">sd 10:</span>0:0:0: [sdf] tag#11 uas_zap_pending 0 uas-tag 1 inflight: CMD 
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a><span class="m">[103602.068975] </span><span class="k">sd 10:</span>0:0:0: [sdf] tag#11 CDB: Test Unit Ready 00 00 00 00 00 00
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a><span class="m">[103602.069000] </span><span class="k">sd 10:</span><span class="gr">0:0:0: [sdf] Test Unit Ready failed: Result: hostbyte=DID_NO_CONNECT driverbyte=DRIVER_OK</span>
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a><span class="m">[103602.069013] </span><span class="k">sd 10:</span><span class="gr">0:0:0: [sdf] Read Capacity(16) failed: Result: hostbyte=DID_ERROR driverbyte=DRIVER_OK</span>
</span><span id="__span-0-5"><a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a><span class="m">[103602.069015] </span><span class="k">sd 10:</span>0:0:0: [sdf] Sense not available.
</span><span id="__span-0-6"><a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a><span class="m">[103602.069022] </span><span class="k">sd 10:</span><span class="gr">0:0:0: [sdf] Read Capacity(10) failed: Result: hostbyte=DID_ERROR driverbyte=DRIVER_OK</span>
</span><span id="__span-0-7"><a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a><span class="m">[103602.069024] </span><span class="k">sd 10:</span>0:0:0: [sdf] Sense not available.
</span><span id="__span-0-8"><a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a><span class="m">[103602.069029] </span><span class="k">sd 10:</span>0:0:0: [sdf] 0 512-byte logical blocks: (0 B/0 B)
</span><span id="__span-0-9"><a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a><span class="m">[103602.069032] </span><span class="k">sd 10:</span>0:0:0: [sdf] 0-byte physical blocks
</span><span id="__span-0-10"><a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a><span class="m">[103602.069035] </span><span class="k">sd 10:</span>0:0:0: [sdf] Write Protect is off
</span><span id="__span-0-11"><a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a><span class="m">[103602.069038] </span><span class="k">sd 10:</span>0:0:0: [sdf] Mode Sense: 00 00 00 00
</span><span id="__span-0-12"><a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a><span class="m">[103602.069042] </span><span class="k">sd 10:</span><span class="gr">0:0:0: [sdf] Asking for cache data failed</span>
</span><span id="__span-0-13"><a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a><span class="m">[103602.069046] </span><span class="k">sd 10:</span>0:0:0: [sdf] Assuming drive cache: write through
</span><span id="__span-0-14"><a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a><span class="m">[103602.069049] </span><span class="k">sd 10:</span>0:0:0: [sdf] Preferred minimum I/O size 4096 bytes not a multiple of physical block size (0 bytes)
</span><span id="__span-0-15"><a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a><span class="m">[103602.069052] </span><span class="k">sd 10:</span>0:0:0: [sdf] Optimal transfer size 33553920 bytes not a multiple of physical block size (0 bytes)
</span><span id="__span-0-16"><a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a><span class="m">[103602.069483] </span><span class="k">sd 10:</span>0:0:0: [sdf] Attached SCSI disk
</span><span id="__span-0-17"><a id="__codelineno-0-17" name="__codelineno-0-17" href="#__codelineno-0-17"></a><span class="m">[103603.389453] </span><span class="k">usb 4-1:</span> new SuperSpeed USB device number 3 using xhci_hcd
</span><span id="__span-0-18"><a id="__codelineno-0-18" name="__codelineno-0-18" href="#__codelineno-0-18"></a><span class="m">[103603.402010] </span><span class="k">usb 4-1:</span> New USB device found, idVendor=152d, idProduct=0583, bcdDevice=31.08
</span><span id="__span-0-19"><a id="__codelineno-0-19" name="__codelineno-0-19" href="#__codelineno-0-19"></a><span class="m">[103603.402017] </span><span class="k">usb 4-1:</span> New USB device strings: Mfr=1, Product=2, SerialNumber=3
</span><span id="__span-0-20"><a id="__codelineno-0-20" name="__codelineno-0-20" href="#__codelineno-0-20"></a><span class="m">[103603.402019] </span><span class="k">usb 4-1:</span> Product: USB Storage Device
</span><span id="__span-0-21"><a id="__codelineno-0-21" name="__codelineno-0-21" href="#__codelineno-0-21"></a><span class="m">[103603.402021] </span><span class="k">usb 4-1:</span> Manufacturer: JMicron
</span><span id="__span-0-22"><a id="__codelineno-0-22" name="__codelineno-0-22" href="#__codelineno-0-22"></a><span class="m">[103603.402023] </span><span class="k">usb 4-1:</span> SerialNumber: DD564198838E3
</span><span id="__span-0-23"><a id="__codelineno-0-23" name="__codelineno-0-23" href="#__codelineno-0-23"></a><span class="m">[103603.403724] </span><span class="k">scsi host10:</span> uas
</span><span id="__span-0-24"><a id="__codelineno-0-24" name="__codelineno-0-24" href="#__codelineno-0-24"></a><span class="m">[103603.404249] </span><span class="k">scsi 10:</span>0:0:0: Direct-Access     Samsung  SSD 970 EVO      3108 PQ: 0 ANSI: 6
</span><span id="__span-0-25"><a id="__codelineno-0-25" name="__codelineno-0-25" href="#__codelineno-0-25"></a><span class="m">[103603.406054] </span><span class="k">sd 10:</span>0:0:0: Attached scsi generic sg5 type 0
</span><span id="__span-0-26"><a id="__codelineno-0-26" name="__codelineno-0-26" href="#__codelineno-0-26"></a><span class="m">[103603.406383] </span><span class="k">sd 10:</span>0:0:0: [sdf] 3907029168 512-byte logical blocks: (2.00 TB/1.82 TiB)
</span><span id="__span-0-27"><a id="__codelineno-0-27" name="__codelineno-0-27" href="#__codelineno-0-27"></a><span class="m">[103603.406386] </span><span class="k">sd 10:</span>0:0:0: [sdf] 4096-byte physical blocks
</span><span id="__span-0-28"><a id="__codelineno-0-28" name="__codelineno-0-28" href="#__codelineno-0-28"></a><span class="m">[103603.406504] </span><span class="k">sd 10:</span>0:0:0: [sdf] Write Protect is off
</span><span id="__span-0-29"><a id="__codelineno-0-29" name="__codelineno-0-29" href="#__codelineno-0-29"></a><span class="m">[103603.406507] </span><span class="k">sd 10:</span>0:0:0: [sdf] Mode Sense: 5f 00 00 08
</span><span id="__span-0-30"><a id="__codelineno-0-30" name="__codelineno-0-30" href="#__codelineno-0-30"></a><span class="m">[103603.406703] </span><span class="k">sd 10:</span>0:0:0: [sdf] Write cache: enabled, read cache: enabled, doesn't support DPO or FUA
</span><span id="__span-0-31"><a id="__codelineno-0-31" name="__codelineno-0-31" href="#__codelineno-0-31"></a><span class="m">[103603.406706] </span><span class="k">sd 10:</span>0:0:0: [sdf] Preferred minimum I/O size 4096 bytes
</span><span id="__span-0-32"><a id="__codelineno-0-32" name="__codelineno-0-32" href="#__codelineno-0-32"></a><span class="m">[103603.406708] </span><span class="k">sd 10:</span>0:0:0: [sdf] Optimal transfer size 33553920 bytes not a multiple of preferred minimum block size (4096 bytes)
</span><span id="__span-0-33"><a id="__codelineno-0-33" name="__codelineno-0-33" href="#__codelineno-0-33"></a><span class="m">[103603.410179] </span><span class="k"> sdf:</span> sdf1 sdf2 sdf3 sdf4 sdf5 sdf6
</span><span id="__span-0-34"><a id="__codelineno-0-34" name="__codelineno-0-34" href="#__codelineno-0-34"></a><span class="m">[103603.410501] </span><span class="k">sd 10:</span>0:0:0: [sdf] Attached SCSI disk
</span></code></pre></div>
</details>
<h2 id="install-to-nvme-ssd">Install to NVMe SSD</h2>
<p>To install Raspberry Pi Os directly on the NVMe drive, it goes first into an
<a href="https://icybox.de/product/externe_speicherloesungen/IB-1817M-C31">ICY BOX IB-1817M-C31 USB 3.1 NVMe enclosure</a>
to then use <code>rpi-imager</code> to install the latest 64-bit Raspberry Pi Os Lite on
it. This will replace original partitions with just two (<code>bootfs</code>, <code>rootfs</code>):</p>
<div class="language-dmesg highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a><span class="m">[104897.486810] </span><span class="k"> sdf:</span> sdf1 sdf2
</span></code></pre></div>
<div class="language-console highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a><span class="gp"># </span>parted<span class="w"> </span>/dev/sdf<span class="w"> </span>print
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a><span class="go">Model: Samsung SSD 970 EVO (scsi)</span>
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a><span class="go">Disk /dev/sdf: 2000GB</span>
</span><span id="__span-2-4"><a id="__codelineno-2-4" name="__codelineno-2-4" href="#__codelineno-2-4"></a><span class="go">Sector size (logical/physical): 512B/4096B</span>
</span><span id="__span-2-5"><a id="__codelineno-2-5" name="__codelineno-2-5" href="#__codelineno-2-5"></a><span class="go">Partition Table: msdos</span>
</span><span id="__span-2-6"><a id="__codelineno-2-6" name="__codelineno-2-6" href="#__codelineno-2-6"></a><span class="go">Disk Flags: </span>
</span><span id="__span-2-7"><a id="__codelineno-2-7" name="__codelineno-2-7" href="#__codelineno-2-7"></a>
</span><span id="__span-2-8"><a id="__codelineno-2-8" name="__codelineno-2-8" href="#__codelineno-2-8"></a><span class="go">Number  Start   End     Size    Type     File system  Flags</span>
</span><span id="__span-2-9"><a id="__codelineno-2-9" name="__codelineno-2-9" href="#__codelineno-2-9"></a><span class="go"> 1      4194kB  541MB   537MB   primary  fat32        lba</span>
</span><span id="__span-2-10"><a id="__codelineno-2-10" name="__codelineno-2-10" href="#__codelineno-2-10"></a><span class="go"> 2      541MB   2756MB  2215MB  primary  ext4</span>
</span></code></pre></div>
<details class="note">
<summary>GPT would be necessary only if the disk is larger than 2TB.</summary>
<p><a href="https://www.reddit.com/r/raspberry_pi/comments/19e0x42/booting_pi_from_nvme_greater_than_2tb_gpt_as/">Booting Pi from NVME greater than 2TB (GPT as opposed to MBR)</a>
includes manual instructions to install Raspberry Pi OS on a 4TB NVME using
a GPT table. If you image a disk which is larger than 2TB with the
Raspberry Pi tools or images, your disk will be limited to 2TB because they
use MBR (Master Boot Record) instead of GPT (GUID partition table).</p>
</details>
<h2 id="system-configuration">System Configuration</h2>
<h3 id="pcie-gen-3">PCIe Gen 3</h3>
<p><a href="https://www.jeffgeerling.com/blog/2023/nvme-ssd-boot-raspberry-pi-5">NVMe SSD boot with the Raspberry Pi 5</a>, at least with this Argon ONE case, turned out to
be easy. When using a HAT+-compliant NVMe adapter, there is no need to enable
the external PCIe port, it will be enabled automatically, but it is useful to
force PCIe Gen 3 speeds using these options in <code>/boot/firmware/config.txt</code></p>
<div class="language-ini highlight"><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a><span class="k">[all]</span>
</span><span id="__span-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a><span class="na">dtparam</span><span class="o">=</span><span class="s">pciex1</span>
</span><span id="__span-3-3"><a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a><span class="na">dtparam</span><span class="o">=</span><span class="s">pciex1_gen=3</span>
</span></code></pre></div>
<h3 id="wifi-reconfiguration">WiFi (re)configuration</h3>
<p>The system boots just fine on the first try. Somehow the WiFi connection was
not established, but it did work well after setting up by running
<code>raspi-config</code> and going through the menus.</p>
<details class="terminal">
<summary><code>$ ip a</code></summary>
<div class="language-console highlight"><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a><span class="gp">$ </span>ip<span class="w"> </span>a
</span><span id="__span-4-2"><a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a><span class="go">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000</span>
</span><span id="__span-4-3"><a id="__codelineno-4-3" name="__codelineno-4-3" href="#__codelineno-4-3"></a><span class="go">    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span>
</span><span id="__span-4-4"><a id="__codelineno-4-4" name="__codelineno-4-4" href="#__codelineno-4-4"></a><span class="go">    inet 127.0.0.1/8 scope host lo</span>
</span><span id="__span-4-5"><a id="__codelineno-4-5" name="__codelineno-4-5" href="#__codelineno-4-5"></a><span class="go">    valid_lft forever preferred_lft forever</span>
</span><span id="__span-4-6"><a id="__codelineno-4-6" name="__codelineno-4-6" href="#__codelineno-4-6"></a><span class="go">    inet6 ::1/128 scope host noprefixroute </span>
</span><span id="__span-4-7"><a id="__codelineno-4-7" name="__codelineno-4-7" href="#__codelineno-4-7"></a><span class="go">    valid_lft forever preferred_lft forever</span>
</span><span id="__span-4-8"><a id="__codelineno-4-8" name="__codelineno-4-8" href="#__codelineno-4-8"></a><span class="go">2: eth0: &lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt; mtu 1500 qdisc pfifo_fast state DOWN group default qlen 1000</span>
</span><span id="__span-4-9"><a id="__codelineno-4-9" name="__codelineno-4-9" href="#__codelineno-4-9"></a><span class="go">    link/ether 2c:cf:67:83:6f:3b brd ff:ff:ff:ff:ff:ff</span>
</span><span id="__span-4-10"><a id="__codelineno-4-10" name="__codelineno-4-10" href="#__codelineno-4-10"></a><span class="go">3: wlan0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP group default qlen 1000</span>
</span><span id="__span-4-11"><a id="__codelineno-4-11" name="__codelineno-4-11" href="#__codelineno-4-11"></a><span class="go">    link/ether 2c:cf:67:83:6f:3c brd ff:ff:ff:ff:ff:ff</span>
</span><span id="__span-4-12"><a id="__codelineno-4-12" name="__codelineno-4-12" href="#__codelineno-4-12"></a><span class="go">    inet 192.168.0.124/24 brd 192.168.0.255 scope global dynamic noprefixroute wlan0</span>
</span><span id="__span-4-13"><a id="__codelineno-4-13" name="__codelineno-4-13" href="#__codelineno-4-13"></a><span class="go">    valid_lft 85830sec preferred_lft 85830sec</span>
</span><span id="__span-4-14"><a id="__codelineno-4-14" name="__codelineno-4-14" href="#__codelineno-4-14"></a><span class="go">    inet6 fe80::17df:d960:1aa4:36ff/64 scope link noprefixroute </span>
</span><span id="__span-4-15"><a id="__codelineno-4-15" name="__codelineno-4-15" href="#__codelineno-4-15"></a><span class="go">    valid_lft forever preferred_lft forever</span>
</span></code></pre></div>
</details>
<details class="note">
<summary>About IP address conflicts with <code>lexicon</code>.</summary>
<p>Initically the Raspberry Pi had the <code>.122</code> IP address assigned to it, which
caused a conflict with the <code>metallb</code> configuration in the Kubernetes
cluster in <code>lexicon</code>, where this IP had been assigned to the <code>ingress-nginx</code>
service, so as soon as the Raspberry Pi was assigned that IP address,
<strong>all</strong> services behind Nginx became unreachable. The workaround was to
configure the UPC router to assign those IP addresses used by the
<code>ingress-nginx</code> service to made-up MAC addresses, so they won't be assigned
to physical devices.</p>
</details>
<h4 id="additional-wifi-networks">Additional WiFi networks</h4>
<p><a href="https://www.thedigitalpictureframe.com/how-to-add-a-second-wifi-network-to-your-raspberry-pi/">How to add a second WiFi network to your Raspberry Pi (updated for OS Bookworm)</a>
explains how the wpa_supplicant.conf file is no longer used to configure Wi-Fi
connections and, instead, the current Raspberry Pi OS (based on Bookworm) uses
NetworkManager to manage network connections, including Wi-Fi.</p>
<p>There is a separate configuration file for each WiFi connection under
<code>/etc/NetworkManager/system-connections</code>, all it takes to configure additional
WiFi connections is to</p>
<ol>
<li>Copy a working file with a new name (e.g. the SSID name).</li>
<li>Replace the SSID and password.</li>
<li>Replace the <code>id</code> with a new unique value of choice.</li>
<li>Replace the <code>uuid</code> with a new unique value from running <code>uuid</code>.</li>
<li>Set the permissions to <code>600</code></li>
</ol>
<p>This can be done in advance of replacing WiFi access points, etc.</p>
<h4 id="retrospective-on-ip-address-assignment">Retrospective on IP address assignment</h4>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>When setting up a Kubernetes cluster to be relocated to a different LAN,
make sure to assign a <strong>static</strong> IP address that will be available in the
destination LAN. Otherwise, the cluster will become non-operational because
the required certificates are signed for the initial IP address and are not
trivial to replace without losing deployments and data.</p>
</div>
<details class="note">
<summary>Ask me how I know...</summary>
<p>After relocating <code>alfred</code> to a its destination LAN a having a new IP address
assigned from the local DCHP server (ISP router), the <code>kubelet</code> service is no
longer accessible at the old (or new) IP address.</p>
<p>On the old IP address, nothing is listening:</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a><span class="gp">$ </span>kubectl<span class="w"> </span>get<span class="w"> </span>all<span class="w"> </span>-A
</span><span id="__span-5-2"><a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a><span class="go">E0723 20:15:48.259515   23554 memcache.go:265] "Unhandled Error" err="couldn't get current server API group list: Get \"http://localhost:8080/api?timeout=32s\": dial tcp [::1]:8080: connect: connection refused"</span>
</span><span id="__span-5-3"><a id="__codelineno-5-3" name="__codelineno-5-3" href="#__codelineno-5-3"></a><span class="go">E0723 20:15:48.261327   23554 memcache.go:265] "Unhandled Error" err="couldn't get current server API group list: Get \"http://localhost:8080/api?timeout=32s\": dial tcp [::1]:8080: connect: connection refused"</span>
</span><span id="__span-5-4"><a id="__codelineno-5-4" name="__codelineno-5-4" href="#__codelineno-5-4"></a><span class="go">E0723 20:15:48.263000   23554 memcache.go:265] "Unhandled Error" err="couldn't get current server API group list: Get \"http://localhost:8080/api?timeout=32s\": dial tcp [::1]:8080: connect: connection refused"</span>
</span><span id="__span-5-5"><a id="__codelineno-5-5" name="__codelineno-5-5" href="#__codelineno-5-5"></a><span class="go">E0723 20:15:48.264590   23554 memcache.go:265] "Unhandled Error" err="couldn't get current server API group list: Get \"http://localhost:8080/api?timeout=32s\": dial tcp [::1]:8080: connect: connection refused"</span>
</span><span id="__span-5-6"><a id="__codelineno-5-6" name="__codelineno-5-6" href="#__codelineno-5-6"></a><span class="go">E0723 20:15:48.266104   23554 memcache.go:265] "Unhandled Error" err="couldn't get current server API group list: Get \"http://localhost:8080/api?timeout=32s\": dial tcp [::1]:8080: connect: connection refused"</span>
</span><span id="__span-5-7"><a id="__codelineno-5-7" name="__codelineno-5-7" href="#__codelineno-5-7"></a><span class="go">The connection to the server localhost:8080 was refused - did you specify the right host or port?</span>
</span></code></pre></div>
<p>The server is unable to connect to <code>etcd</code> on <code>192.168.0.124:6443</code></p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-6-1"><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a><span class="gp">$ </span>systemctl<span class="w"> </span>status<span class="w"> </span>kubelet.service
</span><span id="__span-6-2"><a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a><span class="go">...</span>
</span><span id="__span-6-3"><a id="__codelineno-6-3" name="__codelineno-6-3" href="#__codelineno-6-3"></a><span class="go">1323 pod_workers.go:1301] "Error syncing pod, skipping" err="failed to \"StartContainer\" for \"kube-apiserver\" with CrashLoopBackOff: \"back-off 5m0s restarting failed container=kube-apiserver pod=kube-apiserver-alfred_kube-system(b254715d65c91745b90&gt;</span>
</span><span id="__span-6-4"><a id="__codelineno-6-4" name="__codelineno-6-4" href="#__codelineno-6-4"></a><span class="go">1323 kubelet.go:3190] "No need to create a mirror pod, since failed to get node info from the cluster" err="node \"alfred\" not found" node="alfred"</span>
</span><span id="__span-6-5"><a id="__codelineno-6-5" name="__codelineno-6-5" href="#__codelineno-6-5"></a><span class="go">1323 scope.go:117] "RemoveContainer" containerID="7a63e157dfff240e6122e2677a690bcfbc25828b9e70b15f3183c0b5bd37b5d4"</span>
</span><span id="__span-6-6"><a id="__codelineno-6-6" name="__codelineno-6-6" href="#__codelineno-6-6"></a><span class="go">1323 pod_workers.go:1301] "Error syncing pod, skipping" err="failed to \"StartContainer\" for \"etcd\" with CrashLoopBackOff: \"back-off 5m0s restarting failed container=etcd pod=etcd-alfred_kube-system(bd8b1f1f7ec248fb91965a18bb2161c3)\"" pod="kube-sy&gt;</span>
</span><span id="__span-6-7"><a id="__codelineno-6-7" name="__codelineno-6-7" href="#__codelineno-6-7"></a><span class="go">1323 controller.go:145] "Failed to ensure lease exists, will retry" err="Get \"https://192.168.0.124:6443/apis/coordination.k8s.io/v1/namespaces/kube-node-lease/leases/alfred?timeout=10s\": dial tcp 192.168.0.124:6443: connect: no route to host" interv&gt;</span>
</span><span id="__span-6-8"><a id="__codelineno-6-8" name="__codelineno-6-8" href="#__codelineno-6-8"></a><span class="go">1323 kubelet_node_status.go:107] "Unable to register node with API server" err="Post \"https://192.168.0.124:6443/api/v1/nodes\": dial tcp 192.168.0.124:6443: connect: no route to host" node="alfred"</span>
</span><span id="__span-6-9"><a id="__codelineno-6-9" name="__codelineno-6-9" href="#__codelineno-6-9"></a><span class="go">1323 event.go:368] "Unable to write event (may retry after sleeping)" err="Patch \"https://192.168.0.124:6443/api/v1/namespaces/default/events/alfred.1854f3b436893b1b\": dial tcp 192.168.0.124:6443: connect: no route to host" event="&amp;Event{ObjectMeta:{&gt;</span>
</span><span id="__span-6-10"><a id="__codelineno-6-10" name="__codelineno-6-10" href="#__codelineno-6-10"></a><span class="go">1323 kubelet.go:3190] "No need to create a mirror pod, since failed to get node info from the cluster" err="node \"alfred\" not found" node="alfred"</span>
</span></code></pre></div>
<p>Because the service is now listening on the new IP address:</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-7-1"><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a><span class="gp">$ </span>netstat<span class="w"> </span>-na<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span><span class="m">6443</span>
</span><span id="__span-7-2"><a id="__codelineno-7-2" name="__codelineno-7-2" href="#__codelineno-7-2"></a><span class="go">tcp        0      1 192.168.0.50:54216      192.168.0.124:6443      SYN_SENT </span>
</span><span id="__span-7-3"><a id="__codelineno-7-3" name="__codelineno-7-3" href="#__codelineno-7-3"></a>
</span><span id="__span-7-4"><a id="__codelineno-7-4" name="__codelineno-7-4" href="#__codelineno-7-4"></a><span class="gp">$ </span>ip<span class="w"> </span>a
</span><span id="__span-7-5"><a id="__codelineno-7-5" name="__codelineno-7-5" href="#__codelineno-7-5"></a><span class="go">...</span>
</span><span id="__span-7-6"><a id="__codelineno-7-6" name="__codelineno-7-6" href="#__codelineno-7-6"></a><span class="go">2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP group default qlen 1000</span>
</span><span id="__span-7-7"><a id="__codelineno-7-7" name="__codelineno-7-7" href="#__codelineno-7-7"></a><span class="go">    link/ether 2c:cf:67:83:6f:3b brd ff:ff:ff:ff:ff:ff</span>
</span><span id="__span-7-8"><a id="__codelineno-7-8" name="__codelineno-7-8" href="#__codelineno-7-8"></a><span class="go">    inet 192.168.0.50/24 brd 192.168.0.255 scope global dynamic noprefixroute eth0</span>
</span><span id="__span-7-9"><a id="__codelineno-7-9" name="__codelineno-7-9" href="#__codelineno-7-9"></a><span class="go">      valid_lft 602389sec preferred_lft 602389sec</span>
</span><span id="__span-7-10"><a id="__codelineno-7-10" name="__codelineno-7-10" href="#__codelineno-7-10"></a><span class="go">    inet6 fe80::5269:183f:fa1a:d1e5/64 scope link noprefixroute </span>
</span><span id="__span-7-11"><a id="__codelineno-7-11" name="__codelineno-7-11" href="#__codelineno-7-11"></a><span class="go">      valid_lft forever preferred_lft forever</span>
</span></code></pre></div>
<p>The old IP address is promptly found in several files that would need to be updated:</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-8-1"><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a>/etc/hosts
</span><span id="__span-8-2"><a id="__codelineno-8-2" name="__codelineno-8-2" href="#__codelineno-8-2"></a>/etc/kubernetes/kubelet.conf
</span><span id="__span-8-3"><a id="__codelineno-8-3" name="__codelineno-8-3" href="#__codelineno-8-3"></a>/etc/kubernetes/admin.conf
</span><span id="__span-8-4"><a id="__codelineno-8-4" name="__codelineno-8-4" href="#__codelineno-8-4"></a>~/.kube/config
</span></code></pre></div>
<p>But there are quite a few more files that would need to be updated
(in multiple lines):</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-9-1"><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a>$ sudo grep -rin 124 /etc/kubernetes/*
</span><span id="__span-9-2"><a id="__codelineno-9-2" name="__codelineno-9-2" href="#__codelineno-9-2"></a>/etc/kubernetes/controller-manager.conf:5:    server: https://192.168.0.124:6443
</span><span id="__span-9-3"><a id="__codelineno-9-3" name="__codelineno-9-3" href="#__codelineno-9-3"></a>/etc/kubernetes/manifests/etcd.yaml:5:    kubeadm.kubernetes.io/etcd.advertise-client-urls: https://192.168.0.124:2379
</span><span id="__span-9-4"><a id="__codelineno-9-4" name="__codelineno-9-4" href="#__codelineno-9-4"></a>/etc/kubernetes/manifests/etcd.yaml:16:    - --advertise-client-urls=https://192.168.0.124:2379
</span><span id="__span-9-5"><a id="__codelineno-9-5" name="__codelineno-9-5" href="#__codelineno-9-5"></a>/etc/kubernetes/manifests/etcd.yaml:22:    - --initial-advertise-peer-urls=https://192.168.0.124:2380
</span><span id="__span-9-6"><a id="__codelineno-9-6" name="__codelineno-9-6" href="#__codelineno-9-6"></a>/etc/kubernetes/manifests/etcd.yaml:23:    - --initial-cluster=alfred=https://192.168.0.124:2380
</span><span id="__span-9-7"><a id="__codelineno-9-7" name="__codelineno-9-7" href="#__codelineno-9-7"></a>/etc/kubernetes/manifests/etcd.yaml:25:    - --listen-client-urls=https://127.0.0.1:2379,https://192.168.0.124:2379
</span><span id="__span-9-8"><a id="__codelineno-9-8" name="__codelineno-9-8" href="#__codelineno-9-8"></a>/etc/kubernetes/manifests/etcd.yaml:27:    - --listen-peer-urls=https://192.168.0.124:2380
</span><span id="__span-9-9"><a id="__codelineno-9-9" name="__codelineno-9-9" href="#__codelineno-9-9"></a>/etc/kubernetes/manifests/kube-apiserver.yaml:5:    kubeadm.kubernetes.io/kube-apiserver.advertise-address.endpoint: 192.168.0.124:6443
</span><span id="__span-9-10"><a id="__codelineno-9-10" name="__codelineno-9-10" href="#__codelineno-9-10"></a>/etc/kubernetes/manifests/kube-apiserver.yaml:16:    - --advertise-address=192.168.0.124
</span><span id="__span-9-11"><a id="__codelineno-9-11" name="__codelineno-9-11" href="#__codelineno-9-11"></a>/etc/kubernetes/manifests/kube-apiserver.yaml:48:        host: 192.168.0.124
</span><span id="__span-9-12"><a id="__codelineno-9-12" name="__codelineno-9-12" href="#__codelineno-9-12"></a>/etc/kubernetes/manifests/kube-apiserver.yaml:59:        host: 192.168.0.124
</span><span id="__span-9-13"><a id="__codelineno-9-13" name="__codelineno-9-13" href="#__codelineno-9-13"></a>/etc/kubernetes/manifests/kube-apiserver.yaml:71:        host: 192.168.0.124
</span><span id="__span-9-14"><a id="__codelineno-9-14" name="__codelineno-9-14" href="#__codelineno-9-14"></a>/etc/kubernetes/scheduler.conf:5:    server: https://192.168.0.124:6443
</span><span id="__span-9-15"><a id="__codelineno-9-15" name="__codelineno-9-15" href="#__codelineno-9-15"></a>/etc/kubernetes/super-admin.conf:5:    server: https://192.168.0.124:6443
</span></code></pre></div>
<p>It would be best if the kubelet service updated all these from a single,
centralized parameter. Based on https://stackoverflow.com/a/68391387,
although <code>/etc/systemd/system/kubelet.service.d/10-kubeadm.conf</code> does not exist,
this should be possible by setting <code>KUBELET_EXTRA_ARGS=--node-ip 192.168.0.50</code>
in <code>/etc/default/kubelet</code> (then reloading and restarting the service):</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-10-1"><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a># systemctl daemon-reload
</span><span id="__span-10-2"><a id="__codelineno-10-2" name="__codelineno-10-2" href="#__codelineno-10-2"></a># systemctl restart kubelet.service
</span><span id="__span-10-3"><a id="__codelineno-10-3" name="__codelineno-10-3" href="#__codelineno-10-3"></a># systemctl status kubelet.service
</span><span id="__span-10-4"><a id="__codelineno-10-4" name="__codelineno-10-4" href="#__codelineno-10-4"></a>142316 reflector.go:569] k8s.io/client-go/informers/factory.go:160: failed to list *v1.Node: Get "https://192.168.0.50:6443/api/v1/nodes?fieldSelector=metadata.name%3Dalfred&amp;limit=500&amp;resourceVersion=0": net/http: TLS handshake timeout
</span><span id="__span-10-5"><a id="__codelineno-10-5" name="__codelineno-10-5" href="#__codelineno-10-5"></a>142316 reflector.go:166] "Unhandled Error" err="k8s.io/client-go/informers/factory.go:160: Failed to watch *v1.Node: failed to list *v1.Node: Get \"https://192.168.0.50:6443/api/v1/nodes?fieldSelector=metadata.name%3Dalfred&amp;limit=500&amp;resourceVersion=0\&gt;
</span></code></pre></div>
<p>Now the issue is that the <strong>TLS handshake</strong> fails, because certificates were created
for the IP address 192.168.0.124 <strong>but not 192.168.0.50</strong>; this has been reported as
<a href="https://github.com/kubernetes/kubeadm/issues/338"><code>kudeamd</code> issue #338: Changing master IP address</a>
<a href="https://github.com/kubernetes/kubeadm/issues/338#issuecomment-1835645768">and the workaround is quite involved</a>.    </p>
<p>So the solution is, for now, to add 124 as a
<a href="https://pimylifeup.com/raspberry-pi-static-ip-address/#static-ip-address-using-network-manager-cli">Static IP Address Using the Network Manager CLI</a>.    </p>
<p>However, 124 is in the middle of the router's DHCP pool and there is no option to assign IPs to MACs,
so just in case add also .5 and perhaps later rebuild the cluster on that address.</p>
</details>
<h3 id="fix-locales">Fix locales</h3>
<p>The above looks like rpi-imager took my PCs locale settings:</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-11-1"><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a><span class="go">-bash: warning: setlocale: LC_ALL: cannot change locale (en_US.UTF-8)</span>
</span></code></pre></div>
<p>The solution is to use <code>raspi-config</code> to generate <code>en_US.UTF-8</code> and set it as the system default.</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-12-1"><a id="__codelineno-12-1" name="__codelineno-12-1" href="#__codelineno-12-1"></a><span class="gp">$ </span>sudo<span class="w"> </span>raspi-config
</span><span id="__span-12-2"><a id="__codelineno-12-2" name="__codelineno-12-2" href="#__codelineno-12-2"></a><span class="go">...</span>
</span><span id="__span-12-3"><a id="__codelineno-12-3" name="__codelineno-12-3" href="#__codelineno-12-3"></a><span class="go">Generating locales (this might take a while)...</span>
</span><span id="__span-12-4"><a id="__codelineno-12-4" name="__codelineno-12-4" href="#__codelineno-12-4"></a><span class="go">  en_GB.UTF-8... done</span>
</span><span id="__span-12-5"><a id="__codelineno-12-5" name="__codelineno-12-5" href="#__codelineno-12-5"></a><span class="go">  en_US.UTF-8... done</span>
</span><span id="__span-12-6"><a id="__codelineno-12-6" name="__codelineno-12-6" href="#__codelineno-12-6"></a><span class="go">Generation complete.</span>
</span></code></pre></div>
<h3 id="disable-swap">Disable swap</h3>
<p>With 8 GB of RAM there should be no reason to need disk swap, never mind that it
would be rather fast in this system.</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-13-1"><a id="__codelineno-13-1" name="__codelineno-13-1" href="#__codelineno-13-1"></a><span class="gp">$ </span>free<span class="w"> </span>-h
</span><span id="__span-13-2"><a id="__codelineno-13-2" name="__codelineno-13-2" href="#__codelineno-13-2"></a><span class="go">               total        used        free      shared  buff/cache   available</span>
</span><span id="__span-13-3"><a id="__codelineno-13-3" name="__codelineno-13-3" href="#__codelineno-13-3"></a><span class="go">Mem:           7.9Gi       205Mi       7.2Gi       5.1Mi       590Mi       7.7Gi</span>
</span><span id="__span-13-4"><a id="__codelineno-13-4" name="__codelineno-13-4" href="#__codelineno-13-4"></a><span class="go">Swap:          511Mi          0B       511Mi</span>
</span><span id="__span-13-5"><a id="__codelineno-13-5" name="__codelineno-13-5" href="#__codelineno-13-5"></a>
</span><span id="__span-13-6"><a id="__codelineno-13-6" name="__codelineno-13-6" href="#__codelineno-13-6"></a><span class="gp">$ </span>sudo<span class="w"> </span>dphys-swapfile<span class="w"> </span>swapoff
</span><span id="__span-13-7"><a id="__codelineno-13-7" name="__codelineno-13-7" href="#__codelineno-13-7"></a><span class="gp">$ </span>sudo<span class="w"> </span>dphys-swapfile<span class="w"> </span>uninstall
</span><span id="__span-13-8"><a id="__codelineno-13-8" name="__codelineno-13-8" href="#__codelineno-13-8"></a><span class="gp">$ </span>sudo<span class="w"> </span>systemctl<span class="w"> </span>disable<span class="w"> </span>dphys-swapfile
</span><span id="__span-13-9"><a id="__codelineno-13-9" name="__codelineno-13-9" href="#__codelineno-13-9"></a><span class="go">Synchronizing state of dphys-swapfile.service with SysV service script with /lib/systemd/systemd-sysv-install.</span>
</span><span id="__span-13-10"><a id="__codelineno-13-10" name="__codelineno-13-10" href="#__codelineno-13-10"></a><span class="go">Executing: /lib/systemd/systemd-sysv-install disable dphys-swapfile</span>
</span><span id="__span-13-11"><a id="__codelineno-13-11" name="__codelineno-13-11" href="#__codelineno-13-11"></a><span class="go">Removed "/etc/systemd/system/multi-user.target.wants/dphys-swapfile.service".</span>
</span><span id="__span-13-12"><a id="__codelineno-13-12" name="__codelineno-13-12" href="#__codelineno-13-12"></a>
</span><span id="__span-13-13"><a id="__codelineno-13-13" name="__codelineno-13-13" href="#__codelineno-13-13"></a><span class="gp">$ </span>free<span class="w"> </span>-h
</span><span id="__span-13-14"><a id="__codelineno-13-14" name="__codelineno-13-14" href="#__codelineno-13-14"></a><span class="go">               total        used        free      shared  buff/cache   available</span>
</span><span id="__span-13-15"><a id="__codelineno-13-15" name="__codelineno-13-15" href="#__codelineno-13-15"></a><span class="go">Mem:           7.9Gi       210Mi       7.2Gi       5.1Mi       591Mi       7.7Gi</span>
</span><span id="__span-13-16"><a id="__codelineno-13-16" name="__codelineno-13-16" href="#__codelineno-13-16"></a><span class="go">Swap:             0B          0B          0</span>
</span></code></pre></div>
<h3 id="ssh-server">SSH Server</h3>
<p>As a general good practice, even if this system won't have its SSH port open to
the Internet, add the relevant public keys to <code>/home/pi/.ssh/authorized_keys</code>
and disable password authentication by setting <code>PasswordAuthentication no</code> in
<code>/etc/ssh/sshd_config</code>.</p>
<h3 id="disable-power-save-for-wifi">Disable power save for WiFi</h3>
<p>Raspberry Pi enables power save on WiFi by default:</p>
<div class="language-dmesg highlight"><pre><span></span><code><span id="__span-14-1"><a id="__codelineno-14-1" name="__codelineno-14-1" href="#__codelineno-14-1"></a><span class="m">[    5.598286] </span><span class="k">brcmfmac:</span> F1 signature read @0x18000000=0x15264345
</span><span id="__span-14-2"><a id="__codelineno-14-2" name="__codelineno-14-2" href="#__codelineno-14-2"></a><span class="m">[    5.600446] </span><span class="k">brcmfmac:</span> brcmf_fw_alloc_request: using brcm/brcmfmac43455-sdio for chip BCM4345/6
</span><span id="__span-14-3"><a id="__codelineno-14-3" name="__codelineno-14-3" href="#__codelineno-14-3"></a><span class="m">[    5.600754] </span><span class="k">usbcore:</span> registered new interface driver brcmfmac
</span><span id="__span-14-4"><a id="__codelineno-14-4" name="__codelineno-14-4" href="#__codelineno-14-4"></a><span class="m">[    5.790052] </span><span class="k">brcmfmac:</span> brcmf_c_process_txcap_blob: no txcap_blob available (err=-2)
</span><span id="__span-14-5"><a id="__codelineno-14-5" name="__codelineno-14-5" href="#__codelineno-14-5"></a><span class="m">[    5.790325] </span><span class="k">brcmfmac:</span> brcmf_c_preinit_dcmds: Firmware: BCM4345/6 wl0: Aug 29 2023 01:47:08 version 7.45.265 (28bca26 CY) FWID 01-b677b91b
</span><span id="__span-14-6"><a id="__codelineno-14-6" name="__codelineno-14-6" href="#__codelineno-14-6"></a><span class="m">[    6.423812] </span><span class="k">brcmfmac:</span> brcmf_cfg80211_set_power_mgmt: power save enabled
</span></code></pre></div>
<p>This can lead to losing connectivity in certain conditions, so disable power
save of WiFi to avoid having to deal with such problems like
<a href="https://forums.raspberrypi.com/viewtopic.php?f=91&amp;t=16054">Reconnect on WiFi drop</a>.</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-15-1"><a id="__codelineno-15-1" name="__codelineno-15-1" href="#__codelineno-15-1"></a><span class="gp">$ </span>sudo<span class="w"> </span>/sbin/iw<span class="w"> </span>dev<span class="w"> </span>wlan0<span class="w"> </span><span class="nb">set</span><span class="w"> </span>power_save<span class="w"> </span>off
</span></code></pre></div>
<div class="language-dmesg highlight"><pre><span></span><code><span id="__span-16-1"><a id="__codelineno-16-1" name="__codelineno-16-1" href="#__codelineno-16-1"></a><span class="m">[ 1767.061929] </span><span class="k">brcmfmac:</span> brcmf_cfg80211_set_power_mgmt: power save disabled
</span></code></pre></div>
<h3 id="argon-case-scripts">Argon case scripts</h3>
<p>The instructions in page 13 of the
<a href="https://www.pi-shop.ch/downloads/dl/file/id/1127/product/3203/manual_argon_one_v3_m_2_nvme.pdf">Argon ONE V3 NVMe case manual</a>
to install the scripts for FAN control seem simple enough:</p>
<p><a class="glightbox" data-type="image" data-width="auto" data-height="auto" href="../../../../media/2025-02-22-home-assistant-on-kubernetes-on-raspberry-pi-5-alfred/argon-one-v3-nvme-manual-p13.png" data-desc-position="bottom"><img alt="Page 13 of Argon ONE V3 NVMe case manual" src="../../../../media/2025-02-22-home-assistant-on-kubernetes-on-raspberry-pi-5-alfred/argon-one-v3-nvme-manual-p13.png" style="height:550px;width:764px"></a></p>
<h4 id="failed-argon-installation">Failed Argon installation</h4>
<p>However, these scripts were problematic for users with this hardware setup
<a href="https://forum.argon40.com/t/argon-one-v3-power-button-and-fan-scripts-issue/2276/32">as of early 2024</a>
and also in this case something didn't go well at first:</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-17-1"><a id="__codelineno-17-1" name="__codelineno-17-1" href="#__codelineno-17-1"></a><span class="gp">$ </span>curl<span class="w"> </span>https://download.argon40.com/argon-eeprom.sh<span class="w"> </span><span class="p">|</span><span class="w"> </span>bash
</span><span id="__span-17-2"><a id="__codelineno-17-2" name="__codelineno-17-2" href="#__codelineno-17-2"></a><span class="go">*************</span>
</span><span id="__span-17-3"><a id="__codelineno-17-3" name="__codelineno-17-3" href="#__codelineno-17-3"></a><span class="go"> Argon Setup  </span>
</span><span id="__span-17-4"><a id="__codelineno-17-4" name="__codelineno-17-4" href="#__codelineno-17-4"></a><span class="go">*************</span>
</span><span id="__span-17-5"><a id="__codelineno-17-5" name="__codelineno-17-5" href="#__codelineno-17-5"></a><span class="go">Hit:1 http://archive.raspberrypi.com/debian bookworm InRelease</span>
</span><span id="__span-17-6"><a id="__codelineno-17-6" name="__codelineno-17-6" href="#__codelineno-17-6"></a><span class="go">Hit:2 http://deb.debian.org/debian bookworm InRelease</span>
</span><span id="__span-17-7"><a id="__codelineno-17-7" name="__codelineno-17-7" href="#__codelineno-17-7"></a><span class="go">Hit:3 http://deb.debian.org/debian-security bookworm-security InRelease</span>
</span><span id="__span-17-8"><a id="__codelineno-17-8" name="__codelineno-17-8" href="#__codelineno-17-8"></a><span class="go">Get:4 http://deb.debian.org/debian bookworm-updates InRelease [55.4 kB]</span>
</span><span id="__span-17-9"><a id="__codelineno-17-9" name="__codelineno-17-9" href="#__codelineno-17-9"></a><span class="go">Fetched 55.4 kB in 1s (101 kB/s)    </span>
</span><span id="__span-17-10"><a id="__codelineno-17-10" name="__codelineno-17-10" href="#__codelineno-17-10"></a><span class="go">Reading package lists... Done</span>
</span><span id="__span-17-11"><a id="__codelineno-17-11" name="__codelineno-17-11" href="#__codelineno-17-11"></a><span class="go">Reading package lists... Done</span>
</span><span id="__span-17-12"><a id="__codelineno-17-12" name="__codelineno-17-12" href="#__codelineno-17-12"></a><span class="go">Building dependency tree... Done</span>
</span><span id="__span-17-13"><a id="__codelineno-17-13" name="__codelineno-17-13" href="#__codelineno-17-13"></a><span class="go">Reading state information... Done</span>
</span><span id="__span-17-14"><a id="__codelineno-17-14" name="__codelineno-17-14" href="#__codelineno-17-14"></a><span class="go">Calculating upgrade... Done</span>
</span><span id="__span-17-15"><a id="__codelineno-17-15" name="__codelineno-17-15" href="#__codelineno-17-15"></a><span class="go">0 upgraded, 0 newly installed, 0 to remove and 0 not upgraded.</span>
</span><span id="__span-17-16"><a id="__codelineno-17-16" name="__codelineno-17-16" href="#__codelineno-17-16"></a><span class="go">*** UPDATE AVAILABLE ***</span>
</span><span id="__span-17-17"><a id="__codelineno-17-17" name="__codelineno-17-17" href="#__codelineno-17-17"></a>
</span><span id="__span-17-18"><a id="__codelineno-17-18" name="__codelineno-17-18" href="#__codelineno-17-18"></a><span class="go">Run "sudo rpi-eeprom-update -a" to install this update now.</span>
</span><span id="__span-17-19"><a id="__codelineno-17-19" name="__codelineno-17-19" href="#__codelineno-17-19"></a>
</span><span id="__span-17-20"><a id="__codelineno-17-20" name="__codelineno-17-20" href="#__codelineno-17-20"></a><span class="go">To configure the bootloader update policy run "sudo raspi-config"</span>
</span><span id="__span-17-21"><a id="__codelineno-17-21" name="__codelineno-17-21" href="#__codelineno-17-21"></a>
</span><span id="__span-17-22"><a id="__codelineno-17-22" name="__codelineno-17-22" href="#__codelineno-17-22"></a><span class="go">BOOTLOADER: update available</span>
</span><span id="__span-17-23"><a id="__codelineno-17-23" name="__codelineno-17-23" href="#__codelineno-17-23"></a><span class="go">   CURRENT: Mon Sep 23 01:02:56 PM UTC 2024 (1727096576)</span>
</span><span id="__span-17-24"><a id="__codelineno-17-24" name="__codelineno-17-24" href="#__codelineno-17-24"></a><span class="go">    LATEST: Wed Feb 12 10:51:52 AM UTC 2025 (1739357512)</span>
</span><span id="__span-17-25"><a id="__codelineno-17-25" name="__codelineno-17-25" href="#__codelineno-17-25"></a><span class="go">   RELEASE: default (/usr/lib/firmware/raspberrypi/bootloader-2712/default)</span>
</span><span id="__span-17-26"><a id="__codelineno-17-26" name="__codelineno-17-26" href="#__codelineno-17-26"></a><span class="go">            Use raspi-config to change the release.</span>
</span><span id="__span-17-27"><a id="__codelineno-17-27" name="__codelineno-17-27" href="#__codelineno-17-27"></a><span class="go">Updating bootloader EEPROM</span>
</span><span id="__span-17-28"><a id="__codelineno-17-28" name="__codelineno-17-28" href="#__codelineno-17-28"></a><span class="go"> image: /usr/lib/firmware/raspberrypi/bootloader-2712/default/pieeprom-2025-02-12.bin</span>
</span><span id="__span-17-29"><a id="__codelineno-17-29" name="__codelineno-17-29" href="#__codelineno-17-29"></a><span class="go">config_src: blconfig device</span>
</span><span id="__span-17-30"><a id="__codelineno-17-30" name="__codelineno-17-30" href="#__codelineno-17-30"></a><span class="go">config: /tmp/tmpgeb40cic/boot.conf</span>
</span><span id="__span-17-31"><a id="__codelineno-17-31" name="__codelineno-17-31" href="#__codelineno-17-31"></a><span class="gp">#</span><span class="c1">###############################################################################</span>
</span><span id="__span-17-32"><a id="__codelineno-17-32" name="__codelineno-17-32" href="#__codelineno-17-32"></a><span class="go">[all]</span>
</span><span id="__span-17-33"><a id="__codelineno-17-33" name="__codelineno-17-33" href="#__codelineno-17-33"></a><span class="go">WAKE_ON_GPIO=0</span>
</span><span id="__span-17-34"><a id="__codelineno-17-34" name="__codelineno-17-34" href="#__codelineno-17-34"></a><span class="go">PCIE_PROBE=1</span>
</span><span id="__span-17-35"><a id="__codelineno-17-35" name="__codelineno-17-35" href="#__codelineno-17-35"></a><span class="go">BOOT_UART=1</span>
</span><span id="__span-17-36"><a id="__codelineno-17-36" name="__codelineno-17-36" href="#__codelineno-17-36"></a><span class="go">POWER_OFF_ON_HALT=1</span>
</span><span id="__span-17-37"><a id="__codelineno-17-37" name="__codelineno-17-37" href="#__codelineno-17-37"></a><span class="go">BOOT_ORDER=0xf416</span>
</span><span id="__span-17-38"><a id="__codelineno-17-38" name="__codelineno-17-38" href="#__codelineno-17-38"></a>
</span><span id="__span-17-39"><a id="__codelineno-17-39" name="__codelineno-17-39" href="#__codelineno-17-39"></a><span class="gp">#</span><span class="c1">###############################################################################</span>
</span><span id="__span-17-40"><a id="__codelineno-17-40" name="__codelineno-17-40" href="#__codelineno-17-40"></a>
</span><span id="__span-17-41"><a id="__codelineno-17-41" name="__codelineno-17-41" href="#__codelineno-17-41"></a><span class="go">*** To cancel this update run 'sudo rpi-eeprom-update -r' ***</span>
</span><span id="__span-17-42"><a id="__codelineno-17-42" name="__codelineno-17-42" href="#__codelineno-17-42"></a>
</span><span id="__span-17-43"><a id="__codelineno-17-43" name="__codelineno-17-43" href="#__codelineno-17-43"></a><span class="go">ERROR: rpi-eeprom-update -d -i -f /tmp/tmpgeb40cic/pieeprom.upd timeout</span>
</span></code></pre></div>
<p>This EEPROM update failure appears to have been discussed absolutely nowhere
on the Internet (what does this timeout mean?), leading to extreme caution
moving forward. The active EEPROM config now seems like a subset of the above:</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-18-1"><a id="__codelineno-18-1" name="__codelineno-18-1" href="#__codelineno-18-1"></a><span class="gp">$ </span>sudo<span class="w"> </span>rpi-eeprom-config<span class="w"> </span>
</span><span id="__span-18-2"><a id="__codelineno-18-2" name="__codelineno-18-2" href="#__codelineno-18-2"></a><span class="go">[all]</span>
</span><span id="__span-18-3"><a id="__codelineno-18-3" name="__codelineno-18-3" href="#__codelineno-18-3"></a><span class="go">BOOT_UART=1</span>
</span><span id="__span-18-4"><a id="__codelineno-18-4" name="__codelineno-18-4" href="#__codelineno-18-4"></a><span class="go">POWER_OFF_ON_HALT=0</span>
</span><span id="__span-18-5"><a id="__codelineno-18-5" name="__codelineno-18-5" href="#__codelineno-18-5"></a><span class="go">BOOT_ORDER=0xf461</span>
</span></code></pre></div>
<p>Since this appears to be the recommendation from the above script output,
lets cancel the pending update for now:</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-19-1"><a id="__codelineno-19-1" name="__codelineno-19-1" href="#__codelineno-19-1"></a><span class="gp">$ </span>sudo<span class="w"> </span>rpi-eeprom-update<span class="w"> </span>-r
</span><span id="__span-19-2"><a id="__codelineno-19-2" name="__codelineno-19-2" href="#__codelineno-19-2"></a><span class="go">Removing temporary files from previous EEPROM update</span>
</span></code></pre></div>
<p>There are a couple of newer versions available, the last one being very
recent:</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-20-1"><a id="__codelineno-20-1" name="__codelineno-20-1" href="#__codelineno-20-1"></a><span class="gp">$ </span>sudo<span class="w"> </span>rpi-eeprom-update<span class="w"> </span>-l
</span><span id="__span-20-2"><a id="__codelineno-20-2" name="__codelineno-20-2" href="#__codelineno-20-2"></a><span class="go">/usr/lib/firmware/raspberrypi/bootloader-2712/default/pieeprom-2025-02-12.bin</span>
</span><span id="__span-20-3"><a id="__codelineno-20-3" name="__codelineno-20-3" href="#__codelineno-20-3"></a><span class="gp">$ </span>ls<span class="w"> </span>-l<span class="w"> </span>/usr/lib/firmware/raspberrypi/bootloader-2712/default/
</span><span id="__span-20-4"><a id="__codelineno-20-4" name="__codelineno-20-4" href="#__codelineno-20-4"></a><span class="go">total 6248</span>
</span><span id="__span-20-5"><a id="__codelineno-20-5" name="__codelineno-20-5" href="#__codelineno-20-5"></a><span class="go">-rw-r--r-- 1 root root 2097152 Feb 18 10:42 pieeprom-2024-11-12.bin</span>
</span><span id="__span-20-6"><a id="__codelineno-20-6" name="__codelineno-20-6" href="#__codelineno-20-6"></a><span class="go">-rw-r--r-- 1 root root 2097152 Feb 18 10:42 pieeprom-2025-01-22.bin</span>
</span><span id="__span-20-7"><a id="__codelineno-20-7" name="__codelineno-20-7" href="#__codelineno-20-7"></a><span class="go">-rw-r--r-- 1 root root 2097152 Feb 18 10:42 pieeprom-2025-02-12.bin</span>
</span><span id="__span-20-8"><a id="__codelineno-20-8" name="__codelineno-20-8" href="#__codelineno-20-8"></a><span class="go">-rw-r--r-- 1 root root  102992 Feb 18 10:42 recovery.bin</span>
</span></code></pre></div>
<h4 id="update-eeprom">Update EEPROM</h4>
<p><a href="https://www.raspberrypi.com/documentation/computers/raspberry-pi.html#raspi-config">Using raspi-config to update the bootloader</a>
and set it to <code>Latest</code> (<strong>without</strong> resetting config) worked just fine.
After the required reboot, the <code>argon-eeprom.sh</code> script also run fine:</p>
<details class="terminal">
<summary><code>curl https://download.argon40.com/argon-eeprom.sh | bash</code></summary>
<div class="language-console highlight"><pre><span></span><code><span id="__span-21-1"><a id="__codelineno-21-1" name="__codelineno-21-1" href="#__codelineno-21-1"></a><span class="gp">$ </span>curl<span class="w"> </span>https://download.argon40.com/argon-eeprom.sh<span class="w"> </span><span class="p">|</span><span class="w"> </span>bash
</span><span id="__span-21-2"><a id="__codelineno-21-2" name="__codelineno-21-2" href="#__codelineno-21-2"></a><span class="go">*************</span>
</span><span id="__span-21-3"><a id="__codelineno-21-3" name="__codelineno-21-3" href="#__codelineno-21-3"></a><span class="go">Argon Setup  </span>
</span><span id="__span-21-4"><a id="__codelineno-21-4" name="__codelineno-21-4" href="#__codelineno-21-4"></a><span class="go">*************</span>
</span><span id="__span-21-5"><a id="__codelineno-21-5" name="__codelineno-21-5" href="#__codelineno-21-5"></a><span class="go">Hit:1 http://deb.debian.org/debian bookworm InRelease</span>
</span><span id="__span-21-6"><a id="__codelineno-21-6" name="__codelineno-21-6" href="#__codelineno-21-6"></a><span class="go">Hit:2 http://archive.raspberrypi.com/debian bookworm InRelease</span>
</span><span id="__span-21-7"><a id="__codelineno-21-7" name="__codelineno-21-7" href="#__codelineno-21-7"></a><span class="go">Hit:3 http://deb.debian.org/debian-security bookworm-security InRelease</span>
</span><span id="__span-21-8"><a id="__codelineno-21-8" name="__codelineno-21-8" href="#__codelineno-21-8"></a><span class="go">Hit:4 http://deb.debian.org/debian bookworm-updates InRelease</span>
</span><span id="__span-21-9"><a id="__codelineno-21-9" name="__codelineno-21-9" href="#__codelineno-21-9"></a><span class="go">Reading package lists... Done</span>
</span><span id="__span-21-10"><a id="__codelineno-21-10" name="__codelineno-21-10" href="#__codelineno-21-10"></a><span class="go">Reading package lists... Done</span>
</span><span id="__span-21-11"><a id="__codelineno-21-11" name="__codelineno-21-11" href="#__codelineno-21-11"></a><span class="go">Building dependency tree... Done</span>
</span><span id="__span-21-12"><a id="__codelineno-21-12" name="__codelineno-21-12" href="#__codelineno-21-12"></a><span class="go">Reading state information... Done</span>
</span><span id="__span-21-13"><a id="__codelineno-21-13" name="__codelineno-21-13" href="#__codelineno-21-13"></a><span class="go">Calculating upgrade... Done</span>
</span><span id="__span-21-14"><a id="__codelineno-21-14" name="__codelineno-21-14" href="#__codelineno-21-14"></a><span class="go">0 upgraded, 0 newly installed, 0 to remove and 0 not upgraded.</span>
</span><span id="__span-21-15"><a id="__codelineno-21-15" name="__codelineno-21-15" href="#__codelineno-21-15"></a><span class="go">BOOTLOADER: up to date</span>
</span><span id="__span-21-16"><a id="__codelineno-21-16" name="__codelineno-21-16" href="#__codelineno-21-16"></a><span class="go">  CURRENT: Wed Feb 12 10:51:52 AM UTC 2025 (1739357512)</span>
</span><span id="__span-21-17"><a id="__codelineno-21-17" name="__codelineno-21-17" href="#__codelineno-21-17"></a><span class="go">    LATEST: Wed Feb 12 10:51:52 AM UTC 2025 (1739357512)</span>
</span><span id="__span-21-18"><a id="__codelineno-21-18" name="__codelineno-21-18" href="#__codelineno-21-18"></a><span class="go">  RELEASE: latest (/usr/lib/firmware/raspberrypi/bootloader-2712/latest)</span>
</span><span id="__span-21-19"><a id="__codelineno-21-19" name="__codelineno-21-19" href="#__codelineno-21-19"></a><span class="go">            Use raspi-config to change the release.</span>
</span><span id="__span-21-20"><a id="__codelineno-21-20" name="__codelineno-21-20" href="#__codelineno-21-20"></a><span class="go">EEPROM settings up to date</span>
</span></code></pre></div>
</details>
<h4 id="successful-argon-installation">Successful Argon installation</h4>
<p>Then after another required reboot, the <code>argon1.sh</code> script worked fine too:</p>
<details class="terminal">
<summary><code>curl https://download.argon40.com/argon1.sh | bash</code></summary>
<div class="language-console highlight"><pre><span></span><code><span id="__span-22-1"><a id="__codelineno-22-1" name="__codelineno-22-1" href="#__codelineno-22-1"></a><span class="gp">$ </span>curl<span class="w"> </span>https://download.argon40.com/argon1.sh<span class="w"> </span><span class="p">|</span><span class="w"> </span>bash
</span><span id="__span-22-2"><a id="__codelineno-22-2" name="__codelineno-22-2" href="#__codelineno-22-2"></a><span class="go">*************</span>
</span><span id="__span-22-3"><a id="__codelineno-22-3" name="__codelineno-22-3" href="#__codelineno-22-3"></a><span class="go"> Argon Setup  </span>
</span><span id="__span-22-4"><a id="__codelineno-22-4" name="__codelineno-22-4" href="#__codelineno-22-4"></a><span class="go">*************</span>
</span><span id="__span-22-5"><a id="__codelineno-22-5" name="__codelineno-22-5" href="#__codelineno-22-5"></a><span class="go">Reading package lists... Done</span>
</span><span id="__span-22-6"><a id="__codelineno-22-6" name="__codelineno-22-6" href="#__codelineno-22-6"></a><span class="go">Building dependency tree... Done</span>
</span><span id="__span-22-7"><a id="__codelineno-22-7" name="__codelineno-22-7" href="#__codelineno-22-7"></a><span class="go">Reading state information... Done</span>
</span><span id="__span-22-8"><a id="__codelineno-22-8" name="__codelineno-22-8" href="#__codelineno-22-8"></a><span class="go">python3-libgpiod is already the newest version (1.6.3-1+b3).</span>
</span><span id="__span-22-9"><a id="__codelineno-22-9" name="__codelineno-22-9" href="#__codelineno-22-9"></a><span class="go">0 upgraded, 0 newly installed, 0 to remove and 0 not upgraded.</span>
</span><span id="__span-22-10"><a id="__codelineno-22-10" name="__codelineno-22-10" href="#__codelineno-22-10"></a><span class="go">Reading package lists... Done</span>
</span><span id="__span-22-11"><a id="__codelineno-22-11" name="__codelineno-22-11" href="#__codelineno-22-11"></a><span class="go">Building dependency tree... Done</span>
</span><span id="__span-22-12"><a id="__codelineno-22-12" name="__codelineno-22-12" href="#__codelineno-22-12"></a><span class="go">Reading state information... Done</span>
</span><span id="__span-22-13"><a id="__codelineno-22-13" name="__codelineno-22-13" href="#__codelineno-22-13"></a><span class="go">The following additional packages will be installed:</span>
</span><span id="__span-22-14"><a id="__codelineno-22-14" name="__codelineno-22-14" href="#__codelineno-22-14"></a><span class="go">  i2c-tools libi2c0 read-edid</span>
</span><span id="__span-22-15"><a id="__codelineno-22-15" name="__codelineno-22-15" href="#__codelineno-22-15"></a><span class="go">Suggested packages:</span>
</span><span id="__span-22-16"><a id="__codelineno-22-16" name="__codelineno-22-16" href="#__codelineno-22-16"></a><span class="go">  libi2c-dev</span>
</span><span id="__span-22-17"><a id="__codelineno-22-17" name="__codelineno-22-17" href="#__codelineno-22-17"></a><span class="go">The following NEW packages will be installed:</span>
</span><span id="__span-22-18"><a id="__codelineno-22-18" name="__codelineno-22-18" href="#__codelineno-22-18"></a><span class="go">  i2c-tools libi2c0 python3-smbus read-edid</span>
</span><span id="__span-22-19"><a id="__codelineno-22-19" name="__codelineno-22-19" href="#__codelineno-22-19"></a><span class="go">0 upgraded, 4 newly installed, 0 to remove and 0 not upgraded.</span>
</span><span id="__span-22-20"><a id="__codelineno-22-20" name="__codelineno-22-20" href="#__codelineno-22-20"></a><span class="go">Need to get 116 kB of archives.</span>
</span><span id="__span-22-21"><a id="__codelineno-22-21" name="__codelineno-22-21" href="#__codelineno-22-21"></a><span class="go">After this operation, 773 kB of additional disk space will be used.</span>
</span><span id="__span-22-22"><a id="__codelineno-22-22" name="__codelineno-22-22" href="#__codelineno-22-22"></a><span class="go">Get:1 http://deb.debian.org/debian bookworm/main arm64 libi2c0 arm64 4.3-2+b3 [9,456 B]</span>
</span><span id="__span-22-23"><a id="__codelineno-22-23" name="__codelineno-22-23" href="#__codelineno-22-23"></a><span class="go">Get:2 http://deb.debian.org/debian bookworm/main arm64 i2c-tools arm64 4.3-2+b3 [78.6 kB]</span>
</span><span id="__span-22-24"><a id="__codelineno-22-24" name="__codelineno-22-24" href="#__codelineno-22-24"></a><span class="go">Get:3 http://deb.debian.org/debian bookworm/main arm64 python3-smbus arm64 4.3-2+b3 [11.8 kB]</span>
</span><span id="__span-22-25"><a id="__codelineno-22-25" name="__codelineno-22-25" href="#__codelineno-22-25"></a><span class="go">Get:4 http://deb.debian.org/debian bookworm/main arm64 read-edid arm64 3.0.2-1.1 [16.1 kB]</span>
</span><span id="__span-22-26"><a id="__codelineno-22-26" name="__codelineno-22-26" href="#__codelineno-22-26"></a><span class="go">Fetched 116 kB in 0s (487 kB/s)      </span>
</span><span id="__span-22-27"><a id="__codelineno-22-27" name="__codelineno-22-27" href="#__codelineno-22-27"></a><span class="go">Selecting previously unselected package libi2c0:arm64.</span>
</span><span id="__span-22-28"><a id="__codelineno-22-28" name="__codelineno-22-28" href="#__codelineno-22-28"></a><span class="gp gp-VirtualEnv">(Reading database ... 81258 files and directories currently installed.)</span>
</span><span id="__span-22-29"><a id="__codelineno-22-29" name="__codelineno-22-29" href="#__codelineno-22-29"></a><span class="go">Preparing to unpack .../libi2c0_4.3-2+b3_arm64.deb ...</span>
</span><span id="__span-22-30"><a id="__codelineno-22-30" name="__codelineno-22-30" href="#__codelineno-22-30"></a><span class="go">Unpacking libi2c0:arm64 (4.3-2+b3) ...</span>
</span><span id="__span-22-31"><a id="__codelineno-22-31" name="__codelineno-22-31" href="#__codelineno-22-31"></a><span class="go">Selecting previously unselected package i2c-tools.</span>
</span><span id="__span-22-32"><a id="__codelineno-22-32" name="__codelineno-22-32" href="#__codelineno-22-32"></a><span class="go">Preparing to unpack .../i2c-tools_4.3-2+b3_arm64.deb ...</span>
</span><span id="__span-22-33"><a id="__codelineno-22-33" name="__codelineno-22-33" href="#__codelineno-22-33"></a><span class="go">Unpacking i2c-tools (4.3-2+b3) ...</span>
</span><span id="__span-22-34"><a id="__codelineno-22-34" name="__codelineno-22-34" href="#__codelineno-22-34"></a><span class="go">Selecting previously unselected package python3-smbus:arm64.</span>
</span><span id="__span-22-35"><a id="__codelineno-22-35" name="__codelineno-22-35" href="#__codelineno-22-35"></a><span class="go">Preparing to unpack .../python3-smbus_4.3-2+b3_arm64.deb ...</span>
</span><span id="__span-22-36"><a id="__codelineno-22-36" name="__codelineno-22-36" href="#__codelineno-22-36"></a><span class="go">Unpacking python3-smbus:arm64 (4.3-2+b3) ...</span>
</span><span id="__span-22-37"><a id="__codelineno-22-37" name="__codelineno-22-37" href="#__codelineno-22-37"></a><span class="go">Selecting previously unselected package read-edid.</span>
</span><span id="__span-22-38"><a id="__codelineno-22-38" name="__codelineno-22-38" href="#__codelineno-22-38"></a><span class="go">Preparing to unpack .../read-edid_3.0.2-1.1_arm64.deb ...</span>
</span><span id="__span-22-39"><a id="__codelineno-22-39" name="__codelineno-22-39" href="#__codelineno-22-39"></a><span class="go">Unpacking read-edid (3.0.2-1.1) ...</span>
</span><span id="__span-22-40"><a id="__codelineno-22-40" name="__codelineno-22-40" href="#__codelineno-22-40"></a><span class="go">Setting up libi2c0:arm64 (4.3-2+b3) ...</span>
</span><span id="__span-22-41"><a id="__codelineno-22-41" name="__codelineno-22-41" href="#__codelineno-22-41"></a><span class="go">Setting up read-edid (3.0.2-1.1) ...</span>
</span><span id="__span-22-42"><a id="__codelineno-22-42" name="__codelineno-22-42" href="#__codelineno-22-42"></a><span class="go">Setting up i2c-tools (4.3-2+b3) ...</span>
</span><span id="__span-22-43"><a id="__codelineno-22-43" name="__codelineno-22-43" href="#__codelineno-22-43"></a><span class="go">Setting up python3-smbus:arm64 (4.3-2+b3) ...</span>
</span><span id="__span-22-44"><a id="__codelineno-22-44" name="__codelineno-22-44" href="#__codelineno-22-44"></a><span class="go">Processing triggers for man-db (2.11.2-2) ...</span>
</span><span id="__span-22-45"><a id="__codelineno-22-45" name="__codelineno-22-45" href="#__codelineno-22-45"></a><span class="go">Processing triggers for libc-bin (2.36-9+rpt2+deb12u9) ...</span>
</span><span id="__span-22-46"><a id="__codelineno-22-46" name="__codelineno-22-46" href="#__codelineno-22-46"></a><span class="go">Reading package lists... Done</span>
</span><span id="__span-22-47"><a id="__codelineno-22-47" name="__codelineno-22-47" href="#__codelineno-22-47"></a><span class="go">Building dependency tree... Done</span>
</span><span id="__span-22-48"><a id="__codelineno-22-48" name="__codelineno-22-48" href="#__codelineno-22-48"></a><span class="go">Reading state information... Done</span>
</span><span id="__span-22-49"><a id="__codelineno-22-49" name="__codelineno-22-49" href="#__codelineno-22-49"></a><span class="go">i2c-tools is already the newest version (4.3-2+b3).</span>
</span><span id="__span-22-50"><a id="__codelineno-22-50" name="__codelineno-22-50" href="#__codelineno-22-50"></a><span class="go">i2c-tools set to manually installed.</span>
</span><span id="__span-22-51"><a id="__codelineno-22-51" name="__codelineno-22-51" href="#__codelineno-22-51"></a><span class="go">0 upgraded, 0 newly installed, 0 to remove and 0 not upgraded.</span>
</span><span id="__span-22-52"><a id="__codelineno-22-52" name="__codelineno-22-52" href="#__codelineno-22-52"></a><span class="go">Created symlink /etc/systemd/system/multi-user.target.wants/argononed.service  /lib/systemd/system/argononed.service.</span>
</span><span id="__span-22-53"><a id="__codelineno-22-53" name="__codelineno-22-53" href="#__codelineno-22-53"></a><span class="go">Hit:1 http://deb.debian.org/debian bookworm InRelease</span>
</span><span id="__span-22-54"><a id="__codelineno-22-54" name="__codelineno-22-54" href="#__codelineno-22-54"></a><span class="go">Hit:2 http://deb.debian.org/debian-security bookworm-security InRelease</span>
</span><span id="__span-22-55"><a id="__codelineno-22-55" name="__codelineno-22-55" href="#__codelineno-22-55"></a><span class="go">Hit:3 http://deb.debian.org/debian bookworm-updates InRelease   </span>
</span><span id="__span-22-56"><a id="__codelineno-22-56" name="__codelineno-22-56" href="#__codelineno-22-56"></a><span class="go">Hit:4 http://archive.raspberrypi.com/debian bookworm InRelease  </span>
</span><span id="__span-22-57"><a id="__codelineno-22-57" name="__codelineno-22-57" href="#__codelineno-22-57"></a><span class="go">Reading package lists... Done                             </span>
</span><span id="__span-22-58"><a id="__codelineno-22-58" name="__codelineno-22-58" href="#__codelineno-22-58"></a><span class="go">Reading package lists... Done</span>
</span><span id="__span-22-59"><a id="__codelineno-22-59" name="__codelineno-22-59" href="#__codelineno-22-59"></a><span class="go">Building dependency tree... Done</span>
</span><span id="__span-22-60"><a id="__codelineno-22-60" name="__codelineno-22-60" href="#__codelineno-22-60"></a><span class="go">Reading state information... Done</span>
</span><span id="__span-22-61"><a id="__codelineno-22-61" name="__codelineno-22-61" href="#__codelineno-22-61"></a><span class="go">Calculating upgrade... Done</span>
</span><span id="__span-22-62"><a id="__codelineno-22-62" name="__codelineno-22-62" href="#__codelineno-22-62"></a><span class="go">0 upgraded, 0 newly installed, 0 to remove and 0 not upgraded.</span>
</span><span id="__span-22-63"><a id="__codelineno-22-63" name="__codelineno-22-63" href="#__codelineno-22-63"></a><span class="go">BOOTLOADER: up to date</span>
</span><span id="__span-22-64"><a id="__codelineno-22-64" name="__codelineno-22-64" href="#__codelineno-22-64"></a><span class="go">   CURRENT: Wed Feb 12 10:51:52 AM UTC 2025 (1739357512)</span>
</span><span id="__span-22-65"><a id="__codelineno-22-65" name="__codelineno-22-65" href="#__codelineno-22-65"></a><span class="go">    LATEST: Wed Feb 12 10:51:52 AM UTC 2025 (1739357512)</span>
</span><span id="__span-22-66"><a id="__codelineno-22-66" name="__codelineno-22-66" href="#__codelineno-22-66"></a><span class="go">   RELEASE: latest (/usr/lib/firmware/raspberrypi/bootloader-2712/latest)</span>
</span><span id="__span-22-67"><a id="__codelineno-22-67" name="__codelineno-22-67" href="#__codelineno-22-67"></a><span class="go">            Use raspi-config to change the release.</span>
</span><span id="__span-22-68"><a id="__codelineno-22-68" name="__codelineno-22-68" href="#__codelineno-22-68"></a><span class="go">Updating bootloader EEPROM</span>
</span><span id="__span-22-69"><a id="__codelineno-22-69" name="__codelineno-22-69" href="#__codelineno-22-69"></a><span class="go"> image: /usr/lib/firmware/raspberrypi/bootloader-2712/latest/pieeprom-2025-02-12.bin</span>
</span><span id="__span-22-70"><a id="__codelineno-22-70" name="__codelineno-22-70" href="#__codelineno-22-70"></a><span class="go">config_src: blconfig device</span>
</span><span id="__span-22-71"><a id="__codelineno-22-71" name="__codelineno-22-71" href="#__codelineno-22-71"></a><span class="go">config: /tmp/tmpsnnegdcc/boot.conf</span>
</span><span id="__span-22-72"><a id="__codelineno-22-72" name="__codelineno-22-72" href="#__codelineno-22-72"></a><span class="gp">#</span><span class="c1">###############################################################################</span>
</span><span id="__span-22-73"><a id="__codelineno-22-73" name="__codelineno-22-73" href="#__codelineno-22-73"></a><span class="go">[all]</span>
</span><span id="__span-22-74"><a id="__codelineno-22-74" name="__codelineno-22-74" href="#__codelineno-22-74"></a><span class="go">PSU_MAX_CURRENT=5000</span>
</span><span id="__span-22-75"><a id="__codelineno-22-75" name="__codelineno-22-75" href="#__codelineno-22-75"></a><span class="go">WAKE_ON_GPIO=0</span>
</span><span id="__span-22-76"><a id="__codelineno-22-76" name="__codelineno-22-76" href="#__codelineno-22-76"></a><span class="go">PCIE_PROBE=1</span>
</span><span id="__span-22-77"><a id="__codelineno-22-77" name="__codelineno-22-77" href="#__codelineno-22-77"></a><span class="go">BOOT_UART=1</span>
</span><span id="__span-22-78"><a id="__codelineno-22-78" name="__codelineno-22-78" href="#__codelineno-22-78"></a><span class="go">POWER_OFF_ON_HALT=1</span>
</span><span id="__span-22-79"><a id="__codelineno-22-79" name="__codelineno-22-79" href="#__codelineno-22-79"></a><span class="go">BOOT_ORDER=0xf416</span>
</span><span id="__span-22-80"><a id="__codelineno-22-80" name="__codelineno-22-80" href="#__codelineno-22-80"></a>
</span><span id="__span-22-81"><a id="__codelineno-22-81" name="__codelineno-22-81" href="#__codelineno-22-81"></a><span class="gp">#</span><span class="c1">###############################################################################</span>
</span><span id="__span-22-82"><a id="__codelineno-22-82" name="__codelineno-22-82" href="#__codelineno-22-82"></a>
</span><span id="__span-22-83"><a id="__codelineno-22-83" name="__codelineno-22-83" href="#__codelineno-22-83"></a><span class="go">*** To cancel this update run 'sudo rpi-eeprom-update -r' ***</span>
</span><span id="__span-22-84"><a id="__codelineno-22-84" name="__codelineno-22-84" href="#__codelineno-22-84"></a>
</span><span id="__span-22-85"><a id="__codelineno-22-85" name="__codelineno-22-85" href="#__codelineno-22-85"></a><span class="go">*** CREATED UPDATE /tmp/tmpsnnegdcc/pieeprom.upd  ***</span>
</span><span id="__span-22-86"><a id="__codelineno-22-86" name="__codelineno-22-86" href="#__codelineno-22-86"></a>
</span><span id="__span-22-87"><a id="__codelineno-22-87" name="__codelineno-22-87" href="#__codelineno-22-87"></a><span class="go">   CURRENT: Wed Feb 12 10:51:52 AM UTC 2025 (1739357512)</span>
</span><span id="__span-22-88"><a id="__codelineno-22-88" name="__codelineno-22-88" href="#__codelineno-22-88"></a><span class="go">    UPDATE: Wed Feb 12 10:51:52 AM UTC 2025 (1739357512)</span>
</span><span id="__span-22-89"><a id="__codelineno-22-89" name="__codelineno-22-89" href="#__codelineno-22-89"></a><span class="go">    BOOTFS: /boot/firmware</span>
</span><span id="__span-22-90"><a id="__codelineno-22-90" name="__codelineno-22-90" href="#__codelineno-22-90"></a><span class="go">'/tmp/tmp.U1Yfb9oJp3' -&gt; '/boot/firmware/pieeprom.upd'</span>
</span><span id="__span-22-91"><a id="__codelineno-22-91" name="__codelineno-22-91" href="#__codelineno-22-91"></a>
</span><span id="__span-22-92"><a id="__codelineno-22-92" name="__codelineno-22-92" href="#__codelineno-22-92"></a><span class="go">UPDATING bootloader. This could take up to a minute. Please wait</span>
</span><span id="__span-22-93"><a id="__codelineno-22-93" name="__codelineno-22-93" href="#__codelineno-22-93"></a>
</span><span id="__span-22-94"><a id="__codelineno-22-94" name="__codelineno-22-94" href="#__codelineno-22-94"></a><span class="go">*** Do not disconnect the power until the update is complete ***</span>
</span><span id="__span-22-95"><a id="__codelineno-22-95" name="__codelineno-22-95" href="#__codelineno-22-95"></a>
</span><span id="__span-22-96"><a id="__codelineno-22-96" name="__codelineno-22-96" href="#__codelineno-22-96"></a><span class="go">If a problem occurs then the Raspberry Pi Imager may be used to create</span>
</span><span id="__span-22-97"><a id="__codelineno-22-97" name="__codelineno-22-97" href="#__codelineno-22-97"></a><span class="go">a bootloader rescue SD card image which restores the default bootloader image.</span>
</span><span id="__span-22-98"><a id="__codelineno-22-98" name="__codelineno-22-98" href="#__codelineno-22-98"></a>
</span><span id="__span-22-99"><a id="__codelineno-22-99" name="__codelineno-22-99" href="#__codelineno-22-99"></a><span class="go">flashrom -p linux_spi:dev=/dev/spidev10.0,spispeed=16000 -w /boot/firmware/pieeprom.upd</span>
</span><span id="__span-22-100"><a id="__codelineno-22-100" name="__codelineno-22-100" href="#__codelineno-22-100"></a><span class="go">Verifying update</span>
</span><span id="__span-22-101"><a id="__codelineno-22-101" name="__codelineno-22-101" href="#__codelineno-22-101"></a><span class="go">VERIFY: SUCCESS</span>
</span><span id="__span-22-102"><a id="__codelineno-22-102" name="__codelineno-22-102" href="#__codelineno-22-102"></a><span class="go">UPDATE SUCCESSFUL</span>
</span><span id="__span-22-103"><a id="__codelineno-22-103" name="__codelineno-22-103" href="#__codelineno-22-103"></a><span class="go">*********************</span>
</span><span id="__span-22-104"><a id="__codelineno-22-104" name="__codelineno-22-104" href="#__codelineno-22-104"></a><span class="go">  Setup Completed </span>
</span><span id="__span-22-105"><a id="__codelineno-22-105" name="__codelineno-22-105" href="#__codelineno-22-105"></a><span class="go">*********************</span>
</span><span id="__span-22-106"><a id="__codelineno-22-106" name="__codelineno-22-106" href="#__codelineno-22-106"></a><span class="go">Version 2502002</span>
</span><span id="__span-22-107"><a id="__codelineno-22-107" name="__codelineno-22-107" href="#__codelineno-22-107"></a>
</span><span id="__span-22-108"><a id="__codelineno-22-108" name="__codelineno-22-108" href="#__codelineno-22-108"></a><span class="go">We acknowledge the valuable feedback of the following:</span>
</span><span id="__span-22-109"><a id="__codelineno-22-109" name="__codelineno-22-109" href="#__codelineno-22-109"></a><span class="go">ghalfacree, NHHiker</span>
</span><span id="__span-22-110"><a id="__codelineno-22-110" name="__codelineno-22-110" href="#__codelineno-22-110"></a>
</span><span id="__span-22-111"><a id="__codelineno-22-111" name="__codelineno-22-111" href="#__codelineno-22-111"></a><span class="go">Feel free to join the discussions at https://forum.argon40.com</span>
</span><span id="__span-22-112"><a id="__codelineno-22-112" name="__codelineno-22-112" href="#__codelineno-22-112"></a>
</span><span id="__span-22-113"><a id="__codelineno-22-113" name="__codelineno-22-113" href="#__codelineno-22-113"></a>
</span><span id="__span-22-114"><a id="__codelineno-22-114" name="__codelineno-22-114" href="#__codelineno-22-114"></a><span class="go">Use 'argon-config' to configure device</span>
</span></code></pre></div>
</details>
<p>And finally, after yet another reboot, the <code>argon-config</code> works:</p>
<details class="terminal">
<summary><code>sudo argon-config</code></summary>
<div class="language-console highlight"><pre><span></span><code><span id="__span-23-1"><a id="__codelineno-23-1" name="__codelineno-23-1" href="#__codelineno-23-1"></a><span class="gp">$ </span>sudo<span class="w"> </span>argon-config
</span><span id="__span-23-2"><a id="__codelineno-23-2" name="__codelineno-23-2" href="#__codelineno-23-2"></a><span class="go">--------------------------</span>
</span><span id="__span-23-3"><a id="__codelineno-23-3" name="__codelineno-23-3" href="#__codelineno-23-3"></a><span class="go">Argon Configuration Tool</span>
</span><span id="__span-23-4"><a id="__codelineno-23-4" name="__codelineno-23-4" href="#__codelineno-23-4"></a><span class="go">Version 2502002</span>
</span><span id="__span-23-5"><a id="__codelineno-23-5" name="__codelineno-23-5" href="#__codelineno-23-5"></a><span class="go">--------------------------</span>
</span><span id="__span-23-6"><a id="__codelineno-23-6" name="__codelineno-23-6" href="#__codelineno-23-6"></a>
</span><span id="__span-23-7"><a id="__codelineno-23-7" name="__codelineno-23-7" href="#__codelineno-23-7"></a><span class="go">Choose Option:</span>
</span><span id="__span-23-8"><a id="__codelineno-23-8" name="__codelineno-23-8" href="#__codelineno-23-8"></a><span class="go">  1. Configure Fan</span>
</span><span id="__span-23-9"><a id="__codelineno-23-9" name="__codelineno-23-9" href="#__codelineno-23-9"></a><span class="go">  2. Configure IR</span>
</span><span id="__span-23-10"><a id="__codelineno-23-10" name="__codelineno-23-10" href="#__codelineno-23-10"></a><span class="go">  3. Argon Industria UPS</span>
</span><span id="__span-23-11"><a id="__codelineno-23-11" name="__codelineno-23-11" href="#__codelineno-23-11"></a><span class="go">  4. Configure BLSTR DAC (v3/v5 only)</span>
</span><span id="__span-23-12"><a id="__codelineno-23-12" name="__codelineno-23-12" href="#__codelineno-23-12"></a><span class="go">  5. Configure Units</span>
</span><span id="__span-23-13"><a id="__codelineno-23-13" name="__codelineno-23-13" href="#__codelineno-23-13"></a><span class="go">  6. System Information</span>
</span><span id="__span-23-14"><a id="__codelineno-23-14" name="__codelineno-23-14" href="#__codelineno-23-14"></a><span class="go">  7. Uninstall</span>
</span><span id="__span-23-15"><a id="__codelineno-23-15" name="__codelineno-23-15" href="#__codelineno-23-15"></a>
</span><span id="__span-23-16"><a id="__codelineno-23-16" name="__codelineno-23-16" href="#__codelineno-23-16"></a><span class="go">  0. Exit</span>
</span><span id="__span-23-17"><a id="__codelineno-23-17" name="__codelineno-23-17" href="#__codelineno-23-17"></a><span class="go">Enter Number (0-7):6</span>
</span><span id="__span-23-18"><a id="__codelineno-23-18" name="__codelineno-23-18" href="#__codelineno-23-18"></a><span class="go">--------------------------</span>
</span><span id="__span-23-19"><a id="__codelineno-23-19" name="__codelineno-23-19" href="#__codelineno-23-19"></a><span class="go"> Argon System Information</span>
</span><span id="__span-23-20"><a id="__codelineno-23-20" name="__codelineno-23-20" href="#__codelineno-23-20"></a><span class="go">--------------------------</span>
</span><span id="__span-23-21"><a id="__codelineno-23-21" name="__codelineno-23-21" href="#__codelineno-23-21"></a>
</span><span id="__span-23-22"><a id="__codelineno-23-22" name="__codelineno-23-22" href="#__codelineno-23-22"></a><span class="go">  1. Temperatures</span>
</span><span id="__span-23-23"><a id="__codelineno-23-23" name="__codelineno-23-23" href="#__codelineno-23-23"></a><span class="go">  2. CPU Utilization</span>
</span><span id="__span-23-24"><a id="__codelineno-23-24" name="__codelineno-23-24" href="#__codelineno-23-24"></a><span class="go">  3. Storage Capacity</span>
</span><span id="__span-23-25"><a id="__codelineno-23-25" name="__codelineno-23-25" href="#__codelineno-23-25"></a><span class="go">  4. RAM</span>
</span><span id="__span-23-26"><a id="__codelineno-23-26" name="__codelineno-23-26" href="#__codelineno-23-26"></a><span class="go">  5. IP Address</span>
</span><span id="__span-23-27"><a id="__codelineno-23-27" name="__codelineno-23-27" href="#__codelineno-23-27"></a><span class="go">  6. Fan Speed</span>
</span><span id="__span-23-28"><a id="__codelineno-23-28" name="__codelineno-23-28" href="#__codelineno-23-28"></a>
</span><span id="__span-23-29"><a id="__codelineno-23-29" name="__codelineno-23-29" href="#__codelineno-23-29"></a><span class="go">  0. Back</span>
</span><span id="__span-23-30"><a id="__codelineno-23-30" name="__codelineno-23-30" href="#__codelineno-23-30"></a><span class="go">Enter Number (0-6):1</span>
</span><span id="__span-23-31"><a id="__codelineno-23-31" name="__codelineno-23-31" href="#__codelineno-23-31"></a><span class="go">--------------------------</span>
</span><span id="__span-23-32"><a id="__codelineno-23-32" name="__codelineno-23-32" href="#__codelineno-23-32"></a><span class="go">TEMPERATURE INFORMATION:</span>
</span><span id="__span-23-33"><a id="__codelineno-23-33" name="__codelineno-23-33" href="#__codelineno-23-33"></a><span class="go">   CPU: 40.2C</span>
</span><span id="__span-23-34"><a id="__codelineno-23-34" name="__codelineno-23-34" href="#__codelineno-23-34"></a><span class="go">--------------------------</span>
</span><span id="__span-23-35"><a id="__codelineno-23-35" name="__codelineno-23-35" href="#__codelineno-23-35"></a>
</span><span id="__span-23-36"><a id="__codelineno-23-36" name="__codelineno-23-36" href="#__codelineno-23-36"></a><span class="go">  1. Temperatures</span>
</span><span id="__span-23-37"><a id="__codelineno-23-37" name="__codelineno-23-37" href="#__codelineno-23-37"></a><span class="go">  2. CPU Utilization</span>
</span><span id="__span-23-38"><a id="__codelineno-23-38" name="__codelineno-23-38" href="#__codelineno-23-38"></a><span class="go">  3. Storage Capacity</span>
</span><span id="__span-23-39"><a id="__codelineno-23-39" name="__codelineno-23-39" href="#__codelineno-23-39"></a><span class="go">  4. RAM</span>
</span><span id="__span-23-40"><a id="__codelineno-23-40" name="__codelineno-23-40" href="#__codelineno-23-40"></a><span class="go">  5. IP Address</span>
</span><span id="__span-23-41"><a id="__codelineno-23-41" name="__codelineno-23-41" href="#__codelineno-23-41"></a><span class="go">  6. Fan Speed</span>
</span><span id="__span-23-42"><a id="__codelineno-23-42" name="__codelineno-23-42" href="#__codelineno-23-42"></a>
</span><span id="__span-23-43"><a id="__codelineno-23-43" name="__codelineno-23-43" href="#__codelineno-23-43"></a><span class="go">  0. Back</span>
</span><span id="__span-23-44"><a id="__codelineno-23-44" name="__codelineno-23-44" href="#__codelineno-23-44"></a><span class="go">Enter Number (0-6):2</span>
</span><span id="__span-23-45"><a id="__codelineno-23-45" name="__codelineno-23-45" href="#__codelineno-23-45"></a><span class="go">--------------------------</span>
</span><span id="__span-23-46"><a id="__codelineno-23-46" name="__codelineno-23-46" href="#__codelineno-23-46"></a><span class="go">CPU USAGE INFORMATION:</span>
</span><span id="__span-23-47"><a id="__codelineno-23-47" name="__codelineno-23-47" href="#__codelineno-23-47"></a><span class="go">   cpu0: 0%</span>
</span><span id="__span-23-48"><a id="__codelineno-23-48" name="__codelineno-23-48" href="#__codelineno-23-48"></a><span class="go">   cpu1: 0%</span>
</span><span id="__span-23-49"><a id="__codelineno-23-49" name="__codelineno-23-49" href="#__codelineno-23-49"></a><span class="go">   cpu2: 0%</span>
</span><span id="__span-23-50"><a id="__codelineno-23-50" name="__codelineno-23-50" href="#__codelineno-23-50"></a><span class="go">   cpu3: 0%</span>
</span><span id="__span-23-51"><a id="__codelineno-23-51" name="__codelineno-23-51" href="#__codelineno-23-51"></a><span class="go">--------------------------</span>
</span><span id="__span-23-52"><a id="__codelineno-23-52" name="__codelineno-23-52" href="#__codelineno-23-52"></a>
</span><span id="__span-23-53"><a id="__codelineno-23-53" name="__codelineno-23-53" href="#__codelineno-23-53"></a><span class="go">  1. Temperatures</span>
</span><span id="__span-23-54"><a id="__codelineno-23-54" name="__codelineno-23-54" href="#__codelineno-23-54"></a><span class="go">  2. CPU Utilization</span>
</span><span id="__span-23-55"><a id="__codelineno-23-55" name="__codelineno-23-55" href="#__codelineno-23-55"></a><span class="go">  3. Storage Capacity</span>
</span><span id="__span-23-56"><a id="__codelineno-23-56" name="__codelineno-23-56" href="#__codelineno-23-56"></a><span class="go">  4. RAM</span>
</span><span id="__span-23-57"><a id="__codelineno-23-57" name="__codelineno-23-57" href="#__codelineno-23-57"></a><span class="go">  5. IP Address</span>
</span><span id="__span-23-58"><a id="__codelineno-23-58" name="__codelineno-23-58" href="#__codelineno-23-58"></a><span class="go">  6. Fan Speed</span>
</span><span id="__span-23-59"><a id="__codelineno-23-59" name="__codelineno-23-59" href="#__codelineno-23-59"></a>
</span><span id="__span-23-60"><a id="__codelineno-23-60" name="__codelineno-23-60" href="#__codelineno-23-60"></a><span class="go">  0. Back</span>
</span><span id="__span-23-61"><a id="__codelineno-23-61" name="__codelineno-23-61" href="#__codelineno-23-61"></a><span class="go">Enter Number (0-6):3</span>
</span><span id="__span-23-62"><a id="__codelineno-23-62" name="__codelineno-23-62" href="#__codelineno-23-62"></a><span class="go">--------------------------</span>
</span><span id="__span-23-63"><a id="__codelineno-23-63" name="__codelineno-23-63" href="#__codelineno-23-63"></a><span class="go">STORAGE INFORMATION:</span>
</span><span id="__span-23-64"><a id="__codelineno-23-64" name="__codelineno-23-64" href="#__codelineno-23-64"></a><span class="go">   nvme0n1 0% used of 2TB</span>
</span><span id="__span-23-65"><a id="__codelineno-23-65" name="__codelineno-23-65" href="#__codelineno-23-65"></a><span class="go">--------------------------</span>
</span><span id="__span-23-66"><a id="__codelineno-23-66" name="__codelineno-23-66" href="#__codelineno-23-66"></a>
</span><span id="__span-23-67"><a id="__codelineno-23-67" name="__codelineno-23-67" href="#__codelineno-23-67"></a><span class="go">  1. Temperatures</span>
</span><span id="__span-23-68"><a id="__codelineno-23-68" name="__codelineno-23-68" href="#__codelineno-23-68"></a><span class="go">  2. CPU Utilization</span>
</span><span id="__span-23-69"><a id="__codelineno-23-69" name="__codelineno-23-69" href="#__codelineno-23-69"></a><span class="go">  3. Storage Capacity</span>
</span><span id="__span-23-70"><a id="__codelineno-23-70" name="__codelineno-23-70" href="#__codelineno-23-70"></a><span class="go">  4. RAM</span>
</span><span id="__span-23-71"><a id="__codelineno-23-71" name="__codelineno-23-71" href="#__codelineno-23-71"></a><span class="go">  5. IP Address</span>
</span><span id="__span-23-72"><a id="__codelineno-23-72" name="__codelineno-23-72" href="#__codelineno-23-72"></a><span class="go">  6. Fan Speed</span>
</span><span id="__span-23-73"><a id="__codelineno-23-73" name="__codelineno-23-73" href="#__codelineno-23-73"></a>
</span><span id="__span-23-74"><a id="__codelineno-23-74" name="__codelineno-23-74" href="#__codelineno-23-74"></a><span class="go">  0. Back</span>
</span><span id="__span-23-75"><a id="__codelineno-23-75" name="__codelineno-23-75" href="#__codelineno-23-75"></a><span class="go">Enter Number (0-6):4</span>
</span><span id="__span-23-76"><a id="__codelineno-23-76" name="__codelineno-23-76" href="#__codelineno-23-76"></a><span class="go">--------------------------</span>
</span><span id="__span-23-77"><a id="__codelineno-23-77" name="__codelineno-23-77" href="#__codelineno-23-77"></a><span class="go">RAM INFORMATION:</span>
</span><span id="__span-23-78"><a id="__codelineno-23-78" name="__codelineno-23-78" href="#__codelineno-23-78"></a><span class="go">   97% of 8GB</span>
</span><span id="__span-23-79"><a id="__codelineno-23-79" name="__codelineno-23-79" href="#__codelineno-23-79"></a><span class="go">--------------------------</span>
</span><span id="__span-23-80"><a id="__codelineno-23-80" name="__codelineno-23-80" href="#__codelineno-23-80"></a>
</span><span id="__span-23-81"><a id="__codelineno-23-81" name="__codelineno-23-81" href="#__codelineno-23-81"></a><span class="go">  1. Temperatures</span>
</span><span id="__span-23-82"><a id="__codelineno-23-82" name="__codelineno-23-82" href="#__codelineno-23-82"></a><span class="go">  2. CPU Utilization</span>
</span><span id="__span-23-83"><a id="__codelineno-23-83" name="__codelineno-23-83" href="#__codelineno-23-83"></a><span class="go">  3. Storage Capacity</span>
</span><span id="__span-23-84"><a id="__codelineno-23-84" name="__codelineno-23-84" href="#__codelineno-23-84"></a><span class="go">  4. RAM</span>
</span><span id="__span-23-85"><a id="__codelineno-23-85" name="__codelineno-23-85" href="#__codelineno-23-85"></a><span class="go">  5. IP Address</span>
</span><span id="__span-23-86"><a id="__codelineno-23-86" name="__codelineno-23-86" href="#__codelineno-23-86"></a><span class="go">  6. Fan Speed</span>
</span><span id="__span-23-87"><a id="__codelineno-23-87" name="__codelineno-23-87" href="#__codelineno-23-87"></a>
</span><span id="__span-23-88"><a id="__codelineno-23-88" name="__codelineno-23-88" href="#__codelineno-23-88"></a><span class="go">  0. Back</span>
</span><span id="__span-23-89"><a id="__codelineno-23-89" name="__codelineno-23-89" href="#__codelineno-23-89"></a><span class="go">Enter Number (0-6):5</span>
</span><span id="__span-23-90"><a id="__codelineno-23-90" name="__codelineno-23-90" href="#__codelineno-23-90"></a><span class="go">--------------------------</span>
</span><span id="__span-23-91"><a id="__codelineno-23-91" name="__codelineno-23-91" href="#__codelineno-23-91"></a><span class="go">IP INFORMATION:</span>
</span><span id="__span-23-92"><a id="__codelineno-23-92" name="__codelineno-23-92" href="#__codelineno-23-92"></a><span class="go">   192.168.0.124</span>
</span><span id="__span-23-93"><a id="__codelineno-23-93" name="__codelineno-23-93" href="#__codelineno-23-93"></a><span class="go">--------------------------</span>
</span><span id="__span-23-94"><a id="__codelineno-23-94" name="__codelineno-23-94" href="#__codelineno-23-94"></a>
</span><span id="__span-23-95"><a id="__codelineno-23-95" name="__codelineno-23-95" href="#__codelineno-23-95"></a><span class="go">  1. Temperatures</span>
</span><span id="__span-23-96"><a id="__codelineno-23-96" name="__codelineno-23-96" href="#__codelineno-23-96"></a><span class="go">  2. CPU Utilization</span>
</span><span id="__span-23-97"><a id="__codelineno-23-97" name="__codelineno-23-97" href="#__codelineno-23-97"></a><span class="go">  3. Storage Capacity</span>
</span><span id="__span-23-98"><a id="__codelineno-23-98" name="__codelineno-23-98" href="#__codelineno-23-98"></a><span class="go">  4. RAM</span>
</span><span id="__span-23-99"><a id="__codelineno-23-99" name="__codelineno-23-99" href="#__codelineno-23-99"></a><span class="go">  5. IP Address</span>
</span><span id="__span-23-100"><a id="__codelineno-23-100" name="__codelineno-23-100" href="#__codelineno-23-100"></a><span class="go">  6. Fan Speed</span>
</span><span id="__span-23-101"><a id="__codelineno-23-101" name="__codelineno-23-101" href="#__codelineno-23-101"></a>
</span><span id="__span-23-102"><a id="__codelineno-23-102" name="__codelineno-23-102" href="#__codelineno-23-102"></a><span class="go">  0. Back</span>
</span><span id="__span-23-103"><a id="__codelineno-23-103" name="__codelineno-23-103" href="#__codelineno-23-103"></a><span class="go">Enter Number (0-6):6</span>
</span><span id="__span-23-104"><a id="__codelineno-23-104" name="__codelineno-23-104" href="#__codelineno-23-104"></a><span class="go">--------------------------</span>
</span><span id="__span-23-105"><a id="__codelineno-23-105" name="__codelineno-23-105" href="#__codelineno-23-105"></a><span class="go">TEMPERATURE INFORMATION:</span>
</span><span id="__span-23-106"><a id="__codelineno-23-106" name="__codelineno-23-106" href="#__codelineno-23-106"></a><span class="go">   CPU: 40.2C</span>
</span><span id="__span-23-107"><a id="__codelineno-23-107" name="__codelineno-23-107" href="#__codelineno-23-107"></a><span class="go">FAN CONFIGURATION INFORMATION:</span>
</span><span id="__span-23-108"><a id="__codelineno-23-108" name="__codelineno-23-108" href="#__codelineno-23-108"></a><span class="go">        65.0=100</span>
</span><span id="__span-23-109"><a id="__codelineno-23-109" name="__codelineno-23-109" href="#__codelineno-23-109"></a><span class="go">        60.0=55</span>
</span><span id="__span-23-110"><a id="__codelineno-23-110" name="__codelineno-23-110" href="#__codelineno-23-110"></a><span class="go">        55.0=30</span>
</span><span id="__span-23-111"><a id="__codelineno-23-111" name="__codelineno-23-111" href="#__codelineno-23-111"></a><span class="go">FAN SPEED INFORMATION:</span>
</span><span id="__span-23-112"><a id="__codelineno-23-112" name="__codelineno-23-112" href="#__codelineno-23-112"></a><span class="go">   Fan Speed 0</span>
</span><span id="__span-23-113"><a id="__codelineno-23-113" name="__codelineno-23-113" href="#__codelineno-23-113"></a><span class="go">--------------------------</span>
</span><span id="__span-23-114"><a id="__codelineno-23-114" name="__codelineno-23-114" href="#__codelineno-23-114"></a>
</span><span id="__span-23-115"><a id="__codelineno-23-115" name="__codelineno-23-115" href="#__codelineno-23-115"></a><span class="go">  1. Temperatures</span>
</span><span id="__span-23-116"><a id="__codelineno-23-116" name="__codelineno-23-116" href="#__codelineno-23-116"></a><span class="go">  2. CPU Utilization</span>
</span><span id="__span-23-117"><a id="__codelineno-23-117" name="__codelineno-23-117" href="#__codelineno-23-117"></a><span class="go">  3. Storage Capacity</span>
</span><span id="__span-23-118"><a id="__codelineno-23-118" name="__codelineno-23-118" href="#__codelineno-23-118"></a><span class="go">  4. RAM</span>
</span><span id="__span-23-119"><a id="__codelineno-23-119" name="__codelineno-23-119" href="#__codelineno-23-119"></a><span class="go">  5. IP Address</span>
</span><span id="__span-23-120"><a id="__codelineno-23-120" name="__codelineno-23-120" href="#__codelineno-23-120"></a><span class="go">  6. Fan Speed</span>
</span><span id="__span-23-121"><a id="__codelineno-23-121" name="__codelineno-23-121" href="#__codelineno-23-121"></a>
</span><span id="__span-23-122"><a id="__codelineno-23-122" name="__codelineno-23-122" href="#__codelineno-23-122"></a><span class="go">  0. Back</span>
</span><span id="__span-23-123"><a id="__codelineno-23-123" name="__codelineno-23-123" href="#__codelineno-23-123"></a><span class="go">Enter Number (0-6):0</span>
</span><span id="__span-23-124"><a id="__codelineno-23-124" name="__codelineno-23-124" href="#__codelineno-23-124"></a>
</span><span id="__span-23-125"><a id="__codelineno-23-125" name="__codelineno-23-125" href="#__codelineno-23-125"></a><span class="go">Choose Option:</span>
</span><span id="__span-23-126"><a id="__codelineno-23-126" name="__codelineno-23-126" href="#__codelineno-23-126"></a><span class="go">  1. Configure Fan</span>
</span><span id="__span-23-127"><a id="__codelineno-23-127" name="__codelineno-23-127" href="#__codelineno-23-127"></a><span class="go">  2. Configure IR</span>
</span><span id="__span-23-128"><a id="__codelineno-23-128" name="__codelineno-23-128" href="#__codelineno-23-128"></a><span class="go">  3. Argon Industria UPS</span>
</span><span id="__span-23-129"><a id="__codelineno-23-129" name="__codelineno-23-129" href="#__codelineno-23-129"></a><span class="go">  4. Configure BLSTR DAC (v3/v5 only)</span>
</span><span id="__span-23-130"><a id="__codelineno-23-130" name="__codelineno-23-130" href="#__codelineno-23-130"></a><span class="go">  5. Configure Units</span>
</span><span id="__span-23-131"><a id="__codelineno-23-131" name="__codelineno-23-131" href="#__codelineno-23-131"></a><span class="go">  6. System Information</span>
</span><span id="__span-23-132"><a id="__codelineno-23-132" name="__codelineno-23-132" href="#__codelineno-23-132"></a><span class="go">  7. Uninstall</span>
</span><span id="__span-23-133"><a id="__codelineno-23-133" name="__codelineno-23-133" href="#__codelineno-23-133"></a>
</span><span id="__span-23-134"><a id="__codelineno-23-134" name="__codelineno-23-134" href="#__codelineno-23-134"></a><span class="go">  0. Exit</span>
</span><span id="__span-23-135"><a id="__codelineno-23-135" name="__codelineno-23-135" href="#__codelineno-23-135"></a><span class="go">Enter Number (0-7):0</span>
</span><span id="__span-23-136"><a id="__codelineno-23-136" name="__codelineno-23-136" href="#__codelineno-23-136"></a><span class="go">Thank you.</span>
</span></code></pre></div>
</details>
<h2 id="essential-software">Essential Software</h2>
<h3 id="basic-packages">Basic packages</h3>
<p>Before moving forward, I like to install a few basics that make work easier,
or on which subsequent packages depend:</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-24-1"><a id="__codelineno-24-1" name="__codelineno-24-1" href="#__codelineno-24-1"></a><span class="gp">$ </span>sudo<span class="w"> </span>apt<span class="w"> </span>update
</span><span id="__span-24-2"><a id="__codelineno-24-2" name="__codelineno-24-2" href="#__codelineno-24-2"></a><span class="gp">$ </span>sudo<span class="w"> </span>apt<span class="w"> </span>full-upgrade<span class="w"> </span>-y
</span><span id="__span-24-3"><a id="__codelineno-24-3" name="__codelineno-24-3" href="#__codelineno-24-3"></a><span class="gp">$ </span>sudo<span class="w"> </span>apt<span class="w"> </span>install<span class="w"> </span>-y<span class="w"> </span>bc<span class="w"> </span>git<span class="w"> </span>iotop-c<span class="w"> </span>netcat-openbsd<span class="w"> </span>rename<span class="w"> </span>speedtest-cli<span class="w"> </span><span class="se">\</span>
</span><span id="__span-24-4"><a id="__codelineno-24-4" name="__codelineno-24-4" href="#__codelineno-24-4"></a><span class="w">  </span>sysstat<span class="w"> </span>vim<span class="w"> </span>python3-pip<span class="w"> </span>python3-influxdb<span class="w"> </span>python3-numpy<span class="w"> </span>python3-absl<span class="w"> </span><span class="se">\</span>
</span><span id="__span-24-5"><a id="__codelineno-24-5" name="__codelineno-24-5" href="#__codelineno-24-5"></a><span class="w">  </span>python3-unidecode
</span></code></pre></div>
<h3 id="continuous-monitoring">Continuous Monitoring</h3>
<p><a href="../../../../../projects/conmon/">Continuous Monitoring</a> on this system needs only the
<a href="../../../../../projects/conmon/#conmon-st"><code>conmon-st</code></a> script to gather metrics,
since it will be reporting metrics to the
<a href="../../../../2024/04/20/monitoring-with-influxdb-and-grafana-on-kubernetes/">InfluxDB and Grafana on Kubernetes</a>
already setup on <code>lexicon</code>.</p>
<p>After <a href="../../../../../projects/conmon/#install-conmon">installing the service file</a>,
it is also necessary to add <code>User=pi</code> in the <code>[Service]</code> section.</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-25-1"><a id="__codelineno-25-1" name="__codelineno-25-1" href="#__codelineno-25-1"></a><span class="gp">$ </span>sudo<span class="w"> </span>systemctl<span class="w"> </span><span class="nb">enable</span><span class="w"> </span>conmon.service
</span><span id="__span-25-2"><a id="__codelineno-25-2" name="__codelineno-25-2" href="#__codelineno-25-2"></a><span class="gp">$ </span>sudo<span class="w"> </span>systemctl<span class="w"> </span>daemon-reload
</span><span id="__span-25-3"><a id="__codelineno-25-3" name="__codelineno-25-3" href="#__codelineno-25-3"></a><span class="gp">$ </span>sudo<span class="w"> </span>systemctl<span class="w"> </span>start<span class="w"> </span>conmon.service
</span><span id="__span-25-4"><a id="__codelineno-25-4" name="__codelineno-25-4" href="#__codelineno-25-4"></a><span class="gp">$ </span>sudo<span class="w"> </span>systemctl<span class="w"> </span>status<span class="w"> </span>conmon.service
</span></code></pre></div>
<h3 id="fail2ban">Fail2Ban</h3>
<p><a href="https://github.com/fail2ban/fail2ban?tab=readme-ov-file#fail2ban-ban-hosts-that-cause-multiple-authentication-errors">Fail2Ban</a>
scans log files and bans IP addresses conducting too many failed login attempts.
It is a rather basic protection mechanism, and this system is not intended to
have its SSH port open to the Internet, but it is so easy to install and enable
that there is no excuse not to.</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-26-1"><a id="__codelineno-26-1" name="__codelineno-26-1" href="#__codelineno-26-1"></a><span class="gp">$ </span>sudo<span class="w"> </span>apt-get<span class="w"> </span>install<span class="w"> </span>iptables<span class="w"> </span>fail2ban<span class="w"> </span>-y
</span><span id="__span-26-2"><a id="__codelineno-26-2" name="__codelineno-26-2" href="#__codelineno-26-2"></a><span class="gp">$ </span>sudo<span class="w"> </span>systemctl<span class="w"> </span><span class="nb">enable</span><span class="w"> </span>--now<span class="w"> </span>fail2ban
</span></code></pre></div>
<p>The configuration in <code>/etc/fail2ban/jail.conf</code> can be spiced up to make a
little more trigger-happy:</p>
<div class="language-ini highlight"><pre><span></span><code><span id="__span-27-1"><a id="__codelineno-27-1" name="__codelineno-27-1" href="#__codelineno-27-1"></a><span class="c1"># "bantime" is the number of seconds that a host is banned.</span>
</span><span id="__span-27-2"><a id="__codelineno-27-2" name="__codelineno-27-2" href="#__codelineno-27-2"></a><span class="na">bantime</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="s">12h</span>
</span><span id="__span-27-3"><a id="__codelineno-27-3" name="__codelineno-27-3" href="#__codelineno-27-3"></a><span class="c1"># A host is banned if it has generated "maxretry" during the last "findtime"</span>
</span><span id="__span-27-4"><a id="__codelineno-27-4" name="__codelineno-27-4" href="#__codelineno-27-4"></a><span class="c1"># seconds.</span>
</span><span id="__span-27-5"><a id="__codelineno-27-5" name="__codelineno-27-5" href="#__codelineno-27-5"></a><span class="na">findtime</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="s">90m</span>
</span><span id="__span-27-6"><a id="__codelineno-27-6" name="__codelineno-27-6" href="#__codelineno-27-6"></a><span class="c1"># "maxretry" is the number of failures before a host get banned.</span>
</span><span id="__span-27-7"><a id="__codelineno-27-7" name="__codelineno-27-7" href="#__codelineno-27-7"></a><span class="na">maxretry</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">3</span>
</span><span id="__span-27-8"><a id="__codelineno-27-8" name="__codelineno-27-8" href="#__codelineno-27-8"></a><span class="c1"># "bantime.increment" allows to use database for searching of previously banned ip's to increase a </span>
</span><span id="__span-27-9"><a id="__codelineno-27-9" name="__codelineno-27-9" href="#__codelineno-27-9"></a><span class="c1"># default ban time using special formula, default it is banTime * 1, 2, 4, 8, 16, 32...</span>
</span><span id="__span-27-10"><a id="__codelineno-27-10" name="__codelineno-27-10" href="#__codelineno-27-10"></a><span class="na">bantime.increment</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">true</span>
</span></code></pre></div>
<p>Then restart the service to pick the changes up:</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-28-1"><a id="__codelineno-28-1" name="__codelineno-28-1" href="#__codelineno-28-1"></a><span class="gp">$ </span>sudo<span class="w"> </span>systemctl<span class="w"> </span>restart<span class="w"> </span>fail2ban
</span></code></pre></div>
<h2 id="kubernetes">Kubernetes</h2>
<p><a href="https://devops.datenkollektiv.de/raspberry-pi-5-a-kubernetes-cluster.html">Raspberry Pi 5 - a Kubernetes cluster</a>
looks like installing Kubernetes on a Raspberry Pi is not any different than
installing it on Ubuntu Server, so we can essentially combine the latest
<a href="../../../../2024/05/12/single-node-kubernetes-cluster-on-ubuntu-studio-desktop-rapture/">Single-node Kubernetes cluster on Ubuntu Studio desktop (rapture)</a>
with the original, more detailed
<a href="../../../../2023/03/25/single-node-kubernetes-cluster-on-ubuntu-server-lexicon/">Single-node Kubernetes cluster on Ubuntu Server (lexicon)</a>, which
<em>should</em> mean <em>mostly</em> following
<a href="https://kubernetes.io/docs/">kubernetes.io/docs</a>
along with the combined learnings from having done this already twice.</p>
<h3 id="github-repository">GitHub Repository</h3>
<p>Kubernetes deployments for all servers are best kept in a revision controlled
<a href="../../../../2024/05/12/single-node-kubernetes-cluster-on-ubuntu-studio-desktop-rapture/#github-repository">GitHub repo</a>,
already in use since the last cluster was setup.
<a href="https://docs.github.com/en/authentication/connecting-to-github-with-ssh/generating-a-new-ssh-key-and-adding-it-to-the-ssh-agent#generating-a-new-ssh-key">Generate a new SSH key</a>,
<a href="https://docs.github.com/en/authentication/connecting-to-github-with-ssh/adding-a-new-ssh-key-to-your-github-account#adding-a-new-ssh-key-to-your-account">add it to the GitHub account</a>
as an <em>Authentication Key</em> and, instead of keeping separate directories for
each Kubernetes version, which seems to have been unnecessary, simply create
a directory per server and keep common files at the root:</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-29-1"><a id="__codelineno-29-1" name="__codelineno-29-1" href="#__codelineno-29-1"></a><span class="gp">$ </span>git<span class="w"> </span>clone<span class="w"> </span>git@github.com:xxxx/kubernetes-deployments.git
</span><span id="__span-29-2"><a id="__codelineno-29-2" name="__codelineno-29-2" href="#__codelineno-29-2"></a><span class="gp">$ </span><span class="nb">cd</span><span class="w"> </span>kubernetes-deployments/
</span><span id="__span-29-3"><a id="__codelineno-29-3" name="__codelineno-29-3" href="#__codelineno-29-3"></a><span class="gp">$ </span>mkdir<span class="w"> </span>alfred
</span></code></pre></div>
<h3 id="install-kubernetes">Install Kubernetes</h3>
<p>The <a href="https://cdn.dl.k8s.io/release/stable.txt">current stable release</a> is now
v1.32.<strong>2</strong> which is already the 3rd patch in 1.32, so we use this version to
<a href="https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/install-kubeadm/#installing-kubeadm-kubelet-and-kubectl">Installing kubeadm, kubelet and kubectl</a>
from Debian packages:</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-30-1"><a id="__codelineno-30-1" name="__codelineno-30-1" href="#__codelineno-30-1"></a><span class="gp">$ </span>curl<span class="w"> </span>-fsSL<span class="w"> </span>https://pkgs.k8s.io/core:/stable:/v1.32/deb/Release.key<span class="w"> </span><span class="se">\</span>
</span><span id="__span-30-2"><a id="__codelineno-30-2" name="__codelineno-30-2" href="#__codelineno-30-2"></a><span class="w">  </span><span class="p">|</span><span class="w"> </span>sudo<span class="w"> </span>gpg<span class="w"> </span>--dearmor<span class="w"> </span>-o<span class="w"> </span>/etc/apt/keyrings/kubernetes-apt-keyring.gpg
</span><span id="__span-30-3"><a id="__codelineno-30-3" name="__codelineno-30-3" href="#__codelineno-30-3"></a><span class="gp">$ </span>sudo<span class="w"> </span>chmod<span class="w"> </span><span class="m">644</span><span class="w"> </span>/etc/apt/keyrings/kubernetes-apt-keyring.gpg
</span><span id="__span-30-4"><a id="__codelineno-30-4" name="__codelineno-30-4" href="#__codelineno-30-4"></a><span class="gp">$ </span><span class="nb">echo</span><span class="w"> </span><span class="s1">'deb [signed-by=/etc/apt/keyrings/kubernetes-apt-keyring.gpg] https://pkgs.k8s.io/core:/stable:/v1.32/deb/ /'</span><span class="w"> </span><span class="se">\</span>
</span><span id="__span-30-5"><a id="__codelineno-30-5" name="__codelineno-30-5" href="#__codelineno-30-5"></a><span class="w">  </span><span class="p">|</span><span class="w"> </span>sudo<span class="w"> </span>tee<span class="w"> </span>/etc/apt/sources.list.d/kubernetes.list
</span><span id="__span-30-6"><a id="__codelineno-30-6" name="__codelineno-30-6" href="#__codelineno-30-6"></a><span class="gp">$ </span>sudo<span class="w"> </span>apt-get<span class="w"> </span>update
</span></code></pre></div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The "<code>/etc/apt/keyrings</code> already existed and the required packages were
already installed: <code>ca-certificates</code>, <code>curl</code>, <code>gnupg</code> (and
<code>apt-transport-https</code> is a dummy package).</p>
</div>
<p>Once the APT repository is ready, install the packages:</p>
<details class="terminal">
<summary><code>sudo apt-get install -y kubelet kubeadm kubectl</code></summary>
<div class="language-console highlight"><pre><span></span><code><span id="__span-31-1"><a id="__codelineno-31-1" name="__codelineno-31-1" href="#__codelineno-31-1"></a><span class="gp">$ </span>sudo<span class="w"> </span>apt-get<span class="w"> </span>install<span class="w"> </span>-y<span class="w"> </span>kubelet<span class="w"> </span>kubeadm<span class="w"> </span>kubectl
</span><span id="__span-31-2"><a id="__codelineno-31-2" name="__codelineno-31-2" href="#__codelineno-31-2"></a><span class="go">Reading package lists... Done</span>
</span><span id="__span-31-3"><a id="__codelineno-31-3" name="__codelineno-31-3" href="#__codelineno-31-3"></a><span class="go">Building dependency tree... Done</span>
</span><span id="__span-31-4"><a id="__codelineno-31-4" name="__codelineno-31-4" href="#__codelineno-31-4"></a><span class="go">Reading state information... Done</span>
</span><span id="__span-31-5"><a id="__codelineno-31-5" name="__codelineno-31-5" href="#__codelineno-31-5"></a><span class="go">The following additional packages will be installed:</span>
</span><span id="__span-31-6"><a id="__codelineno-31-6" name="__codelineno-31-6" href="#__codelineno-31-6"></a><span class="go">  conntrack cri-tools kubernetes-cni</span>
</span><span id="__span-31-7"><a id="__codelineno-31-7" name="__codelineno-31-7" href="#__codelineno-31-7"></a><span class="go">The following NEW packages will be installed:</span>
</span><span id="__span-31-8"><a id="__codelineno-31-8" name="__codelineno-31-8" href="#__codelineno-31-8"></a><span class="go">  conntrack cri-tools kubeadm kubectl kubelet kubernetes-cni</span>
</span><span id="__span-31-9"><a id="__codelineno-31-9" name="__codelineno-31-9" href="#__codelineno-31-9"></a><span class="go">0 upgraded, 6 newly installed, 0 to remove and 0 not upgraded.</span>
</span><span id="__span-31-10"><a id="__codelineno-31-10" name="__codelineno-31-10" href="#__codelineno-31-10"></a><span class="go">Need to get 83.4 MB of archives.</span>
</span><span id="__span-31-11"><a id="__codelineno-31-11" name="__codelineno-31-11" href="#__codelineno-31-11"></a><span class="go">After this operation, 330 MB of additional disk space will be used.</span>
</span><span id="__span-31-12"><a id="__codelineno-31-12" name="__codelineno-31-12" href="#__codelineno-31-12"></a><span class="go">Fetched 83.4 MB in 9s (9,047 kB/s)                                                                   </span>
</span><span id="__span-31-13"><a id="__codelineno-31-13" name="__codelineno-31-13" href="#__codelineno-31-13"></a><span class="go">Selecting previously unselected package conntrack.</span>
</span><span id="__span-31-14"><a id="__codelineno-31-14" name="__codelineno-31-14" href="#__codelineno-31-14"></a><span class="gp gp-VirtualEnv">(Reading database ... 83134 files and directories currently installed.)</span>
</span><span id="__span-31-15"><a id="__codelineno-31-15" name="__codelineno-31-15" href="#__codelineno-31-15"></a><span class="go">Preparing to unpack .../0-conntrack_1%3a1.4.7-1+b2_arm64.deb ...</span>
</span><span id="__span-31-16"><a id="__codelineno-31-16" name="__codelineno-31-16" href="#__codelineno-31-16"></a><span class="go">Unpacking conntrack (1:1.4.7-1+b2) ...</span>
</span><span id="__span-31-17"><a id="__codelineno-31-17" name="__codelineno-31-17" href="#__codelineno-31-17"></a><span class="go">Selecting previously unselected package cri-tools.</span>
</span><span id="__span-31-18"><a id="__codelineno-31-18" name="__codelineno-31-18" href="#__codelineno-31-18"></a><span class="go">Preparing to unpack .../1-cri-tools_1.32.0-1.1_arm64.deb ...</span>
</span><span id="__span-31-19"><a id="__codelineno-31-19" name="__codelineno-31-19" href="#__codelineno-31-19"></a><span class="go">Unpacking cri-tools (1.32.0-1.1) ...</span>
</span><span id="__span-31-20"><a id="__codelineno-31-20" name="__codelineno-31-20" href="#__codelineno-31-20"></a><span class="go">Selecting previously unselected package kubeadm.</span>
</span><span id="__span-31-21"><a id="__codelineno-31-21" name="__codelineno-31-21" href="#__codelineno-31-21"></a><span class="go">Preparing to unpack .../2-kubeadm_1.32.2-1.1_arm64.deb ...</span>
</span><span id="__span-31-22"><a id="__codelineno-31-22" name="__codelineno-31-22" href="#__codelineno-31-22"></a><span class="go">Unpacking kubeadm (1.32.2-1.1) ...</span>
</span><span id="__span-31-23"><a id="__codelineno-31-23" name="__codelineno-31-23" href="#__codelineno-31-23"></a><span class="go">Selecting previously unselected package kubectl.</span>
</span><span id="__span-31-24"><a id="__codelineno-31-24" name="__codelineno-31-24" href="#__codelineno-31-24"></a><span class="go">Preparing to unpack .../3-kubectl_1.32.2-1.1_arm64.deb ...</span>
</span><span id="__span-31-25"><a id="__codelineno-31-25" name="__codelineno-31-25" href="#__codelineno-31-25"></a><span class="go">Unpacking kubectl (1.32.2-1.1) ...</span>
</span><span id="__span-31-26"><a id="__codelineno-31-26" name="__codelineno-31-26" href="#__codelineno-31-26"></a><span class="go">Selecting previously unselected package kubernetes-cni.</span>
</span><span id="__span-31-27"><a id="__codelineno-31-27" name="__codelineno-31-27" href="#__codelineno-31-27"></a><span class="go">Preparing to unpack .../4-kubernetes-cni_1.6.0-1.1_arm64.deb ...</span>
</span><span id="__span-31-28"><a id="__codelineno-31-28" name="__codelineno-31-28" href="#__codelineno-31-28"></a><span class="go">Unpacking kubernetes-cni (1.6.0-1.1) ...</span>
</span><span id="__span-31-29"><a id="__codelineno-31-29" name="__codelineno-31-29" href="#__codelineno-31-29"></a><span class="go">Selecting previously unselected package kubelet.</span>
</span><span id="__span-31-30"><a id="__codelineno-31-30" name="__codelineno-31-30" href="#__codelineno-31-30"></a><span class="go">Preparing to unpack .../5-kubelet_1.32.2-1.1_arm64.deb ...</span>
</span><span id="__span-31-31"><a id="__codelineno-31-31" name="__codelineno-31-31" href="#__codelineno-31-31"></a><span class="go">Unpacking kubelet (1.32.2-1.1) ...</span>
</span><span id="__span-31-32"><a id="__codelineno-31-32" name="__codelineno-31-32" href="#__codelineno-31-32"></a><span class="go">Setting up conntrack (1:1.4.7-1+b2) ...</span>
</span><span id="__span-31-33"><a id="__codelineno-31-33" name="__codelineno-31-33" href="#__codelineno-31-33"></a><span class="go">Setting up kubectl (1.32.2-1.1) ...</span>
</span><span id="__span-31-34"><a id="__codelineno-31-34" name="__codelineno-31-34" href="#__codelineno-31-34"></a><span class="go">Setting up cri-tools (1.32.0-1.1) ...</span>
</span><span id="__span-31-35"><a id="__codelineno-31-35" name="__codelineno-31-35" href="#__codelineno-31-35"></a><span class="go">Setting up kubernetes-cni (1.6.0-1.1) ...</span>
</span><span id="__span-31-36"><a id="__codelineno-31-36" name="__codelineno-31-36" href="#__codelineno-31-36"></a><span class="go">Setting up kubeadm (1.32.2-1.1) ...</span>
</span><span id="__span-31-37"><a id="__codelineno-31-37" name="__codelineno-31-37" href="#__codelineno-31-37"></a><span class="go">Setting up kubelet (1.32.2-1.1) ...</span>
</span><span id="__span-31-38"><a id="__codelineno-31-38" name="__codelineno-31-38" href="#__codelineno-31-38"></a><span class="go">Processing triggers for man-db (2.11.2-2) ...</span>
</span></code></pre></div>
</details>
<p>And then, because updating Kubernetes is a rather involved process, <em>hold</em> them:</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-32-1"><a id="__codelineno-32-1" name="__codelineno-32-1" href="#__codelineno-32-1"></a><span class="gp">$ </span>sudo<span class="w"> </span>apt-mark<span class="w"> </span>hold<span class="w"> </span>kubelet<span class="w"> </span>kubeadm<span class="w"> </span>kubectl
</span></code></pre></div>
<p><a href="https://kubernetes.io/docs/tasks/tools/install-kubectl-linux/#enable-kubectl-autocompletion">Enabling shell autocompletion</a>
for <code>kubectl</code> is very easy, since <code>bash-completion</code> is already installed:</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-33-1"><a id="__codelineno-33-1" name="__codelineno-33-1" href="#__codelineno-33-1"></a><span class="gp">$ </span>kubectl<span class="w"> </span>completion<span class="w"> </span>bash<span class="w"> </span><span class="p">|</span><span class="w"> </span>sudo<span class="w"> </span>tee<span class="w"> </span>/etc/bash_completion.d/kubectl<span class="w"> </span>&gt;<span class="w"> </span>/dev/null
</span><span id="__span-33-2"><a id="__codelineno-33-2" name="__codelineno-33-2" href="#__codelineno-33-2"></a><span class="gp">$ </span>sudo<span class="w"> </span>chmod<span class="w"> </span>a+r<span class="w"> </span>/etc/bash_completion.d/kubectl
</span></code></pre></div>
<h4 id="enable-the-kubelet-service">Enable the kubelet service</h4>
<p>This step is only really necessary later, before
<a href="#bootstrap-with-kubeadm">bootstrapping the cluster with <code>kubeadm</code></a>,
but it can be done any time; the service will just be waiting:</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-34-1"><a id="__codelineno-34-1" name="__codelineno-34-1" href="#__codelineno-34-1"></a><span class="gp">$ </span>sudo<span class="w"> </span>systemctl<span class="w"> </span><span class="nb">enable</span><span class="w"> </span>--now<span class="w"> </span>kubelet
</span></code></pre></div>
<h3 id="install-container-runtime">Install container runtime</h3>
<h4 id="networking-setup">Networking setup</h4>
<p><a href="https://kubernetes.io/docs/setup/production-environment/container-runtimes/#prerequisite-ipv4-forwarding-optional">Enabling IPv4 packet forwarding</a>
appears to be the only required network setup for Kubernetes v1.32,
and this is already enabled in Rasberry Pi OS:</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-35-1"><a id="__codelineno-35-1" name="__codelineno-35-1" href="#__codelineno-35-1"></a><span class="gp">$ </span>sudo<span class="w"> </span>sysctl<span class="w"> </span>net.ipv4.ip_forward
</span><span id="__span-35-2"><a id="__codelineno-35-2" name="__codelineno-35-2" href="#__codelineno-35-2"></a><span class="go">net.ipv4.ip_forward = 1</span>
</span></code></pre></div>
<p>Even so, better to have this enabled explicitly now than to later have
<a href="../../../../2024/09/22/kubernetes-cluster-dns-issues/">Kubernetes cluster DNS issues</a>.</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-36-1"><a id="__codelineno-36-1" name="__codelineno-36-1" href="#__codelineno-36-1"></a><span class="gp">$ </span>cat<span class="w"> </span>&lt;&lt;EOF<span class="w"> </span><span class="p">|</span><span class="w"> </span>sudo<span class="w"> </span>tee<span class="w"> </span>/etc/sysctl.d/k8s.conf
</span><span id="__span-36-2"><a id="__codelineno-36-2" name="__codelineno-36-2" href="#__codelineno-36-2"></a><span class="go">net.ipv4.ip_forward = 1</span>
</span><span id="__span-36-3"><a id="__codelineno-36-3" name="__codelineno-36-3" href="#__codelineno-36-3"></a><span class="go">EOF</span>
</span><span id="__span-36-4"><a id="__codelineno-36-4" name="__codelineno-36-4" href="#__codelineno-36-4"></a>
</span><span id="__span-36-5"><a id="__codelineno-36-5" name="__codelineno-36-5" href="#__codelineno-36-5"></a><span class="gp">$ </span>sudo<span class="w"> </span>sysctl<span class="w"> </span>--system
</span></code></pre></div>
<p>However, this alone is not enough for the successful deployment of the
<a href="#network-plugin">Network plugin</a> required after bootstraping the cluster.</p>
<p>Ommitting the additional steps to
<a href="https://v1-29.docs.kubernetes.io/docs/setup/production-environment/container-runtimes/#forwarding-ipv4-and-letting-iptables-see-bridged-traffic">let iptables see bridged traffic</a>,
which seems to have been required only up to <strong>v1.29</strong>, would later result
in the <code>kube-flannel</code>
<a href="#troubleshooting-flannel">deployment failing to start up</a>
(stuck in a crash loop):</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-37-1"><a id="__codelineno-37-1" name="__codelineno-37-1" href="#__codelineno-37-1"></a><span class="gp">$ </span>sudo<span class="w"> </span>modprobe<span class="w"> </span>overlay
</span><span id="__span-37-2"><a id="__codelineno-37-2" name="__codelineno-37-2" href="#__codelineno-37-2"></a><span class="gp">$ </span>sudo<span class="w"> </span>modprobe<span class="w"> </span>br_netfilter
</span><span id="__span-37-3"><a id="__codelineno-37-3" name="__codelineno-37-3" href="#__codelineno-37-3"></a><span class="gp">$ </span>sudo<span class="w"> </span>tee<span class="w"> </span>/etc/modules-load.d/k8s.conf&lt;&lt;EOF
</span><span id="__span-37-4"><a id="__codelineno-37-4" name="__codelineno-37-4" href="#__codelineno-37-4"></a><span class="go">br_netfilter</span>
</span><span id="__span-37-5"><a id="__codelineno-37-5" name="__codelineno-37-5" href="#__codelineno-37-5"></a><span class="go">overlay</span>
</span><span id="__span-37-6"><a id="__codelineno-37-6" name="__codelineno-37-6" href="#__codelineno-37-6"></a><span class="go">EOF</span>
</span><span id="__span-37-7"><a id="__codelineno-37-7" name="__codelineno-37-7" href="#__codelineno-37-7"></a>
</span><span id="__span-37-8"><a id="__codelineno-37-8" name="__codelineno-37-8" href="#__codelineno-37-8"></a><span class="gp">$ </span>sudo<span class="w"> </span>tee<span class="w"> </span>/etc/sysctl.d/k8s.conf&lt;&lt;EOF
</span><span id="__span-37-9"><a id="__codelineno-37-9" name="__codelineno-37-9" href="#__codelineno-37-9"></a><span class="go">net.bridge.bridge-nf-call-ip6tables = 1</span>
</span><span id="__span-37-10"><a id="__codelineno-37-10" name="__codelineno-37-10" href="#__codelineno-37-10"></a><span class="go">net.bridge.bridge-nf-call-iptables = 1</span>
</span><span id="__span-37-11"><a id="__codelineno-37-11" name="__codelineno-37-11" href="#__codelineno-37-11"></a><span class="go">net.ipv4.ip_forward = 1</span>
</span><span id="__span-37-12"><a id="__codelineno-37-12" name="__codelineno-37-12" href="#__codelineno-37-12"></a><span class="go">EOF</span>
</span><span id="__span-37-13"><a id="__codelineno-37-13" name="__codelineno-37-13" href="#__codelineno-37-13"></a><span class="gp">$ </span>sudo<span class="w"> </span>sysctl<span class="w"> </span>--system
</span></code></pre></div>
<p>Reboot the system to make sure that the changes are permanent:</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-38-1"><a id="__codelineno-38-1" name="__codelineno-38-1" href="#__codelineno-38-1"></a><span class="gp">$ </span>sudo<span class="w"> </span>sysctl<span class="w"> </span>-a<span class="w"> </span><span class="p">|</span><span class="w"> </span>egrep<span class="w"> </span><span class="s1">'net.ipv4.ip_forward |net.bridge.bridge-nf-call-ip'</span>
</span><span id="__span-38-2"><a id="__codelineno-38-2" name="__codelineno-38-2" href="#__codelineno-38-2"></a><span class="go">net.bridge.bridge-nf-call-ip6tables = 1</span>
</span><span id="__span-38-3"><a id="__codelineno-38-3" name="__codelineno-38-3" href="#__codelineno-38-3"></a><span class="go">net.bridge.bridge-nf-call-iptables = 1</span>
</span><span id="__span-38-4"><a id="__codelineno-38-4" name="__codelineno-38-4" href="#__codelineno-38-4"></a><span class="go">net.ipv4.ip_forward = 1</span>
</span><span id="__span-38-5"><a id="__codelineno-38-5" name="__codelineno-38-5" href="#__codelineno-38-5"></a>
</span><span id="__span-38-6"><a id="__codelineno-38-6" name="__codelineno-38-6" href="#__codelineno-38-6"></a><span class="gp">$ </span>lsmod<span class="w"> </span><span class="p">|</span><span class="w"> </span>egrep<span class="w"> </span><span class="s1">'overlay|bridge'</span>
</span><span id="__span-38-7"><a id="__codelineno-38-7" name="__codelineno-38-7" href="#__codelineno-38-7"></a><span class="go">bridge                294912  1 br_netfilter</span>
</span><span id="__span-38-8"><a id="__codelineno-38-8" name="__codelineno-38-8" href="#__codelineno-38-8"></a><span class="go">stp                    49152  1 bridge</span>
</span><span id="__span-38-9"><a id="__codelineno-38-9" name="__codelineno-38-9" href="#__codelineno-38-9"></a><span class="go">llc                    49152  2 bridge,stp</span>
</span><span id="__span-38-10"><a id="__codelineno-38-10" name="__codelineno-38-10" href="#__codelineno-38-10"></a><span class="go">overlay               163840  11</span>
</span><span id="__span-38-11"><a id="__codelineno-38-11" name="__codelineno-38-11" href="#__codelineno-38-11"></a><span class="go">ipv6                  589824  58 bridge,br_netfilter</span>
</span></code></pre></div>
<h4 id="install-containerd">Install containerd</h4>
<p><a href="https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/install-kubeadm/#installing-runtime">Installing a container runtime</a>
comes next, with <code>containerd</code> being the runtime of choice.
<a href="https://docs.docker.com/engine/install/debian/#install-using-the-repository">Install using the <code>apt</code> repository</a>:</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-39-1"><a id="__codelineno-39-1" name="__codelineno-39-1" href="#__codelineno-39-1"></a><span class="gp">$ </span>sudo<span class="w"> </span>curl<span class="w"> </span>-fsSL<span class="w"> </span>https://download.docker.com/linux/debian/gpg<span class="w"> </span><span class="se">\</span>
</span><span id="__span-39-2"><a id="__codelineno-39-2" name="__codelineno-39-2" href="#__codelineno-39-2"></a><span class="w">  </span>-o<span class="w"> </span>/etc/apt/keyrings/docker.asc
</span><span id="__span-39-3"><a id="__codelineno-39-3" name="__codelineno-39-3" href="#__codelineno-39-3"></a><span class="gp">$ </span>sudo<span class="w"> </span>chmod<span class="w"> </span>a+r<span class="w"> </span>/etc/apt/keyrings/docker.asc
</span><span id="__span-39-4"><a id="__codelineno-39-4" name="__codelineno-39-4" href="#__codelineno-39-4"></a><span class="gp">$ </span><span class="nb">echo</span><span class="w"> </span><span class="se">\</span>
</span><span id="__span-39-5"><a id="__codelineno-39-5" name="__codelineno-39-5" href="#__codelineno-39-5"></a><span class="w">  </span><span class="s2">"deb [arch=</span><span class="k">$(</span>dpkg<span class="w"> </span>--print-architecture<span class="k">)</span><span class="s2"> signed-by=/etc/apt/keyrings/docker.asc] https://download.docker.com/linux/debian \</span>
</span><span id="__span-39-6"><a id="__codelineno-39-6" name="__codelineno-39-6" href="#__codelineno-39-6"></a><span class="gp">  $</span><span class="s2">(. /etc/os-release &amp;&amp; echo "</span><span class="nv">$VERSION_CODENAME</span><span class="s2">") stable"</span><span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="se">\</span>
</span><span id="__span-39-7"><a id="__codelineno-39-7" name="__codelineno-39-7" href="#__codelineno-39-7"></a><span class="w">  </span>sudo<span class="w"> </span>tee<span class="w"> </span>/etc/apt/sources.list.d/docker.list<span class="w"> </span>&gt;<span class="w"> </span>/dev/null
</span><span id="__span-39-8"><a id="__codelineno-39-8" name="__codelineno-39-8" href="#__codelineno-39-8"></a><span class="gp">$ </span>sudo<span class="w"> </span>apt-get<span class="w"> </span>update
</span></code></pre></div>
<p>Once the APT repository is ready, install the packages:</p>
<details class="terminal">
<summary><code>sudo apt-get install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin</code></summary>
<div class="language-console highlight"><pre><span></span><code><span id="__span-40-1"><a id="__codelineno-40-1" name="__codelineno-40-1" href="#__codelineno-40-1"></a><span class="gp">$ </span>sudo<span class="w"> </span>apt-get<span class="w"> </span>install<span class="w"> </span>-y<span class="w"> </span>docker-ce<span class="w"> </span>docker-ce-cli<span class="w"> </span>containerd.io<span class="w"> </span>docker-buildx-plugin<span class="w"> </span>docker-compose-plugin
</span><span id="__span-40-2"><a id="__codelineno-40-2" name="__codelineno-40-2" href="#__codelineno-40-2"></a><span class="go">Reading package lists... Done</span>
</span><span id="__span-40-3"><a id="__codelineno-40-3" name="__codelineno-40-3" href="#__codelineno-40-3"></a><span class="go">Building dependency tree... Done</span>
</span><span id="__span-40-4"><a id="__codelineno-40-4" name="__codelineno-40-4" href="#__codelineno-40-4"></a><span class="go">Reading state information... Done</span>
</span><span id="__span-40-5"><a id="__codelineno-40-5" name="__codelineno-40-5" href="#__codelineno-40-5"></a><span class="go">The following additional packages will be installed:</span>
</span><span id="__span-40-6"><a id="__codelineno-40-6" name="__codelineno-40-6" href="#__codelineno-40-6"></a><span class="go">  docker-ce-rootless-extras libltdl7 libslirp0 pigz slirp4netns</span>
</span><span id="__span-40-7"><a id="__codelineno-40-7" name="__codelineno-40-7" href="#__codelineno-40-7"></a><span class="go">Suggested packages:</span>
</span><span id="__span-40-8"><a id="__codelineno-40-8" name="__codelineno-40-8" href="#__codelineno-40-8"></a><span class="go">  cgroupfs-mount | cgroup-lite</span>
</span><span id="__span-40-9"><a id="__codelineno-40-9" name="__codelineno-40-9" href="#__codelineno-40-9"></a><span class="go">The following NEW packages will be installed:</span>
</span><span id="__span-40-10"><a id="__codelineno-40-10" name="__codelineno-40-10" href="#__codelineno-40-10"></a><span class="go">  containerd.io docker-buildx-plugin docker-ce docker-ce-cli docker-ce-rootless-extras</span>
</span><span id="__span-40-11"><a id="__codelineno-40-11" name="__codelineno-40-11" href="#__codelineno-40-11"></a><span class="go">  docker-compose-plugin libltdl7 libslirp0 pigz slirp4netns</span>
</span><span id="__span-40-12"><a id="__codelineno-40-12" name="__codelineno-40-12" href="#__codelineno-40-12"></a><span class="go">0 upgraded, 10 newly installed, 0 to remove and 0 not upgraded.</span>
</span><span id="__span-40-13"><a id="__codelineno-40-13" name="__codelineno-40-13" href="#__codelineno-40-13"></a><span class="go">Need to get 104 MB of archives.</span>
</span><span id="__span-40-14"><a id="__codelineno-40-14" name="__codelineno-40-14" href="#__codelineno-40-14"></a><span class="go">After this operation, 405 MB of additional disk space will be used.</span>
</span><span id="__span-40-15"><a id="__codelineno-40-15" name="__codelineno-40-15" href="#__codelineno-40-15"></a><span class="go">Fetched 104 MB in 9s (11.8 MB/)</span>
</span><span id="__span-40-16"><a id="__codelineno-40-16" name="__codelineno-40-16" href="#__codelineno-40-16"></a><span class="go">Selecting previously unselected package pigz.</span>
</span><span id="__span-40-17"><a id="__codelineno-40-17" name="__codelineno-40-17" href="#__codelineno-40-17"></a><span class="gp gp-VirtualEnv">(Reading database ... 83193 files and directories currently installed.)</span>
</span><span id="__span-40-18"><a id="__codelineno-40-18" name="__codelineno-40-18" href="#__codelineno-40-18"></a><span class="go">Preparing to unpack .../0-pigz_2.6-1_arm64.deb ...</span>
</span><span id="__span-40-19"><a id="__codelineno-40-19" name="__codelineno-40-19" href="#__codelineno-40-19"></a><span class="go">Unpacking pigz (2.6-1) ...</span>
</span><span id="__span-40-20"><a id="__codelineno-40-20" name="__codelineno-40-20" href="#__codelineno-40-20"></a><span class="go">Selecting previously unselected package containerd.io.</span>
</span><span id="__span-40-21"><a id="__codelineno-40-21" name="__codelineno-40-21" href="#__codelineno-40-21"></a><span class="go">Preparing to unpack .../1-containerd.io_1.7.25-1_arm64.deb ...</span>
</span><span id="__span-40-22"><a id="__codelineno-40-22" name="__codelineno-40-22" href="#__codelineno-40-22"></a><span class="go">Unpacking containerd.io (1.7.25-1) ...</span>
</span><span id="__span-40-23"><a id="__codelineno-40-23" name="__codelineno-40-23" href="#__codelineno-40-23"></a><span class="go">Selecting previously unselected package docker-buildx-plugin.</span>
</span><span id="__span-40-24"><a id="__codelineno-40-24" name="__codelineno-40-24" href="#__codelineno-40-24"></a><span class="go">Preparing to unpack .../2-docker-buildx-plugin_0.21.0-1~debian.12~bookworm_arm64.deb ...</span>
</span><span id="__span-40-25"><a id="__codelineno-40-25" name="__codelineno-40-25" href="#__codelineno-40-25"></a><span class="go">Unpacking docker-buildx-plugin (0.21.0-1~debian.12~bookworm) ...</span>
</span><span id="__span-40-26"><a id="__codelineno-40-26" name="__codelineno-40-26" href="#__codelineno-40-26"></a><span class="go">Selecting previously unselected package docker-ce-cli.</span>
</span><span id="__span-40-27"><a id="__codelineno-40-27" name="__codelineno-40-27" href="#__codelineno-40-27"></a><span class="go">Preparing to unpack .../3-docker-ce-cli_5%3a28.0.0-1~debian.12~bookworm_arm64.deb ...</span>
</span><span id="__span-40-28"><a id="__codelineno-40-28" name="__codelineno-40-28" href="#__codelineno-40-28"></a><span class="go">Unpacking docker-ce-cli (5:28.0.0-1~debian.12~bookworm) ...</span>
</span><span id="__span-40-29"><a id="__codelineno-40-29" name="__codelineno-40-29" href="#__codelineno-40-29"></a><span class="go">Selecting previously unselected package docker-ce.</span>
</span><span id="__span-40-30"><a id="__codelineno-40-30" name="__codelineno-40-30" href="#__codelineno-40-30"></a><span class="go">Preparing to unpack .../4-docker-ce_5%3a28.0.0-1~debian.12~bookworm_arm64.deb ...</span>
</span><span id="__span-40-31"><a id="__codelineno-40-31" name="__codelineno-40-31" href="#__codelineno-40-31"></a><span class="go">Unpacking docker-ce (5:28.0.0-1~debian.12~bookworm) ...</span>
</span><span id="__span-40-32"><a id="__codelineno-40-32" name="__codelineno-40-32" href="#__codelineno-40-32"></a><span class="go">Selecting previously unselected package docker-ce-rootless-extras.</span>
</span><span id="__span-40-33"><a id="__codelineno-40-33" name="__codelineno-40-33" href="#__codelineno-40-33"></a><span class="go">Preparing to unpack .../5-docker-ce-rootless-extras_5%3a28.0.0-1~debian.12~bookworm_arm64.deb ...</span>
</span><span id="__span-40-34"><a id="__codelineno-40-34" name="__codelineno-40-34" href="#__codelineno-40-34"></a><span class="go">Unpacking docker-ce-rootless-extras (5:28.0.0-1~debian.12~bookworm) ...</span>
</span><span id="__span-40-35"><a id="__codelineno-40-35" name="__codelineno-40-35" href="#__codelineno-40-35"></a><span class="go">Selecting previously unselected package docker-compose-plugin.</span>
</span><span id="__span-40-36"><a id="__codelineno-40-36" name="__codelineno-40-36" href="#__codelineno-40-36"></a><span class="go">Preparing to unpack .../6-docker-compose-plugin_2.33.0-1~debian.12~bookworm_arm64.deb ...</span>
</span><span id="__span-40-37"><a id="__codelineno-40-37" name="__codelineno-40-37" href="#__codelineno-40-37"></a><span class="go">Unpacking docker-compose-plugin (2.33.0-1~debian.12~bookworm) ...</span>
</span><span id="__span-40-38"><a id="__codelineno-40-38" name="__codelineno-40-38" href="#__codelineno-40-38"></a><span class="go">Selecting previously unselected package libltdl7:arm64.</span>
</span><span id="__span-40-39"><a id="__codelineno-40-39" name="__codelineno-40-39" href="#__codelineno-40-39"></a><span class="go">Preparing to unpack .../7-libltdl7_2.4.7-7~deb12u1_arm64.deb ...</span>
</span><span id="__span-40-40"><a id="__codelineno-40-40" name="__codelineno-40-40" href="#__codelineno-40-40"></a><span class="go">Unpacking libltdl7:arm64 (2.4.7-7~deb12u1) ...</span>
</span><span id="__span-40-41"><a id="__codelineno-40-41" name="__codelineno-40-41" href="#__codelineno-40-41"></a><span class="go">Selecting previously unselected package libslirp0:arm64.</span>
</span><span id="__span-40-42"><a id="__codelineno-40-42" name="__codelineno-40-42" href="#__codelineno-40-42"></a><span class="go">Preparing to unpack .../8-libslirp0_4.7.0-1_arm64.deb ...</span>
</span><span id="__span-40-43"><a id="__codelineno-40-43" name="__codelineno-40-43" href="#__codelineno-40-43"></a><span class="go">Unpacking libslirp0:arm64 (4.7.0-1) ...</span>
</span><span id="__span-40-44"><a id="__codelineno-40-44" name="__codelineno-40-44" href="#__codelineno-40-44"></a><span class="go">Selecting previously unselected package slirp4netns.</span>
</span><span id="__span-40-45"><a id="__codelineno-40-45" name="__codelineno-40-45" href="#__codelineno-40-45"></a><span class="go">Preparing to unpack .../9-slirp4netns_1.2.0-1_arm64.deb ...</span>
</span><span id="__span-40-46"><a id="__codelineno-40-46" name="__codelineno-40-46" href="#__codelineno-40-46"></a><span class="go">Unpacking slirp4netns (1.2.0-1) ...</span>
</span><span id="__span-40-47"><a id="__codelineno-40-47" name="__codelineno-40-47" href="#__codelineno-40-47"></a><span class="go">Setting up docker-buildx-plugin (0.21.0-1~debian.12~bookworm) ...</span>
</span><span id="__span-40-48"><a id="__codelineno-40-48" name="__codelineno-40-48" href="#__codelineno-40-48"></a><span class="go">Setting up containerd.io (1.7.25-1) ...</span>
</span><span id="__span-40-49"><a id="__codelineno-40-49" name="__codelineno-40-49" href="#__codelineno-40-49"></a><span class="go">Created symlink /etc/systemd/system/multi-user.target.wants/containerd.service  /lib/systemd/system/containerd.service.</span>
</span><span id="__span-40-50"><a id="__codelineno-40-50" name="__codelineno-40-50" href="#__codelineno-40-50"></a><span class="go">Setting up docker-compose-plugin (2.33.0-1~debian.12~bookworm) ...</span>
</span><span id="__span-40-51"><a id="__codelineno-40-51" name="__codelineno-40-51" href="#__codelineno-40-51"></a><span class="go">Setting up libltdl7:arm64 (2.4.7-7~deb12u1) ...</span>
</span><span id="__span-40-52"><a id="__codelineno-40-52" name="__codelineno-40-52" href="#__codelineno-40-52"></a><span class="go">Setting up docker-ce-cli (5:28.0.0-1~debian.12~bookworm) ...</span>
</span><span id="__span-40-53"><a id="__codelineno-40-53" name="__codelineno-40-53" href="#__codelineno-40-53"></a><span class="go">Setting up libslirp0:arm64 (4.7.0-1) ...</span>
</span><span id="__span-40-54"><a id="__codelineno-40-54" name="__codelineno-40-54" href="#__codelineno-40-54"></a><span class="go">Setting up pigz (2.6-1) ...</span>
</span><span id="__span-40-55"><a id="__codelineno-40-55" name="__codelineno-40-55" href="#__codelineno-40-55"></a><span class="go">Setting up docker-ce-rootless-extras (5:28.0.0-1~debian.12~bookworm) ...</span>
</span><span id="__span-40-56"><a id="__codelineno-40-56" name="__codelineno-40-56" href="#__codelineno-40-56"></a><span class="go">Setting up slirp4netns (1.2.0-1) ...</span>
</span><span id="__span-40-57"><a id="__codelineno-40-57" name="__codelineno-40-57" href="#__codelineno-40-57"></a><span class="go">Setting up docker-ce (5:28.0.0-1~debian.12~bookworm) ...</span>
</span><span id="__span-40-58"><a id="__codelineno-40-58" name="__codelineno-40-58" href="#__codelineno-40-58"></a><span class="go">Created symlink /etc/systemd/system/multi-user.target.wants/docker.service  /lib/systemd/system/docker.service.</span>
</span><span id="__span-40-59"><a id="__codelineno-40-59" name="__codelineno-40-59" href="#__codelineno-40-59"></a><span class="go">Created symlink /etc/systemd/system/sockets.target.wants/docker.socket  /lib/systemd/system/docker.socket.</span>
</span><span id="__span-40-60"><a id="__codelineno-40-60" name="__codelineno-40-60" href="#__codelineno-40-60"></a><span class="go">Processing triggers for man-db (2.11.2-2) ...</span>
</span><span id="__span-40-61"><a id="__codelineno-40-61" name="__codelineno-40-61" href="#__codelineno-40-61"></a><span class="go">Processing triggers for libc-bin (2.36-9+rpt2+deb12u9) ...</span>
</span></code></pre></div>
</details>
<p>In just a few moments <code>docker</code> is already running:</p>
<details class="terminal">
<summary><code>systemctl status docker</code></summary>
<div class="language-console highlight"><pre><span></span><code><span id="__span-41-1"><a id="__codelineno-41-1" name="__codelineno-41-1" href="#__codelineno-41-1"></a><span class="gp">$ </span>systemctl<span class="w"> </span>status<span class="w"> </span>docker
</span><span id="__span-41-2"><a id="__codelineno-41-2" name="__codelineno-41-2" href="#__codelineno-41-2"></a><span class="go"> docker.service - Docker Application Container Engine</span>
</span><span id="__span-41-3"><a id="__codelineno-41-3" name="__codelineno-41-3" href="#__codelineno-41-3"></a><span class="go">    Loaded: loaded (/lib/systemd/system/docker.service; enabled; preset: enabled)</span>
</span><span id="__span-41-4"><a id="__codelineno-41-4" name="__codelineno-41-4" href="#__codelineno-41-4"></a><span class="go">    Active: active (running) since Sat 2025-02-22 14:45:10 CET; 1min 58s ago</span>
</span><span id="__span-41-5"><a id="__codelineno-41-5" name="__codelineno-41-5" href="#__codelineno-41-5"></a><span class="go">TriggeredBy:  docker.socket</span>
</span><span id="__span-41-6"><a id="__codelineno-41-6" name="__codelineno-41-6" href="#__codelineno-41-6"></a><span class="go">      Docs: https://docs.docker.com</span>
</span><span id="__span-41-7"><a id="__codelineno-41-7" name="__codelineno-41-7" href="#__codelineno-41-7"></a><span class="go">  Main PID: 272049 (dockerd)</span>
</span><span id="__span-41-8"><a id="__codelineno-41-8" name="__codelineno-41-8" href="#__codelineno-41-8"></a><span class="go">      Tasks: 10</span>
</span><span id="__span-41-9"><a id="__codelineno-41-9" name="__codelineno-41-9" href="#__codelineno-41-9"></a><span class="go">        CPU: 179ms</span>
</span><span id="__span-41-10"><a id="__codelineno-41-10" name="__codelineno-41-10" href="#__codelineno-41-10"></a><span class="go">    CGroup: /system.slice/docker.service</span>
</span><span id="__span-41-11"><a id="__codelineno-41-11" name="__codelineno-41-11" href="#__codelineno-41-11"></a><span class="go">            272049 /usr/bin/dockerd -H fd:// --containerd=/run/containerd/containerd.sock</span>
</span><span id="__span-41-12"><a id="__codelineno-41-12" name="__codelineno-41-12" href="#__codelineno-41-12"></a>
</span><span id="__span-41-13"><a id="__codelineno-41-13" name="__codelineno-41-13" href="#__codelineno-41-13"></a><span class="go">Feb 22 14:45:10 alfred dockerd[272049]: time="2025-02-22T14:45:10.298075305+01:00" level=info msg="Loading containers: start."</span>
</span><span id="__span-41-14"><a id="__codelineno-41-14" name="__codelineno-41-14" href="#__codelineno-41-14"></a><span class="go">Feb 22 14:45:10 alfred dockerd[272049]: time="2025-02-22T14:45:10.482322273+01:00" level=info msg="Loading containers: done."</span>
</span><span id="__span-41-15"><a id="__codelineno-41-15" name="__codelineno-41-15" href="#__codelineno-41-15"></a><span class="go">Feb 22 14:45:10 alfred dockerd[272049]: time="2025-02-22T14:45:10.493322483+01:00" level=warning msg="WARNING: No memory limit support"</span>
</span><span id="__span-41-16"><a id="__codelineno-41-16" name="__codelineno-41-16" href="#__codelineno-41-16"></a><span class="go">Feb 22 14:45:10 alfred dockerd[272049]: time="2025-02-22T14:45:10.493351206+01:00" level=warning msg="WARNING: No swap limit support"</span>
</span><span id="__span-41-17"><a id="__codelineno-41-17" name="__codelineno-41-17" href="#__codelineno-41-17"></a><span class="go">Feb 22 14:45:10 alfred dockerd[272049]: time="2025-02-22T14:45:10.493375243+01:00" level=info msg="Docker daemon" commit=af898ab containerd-snapshotter=false storage-driver=overlay2 version=28.0.0</span>
</span><span id="__span-41-18"><a id="__codelineno-41-18" name="__codelineno-41-18" href="#__codelineno-41-18"></a><span class="go">Feb 22 14:45:10 alfred dockerd[272049]: time="2025-02-22T14:45:10.493479613+01:00" level=info msg="Initializing buildkit"</span>
</span><span id="__span-41-19"><a id="__codelineno-41-19" name="__codelineno-41-19" href="#__codelineno-41-19"></a><span class="go">Feb 22 14:45:10 alfred dockerd[272049]: time="2025-02-22T14:45:10.538199044+01:00" level=info msg="Completed buildkit initialization"</span>
</span><span id="__span-41-20"><a id="__codelineno-41-20" name="__codelineno-41-20" href="#__codelineno-41-20"></a><span class="go">Feb 22 14:45:10 alfred dockerd[272049]: time="2025-02-22T14:45:10.543738454+01:00" level=info msg="Daemon has completed initialization"</span>
</span><span id="__span-41-21"><a id="__codelineno-41-21" name="__codelineno-41-21" href="#__codelineno-41-21"></a><span class="go">Feb 22 14:45:10 alfred systemd[1]: Started docker.service - Docker Application Container Engine.</span>
</span><span id="__span-41-22"><a id="__codelineno-41-22" name="__codelineno-41-22" href="#__codelineno-41-22"></a><span class="go">Feb 22 14:45:10 alfred dockerd[272049]: time="2025-02-22T14:45:10.543810435+01:00" level=info msg="API listen on /run/docker.sock"</span>
</span></code></pre></div>
</details>
<p>The server is indeed reachable and its version can be checked:</p>
<details class="terminal">
<summary><code>sudo docker version</code></summary>
<div class="language-console highlight"><pre><span></span><code><span id="__span-42-1"><a id="__codelineno-42-1" name="__codelineno-42-1" href="#__codelineno-42-1"></a><span class="gp">$ </span>sudo<span class="w"> </span>docker<span class="w"> </span>version
</span><span id="__span-42-2"><a id="__codelineno-42-2" name="__codelineno-42-2" href="#__codelineno-42-2"></a><span class="go">Client: Docker Engine - Community</span>
</span><span id="__span-42-3"><a id="__codelineno-42-3" name="__codelineno-42-3" href="#__codelineno-42-3"></a><span class="go">Version:           28.0.0</span>
</span><span id="__span-42-4"><a id="__codelineno-42-4" name="__codelineno-42-4" href="#__codelineno-42-4"></a><span class="go">API version:       1.48</span>
</span><span id="__span-42-5"><a id="__codelineno-42-5" name="__codelineno-42-5" href="#__codelineno-42-5"></a><span class="go">Go version:        go1.23.6</span>
</span><span id="__span-42-6"><a id="__codelineno-42-6" name="__codelineno-42-6" href="#__codelineno-42-6"></a><span class="go">Git commit:        f9ced58</span>
</span><span id="__span-42-7"><a id="__codelineno-42-7" name="__codelineno-42-7" href="#__codelineno-42-7"></a><span class="go">Built:             Wed Feb 19 22:10:37 2025</span>
</span><span id="__span-42-8"><a id="__codelineno-42-8" name="__codelineno-42-8" href="#__codelineno-42-8"></a><span class="go">OS/Arch:           linux/arm64</span>
</span><span id="__span-42-9"><a id="__codelineno-42-9" name="__codelineno-42-9" href="#__codelineno-42-9"></a><span class="go">Context:           default</span>
</span><span id="__span-42-10"><a id="__codelineno-42-10" name="__codelineno-42-10" href="#__codelineno-42-10"></a>
</span><span id="__span-42-11"><a id="__codelineno-42-11" name="__codelineno-42-11" href="#__codelineno-42-11"></a><span class="go">Server: Docker Engine - Community</span>
</span><span id="__span-42-12"><a id="__codelineno-42-12" name="__codelineno-42-12" href="#__codelineno-42-12"></a><span class="go">Engine:</span>
</span><span id="__span-42-13"><a id="__codelineno-42-13" name="__codelineno-42-13" href="#__codelineno-42-13"></a><span class="go">  Version:          28.0.0</span>
</span><span id="__span-42-14"><a id="__codelineno-42-14" name="__codelineno-42-14" href="#__codelineno-42-14"></a><span class="go">  API version:      1.48 (minimum version 1.24)</span>
</span><span id="__span-42-15"><a id="__codelineno-42-15" name="__codelineno-42-15" href="#__codelineno-42-15"></a><span class="go">  Go version:       go1.23.6</span>
</span><span id="__span-42-16"><a id="__codelineno-42-16" name="__codelineno-42-16" href="#__codelineno-42-16"></a><span class="go">  Git commit:       af898ab</span>
</span><span id="__span-42-17"><a id="__codelineno-42-17" name="__codelineno-42-17" href="#__codelineno-42-17"></a><span class="go">  Built:            Wed Feb 19 22:10:37 2025</span>
</span><span id="__span-42-18"><a id="__codelineno-42-18" name="__codelineno-42-18" href="#__codelineno-42-18"></a><span class="go">  OS/Arch:          linux/arm64</span>
</span><span id="__span-42-19"><a id="__codelineno-42-19" name="__codelineno-42-19" href="#__codelineno-42-19"></a><span class="go">  Experimental:     false</span>
</span><span id="__span-42-20"><a id="__codelineno-42-20" name="__codelineno-42-20" href="#__codelineno-42-20"></a><span class="go">containerd:</span>
</span><span id="__span-42-21"><a id="__codelineno-42-21" name="__codelineno-42-21" href="#__codelineno-42-21"></a><span class="go">  Version:          1.7.25</span>
</span><span id="__span-42-22"><a id="__codelineno-42-22" name="__codelineno-42-22" href="#__codelineno-42-22"></a><span class="go">  GitCommit:        bcc810d6b9066471b0b6fa75f557a15a1cbf31bb</span>
</span><span id="__span-42-23"><a id="__codelineno-42-23" name="__codelineno-42-23" href="#__codelineno-42-23"></a><span class="go">runc:</span>
</span><span id="__span-42-24"><a id="__codelineno-42-24" name="__codelineno-42-24" href="#__codelineno-42-24"></a><span class="go">  Version:          1.2.4</span>
</span><span id="__span-42-25"><a id="__codelineno-42-25" name="__codelineno-42-25" href="#__codelineno-42-25"></a><span class="go">  GitCommit:        v1.2.4-0-g6c52b3f</span>
</span><span id="__span-42-26"><a id="__codelineno-42-26" name="__codelineno-42-26" href="#__codelineno-42-26"></a><span class="go">docker-init:</span>
</span><span id="__span-42-27"><a id="__codelineno-42-27" name="__codelineno-42-27" href="#__codelineno-42-27"></a><span class="go">  Version:          0.19.0</span>
</span><span id="__span-42-28"><a id="__codelineno-42-28" name="__codelineno-42-28" href="#__codelineno-42-28"></a><span class="go">  GitCommit:        de40ad0</span>
</span></code></pre></div>
</details>
<p>And the basic <code>hello-world</code> example <em>just works</em>:</p>
<details class="terminal">
<summary><code>sudo docker run hello-world</code></summary>
<div class="language-console highlight"><pre><span></span><code><span id="__span-43-1"><a id="__codelineno-43-1" name="__codelineno-43-1" href="#__codelineno-43-1"></a><span class="gp">$ </span>sudo<span class="w"> </span>docker<span class="w"> </span>run<span class="w"> </span>hello-world
</span><span id="__span-43-2"><a id="__codelineno-43-2" name="__codelineno-43-2" href="#__codelineno-43-2"></a><span class="go">Unable to find image 'hello-world:latest' locally</span>
</span><span id="__span-43-3"><a id="__codelineno-43-3" name="__codelineno-43-3" href="#__codelineno-43-3"></a><span class="go">latest: Pulling from library/hello-world</span>
</span><span id="__span-43-4"><a id="__codelineno-43-4" name="__codelineno-43-4" href="#__codelineno-43-4"></a><span class="go">c9c5fd25a1bd: Pull complete </span>
</span><span id="__span-43-5"><a id="__codelineno-43-5" name="__codelineno-43-5" href="#__codelineno-43-5"></a><span class="go">Digest: sha256:e0b569a5163a5e6be84e210a2587e7d447e08f87a0e90798363fa44a0464a1e8</span>
</span><span id="__span-43-6"><a id="__codelineno-43-6" name="__codelineno-43-6" href="#__codelineno-43-6"></a><span class="go">Status: Downloaded newer image for hello-world:latest</span>
</span><span id="__span-43-7"><a id="__codelineno-43-7" name="__codelineno-43-7" href="#__codelineno-43-7"></a>
</span><span id="__span-43-8"><a id="__codelineno-43-8" name="__codelineno-43-8" href="#__codelineno-43-8"></a><span class="go">Hello from Docker!</span>
</span><span id="__span-43-9"><a id="__codelineno-43-9" name="__codelineno-43-9" href="#__codelineno-43-9"></a><span class="go">This message shows that your installation appears to be working correctly.</span>
</span><span id="__span-43-10"><a id="__codelineno-43-10" name="__codelineno-43-10" href="#__codelineno-43-10"></a>
</span><span id="__span-43-11"><a id="__codelineno-43-11" name="__codelineno-43-11" href="#__codelineno-43-11"></a><span class="go">To generate this message, Docker took the following steps:</span>
</span><span id="__span-43-12"><a id="__codelineno-43-12" name="__codelineno-43-12" href="#__codelineno-43-12"></a><span class="go">1. The Docker client contacted the Docker daemon.</span>
</span><span id="__span-43-13"><a id="__codelineno-43-13" name="__codelineno-43-13" href="#__codelineno-43-13"></a><span class="go">2. The Docker daemon pulled the "hello-world" image from the Docker Hub.</span>
</span><span id="__span-43-14"><a id="__codelineno-43-14" name="__codelineno-43-14" href="#__codelineno-43-14"></a><span class="go">    (arm64v8)</span>
</span><span id="__span-43-15"><a id="__codelineno-43-15" name="__codelineno-43-15" href="#__codelineno-43-15"></a><span class="go">3. The Docker daemon created a new container from that image which runs the</span>
</span><span id="__span-43-16"><a id="__codelineno-43-16" name="__codelineno-43-16" href="#__codelineno-43-16"></a><span class="go">    executable that produces the output you are currently reading.</span>
</span><span id="__span-43-17"><a id="__codelineno-43-17" name="__codelineno-43-17" href="#__codelineno-43-17"></a><span class="go">4. The Docker daemon streamed that output to the Docker client, which sent it</span>
</span><span id="__span-43-18"><a id="__codelineno-43-18" name="__codelineno-43-18" href="#__codelineno-43-18"></a><span class="go">    to your terminal.</span>
</span><span id="__span-43-19"><a id="__codelineno-43-19" name="__codelineno-43-19" href="#__codelineno-43-19"></a>
</span><span id="__span-43-20"><a id="__codelineno-43-20" name="__codelineno-43-20" href="#__codelineno-43-20"></a><span class="go">To try something more ambitious, you can run an Ubuntu container with:</span>
</span><span id="__span-43-21"><a id="__codelineno-43-21" name="__codelineno-43-21" href="#__codelineno-43-21"></a><span class="gp">$ </span>docker<span class="w"> </span>run<span class="w"> </span>-it<span class="w"> </span>ubuntu<span class="w"> </span>bash
</span><span id="__span-43-22"><a id="__codelineno-43-22" name="__codelineno-43-22" href="#__codelineno-43-22"></a>
</span><span id="__span-43-23"><a id="__codelineno-43-23" name="__codelineno-43-23" href="#__codelineno-43-23"></a><span class="go">Share images, automate workflows, and more with a free Docker ID:</span>
</span><span id="__span-43-24"><a id="__codelineno-43-24" name="__codelineno-43-24" href="#__codelineno-43-24"></a><span class="go">https://hub.docker.com/</span>
</span><span id="__span-43-25"><a id="__codelineno-43-25" name="__codelineno-43-25" href="#__codelineno-43-25"></a>
</span><span id="__span-43-26"><a id="__codelineno-43-26" name="__codelineno-43-26" href="#__codelineno-43-26"></a><span class="go">For more examples and ideas, visit:</span>
</span><span id="__span-43-27"><a id="__codelineno-43-27" name="__codelineno-43-27" href="#__codelineno-43-27"></a><span class="go">https://docs.docker.com/get-started/</span>
</span></code></pre></div>
</details>
<h5 id="configure-containerd-for-kubernetes">Configure <code>containerd</code> for Kubernetes</h5>
<p>The default configutation that comes with <code>containerd</code>, at least when
installed from the APT repository, needs two adjustments to work with
Kubernetes</p>
<ol>
<li>Enable the use of <a href="https://kubernetes.io/docs/setup/production-environment/container-runtimes/#systemd-cgroup-driver"><code>systemd</code> cgroup driver</a>,
   because Debian 12 (bookworm) uses both <code>systemd</code> and
   <a href="https://kubernetes.io/docs/concepts/architecture/cgroups/#using-cgroupv2">cgroup v2</a>.</li>
<li>Enable CRI integration, which is disabled in <code>/etc/containerd/config.toml</code>,
   but is needed to use <code>containerd</code> with Kubernetes.</li>
</ol>
<p>The safest method to set these configurations is to do it based off of the
default configuration:</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-44-1"><a id="__codelineno-44-1" name="__codelineno-44-1" href="#__codelineno-44-1"></a><span class="gp">$ </span>containerd<span class="w"> </span>config<span class="w"> </span>default<span class="w"> </span><span class="se">\</span>
</span><span id="__span-44-2"><a id="__codelineno-44-2" name="__codelineno-44-2" href="#__codelineno-44-2"></a><span class="w"> </span><span class="p">|</span><span class="w"> </span>sed<span class="w"> </span><span class="s1">'s/disabled_plugins.*/disabled_plugins = []/'</span><span class="w"> </span><span class="se">\</span>
</span><span id="__span-44-3"><a id="__codelineno-44-3" name="__codelineno-44-3" href="#__codelineno-44-3"></a><span class="w"> </span><span class="p">|</span><span class="w"> </span>sed<span class="w"> </span><span class="s1">'s/SystemdCgroup = false/SystemdCgroup = true/'</span><span class="w"> </span><span class="se">\</span>
</span><span id="__span-44-4"><a id="__codelineno-44-4" name="__codelineno-44-4" href="#__codelineno-44-4"></a><span class="w"> </span><span class="p">|</span><span class="w"> </span>sudo<span class="w"> </span>tee<span class="w"> </span>/etc/containerd/config.toml<span class="w"> </span>&gt;<span class="w"> </span>/dev/null
</span><span id="__span-44-5"><a id="__codelineno-44-5" name="__codelineno-44-5" href="#__codelineno-44-5"></a>
</span><span id="__span-44-6"><a id="__codelineno-44-6" name="__codelineno-44-6" href="#__codelineno-44-6"></a><span class="gp">$ </span>sudo<span class="w"> </span>systemctl<span class="w"> </span>restart<span class="w"> </span>containerd
</span></code></pre></div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>There is no need to manually configure the cgroup driver for <code>kubelet</code>
because, already since v1.22, <code>kubeadm</code> defaults it to <code>systemd</code>.</p>
</div>
<p>Installing Raspberry Pi OS uses most of the disk for the root partition,
so there is plenty of space under <code>/var</code> (unlike in my PCs).</p>
<h3 id="bootstrap-with-kubeadm">Bootstrap with <code>kubeadm</code></h3>
<p><a href="https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/create-cluster-kubeadm/">Creating a cluster with kubeadm</a>
is the next big step towards <em>creating</em> the Kubernetes cluster.</p>
<h4 id="initialize-control-plane">Initialize control-plane</h4>
<p>Having reviewed the requirements and installed all the components already,
<a href="https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/create-cluster-kubeadm/#initializing-your-control-plane-node">initialize the control-plane node</a>
with the following flags:</p>
<ul>
<li><code>--cri-socket=unix:/run/containerd/containerd.sock</code> to make sure Kubernetes
   uses the containerd runtime.</li>
<li><code>--pod-network-cidr=10.244.0.0/16</code> as 
   <a href="https://github.com/flannel-io/flannel/blob/master/Documentation/kubernetes.md">required by flannel</a>,
   which is the <a href="#network-plugin">network plugin</a> to be installed later.</li>
</ul>
<details class="terminal">
<summary><code>sudo kubeadm init</code></summary>
<div class="language-console highlight"><pre><span></span><code><span id="__span-45-1"><a id="__codelineno-45-1" name="__codelineno-45-1" href="#__codelineno-45-1"></a><span class="gp">$ </span>sudo<span class="w"> </span>kubeadm<span class="w"> </span>init<span class="w"> </span><span class="se">\</span>
</span><span id="__span-45-2"><a id="__codelineno-45-2" name="__codelineno-45-2" href="#__codelineno-45-2"></a><span class="w">  </span>--cri-socket<span class="o">=</span>unix:/run/containerd/containerd.sock<span class="w"> </span><span class="se">\</span>
</span><span id="__span-45-3"><a id="__codelineno-45-3" name="__codelineno-45-3" href="#__codelineno-45-3"></a><span class="w">  </span>--pod-network-cidr<span class="o">=</span><span class="m">10</span>.244.0.0/16
</span><span id="__span-45-4"><a id="__codelineno-45-4" name="__codelineno-45-4" href="#__codelineno-45-4"></a><span class="go">[init] Using Kubernetes version: v1.32.2</span>
</span><span id="__span-45-5"><a id="__codelineno-45-5" name="__codelineno-45-5" href="#__codelineno-45-5"></a><span class="go">[preflight] Running pre-flight checks</span>
</span><span id="__span-45-6"><a id="__codelineno-45-6" name="__codelineno-45-6" href="#__codelineno-45-6"></a><span class="go">        [WARNING SystemVerification]: missing optional cgroups: hugetlb</span>
</span><span id="__span-45-7"><a id="__codelineno-45-7" name="__codelineno-45-7" href="#__codelineno-45-7"></a><span class="go">[preflight] Pulling images required for setting up a Kubernetes cluster</span>
</span><span id="__span-45-8"><a id="__codelineno-45-8" name="__codelineno-45-8" href="#__codelineno-45-8"></a><span class="go">[preflight] This might take a minute or two, depending on the speed of your internet connection</span>
</span><span id="__span-45-9"><a id="__codelineno-45-9" name="__codelineno-45-9" href="#__codelineno-45-9"></a><span class="go">[preflight] You can also perform this action beforehand using 'kubeadm config images pull'</span>
</span><span id="__span-45-10"><a id="__codelineno-45-10" name="__codelineno-45-10" href="#__codelineno-45-10"></a><span class="go">W0222 18:06:17.311306   23707 checks.go:846] detected that the sandbox image "registry.k8s.io/pause:3.8" of the container runtime is inconsistent with that used by kubeadm.It is recommended to use "registry.k8s.io/pause:3.10" as the CRI sandbox image.</span>
</span><span id="__span-45-11"><a id="__codelineno-45-11" name="__codelineno-45-11" href="#__codelineno-45-11"></a><span class="go">[certs] Using certificateDir folder "/etc/kubernetes/pki"</span>
</span><span id="__span-45-12"><a id="__codelineno-45-12" name="__codelineno-45-12" href="#__codelineno-45-12"></a><span class="go">[certs] Generating "ca" certificate and key</span>
</span><span id="__span-45-13"><a id="__codelineno-45-13" name="__codelineno-45-13" href="#__codelineno-45-13"></a><span class="go">[certs] Generating "apiserver" certificate and key</span>
</span><span id="__span-45-14"><a id="__codelineno-45-14" name="__codelineno-45-14" href="#__codelineno-45-14"></a><span class="go">[certs] apiserver serving cert is signed for DNS names [alfred kubernetes kubernetes.default kubernetes.default.svc kubernetes.default.svc.cluster.local] and IPs [10.96.0.1 192.168.0.124]</span>
</span><span id="__span-45-15"><a id="__codelineno-45-15" name="__codelineno-45-15" href="#__codelineno-45-15"></a><span class="go">[certs] Generating "apiserver-kubelet-client" certificate and key</span>
</span><span id="__span-45-16"><a id="__codelineno-45-16" name="__codelineno-45-16" href="#__codelineno-45-16"></a><span class="go">[certs] Generating "front-proxy-ca" certificate and key</span>
</span><span id="__span-45-17"><a id="__codelineno-45-17" name="__codelineno-45-17" href="#__codelineno-45-17"></a><span class="go">[certs] Generating "front-proxy-client" certificate and key</span>
</span><span id="__span-45-18"><a id="__codelineno-45-18" name="__codelineno-45-18" href="#__codelineno-45-18"></a><span class="go">[certs] Generating "etcd/ca" certificate and key</span>
</span><span id="__span-45-19"><a id="__codelineno-45-19" name="__codelineno-45-19" href="#__codelineno-45-19"></a><span class="go">[certs] Generating "etcd/server" certificate and key</span>
</span><span id="__span-45-20"><a id="__codelineno-45-20" name="__codelineno-45-20" href="#__codelineno-45-20"></a><span class="go">[certs] etcd/server serving cert is signed for DNS names [alfred localhost] and IPs [192.168.0.124 127.0.0.1 ::1]</span>
</span><span id="__span-45-21"><a id="__codelineno-45-21" name="__codelineno-45-21" href="#__codelineno-45-21"></a><span class="go">[certs] Generating "etcd/peer" certificate and key</span>
</span><span id="__span-45-22"><a id="__codelineno-45-22" name="__codelineno-45-22" href="#__codelineno-45-22"></a><span class="go">[certs] etcd/peer serving cert is signed for DNS names [alfred localhost] and IPs [192.168.0.124 127.0.0.1 ::1]</span>
</span><span id="__span-45-23"><a id="__codelineno-45-23" name="__codelineno-45-23" href="#__codelineno-45-23"></a><span class="go">[certs] Generating "etcd/healthcheck-client" certificate and key</span>
</span><span id="__span-45-24"><a id="__codelineno-45-24" name="__codelineno-45-24" href="#__codelineno-45-24"></a><span class="go">[certs] Generating "apiserver-etcd-client" certificate and key</span>
</span><span id="__span-45-25"><a id="__codelineno-45-25" name="__codelineno-45-25" href="#__codelineno-45-25"></a><span class="go">[certs] Generating "sa" key and public key</span>
</span><span id="__span-45-26"><a id="__codelineno-45-26" name="__codelineno-45-26" href="#__codelineno-45-26"></a><span class="go">[kubeconfig] Using kubeconfig folder "/etc/kubernetes"</span>
</span><span id="__span-45-27"><a id="__codelineno-45-27" name="__codelineno-45-27" href="#__codelineno-45-27"></a><span class="go">[kubeconfig] Writing "admin.conf" kubeconfig file</span>
</span><span id="__span-45-28"><a id="__codelineno-45-28" name="__codelineno-45-28" href="#__codelineno-45-28"></a><span class="go">[kubeconfig] Writing "super-admin.conf" kubeconfig file</span>
</span><span id="__span-45-29"><a id="__codelineno-45-29" name="__codelineno-45-29" href="#__codelineno-45-29"></a><span class="go">[kubeconfig] Writing "kubelet.conf" kubeconfig file</span>
</span><span id="__span-45-30"><a id="__codelineno-45-30" name="__codelineno-45-30" href="#__codelineno-45-30"></a><span class="go">[kubeconfig] Writing "controller-manager.conf" kubeconfig file</span>
</span><span id="__span-45-31"><a id="__codelineno-45-31" name="__codelineno-45-31" href="#__codelineno-45-31"></a><span class="go">[kubeconfig] Writing "scheduler.conf" kubeconfig file</span>
</span><span id="__span-45-32"><a id="__codelineno-45-32" name="__codelineno-45-32" href="#__codelineno-45-32"></a><span class="go">[etcd] Creating static Pod manifest for local etcd in "/etc/kubernetes/manifests"</span>
</span><span id="__span-45-33"><a id="__codelineno-45-33" name="__codelineno-45-33" href="#__codelineno-45-33"></a><span class="go">[control-plane] Using manifest folder "/etc/kubernetes/manifests"</span>
</span><span id="__span-45-34"><a id="__codelineno-45-34" name="__codelineno-45-34" href="#__codelineno-45-34"></a><span class="go">[control-plane] Creating static Pod manifest for "kube-apiserver"</span>
</span><span id="__span-45-35"><a id="__codelineno-45-35" name="__codelineno-45-35" href="#__codelineno-45-35"></a><span class="go">[control-plane] Creating static Pod manifest for "kube-controller-manager"</span>
</span><span id="__span-45-36"><a id="__codelineno-45-36" name="__codelineno-45-36" href="#__codelineno-45-36"></a><span class="go">[control-plane] Creating static Pod manifest for "kube-scheduler"</span>
</span><span id="__span-45-37"><a id="__codelineno-45-37" name="__codelineno-45-37" href="#__codelineno-45-37"></a><span class="go">[kubelet-start] Writing kubelet environment file with flags to file "/var/lib/kubelet/kubeadm-flags.env"</span>
</span><span id="__span-45-38"><a id="__codelineno-45-38" name="__codelineno-45-38" href="#__codelineno-45-38"></a><span class="go">[kubelet-start] Writing kubelet configuration to file "/var/lib/kubelet/config.yaml"</span>
</span><span id="__span-45-39"><a id="__codelineno-45-39" name="__codelineno-45-39" href="#__codelineno-45-39"></a><span class="go">[kubelet-start] Starting the kubelet</span>
</span><span id="__span-45-40"><a id="__codelineno-45-40" name="__codelineno-45-40" href="#__codelineno-45-40"></a><span class="go">[wait-control-plane] Waiting for the kubelet to boot up the control plane as static Pods from directory "/etc/kubernetes/manifests"</span>
</span><span id="__span-45-41"><a id="__codelineno-45-41" name="__codelineno-45-41" href="#__codelineno-45-41"></a><span class="go">[kubelet-check] Waiting for a healthy kubelet at http://127.0.0.1:10248/healthz. This can take up to 4m0s</span>
</span><span id="__span-45-42"><a id="__codelineno-45-42" name="__codelineno-45-42" href="#__codelineno-45-42"></a><span class="go">[kubelet-check] The kubelet is healthy after 1.500708247s</span>
</span><span id="__span-45-43"><a id="__codelineno-45-43" name="__codelineno-45-43" href="#__codelineno-45-43"></a><span class="go">[api-check] Waiting for a healthy API server. This can take up to 4m0s</span>
</span><span id="__span-45-44"><a id="__codelineno-45-44" name="__codelineno-45-44" href="#__codelineno-45-44"></a><span class="go">[api-check] The API server is healthy after 6.502008927s</span>
</span><span id="__span-45-45"><a id="__codelineno-45-45" name="__codelineno-45-45" href="#__codelineno-45-45"></a><span class="go">[upload-config] Storing the configuration used in ConfigMap "kubeadm-config" in the "kube-system" Namespace</span>
</span><span id="__span-45-46"><a id="__codelineno-45-46" name="__codelineno-45-46" href="#__codelineno-45-46"></a><span class="go">[kubelet] Creating a ConfigMap "kubelet-config" in namespace kube-system with the configuration for the kubelets in the cluster</span>
</span><span id="__span-45-47"><a id="__codelineno-45-47" name="__codelineno-45-47" href="#__codelineno-45-47"></a><span class="go">[upload-certs] Skipping phase. Please see --upload-certs</span>
</span><span id="__span-45-48"><a id="__codelineno-45-48" name="__codelineno-45-48" href="#__codelineno-45-48"></a><span class="go">[mark-control-plane] Marking the node alfred as control-plane by adding the labels: [node-role.kubernetes.io/control-plane node.kubernetes.io/exclude-from-external-load-balancers]</span>
</span><span id="__span-45-49"><a id="__codelineno-45-49" name="__codelineno-45-49" href="#__codelineno-45-49"></a><span class="go">[mark-control-plane] Marking the node alfred as control-plane by adding the taints [node-role.kubernetes.io/control-plane:NoSchedule]</span>
</span><span id="__span-45-50"><a id="__codelineno-45-50" name="__codelineno-45-50" href="#__codelineno-45-50"></a><span class="go">[bootstrap-token] Using token: wsa12a.382ftng8m2y3id9x</span>
</span><span id="__span-45-51"><a id="__codelineno-45-51" name="__codelineno-45-51" href="#__codelineno-45-51"></a><span class="go">[bootstrap-token] Configuring bootstrap tokens, cluster-info ConfigMap, RBAC Roles</span>
</span><span id="__span-45-52"><a id="__codelineno-45-52" name="__codelineno-45-52" href="#__codelineno-45-52"></a><span class="go">[bootstrap-token] Configured RBAC rules to allow Node Bootstrap tokens to get nodes</span>
</span><span id="__span-45-53"><a id="__codelineno-45-53" name="__codelineno-45-53" href="#__codelineno-45-53"></a><span class="go">[bootstrap-token] Configured RBAC rules to allow Node Bootstrap tokens to post CSRs in order for nodes to get long term certificate credentials</span>
</span><span id="__span-45-54"><a id="__codelineno-45-54" name="__codelineno-45-54" href="#__codelineno-45-54"></a><span class="go">[bootstrap-token] Configured RBAC rules to allow the csrapprover controller automatically approve CSRs from a Node Bootstrap Token</span>
</span><span id="__span-45-55"><a id="__codelineno-45-55" name="__codelineno-45-55" href="#__codelineno-45-55"></a><span class="go">[bootstrap-token] Configured RBAC rules to allow certificate rotation for all node client certificates in the cluster</span>
</span><span id="__span-45-56"><a id="__codelineno-45-56" name="__codelineno-45-56" href="#__codelineno-45-56"></a><span class="go">[bootstrap-token] Creating the "cluster-info" ConfigMap in the "kube-public" namespace</span>
</span><span id="__span-45-57"><a id="__codelineno-45-57" name="__codelineno-45-57" href="#__codelineno-45-57"></a><span class="go">[kubelet-finalize] Updating "/etc/kubernetes/kubelet.conf" to point to a rotatable kubelet client certificate and key</span>
</span><span id="__span-45-58"><a id="__codelineno-45-58" name="__codelineno-45-58" href="#__codelineno-45-58"></a><span class="go">[addons] Applied essential addon: CoreDNS</span>
</span><span id="__span-45-59"><a id="__codelineno-45-59" name="__codelineno-45-59" href="#__codelineno-45-59"></a><span class="go">[addons] Applied essential addon: kube-proxy</span>
</span><span id="__span-45-60"><a id="__codelineno-45-60" name="__codelineno-45-60" href="#__codelineno-45-60"></a>
</span><span id="__span-45-61"><a id="__codelineno-45-61" name="__codelineno-45-61" href="#__codelineno-45-61"></a><span class="go">Your Kubernetes control-plane has initialized successfully!</span>
</span><span id="__span-45-62"><a id="__codelineno-45-62" name="__codelineno-45-62" href="#__codelineno-45-62"></a>
</span><span id="__span-45-63"><a id="__codelineno-45-63" name="__codelineno-45-63" href="#__codelineno-45-63"></a><span class="go">To start using your cluster, you need to run the following as a regular user:</span>
</span><span id="__span-45-64"><a id="__codelineno-45-64" name="__codelineno-45-64" href="#__codelineno-45-64"></a>
</span><span id="__span-45-65"><a id="__codelineno-45-65" name="__codelineno-45-65" href="#__codelineno-45-65"></a><span class="go">  mkdir -p $HOME/.kube</span>
</span><span id="__span-45-66"><a id="__codelineno-45-66" name="__codelineno-45-66" href="#__codelineno-45-66"></a><span class="go">  sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config</span>
</span><span id="__span-45-67"><a id="__codelineno-45-67" name="__codelineno-45-67" href="#__codelineno-45-67"></a><span class="go">  sudo chown $(id -u):$(id -g) $HOME/.kube/config</span>
</span><span id="__span-45-68"><a id="__codelineno-45-68" name="__codelineno-45-68" href="#__codelineno-45-68"></a>
</span><span id="__span-45-69"><a id="__codelineno-45-69" name="__codelineno-45-69" href="#__codelineno-45-69"></a><span class="go">Alternatively, if you are the root user, you can run:</span>
</span><span id="__span-45-70"><a id="__codelineno-45-70" name="__codelineno-45-70" href="#__codelineno-45-70"></a>
</span><span id="__span-45-71"><a id="__codelineno-45-71" name="__codelineno-45-71" href="#__codelineno-45-71"></a><span class="go">  export KUBECONFIG=/etc/kubernetes/admin.conf</span>
</span><span id="__span-45-72"><a id="__codelineno-45-72" name="__codelineno-45-72" href="#__codelineno-45-72"></a>
</span><span id="__span-45-73"><a id="__codelineno-45-73" name="__codelineno-45-73" href="#__codelineno-45-73"></a><span class="go">You should now deploy a pod network to the cluster.</span>
</span><span id="__span-45-74"><a id="__codelineno-45-74" name="__codelineno-45-74" href="#__codelineno-45-74"></a><span class="go">Run "kubectl apply -f [podnetwork].yaml" with one of the options listed at:</span>
</span><span id="__span-45-75"><a id="__codelineno-45-75" name="__codelineno-45-75" href="#__codelineno-45-75"></a><span class="go">  https://kubernetes.io/docs/concepts/cluster-administration/addons/</span>
</span><span id="__span-45-76"><a id="__codelineno-45-76" name="__codelineno-45-76" href="#__codelineno-45-76"></a>
</span><span id="__span-45-77"><a id="__codelineno-45-77" name="__codelineno-45-77" href="#__codelineno-45-77"></a><span class="go">Then you can join any number of worker nodes by running the following on each as root:</span>
</span><span id="__span-45-78"><a id="__codelineno-45-78" name="__codelineno-45-78" href="#__codelineno-45-78"></a>
</span><span id="__span-45-79"><a id="__codelineno-45-79" name="__codelineno-45-79" href="#__codelineno-45-79"></a><span class="go">kubeadm join 192.168.0.124:6443 --token wsa12a.382ftng8m2y3id9x \</span>
</span><span id="__span-45-80"><a id="__codelineno-45-80" name="__codelineno-45-80" href="#__codelineno-45-80"></a><span class="go">        --discovery-token-ca-cert-hash sha256:33d013e353b67503bf547c210adc44fe52617626b6f310f801c87c1200269daf</span>
</span></code></pre></div>
</details>
<p>Now <code>kubelet</code> is running and reporting pod startups:</p>
<details class="terminal">
<summary><code>systemctl status kubelet</code></summary>
<div class="language-console highlight"><pre><span></span><code><span id="__span-46-1"><a id="__codelineno-46-1" name="__codelineno-46-1" href="#__codelineno-46-1"></a><span class="gp">$ </span>systemctl<span class="w"> </span>status<span class="w"> </span>kubelet
</span><span id="__span-46-2"><a id="__codelineno-46-2" name="__codelineno-46-2" href="#__codelineno-46-2"></a><span class="go"> kubelet.service - kubelet: The Kubernetes Node Agent</span>
</span><span id="__span-46-3"><a id="__codelineno-46-3" name="__codelineno-46-3" href="#__codelineno-46-3"></a><span class="go">    Loaded: loaded (/lib/systemd/system/kubelet.service; enabled; preset: enabled)</span>
</span><span id="__span-46-4"><a id="__codelineno-46-4" name="__codelineno-46-4" href="#__codelineno-46-4"></a><span class="go">    Drop-In: /usr/lib/systemd/system/kubelet.service.d</span>
</span><span id="__span-46-5"><a id="__codelineno-46-5" name="__codelineno-46-5" href="#__codelineno-46-5"></a><span class="go">            10-kubeadm.conf</span>
</span><span id="__span-46-6"><a id="__codelineno-46-6" name="__codelineno-46-6" href="#__codelineno-46-6"></a><span class="go">    Active: active (running) since Sat 2025-02-22 18:07:07 CET; 59s ago</span>
</span><span id="__span-46-7"><a id="__codelineno-46-7" name="__codelineno-46-7" href="#__codelineno-46-7"></a><span class="go">      Docs: https://kubernetes.io/docs/</span>
</span><span id="__span-46-8"><a id="__codelineno-46-8" name="__codelineno-46-8" href="#__codelineno-46-8"></a><span class="go">  Main PID: 26454 (kubelet)</span>
</span><span id="__span-46-9"><a id="__codelineno-46-9" name="__codelineno-46-9" href="#__codelineno-46-9"></a><span class="go">      Tasks: 13 (limit: 9586)</span>
</span><span id="__span-46-10"><a id="__codelineno-46-10" name="__codelineno-46-10" href="#__codelineno-46-10"></a><span class="go">    Memory: 33.7M</span>
</span><span id="__span-46-11"><a id="__codelineno-46-11" name="__codelineno-46-11" href="#__codelineno-46-11"></a><span class="go">        CPU: 1.841s</span>
</span><span id="__span-46-12"><a id="__codelineno-46-12" name="__codelineno-46-12" href="#__codelineno-46-12"></a><span class="go">    CGroup: /system.slice/kubelet.service</span>
</span><span id="__span-46-13"><a id="__codelineno-46-13" name="__codelineno-46-13" href="#__codelineno-46-13"></a><span class="go">            26454 /usr/bin/kubelet --bootstrap-kubeconfig=/etc/kubernetes/bootstrap-kubelet.conf --kubeconfig=/etc/kubernetes/kubelet.conf --config=/var/lib/kubelet/config.yaml --container-runtime-endpoint=unix:/run/containerd/containerd.sock --pod-infra-container-image=registry.k8s.io/pause:3.10</span>
</span><span id="__span-46-14"><a id="__codelineno-46-14" name="__codelineno-46-14" href="#__codelineno-46-14"></a>
</span><span id="__span-46-15"><a id="__codelineno-46-15" name="__codelineno-46-15" href="#__codelineno-46-15"></a><span class="go">Feb 22 18:07:08 alfred kubelet[26454]: I0222 18:07:08.449253   26454 pod_startup_latency_tracker.go:104] "Observed pod startup duration" pod="kube-system/kube-apiserver-alfred" podStartSLOduration=1.449228049 podStartE2EDuration="1.449228049s" podCreationTimestamp="2025-02-22 18:07:07 +0100 CET" firstStartedPulling="0001-01-01 00:00:00 +0000 UTC" lastFinishedPulling="0001-01-&gt;</span>
</span><span id="__span-46-16"><a id="__codelineno-46-16" name="__codelineno-46-16" href="#__codelineno-46-16"></a><span class="go">Feb 22 18:07:08 alfred kubelet[26454]: I0222 18:07:08.465459   26454 pod_startup_latency_tracker.go:104] "Observed pod startup duration" pod="kube-system/kube-controller-manager-alfred" podStartSLOduration=1.4654371689999999 podStartE2EDuration="1.465437169s" podCreationTimestamp="2025-02-22 18:07:07 +0100 CET" firstStartedPulling="0001-01-01 00:00:00 +0000 UTC" lastFinishedP&gt;</span>
</span><span id="__span-46-17"><a id="__codelineno-46-17" name="__codelineno-46-17" href="#__codelineno-46-17"></a><span class="go">Feb 22 18:07:08 alfred kubelet[26454]: I0222 18:07:08.477805   26454 pod_startup_latency_tracker.go:104] "Observed pod startup duration" pod="kube-system/kube-scheduler-alfred" podStartSLOduration=1.47777902 podStartE2EDuration="1.47777902s" podCreationTimestamp="2025-02-22 18:07:07 +0100 CET" firstStartedPulling="0001-01-01 00:00:00 +0000 UTC" lastFinishedPulling="0001-01-01&gt;</span>
</span><span id="__span-46-18"><a id="__codelineno-46-18" name="__codelineno-46-18" href="#__codelineno-46-18"></a><span class="go">Feb 22 18:07:11 alfred kubelet[26454]: I0222 18:07:11.830256   26454 kuberuntime_manager.go:1702] "Updating runtime config through cri with podcidr" CIDR="10.244.0.0/24"</span>
</span><span id="__span-46-19"><a id="__codelineno-46-19" name="__codelineno-46-19" href="#__codelineno-46-19"></a><span class="go">Feb 22 18:07:11 alfred kubelet[26454]: I0222 18:07:11.831026   26454 kubelet_network.go:61] "Updating Pod CIDR" originalPodCIDR="" newPodCIDR="10.244.0.0/24"</span>
</span><span id="__span-46-20"><a id="__codelineno-46-20" name="__codelineno-46-20" href="#__codelineno-46-20"></a><span class="go">Feb 22 18:07:12 alfred kubelet[26454]: I0222 18:07:12.664117   26454 reconciler_common.go:251] "operationExecutor.VerifyControllerAttachedVolume started for volume \"kube-proxy\" (UniqueName: \"kubernetes.io/configmap/d82bc4b9-39fd-4616-9d9d-919b5dbf12f8-kube-proxy\") pod \"kube-proxy-m9rb6\" (UID: \"d82bc4b9-39fd-4616-9d9d-919b5dbf12f8\") " pod="kube-system/kube-proxy-m9rb6"</span>
</span><span id="__span-46-21"><a id="__codelineno-46-21" name="__codelineno-46-21" href="#__codelineno-46-21"></a><span class="go">Feb 22 18:07:12 alfred kubelet[26454]: I0222 18:07:12.664164   26454 reconciler_common.go:251] "operationExecutor.VerifyControllerAttachedVolume started for volume \"xtables-lock\" (UniqueName: \"kubernetes.io/host-path/d82bc4b9-39fd-4616-9d9d-919b5dbf12f8-xtables-lock\") pod \"kube-proxy-m9rb6\" (UID: \"d82bc4b9-39fd-4616-9d9d-919b5dbf12f8\") " pod="kube-system/kube-proxy-m9&gt;</span>
</span><span id="__span-46-22"><a id="__codelineno-46-22" name="__codelineno-46-22" href="#__codelineno-46-22"></a><span class="go">Feb 22 18:07:12 alfred kubelet[26454]: I0222 18:07:12.664191   26454 reconciler_common.go:251] "operationExecutor.VerifyControllerAttachedVolume started for volume \"lib-modules\" (UniqueName: \"kubernetes.io/host-path/d82bc4b9-39fd-4616-9d9d-919b5dbf12f8-lib-modules\") pod \"kube-proxy-m9rb6\" (UID: \"d82bc4b9-39fd-4616-9d9d-919b5dbf12f8\") " pod="kube-system/kube-proxy-m9rb&gt;</span>
</span><span id="__span-46-23"><a id="__codelineno-46-23" name="__codelineno-46-23" href="#__codelineno-46-23"></a><span class="go">Feb 22 18:07:12 alfred kubelet[26454]: I0222 18:07:12.664222   26454 reconciler_common.go:251] "operationExecutor.VerifyControllerAttachedVolume started for volume \"kube-api-access-kvm6p\" (UniqueName: \"kubernetes.io/projected/d82bc4b9-39fd-4616-9d9d-919b5dbf12f8-kube-api-access-kvm6p\") pod \"kube-proxy-m9rb6\" (UID: \"d82bc4b9-39fd-4616-9d9d-919b5dbf12f8\") " pod="kube-sy&gt;</span>
</span><span id="__span-46-24"><a id="__codelineno-46-24" name="__codelineno-46-24" href="#__codelineno-46-24"></a><span class="go">Feb 22 18:07:13 alfred kubelet[26454]: I0222 18:07:13.955329   26454 pod_startup_latency_tracker.go:104] "Observed pod startup duration" pod="kube-system/kube-proxy-m9rb6" podStartSLOduration=1.955298193 podStartE2EDuration="1.955298193s" podCreationTimestamp="2025-02-22 18:07:12 +0100 CET" firstStartedPulling="0001-01-01 00:00:00 +0000 UTC" lastFinishedPulling="0001-01-01 00&gt;</span>
</span></code></pre></div>
</details>
<p>We can see all the containers already running:</p>
<details class="terminal">
<summary><code>sudo crictl ps -a</code></summary>
<div class="language-console highlight"><pre><span></span><code><span id="__span-47-1"><a id="__codelineno-47-1" name="__codelineno-47-1" href="#__codelineno-47-1"></a><span class="gp">$ </span>sudo<span class="w"> </span>crictl<span class="w"> </span>ps<span class="w"> </span>-a
</span><span id="__span-47-2"><a id="__codelineno-47-2" name="__codelineno-47-2" href="#__codelineno-47-2"></a><span class="go">WARN[0000] Config "/etc/crictl.yaml" does not exist, trying next: "/usr/bin/crictl.yaml" </span>
</span><span id="__span-47-3"><a id="__codelineno-47-3" name="__codelineno-47-3" href="#__codelineno-47-3"></a><span class="go">CONTAINER           IMAGE               CREATED             STATE               NAME                      ATTEMPT             POD ID              POD                              NAMESPACE</span>
</span><span id="__span-47-4"><a id="__codelineno-47-4" name="__codelineno-47-4" href="#__codelineno-47-4"></a><span class="go">96bfa773295db       e5aac5df76d9b       3 minutes ago       Running             kube-proxy                0                   913830cf3993f       kube-proxy-m9rb6                 kube-system</span>
</span><span id="__span-47-5"><a id="__codelineno-47-5" name="__codelineno-47-5" href="#__codelineno-47-5"></a><span class="go">a6b39c9d1cb7b       3c9285acfd2ff       3 minutes ago       Running             kube-controller-manager   0                   a79090d0033d6       kube-controller-manager-alfred   kube-system</span>
</span><span id="__span-47-6"><a id="__codelineno-47-6" name="__codelineno-47-6" href="#__codelineno-47-6"></a><span class="go">daabcca3c5ff7       6417e1437b6d9       3 minutes ago       Running             kube-apiserver            0                   eb82d6f92e0a6       kube-apiserver-alfred            kube-system</span>
</span><span id="__span-47-7"><a id="__codelineno-47-7" name="__codelineno-47-7" href="#__codelineno-47-7"></a><span class="go">a3265cea76a4e       82dfa03f692fb       3 minutes ago       Running             kube-scheduler            0                   358bbf99544f9       kube-scheduler-alfred            kube-system</span>
</span><span id="__span-47-8"><a id="__codelineno-47-8" name="__codelineno-47-8" href="#__codelineno-47-8"></a><span class="go">58c64ed06ad12       7fc9d4aa817aa       3 minutes ago       Running             etcd                      0                   a176e6da07c76       etcd-alfred                      kube-system</span>
</span></code></pre></div>
</details>
<p>The cluster is configured correctly to use registry.k8s.io/pause:3.<strong>10</strong>:</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-48-1"><a id="__codelineno-48-1" name="__codelineno-48-1" href="#__codelineno-48-1"></a><span class="gp">$ </span>grep<span class="w"> </span>container-runtime<span class="w"> </span>/var/lib/kubelet/kubeadm-flags.env<span class="w"> </span>
</span><span id="__span-48-2"><a id="__codelineno-48-2" name="__codelineno-48-2" href="#__codelineno-48-2"></a><span class="go">KUBELET_KUBEADM_ARGS="--container-runtime-endpoint=unix:/run/containerd/containerd.sock --pod-infra-container-image=registry.k8s.io/pause:3.10"</span>
</span></code></pre></div>
<h5 id="troubleshooting-bootstrap">Troubleshooting Bootstrap</h5>
<p>The first attempt failed for a few reasons:</p>
<details class="terminal">
<summary><code>sudo kubeadm init</code></summary>
<div class="language-console highlight"><pre><span></span><code><span id="__span-49-1"><a id="__codelineno-49-1" name="__codelineno-49-1" href="#__codelineno-49-1"></a><span class="gp">$ </span>sudo<span class="w"> </span>kubeadm<span class="w"> </span>init<span class="w"> </span><span class="se">\</span>
</span><span id="__span-49-2"><a id="__codelineno-49-2" name="__codelineno-49-2" href="#__codelineno-49-2"></a><span class="w">  </span>--cri-socket<span class="o">=</span>unix:/run/containerd/containerd.sock<span class="w"> </span><span class="se">\</span>
</span><span id="__span-49-3"><a id="__codelineno-49-3" name="__codelineno-49-3" href="#__codelineno-49-3"></a><span class="w">  </span>--pod-network-cidr<span class="o">=</span><span class="m">10</span>.244.0.0/16
</span><span id="__span-49-4"><a id="__codelineno-49-4" name="__codelineno-49-4" href="#__codelineno-49-4"></a>
</span><span id="__span-49-5"><a id="__codelineno-49-5" name="__codelineno-49-5" href="#__codelineno-49-5"></a><span class="go">[init] Using Kubernetes version: v1.32.2</span>
</span><span id="__span-49-6"><a id="__codelineno-49-6" name="__codelineno-49-6" href="#__codelineno-49-6"></a><span class="go">[preflight] Running pre-flight checks</span>
</span><span id="__span-49-7"><a id="__codelineno-49-7" name="__codelineno-49-7" href="#__codelineno-49-7"></a><span class="hll"><span class="go">W0222 16:05:57.929808  443810 checks.go:1077] [preflight] WARNING: Couldn't create the interface used for talking to the container runtime: failed to create new CRI runtime service: validate service connection: validate CRI v1 runtime API for endpoint "unix:/run/containerd/containerd.sock": rpc error: code = Unimplemented desc = unknown service runtime.v1.RuntimeService</span>
</span></span><span id="__span-49-8"><a id="__codelineno-49-8" name="__codelineno-49-8" href="#__codelineno-49-8"></a><span class="go">[preflight] The system verification failed. Printing the output from the verification:</span>
</span><span id="__span-49-9"><a id="__codelineno-49-9" name="__codelineno-49-9" href="#__codelineno-49-9"></a><span class="go">KERNEL_VERSION: 6.6.74+rpt-rpi-2712</span>
</span><span id="__span-49-10"><a id="__codelineno-49-10" name="__codelineno-49-10" href="#__codelineno-49-10"></a><span class="go">CONFIG_NAMESPACES: enabled</span>
</span><span id="__span-49-11"><a id="__codelineno-49-11" name="__codelineno-49-11" href="#__codelineno-49-11"></a><span class="go">CONFIG_NET_NS: enabled</span>
</span><span id="__span-49-12"><a id="__codelineno-49-12" name="__codelineno-49-12" href="#__codelineno-49-12"></a><span class="go">CONFIG_PID_NS: enabled</span>
</span><span id="__span-49-13"><a id="__codelineno-49-13" name="__codelineno-49-13" href="#__codelineno-49-13"></a><span class="go">CONFIG_IPC_NS: enabled</span>
</span><span id="__span-49-14"><a id="__codelineno-49-14" name="__codelineno-49-14" href="#__codelineno-49-14"></a><span class="go">CONFIG_UTS_NS: enabled</span>
</span><span id="__span-49-15"><a id="__codelineno-49-15" name="__codelineno-49-15" href="#__codelineno-49-15"></a><span class="go">CONFIG_CGROUPS: enabled</span>
</span><span id="__span-49-16"><a id="__codelineno-49-16" name="__codelineno-49-16" href="#__codelineno-49-16"></a><span class="go">CONFIG_CGROUP_BPF: enabled</span>
</span><span id="__span-49-17"><a id="__codelineno-49-17" name="__codelineno-49-17" href="#__codelineno-49-17"></a><span class="go">CONFIG_CGROUP_CPUACCT: enabled</span>
</span><span id="__span-49-18"><a id="__codelineno-49-18" name="__codelineno-49-18" href="#__codelineno-49-18"></a><span class="go">CONFIG_CGROUP_DEVICE: enabled</span>
</span><span id="__span-49-19"><a id="__codelineno-49-19" name="__codelineno-49-19" href="#__codelineno-49-19"></a><span class="go">CONFIG_CGROUP_FREEZER: enabled</span>
</span><span id="__span-49-20"><a id="__codelineno-49-20" name="__codelineno-49-20" href="#__codelineno-49-20"></a><span class="go">CONFIG_CGROUP_PIDS: enabled</span>
</span><span id="__span-49-21"><a id="__codelineno-49-21" name="__codelineno-49-21" href="#__codelineno-49-21"></a><span class="go">CONFIG_CGROUP_SCHED: enabled</span>
</span><span id="__span-49-22"><a id="__codelineno-49-22" name="__codelineno-49-22" href="#__codelineno-49-22"></a><span class="go">CONFIG_CPUSETS: enabled</span>
</span><span id="__span-49-23"><a id="__codelineno-49-23" name="__codelineno-49-23" href="#__codelineno-49-23"></a><span class="go">CONFIG_MEMCG: enabled</span>
</span><span id="__span-49-24"><a id="__codelineno-49-24" name="__codelineno-49-24" href="#__codelineno-49-24"></a><span class="go">CONFIG_INET: enabled</span>
</span><span id="__span-49-25"><a id="__codelineno-49-25" name="__codelineno-49-25" href="#__codelineno-49-25"></a><span class="go">CONFIG_EXT4_FS: enabled</span>
</span><span id="__span-49-26"><a id="__codelineno-49-26" name="__codelineno-49-26" href="#__codelineno-49-26"></a><span class="go">CONFIG_PROC_FS: enabled</span>
</span><span id="__span-49-27"><a id="__codelineno-49-27" name="__codelineno-49-27" href="#__codelineno-49-27"></a><span class="go">CONFIG_NETFILTER_XT_TARGET_REDIRECT: enabled (as module)</span>
</span><span id="__span-49-28"><a id="__codelineno-49-28" name="__codelineno-49-28" href="#__codelineno-49-28"></a><span class="go">CONFIG_NETFILTER_XT_MATCH_COMMENT: enabled (as module)</span>
</span><span id="__span-49-29"><a id="__codelineno-49-29" name="__codelineno-49-29" href="#__codelineno-49-29"></a><span class="go">CONFIG_FAIR_GROUP_SCHED: enabled</span>
</span><span id="__span-49-30"><a id="__codelineno-49-30" name="__codelineno-49-30" href="#__codelineno-49-30"></a><span class="go">CONFIG_OVERLAY_FS: enabled (as module)</span>
</span><span id="__span-49-31"><a id="__codelineno-49-31" name="__codelineno-49-31" href="#__codelineno-49-31"></a><span class="go">CONFIG_AUFS_FS: not set - Required for aufs.</span>
</span><span id="__span-49-32"><a id="__codelineno-49-32" name="__codelineno-49-32" href="#__codelineno-49-32"></a><span class="go">CONFIG_BLK_DEV_DM: enabled (as module)</span>
</span><span id="__span-49-33"><a id="__codelineno-49-33" name="__codelineno-49-33" href="#__codelineno-49-33"></a><span class="go">CONFIG_CFS_BANDWIDTH: enabled</span>
</span><span id="__span-49-34"><a id="__codelineno-49-34" name="__codelineno-49-34" href="#__codelineno-49-34"></a><span class="go">CONFIG_CGROUP_HUGETLB: not set - Required for hugetlb cgroup.</span>
</span><span id="__span-49-35"><a id="__codelineno-49-35" name="__codelineno-49-35" href="#__codelineno-49-35"></a><span class="go">CONFIG_SECCOMP: enabled</span>
</span><span id="__span-49-36"><a id="__codelineno-49-36" name="__codelineno-49-36" href="#__codelineno-49-36"></a><span class="go">CONFIG_SECCOMP_FILTER: enabled</span>
</span><span id="__span-49-37"><a id="__codelineno-49-37" name="__codelineno-49-37" href="#__codelineno-49-37"></a><span class="go">OS: Linux</span>
</span><span id="__span-49-38"><a id="__codelineno-49-38" name="__codelineno-49-38" href="#__codelineno-49-38"></a><span class="go">CGROUPS_CPU: enabled</span>
</span><span id="__span-49-39"><a id="__codelineno-49-39" name="__codelineno-49-39" href="#__codelineno-49-39"></a><span class="go">CGROUPS_CPUSET: enabled</span>
</span><span id="__span-49-40"><a id="__codelineno-49-40" name="__codelineno-49-40" href="#__codelineno-49-40"></a><span class="go">CGROUPS_DEVICES: enabled</span>
</span><span id="__span-49-41"><a id="__codelineno-49-41" name="__codelineno-49-41" href="#__codelineno-49-41"></a><span class="go">CGROUPS_FREEZER: enabled</span>
</span><span id="__span-49-42"><a id="__codelineno-49-42" name="__codelineno-49-42" href="#__codelineno-49-42"></a><span class="go">CGROUPS_MEMORY: missing</span>
</span><span id="__span-49-43"><a id="__codelineno-49-43" name="__codelineno-49-43" href="#__codelineno-49-43"></a><span class="go">CGROUPS_PIDS: enabled</span>
</span><span id="__span-49-44"><a id="__codelineno-49-44" name="__codelineno-49-44" href="#__codelineno-49-44"></a><span class="go">CGROUPS_HUGETLB: missing</span>
</span><span id="__span-49-45"><a id="__codelineno-49-45" name="__codelineno-49-45" href="#__codelineno-49-45"></a><span class="go">CGROUPS_IO: enabled</span>
</span><span id="__span-49-46"><a id="__codelineno-49-46" name="__codelineno-49-46" href="#__codelineno-49-46"></a><span class="hll"><span class="go">        [WARNING SystemVerification]: missing optional cgroups: hugetlb</span>
</span></span><span id="__span-49-47"><a id="__codelineno-49-47" name="__codelineno-49-47" href="#__codelineno-49-47"></a><span class="go">error execution phase preflight: [preflight] Some fatal errors occurred:</span>
</span><span id="__span-49-48"><a id="__codelineno-49-48" name="__codelineno-49-48" href="#__codelineno-49-48"></a><span class="hll"><span class="go">        [ERROR SystemVerification]: missing required cgroups: memory</span>
</span></span><span id="__span-49-49"><a id="__codelineno-49-49" name="__codelineno-49-49" href="#__codelineno-49-49"></a><span class="go">[preflight] If you know what you are doing, you can make a check non-fatal with `--ignore-preflight-errors=...`</span>
</span><span id="__span-49-50"><a id="__codelineno-49-50" name="__codelineno-49-50" href="#__codelineno-49-50"></a><span class="go">To see the stack trace of this error execute with --v=5 or higher</span>
</span></code></pre></div>
</details>
<p>There are 2 warnings and 1 error, although at least one of the warnings looks
like it may be a fatal error preventing the creation of the cluster:</p>
<ol>
<li><strong>WARNING:</strong> Couldn't create the interface used for talking to the
    container runtime: failed to create new CRI runtime service: validate
    service connection: validate CRI v1 runtime API for endpoint
    <code>"unix:/run/containerd/containerd.sock"</code>: rpc error:
    <code>code = Unimplemented desc = unknown service runtime.v1.RuntimeService</code><ul>
<li><strong>Solution</strong>: <code>sudo systemctl restart containerd</code></li>
<li><strong>Explanation</strong>: this was a subtle mistake; after replacing the
   configuration in <code>/etc/containerd/config.toml</code> the service was <strong>not</strong>
   restarted, because the command was <code>sudo systemctl start containerd</code>
   (<strong><code>start</code></strong> instead of <strong><code>restart</code></strong>) which had no effect because the
   service was already running. Later, this was suspected based on the
   notes taken along the way (i.e. this article's draft) and 
   confirmed by the last modified time in the config file being 1 hour
   <strong>later</strong> than the start time given by <code>sudo status containerd</code>.</li>
</ul>
</li>
<li><strong>WARNING:</strong> missing optional cgroups: hugetlb<ul>
<li>This appears safe to ignore, since 
   <a href="https://docs.kernel.org/admin-guide/mm/hugetlbpage.html">HugeTLB Pages</a>
   is neither supported by the kernel nor necessary for this system.</li>
</ul>
</li>
<li><strong>ERROR:</strong> missing required cgroups: memory<ul>
<li><a href="https://github.com/raspberrypi/linux/issues/5933">Raspberry Pi OS bug #5933</a>
   causes this; the memory cgroup in the kernel command line:<br>
   <div class="language-dmesg highlight"><pre><span></span><code><span id="__span-50-1"><a id="__codelineno-50-1" name="__codelineno-50-1" href="#__codelineno-50-1"></a><span class="m">[    0.000000] </span><span class="k">Kernel command line:</span> ... cgroup_disable=memory ...
</span><span id="__span-50-2"><a id="__codelineno-50-2" name="__codelineno-50-2" href="#__codelineno-50-2"></a><span class="m">[    0.000000] </span><span class="k">cgroup:</span> Disabling memory control group subsystem
</span></code></pre></div>
   This is <strong>not</strong> caused by the command line parameters defined in
   <code>/boot/firmware/cmdline.txt</code> (documented in
   <a href="https://www.raspberrypi.com/documentation/computers/configuration.html#kernel-command-line-cmdline-txt">Kernel command line (cmdline.txt)</a>):
   <code>console=serial0,115200 console=tty1 root=PARTUUID=7c5a31a3-02 rootfstype=ext4 fsck.repair=yes rootwait cfg80211.ieee80211_regdom=CH</code></li>
<li><strong>Solution</strong>: add the required cgroups
   (<code>cgroup_enable=cpuset cgroup_memory=1 cgroup_enable=memory</code>) to the
   command line parameters defined in <code>/boot/firmware/cmdline.txt</code>:
   <div class="language-console highlight"><pre><span></span><code><span id="__span-51-1"><a id="__codelineno-51-1" name="__codelineno-51-1" href="#__codelineno-51-1"></a><span class="gp">$ </span>sudo<span class="w"> </span>sed<span class="w"> </span>-i<span class="w"> </span><span class="se">\</span>
</span><span id="__span-51-2"><a id="__codelineno-51-2" name="__codelineno-51-2" href="#__codelineno-51-2"></a><span class="w">  </span><span class="s1">'s/^/cgroup_enable=cpuset cgroup_memory=1 cgroup_enable=memory/ '</span><span class="w"> </span><span class="se">\</span>
</span><span id="__span-51-3"><a id="__codelineno-51-3" name="__codelineno-51-3" href="#__codelineno-51-3"></a><span class="w">  </span>/boot/firmware/cmdline.txt
</span></code></pre></div>
   After rebooting, <code>/proc/cmdline</code> shows <strong>both</strong> <code>cgroup_disable=memory</code>
   and the added parameters, but the memory cgroup is now enabled:
   <div class="language-dmesg highlight"><pre><span></span><code><span id="__span-52-1"><a id="__codelineno-52-1" name="__codelineno-52-1" href="#__codelineno-52-1"></a><span class="m">[    0.000000] </span><span class="k">Kernel command line:</span> ... cgroup_disable=memory ...
</span><span id="__span-52-2"><a id="__codelineno-52-2" name="__codelineno-52-2" href="#__codelineno-52-2"></a><span class="hll">    cgroup_enable=cpuset cgroup_memory=1 cgroup_enable=memory ...
</span></span><span id="__span-52-3"><a id="__codelineno-52-3" name="__codelineno-52-3" href="#__codelineno-52-3"></a><span class="m">[    0.000000] </span><span class="k">cgroup:</span> Disabling memory control group subsystem
</span><span id="__span-52-4"><a id="__codelineno-52-4" name="__codelineno-52-4" href="#__codelineno-52-4"></a><span class="m">[    0.000000] </span><span class="k">cgroup:</span> Enabling cpuset control group subsystem
</span><span id="__span-52-5"><a id="__codelineno-52-5" name="__codelineno-52-5" href="#__codelineno-52-5"></a><span class="hll"><span class="m">[    0.000000] </span><span class="k">cgroup:</span> Enabling memory control group subsystem
</span></span></code></pre></div>
   The <code>cgroup_memory=1</code> parameter is unknown to the kernel and passed on
   to <code>/init</code>.</li>
</ul>
</li>
</ol>
<h4 id="setup-kubectl-access">Setup <code>kubectl</code> access</h4>
<p>To run <code>kubectl</code> as the non-root user (<code>pi</code>), copy the Kubernetes config file
under the <code>~/.kube</code> directory and set the right permissions to it:</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-53-1"><a id="__codelineno-53-1" name="__codelineno-53-1" href="#__codelineno-53-1"></a><span class="gp">$ </span>mkdir<span class="w"> </span><span class="nv">$HOME</span>/.kube
</span><span id="__span-53-2"><a id="__codelineno-53-2" name="__codelineno-53-2" href="#__codelineno-53-2"></a><span class="gp">$ </span>sudo<span class="w"> </span>cp<span class="w"> </span>-f<span class="w"> </span>/etc/kubernetes/admin.conf<span class="w"> </span><span class="nv">$HOME</span>/.kube/config
</span><span id="__span-53-3"><a id="__codelineno-53-3" name="__codelineno-53-3" href="#__codelineno-53-3"></a><span class="gp">$ </span>sudo<span class="w"> </span>chown<span class="w"> </span><span class="k">$(</span>id<span class="w"> </span>-u<span class="k">)</span>:<span class="k">$(</span>id<span class="w"> </span>-g<span class="k">)</span><span class="w"> </span><span class="nv">$HOME</span>/.kube/config
</span><span id="__span-53-4"><a id="__codelineno-53-4" name="__codelineno-53-4" href="#__codelineno-53-4"></a><span class="gp">$ </span>ls<span class="w"> </span>-l<span class="w"> </span><span class="nv">$HOME</span>/.kube/config
</span><span id="__span-53-5"><a id="__codelineno-53-5" name="__codelineno-53-5" href="#__codelineno-53-5"></a><span class="go">-rw------- 1 pi pi 5653 Feb 22 18:20 /home/pi/.kube/config</span>
</span><span id="__span-53-6"><a id="__codelineno-53-6" name="__codelineno-53-6" href="#__codelineno-53-6"></a><span class="gp">$ </span>kubectl<span class="w"> </span>cluster-info
</span><span id="__span-53-7"><a id="__codelineno-53-7" name="__codelineno-53-7" href="#__codelineno-53-7"></a><span class="go">Kubernetes control plane is running at https://192.168.0.124:6443</span>
</span><span id="__span-53-8"><a id="__codelineno-53-8" name="__codelineno-53-8" href="#__codelineno-53-8"></a><span class="go">CoreDNS is running at https://192.168.0.124:6443/api/v1/namespaces/kube-system/services/kube-dns:dns/proxy</span>
</span><span id="__span-53-9"><a id="__codelineno-53-9" name="__codelineno-53-9" href="#__codelineno-53-9"></a>
</span><span id="__span-53-10"><a id="__codelineno-53-10" name="__codelineno-53-10" href="#__codelineno-53-10"></a><span class="go">To further debug and diagnose cluster problems, use 'kubectl cluster-info dump'.</span>
</span></code></pre></div>
<h3 id="network-plugin">Network plugin</h3>
<p><a href="https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/create-cluster-kubeadm/#pod-network">Installing a Pod network add-on</a>
is the next required step and, once again, in lack of other suggestions,
<a href="https://github.com/flannel-io/flannel#deploying-flannel-manually">deploying flannel manually</a>
like in previous clusters seems the way to go:</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-54-1"><a id="__codelineno-54-1" name="__codelineno-54-1" href="#__codelineno-54-1"></a><span class="gp">$ </span>wget<span class="w"> </span><span class="se">\</span>
</span><span id="__span-54-2"><a id="__codelineno-54-2" name="__codelineno-54-2" href="#__codelineno-54-2"></a><span class="w">  </span>https://github.com/flannel-io/flannel/releases/latest/download/kube-flannel.yml
</span><span id="__span-54-3"><a id="__codelineno-54-3" name="__codelineno-54-3" href="#__codelineno-54-3"></a>
</span><span id="__span-54-4"><a id="__codelineno-54-4" name="__codelineno-54-4" href="#__codelineno-54-4"></a><span class="gp">$ </span>kubectl<span class="w"> </span>apply<span class="w"> </span>-f<span class="w"> </span>kube-flannel.yml
</span><span id="__span-54-5"><a id="__codelineno-54-5" name="__codelineno-54-5" href="#__codelineno-54-5"></a><span class="go">namespace/kube-flannel created</span>
</span><span id="__span-54-6"><a id="__codelineno-54-6" name="__codelineno-54-6" href="#__codelineno-54-6"></a><span class="go">serviceaccount/flannel created</span>
</span><span id="__span-54-7"><a id="__codelineno-54-7" name="__codelineno-54-7" href="#__codelineno-54-7"></a><span class="go">clusterrole.rbac.authorization.k8s.io/flannel created</span>
</span><span id="__span-54-8"><a id="__codelineno-54-8" name="__codelineno-54-8" href="#__codelineno-54-8"></a><span class="go">clusterrolebinding.rbac.authorization.k8s.io/flannel created</span>
</span><span id="__span-54-9"><a id="__codelineno-54-9" name="__codelineno-54-9" href="#__codelineno-54-9"></a><span class="go">configmap/kube-flannel-cfg created</span>
</span><span id="__span-54-10"><a id="__codelineno-54-10" name="__codelineno-54-10" href="#__codelineno-54-10"></a><span class="go">daemonset.apps/kube-flannel-ds created</span>
</span></code></pre></div>
<h4 id="troubleshooting-flannel">Troubleshooting Flannel</h4>
<p>Unlike in previous cluster setups, the <code>kube-flannel-ds</code> deployment fails
and the pod stays in a <code>CrashLoopBackOff</code> cycle:</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-55-1"><a id="__codelineno-55-1" name="__codelineno-55-1" href="#__codelineno-55-1"></a><span class="gp">$ </span>kubectl<span class="w"> </span>get<span class="w"> </span>pods<span class="w"> </span>-n<span class="w"> </span>kube-flannel<span class="w"> </span>
</span><span id="__span-55-2"><a id="__codelineno-55-2" name="__codelineno-55-2" href="#__codelineno-55-2"></a><span class="go">NAME                    READY   STATUS             RESTARTS       AGE</span>
</span><span id="__span-55-3"><a id="__codelineno-55-3" name="__codelineno-55-3" href="#__codelineno-55-3"></a><span class="go">kube-flannel-ds-l6446   0/1     CrashLoopBackOff   10 (85s ago)   27m</span>
</span><span id="__span-55-4"><a id="__codelineno-55-4" name="__codelineno-55-4" href="#__codelineno-55-4"></a>
</span><span id="__span-55-5"><a id="__codelineno-55-5" name="__codelineno-55-5" href="#__codelineno-55-5"></a><span class="gp">$ </span>kubectl<span class="w"> </span>get<span class="w"> </span>all<span class="w"> </span>-n<span class="w"> </span>kube-flannel<span class="w"> </span>
</span><span id="__span-55-6"><a id="__codelineno-55-6" name="__codelineno-55-6" href="#__codelineno-55-6"></a><span class="go">NAME                        READY   STATUS   RESTARTS      AGE</span>
</span><span id="__span-55-7"><a id="__codelineno-55-7" name="__codelineno-55-7" href="#__codelineno-55-7"></a><span class="go">pod/kube-flannel-ds-l6446   0/1     Error    5 (88s ago)   3m18s</span>
</span><span id="__span-55-8"><a id="__codelineno-55-8" name="__codelineno-55-8" href="#__codelineno-55-8"></a>
</span><span id="__span-55-9"><a id="__codelineno-55-9" name="__codelineno-55-9" href="#__codelineno-55-9"></a><span class="go">NAME                             DESIRED   CURRENT   READY   UP-TO-DATE   AVAILABLE   NODE SELECTOR   AGE</span>
</span><span id="__span-55-10"><a id="__codelineno-55-10" name="__codelineno-55-10" href="#__codelineno-55-10"></a><span class="go">daemonset.apps/kube-flannel-ds   1         1         0       1            0           &lt;none&gt;          3m18s</span>
</span></code></pre></div>
<p>Inspecting the logs of this pod, in particular the error regarding
<code>br_netfilter</code> suggests that the <a href="#networking-setup">networking setup</a>
<em>previously</em> required by <code>containerd</code> was now, if not required by <code>containerd</code>,
at least required by Flannel:</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-56-1"><a id="__codelineno-56-1" name="__codelineno-56-1" href="#__codelineno-56-1"></a><span class="gp">$ </span>kubectl<span class="w"> </span>logs<span class="w"> </span>-n<span class="w"> </span>kube-flannel<span class="w"> </span><span class="se">\</span>
</span><span id="__span-56-2"><a id="__codelineno-56-2" name="__codelineno-56-2" href="#__codelineno-56-2"></a><span class="gp">  $</span><span class="o">(</span>kubectl<span class="w"> </span>get<span class="w"> </span>pods<span class="w"> </span>-n<span class="w"> </span>kube-flannel<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>kube-flannel<span class="w"> </span><span class="p">|</span><span class="w"> </span>cut<span class="w"> </span>-f1<span class="w"> </span>-d<span class="s1">' '</span><span class="o">)</span>
</span><span id="__span-56-3"><a id="__codelineno-56-3" name="__codelineno-56-3" href="#__codelineno-56-3"></a><span class="go">Defaulted container "kube-flannel" out of: kube-flannel, install-cni-plugin (init), install-cni (init)</span>
</span><span id="__span-56-4"><a id="__codelineno-56-4" name="__codelineno-56-4" href="#__codelineno-56-4"></a><span class="go">I0222 18:58:21.486712       1 main.go:211] CLI flags config: {etcdEndpoints:http://127.0.0.1:4001,http://127.0.0.1:2379 etcdPrefix:/coreos.com/network etcdKeyfile: etcdCertfile: etcdCAFile: etcdUsername: etcdPassword: version:false kubeSubnetMgr:true kubeApiUrl: kubeAnnotationPrefix:flannel.alpha.coreos.com kubeConfigFile: iface:[] ifaceRegex:[] ipMasq:true ifaceCanReach: subnetFile:/run/flannel/subnet.env publicIP: publicIPv6: subnetLeaseRenewMargin:60 healthzIP:0.0.0.0 healthzPort:0 iptablesResyncSeconds:5 iptablesForwardRules:true netConfPath:/etc/kube-flannel/net-conf.json setNodeNetworkUnavailable:true}</span>
</span><span id="__span-56-5"><a id="__codelineno-56-5" name="__codelineno-56-5" href="#__codelineno-56-5"></a><span class="go">W0222 18:58:21.486829       1 client_config.go:618] Neither --kubeconfig nor --master was specified.  Using the inClusterConfig.  This might not work.</span>
</span><span id="__span-56-6"><a id="__codelineno-56-6" name="__codelineno-56-6" href="#__codelineno-56-6"></a><span class="go">I0222 18:58:21.501277       1 kube.go:139] Waiting 10m0s for node controller to sync</span>
</span><span id="__span-56-7"><a id="__codelineno-56-7" name="__codelineno-56-7" href="#__codelineno-56-7"></a><span class="go">I0222 18:58:21.501371       1 kube.go:469] Starting kube subnet manager</span>
</span><span id="__span-56-8"><a id="__codelineno-56-8" name="__codelineno-56-8" href="#__codelineno-56-8"></a><span class="go">I0222 18:58:22.502220       1 kube.go:146] Node controller sync successful</span>
</span><span id="__span-56-9"><a id="__codelineno-56-9" name="__codelineno-56-9" href="#__codelineno-56-9"></a><span class="go">I0222 18:58:22.502244       1 main.go:231] Created subnet manager: Kubernetes Subnet Manager - alfred</span>
</span><span id="__span-56-10"><a id="__codelineno-56-10" name="__codelineno-56-10" href="#__codelineno-56-10"></a><span class="go">I0222 18:58:22.502249       1 main.go:234] Installing signal handlers</span>
</span><span id="__span-56-11"><a id="__codelineno-56-11" name="__codelineno-56-11" href="#__codelineno-56-11"></a><span class="go">I0222 18:58:22.502404       1 main.go:468] Found network config - Backend type: vxlan</span>
</span><span id="__span-56-12"><a id="__codelineno-56-12" name="__codelineno-56-12" href="#__codelineno-56-12"></a><span class="hll"><span class="go">E0222 18:58:22.502451       1 main.go:268] Failed to check br_netfilter: stat /proc/sys/net/bridge/bridge-nf-call-iptables: no such file or directory</span>
</span></span></code></pre></div>
<p>Having initially omitted the steps to
<a href="https://v1-29.docs.kubernetes.io/docs/setup/production-environment/container-runtimes/#forwarding-ipv4-and-letting-iptables-see-bridged-traffic">let iptables see bridged traffic</a>,
these were performed after this failure and, afer restarting the daemonset
(<code>ds</code>), proved to be the missing ingredient for success:</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-57-1"><a id="__codelineno-57-1" name="__codelineno-57-1" href="#__codelineno-57-1"></a><span class="gp">$ </span>kubectl<span class="w"> </span>rollout<span class="w"> </span>restart<span class="w"> </span>ds<span class="w"> </span>kube-flannel-ds<span class="w"> </span>-n<span class="w"> </span>kube-flannel
</span><span id="__span-57-2"><a id="__codelineno-57-2" name="__codelineno-57-2" href="#__codelineno-57-2"></a><span class="go">daemonset.apps/kube-flannel-ds restarted</span>
</span><span id="__span-57-3"><a id="__codelineno-57-3" name="__codelineno-57-3" href="#__codelineno-57-3"></a>
</span><span id="__span-57-4"><a id="__codelineno-57-4" name="__codelineno-57-4" href="#__codelineno-57-4"></a><span class="gp">$ </span>kubectl<span class="w"> </span>get<span class="w"> </span>all<span class="w"> </span>-n<span class="w"> </span>kube-flannel
</span><span id="__span-57-5"><a id="__codelineno-57-5" name="__codelineno-57-5" href="#__codelineno-57-5"></a><span class="go">NAME                        READY   STATUS    RESTARTS   AGE</span>
</span><span id="__span-57-6"><a id="__codelineno-57-6" name="__codelineno-57-6" href="#__codelineno-57-6"></a><span class="go">pod/kube-flannel-ds-gq6b4   1/1     Running   0          4s</span>
</span><span id="__span-57-7"><a id="__codelineno-57-7" name="__codelineno-57-7" href="#__codelineno-57-7"></a>
</span><span id="__span-57-8"><a id="__codelineno-57-8" name="__codelineno-57-8" href="#__codelineno-57-8"></a><span class="go">NAME                             DESIRED   CURRENT   READY   UP-TO-DATE   AVAILABLE   NODE SELECTOR   AGE</span>
</span><span id="__span-57-9"><a id="__codelineno-57-9" name="__codelineno-57-9" href="#__codelineno-57-9"></a><span class="go">daemonset.apps/kube-flannel-ds   1         1         1       1            1           &lt;none&gt;          43m</span>
</span><span id="__span-57-10"><a id="__codelineno-57-10" name="__codelineno-57-10" href="#__codelineno-57-10"></a>
</span><span id="__span-57-11"><a id="__codelineno-57-11" name="__codelineno-57-11" href="#__codelineno-57-11"></a><span class="gp">$ </span>kubectl<span class="w"> </span>logs<span class="w"> </span>-n<span class="w"> </span>kube-flannel<span class="w"> </span><span class="se">\</span>
</span><span id="__span-57-12"><a id="__codelineno-57-12" name="__codelineno-57-12" href="#__codelineno-57-12"></a><span class="gp">  $</span><span class="o">(</span>kubectl<span class="w"> </span>get<span class="w"> </span>pods<span class="w"> </span>-n<span class="w"> </span>kube-flannel<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>kube-flannel<span class="w"> </span><span class="p">|</span><span class="w"> </span>cut<span class="w"> </span>-f1<span class="w"> </span>-d<span class="s1">' '</span><span class="o">)</span>
</span><span id="__span-57-13"><a id="__codelineno-57-13" name="__codelineno-57-13" href="#__codelineno-57-13"></a><span class="go">Defaulted container "kube-flannel" out of: kube-flannel, install-cni-plugin (init), install-cni (init)</span>
</span><span id="__span-57-14"><a id="__codelineno-57-14" name="__codelineno-57-14" href="#__codelineno-57-14"></a><span class="go">I0222 19:10:27.963740       1 main.go:211] CLI flags config: {etcdEndpoints:http://127.0.0.1:4001,http://127.0.0.1:2379 etcdPrefix:/coreos.com/network etcdKeyfile: etcdCertfile: etcdCAFile: etcdUsername: etcdPassword: version:false kubeSubnetMgr:true kubeApiUrl: kubeAnnotationPrefix:flannel.alpha.coreos.com kubeConfigFile: iface:[] ifaceRegex:[] ipMasq:true ifaceCanReach: subnetFile:/run/flannel/subnet.env publicIP: publicIPv6: subnetLeaseRenewMargin:60 healthzIP:0.0.0.0 healthzPort:0 iptablesResyncSeconds:5 iptablesForwardRules:true netConfPath:/etc/kube-flannel/net-conf.json setNodeNetworkUnavailable:true}</span>
</span><span id="__span-57-15"><a id="__codelineno-57-15" name="__codelineno-57-15" href="#__codelineno-57-15"></a><span class="go">W0222 19:10:27.963882       1 client_config.go:618] Neither --kubeconfig nor --master was specified.  Using the inClusterConfig.  This might not work.</span>
</span><span id="__span-57-16"><a id="__codelineno-57-16" name="__codelineno-57-16" href="#__codelineno-57-16"></a><span class="go">I0222 19:10:27.981819       1 kube.go:139] Waiting 10m0s for node controller to sync</span>
</span><span id="__span-57-17"><a id="__codelineno-57-17" name="__codelineno-57-17" href="#__codelineno-57-17"></a><span class="go">I0222 19:10:27.981886       1 kube.go:469] Starting kube subnet manager</span>
</span><span id="__span-57-18"><a id="__codelineno-57-18" name="__codelineno-57-18" href="#__codelineno-57-18"></a><span class="go">I0222 19:10:27.985297       1 kube.go:490] Creating the node lease for IPv4. This is the n.Spec.PodCIDRs: [10.244.0.0/24]</span>
</span><span id="__span-57-19"><a id="__codelineno-57-19" name="__codelineno-57-19" href="#__codelineno-57-19"></a><span class="go">I0222 19:10:28.981965       1 kube.go:146] Node controller sync successful</span>
</span><span id="__span-57-20"><a id="__codelineno-57-20" name="__codelineno-57-20" href="#__codelineno-57-20"></a><span class="go">I0222 19:10:28.981987       1 main.go:231] Created subnet manager: Kubernetes Subnet Manager - alfred</span>
</span><span id="__span-57-21"><a id="__codelineno-57-21" name="__codelineno-57-21" href="#__codelineno-57-21"></a><span class="go">I0222 19:10:28.981992       1 main.go:234] Installing signal handlers</span>
</span><span id="__span-57-22"><a id="__codelineno-57-22" name="__codelineno-57-22" href="#__codelineno-57-22"></a><span class="go">I0222 19:10:28.982155       1 main.go:468] Found network config - Backend type: vxlan</span>
</span><span id="__span-57-23"><a id="__codelineno-57-23" name="__codelineno-57-23" href="#__codelineno-57-23"></a><span class="go">I0222 19:10:28.984567       1 kube.go:669] List of node(alfred) annotations: map[string]string{"flannel.alpha.coreos.com/backend-data":"{\"VNI\":1,\"VtepMAC\":\"8a:31:5f:70:6e:3f\"}", "flannel.alpha.coreos.com/backend-type":"vxlan", "flannel.alpha.coreos.com/kube-subnet-manager":"true", "flannel.alpha.coreos.com/public-ip":"192.168.0.124", "kubeadm.alpha.kubernetes.io/cri-socket":"unix:/run/containerd/containerd.sock", "node.alpha.kubernetes.io/ttl":"0", "volumes.kubernetes.io/controller-managed-attach-detach":"true"}</span>
</span><span id="__span-57-24"><a id="__codelineno-57-24" name="__codelineno-57-24" href="#__codelineno-57-24"></a><span class="go">I0222 19:10:28.984614       1 match.go:211] Determining IP address of default interface</span>
</span><span id="__span-57-25"><a id="__codelineno-57-25" name="__codelineno-57-25" href="#__codelineno-57-25"></a><span class="go">I0222 19:10:28.984933       1 match.go:264] Using interface with name wlan0 and address 192.168.0.124</span>
</span><span id="__span-57-26"><a id="__codelineno-57-26" name="__codelineno-57-26" href="#__codelineno-57-26"></a><span class="go">I0222 19:10:28.984953       1 match.go:286] Defaulting external address to interface address (192.168.0.124)</span>
</span><span id="__span-57-27"><a id="__codelineno-57-27" name="__codelineno-57-27" href="#__codelineno-57-27"></a><span class="go">I0222 19:10:28.985003       1 vxlan.go:141] VXLAN config: VNI=1 Port=0 GBP=false Learning=false DirectRouting=false</span>
</span><span id="__span-57-28"><a id="__codelineno-57-28" name="__codelineno-57-28" href="#__codelineno-57-28"></a><span class="go">I0222 19:10:28.987228       1 kube.go:636] List of node(alfred) annotations: map[string]string{"flannel.alpha.coreos.com/backend-data":"{\"VNI\":1,\"VtepMAC\":\"8a:31:5f:70:6e:3f\"}", "flannel.alpha.coreos.com/backend-type":"vxlan", "flannel.alpha.coreos.com/kube-subnet-manager":"true", "flannel.alpha.coreos.com/public-ip":"192.168.0.124", "kubeadm.alpha.kubernetes.io/cri-socket":"unix:/run/containerd/containerd.sock", "node.alpha.kubernetes.io/ttl":"0", "volumes.kubernetes.io/controller-managed-attach-detach":"true"}</span>
</span><span id="__span-57-29"><a id="__codelineno-57-29" name="__codelineno-57-29" href="#__codelineno-57-29"></a><span class="go">I0222 19:10:28.987278       1 vxlan.go:155] Interface flannel.1 mac address set to: 8a:31:5f:70:6e:3f</span>
</span><span id="__span-57-30"><a id="__codelineno-57-30" name="__codelineno-57-30" href="#__codelineno-57-30"></a><span class="go">I0222 19:10:28.987762       1 iptables.go:51] Starting flannel in iptables mode...</span>
</span><span id="__span-57-31"><a id="__codelineno-57-31" name="__codelineno-57-31" href="#__codelineno-57-31"></a><span class="go">W0222 19:10:28.987895       1 main.go:557] no subnet found for key: FLANNEL_IPV6_NETWORK in file: /run/flannel/subnet.env</span>
</span><span id="__span-57-32"><a id="__codelineno-57-32" name="__codelineno-57-32" href="#__codelineno-57-32"></a><span class="go">W0222 19:10:28.987918       1 main.go:557] no subnet found for key: FLANNEL_IPV6_SUBNET in file: /run/flannel/subnet.env</span>
</span><span id="__span-57-33"><a id="__codelineno-57-33" name="__codelineno-57-33" href="#__codelineno-57-33"></a><span class="go">I0222 19:10:28.987925       1 iptables.go:125] Setting up masking rules</span>
</span><span id="__span-57-34"><a id="__codelineno-57-34" name="__codelineno-57-34" href="#__codelineno-57-34"></a><span class="go">I0222 19:10:28.993678       1 iptables.go:226] Changing default FORWARD chain policy to ACCEPT</span>
</span><span id="__span-57-35"><a id="__codelineno-57-35" name="__codelineno-57-35" href="#__codelineno-57-35"></a><span class="go">I0222 19:10:28.995928       1 main.go:412] Wrote subnet file to /run/flannel/subnet.env</span>
</span><span id="__span-57-36"><a id="__codelineno-57-36" name="__codelineno-57-36" href="#__codelineno-57-36"></a><span class="go">I0222 19:10:28.995946       1 main.go:416] Running backend.</span>
</span><span id="__span-57-37"><a id="__codelineno-57-37" name="__codelineno-57-37" href="#__codelineno-57-37"></a><span class="go">I0222 19:10:28.996090       1 vxlan_network.go:65] watching for new subnet leases</span>
</span><span id="__span-57-38"><a id="__codelineno-57-38" name="__codelineno-57-38" href="#__codelineno-57-38"></a><span class="go">I0222 19:10:29.005453       1 iptables.go:372] bootstrap done</span>
</span><span id="__span-57-39"><a id="__codelineno-57-39" name="__codelineno-57-39" href="#__codelineno-57-39"></a><span class="go">I0222 19:10:29.009834       1 main.go:437] Waiting for all goroutines to exit</span>
</span><span id="__span-57-40"><a id="__codelineno-57-40" name="__codelineno-57-40" href="#__codelineno-57-40"></a><span class="go">I0222 19:10:29.014751       1 iptables.go:372] bootstrap done</span>
</span></code></pre></div>
<h3 id="enable-single-node-cluster">Enable single-node cluster</h3>
<p><a href="https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/create-cluster-kubeadm/#control-plane-node-isolation">Control plane node isolation</a>
is required for a single-node cluster, because otherwise a cluster
will not schedule Pods on the control plane nodes for security reasons.
This is reflected in the <strong><code>Taints</code></strong> found in the node details:</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-58-1"><a id="__codelineno-58-1" name="__codelineno-58-1" href="#__codelineno-58-1"></a><span class="gp">$ </span>kubectl<span class="w"> </span>get<span class="w"> </span>nodes<span class="w"> </span>-o<span class="w"> </span>wide
</span><span id="__span-58-2"><a id="__codelineno-58-2" name="__codelineno-58-2" href="#__codelineno-58-2"></a><span class="go">NAME     STATUS   ROLES           AGE    VERSION   INTERNAL-IP     EXTERNAL-IP   OS-IMAGE                         KERNEL-VERSION        CONTAINER-RUNTIME</span>
</span><span id="__span-58-3"><a id="__codelineno-58-3" name="__codelineno-58-3" href="#__codelineno-58-3"></a><span class="go">alfred   Ready    control-plane   161m   v1.32.2   192.168.0.124   &lt;none&gt;        Debian GNU/Linux 12 (bookworm)   6.6.74+rpt-rpi-2712   containerd://1.7.25</span>
</span><span id="__span-58-4"><a id="__codelineno-58-4" name="__codelineno-58-4" href="#__codelineno-58-4"></a>
</span><span id="__span-58-5"><a id="__codelineno-58-5" name="__codelineno-58-5" href="#__codelineno-58-5"></a><span class="gp">$ </span>kubectl<span class="w"> </span>describe<span class="w"> </span>node<span class="w"> </span>alfred
</span><span id="__span-58-6"><a id="__codelineno-58-6" name="__codelineno-58-6" href="#__codelineno-58-6"></a><span class="go">Name:               alfred</span>
</span><span id="__span-58-7"><a id="__codelineno-58-7" name="__codelineno-58-7" href="#__codelineno-58-7"></a><span class="go">Roles:              control-plane</span>
</span><span id="__span-58-8"><a id="__codelineno-58-8" name="__codelineno-58-8" href="#__codelineno-58-8"></a><span class="go">Labels:             beta.kubernetes.io/arch=arm64</span>
</span><span id="__span-58-9"><a id="__codelineno-58-9" name="__codelineno-58-9" href="#__codelineno-58-9"></a><span class="go">                    beta.kubernetes.io/os=linux</span>
</span><span id="__span-58-10"><a id="__codelineno-58-10" name="__codelineno-58-10" href="#__codelineno-58-10"></a><span class="go">                    kubernetes.io/arch=arm64</span>
</span><span id="__span-58-11"><a id="__codelineno-58-11" name="__codelineno-58-11" href="#__codelineno-58-11"></a><span class="go">                    kubernetes.io/hostname=alfred</span>
</span><span id="__span-58-12"><a id="__codelineno-58-12" name="__codelineno-58-12" href="#__codelineno-58-12"></a><span class="go">                    kubernetes.io/os=linux</span>
</span><span id="__span-58-13"><a id="__codelineno-58-13" name="__codelineno-58-13" href="#__codelineno-58-13"></a><span class="go">                    node-role.kubernetes.io/control-plane=</span>
</span><span id="__span-58-14"><a id="__codelineno-58-14" name="__codelineno-58-14" href="#__codelineno-58-14"></a><span class="go">                    node.kubernetes.io/exclude-from-external-load-balancers=</span>
</span><span id="__span-58-15"><a id="__codelineno-58-15" name="__codelineno-58-15" href="#__codelineno-58-15"></a><span class="go">Annotations:        flannel.alpha.coreos.com/backend-data: {"VNI":1,"VtepMAC":"8a:31:5f:70:6e:3f"}</span>
</span><span id="__span-58-16"><a id="__codelineno-58-16" name="__codelineno-58-16" href="#__codelineno-58-16"></a><span class="go">                    flannel.alpha.coreos.com/backend-type: vxlan</span>
</span><span id="__span-58-17"><a id="__codelineno-58-17" name="__codelineno-58-17" href="#__codelineno-58-17"></a><span class="go">                    flannel.alpha.coreos.com/kube-subnet-manager: true</span>
</span><span id="__span-58-18"><a id="__codelineno-58-18" name="__codelineno-58-18" href="#__codelineno-58-18"></a><span class="go">                    flannel.alpha.coreos.com/public-ip: 192.168.0.124</span>
</span><span id="__span-58-19"><a id="__codelineno-58-19" name="__codelineno-58-19" href="#__codelineno-58-19"></a><span class="go">                    kubeadm.alpha.kubernetes.io/cri-socket: unix:/run/containerd/containerd.sock</span>
</span><span id="__span-58-20"><a id="__codelineno-58-20" name="__codelineno-58-20" href="#__codelineno-58-20"></a><span class="go">                    node.alpha.kubernetes.io/ttl: 0</span>
</span><span id="__span-58-21"><a id="__codelineno-58-21" name="__codelineno-58-21" href="#__codelineno-58-21"></a><span class="go">                    volumes.kubernetes.io/controller-managed-attach-detach: true</span>
</span><span id="__span-58-22"><a id="__codelineno-58-22" name="__codelineno-58-22" href="#__codelineno-58-22"></a><span class="go">CreationTimestamp:  Sat, 22 Feb 2025 18:07:04 +0100</span>
</span><span id="__span-58-23"><a id="__codelineno-58-23" name="__codelineno-58-23" href="#__codelineno-58-23"></a><span class="hll"><span class="go">Taints:             node-role.kubernetes.io/control-plane:NoSchedule</span>
</span></span><span id="__span-58-24"><a id="__codelineno-58-24" name="__codelineno-58-24" href="#__codelineno-58-24"></a><span class="go">Unschedulable:      false</span>
</span><span id="__span-58-25"><a id="__codelineno-58-25" name="__codelineno-58-25" href="#__codelineno-58-25"></a><span class="go">Lease:</span>
</span><span id="__span-58-26"><a id="__codelineno-58-26" name="__codelineno-58-26" href="#__codelineno-58-26"></a><span class="go">  HolderIdentity:  alfred</span>
</span><span id="__span-58-27"><a id="__codelineno-58-27" name="__codelineno-58-27" href="#__codelineno-58-27"></a><span class="go">  AcquireTime:     &lt;unset&gt;</span>
</span><span id="__span-58-28"><a id="__codelineno-58-28" name="__codelineno-58-28" href="#__codelineno-58-28"></a><span class="go">  RenewTime:       Sat, 22 Feb 2025 20:50:44 +0100</span>
</span></code></pre></div>
<p>Remove this taint to allow other pods to be scheduled:</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-59-1"><a id="__codelineno-59-1" name="__codelineno-59-1" href="#__codelineno-59-1"></a><span class="gp">$ </span>kubectl<span class="w"> </span>taint<span class="w"> </span>nodes<span class="w"> </span>--all<span class="w"> </span>node-role.kubernetes.io/control-plane-
</span><span id="__span-59-2"><a id="__codelineno-59-2" name="__codelineno-59-2" href="#__codelineno-59-2"></a><span class="go">node/alfred untainted</span>
</span><span id="__span-59-3"><a id="__codelineno-59-3" name="__codelineno-59-3" href="#__codelineno-59-3"></a>
</span><span id="__span-59-4"><a id="__codelineno-59-4" name="__codelineno-59-4" href="#__codelineno-59-4"></a><span class="gp">$ </span>kubectl<span class="w"> </span>describe<span class="w"> </span>node<span class="w"> </span>alfred<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>-i<span class="w"> </span>taint
</span><span id="__span-59-5"><a id="__codelineno-59-5" name="__codelineno-59-5" href="#__codelineno-59-5"></a><span class="go">Taints:             &lt;none&gt;</span>
</span></code></pre></div>
<h4 id="test-pod-scheduling">Test pod scheduling</h4>
<div class="language-console highlight"><pre><span></span><code><span id="__span-60-1"><a id="__codelineno-60-1" name="__codelineno-60-1" href="#__codelineno-60-1"></a><span class="gp">$ </span>kubectl<span class="w"> </span>apply<span class="w"> </span>-f<span class="w"> </span>https://k8s.io/examples/pods/commands.yaml
</span><span id="__span-60-2"><a id="__codelineno-60-2" name="__codelineno-60-2" href="#__codelineno-60-2"></a><span class="go">pod/command-demo created</span>
</span><span id="__span-60-3"><a id="__codelineno-60-3" name="__codelineno-60-3" href="#__codelineno-60-3"></a>
</span><span id="__span-60-4"><a id="__codelineno-60-4" name="__codelineno-60-4" href="#__codelineno-60-4"></a><span class="gp">$ </span>kubectl<span class="w"> </span>get<span class="w"> </span>all
</span><span id="__span-60-5"><a id="__codelineno-60-5" name="__codelineno-60-5" href="#__codelineno-60-5"></a><span class="go">NAME               READY   STATUS              RESTARTS   AGE</span>
</span><span id="__span-60-6"><a id="__codelineno-60-6" name="__codelineno-60-6" href="#__codelineno-60-6"></a><span class="go">pod/command-demo   0/1     ContainerCreating   0          7s</span>
</span><span id="__span-60-7"><a id="__codelineno-60-7" name="__codelineno-60-7" href="#__codelineno-60-7"></a>
</span><span id="__span-60-8"><a id="__codelineno-60-8" name="__codelineno-60-8" href="#__codelineno-60-8"></a><span class="go">NAME                 TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)   AGE</span>
</span><span id="__span-60-9"><a id="__codelineno-60-9" name="__codelineno-60-9" href="#__codelineno-60-9"></a><span class="go">service/kubernetes   ClusterIP   10.96.0.1    &lt;none&gt;        443/TCP   172m</span>
</span><span id="__span-60-10"><a id="__codelineno-60-10" name="__codelineno-60-10" href="#__codelineno-60-10"></a>
</span><span id="__span-60-11"><a id="__codelineno-60-11" name="__codelineno-60-11" href="#__codelineno-60-11"></a><span class="gp">$ </span>kubectl<span class="w"> </span>get<span class="w"> </span>all
</span><span id="__span-60-12"><a id="__codelineno-60-12" name="__codelineno-60-12" href="#__codelineno-60-12"></a><span class="go">NAME               READY   STATUS      RESTARTS   AGE</span>
</span><span id="__span-60-13"><a id="__codelineno-60-13" name="__codelineno-60-13" href="#__codelineno-60-13"></a><span class="go">pod/command-demo   0/1     Completed   0          14s</span>
</span><span id="__span-60-14"><a id="__codelineno-60-14" name="__codelineno-60-14" href="#__codelineno-60-14"></a>
</span><span id="__span-60-15"><a id="__codelineno-60-15" name="__codelineno-60-15" href="#__codelineno-60-15"></a><span class="go">NAME                 TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)   AGE</span>
</span><span id="__span-60-16"><a id="__codelineno-60-16" name="__codelineno-60-16" href="#__codelineno-60-16"></a><span class="go">service/kubernetes   ClusterIP   10.96.0.1    &lt;none&gt;        443/TCP   172m</span>
</span><span id="__span-60-17"><a id="__codelineno-60-17" name="__codelineno-60-17" href="#__codelineno-60-17"></a>
</span><span id="__span-60-18"><a id="__codelineno-60-18" name="__codelineno-60-18" href="#__codelineno-60-18"></a><span class="gp">$ </span>kubectl<span class="w"> </span>events<span class="w"> </span>pods
</span><span id="__span-60-19"><a id="__codelineno-60-19" name="__codelineno-60-19" href="#__codelineno-60-19"></a><span class="go">LAST SEEN           TYPE      REASON                    OBJECT             MESSAGE</span>
</span><span id="__span-60-20"><a id="__codelineno-60-20" name="__codelineno-60-20" href="#__codelineno-60-20"></a><span class="go">...</span>
</span><span id="__span-60-21"><a id="__codelineno-60-21" name="__codelineno-60-21" href="#__codelineno-60-21"></a><span class="go">12m                 Normal    Starting                  Node/alfred        </span>
</span><span id="__span-60-22"><a id="__codelineno-60-22" name="__codelineno-60-22" href="#__codelineno-60-22"></a><span class="go">12m                 Normal    RegisteredNode            Node/alfred        Node alfred event: Registered Node alfred in Controller</span>
</span><span id="__span-60-23"><a id="__codelineno-60-23" name="__codelineno-60-23" href="#__codelineno-60-23"></a><span class="go">19s                 Normal    Pulling                   Pod/command-demo   Pulling image "debian"</span>
</span><span id="__span-60-24"><a id="__codelineno-60-24" name="__codelineno-60-24" href="#__codelineno-60-24"></a><span class="go">19s                 Normal    Scheduled                 Pod/command-demo   Successfully assigned default/command-demo to alfred</span>
</span><span id="__span-60-25"><a id="__codelineno-60-25" name="__codelineno-60-25" href="#__codelineno-60-25"></a><span class="go">8s                  Normal    Pulled                    Pod/command-demo   Successfully pulled image "debian" in 11.231s (11.231s including waiting). Image size: 48316582 bytes.</span>
</span><span id="__span-60-26"><a id="__codelineno-60-26" name="__codelineno-60-26" href="#__codelineno-60-26"></a><span class="hll"><span class="go">8s                  Normal    Created                   Pod/command-demo   Created container: command-demo-container</span>
</span></span><span id="__span-60-27"><a id="__codelineno-60-27" name="__codelineno-60-27" href="#__codelineno-60-27"></a><span class="hll"><span class="go">7s                  Normal    Started                   Pod/command-demo   Started container command-demo-container</span>
</span></span></code></pre></div>
<p>With the cluster now ready to run pods and services, move on to installing
more components that will be used by the actual services:
<a href="#metallb-load-balancer">MetalLB Load Balancer</a>,
<a href="#kubernetes-dashboard">Kubernets Dashboard</a>,
<a href="#ingress-controller">Ingress Controller</a>,
<a href="#https-certificates">HTTPS certificates</a>
with Lets Encrypt, including
<a href="#automatic-renovation">automatically renovated monthly</a>.</p>
<p><a href="../../../../2023/03/25/single-node-kubernetes-cluster-on-ubuntu-server-lexicon/#localpath-pv-provisioner">LocalPath PV provisioner</a>
for simple persistent storage in local file systems may be setup later,
but experience with previous clusters so far has proven this unnecessary.</p>
<h3 id="metallb-load-balancer">MetalLB Load Balancer</h3>
<p>A Load Balancer is going to be necessary for the 
<a href="#kubernetes-dashboard">Dashboard</a> and other services, to expose individual
services via open ports on the server (<code>NodePort</code>) or virtual IP addresses.
<a href="https://metallb.universe.tf/installation/#installation-by-manifest">Installation By Manifest</a>
is as simple as applying the provided manifest:</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-61-1"><a id="__codelineno-61-1" name="__codelineno-61-1" href="#__codelineno-61-1"></a><span class="gp">$ </span>wget<span class="w"> </span><span class="se">\</span>
</span><span id="__span-61-2"><a id="__codelineno-61-2" name="__codelineno-61-2" href="#__codelineno-61-2"></a><span class="w">  </span>https://raw.githubusercontent.com/metallb/metallb/v0.14.9/config/manifests/metallb-native.yaml
</span><span id="__span-61-3"><a id="__codelineno-61-3" name="__codelineno-61-3" href="#__codelineno-61-3"></a>
</span><span id="__span-61-4"><a id="__codelineno-61-4" name="__codelineno-61-4" href="#__codelineno-61-4"></a><span class="gp">$ </span>kubectl<span class="w"> </span>apply<span class="w"> </span>-f<span class="w"> </span>metallb/metallb-native.yaml
</span><span id="__span-61-5"><a id="__codelineno-61-5" name="__codelineno-61-5" href="#__codelineno-61-5"></a><span class="go">namespace/metallb-system created</span>
</span><span id="__span-61-6"><a id="__codelineno-61-6" name="__codelineno-61-6" href="#__codelineno-61-6"></a><span class="go">customresourcedefinition.apiextensions.k8s.io/bfdprofiles.metallb.io created</span>
</span><span id="__span-61-7"><a id="__codelineno-61-7" name="__codelineno-61-7" href="#__codelineno-61-7"></a><span class="go">customresourcedefinition.apiextensions.k8s.io/bgpadvertisements.metallb.io created</span>
</span><span id="__span-61-8"><a id="__codelineno-61-8" name="__codelineno-61-8" href="#__codelineno-61-8"></a><span class="go">customresourcedefinition.apiextensions.k8s.io/bgppeers.metallb.io created</span>
</span><span id="__span-61-9"><a id="__codelineno-61-9" name="__codelineno-61-9" href="#__codelineno-61-9"></a><span class="go">customresourcedefinition.apiextensions.k8s.io/communities.metallb.io created</span>
</span><span id="__span-61-10"><a id="__codelineno-61-10" name="__codelineno-61-10" href="#__codelineno-61-10"></a><span class="go">customresourcedefinition.apiextensions.k8s.io/ipaddresspools.metallb.io created</span>
</span><span id="__span-61-11"><a id="__codelineno-61-11" name="__codelineno-61-11" href="#__codelineno-61-11"></a><span class="go">customresourcedefinition.apiextensions.k8s.io/l2advertisements.metallb.io created</span>
</span><span id="__span-61-12"><a id="__codelineno-61-12" name="__codelineno-61-12" href="#__codelineno-61-12"></a><span class="go">customresourcedefinition.apiextensions.k8s.io/servicel2statuses.metallb.io created</span>
</span><span id="__span-61-13"><a id="__codelineno-61-13" name="__codelineno-61-13" href="#__codelineno-61-13"></a><span class="go">serviceaccount/controller created</span>
</span><span id="__span-61-14"><a id="__codelineno-61-14" name="__codelineno-61-14" href="#__codelineno-61-14"></a><span class="go">serviceaccount/speaker created</span>
</span><span id="__span-61-15"><a id="__codelineno-61-15" name="__codelineno-61-15" href="#__codelineno-61-15"></a><span class="go">role.rbac.authorization.k8s.io/controller created</span>
</span><span id="__span-61-16"><a id="__codelineno-61-16" name="__codelineno-61-16" href="#__codelineno-61-16"></a><span class="go">role.rbac.authorization.k8s.io/pod-lister created</span>
</span><span id="__span-61-17"><a id="__codelineno-61-17" name="__codelineno-61-17" href="#__codelineno-61-17"></a><span class="go">clusterrole.rbac.authorization.k8s.io/metallb-system:controller created</span>
</span><span id="__span-61-18"><a id="__codelineno-61-18" name="__codelineno-61-18" href="#__codelineno-61-18"></a><span class="go">clusterrole.rbac.authorization.k8s.io/metallb-system:speaker created</span>
</span><span id="__span-61-19"><a id="__codelineno-61-19" name="__codelineno-61-19" href="#__codelineno-61-19"></a><span class="go">rolebinding.rbac.authorization.k8s.io/controller created</span>
</span><span id="__span-61-20"><a id="__codelineno-61-20" name="__codelineno-61-20" href="#__codelineno-61-20"></a><span class="go">rolebinding.rbac.authorization.k8s.io/pod-lister created</span>
</span><span id="__span-61-21"><a id="__codelineno-61-21" name="__codelineno-61-21" href="#__codelineno-61-21"></a><span class="go">clusterrolebinding.rbac.authorization.k8s.io/metallb-system:controller created</span>
</span><span id="__span-61-22"><a id="__codelineno-61-22" name="__codelineno-61-22" href="#__codelineno-61-22"></a><span class="go">clusterrolebinding.rbac.authorization.k8s.io/metallb-system:speaker created</span>
</span><span id="__span-61-23"><a id="__codelineno-61-23" name="__codelineno-61-23" href="#__codelineno-61-23"></a><span class="go">configmap/metallb-excludel2 created</span>
</span><span id="__span-61-24"><a id="__codelineno-61-24" name="__codelineno-61-24" href="#__codelineno-61-24"></a><span class="go">secret/metallb-webhook-cert created</span>
</span><span id="__span-61-25"><a id="__codelineno-61-25" name="__codelineno-61-25" href="#__codelineno-61-25"></a><span class="go">service/metallb-webhook-service created</span>
</span><span id="__span-61-26"><a id="__codelineno-61-26" name="__codelineno-61-26" href="#__codelineno-61-26"></a><span class="go">deployment.apps/controller created</span>
</span><span id="__span-61-27"><a id="__codelineno-61-27" name="__codelineno-61-27" href="#__codelineno-61-27"></a><span class="go">daemonset.apps/speaker created</span>
</span><span id="__span-61-28"><a id="__codelineno-61-28" name="__codelineno-61-28" href="#__codelineno-61-28"></a><span class="go">validatingwebhookconfiguration.admissionregistration.k8s.io/metallb-webhook-configuration created</span>
</span></code></pre></div>
<p>Soon enough the deployment should have the controller and speaker running:</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-62-1"><a id="__codelineno-62-1" name="__codelineno-62-1" href="#__codelineno-62-1"></a><span class="gp">$ </span>kubectl<span class="w"> </span>get<span class="w"> </span>all<span class="w"> </span>-n<span class="w"> </span>metallb-system
</span><span id="__span-62-2"><a id="__codelineno-62-2" name="__codelineno-62-2" href="#__codelineno-62-2"></a><span class="go">NAME                             READY   STATUS    RESTARTS   AGE</span>
</span><span id="__span-62-3"><a id="__codelineno-62-3" name="__codelineno-62-3" href="#__codelineno-62-3"></a><span class="go">pod/controller-bb5f47665-hgctc   1/1     Running   0          3m47s</span>
</span><span id="__span-62-4"><a id="__codelineno-62-4" name="__codelineno-62-4" href="#__codelineno-62-4"></a><span class="go">pod/speaker-974wc                1/1     Running   0          3m47s</span>
</span><span id="__span-62-5"><a id="__codelineno-62-5" name="__codelineno-62-5" href="#__codelineno-62-5"></a>
</span><span id="__span-62-6"><a id="__codelineno-62-6" name="__codelineno-62-6" href="#__codelineno-62-6"></a><span class="go">NAME                              TYPE        CLUSTER-IP    EXTERNAL-IP   PORT(S)   AGE</span>
</span><span id="__span-62-7"><a id="__codelineno-62-7" name="__codelineno-62-7" href="#__codelineno-62-7"></a><span class="go">service/metallb-webhook-service   ClusterIP   10.97.34.85   &lt;none&gt;        443/TCP   3m47s</span>
</span><span id="__span-62-8"><a id="__codelineno-62-8" name="__codelineno-62-8" href="#__codelineno-62-8"></a>
</span><span id="__span-62-9"><a id="__codelineno-62-9" name="__codelineno-62-9" href="#__codelineno-62-9"></a><span class="go">NAME                     DESIRED   CURRENT   READY   UP-TO-DATE   AVAILABLE   NODE SELECTOR            AGE</span>
</span><span id="__span-62-10"><a id="__codelineno-62-10" name="__codelineno-62-10" href="#__codelineno-62-10"></a><span class="go">daemonset.apps/speaker   1         1         1       1            1           kubernetes.io/os=linux   3m47s</span>
</span><span id="__span-62-11"><a id="__codelineno-62-11" name="__codelineno-62-11" href="#__codelineno-62-11"></a>
</span><span id="__span-62-12"><a id="__codelineno-62-12" name="__codelineno-62-12" href="#__codelineno-62-12"></a><span class="go">NAME                         READY   UP-TO-DATE   AVAILABLE   AGE</span>
</span><span id="__span-62-13"><a id="__codelineno-62-13" name="__codelineno-62-13" href="#__codelineno-62-13"></a><span class="go">deployment.apps/controller   1/1     1            1           3m47s</span>
</span><span id="__span-62-14"><a id="__codelineno-62-14" name="__codelineno-62-14" href="#__codelineno-62-14"></a>
</span><span id="__span-62-15"><a id="__codelineno-62-15" name="__codelineno-62-15" href="#__codelineno-62-15"></a><span class="go">NAME                                   DESIRED   CURRENT   READY   AGE</span>
</span><span id="__span-62-16"><a id="__codelineno-62-16" name="__codelineno-62-16" href="#__codelineno-62-16"></a><span class="go">replicaset.apps/controller-bb5f47665   1         1         1       3m47s</span>
</span></code></pre></div>
<p>MetalLB remains idle until configured, which is done by deploying resources
into its namespace (<code>metallb-system</code>). In this PC, a small range of IP
addresses is advertised via 
<a href="https://metallb.universe.tf/configuration/#layer-2-configuration">Layer 2 Configuration</a>,
which does not not require the IPs to be bound to the network interfaces:</p>
<div class="language-yaml highlight"><span class="filename">metallb/ipaddress-pool-alfred.yaml</span><pre><span></span><code><span id="__span-63-1"><a id="__codelineno-63-1" name="__codelineno-63-1" href="#__codelineno-63-1"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">metallb.io/v1beta1</span>
</span><span id="__span-63-2"><a id="__codelineno-63-2" name="__codelineno-63-2" href="#__codelineno-63-2"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">IPAddressPool</span>
</span><span id="__span-63-3"><a id="__codelineno-63-3" name="__codelineno-63-3" href="#__codelineno-63-3"></a><span class="nt">metadata</span><span class="p">:</span>
</span><span id="__span-63-4"><a id="__codelineno-63-4" name="__codelineno-63-4" href="#__codelineno-63-4"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">production</span>
</span><span id="__span-63-5"><a id="__codelineno-63-5" name="__codelineno-63-5" href="#__codelineno-63-5"></a><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">metallb-system</span>
</span><span id="__span-63-6"><a id="__codelineno-63-6" name="__codelineno-63-6" href="#__codelineno-63-6"></a><span class="nt">spec</span><span class="p">:</span>
</span><span id="__span-63-7"><a id="__codelineno-63-7" name="__codelineno-63-7" href="#__codelineno-63-7"></a><span class="w">  </span><span class="nt">addresses</span><span class="p">:</span>
</span><span id="__span-63-8"><a id="__codelineno-63-8" name="__codelineno-63-8" href="#__codelineno-63-8"></a><span class="hll"><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">192.168.0.151-192.168.0.160</span>
</span></span><span id="__span-63-9"><a id="__codelineno-63-9" name="__codelineno-63-9" href="#__codelineno-63-9"></a><span class="nn">---</span>
</span><span id="__span-63-10"><a id="__codelineno-63-10" name="__codelineno-63-10" href="#__codelineno-63-10"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">metallb.io/v1beta1</span>
</span><span id="__span-63-11"><a id="__codelineno-63-11" name="__codelineno-63-11" href="#__codelineno-63-11"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">L2Advertisement</span>
</span><span id="__span-63-12"><a id="__codelineno-63-12" name="__codelineno-63-12" href="#__codelineno-63-12"></a><span class="nt">metadata</span><span class="p">:</span>
</span><span id="__span-63-13"><a id="__codelineno-63-13" name="__codelineno-63-13" href="#__codelineno-63-13"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">l2-advert</span>
</span><span id="__span-63-14"><a id="__codelineno-63-14" name="__codelineno-63-14" href="#__codelineno-63-14"></a><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">metallb-system</span>
</span></code></pre></div>
<p>The range is based on the local DHCP server configuration and which IPs are 
currently in use; this range has just not been leased so far. The reason to
use IPs from the leased range is that the router only allows adding port
forwarding rules for those. This range is intentionally on the same network
range and subnet as the DHCP server so that no routing is needed to reach
MetalLB IPs.</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-64-1"><a id="__codelineno-64-1" name="__codelineno-64-1" href="#__codelineno-64-1"></a><span class="gp">$ </span>kubectl<span class="w"> </span>apply<span class="w"> </span>-f<span class="w"> </span>ipaddress-pool-alfred.yaml
</span><span id="__span-64-2"><a id="__codelineno-64-2" name="__codelineno-64-2" href="#__codelineno-64-2"></a><span class="go">ipaddresspool.metallb.io/production created</span>
</span><span id="__span-64-3"><a id="__codelineno-64-3" name="__codelineno-64-3" href="#__codelineno-64-3"></a><span class="go">l2advertisement.metallb.io/l2-advert created</span>
</span><span id="__span-64-4"><a id="__codelineno-64-4" name="__codelineno-64-4" href="#__codelineno-64-4"></a>
</span><span id="__span-64-5"><a id="__codelineno-64-5" name="__codelineno-64-5" href="#__codelineno-64-5"></a><span class="gp">$ </span>kubectl<span class="w"> </span>get<span class="w"> </span>ipaddresspool.metallb.io<span class="w"> </span>-n<span class="w"> </span>metallb-system<span class="w"> </span>
</span><span id="__span-64-6"><a id="__codelineno-64-6" name="__codelineno-64-6" href="#__codelineno-64-6"></a><span class="go">NAME         AUTO ASSIGN   AVOID BUGGY IPS   ADDRESSES</span>
</span><span id="__span-64-7"><a id="__codelineno-64-7" name="__codelineno-64-7" href="#__codelineno-64-7"></a><span class="go">production   true          false             ["192.168.0.151-192.168.0.160"]</span>
</span><span id="__span-64-8"><a id="__codelineno-64-8" name="__codelineno-64-8" href="#__codelineno-64-8"></a>
</span><span id="__span-64-9"><a id="__codelineno-64-9" name="__codelineno-64-9" href="#__codelineno-64-9"></a><span class="gp">$ </span>kubectl<span class="w"> </span>get<span class="w"> </span>l2advertisement.metallb.io<span class="w"> </span>-n<span class="w"> </span>metallb-system<span class="w"> </span>
</span><span id="__span-64-10"><a id="__codelineno-64-10" name="__codelineno-64-10" href="#__codelineno-64-10"></a><span class="go">NAME        IPADDRESSPOOLS   IPADDRESSPOOL SELECTORS   INTERFACES</span>
</span><span id="__span-64-11"><a id="__codelineno-64-11" name="__codelineno-64-11" href="#__codelineno-64-11"></a><span class="go">l2-advert                                              </span>
</span><span id="__span-64-12"><a id="__codelineno-64-12" name="__codelineno-64-12" href="#__codelineno-64-12"></a>
</span><span id="__span-64-13"><a id="__codelineno-64-13" name="__codelineno-64-13" href="#__codelineno-64-13"></a><span class="gp">$ </span>kubectl<span class="w"> </span>describe<span class="w"> </span>ipaddresspool.metallb.io<span class="w"> </span>production<span class="w"> </span>-n<span class="w"> </span>metallb-system<span class="w"> </span>
</span><span id="__span-64-14"><a id="__codelineno-64-14" name="__codelineno-64-14" href="#__codelineno-64-14"></a><span class="go">Name:         production</span>
</span><span id="__span-64-15"><a id="__codelineno-64-15" name="__codelineno-64-15" href="#__codelineno-64-15"></a><span class="go">Namespace:    metallb-system</span>
</span><span id="__span-64-16"><a id="__codelineno-64-16" name="__codelineno-64-16" href="#__codelineno-64-16"></a><span class="go">Labels:       &lt;none&gt;</span>
</span><span id="__span-64-17"><a id="__codelineno-64-17" name="__codelineno-64-17" href="#__codelineno-64-17"></a><span class="go">Annotations:  &lt;none&gt;</span>
</span><span id="__span-64-18"><a id="__codelineno-64-18" name="__codelineno-64-18" href="#__codelineno-64-18"></a><span class="go">API Version:  metallb.io/v1beta1</span>
</span><span id="__span-64-19"><a id="__codelineno-64-19" name="__codelineno-64-19" href="#__codelineno-64-19"></a><span class="go">Kind:         IPAddressPool</span>
</span><span id="__span-64-20"><a id="__codelineno-64-20" name="__codelineno-64-20" href="#__codelineno-64-20"></a><span class="go">Metadata:</span>
</span><span id="__span-64-21"><a id="__codelineno-64-21" name="__codelineno-64-21" href="#__codelineno-64-21"></a><span class="go">  Creation Timestamp:  2025-02-22T21:45:44Z</span>
</span><span id="__span-64-22"><a id="__codelineno-64-22" name="__codelineno-64-22" href="#__codelineno-64-22"></a><span class="go">  Generation:          1</span>
</span><span id="__span-64-23"><a id="__codelineno-64-23" name="__codelineno-64-23" href="#__codelineno-64-23"></a><span class="go">  Resource Version:    22690</span>
</span><span id="__span-64-24"><a id="__codelineno-64-24" name="__codelineno-64-24" href="#__codelineno-64-24"></a><span class="go">  UID:                 ca4ffb14-4063-4a63-8ab4-75995db0347c</span>
</span><span id="__span-64-25"><a id="__codelineno-64-25" name="__codelineno-64-25" href="#__codelineno-64-25"></a><span class="go">Spec:</span>
</span><span id="__span-64-26"><a id="__codelineno-64-26" name="__codelineno-64-26" href="#__codelineno-64-26"></a><span class="go">  Addresses:</span>
</span><span id="__span-64-27"><a id="__codelineno-64-27" name="__codelineno-64-27" href="#__codelineno-64-27"></a><span class="go">    192.168.0.151-192.168.0.160</span>
</span><span id="__span-64-28"><a id="__codelineno-64-28" name="__codelineno-64-28" href="#__codelineno-64-28"></a><span class="go">  Auto Assign:       true</span>
</span><span id="__span-64-29"><a id="__codelineno-64-29" name="__codelineno-64-29" href="#__codelineno-64-29"></a><span class="go">  Avoid Buggy I Ps:  false</span>
</span><span id="__span-64-30"><a id="__codelineno-64-30" name="__codelineno-64-30" href="#__codelineno-64-30"></a><span class="go">Events:              &lt;none&gt;</span>
</span></code></pre></div>
<h4 id="2026-upgrade-to-helm-chart"><strong>2026</strong> Upgrade to Helm chart</h4>
<p><a href="../../../../2026/01/10/upgrading-single-node-kubernetes-cluster-on-ubuntu-studio-2404-octavo/">Upgrading Kubernetes</a>
eventually reached a point where MetalLB needed to be upgraded too; upgrading to
Kubernetes 1.35 requires MetalLB 0.15 or later.</p>
<p>MetalLb was last using the <code>metallb-native.yaml</code> instead of its Helm chart, and there
is a <code>IPAddressPool</code> defined in a separate manifest, so now in order to migrate to the
Helm chart without losing IP assignments or causing a collision, the migration needs to
perform a "takeover". Kubernetes allows Helm to manage existing resources if they are correctly labeled and annotated. The <code>IPAddressPool</code> and <code>L2Advertisement</code> are Custom
Resources (CRD). Helm will not delete these during the upgrade if the namespace is
handled correctly, but they should be backed up first:</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-65-1"><a id="__codelineno-65-1" name="__codelineno-65-1" href="#__codelineno-65-1"></a><span class="gp">$ </span>kubectl<span class="w"> </span>get<span class="w"> </span>ipaddresspools.metallb.io,l2advertisements.metallb.io<span class="w"> </span>-A<span class="w"> </span>-o<span class="w"> </span>yaml<span class="w"> </span><span class="se">\</span>
</span><span id="__span-65-2"><a id="__codelineno-65-2" name="__codelineno-65-2" href="#__codelineno-65-2"></a><span class="w">  </span>&gt;<span class="w"> </span>metallb-config-backup.yaml
</span></code></pre></div>
<p>Install the MetalLB Helm chart:</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-66-1"><a id="__codelineno-66-1" name="__codelineno-66-1" href="#__codelineno-66-1"></a><span class="gp">$ </span>helm<span class="w"> </span>repo<span class="w"> </span>add<span class="w"> </span>metallb<span class="w"> </span>https://metallb.github.io/metallb
</span><span id="__span-66-2"><a id="__codelineno-66-2" name="__codelineno-66-2" href="#__codelineno-66-2"></a><span class="go">"metallb" has been added to your repositories</span>
</span><span id="__span-66-3"><a id="__codelineno-66-3" name="__codelineno-66-3" href="#__codelineno-66-3"></a>
</span><span id="__span-66-4"><a id="__codelineno-66-4" name="__codelineno-66-4" href="#__codelineno-66-4"></a><span class="gp">$ </span>helm<span class="w"> </span>repo<span class="w"> </span>update
</span><span id="__span-66-5"><a id="__codelineno-66-5" name="__codelineno-66-5" href="#__codelineno-66-5"></a><span class="go">Hang tight while we grab the latest from your chart repositories...</span>
</span><span id="__span-66-6"><a id="__codelineno-66-6" name="__codelineno-66-6" href="#__codelineno-66-6"></a><span class="go">...Successfully got an update from the "metallb" chart repository</span>
</span><span id="__span-66-7"><a id="__codelineno-66-7" name="__codelineno-66-7" href="#__codelineno-66-7"></a><span class="go">...</span>
</span><span id="__span-66-8"><a id="__codelineno-66-8" name="__codelineno-66-8" href="#__codelineno-66-8"></a><span class="go">Update Complete. Happy Helming!</span>
</span></code></pre></div>
<p>To minimize downtime during the takeover, pre-pull the Docker images so that the Helm
installation happens in seconds rather than minutes:</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-67-1"><a id="__codelineno-67-1" name="__codelineno-67-1" href="#__codelineno-67-1"></a><span class="gp"># </span>docker<span class="w"> </span>pull<span class="w"> </span>quay.io/metallb/speaker:v0.15.3
</span><span id="__span-67-2"><a id="__codelineno-67-2" name="__codelineno-67-2" href="#__codelineno-67-2"></a><span class="go">v0.15.3: Pulling from metallb/speaker</span>
</span><span id="__span-67-3"><a id="__codelineno-67-3" name="__codelineno-67-3" href="#__codelineno-67-3"></a><span class="go">fd4aa3667332: Pull complete </span>
</span><span id="__span-67-4"><a id="__codelineno-67-4" name="__codelineno-67-4" href="#__codelineno-67-4"></a><span class="go">...</span>
</span><span id="__span-67-5"><a id="__codelineno-67-5" name="__codelineno-67-5" href="#__codelineno-67-5"></a><span class="go">07003b9acb06: Pull complete </span>
</span><span id="__span-67-6"><a id="__codelineno-67-6" name="__codelineno-67-6" href="#__codelineno-67-6"></a><span class="go">Digest: sha256:c6a5b25b2e1fba610a57b2db4bb8141d7c133569d561a8cc29e38ca5113efbc4</span>
</span><span id="__span-67-7"><a id="__codelineno-67-7" name="__codelineno-67-7" href="#__codelineno-67-7"></a><span class="go">Status: Downloaded newer image for quay.io/metallb/speaker:v0.15.3</span>
</span><span id="__span-67-8"><a id="__codelineno-67-8" name="__codelineno-67-8" href="#__codelineno-67-8"></a><span class="go">quay.io/metallb/speaker:v0.15.3</span>
</span><span id="__span-67-9"><a id="__codelineno-67-9" name="__codelineno-67-9" href="#__codelineno-67-9"></a>
</span><span id="__span-67-10"><a id="__codelineno-67-10" name="__codelineno-67-10" href="#__codelineno-67-10"></a><span class="gp"># </span>docker<span class="w"> </span>pull<span class="w"> </span>quay.io/metallb/controller:v0.15.3
</span><span id="__span-67-11"><a id="__codelineno-67-11" name="__codelineno-67-11" href="#__codelineno-67-11"></a><span class="go">v0.15.3: Pulling from metallb/controller</span>
</span><span id="__span-67-12"><a id="__codelineno-67-12" name="__codelineno-67-12" href="#__codelineno-67-12"></a><span class="go">fd4aa3667332: Already exists </span>
</span><span id="__span-67-13"><a id="__codelineno-67-13" name="__codelineno-67-13" href="#__codelineno-67-13"></a><span class="go">...</span>
</span><span id="__span-67-14"><a id="__codelineno-67-14" name="__codelineno-67-14" href="#__codelineno-67-14"></a><span class="go">ddf74a63f7d8: Already exists </span>
</span><span id="__span-67-15"><a id="__codelineno-67-15" name="__codelineno-67-15" href="#__codelineno-67-15"></a><span class="go">6dff88f058c1: Pull complete </span>
</span><span id="__span-67-16"><a id="__codelineno-67-16" name="__codelineno-67-16" href="#__codelineno-67-16"></a><span class="go">db83dd67de88: Pull complete </span>
</span><span id="__span-67-17"><a id="__codelineno-67-17" name="__codelineno-67-17" href="#__codelineno-67-17"></a><span class="go">Digest: sha256:6698ccc54c380913816ed1fd0758637ec87dd79da419c4ab170a2c26c158ab89</span>
</span><span id="__span-67-18"><a id="__codelineno-67-18" name="__codelineno-67-18" href="#__codelineno-67-18"></a><span class="go">Status: Downloaded newer image for quay.io/metallb/controller:v0.15.3</span>
</span><span id="__span-67-19"><a id="__codelineno-67-19" name="__codelineno-67-19" href="#__codelineno-67-19"></a><span class="go">quay.io/metallb/controller:v0.15.3</span>
</span></code></pre></div>
<p>Helm requires specific metadata to "adopt" existing resources. Without this, Helm will
fail with an "already exists" error. To avoid this, annotate and label the namespace:</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-68-1"><a id="__codelineno-68-1" name="__codelineno-68-1" href="#__codelineno-68-1"></a><span class="gp">$ </span>kubectl<span class="w"> </span>describe<span class="w"> </span>namespaces<span class="w"> </span>metallb-system<span class="w"> </span>
</span><span id="__span-68-2"><a id="__codelineno-68-2" name="__codelineno-68-2" href="#__codelineno-68-2"></a><span class="go">Name:         metallb-system</span>
</span><span id="__span-68-3"><a id="__codelineno-68-3" name="__codelineno-68-3" href="#__codelineno-68-3"></a><span class="go">Labels:       kubernetes.io/metadata.name=metallb-system</span>
</span><span id="__span-68-4"><a id="__codelineno-68-4" name="__codelineno-68-4" href="#__codelineno-68-4"></a><span class="go">              pod-security.kubernetes.io/audit=privileged</span>
</span><span id="__span-68-5"><a id="__codelineno-68-5" name="__codelineno-68-5" href="#__codelineno-68-5"></a><span class="go">              pod-security.kubernetes.io/enforce=privileged</span>
</span><span id="__span-68-6"><a id="__codelineno-68-6" name="__codelineno-68-6" href="#__codelineno-68-6"></a><span class="go">              pod-security.kubernetes.io/warn=privileged</span>
</span><span id="__span-68-7"><a id="__codelineno-68-7" name="__codelineno-68-7" href="#__codelineno-68-7"></a><span class="go">Annotations:  &lt;none&gt;</span>
</span><span id="__span-68-8"><a id="__codelineno-68-8" name="__codelineno-68-8" href="#__codelineno-68-8"></a><span class="go">Status:       Active</span>
</span><span id="__span-68-9"><a id="__codelineno-68-9" name="__codelineno-68-9" href="#__codelineno-68-9"></a>
</span><span id="__span-68-10"><a id="__codelineno-68-10" name="__codelineno-68-10" href="#__codelineno-68-10"></a><span class="go">No resource quota.</span>
</span><span id="__span-68-11"><a id="__codelineno-68-11" name="__codelineno-68-11" href="#__codelineno-68-11"></a>
</span><span id="__span-68-12"><a id="__codelineno-68-12" name="__codelineno-68-12" href="#__codelineno-68-12"></a><span class="go">No LimitRange resource.</span>
</span><span id="__span-68-13"><a id="__codelineno-68-13" name="__codelineno-68-13" href="#__codelineno-68-13"></a>
</span><span id="__span-68-14"><a id="__codelineno-68-14" name="__codelineno-68-14" href="#__codelineno-68-14"></a><span class="gp">$ </span>kubectl<span class="w"> </span>annotate<span class="w"> </span>namespace<span class="w"> </span>metallb-system<span class="w"> </span>meta.helm.sh/release-name<span class="o">=</span>metallb
</span><span id="__span-68-15"><a id="__codelineno-68-15" name="__codelineno-68-15" href="#__codelineno-68-15"></a><span class="go">namespace/metallb-system annotated</span>
</span><span id="__span-68-16"><a id="__codelineno-68-16" name="__codelineno-68-16" href="#__codelineno-68-16"></a>
</span><span id="__span-68-17"><a id="__codelineno-68-17" name="__codelineno-68-17" href="#__codelineno-68-17"></a><span class="gp">$ </span>kubectl<span class="w"> </span>annotate<span class="w"> </span>namespace<span class="w"> </span>metallb-system<span class="w"> </span>meta.helm.sh/release-namespace<span class="o">=</span>metallb-system
</span><span id="__span-68-18"><a id="__codelineno-68-18" name="__codelineno-68-18" href="#__codelineno-68-18"></a><span class="go">namespace/metallb-system annotated</span>
</span><span id="__span-68-19"><a id="__codelineno-68-19" name="__codelineno-68-19" href="#__codelineno-68-19"></a>
</span><span id="__span-68-20"><a id="__codelineno-68-20" name="__codelineno-68-20" href="#__codelineno-68-20"></a><span class="gp">$ </span>kubectl<span class="w"> </span>label<span class="w"> </span>namespace<span class="w"> </span>metallb-system<span class="w"> </span>app.kubernetes.io/managed-by<span class="o">=</span>Helm
</span><span id="__span-68-21"><a id="__codelineno-68-21" name="__codelineno-68-21" href="#__codelineno-68-21"></a><span class="go">namespace/metallb-system labeled</span>
</span><span id="__span-68-22"><a id="__codelineno-68-22" name="__codelineno-68-22" href="#__codelineno-68-22"></a>
</span><span id="__span-68-23"><a id="__codelineno-68-23" name="__codelineno-68-23" href="#__codelineno-68-23"></a><span class="gp">$ </span>kubectl<span class="w"> </span>describe<span class="w"> </span>namespaces<span class="w"> </span>metallb-system
</span><span id="__span-68-24"><a id="__codelineno-68-24" name="__codelineno-68-24" href="#__codelineno-68-24"></a><span class="go">Name:         metallb-system</span>
</span><span id="__span-68-25"><a id="__codelineno-68-25" name="__codelineno-68-25" href="#__codelineno-68-25"></a><span class="go">Labels:       app.kubernetes.io/managed-by=Helm</span>
</span><span id="__span-68-26"><a id="__codelineno-68-26" name="__codelineno-68-26" href="#__codelineno-68-26"></a><span class="go">              kubernetes.io/metadata.name=metallb-system</span>
</span><span id="__span-68-27"><a id="__codelineno-68-27" name="__codelineno-68-27" href="#__codelineno-68-27"></a><span class="go">              pod-security.kubernetes.io/audit=privileged</span>
</span><span id="__span-68-28"><a id="__codelineno-68-28" name="__codelineno-68-28" href="#__codelineno-68-28"></a><span class="go">              pod-security.kubernetes.io/enforce=privileged</span>
</span><span id="__span-68-29"><a id="__codelineno-68-29" name="__codelineno-68-29" href="#__codelineno-68-29"></a><span class="go">              pod-security.kubernetes.io/warn=privileged</span>
</span><span id="__span-68-30"><a id="__codelineno-68-30" name="__codelineno-68-30" href="#__codelineno-68-30"></a><span class="go">Annotations:  meta.helm.sh/release-name: metallb</span>
</span><span id="__span-68-31"><a id="__codelineno-68-31" name="__codelineno-68-31" href="#__codelineno-68-31"></a><span class="go">              meta.helm.sh/release-namespace: metallb-system</span>
</span><span id="__span-68-32"><a id="__codelineno-68-32" name="__codelineno-68-32" href="#__codelineno-68-32"></a><span class="go">Status:       Active</span>
</span><span id="__span-68-33"><a id="__codelineno-68-33" name="__codelineno-68-33" href="#__codelineno-68-33"></a>
</span><span id="__span-68-34"><a id="__codelineno-68-34" name="__codelineno-68-34" href="#__codelineno-68-34"></a><span class="go">No resource quota.</span>
</span><span id="__span-68-35"><a id="__codelineno-68-35" name="__codelineno-68-35" href="#__codelineno-68-35"></a>
</span><span id="__span-68-36"><a id="__codelineno-68-36" name="__codelineno-68-36" href="#__codelineno-68-36"></a><span class="go">No LimitRange resource.</span>
</span></code></pre></div>
<p>Then, to avoid conflicts, delete the existing deployment/daemonset while <strong>keeping</strong> the
<strong>CRDs and Namespace</strong>. It is critical <em>not to delete</em> the namespace, as doing so would
trigger a cascading deletion of <code>IPAddressPools</code> and potentially <code>Services</code> using them.</p>
<p><strong>Do not run</strong> <code>kubectl delete -f</code> on the <code>metallb-native.yaml</code> manifest. Instead, use
the manifest to identify and delete only the functional components (Deployments,
DaemonSets, and RBAC) while leaving the Namespace and CRDs intact. To delete everything
<strong>except</strong> the namespace and the CRDs, use the <code>--selector</code> to target MetalLB's
internal components:</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-69-1"><a id="__codelineno-69-1" name="__codelineno-69-1" href="#__codelineno-69-1"></a><span class="gp">$ </span>kubectl<span class="w"> </span>delete<span class="w"> </span>-n<span class="w"> </span>metallb-system<span class="w"> </span>-l<span class="w"> </span><span class="nv">app</span><span class="o">=</span>metallb<span class="w"> </span><span class="se">\</span>
</span><span id="__span-69-2"><a id="__codelineno-69-2" name="__codelineno-69-2" href="#__codelineno-69-2"></a><span class="w">  </span>deployment,daemonset,service,serviceaccount,role,rolebinding<span class="w"> </span>
</span><span id="__span-69-3"><a id="__codelineno-69-3" name="__codelineno-69-3" href="#__codelineno-69-3"></a><span class="go">deployment.apps "controller" deleted from metallb-system namespace</span>
</span><span id="__span-69-4"><a id="__codelineno-69-4" name="__codelineno-69-4" href="#__codelineno-69-4"></a><span class="go">daemonset.apps "speaker" deleted from metallb-system namespace</span>
</span><span id="__span-69-5"><a id="__codelineno-69-5" name="__codelineno-69-5" href="#__codelineno-69-5"></a><span class="go">serviceaccount "controller" deleted from metallb-system namespace</span>
</span><span id="__span-69-6"><a id="__codelineno-69-6" name="__codelineno-69-6" href="#__codelineno-69-6"></a><span class="go">serviceaccount "speaker" deleted from metallb-system namespace</span>
</span><span id="__span-69-7"><a id="__codelineno-69-7" name="__codelineno-69-7" href="#__codelineno-69-7"></a><span class="go">role.rbac.authorization.k8s.io "controller" deleted from metallb-system namespace</span>
</span><span id="__span-69-8"><a id="__codelineno-69-8" name="__codelineno-69-8" href="#__codelineno-69-8"></a><span class="go">role.rbac.authorization.k8s.io "pod-lister" deleted from metallb-system namespace</span>
</span><span id="__span-69-9"><a id="__codelineno-69-9" name="__codelineno-69-9" href="#__codelineno-69-9"></a><span class="go">rolebinding.rbac.authorization.k8s.io "controller" deleted from metallb-system namespace</span>
</span><span id="__span-69-10"><a id="__codelineno-69-10" name="__codelineno-69-10" href="#__codelineno-69-10"></a><span class="go">rolebinding.rbac.authorization.k8s.io "pod-lister" deleted from metallb-system namespace</span>
</span><span id="__span-69-11"><a id="__codelineno-69-11" name="__codelineno-69-11" href="#__codelineno-69-11"></a>
</span><span id="__span-69-12"><a id="__codelineno-69-12" name="__codelineno-69-12" href="#__codelineno-69-12"></a><span class="gp">$ </span>kubectl<span class="w"> </span>delete<span class="w"> </span>-l<span class="w"> </span><span class="nv">app</span><span class="o">=</span>metallb<span class="w"> </span>clusterrole,clusterrolebinding
</span><span id="__span-69-13"><a id="__codelineno-69-13" name="__codelineno-69-13" href="#__codelineno-69-13"></a><span class="go">clusterrole.rbac.authorization.k8s.io "metallb-system:controller" deleted</span>
</span><span id="__span-69-14"><a id="__codelineno-69-14" name="__codelineno-69-14" href="#__codelineno-69-14"></a><span class="go">clusterrole.rbac.authorization.k8s.io "metallb-system:speaker" deleted</span>
</span><span id="__span-69-15"><a id="__codelineno-69-15" name="__codelineno-69-15" href="#__codelineno-69-15"></a><span class="go">clusterrolebinding.rbac.authorization.k8s.io "metallb-system:controller" deleted</span>
</span><span id="__span-69-16"><a id="__codelineno-69-16" name="__codelineno-69-16" href="#__codelineno-69-16"></a><span class="go">clusterrolebinding.rbac.authorization.k8s.io "metallb-system:speaker" deleted</span>
</span><span id="__span-69-17"><a id="__codelineno-69-17" name="__codelineno-69-17" href="#__codelineno-69-17"></a>
</span><span id="__span-69-18"><a id="__codelineno-69-18" name="__codelineno-69-18" href="#__codelineno-69-18"></a><span class="gp">$ </span>kubectl<span class="w"> </span>delete<span class="w"> </span>validatingwebhookconfiguration<span class="w"> </span>metallb-webhook-configuration
</span><span id="__span-69-19"><a id="__codelineno-69-19" name="__codelineno-69-19" href="#__codelineno-69-19"></a><span class="go">validatingwebhookconfiguration.admissionregistration.k8s.io "metallb-webhook-configuration" deleted</span>
</span></code></pre></div>
<p>The CRDs (<code>IPAddressPool</code> and <code>L2Advertisement</code>) in the 0.14.9 manifest don't have the
<code>app=metallb</code> label, so the commands above will not touch them and thus the IP Pool
configuration is safe.</p>
<p>However, the above deletions are not enough, attempting to install the Helm chart fails
with <code>INSTALLATION FAILED</code> errors due to many other pre-existing
<code>CustomResourceDefinition</code> objects such as <code>bfdprofiles.metallb.io</code>:</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-70-1"><a id="__codelineno-70-1" name="__codelineno-70-1" href="#__codelineno-70-1"></a><span class="gp">$ </span>helm<span class="w"> </span>install<span class="w"> </span>metallb<span class="w"> </span>metallb/metallb<span class="w"> </span><span class="se">\</span>
</span><span id="__span-70-2"><a id="__codelineno-70-2" name="__codelineno-70-2" href="#__codelineno-70-2"></a><span class="w">  </span>--namespace<span class="w"> </span>metallb-system<span class="w"> </span><span class="se">\</span>
</span><span id="__span-70-3"><a id="__codelineno-70-3" name="__codelineno-70-3" href="#__codelineno-70-3"></a><span class="w">  </span>--version<span class="w"> </span><span class="m">0</span>.15.3
</span><span id="__span-70-4"><a id="__codelineno-70-4" name="__codelineno-70-4" href="#__codelineno-70-4"></a><span class="go">Error: INSTALLATION FAILED: Unable to continue with install: CustomResourceDefinition</span>
</span><span id="__span-70-5"><a id="__codelineno-70-5" name="__codelineno-70-5" href="#__codelineno-70-5"></a><span class="go">"bfdprofiles.metallb.io" in namespace "" exists and cannot be imported into the</span>
</span><span id="__span-70-6"><a id="__codelineno-70-6" name="__codelineno-70-6" href="#__codelineno-70-6"></a><span class="go">current release: invalid ownership metadata; label validation error: missing key</span>
</span><span id="__span-70-7"><a id="__codelineno-70-7" name="__codelineno-70-7" href="#__codelineno-70-7"></a><span class="go">"app.kubernetes.io/managed-by": must be set to "Helm"; annotation validation error:</span>
</span><span id="__span-70-8"><a id="__codelineno-70-8" name="__codelineno-70-8" href="#__codelineno-70-8"></a><span class="go">missing key "meta.helm.sh/release-name": must be set to "metallb"; annotation</span>
</span><span id="__span-70-9"><a id="__codelineno-70-9" name="__codelineno-70-9" href="#__codelineno-70-9"></a><span class="go">validation error: missing key "meta.helm.sh/release-namespace": must be set to</span>
</span><span id="__span-70-10"><a id="__codelineno-70-10" name="__codelineno-70-10" href="#__codelineno-70-10"></a><span class="go">"metallb-system"</span>
</span></code></pre></div>
<p>So there are two options: <code>delete</code> or <code>annotate</code>; a few need to be deleted:</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-71-1"><a id="__codelineno-71-1" name="__codelineno-71-1" href="#__codelineno-71-1"></a><span class="gp">$ </span>kubectl<span class="w"> </span>delete<span class="w"> </span>secret<span class="w"> </span>metallb-webhook-cert<span class="w"> </span>-n<span class="w"> </span>metallb-system
</span><span id="__span-71-2"><a id="__codelineno-71-2" name="__codelineno-71-2" href="#__codelineno-71-2"></a><span class="go">secret "metallb-webhook-cert" deleted from metallb-system namespace</span>
</span><span id="__span-71-3"><a id="__codelineno-71-3" name="__codelineno-71-3" href="#__codelineno-71-3"></a>
</span><span id="__span-71-4"><a id="__codelineno-71-4" name="__codelineno-71-4" href="#__codelineno-71-4"></a><span class="gp">$ </span>kubectl<span class="w"> </span>delete<span class="w"> </span>configmap<span class="w"> </span>metallb-excludel2<span class="w"> </span>-n<span class="w"> </span>metallb-system
</span><span id="__span-71-5"><a id="__codelineno-71-5" name="__codelineno-71-5" href="#__codelineno-71-5"></a><span class="go">configmap "metallb-excludel2" deleted from metallb-system namespace</span>
</span><span id="__span-71-6"><a id="__codelineno-71-6" name="__codelineno-71-6" href="#__codelineno-71-6"></a>
</span><span id="__span-71-7"><a id="__codelineno-71-7" name="__codelineno-71-7" href="#__codelineno-71-7"></a><span class="gp">$ </span>kubectl<span class="w"> </span>delete<span class="w"> </span>service<span class="w"> </span>metallb-webhook-service<span class="w"> </span>-n<span class="w"> </span>metallb-system
</span><span id="__span-71-8"><a id="__codelineno-71-8" name="__codelineno-71-8" href="#__codelineno-71-8"></a><span class="go">service "metallb-webhook-service" deleted from metallb-system namespace</span>
</span></code></pre></div>
<p>The rest need to be annotated (to preserve them):</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-72-1"><a id="__codelineno-72-1" name="__codelineno-72-1" href="#__codelineno-72-1"></a><span class="gp">$ </span><span class="nv">CRDS</span><span class="o">=</span><span class="s2">"bfdprofiles.metallb.io bgpadvertisements.metallb.io bgppeers.metallb.io communities.metallb.io ipaddresspools.metallb.io l2advertisements.metallb.io"</span>
</span><span id="__span-72-2"><a id="__codelineno-72-2" name="__codelineno-72-2" href="#__codelineno-72-2"></a><span class="gp">$ </span><span class="k">for</span><span class="w"> </span>crd<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="nv">$CRDS</span><span class="p">;</span><span class="w"> </span><span class="k">do</span>
</span><span id="__span-72-3"><a id="__codelineno-72-3" name="__codelineno-72-3" href="#__codelineno-72-3"></a><span class="go">  kubectl annotate crd $crd meta.helm.sh/release-name=metallb --overwrite</span>
</span><span id="__span-72-4"><a id="__codelineno-72-4" name="__codelineno-72-4" href="#__codelineno-72-4"></a><span class="go">  kubectl annotate crd $crd meta.helm.sh/release-namespace=metallb-system --overwrite</span>
</span><span id="__span-72-5"><a id="__codelineno-72-5" name="__codelineno-72-5" href="#__codelineno-72-5"></a><span class="go">  kubectl label crd $crd app.kubernetes.io/managed-by=Helm --overwrite</span>
</span><span id="__span-72-6"><a id="__codelineno-72-6" name="__codelineno-72-6" href="#__codelineno-72-6"></a><span class="go">done</span>
</span><span id="__span-72-7"><a id="__codelineno-72-7" name="__codelineno-72-7" href="#__codelineno-72-7"></a><span class="go">customresourcedefinition.apiextensions.k8s.io/bfdprofiles.metallb.io annotated</span>
</span><span id="__span-72-8"><a id="__codelineno-72-8" name="__codelineno-72-8" href="#__codelineno-72-8"></a><span class="go">customresourcedefinition.apiextensions.k8s.io/bfdprofiles.metallb.io annotated</span>
</span><span id="__span-72-9"><a id="__codelineno-72-9" name="__codelineno-72-9" href="#__codelineno-72-9"></a><span class="go">customresourcedefinition.apiextensions.k8s.io/bfdprofiles.metallb.io labeled</span>
</span><span id="__span-72-10"><a id="__codelineno-72-10" name="__codelineno-72-10" href="#__codelineno-72-10"></a><span class="go">customresourcedefinition.apiextensions.k8s.io/bgpadvertisements.metallb.io annotated</span>
</span><span id="__span-72-11"><a id="__codelineno-72-11" name="__codelineno-72-11" href="#__codelineno-72-11"></a><span class="go">customresourcedefinition.apiextensions.k8s.io/bgpadvertisements.metallb.io annotated</span>
</span><span id="__span-72-12"><a id="__codelineno-72-12" name="__codelineno-72-12" href="#__codelineno-72-12"></a><span class="go">customresourcedefinition.apiextensions.k8s.io/bgpadvertisements.metallb.io labeled</span>
</span><span id="__span-72-13"><a id="__codelineno-72-13" name="__codelineno-72-13" href="#__codelineno-72-13"></a><span class="go">customresourcedefinition.apiextensions.k8s.io/bgppeers.metallb.io annotated</span>
</span><span id="__span-72-14"><a id="__codelineno-72-14" name="__codelineno-72-14" href="#__codelineno-72-14"></a><span class="go">customresourcedefinition.apiextensions.k8s.io/bgppeers.metallb.io annotated</span>
</span><span id="__span-72-15"><a id="__codelineno-72-15" name="__codelineno-72-15" href="#__codelineno-72-15"></a><span class="go">customresourcedefinition.apiextensions.k8s.io/bgppeers.metallb.io labeled</span>
</span><span id="__span-72-16"><a id="__codelineno-72-16" name="__codelineno-72-16" href="#__codelineno-72-16"></a><span class="go">customresourcedefinition.apiextensions.k8s.io/communities.metallb.io annotated</span>
</span><span id="__span-72-17"><a id="__codelineno-72-17" name="__codelineno-72-17" href="#__codelineno-72-17"></a><span class="go">customresourcedefinition.apiextensions.k8s.io/communities.metallb.io annotated</span>
</span><span id="__span-72-18"><a id="__codelineno-72-18" name="__codelineno-72-18" href="#__codelineno-72-18"></a><span class="go">customresourcedefinition.apiextensions.k8s.io/communities.metallb.io labeled</span>
</span><span id="__span-72-19"><a id="__codelineno-72-19" name="__codelineno-72-19" href="#__codelineno-72-19"></a><span class="go">customresourcedefinition.apiextensions.k8s.io/ipaddresspools.metallb.io annotated</span>
</span><span id="__span-72-20"><a id="__codelineno-72-20" name="__codelineno-72-20" href="#__codelineno-72-20"></a><span class="go">customresourcedefinition.apiextensions.k8s.io/ipaddresspools.metallb.io annotated</span>
</span><span id="__span-72-21"><a id="__codelineno-72-21" name="__codelineno-72-21" href="#__codelineno-72-21"></a><span class="go">customresourcedefinition.apiextensions.k8s.io/ipaddresspools.metallb.io labeled</span>
</span><span id="__span-72-22"><a id="__codelineno-72-22" name="__codelineno-72-22" href="#__codelineno-72-22"></a><span class="go">customresourcedefinition.apiextensions.k8s.io/l2advertisements.metallb.io annotated</span>
</span><span id="__span-72-23"><a id="__codelineno-72-23" name="__codelineno-72-23" href="#__codelineno-72-23"></a><span class="go">customresourcedefinition.apiextensions.k8s.io/l2advertisements.metallb.io annotated</span>
</span><span id="__span-72-24"><a id="__codelineno-72-24" name="__codelineno-72-24" href="#__codelineno-72-24"></a><span class="go">customresourcedefinition.apiextensions.k8s.io/l2advertisements.metallb.io labeled</span>
</span><span id="__span-72-25"><a id="__codelineno-72-25" name="__codelineno-72-25" href="#__codelineno-72-25"></a>
</span><span id="__span-72-26"><a id="__codelineno-72-26" name="__codelineno-72-26" href="#__codelineno-72-26"></a><span class="gp">$ </span>kubectl<span class="w"> </span>annotate<span class="w"> </span>crd<span class="w"> </span>servicel2statuses.metallb.io<span class="w"> </span>meta.helm.sh/release-name<span class="o">=</span>metallb<span class="w"> </span>--overwrite
</span><span id="__span-72-27"><a id="__codelineno-72-27" name="__codelineno-72-27" href="#__codelineno-72-27"></a><span class="go">customresourcedefinition.apiextensions.k8s.io/servicel2statuses.metallb.io annotated</span>
</span><span id="__span-72-28"><a id="__codelineno-72-28" name="__codelineno-72-28" href="#__codelineno-72-28"></a>
</span><span id="__span-72-29"><a id="__codelineno-72-29" name="__codelineno-72-29" href="#__codelineno-72-29"></a><span class="gp">$ </span>kubectl<span class="w"> </span>annotate<span class="w"> </span>crd<span class="w"> </span>servicel2statuses.metallb.io<span class="w"> </span>meta.helm.sh/release-namespace<span class="o">=</span>metallb-system<span class="w"> </span>--overwrite
</span><span id="__span-72-30"><a id="__codelineno-72-30" name="__codelineno-72-30" href="#__codelineno-72-30"></a><span class="go">customresourcedefinition.apiextensions.k8s.io/servicel2statuses.metallb.io annotated</span>
</span><span id="__span-72-31"><a id="__codelineno-72-31" name="__codelineno-72-31" href="#__codelineno-72-31"></a>
</span><span id="__span-72-32"><a id="__codelineno-72-32" name="__codelineno-72-32" href="#__codelineno-72-32"></a><span class="gp">$ </span>kubectl<span class="w"> </span>label<span class="w"> </span>crd<span class="w"> </span>servicel2statuses.metallb.io<span class="w"> </span>app.kubernetes.io/managed-by<span class="o">=</span>Helm<span class="w"> </span>--overwrite
</span><span id="__span-72-33"><a id="__codelineno-72-33" name="__codelineno-72-33" href="#__codelineno-72-33"></a><span class="go">customresourcedefinition.apiextensions.k8s.io/servicel2statuses.metallb.io labeled</span>
</span></code></pre></div>
<p>Once the old <code>controller</code> and <code>speaker</code> are gone, Helm can install 0.15.3 into
the existing namespace:</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-73-1"><a id="__codelineno-73-1" name="__codelineno-73-1" href="#__codelineno-73-1"></a><span class="gp">$ </span>helm<span class="w"> </span>install<span class="w"> </span>metallb<span class="w"> </span>metallb/metallb<span class="w"> </span><span class="se">\</span>
</span><span id="__span-73-2"><a id="__codelineno-73-2" name="__codelineno-73-2" href="#__codelineno-73-2"></a><span class="w">  </span>--namespace<span class="w"> </span>metallb-system<span class="w"> </span><span class="se">\</span>
</span><span id="__span-73-3"><a id="__codelineno-73-3" name="__codelineno-73-3" href="#__codelineno-73-3"></a><span class="w">  </span>--version<span class="w"> </span><span class="m">0</span>.15.3
</span><span id="__span-73-4"><a id="__codelineno-73-4" name="__codelineno-73-4" href="#__codelineno-73-4"></a><span class="go">NAME: metallb</span>
</span><span id="__span-73-5"><a id="__codelineno-73-5" name="__codelineno-73-5" href="#__codelineno-73-5"></a><span class="go">LAST DEPLOYED: Fri Jan 30 23:33:07 2026</span>
</span><span id="__span-73-6"><a id="__codelineno-73-6" name="__codelineno-73-6" href="#__codelineno-73-6"></a><span class="go">NAMESPACE: metallb-system</span>
</span><span id="__span-73-7"><a id="__codelineno-73-7" name="__codelineno-73-7" href="#__codelineno-73-7"></a><span class="go">STATUS: deployed</span>
</span><span id="__span-73-8"><a id="__codelineno-73-8" name="__codelineno-73-8" href="#__codelineno-73-8"></a><span class="go">REVISION: 1</span>
</span><span id="__span-73-9"><a id="__codelineno-73-9" name="__codelineno-73-9" href="#__codelineno-73-9"></a><span class="go">TEST SUITE: None</span>
</span><span id="__span-73-10"><a id="__codelineno-73-10" name="__codelineno-73-10" href="#__codelineno-73-10"></a><span class="go">NOTES:</span>
</span><span id="__span-73-11"><a id="__codelineno-73-11" name="__codelineno-73-11" href="#__codelineno-73-11"></a><span class="go">MetalLB is now running in the cluster.</span>
</span><span id="__span-73-12"><a id="__codelineno-73-12" name="__codelineno-73-12" href="#__codelineno-73-12"></a>
</span><span id="__span-73-13"><a id="__codelineno-73-13" name="__codelineno-73-13" href="#__codelineno-73-13"></a><span class="go">Now you can configure it via its CRs. Please refer to the metallb official docs</span>
</span><span id="__span-73-14"><a id="__codelineno-73-14" name="__codelineno-73-14" href="#__codelineno-73-14"></a><span class="go">on how to use the CRs.</span>
</span></code></pre></div>
<p>After the Helm install, the existing <code>IPAddressPool</code> is immediately active:</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-74-1"><a id="__codelineno-74-1" name="__codelineno-74-1" href="#__codelineno-74-1"></a><span class="gp">$ </span>kubectl<span class="w"> </span>-n<span class="w"> </span>metallb-system<span class="w"> </span>get<span class="w"> </span>ipaddresspools
</span><span id="__span-74-2"><a id="__codelineno-74-2" name="__codelineno-74-2" href="#__codelineno-74-2"></a><span class="go">NAME         AUTO ASSIGN   AVOID BUGGY IPS   ADDRESSES</span>
</span><span id="__span-74-3"><a id="__codelineno-74-3" name="__codelineno-74-3" href="#__codelineno-74-3"></a><span class="go">production   true          false             ["192.168.0.151-192.168.0.160"]</span>
</span><span id="__span-74-4"><a id="__codelineno-74-4" name="__codelineno-74-4" href="#__codelineno-74-4"></a>
</span><span id="__span-74-5"><a id="__codelineno-74-5" name="__codelineno-74-5" href="#__codelineno-74-5"></a><span class="gp">$ </span>kubectl<span class="w"> </span>-n<span class="w"> </span>metallb-system<span class="w"> </span>describe<span class="w"> </span>ipaddresspools
</span><span id="__span-74-6"><a id="__codelineno-74-6" name="__codelineno-74-6" href="#__codelineno-74-6"></a><span class="go">Name:         production</span>
</span><span id="__span-74-7"><a id="__codelineno-74-7" name="__codelineno-74-7" href="#__codelineno-74-7"></a><span class="go">Namespace:    metallb-system</span>
</span><span id="__span-74-8"><a id="__codelineno-74-8" name="__codelineno-74-8" href="#__codelineno-74-8"></a><span class="go">Labels:       &lt;none&gt;</span>
</span><span id="__span-74-9"><a id="__codelineno-74-9" name="__codelineno-74-9" href="#__codelineno-74-9"></a><span class="go">Annotations:  &lt;none&gt;</span>
</span><span id="__span-74-10"><a id="__codelineno-74-10" name="__codelineno-74-10" href="#__codelineno-74-10"></a><span class="go">API Version:  metallb.io/v1beta1</span>
</span><span id="__span-74-11"><a id="__codelineno-74-11" name="__codelineno-74-11" href="#__codelineno-74-11"></a><span class="go">Kind:         IPAddressPool</span>
</span><span id="__span-74-12"><a id="__codelineno-74-12" name="__codelineno-74-12" href="#__codelineno-74-12"></a><span class="go">Metadata:</span>
</span><span id="__span-74-13"><a id="__codelineno-74-13" name="__codelineno-74-13" href="#__codelineno-74-13"></a><span class="go">  Creation Timestamp:  2025-02-22T21:45:44Z</span>
</span><span id="__span-74-14"><a id="__codelineno-74-14" name="__codelineno-74-14" href="#__codelineno-74-14"></a><span class="go">  Generation:          1</span>
</span><span id="__span-74-15"><a id="__codelineno-74-15" name="__codelineno-74-15" href="#__codelineno-74-15"></a><span class="go">  Resource Version:    22690</span>
</span><span id="__span-74-16"><a id="__codelineno-74-16" name="__codelineno-74-16" href="#__codelineno-74-16"></a><span class="go">  UID:                 ca4ffb14-4063-4a63-8ab4-75995db0347c</span>
</span><span id="__span-74-17"><a id="__codelineno-74-17" name="__codelineno-74-17" href="#__codelineno-74-17"></a><span class="go">Spec:</span>
</span><span id="__span-74-18"><a id="__codelineno-74-18" name="__codelineno-74-18" href="#__codelineno-74-18"></a><span class="go">  Addresses:</span>
</span><span id="__span-74-19"><a id="__codelineno-74-19" name="__codelineno-74-19" href="#__codelineno-74-19"></a><span class="go">    192.168.0.151-192.168.0.160</span>
</span><span id="__span-74-20"><a id="__codelineno-74-20" name="__codelineno-74-20" href="#__codelineno-74-20"></a><span class="go">  Auto Assign:       true</span>
</span><span id="__span-74-21"><a id="__codelineno-74-21" name="__codelineno-74-21" href="#__codelineno-74-21"></a><span class="go">  Avoid Buggy I Ps:  false</span>
</span><span id="__span-74-22"><a id="__codelineno-74-22" name="__codelineno-74-22" href="#__codelineno-74-22"></a><span class="go">Events:              &lt;none&gt;</span>
</span></code></pre></div>
<p>Had this not worked, the Speaker pod logs should be inspected. When the pools are
active, the speaker should be announcing services like this:</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-75-1"><a id="__codelineno-75-1" name="__codelineno-75-1" href="#__codelineno-75-1"></a><span class="gp">$ </span>kubectl<span class="w"> </span>logs<span class="w"> </span>-n<span class="w"> </span>metallb-system<span class="w"> </span>metallb-speaker-54w68<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>-i<span class="w"> </span>pool
</span><span id="__span-75-2"><a id="__codelineno-75-2" name="__codelineno-75-2" href="#__codelineno-75-2"></a><span class="go">...</span>
</span><span id="__span-75-3"><a id="__codelineno-75-3" name="__codelineno-75-3" href="#__codelineno-75-3"></a><span class="go">{"level":"info","ts":"2026-01-30T23:27:20Z","msg":"Starting EventSource","controller":"bgppeer","controllerGroup":"metallb.io","controllerKind":"BGPPeer","source":"kind source: *v1beta1.IPAddressPool","stacktrace":"sigs.k8s.io/controller-runtime/pkg/internal/controller.(*Controller[...]).startEventSourcesAndQueueLocked.func1.2.1\n\t/go/pkg/mod/sigs.k8s.io/controller-runtime@v0.22.3/pkg/internal/controller/controller.go:353"}</span>
</span><span id="__span-75-4"><a id="__codelineno-75-4" name="__codelineno-75-4" href="#__codelineno-75-4"></a><span class="go">{"caller":"main.go:444","event":"serviceAnnounced","ips":["192.168.0.154"],"level":"info","msg":"service has IP, announcing","pool":"production","protocol":"layer2","ts":"2026-01-30T23:27:20Z"}</span>
</span><span id="__span-75-5"><a id="__codelineno-75-5" name="__codelineno-75-5" href="#__codelineno-75-5"></a><span class="go">{"caller":"main.go:444","event":"serviceAnnounced","ips":["192.168.0.154"],"level":"info","msg":"service has IP, announcing","pool":"production","protocol":"layer2","ts":"2026-01-30T23:27:20Z"}</span>
</span></code></pre></div>
<p>In the event of the logs showing errors about <code>"no pools found"</code>, re-apply the
specific <code>IPAddressPool</code> manifest:</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-76-1"><a id="__codelineno-76-1" name="__codelineno-76-1" href="#__codelineno-76-1"></a><span class="gp">$ </span>kubectl<span class="w"> </span>apply<span class="w"> </span>-f<span class="w"> </span>metallb/ipaddress-pool-alfred.yaml
</span></code></pre></div>
<h3 id="kubernetes-dashboard">Kubernetes Dashboard</h3>
<p>As of v1.29,
<a href="https://kubernetes.io/docs/tasks/access-application-cluster/web-ui-dashboard/">Kubernetes Dashboard</a>
supports only Helm-based 
<a href="https://github.com/kubernetes/dashboard?tab=readme-ov-file#installation">installation</a>,
which at this point means we have to
<a href="https://helm.sh/docs/intro/install/#from-apt-debianubuntu">Install helm from APT</a>:</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-77-1"><a id="__codelineno-77-1" name="__codelineno-77-1" href="#__codelineno-77-1"></a><span class="gp">$ </span>curl<span class="w"> </span>https://baltocdn.com/helm/signing.asc<span class="w"> </span><span class="se">\</span>
</span><span id="__span-77-2"><a id="__codelineno-77-2" name="__codelineno-77-2" href="#__codelineno-77-2"></a><span class="w">  </span><span class="p">|</span><span class="w"> </span>sudo<span class="w"> </span>gpg<span class="w"> </span>--dearmor<span class="w"> </span>-o<span class="w"> </span>/etc/apt/keyrings/helm.gpg
</span><span id="__span-77-3"><a id="__codelineno-77-3" name="__codelineno-77-3" href="#__codelineno-77-3"></a><span class="gp">$ </span><span class="nb">echo</span><span class="w"> </span><span class="s2">"deb [arch=</span><span class="k">$(</span>dpkg<span class="w"> </span>--print-architecture<span class="k">)</span><span class="s2"> signed-by=/etc/apt/keyrings/helm.gpg] https://baltocdn.com/helm/stable/debian/ all main"</span><span class="w"> </span><span class="se">\</span>
</span><span id="__span-77-4"><a id="__codelineno-77-4" name="__codelineno-77-4" href="#__codelineno-77-4"></a><span class="w">  </span><span class="p">|</span><span class="w"> </span>sudo<span class="w"> </span>tee<span class="w"> </span>/etc/apt/sources.list.d/helm-stable-debian.list
</span><span id="__span-77-5"><a id="__codelineno-77-5" name="__codelineno-77-5" href="#__codelineno-77-5"></a><span class="gp">$ </span>sudo<span class="w"> </span>apt-get<span class="w"> </span>update
</span><span id="__span-77-6"><a id="__codelineno-77-6" name="__codelineno-77-6" href="#__codelineno-77-6"></a><span class="gp">$ </span>sudo<span class="w"> </span>apt-get<span class="w"> </span>install<span class="w"> </span>-y<span class="w"> </span>helm
</span></code></pre></div>
<p>Then install the Helm repository for the Kubernetes dashboard:</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-78-1"><a id="__codelineno-78-1" name="__codelineno-78-1" href="#__codelineno-78-1"></a><span class="gp">$ </span>helm<span class="w"> </span>repo<span class="w"> </span>add<span class="w"> </span><span class="se">\</span>
</span><span id="__span-78-2"><a id="__codelineno-78-2" name="__codelineno-78-2" href="#__codelineno-78-2"></a><span class="w">  </span>kubernetes-dashboard<span class="w"> </span><span class="se">\</span>
</span><span id="__span-78-3"><a id="__codelineno-78-3" name="__codelineno-78-3" href="#__codelineno-78-3"></a><span class="w">  </span>https://kubernetes.github.io/dashboard/
</span><span id="__span-78-4"><a id="__codelineno-78-4" name="__codelineno-78-4" href="#__codelineno-78-4"></a><span class="go">"kubernetes-dashboard" has been added to your repositories</span>
</span></code></pre></div>
<p>And install the Kubernetes dashboard (without any customization):</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-79-1"><a id="__codelineno-79-1" name="__codelineno-79-1" href="#__codelineno-79-1"></a><span class="gp">$ </span>helm<span class="w"> </span>upgrade<span class="w"> </span><span class="se">\</span>
</span><span id="__span-79-2"><a id="__codelineno-79-2" name="__codelineno-79-2" href="#__codelineno-79-2"></a><span class="w">  </span>--install<span class="w"> </span>kubernetes-dashboard<span class="w"> </span><span class="se">\</span>
</span><span id="__span-79-3"><a id="__codelineno-79-3" name="__codelineno-79-3" href="#__codelineno-79-3"></a><span class="w">    </span>kubernetes-dashboard/kubernetes-dashboard<span class="w"> </span><span class="se">\</span>
</span><span id="__span-79-4"><a id="__codelineno-79-4" name="__codelineno-79-4" href="#__codelineno-79-4"></a><span class="w">  </span>--create-namespace<span class="w"> </span><span class="se">\</span>
</span><span id="__span-79-5"><a id="__codelineno-79-5" name="__codelineno-79-5" href="#__codelineno-79-5"></a><span class="w">  </span>--namespace<span class="w"> </span>kubernetes-dashboard
</span><span id="__span-79-6"><a id="__codelineno-79-6" name="__codelineno-79-6" href="#__codelineno-79-6"></a>
</span><span id="__span-79-7"><a id="__codelineno-79-7" name="__codelineno-79-7" href="#__codelineno-79-7"></a><span class="go">Release "kubernetes-dashboard" does not exist. Installing it now.</span>
</span><span id="__span-79-8"><a id="__codelineno-79-8" name="__codelineno-79-8" href="#__codelineno-79-8"></a><span class="go">NAME: kubernetes-dashboard</span>
</span><span id="__span-79-9"><a id="__codelineno-79-9" name="__codelineno-79-9" href="#__codelineno-79-9"></a><span class="go">LAST DEPLOYED: Sun Feb 23 17:08:33 2025</span>
</span><span id="__span-79-10"><a id="__codelineno-79-10" name="__codelineno-79-10" href="#__codelineno-79-10"></a><span class="go">NAMESPACE: kubernetes-dashboard</span>
</span><span id="__span-79-11"><a id="__codelineno-79-11" name="__codelineno-79-11" href="#__codelineno-79-11"></a><span class="go">STATUS: deployed</span>
</span><span id="__span-79-12"><a id="__codelineno-79-12" name="__codelineno-79-12" href="#__codelineno-79-12"></a><span class="go">REVISION: 1</span>
</span><span id="__span-79-13"><a id="__codelineno-79-13" name="__codelineno-79-13" href="#__codelineno-79-13"></a><span class="go">TEST SUITE: None</span>
</span><span id="__span-79-14"><a id="__codelineno-79-14" name="__codelineno-79-14" href="#__codelineno-79-14"></a><span class="go">NOTES:</span>
</span><span id="__span-79-15"><a id="__codelineno-79-15" name="__codelineno-79-15" href="#__codelineno-79-15"></a><span class="go">*************************************************************************************************</span>
</span><span id="__span-79-16"><a id="__codelineno-79-16" name="__codelineno-79-16" href="#__codelineno-79-16"></a><span class="go">*** PLEASE BE PATIENT: Kubernetes Dashboard may need a few minutes to get up and become ready ***</span>
</span><span id="__span-79-17"><a id="__codelineno-79-17" name="__codelineno-79-17" href="#__codelineno-79-17"></a><span class="go">*************************************************************************************************</span>
</span><span id="__span-79-18"><a id="__codelineno-79-18" name="__codelineno-79-18" href="#__codelineno-79-18"></a>
</span><span id="__span-79-19"><a id="__codelineno-79-19" name="__codelineno-79-19" href="#__codelineno-79-19"></a><span class="go">Congratulations! You have just installed Kubernetes Dashboard in your cluster.</span>
</span><span id="__span-79-20"><a id="__codelineno-79-20" name="__codelineno-79-20" href="#__codelineno-79-20"></a>
</span><span id="__span-79-21"><a id="__codelineno-79-21" name="__codelineno-79-21" href="#__codelineno-79-21"></a><span class="go">To access Dashboard run:</span>
</span><span id="__span-79-22"><a id="__codelineno-79-22" name="__codelineno-79-22" href="#__codelineno-79-22"></a><span class="go">  kubectl -n kubernetes-dashboard port-forward svc/kubernetes-dashboard-kong-proxy 8443:443</span>
</span><span id="__span-79-23"><a id="__codelineno-79-23" name="__codelineno-79-23" href="#__codelineno-79-23"></a>
</span><span id="__span-79-24"><a id="__codelineno-79-24" name="__codelineno-79-24" href="#__codelineno-79-24"></a><span class="go">NOTE: In case port-forward command does not work, make sure that kong service name is correct.</span>
</span><span id="__span-79-25"><a id="__codelineno-79-25" name="__codelineno-79-25" href="#__codelineno-79-25"></a><span class="go">      Check the services in Kubernetes Dashboard namespace using:</span>
</span><span id="__span-79-26"><a id="__codelineno-79-26" name="__codelineno-79-26" href="#__codelineno-79-26"></a><span class="go">        kubectl -n kubernetes-dashboard get svc</span>
</span><span id="__span-79-27"><a id="__codelineno-79-27" name="__codelineno-79-27" href="#__codelineno-79-27"></a>
</span><span id="__span-79-28"><a id="__codelineno-79-28" name="__codelineno-79-28" href="#__codelineno-79-28"></a><span class="go">Dashboard will be available at:</span>
</span><span id="__span-79-29"><a id="__codelineno-79-29" name="__codelineno-79-29" href="#__codelineno-79-29"></a><span class="go">  https://localhost:8443</span>
</span><span id="__span-79-30"><a id="__codelineno-79-30" name="__codelineno-79-30" href="#__codelineno-79-30"></a>
</span><span id="__span-79-31"><a id="__codelineno-79-31" name="__codelineno-79-31" href="#__codelineno-79-31"></a><span class="gp">$ </span>kubectl<span class="w"> </span>get<span class="w"> </span>all<span class="w"> </span>-n<span class="w"> </span>kubernetes-dashboard<span class="w"> </span>
</span><span id="__span-79-32"><a id="__codelineno-79-32" name="__codelineno-79-32" href="#__codelineno-79-32"></a><span class="go">NAME                                                        READY   STATUS    RESTARTS   AGE</span>
</span><span id="__span-79-33"><a id="__codelineno-79-33" name="__codelineno-79-33" href="#__codelineno-79-33"></a><span class="go">pod/kubernetes-dashboard-api-5b7599777f-ltvmn               1/1     Running   0          17m</span>
</span><span id="__span-79-34"><a id="__codelineno-79-34" name="__codelineno-79-34" href="#__codelineno-79-34"></a><span class="go">pod/kubernetes-dashboard-auth-9c9bf4947-gzvbw               1/1     Running   0          17m</span>
</span><span id="__span-79-35"><a id="__codelineno-79-35" name="__codelineno-79-35" href="#__codelineno-79-35"></a><span class="go">pod/kubernetes-dashboard-kong-79867c9c48-9mx5z              1/1     Running   0          17m</span>
</span><span id="__span-79-36"><a id="__codelineno-79-36" name="__codelineno-79-36" href="#__codelineno-79-36"></a><span class="go">pod/kubernetes-dashboard-metrics-scraper-55cc88cbcb-k7t4k   1/1     Running   0          17m</span>
</span><span id="__span-79-37"><a id="__codelineno-79-37" name="__codelineno-79-37" href="#__codelineno-79-37"></a><span class="go">pod/kubernetes-dashboard-web-8f95766b5-z7cj7                1/1     Running   0          17m</span>
</span><span id="__span-79-38"><a id="__codelineno-79-38" name="__codelineno-79-38" href="#__codelineno-79-38"></a>
</span><span id="__span-79-39"><a id="__codelineno-79-39" name="__codelineno-79-39" href="#__codelineno-79-39"></a><span class="go">NAME                                           TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)    AGE</span>
</span><span id="__span-79-40"><a id="__codelineno-79-40" name="__codelineno-79-40" href="#__codelineno-79-40"></a><span class="go">service/kubernetes-dashboard-api               ClusterIP   10.111.251.2     &lt;none&gt;        8000/TCP   17m</span>
</span><span id="__span-79-41"><a id="__codelineno-79-41" name="__codelineno-79-41" href="#__codelineno-79-41"></a><span class="go">service/kubernetes-dashboard-auth              ClusterIP   10.96.196.222    &lt;none&gt;        8000/TCP   17m</span>
</span><span id="__span-79-42"><a id="__codelineno-79-42" name="__codelineno-79-42" href="#__codelineno-79-42"></a><span class="go">service/kubernetes-dashboard-kong-proxy        ClusterIP   10.100.147.211   &lt;none&gt;        443/TCP    17m</span>
</span><span id="__span-79-43"><a id="__codelineno-79-43" name="__codelineno-79-43" href="#__codelineno-79-43"></a><span class="go">service/kubernetes-dashboard-metrics-scraper   ClusterIP   10.106.137.217   &lt;none&gt;        8000/TCP   17m</span>
</span><span id="__span-79-44"><a id="__codelineno-79-44" name="__codelineno-79-44" href="#__codelineno-79-44"></a><span class="go">service/kubernetes-dashboard-web               ClusterIP   10.106.239.53    &lt;none&gt;        8000/TCP   17m</span>
</span><span id="__span-79-45"><a id="__codelineno-79-45" name="__codelineno-79-45" href="#__codelineno-79-45"></a>
</span><span id="__span-79-46"><a id="__codelineno-79-46" name="__codelineno-79-46" href="#__codelineno-79-46"></a><span class="go">NAME                                                   READY   UP-TO-DATE   AVAILABLE   AGE</span>
</span><span id="__span-79-47"><a id="__codelineno-79-47" name="__codelineno-79-47" href="#__codelineno-79-47"></a><span class="go">deployment.apps/kubernetes-dashboard-api               1/1     1            1           17m</span>
</span><span id="__span-79-48"><a id="__codelineno-79-48" name="__codelineno-79-48" href="#__codelineno-79-48"></a><span class="go">deployment.apps/kubernetes-dashboard-auth              1/1     1            1           17m</span>
</span><span id="__span-79-49"><a id="__codelineno-79-49" name="__codelineno-79-49" href="#__codelineno-79-49"></a><span class="go">deployment.apps/kubernetes-dashboard-kong              1/1     1            1           17m</span>
</span><span id="__span-79-50"><a id="__codelineno-79-50" name="__codelineno-79-50" href="#__codelineno-79-50"></a><span class="go">deployment.apps/kubernetes-dashboard-metrics-scraper   1/1     1            1           17m</span>
</span><span id="__span-79-51"><a id="__codelineno-79-51" name="__codelineno-79-51" href="#__codelineno-79-51"></a><span class="go">deployment.apps/kubernetes-dashboard-web               1/1     1            1           17m</span>
</span><span id="__span-79-52"><a id="__codelineno-79-52" name="__codelineno-79-52" href="#__codelineno-79-52"></a>
</span><span id="__span-79-53"><a id="__codelineno-79-53" name="__codelineno-79-53" href="#__codelineno-79-53"></a><span class="go">NAME                                                              DESIRED   CURRENT   READY   AGE</span>
</span><span id="__span-79-54"><a id="__codelineno-79-54" name="__codelineno-79-54" href="#__codelineno-79-54"></a><span class="go">replicaset.apps/kubernetes-dashboard-api-5b7599777f               1         1         1       17m</span>
</span><span id="__span-79-55"><a id="__codelineno-79-55" name="__codelineno-79-55" href="#__codelineno-79-55"></a><span class="go">replicaset.apps/kubernetes-dashboard-auth-9c9bf4947               1         1         1       17m</span>
</span><span id="__span-79-56"><a id="__codelineno-79-56" name="__codelineno-79-56" href="#__codelineno-79-56"></a><span class="go">replicaset.apps/kubernetes-dashboard-kong-79867c9c48              1         1         1       17m</span>
</span><span id="__span-79-57"><a id="__codelineno-79-57" name="__codelineno-79-57" href="#__codelineno-79-57"></a><span class="go">replicaset.apps/kubernetes-dashboard-metrics-scraper-55cc88cbcb   1         1         1       17m</span>
</span><span id="__span-79-58"><a id="__codelineno-79-58" name="__codelineno-79-58" href="#__codelineno-79-58"></a><span class="go">replicaset.apps/kubernetes-dashboard-web-8f95766b5                1         1         1       17m</span>
</span></code></pre></div>
<p>The dashboard is now behind the <code>kubernetes-dashboard-kong-proxy</code> service,
and the suggested port forward can be used to map port 8443 to it:</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-80-1"><a id="__codelineno-80-1" name="__codelineno-80-1" href="#__codelineno-80-1"></a><span class="gp">$ </span>kubectl<span class="w"> </span>-n<span class="w"> </span>kubernetes-dashboard<span class="w"> </span>port-forward<span class="w"> </span><span class="se">\</span>
</span><span id="__span-80-2"><a id="__codelineno-80-2" name="__codelineno-80-2" href="#__codelineno-80-2"></a><span class="w">  </span>svc/kubernetes-dashboard-kong-proxy<span class="w"> </span><span class="m">8443</span>:443<span class="w"> </span><span class="se">\</span>
</span><span id="__span-80-3"><a id="__codelineno-80-3" name="__codelineno-80-3" href="#__codelineno-80-3"></a><span class="w">  </span>--address<span class="w"> </span><span class="m">0</span>.0.0.0
</span><span id="__span-80-4"><a id="__codelineno-80-4" name="__codelineno-80-4" href="#__codelineno-80-4"></a><span class="go">Forwarding from 0.0.0.0:8443 -&gt; 8443</span>
</span><span id="__span-80-5"><a id="__codelineno-80-5" name="__codelineno-80-5" href="#__codelineno-80-5"></a><span class="go">^C</span>
</span></code></pre></div>
<p>The dasboard is then available at <a href="https://alfred:8443/">https://alfred:8443/</a>:</p>
<p><a class="glightbox" data-type="image" data-width="auto" data-height="auto" href="../../../../media/2025-02-22-home-assistant-on-kubernetes-on-raspberry-pi-5-alfred/kubernetes-dashboard-login.png" data-desc-position="bottom"><img alt="Kubernetes Dashboard login" src="../../../../media/2025-02-22-home-assistant-on-kubernetes-on-raspberry-pi-5-alfred/kubernetes-dashboard-login.png" style="height:342px;width:964px"></a></p>
<p><a href="https://kubernetes.io/docs/tasks/access-application-cluster/web-ui-dashboard/">Accessing the Dashboard UI</a>
requires
<a href="https://github.com/kubernetes/dashboard/blob/master/docs/user/access-control/creating-sample-user.md">creating a sample user</a>;
the setup in the tutorial creates an example admin user with all privileges,
good enough for now:</p>
<div class="language-yaml highlight"><span class="filename">dashboard/admin-sa-rbac.yaml</span><pre><span></span><code><span id="__span-81-1"><a id="__codelineno-81-1" name="__codelineno-81-1" href="#__codelineno-81-1"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
</span><span id="__span-81-2"><a id="__codelineno-81-2" name="__codelineno-81-2" href="#__codelineno-81-2"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ServiceAccount</span>
</span><span id="__span-81-3"><a id="__codelineno-81-3" name="__codelineno-81-3" href="#__codelineno-81-3"></a><span class="nt">metadata</span><span class="p">:</span>
</span><span id="__span-81-4"><a id="__codelineno-81-4" name="__codelineno-81-4" href="#__codelineno-81-4"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">admin-user</span>
</span><span id="__span-81-5"><a id="__codelineno-81-5" name="__codelineno-81-5" href="#__codelineno-81-5"></a><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">kubernetes-dashboard</span>
</span><span id="__span-81-6"><a id="__codelineno-81-6" name="__codelineno-81-6" href="#__codelineno-81-6"></a><span class="nn">---</span>
</span><span id="__span-81-7"><a id="__codelineno-81-7" name="__codelineno-81-7" href="#__codelineno-81-7"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">rbac.authorization.k8s.io/v1</span>
</span><span id="__span-81-8"><a id="__codelineno-81-8" name="__codelineno-81-8" href="#__codelineno-81-8"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ClusterRoleBinding</span>
</span><span id="__span-81-9"><a id="__codelineno-81-9" name="__codelineno-81-9" href="#__codelineno-81-9"></a><span class="nt">metadata</span><span class="p">:</span>
</span><span id="__span-81-10"><a id="__codelineno-81-10" name="__codelineno-81-10" href="#__codelineno-81-10"></a><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">kubernetes-dashboard</span>
</span><span id="__span-81-11"><a id="__codelineno-81-11" name="__codelineno-81-11" href="#__codelineno-81-11"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">admin-user</span>
</span><span id="__span-81-12"><a id="__codelineno-81-12" name="__codelineno-81-12" href="#__codelineno-81-12"></a><span class="nt">roleRef</span><span class="p">:</span>
</span><span id="__span-81-13"><a id="__codelineno-81-13" name="__codelineno-81-13" href="#__codelineno-81-13"></a><span class="w">  </span><span class="nt">apiGroup</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">rbac.authorization.k8s.io</span>
</span><span id="__span-81-14"><a id="__codelineno-81-14" name="__codelineno-81-14" href="#__codelineno-81-14"></a><span class="w">  </span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ClusterRole</span>
</span><span id="__span-81-15"><a id="__codelineno-81-15" name="__codelineno-81-15" href="#__codelineno-81-15"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cluster-admin</span>
</span><span id="__span-81-16"><a id="__codelineno-81-16" name="__codelineno-81-16" href="#__codelineno-81-16"></a><span class="nt">subjects</span><span class="p">:</span>
</span><span id="__span-81-17"><a id="__codelineno-81-17" name="__codelineno-81-17" href="#__codelineno-81-17"></a><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ServiceAccount</span>
</span><span id="__span-81-18"><a id="__codelineno-81-18" name="__codelineno-81-18" href="#__codelineno-81-18"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">admin-user</span>
</span><span id="__span-81-19"><a id="__codelineno-81-19" name="__codelineno-81-19" href="#__codelineno-81-19"></a><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">kubernetes-dashboard</span>
</span><span id="__span-81-20"><a id="__codelineno-81-20" name="__codelineno-81-20" href="#__codelineno-81-20"></a><span class="nn">---</span>
</span><span id="__span-81-21"><a id="__codelineno-81-21" name="__codelineno-81-21" href="#__codelineno-81-21"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
</span><span id="__span-81-22"><a id="__codelineno-81-22" name="__codelineno-81-22" href="#__codelineno-81-22"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Secret</span>
</span><span id="__span-81-23"><a id="__codelineno-81-23" name="__codelineno-81-23" href="#__codelineno-81-23"></a><span class="nt">metadata</span><span class="p">:</span>
</span><span id="__span-81-24"><a id="__codelineno-81-24" name="__codelineno-81-24" href="#__codelineno-81-24"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">admin-user</span>
</span><span id="__span-81-25"><a id="__codelineno-81-25" name="__codelineno-81-25" href="#__codelineno-81-25"></a><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">kubernetes-dashboard</span>
</span><span id="__span-81-26"><a id="__codelineno-81-26" name="__codelineno-81-26" href="#__codelineno-81-26"></a><span class="w">  </span><span class="nt">annotations</span><span class="p">:</span>
</span><span id="__span-81-27"><a id="__codelineno-81-27" name="__codelineno-81-27" href="#__codelineno-81-27"></a><span class="w">    </span><span class="nt">kubernetes.io/service-account.name</span><span class="p">:</span><span class="w"> </span><span class="s">"admin-user"</span><span class="w">   </span>
</span><span id="__span-81-28"><a id="__codelineno-81-28" name="__codelineno-81-28" href="#__codelineno-81-28"></a><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">kubernetes.io/service-account-token</span>
</span></code></pre></div>
<div class="language-console highlight"><pre><span></span><code><span id="__span-82-1"><a id="__codelineno-82-1" name="__codelineno-82-1" href="#__codelineno-82-1"></a><span class="gp">$ </span>kubectl<span class="w"> </span>apply<span class="w"> </span>-f<span class="w"> </span>dashboard/admin-sa-rbac.yaml
</span><span id="__span-82-2"><a id="__codelineno-82-2" name="__codelineno-82-2" href="#__codelineno-82-2"></a><span class="go">serviceaccount/admin-user created</span>
</span><span id="__span-82-3"><a id="__codelineno-82-3" name="__codelineno-82-3" href="#__codelineno-82-3"></a><span class="go">clusterrolebinding.rbac.authorization.k8s.io/admin-user created</span>
</span><span id="__span-82-4"><a id="__codelineno-82-4" name="__codelineno-82-4" href="#__codelineno-82-4"></a><span class="go">secret/admin-user created</span>
</span><span id="__span-82-5"><a id="__codelineno-82-5" name="__codelineno-82-5" href="#__codelineno-82-5"></a>
</span><span id="__span-82-6"><a id="__codelineno-82-6" name="__codelineno-82-6" href="#__codelineno-82-6"></a><span class="gp">$ </span>kubectl<span class="w"> </span>-n<span class="w"> </span>kubernetes-dashboard<span class="w"> </span>create<span class="w"> </span>token<span class="w"> </span>admin-user
</span><span id="__span-82-7"><a id="__codelineno-82-7" name="__codelineno-82-7" href="#__codelineno-82-7"></a><span class="go">eyJhbGciOiJSUzI1NiIsImtpZCI6IkFEVlNfMlN2SVJUbEpvMGNVeGRjako1LTlXakxFdXRzQy1kZjJIdHpCVUEifQ.eyJhdWQiOlsiaHR0cHM6Ly9rdWJlcm5ldGVzLmRlZmF1bHQuc3ZjLmNsdXN0ZXIubG9jYWwiXSwiZXhwIjoxNzQwMzM5OTgwLCJpYXQiOjE3NDAzMzYzODAsImlzcyI6Imh0dHBzOi8va3ViZXJuZXRlcy5kZWZhdWx0LnN2Yy5jbHVzdGVyLmxvY2FsIiwianRpIjoiMGMyODJkZjMtNjcwOC00N2NjLTk1NzItMTFmYzRkOGU3ZDEzIiwia3ViZXJuZXRlcy5pbyI6eyJuYW1lc3BhY2UiOiJrdWJlcm5ldGVzLWRhc2hib2FyZCIsInNlcnZpY2VhY2NvdW50Ijp7Im5hbWUiOiJhZG1pbi11c2VyIiwidWlkIjoiNjJiMmY5NzMtMWQ2MC00NzQ2LTk2ZTYtNmZiNDJhMGE1NmUzIn19LCJuYmYiOjE3NDAzMzYzODAsInN1YiI6InN5c3RlbTpzZXJ2aWNlYWNjb3VudDprdWJlcm5ldGVzLWRhc2hib2FyZDphZG1pbi11c2VyIn0.AgvTqQ3-cEuAQyKgaV0NYApq4cMjEd8rf4taOjwBDwtwBAeqIcGrv5nHv4RMTOK3CyxjBHevBOsOzZ_ycskngQ6aiq5lgrhGNzO8bKKMhFbZqvcO6soQfccNQFqCVcP01oBa6Ue7vx1YctWe1L5YJB201oQt8Fhvee72Xy5cyZ9BONKTp7lJTL48EXgGj6mSgwaHPKF6xfmYWgG8V3WXabN_MExVEEVrQMI0rJeS08iJ6S0yQAGi2VU4qpJ4m-1dwkoUtbqYmtNJnj8itP5tmuIdIYRJusg8ptoGHSBtV538U_QXEO4dLDTGgcWT1Y3wIwDvVaP969yJtXh5KaAdVg</span>
</span></code></pre></div>
<h4 id="troubleshooting-dashboard">Troubleshooting Dashboard</h4>
<p>Without the <code>--address 0.0.0.0</code> flag it will only accept connections from
<code>localhost</code> and no other clients. This flag is necessary because this forward
<a href="https://github.com/kubernetes/dashboard/issues/4624#issuecomment-560504320">is the way to access the proxy over HTTPS</a>
<em>and</em> this is necessary for the access token to work:</p>
<ul>
<li><a href="https://github.com/kubernetes/dashboard/issues/8794">Bug #8794: Bearer Token Authentication not responding</a></li>
<li><a href="https://github.com/kubernetes/dashboard/issues/8795">Bug #8795: Bearer token not working</a></li>
</ul>
<p>This issue makes impossible to access the dashboard bypassing the proxy, which
<em>could have been</em> another way to access the dashboard from remote clients, using
<a href="https://github.com/kubernetes/dashboard/blob/master/docs/user/accessing-dashboard/README.md#kubectl-proxy"><code>kubectl proxy</code></a>
with the following flags:</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-83-1"><a id="__codelineno-83-1" name="__codelineno-83-1" href="#__codelineno-83-1"></a><span class="gp">$ </span>kubectl<span class="w"> </span>proxy<span class="w"> </span><span class="se">\</span>
</span><span id="__span-83-2"><a id="__codelineno-83-2" name="__codelineno-83-2" href="#__codelineno-83-2"></a><span class="w">  </span>--address<span class="o">=</span><span class="s1">'0.0.0.0'</span><span class="w"> </span><span class="se">\</span>
</span><span id="__span-83-3"><a id="__codelineno-83-3" name="__codelineno-83-3" href="#__codelineno-83-3"></a><span class="w">  </span>--disable-filter<span class="o">=</span><span class="nb">true</span><span class="w"> </span><span class="se">\</span>
</span><span id="__span-83-4"><a id="__codelineno-83-4" name="__codelineno-83-4" href="#__codelineno-83-4"></a><span class="w">  </span>--port<span class="o">=</span><span class="m">8001</span>
</span><span id="__span-83-5"><a id="__codelineno-83-5" name="__codelineno-83-5" href="#__codelineno-83-5"></a><span class="go">W0223 19:09:06.922315  850945 proxy.go:177] Request filter disabled, your proxy is vulnerable to XSRF attacks, please be cautious</span>
</span><span id="__span-83-6"><a id="__codelineno-83-6" name="__codelineno-83-6" href="#__codelineno-83-6"></a><span class="go">Starting to serve on [::]:8001</span>
</span></code></pre></div>
<p>The dashboard is thus available on a really long URL, via its API:
<a href="http://alfred:8001/api/v1/namespaces/kubernetes-dashboard/services/https:kubernetes-dashboard-kong-proxy:443/proxy/#/login">http://alfred:8001/api/v1/namespaces/kubernetes-dashboard/services/https:kubernetes-dashboard-kong-proxy:443/proxy/#/login</a>
but, due to the issues above, the token won't work:</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-84-1"><a id="__codelineno-84-1" name="__codelineno-84-1" href="#__codelineno-84-1"></a><span class="gp">$ </span>kubectl<span class="w"> </span>logs<span class="w"> </span>-n<span class="w"> </span>kubernetes-dashboard<span class="w"> </span><span class="se">\</span>
</span><span id="__span-84-2"><a id="__codelineno-84-2" name="__codelineno-84-2" href="#__codelineno-84-2"></a><span class="gp">  $</span><span class="o">(</span>kubectl<span class="w"> </span>get<span class="w"> </span>pods<span class="w"> </span>-n<span class="w"> </span>kubernetes-dashboard<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>kubernetes-dashboard-web<span class="w"> </span><span class="p">|</span><span class="w"> </span>cut<span class="w"> </span>-f1<span class="w"> </span>-d<span class="s1">' '</span><span class="o">)</span><span class="w"> </span>-f
</span><span id="__span-84-3"><a id="__codelineno-84-3" name="__codelineno-84-3" href="#__codelineno-84-3"></a><span class="go">...</span>
</span><span id="__span-84-4"><a id="__codelineno-84-4" name="__codelineno-84-4" href="#__codelineno-84-4"></a><span class="go">E0223 18:46:31.743145       1 handler.go:33] "Could not get user" err="MSG_LOGIN_UNAUTHORIZED_ERROR"</span>
</span></code></pre></div>
<h5 id="custom-helm-values">Custom Helm Values</h5>
<p>To customize the Kubernetes dashboard installation, use 
<a href="https://github.com/kubernetes/dashboard/blob/master/charts/kubernetes-dashboard/values.yaml">helm chart values</a>
to enable the <code>ingress</code> and set services as <code>LoadBalancer</code> so they get each a
dedicated virtual IP address:</p>
<div class="language-yaml highlight"><span class="filename">dashboard/values.yaml</span><pre><span></span><code><span id="__span-85-1"><a id="__codelineno-85-1" name="__codelineno-85-1" href="#__codelineno-85-1"></a><span class="nt">app</span><span class="p">:</span>
</span><span id="__span-85-2"><a id="__codelineno-85-2" name="__codelineno-85-2" href="#__codelineno-85-2"></a><span class="w">  </span><span class="nt">ingress</span><span class="p">:</span>
</span><span id="__span-85-3"><a id="__codelineno-85-3" name="__codelineno-85-3" href="#__codelineno-85-3"></a><span class="w">    </span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
</span><span id="__span-85-4"><a id="__codelineno-85-4" name="__codelineno-85-4" href="#__codelineno-85-4"></a><span class="w">    </span><span class="nt">hosts</span><span class="p">:</span>
</span><span id="__span-85-5"><a id="__codelineno-85-5" name="__codelineno-85-5" href="#__codelineno-85-5"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">alfred</span>
</span><span id="__span-85-6"><a id="__codelineno-85-6" name="__codelineno-85-6" href="#__codelineno-85-6"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">alfred-kong</span>
</span><span id="__span-85-7"><a id="__codelineno-85-7" name="__codelineno-85-7" href="#__codelineno-85-7"></a><span class="nt">web</span><span class="p">:</span>
</span><span id="__span-85-8"><a id="__codelineno-85-8" name="__codelineno-85-8" href="#__codelineno-85-8"></a><span class="w">  </span><span class="nt">service</span><span class="p">:</span>
</span><span id="__span-85-9"><a id="__codelineno-85-9" name="__codelineno-85-9" href="#__codelineno-85-9"></a><span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">LoadBalancer</span>
</span><span id="__span-85-10"><a id="__codelineno-85-10" name="__codelineno-85-10" href="#__codelineno-85-10"></a><span class="nt">kong</span><span class="p">:</span>
</span><span id="__span-85-11"><a id="__codelineno-85-11" name="__codelineno-85-11" href="#__codelineno-85-11"></a><span class="w">  </span><span class="nt">ingressController</span><span class="p">:</span>
</span><span id="__span-85-12"><a id="__codelineno-85-12" name="__codelineno-85-12" href="#__codelineno-85-12"></a><span class="w">    </span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
</span><span id="__span-85-13"><a id="__codelineno-85-13" name="__codelineno-85-13" href="#__codelineno-85-13"></a><span class="w">  </span><span class="nt">proxy</span><span class="p">:</span>
</span><span id="__span-85-14"><a id="__codelineno-85-14" name="__codelineno-85-14" href="#__codelineno-85-14"></a><span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">LoadBalancer</span>
</span></code></pre></div>
<p>Update the dashboard with the custom values:</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-86-1"><a id="__codelineno-86-1" name="__codelineno-86-1" href="#__codelineno-86-1"></a><span class="gp">$ </span>helm<span class="w"> </span>upgrade<span class="w"> </span><span class="se">\</span>
</span><span id="__span-86-2"><a id="__codelineno-86-2" name="__codelineno-86-2" href="#__codelineno-86-2"></a><span class="w">  </span>kubernetes-dashboard<span class="w"> </span><span class="se">\</span>
</span><span id="__span-86-3"><a id="__codelineno-86-3" name="__codelineno-86-3" href="#__codelineno-86-3"></a><span class="w">    </span>kubernetes-dashboard/kubernetes-dashboard<span class="w"> </span><span class="se">\</span>
</span><span id="__span-86-4"><a id="__codelineno-86-4" name="__codelineno-86-4" href="#__codelineno-86-4"></a><span class="w">  </span>--create-namespace<span class="w"> </span><span class="se">\</span>
</span><span id="__span-86-5"><a id="__codelineno-86-5" name="__codelineno-86-5" href="#__codelineno-86-5"></a><span class="w">  </span>--namespace<span class="w"> </span>kubernetes-dashboard<span class="w"> </span><span class="se">\</span>
</span><span id="__span-86-6"><a id="__codelineno-86-6" name="__codelineno-86-6" href="#__codelineno-86-6"></a><span class="w">  </span>--values<span class="o">=</span>dashboard/values.yaml
</span><span id="__span-86-7"><a id="__codelineno-86-7" name="__codelineno-86-7" href="#__codelineno-86-7"></a><span class="go">Release "kubernetes-dashboard" has been upgraded. Happy Helming!</span>
</span><span id="__span-86-8"><a id="__codelineno-86-8" name="__codelineno-86-8" href="#__codelineno-86-8"></a><span class="go">NAME: kubernetes-dashboard</span>
</span><span id="__span-86-9"><a id="__codelineno-86-9" name="__codelineno-86-9" href="#__codelineno-86-9"></a><span class="go">LAST DEPLOYED: Sun Feb 23 17:59:31 2025</span>
</span><span id="__span-86-10"><a id="__codelineno-86-10" name="__codelineno-86-10" href="#__codelineno-86-10"></a><span class="go">NAMESPACE: kubernetes-dashboard</span>
</span><span id="__span-86-11"><a id="__codelineno-86-11" name="__codelineno-86-11" href="#__codelineno-86-11"></a><span class="go">STATUS: deployed</span>
</span><span id="__span-86-12"><a id="__codelineno-86-12" name="__codelineno-86-12" href="#__codelineno-86-12"></a><span class="go">REVISION: 5</span>
</span><span id="__span-86-13"><a id="__codelineno-86-13" name="__codelineno-86-13" href="#__codelineno-86-13"></a><span class="go">TEST SUITE: None</span>
</span><span id="__span-86-14"><a id="__codelineno-86-14" name="__codelineno-86-14" href="#__codelineno-86-14"></a><span class="go">NOTES:</span>
</span><span id="__span-86-15"><a id="__codelineno-86-15" name="__codelineno-86-15" href="#__codelineno-86-15"></a><span class="go">*************************************************************************************************</span>
</span><span id="__span-86-16"><a id="__codelineno-86-16" name="__codelineno-86-16" href="#__codelineno-86-16"></a><span class="go">*** PLEASE BE PATIENT: Kubernetes Dashboard may need a few minutes to get up and become ready ***</span>
</span><span id="__span-86-17"><a id="__codelineno-86-17" name="__codelineno-86-17" href="#__codelineno-86-17"></a><span class="go">*************************************************************************************************</span>
</span><span id="__span-86-18"><a id="__codelineno-86-18" name="__codelineno-86-18" href="#__codelineno-86-18"></a>
</span><span id="__span-86-19"><a id="__codelineno-86-19" name="__codelineno-86-19" href="#__codelineno-86-19"></a><span class="go">Congratulations! You have just installed Kubernetes Dashboard in your cluster.</span>
</span><span id="__span-86-20"><a id="__codelineno-86-20" name="__codelineno-86-20" href="#__codelineno-86-20"></a>
</span><span id="__span-86-21"><a id="__codelineno-86-21" name="__codelineno-86-21" href="#__codelineno-86-21"></a><span class="go">To access Dashboard run:</span>
</span><span id="__span-86-22"><a id="__codelineno-86-22" name="__codelineno-86-22" href="#__codelineno-86-22"></a><span class="go">  kubectl -n kubernetes-dashboard port-forward svc/kubernetes-dashboard-kong-proxy 8443:443</span>
</span><span id="__span-86-23"><a id="__codelineno-86-23" name="__codelineno-86-23" href="#__codelineno-86-23"></a>
</span><span id="__span-86-24"><a id="__codelineno-86-24" name="__codelineno-86-24" href="#__codelineno-86-24"></a><span class="go">NOTE: In case port-forward command does not work, make sure that kong service name is correct.</span>
</span><span id="__span-86-25"><a id="__codelineno-86-25" name="__codelineno-86-25" href="#__codelineno-86-25"></a><span class="go">      Check the services in Kubernetes Dashboard namespace using:</span>
</span><span id="__span-86-26"><a id="__codelineno-86-26" name="__codelineno-86-26" href="#__codelineno-86-26"></a><span class="go">        kubectl -n kubernetes-dashboard get svc</span>
</span><span id="__span-86-27"><a id="__codelineno-86-27" name="__codelineno-86-27" href="#__codelineno-86-27"></a>
</span><span id="__span-86-28"><a id="__codelineno-86-28" name="__codelineno-86-28" href="#__codelineno-86-28"></a><span class="go">Dashboard will be available at:</span>
</span><span id="__span-86-29"><a id="__codelineno-86-29" name="__codelineno-86-29" href="#__codelineno-86-29"></a><span class="go">  https://localhost:8443</span>
</span><span id="__span-86-30"><a id="__codelineno-86-30" name="__codelineno-86-30" href="#__codelineno-86-30"></a>
</span><span id="__span-86-31"><a id="__codelineno-86-31" name="__codelineno-86-31" href="#__codelineno-86-31"></a>
</span><span id="__span-86-32"><a id="__codelineno-86-32" name="__codelineno-86-32" href="#__codelineno-86-32"></a>
</span><span id="__span-86-33"><a id="__codelineno-86-33" name="__codelineno-86-33" href="#__codelineno-86-33"></a><span class="go">Looks like you are deploying Kubernetes Dashboard on a custom domain(s).</span>
</span><span id="__span-86-34"><a id="__codelineno-86-34" name="__codelineno-86-34" href="#__codelineno-86-34"></a><span class="go">Please make sure that the ingress configuration is valid.</span>
</span><span id="__span-86-35"><a id="__codelineno-86-35" name="__codelineno-86-35" href="#__codelineno-86-35"></a><span class="go">Dashboard should be accessible on your configured domain(s) soon:</span>
</span><span id="__span-86-36"><a id="__codelineno-86-36" name="__codelineno-86-36" href="#__codelineno-86-36"></a><span class="go">  - https://alfred</span>
</span></code></pre></div>
<p>The web UI is available on http://192.168.0.151:8000/ but only from the local
host (e.g. via <code>curl</code>), it still refuses connections from other clients.</p>
<p>On the contrary, https://alfred/ does not accept connections even locally,
because it is only running as <code>ClusterIP</code> so it is only reachable on
https://10.100.147.211/</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-87-1"><a id="__codelineno-87-1" name="__codelineno-87-1" href="#__codelineno-87-1"></a><span class="gp">$ </span>kubectl<span class="w"> </span>get<span class="w"> </span>svc<span class="w"> </span>-n<span class="w"> </span>kubernetes-dashboard
</span><span id="__span-87-2"><a id="__codelineno-87-2" name="__codelineno-87-2" href="#__codelineno-87-2"></a><span class="go">NAME                                           TYPE           CLUSTER-IP       EXTERNAL-IP     PORT(S)               AGE</span>
</span><span id="__span-87-3"><a id="__codelineno-87-3" name="__codelineno-87-3" href="#__codelineno-87-3"></a><span class="go">kubernetes-dashboard-api                       ClusterIP      10.111.251.2     &lt;none&gt;          8000/TCP              72m</span>
</span><span id="__span-87-4"><a id="__codelineno-87-4" name="__codelineno-87-4" href="#__codelineno-87-4"></a><span class="go">kubernetes-dashboard-auth                      ClusterIP      10.96.196.222    &lt;none&gt;          8000/TCP              72m</span>
</span><span id="__span-87-5"><a id="__codelineno-87-5" name="__codelineno-87-5" href="#__codelineno-87-5"></a><span class="go">kubernetes-dashboard-kong-metrics              ClusterIP      10.99.128.207    &lt;none&gt;          10255/TCP,10254/TCP   30s</span>
</span><span id="__span-87-6"><a id="__codelineno-87-6" name="__codelineno-87-6" href="#__codelineno-87-6"></a><span class="hll"><span class="go">kubernetes-dashboard-kong-proxy                LoadBalancer   10.100.147.211   192.168.0.152   443:32353/TCP         72m</span>
</span></span><span id="__span-87-7"><a id="__codelineno-87-7" name="__codelineno-87-7" href="#__codelineno-87-7"></a><span class="go">kubernetes-dashboard-kong-validation-webhook   ClusterIP      10.104.184.144   &lt;none&gt;          443/TCP               30s</span>
</span><span id="__span-87-8"><a id="__codelineno-87-8" name="__codelineno-87-8" href="#__codelineno-87-8"></a><span class="go">kubernetes-dashboard-metrics-scraper           ClusterIP      10.106.137.217   &lt;none&gt;          8000/TCP              72m</span>
</span><span id="__span-87-9"><a id="__codelineno-87-9" name="__codelineno-87-9" href="#__codelineno-87-9"></a><span class="hll"><span class="go">kubernetes-dashboard-web                       LoadBalancer   10.106.239.53    192.168.0.151   8000:31544/TCP        72m</span>
</span></span></code></pre></div>
<p>However, both services refurse connections from clients other than localhost,
which makes the use of <code>LoadBalancer</code> rather pointless.</p>
<h4 id="alternatives-considered">Alternatives considered</h4>
<p>For a brief moment, considered falling back to the old deployment-based
<a href="https://raw.githubusercontent.com/kubernetes/dashboard/v2.7.0/aio/deploy/recommended.yaml">recommended.yaml</a>
used in previous clusters, but this may not work since 
<a href="https://github.com/kubernetes/dashboard/releases/tag/kubernetes-dashboard-7.10.3">kubernetes-dashboard-7.10.3</a>
is the first version compaible with Kubernetes v1.<strong>32</strong>.</p>
<p>Other resources briefly considered were:</p>
<ul>
<li><a href="https://spacelift.io/blog/kubernetes-dashboard#how-to-access-and-deploy-kubernetes-dashboard">Kubernetes Dashboard: Tutorial, Best Practices &amp; Alternatives</a></li>
<li><a href="https://medium.com/@martin.hodges/using-kong-to-access-kubernetes-services-using-a-gateway-resource-with-no-cloud-provided-8a1bcd396be9">Using Kong to access Kubernetes services, using a Gateway resource with no cloud provided LoadBalancer</a></li>
<li>Setting <a href="https://docs.konghq.com/gateway/latest/reference/configuration/#trusted_ips">trusted_ips</a> in Kong.</li>
</ul>
<h3 id="new-in-2026-headlamp"><strong>New in 2026:</strong> Headlamp</h3>
<p><a href="https://github.com/kubernetes-retired/dashboard?tab=readme-ov-file#kubernetes-dashboard">Kubernetes Dashboard</a>
was deprecated and archived in January 2026, and is no longer
maintained due to lack of active maintainers and contributors.
The suggested replacement is
<a href="https://github.com/kubernetes-sigs/headlamp?tab=readme-ov-file#------------">Headlamp</a>,
which can be deployed
<a href="https://headlamp.dev/docs/latest/installation/in-cluster/">in-cluster</a>
with a (Pomerium) ingress.</p>
<p>The easiest way to install Headlamp is to use their helm chart:</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-88-1"><a id="__codelineno-88-1" name="__codelineno-88-1" href="#__codelineno-88-1"></a><span class="gp">$ </span>helm<span class="w"> </span>repo<span class="w"> </span>add<span class="w"> </span>headlamp<span class="w"> </span>https://kubernetes-sigs.github.io/headlamp/
</span><span id="__span-88-2"><a id="__codelineno-88-2" name="__codelineno-88-2" href="#__codelineno-88-2"></a><span class="go">"headlamp" has been added to your repositories</span>
</span><span id="__span-88-3"><a id="__codelineno-88-3" name="__codelineno-88-3" href="#__codelineno-88-3"></a>
</span><span id="__span-88-4"><a id="__codelineno-88-4" name="__codelineno-88-4" href="#__codelineno-88-4"></a><span class="gp">$ </span>helm<span class="w"> </span>repo<span class="w"> </span>update
</span><span id="__span-88-5"><a id="__codelineno-88-5" name="__codelineno-88-5" href="#__codelineno-88-5"></a>
</span><span id="__span-88-6"><a id="__codelineno-88-6" name="__codelineno-88-6" href="#__codelineno-88-6"></a><span class="gp">$ </span>helm<span class="w"> </span>install<span class="w"> </span>headlamp<span class="w"> </span>headlamp/headlamp<span class="w"> </span><span class="se">\</span>
</span><span id="__span-88-7"><a id="__codelineno-88-7" name="__codelineno-88-7" href="#__codelineno-88-7"></a><span class="w">  </span>--namespace<span class="w"> </span>kube-system<span class="w"> </span><span class="se">\</span>
</span><span id="__span-88-8"><a id="__codelineno-88-8" name="__codelineno-88-8" href="#__codelineno-88-8"></a><span class="w">  </span>-f<span class="w"> </span>headlamp-values.yaml
</span><span id="__span-88-9"><a id="__codelineno-88-9" name="__codelineno-88-9" href="#__codelineno-88-9"></a><span class="go">NAME: headlamp</span>
</span><span id="__span-88-10"><a id="__codelineno-88-10" name="__codelineno-88-10" href="#__codelineno-88-10"></a><span class="go">LAST DEPLOYED: Sun Feb  1 00:27:44 2026</span>
</span><span id="__span-88-11"><a id="__codelineno-88-11" name="__codelineno-88-11" href="#__codelineno-88-11"></a><span class="go">NAMESPACE: kube-system</span>
</span><span id="__span-88-12"><a id="__codelineno-88-12" name="__codelineno-88-12" href="#__codelineno-88-12"></a><span class="go">STATUS: deployed</span>
</span><span id="__span-88-13"><a id="__codelineno-88-13" name="__codelineno-88-13" href="#__codelineno-88-13"></a><span class="go">REVISION: 1</span>
</span><span id="__span-88-14"><a id="__codelineno-88-14" name="__codelineno-88-14" href="#__codelineno-88-14"></a><span class="go">TEST SUITE: None</span>
</span><span id="__span-88-15"><a id="__codelineno-88-15" name="__codelineno-88-15" href="#__codelineno-88-15"></a><span class="go">NOTES:</span>
</span><span id="__span-88-16"><a id="__codelineno-88-16" name="__codelineno-88-16" href="#__codelineno-88-16"></a><span class="go">1. Get the application URL by running these commands:</span>
</span><span id="__span-88-17"><a id="__codelineno-88-17" name="__codelineno-88-17" href="#__codelineno-88-17"></a><span class="go">  export POD_NAME=$(kubectl get pods --namespace kube-system -l "app.kubernetes.io/name=headlamp,app.kubernetes.io/instance=headlamp" -o jsonpath="{.items[0].metadata.name}")</span>
</span><span id="__span-88-18"><a id="__codelineno-88-18" name="__codelineno-88-18" href="#__codelineno-88-18"></a><span class="go">  export CONTAINER_PORT=$(kubectl get pod --namespace kube-system $POD_NAME -o jsonpath="{.spec.containers[0].ports[0].containerPort}")</span>
</span><span id="__span-88-19"><a id="__codelineno-88-19" name="__codelineno-88-19" href="#__codelineno-88-19"></a><span class="go">  echo "Visit http://127.0.0.1:8080 to use your application"</span>
</span><span id="__span-88-20"><a id="__codelineno-88-20" name="__codelineno-88-20" href="#__codelineno-88-20"></a><span class="go">  kubectl --namespace kube-system port-forward $POD_NAME 8080:$CONTAINER_PORT</span>
</span><span id="__span-88-21"><a id="__codelineno-88-21" name="__codelineno-88-21" href="#__codelineno-88-21"></a><span class="go">2. Get the token using</span>
</span><span id="__span-88-22"><a id="__codelineno-88-22" name="__codelineno-88-22" href="#__codelineno-88-22"></a><span class="go">  kubectl create token headlamp --namespace kube-system</span>
</span></code></pre></div>
<div class="admonition k8s">
<p class="admonition-title"><code>headlamp-values.yaml</code></p>
<div class="language-yaml highlight"><pre><span></span><code><span id="__span-89-1"><a id="__codelineno-89-1" name="__codelineno-89-1" href="#__codelineno-89-1"></a><span class="nt">config</span><span class="p">:</span>
</span><span id="__span-89-2"><a id="__codelineno-89-2" name="__codelineno-89-2" href="#__codelineno-89-2"></a><span class="w">  </span><span class="nt">watchPlugins</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
</span><span id="__span-89-3"><a id="__codelineno-89-3" name="__codelineno-89-3" href="#__codelineno-89-3"></a><span class="nt">pluginsManager</span><span class="p">:</span>
</span><span id="__span-89-4"><a id="__codelineno-89-4" name="__codelineno-89-4" href="#__codelineno-89-4"></a><span class="w">  </span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
</span><span id="__span-89-5"><a id="__codelineno-89-5" name="__codelineno-89-5" href="#__codelineno-89-5"></a><span class="w">  </span><span class="nt">configContent</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
</span><span id="__span-89-6"><a id="__codelineno-89-6" name="__codelineno-89-6" href="#__codelineno-89-6"></a><span class="w">    </span><span class="no">plugins:</span>
</span><span id="__span-89-7"><a id="__codelineno-89-7" name="__codelineno-89-7" href="#__codelineno-89-7"></a><span class="w">      </span><span class="no">- name: cert-manager</span>
</span><span id="__span-89-8"><a id="__codelineno-89-8" name="__codelineno-89-8" href="#__codelineno-89-8"></a><span class="w">        </span><span class="no">source: https://artifacthub.io/packages/headlamp/headlamp-plugins/headlamp_cert-manager</span>
</span><span id="__span-89-9"><a id="__codelineno-89-9" name="__codelineno-89-9" href="#__codelineno-89-9"></a><span class="w">        </span><span class="no">version: 0.1.0</span>
</span><span id="__span-89-10"><a id="__codelineno-89-10" name="__codelineno-89-10" href="#__codelineno-89-10"></a><span class="w">      </span><span class="no">- name: flux</span>
</span><span id="__span-89-11"><a id="__codelineno-89-11" name="__codelineno-89-11" href="#__codelineno-89-11"></a><span class="w">        </span><span class="no">source: https://artifacthub.io/packages/headlamp/headlamp-plugins/headlamp_flux</span>
</span><span id="__span-89-12"><a id="__codelineno-89-12" name="__codelineno-89-12" href="#__codelineno-89-12"></a><span class="w">        </span><span class="no">version: 0.5.0</span>
</span><span id="__span-89-13"><a id="__codelineno-89-13" name="__codelineno-89-13" href="#__codelineno-89-13"></a><span class="w">      </span><span class="no">- name: trivy</span>
</span><span id="__span-89-14"><a id="__codelineno-89-14" name="__codelineno-89-14" href="#__codelineno-89-14"></a><span class="w">        </span><span class="no">source: https://artifacthub.io/packages/headlamp/headlamp-trivy/headlamp_trivy</span>
</span><span id="__span-89-15"><a id="__codelineno-89-15" name="__codelineno-89-15" href="#__codelineno-89-15"></a><span class="w">        </span><span class="no">version: 0.3.1</span>
</span><span id="__span-89-16"><a id="__codelineno-89-16" name="__codelineno-89-16" href="#__codelineno-89-16"></a><span class="w">    </span><span class="no">installOptions:</span>
</span><span id="__span-89-17"><a id="__codelineno-89-17" name="__codelineno-89-17" href="#__codelineno-89-17"></a><span class="w">      </span><span class="no">parallel: true</span>
</span><span id="__span-89-18"><a id="__codelineno-89-18" name="__codelineno-89-18" href="#__codelineno-89-18"></a><span class="w">      </span><span class="no">maxConcurrent: 2</span>
</span><span id="__span-89-19"><a id="__codelineno-89-19" name="__codelineno-89-19" href="#__codelineno-89-19"></a><span class="w">  </span><span class="nt">baseImage</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">node:lts-alpine</span>
</span><span id="__span-89-20"><a id="__codelineno-89-20" name="__codelineno-89-20" href="#__codelineno-89-20"></a><span class="w">  </span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">latest</span>
</span></code></pre></div>
</div>
<p>To make Headlamp available via <a href="../../../12/18/replacing-ingress-nginx-with-pomerium/">Pomerium ingress</a>
on external URL, add an <code>Ingress</code> manifest under <code>pomerium/pomerium-ingress/</code>
(and load it from <code>kustomization.yaml</code>):</p>
<div class="admonition k8s">
<p class="admonition-title"><code>pomerium/pomerium-ingress/headlamp.yaml</code></p>
<div class="language-yaml highlight"><pre><span></span><code><span id="__span-90-1"><a id="__codelineno-90-1" name="__codelineno-90-1" href="#__codelineno-90-1"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">networking.k8s.io/v1</span>
</span><span id="__span-90-2"><a id="__codelineno-90-2" name="__codelineno-90-2" href="#__codelineno-90-2"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Ingress</span>
</span><span id="__span-90-3"><a id="__codelineno-90-3" name="__codelineno-90-3" href="#__codelineno-90-3"></a><span class="nt">metadata</span><span class="p">:</span>
</span><span id="__span-90-4"><a id="__codelineno-90-4" name="__codelineno-90-4" href="#__codelineno-90-4"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">headlamp-pomerium-ingress</span>
</span><span id="__span-90-5"><a id="__codelineno-90-5" name="__codelineno-90-5" href="#__codelineno-90-5"></a><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">kube-system</span>
</span><span id="__span-90-6"><a id="__codelineno-90-6" name="__codelineno-90-6" href="#__codelineno-90-6"></a><span class="w">  </span><span class="nt">annotations</span><span class="p">:</span>
</span><span id="__span-90-7"><a id="__codelineno-90-7" name="__codelineno-90-7" href="#__codelineno-90-7"></a><span class="w">    </span><span class="nt">cert-manager.io/cluster-issuer</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">letsencrypt-prod</span>
</span><span id="__span-90-8"><a id="__codelineno-90-8" name="__codelineno-90-8" href="#__codelineno-90-8"></a><span class="w">    </span><span class="nt">ingress.pomerium.io/pass_identity_headers</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
</span><span id="__span-90-9"><a id="__codelineno-90-9" name="__codelineno-90-9" href="#__codelineno-90-9"></a><span class="nt">spec</span><span class="p">:</span>
</span><span id="__span-90-10"><a id="__codelineno-90-10" name="__codelineno-90-10" href="#__codelineno-90-10"></a><span class="w">  </span><span class="nt">ingressClassName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">pomerium</span>
</span><span id="__span-90-11"><a id="__codelineno-90-11" name="__codelineno-90-11" href="#__codelineno-90-11"></a><span class="w">  </span><span class="nt">rules</span><span class="p">:</span>
</span><span id="__span-90-12"><a id="__codelineno-90-12" name="__codelineno-90-12" href="#__codelineno-90-12"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">host</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">batlamp.very-very-dark-gray.top</span>
</span><span id="__span-90-13"><a id="__codelineno-90-13" name="__codelineno-90-13" href="#__codelineno-90-13"></a><span class="w">      </span><span class="nt">http</span><span class="p">:</span>
</span><span id="__span-90-14"><a id="__codelineno-90-14" name="__codelineno-90-14" href="#__codelineno-90-14"></a><span class="w">        </span><span class="nt">paths</span><span class="p">:</span>
</span><span id="__span-90-15"><a id="__codelineno-90-15" name="__codelineno-90-15" href="#__codelineno-90-15"></a><span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/</span>
</span><span id="__span-90-16"><a id="__codelineno-90-16" name="__codelineno-90-16" href="#__codelineno-90-16"></a><span class="w">            </span><span class="nt">pathType</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Prefix</span>
</span><span id="__span-90-17"><a id="__codelineno-90-17" name="__codelineno-90-17" href="#__codelineno-90-17"></a><span class="w">            </span><span class="nt">backend</span><span class="p">:</span>
</span><span id="__span-90-18"><a id="__codelineno-90-18" name="__codelineno-90-18" href="#__codelineno-90-18"></a><span class="w">              </span><span class="nt">service</span><span class="p">:</span>
</span><span id="__span-90-19"><a id="__codelineno-90-19" name="__codelineno-90-19" href="#__codelineno-90-19"></a><span class="w">                </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">headlamp</span>
</span><span id="__span-90-20"><a id="__codelineno-90-20" name="__codelineno-90-20" href="#__codelineno-90-20"></a><span class="w">                </span><span class="nt">port</span><span class="p">:</span>
</span><span id="__span-90-21"><a id="__codelineno-90-21" name="__codelineno-90-21" href="#__codelineno-90-21"></a><span class="w">                  </span><span class="nt">number</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">80</span>
</span><span id="__span-90-22"><a id="__codelineno-90-22" name="__codelineno-90-22" href="#__codelineno-90-22"></a><span class="w">  </span><span class="nt">tls</span><span class="p">:</span>
</span><span id="__span-90-23"><a id="__codelineno-90-23" name="__codelineno-90-23" href="#__codelineno-90-23"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">secretName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">tls-secret-cloudflare</span>
</span><span id="__span-90-24"><a id="__codelineno-90-24" name="__codelineno-90-24" href="#__codelineno-90-24"></a><span class="w">      </span><span class="nt">hosts</span><span class="p">:</span>
</span><span id="__span-90-25"><a id="__codelineno-90-25" name="__codelineno-90-25" href="#__codelineno-90-25"></a><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">batlamp.very-very-dark-gray.top</span>
</span></code></pre></div>
</div>
<p>Finally, to log into the Headlamp dashboard, request a token for <code>headlamp</code>:</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-91-1"><a id="__codelineno-91-1" name="__codelineno-91-1" href="#__codelineno-91-1"></a><span class="gp">$ </span>kubectl<span class="w"> </span>create<span class="w"> </span>token<span class="w"> </span>headlamp<span class="w"> </span>--namespace<span class="w"> </span>kube-system
</span></code></pre></div>
<h4 id="token-bypass">Token bypass</h4>
<p>Having Headlamp accessible only through a Cloudflare Tunnel <em>and</em> Pomerium, both of which
restrict access greatly, having to SSH in to create a token each team seems excessive and
unnecessarily inconvenient. To bypass that, create a <strong>legacy long-lived token</strong>:</p>
<div class="admonition k8s">
<p class="admonition-title"><code>headlamp-token.yaml</code></p>
<div class="language-yaml highlight"><pre><span></span><code><span id="__span-92-1"><a id="__codelineno-92-1" name="__codelineno-92-1" href="#__codelineno-92-1"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
</span><span id="__span-92-2"><a id="__codelineno-92-2" name="__codelineno-92-2" href="#__codelineno-92-2"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Secret</span>
</span><span id="__span-92-3"><a id="__codelineno-92-3" name="__codelineno-92-3" href="#__codelineno-92-3"></a><span class="nt">metadata</span><span class="p">:</span>
</span><span id="__span-92-4"><a id="__codelineno-92-4" name="__codelineno-92-4" href="#__codelineno-92-4"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">headlamp-static-token</span>
</span><span id="__span-92-5"><a id="__codelineno-92-5" name="__codelineno-92-5" href="#__codelineno-92-5"></a><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">kube-system</span>
</span><span id="__span-92-6"><a id="__codelineno-92-6" name="__codelineno-92-6" href="#__codelineno-92-6"></a><span class="w">  </span><span class="nt">annotations</span><span class="p">:</span>
</span><span id="__span-92-7"><a id="__codelineno-92-7" name="__codelineno-92-7" href="#__codelineno-92-7"></a><span class="w">    </span><span class="nt">kubernetes.io/service-account.name</span><span class="p">:</span><span class="w"> </span><span class="s">"headlamp"</span>
</span><span id="__span-92-8"><a id="__codelineno-92-8" name="__codelineno-92-8" href="#__codelineno-92-8"></a><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">kubernetes.io/service-account-token</span>
</span></code></pre></div>
</div>
<p>Create this <code>Secret</code> and extract the token:</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-93-1"><a id="__codelineno-93-1" name="__codelineno-93-1" href="#__codelineno-93-1"></a><span class="gp">$ </span>kubectl<span class="w"> </span>apply<span class="w"> </span>-f<span class="w"> </span>headlamp-token.yaml<span class="w"> </span>
</span><span id="__span-93-2"><a id="__codelineno-93-2" name="__codelineno-93-2" href="#__codelineno-93-2"></a><span class="go">secret/headlamp-static-token created</span>
</span><span id="__span-93-3"><a id="__codelineno-93-3" name="__codelineno-93-3" href="#__codelineno-93-3"></a>
</span><span id="__span-93-4"><a id="__codelineno-93-4" name="__codelineno-93-4" href="#__codelineno-93-4"></a><span class="gp">$ </span>kubectl<span class="w"> </span>get<span class="w"> </span>secret<span class="w"> </span>headlamp-static-token<span class="w"> </span><span class="se">\</span>
</span><span id="__span-93-5"><a id="__codelineno-93-5" name="__codelineno-93-5" href="#__codelineno-93-5"></a><span class="w">  </span>-n<span class="w"> </span>kube-system<span class="w"> </span>-o<span class="w"> </span><span class="nv">jsonpath</span><span class="o">=</span><span class="s1">'{.data.token}'</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>base64<span class="w"> </span>--decode
</span><span id="__span-93-6"><a id="__codelineno-93-6" name="__codelineno-93-6" href="#__codelineno-93-6"></a><span class="go">ey...</span>
</span></code></pre></div>
<p>Get the base64-encoded Certificate Authority (<code>CA</code>) data from the cluster:</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-94-1"><a id="__codelineno-94-1" name="__codelineno-94-1" href="#__codelineno-94-1"></a><span class="gp">$ </span>kubekubectl<span class="w"> </span>config<span class="w"> </span>view<span class="w"> </span>--raw<span class="w"> </span><span class="se">\</span>
</span><span id="__span-94-2"><a id="__codelineno-94-2" name="__codelineno-94-2" href="#__codelineno-94-2"></a><span class="w">  </span>-o<span class="w"> </span><span class="nv">jsonpath</span><span class="o">=</span><span class="s1">'{.clusters[0].cluster.certificate-authority-data}'</span>
</span><span id="__span-94-3"><a id="__codelineno-94-3" name="__codelineno-94-3" href="#__codelineno-94-3"></a><span class="go">LS...</span>
</span></code></pre></div>
<p>Then create a <code>Config</code> to hold that token plus the <code>CA</code> data from:</p>
<div class="admonition k8s">
<p class="admonition-title"><code>headlamp-kubeconfig.yaml</code></p>
<div class="language-yaml highlight"><pre><span></span><code><span id="__span-95-1"><a id="__codelineno-95-1" name="__codelineno-95-1" href="#__codelineno-95-1"></a><span class="w">    </span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
</span><span id="__span-95-2"><a id="__codelineno-95-2" name="__codelineno-95-2" href="#__codelineno-95-2"></a><span class="w">    </span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Config</span>
</span><span id="__span-95-3"><a id="__codelineno-95-3" name="__codelineno-95-3" href="#__codelineno-95-3"></a><span class="w">    </span><span class="nt">clusters</span><span class="p">:</span>
</span><span id="__span-95-4"><a id="__codelineno-95-4" name="__codelineno-95-4" href="#__codelineno-95-4"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">cluster</span><span class="p">:</span>
</span><span id="__span-95-5"><a id="__codelineno-95-5" name="__codelineno-95-5" href="#__codelineno-95-5"></a><span class="w">        </span><span class="nt">certificate-authority-data</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">LS...&lt;CLUSTER_CA_DATA&gt;</span>
</span><span id="__span-95-6"><a id="__codelineno-95-6" name="__codelineno-95-6" href="#__codelineno-95-6"></a><span class="w">        </span><span class="nt">server</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">https://kubernetes.default.svc</span>
</span><span id="__span-95-7"><a id="__codelineno-95-7" name="__codelineno-95-7" href="#__codelineno-95-7"></a><span class="w">      </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">kubernetes</span>
</span><span id="__span-95-8"><a id="__codelineno-95-8" name="__codelineno-95-8" href="#__codelineno-95-8"></a><span class="w">    </span><span class="nt">contexts</span><span class="p">:</span>
</span><span id="__span-95-9"><a id="__codelineno-95-9" name="__codelineno-95-9" href="#__codelineno-95-9"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">context</span><span class="p">:</span>
</span><span id="__span-95-10"><a id="__codelineno-95-10" name="__codelineno-95-10" href="#__codelineno-95-10"></a><span class="w">        </span><span class="nt">cluster</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">kubernetes</span>
</span><span id="__span-95-11"><a id="__codelineno-95-11" name="__codelineno-95-11" href="#__codelineno-95-11"></a><span class="w">        </span><span class="nt">user</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">headlamp-user</span>
</span><span id="__span-95-12"><a id="__codelineno-95-12" name="__codelineno-95-12" href="#__codelineno-95-12"></a><span class="w">      </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">headlamp-context</span>
</span><span id="__span-95-13"><a id="__codelineno-95-13" name="__codelineno-95-13" href="#__codelineno-95-13"></a><span class="w">    </span><span class="nt">current-context</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">headlamp-context</span>
</span><span id="__span-95-14"><a id="__codelineno-95-14" name="__codelineno-95-14" href="#__codelineno-95-14"></a><span class="w">    </span><span class="nt">users</span><span class="p">:</span>
</span><span id="__span-95-15"><a id="__codelineno-95-15" name="__codelineno-95-15" href="#__codelineno-95-15"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">headlamp-user</span>
</span><span id="__span-95-16"><a id="__codelineno-95-16" name="__codelineno-95-16" href="#__codelineno-95-16"></a><span class="w">      </span><span class="nt">user</span><span class="p">:</span>
</span><span id="__span-95-17"><a id="__codelineno-95-17" name="__codelineno-95-17" href="#__codelineno-95-17"></a><span class="w">        </span><span class="nt">token</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ey...&lt;GENERATED_TOKEN&gt;</span>
</span></code></pre></div>
</div>
<p>Create the <code>Secret</code> using the <code>create secret</code> command to wrap your file into an
<code>Opaque</code> secret: </p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-96-1"><a id="__codelineno-96-1" name="__codelineno-96-1" href="#__codelineno-96-1"></a><span class="gp">$ </span>kubectl<span class="w"> </span>create<span class="w"> </span>secret<span class="w"> </span>generic<span class="w"> </span>headlamp-kubeconfig<span class="w"> </span><span class="se">\</span>
</span><span id="__span-96-2"><a id="__codelineno-96-2" name="__codelineno-96-2" href="#__codelineno-96-2"></a><span class="w">  </span>--from-file<span class="o">=</span><span class="nv">config</span><span class="o">=</span>./headlamp-kubeconfig.yaml<span class="w"> </span>-n<span class="w"> </span>kube-system
</span><span id="__span-96-3"><a id="__codelineno-96-3" name="__codelineno-96-3" href="#__codelineno-96-3"></a><span class="go">secret/headlamp-kubeconfig created</span>
</span></code></pre></div>
<p>Add the <code>kubeconfig</code> as a volume along with the <code>-dev</code> flag for less strict security:</p>
<div class="admonition k8s">
<p class="admonition-title"><code>headlamp-values.yaml</code></p>
<div class="language-yaml highlight"><pre><span></span><code><span id="__span-97-1"><a id="__codelineno-97-1" name="__codelineno-97-1" href="#__codelineno-97-1"></a><span class="nt">config</span><span class="p">:</span>
</span><span id="__span-97-2"><a id="__codelineno-97-2" name="__codelineno-97-2" href="#__codelineno-97-2"></a><span class="w">  </span><span class="nt">inCluster</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">false</span>
</span><span id="__span-97-3"><a id="__codelineno-97-3" name="__codelineno-97-3" href="#__codelineno-97-3"></a><span class="w">  </span><span class="nt">extraArgs</span><span class="p">:</span>
</span><span id="__span-97-4"><a id="__codelineno-97-4" name="__codelineno-97-4" href="#__codelineno-97-4"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">"-dev"</span>
</span><span id="__span-97-5"><a id="__codelineno-97-5" name="__codelineno-97-5" href="#__codelineno-97-5"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">"-kubeconfig=/home/headlamp/.config/Headlamp/kubeconfigs/config"</span>
</span><span id="__span-97-6"><a id="__codelineno-97-6" name="__codelineno-97-6" href="#__codelineno-97-6"></a><span class="w">  </span><span class="nt">watchPlugins</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
</span><span id="__span-97-7"><a id="__codelineno-97-7" name="__codelineno-97-7" href="#__codelineno-97-7"></a><span class="nt">env</span><span class="p">:</span>
</span><span id="__span-97-8"><a id="__codelineno-97-8" name="__codelineno-97-8" href="#__codelineno-97-8"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">KUBECONFIG</span>
</span><span id="__span-97-9"><a id="__codelineno-97-9" name="__codelineno-97-9" href="#__codelineno-97-9"></a><span class="w">    </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/home/headlamp/.config/Headlamp/kubeconfigs/config</span>
</span><span id="__span-97-10"><a id="__codelineno-97-10" name="__codelineno-97-10" href="#__codelineno-97-10"></a><span class="nt">volumeMounts</span><span class="p">:</span>
</span><span id="__span-97-11"><a id="__codelineno-97-11" name="__codelineno-97-11" href="#__codelineno-97-11"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">kubeconfig-volume</span>
</span><span id="__span-97-12"><a id="__codelineno-97-12" name="__codelineno-97-12" href="#__codelineno-97-12"></a><span class="w">    </span><span class="nt">mountPath</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/home/headlamp/.config/Headlamp/kubeconfigs/</span>
</span><span id="__span-97-13"><a id="__codelineno-97-13" name="__codelineno-97-13" href="#__codelineno-97-13"></a><span class="w">    </span><span class="nt">readOnly</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
</span><span id="__span-97-14"><a id="__codelineno-97-14" name="__codelineno-97-14" href="#__codelineno-97-14"></a><span class="nt">volumes</span><span class="p">:</span>
</span><span id="__span-97-15"><a id="__codelineno-97-15" name="__codelineno-97-15" href="#__codelineno-97-15"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">kubeconfig-volume</span>
</span><span id="__span-97-16"><a id="__codelineno-97-16" name="__codelineno-97-16" href="#__codelineno-97-16"></a><span class="w">    </span><span class="nt">secret</span><span class="p">:</span>
</span><span id="__span-97-17"><a id="__codelineno-97-17" name="__codelineno-97-17" href="#__codelineno-97-17"></a><span class="w">      </span><span class="nt">secretName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">headlamp-kubeconfig</span>
</span><span id="__span-97-18"><a id="__codelineno-97-18" name="__codelineno-97-18" href="#__codelineno-97-18"></a><span class="nt">pluginsManager</span><span class="p">:</span>
</span><span id="__span-97-19"><a id="__codelineno-97-19" name="__codelineno-97-19" href="#__codelineno-97-19"></a><span class="w">  </span><span class="l l-Scalar l-Scalar-Plain">...</span>
</span></code></pre></div>
</div>
<p>Finally, upgrade the deployment with the new Helm values:</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-98-1"><a id="__codelineno-98-1" name="__codelineno-98-1" href="#__codelineno-98-1"></a><span class="gp">$ </span>helm<span class="w"> </span>upgrade<span class="w"> </span>headlamp<span class="w"> </span>headlamp/headlamp<span class="w"> </span><span class="se">\</span>
</span><span id="__span-98-2"><a id="__codelineno-98-2" name="__codelineno-98-2" href="#__codelineno-98-2"></a><span class="w">  </span>--namespace<span class="w"> </span>kube-system<span class="w"> </span><span class="se">\</span>
</span><span id="__span-98-3"><a id="__codelineno-98-3" name="__codelineno-98-3" href="#__codelineno-98-3"></a><span class="w">  </span>-f<span class="w"> </span>headlamp-values.yaml
</span><span id="__span-98-4"><a id="__codelineno-98-4" name="__codelineno-98-4" href="#__codelineno-98-4"></a><span class="go">NAME: headlamp</span>
</span><span id="__span-98-5"><a id="__codelineno-98-5" name="__codelineno-98-5" href="#__codelineno-98-5"></a><span class="go">LAST DEPLOYED: Sun Feb  1 00:27:44 2026</span>
</span><span id="__span-98-6"><a id="__codelineno-98-6" name="__codelineno-98-6" href="#__codelineno-98-6"></a><span class="go">NAMESPACE: kube-system</span>
</span><span id="__span-98-7"><a id="__codelineno-98-7" name="__codelineno-98-7" href="#__codelineno-98-7"></a><span class="go">STATUS: deployed</span>
</span><span id="__span-98-8"><a id="__codelineno-98-8" name="__codelineno-98-8" href="#__codelineno-98-8"></a><span class="go">REVISION: 1</span>
</span><span id="__span-98-9"><a id="__codelineno-98-9" name="__codelineno-98-9" href="#__codelineno-98-9"></a><span class="go">TEST SUITE: None</span>
</span><span id="__span-98-10"><a id="__codelineno-98-10" name="__codelineno-98-10" href="#__codelineno-98-10"></a><span class="go">NOTES:</span>
</span><span id="__span-98-11"><a id="__codelineno-98-11" name="__codelineno-98-11" href="#__codelineno-98-11"></a><span class="go">1. Get the application URL by running these commands:</span>
</span><span id="__span-98-12"><a id="__codelineno-98-12" name="__codelineno-98-12" href="#__codelineno-98-12"></a><span class="go">  export POD_NAME=$(kubectl get pods --namespace kube-system -l "app.kubernetes.io/name=headlamp,app.kubernetes.io/instance=headlamp" -o jsonpath="{.items[0].metadata.name}")</span>
</span><span id="__span-98-13"><a id="__codelineno-98-13" name="__codelineno-98-13" href="#__codelineno-98-13"></a><span class="go">  export CONTAINER_PORT=$(kubectl get pod --namespace kube-system $POD_NAME -o jsonpath="{.spec.containers[0].ports[0].containerPort}")</span>
</span><span id="__span-98-14"><a id="__codelineno-98-14" name="__codelineno-98-14" href="#__codelineno-98-14"></a><span class="go">  echo "Visit http://127.0.0.1:8080 to use your application"</span>
</span><span id="__span-98-15"><a id="__codelineno-98-15" name="__codelineno-98-15" href="#__codelineno-98-15"></a><span class="go">  kubectl --namespace kube-system port-forward $POD_NAME 8080:$CONTAINER_PORT</span>
</span><span id="__span-98-16"><a id="__codelineno-98-16" name="__codelineno-98-16" href="#__codelineno-98-16"></a><span class="go">2. Get the token using</span>
</span><span id="__span-98-17"><a id="__codelineno-98-17" name="__codelineno-98-17" href="#__codelineno-98-17"></a><span class="go">  kubectl create token headlamp --namespace kube-system</span>
</span></code></pre></div>
<h3 id="ingress-controller">Ingress Controller</h3>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>The Nginx Ingress Controller was deprecated in 2025 and
<a href="../../../12/18/replacing-ingress-nginx-with-pomerium/">replaced with Pomerium</a>.</p>
</div>
<p>An Nginx Ingress Controller will be used to redirect HTTPS requests to
different services depending on the <code>Host</code> header, while all those requests
will be hitting the same IP address.</p>
<p>The current Nginx
<a href="https://kubernetes.github.io/ingress-nginx/deploy/">Installation Guide</a>
essentially suggests two methods to install Nginx:</p>
<ul>
<li>The Helm chart.</li>
<li>The default v1.12 deployment
  <a href="https://raw.githubusercontent.com/kubernetes/ingress-nginx/controller-v1.12.0/deploy/static/provider/cloud/deploy.yaml">based on the Helm chart</a>.</li>
<li>A <code>NodePort</code> deployment for
  <a href="https://kubernetes.github.io/ingress-nginx/deploy/#bare-metal-clusters">bare metal clusters</a>.</li>
</ul>
<p><a href="https://github.com/kubernetes/ingress-nginx?tab=readme-ov-file#supported-versions-table">Supported Versions table</a>
indicates Nginx v1.12 is the first version compaible with Kubernetes v1.32 and,
most conviniently, the updated version is nearly the only difference between
the default deployment based on the Helm template and the deployment used in
previous clusters.</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-99-1"><a id="__codelineno-99-1" name="__codelineno-99-1" href="#__codelineno-99-1"></a><span class="gp">$ </span>helm<span class="w"> </span>repo<span class="w"> </span>add<span class="w"> </span><span class="se">\</span>
</span><span id="__span-99-2"><a id="__codelineno-99-2" name="__codelineno-99-2" href="#__codelineno-99-2"></a><span class="w">  </span>ingress-nginx<span class="w"> </span><span class="se">\</span>
</span><span id="__span-99-3"><a id="__codelineno-99-3" name="__codelineno-99-3" href="#__codelineno-99-3"></a><span class="w">  </span>https://kubernetes.github.io/ingress-nginx
</span><span id="__span-99-4"><a id="__codelineno-99-4" name="__codelineno-99-4" href="#__codelineno-99-4"></a><span class="go">"ingress-nginx" has been added to your repositories</span>
</span><span id="__span-99-5"><a id="__codelineno-99-5" name="__codelineno-99-5" href="#__codelineno-99-5"></a>
</span><span id="__span-99-6"><a id="__codelineno-99-6" name="__codelineno-99-6" href="#__codelineno-99-6"></a><span class="gp">$ </span>helm<span class="w"> </span>upgrade<span class="w"> </span><span class="se">\</span>
</span><span id="__span-99-7"><a id="__codelineno-99-7" name="__codelineno-99-7" href="#__codelineno-99-7"></a><span class="w">  </span>--install<span class="w"> </span>ingress-nginx<span class="w"> </span><span class="se">\</span>
</span><span id="__span-99-8"><a id="__codelineno-99-8" name="__codelineno-99-8" href="#__codelineno-99-8"></a><span class="w">  </span>ingress-nginx/ingress-nginx<span class="w"> </span><span class="se">\</span>
</span><span id="__span-99-9"><a id="__codelineno-99-9" name="__codelineno-99-9" href="#__codelineno-99-9"></a><span class="w">  </span>--create-namespace<span class="w"> </span><span class="se">\</span>
</span><span id="__span-99-10"><a id="__codelineno-99-10" name="__codelineno-99-10" href="#__codelineno-99-10"></a><span class="w">  </span>--namespace<span class="w"> </span>ingress-nginx
</span><span id="__span-99-11"><a id="__codelineno-99-11" name="__codelineno-99-11" href="#__codelineno-99-11"></a><span class="go">Release "ingress-nginx" does not exist. Installing it now.</span>
</span><span id="__span-99-12"><a id="__codelineno-99-12" name="__codelineno-99-12" href="#__codelineno-99-12"></a><span class="go">NAME: ingress-nginx</span>
</span><span id="__span-99-13"><a id="__codelineno-99-13" name="__codelineno-99-13" href="#__codelineno-99-13"></a><span class="go">LAST DEPLOYED: Sun Feb 23 21:26:13 2025</span>
</span><span id="__span-99-14"><a id="__codelineno-99-14" name="__codelineno-99-14" href="#__codelineno-99-14"></a><span class="go">NAMESPACE: ingress-nginx</span>
</span><span id="__span-99-15"><a id="__codelineno-99-15" name="__codelineno-99-15" href="#__codelineno-99-15"></a><span class="go">STATUS: deployed</span>
</span><span id="__span-99-16"><a id="__codelineno-99-16" name="__codelineno-99-16" href="#__codelineno-99-16"></a><span class="go">REVISION: 1</span>
</span><span id="__span-99-17"><a id="__codelineno-99-17" name="__codelineno-99-17" href="#__codelineno-99-17"></a><span class="go">TEST SUITE: None</span>
</span><span id="__span-99-18"><a id="__codelineno-99-18" name="__codelineno-99-18" href="#__codelineno-99-18"></a><span class="go">NOTES:</span>
</span><span id="__span-99-19"><a id="__codelineno-99-19" name="__codelineno-99-19" href="#__codelineno-99-19"></a><span class="go">The ingress-nginx controller has been installed.</span>
</span><span id="__span-99-20"><a id="__codelineno-99-20" name="__codelineno-99-20" href="#__codelineno-99-20"></a><span class="go">It may take a few minutes for the load balancer IP to be available.</span>
</span><span id="__span-99-21"><a id="__codelineno-99-21" name="__codelineno-99-21" href="#__codelineno-99-21"></a><span class="go">You can watch the status by running 'kubectl get service --namespace ingress-nginx ingress-nginx-controller --output wide --watch'</span>
</span><span id="__span-99-22"><a id="__codelineno-99-22" name="__codelineno-99-22" href="#__codelineno-99-22"></a>
</span><span id="__span-99-23"><a id="__codelineno-99-23" name="__codelineno-99-23" href="#__codelineno-99-23"></a><span class="go">An example Ingress that makes use of the controller:</span>
</span><span id="__span-99-24"><a id="__codelineno-99-24" name="__codelineno-99-24" href="#__codelineno-99-24"></a><span class="go">  apiVersion: networking.k8s.io/v1</span>
</span><span id="__span-99-25"><a id="__codelineno-99-25" name="__codelineno-99-25" href="#__codelineno-99-25"></a><span class="go">  kind: Ingress</span>
</span><span id="__span-99-26"><a id="__codelineno-99-26" name="__codelineno-99-26" href="#__codelineno-99-26"></a><span class="go">  metadata:</span>
</span><span id="__span-99-27"><a id="__codelineno-99-27" name="__codelineno-99-27" href="#__codelineno-99-27"></a><span class="go">    name: example</span>
</span><span id="__span-99-28"><a id="__codelineno-99-28" name="__codelineno-99-28" href="#__codelineno-99-28"></a><span class="go">    namespace: foo</span>
</span><span id="__span-99-29"><a id="__codelineno-99-29" name="__codelineno-99-29" href="#__codelineno-99-29"></a><span class="go">  spec:</span>
</span><span id="__span-99-30"><a id="__codelineno-99-30" name="__codelineno-99-30" href="#__codelineno-99-30"></a><span class="go">    ingressClassName: nginx</span>
</span><span id="__span-99-31"><a id="__codelineno-99-31" name="__codelineno-99-31" href="#__codelineno-99-31"></a><span class="go">    rules:</span>
</span><span id="__span-99-32"><a id="__codelineno-99-32" name="__codelineno-99-32" href="#__codelineno-99-32"></a><span class="go">      - host: www.example.com</span>
</span><span id="__span-99-33"><a id="__codelineno-99-33" name="__codelineno-99-33" href="#__codelineno-99-33"></a><span class="go">        http:</span>
</span><span id="__span-99-34"><a id="__codelineno-99-34" name="__codelineno-99-34" href="#__codelineno-99-34"></a><span class="go">          paths:</span>
</span><span id="__span-99-35"><a id="__codelineno-99-35" name="__codelineno-99-35" href="#__codelineno-99-35"></a><span class="go">            - pathType: Prefix</span>
</span><span id="__span-99-36"><a id="__codelineno-99-36" name="__codelineno-99-36" href="#__codelineno-99-36"></a><span class="go">              backend:</span>
</span><span id="__span-99-37"><a id="__codelineno-99-37" name="__codelineno-99-37" href="#__codelineno-99-37"></a><span class="go">                service:</span>
</span><span id="__span-99-38"><a id="__codelineno-99-38" name="__codelineno-99-38" href="#__codelineno-99-38"></a><span class="go">                  name: exampleService</span>
</span><span id="__span-99-39"><a id="__codelineno-99-39" name="__codelineno-99-39" href="#__codelineno-99-39"></a><span class="go">                  port:</span>
</span><span id="__span-99-40"><a id="__codelineno-99-40" name="__codelineno-99-40" href="#__codelineno-99-40"></a><span class="go">                    number: 80</span>
</span><span id="__span-99-41"><a id="__codelineno-99-41" name="__codelineno-99-41" href="#__codelineno-99-41"></a><span class="go">              path: /</span>
</span><span id="__span-99-42"><a id="__codelineno-99-42" name="__codelineno-99-42" href="#__codelineno-99-42"></a><span class="gp">    # </span>This<span class="w"> </span>section<span class="w"> </span>is<span class="w"> </span>only<span class="w"> </span>required<span class="w"> </span><span class="k">if</span><span class="w"> </span>TLS<span class="w"> </span>is<span class="w"> </span>to<span class="w"> </span>be<span class="w"> </span>enabled<span class="w"> </span><span class="k">for</span><span class="w"> </span>the<span class="w"> </span>Ingress
</span><span id="__span-99-43"><a id="__codelineno-99-43" name="__codelineno-99-43" href="#__codelineno-99-43"></a><span class="go">    tls:</span>
</span><span id="__span-99-44"><a id="__codelineno-99-44" name="__codelineno-99-44" href="#__codelineno-99-44"></a><span class="go">      - hosts:</span>
</span><span id="__span-99-45"><a id="__codelineno-99-45" name="__codelineno-99-45" href="#__codelineno-99-45"></a><span class="go">        - www.example.com</span>
</span><span id="__span-99-46"><a id="__codelineno-99-46" name="__codelineno-99-46" href="#__codelineno-99-46"></a><span class="go">        secretName: example-tls</span>
</span><span id="__span-99-47"><a id="__codelineno-99-47" name="__codelineno-99-47" href="#__codelineno-99-47"></a>
</span><span id="__span-99-48"><a id="__codelineno-99-48" name="__codelineno-99-48" href="#__codelineno-99-48"></a><span class="go">If TLS is enabled for the Ingress, a Secret containing the certificate and key must also be provided:</span>
</span><span id="__span-99-49"><a id="__codelineno-99-49" name="__codelineno-99-49" href="#__codelineno-99-49"></a>
</span><span id="__span-99-50"><a id="__codelineno-99-50" name="__codelineno-99-50" href="#__codelineno-99-50"></a><span class="go">  apiVersion: v1</span>
</span><span id="__span-99-51"><a id="__codelineno-99-51" name="__codelineno-99-51" href="#__codelineno-99-51"></a><span class="go">  kind: Secret</span>
</span><span id="__span-99-52"><a id="__codelineno-99-52" name="__codelineno-99-52" href="#__codelineno-99-52"></a><span class="go">  metadata:</span>
</span><span id="__span-99-53"><a id="__codelineno-99-53" name="__codelineno-99-53" href="#__codelineno-99-53"></a><span class="go">    name: example-tls</span>
</span><span id="__span-99-54"><a id="__codelineno-99-54" name="__codelineno-99-54" href="#__codelineno-99-54"></a><span class="go">    namespace: foo</span>
</span><span id="__span-99-55"><a id="__codelineno-99-55" name="__codelineno-99-55" href="#__codelineno-99-55"></a><span class="go">  data:</span>
</span><span id="__span-99-56"><a id="__codelineno-99-56" name="__codelineno-99-56" href="#__codelineno-99-56"></a><span class="go">    tls.crt: &lt;base64 encoded cert&gt;</span>
</span><span id="__span-99-57"><a id="__codelineno-99-57" name="__codelineno-99-57" href="#__codelineno-99-57"></a><span class="go">    tls.key: &lt;base64 encoded key&gt;</span>
</span><span id="__span-99-58"><a id="__codelineno-99-58" name="__codelineno-99-58" href="#__codelineno-99-58"></a><span class="go">  type: kubernetes.io/tls</span>
</span></code></pre></div>
<p>The first virtual IP address is assigned to the <code>ingress-nginx-controller</code>
service and there is NGinx happily returning 404 Not found:</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-100-1"><a id="__codelineno-100-1" name="__codelineno-100-1" href="#__codelineno-100-1"></a><span class="gp">$ </span>kubectl<span class="w"> </span>get<span class="w"> </span>svc<span class="w"> </span>-n<span class="w"> </span>ingress-nginx
</span><span id="__span-100-2"><a id="__codelineno-100-2" name="__codelineno-100-2" href="#__codelineno-100-2"></a><span class="go">NAME                                 TYPE           CLUSTER-IP      EXTERNAL-IP     PORT(S)                      AGE</span>
</span><span id="__span-100-3"><a id="__codelineno-100-3" name="__codelineno-100-3" href="#__codelineno-100-3"></a><span class="go">ingress-nginx-controller             LoadBalancer   10.111.164.62   192.168.0.151   80:31235/TCP,443:32391/TCP   70s</span>
</span><span id="__span-100-4"><a id="__codelineno-100-4" name="__codelineno-100-4" href="#__codelineno-100-4"></a><span class="go">ingress-nginx-controller-admission   ClusterIP      10.100.225.28   &lt;none&gt;          443/TCP                      70s</span>
</span><span id="__span-100-5"><a id="__codelineno-100-5" name="__codelineno-100-5" href="#__codelineno-100-5"></a>
</span><span id="__span-100-6"><a id="__codelineno-100-6" name="__codelineno-100-6" href="#__codelineno-100-6"></a><span class="gp">$ </span>curl<span class="w"> </span>-k<span class="w"> </span>https://192.168.0.151/
</span><span id="__span-100-7"><a id="__codelineno-100-7" name="__codelineno-100-7" href="#__codelineno-100-7"></a><span class="go">&lt;html&gt;</span>
</span><span id="__span-100-8"><a id="__codelineno-100-8" name="__codelineno-100-8" href="#__codelineno-100-8"></a><span class="go">&lt;head&gt;&lt;title&gt;404 Not Found&lt;/title&gt;&lt;/head&gt;</span>
</span><span id="__span-100-9"><a id="__codelineno-100-9" name="__codelineno-100-9" href="#__codelineno-100-9"></a><span class="go">&lt;body&gt;</span>
</span><span id="__span-100-10"><a id="__codelineno-100-10" name="__codelineno-100-10" href="#__codelineno-100-10"></a><span class="go">&lt;center&gt;&lt;h1&gt;404 Not Found&lt;/h1&gt;&lt;/center&gt;</span>
</span><span id="__span-100-11"><a id="__codelineno-100-11" name="__codelineno-100-11" href="#__codelineno-100-11"></a><span class="go">&lt;hr&gt;&lt;center&gt;nginx&lt;/center&gt;</span>
</span><span id="__span-100-12"><a id="__codelineno-100-12" name="__codelineno-100-12" href="#__codelineno-100-12"></a><span class="go">&lt;/body&gt;</span>
</span><span id="__span-100-13"><a id="__codelineno-100-13" name="__codelineno-100-13" href="#__codelineno-100-13"></a><span class="go">&lt;/html&gt;</span>
</span></code></pre></div>
<h4 id="troubleshooting-ingress">Troubleshooting Ingress</h4>
<p>This is still not available from other hosts, connections to the <code>LoadBalancer</code>
IP address times out or is refused, on both ports.
<a href="https://stackoverflow.com/a/56053059">This Stack Overflow answer</a> suggests
the reason is likely to be that the pod itself is not accepting connections
from external hosts, but the Helm chart seems to default to accepting them:</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-101-1"><a id="__codelineno-101-1" name="__codelineno-101-1" href="#__codelineno-101-1"></a><span class="gp">$ </span>helm<span class="w"> </span>upgrade<span class="w"> </span><span class="se">\</span>
</span><span id="__span-101-2"><a id="__codelineno-101-2" name="__codelineno-101-2" href="#__codelineno-101-2"></a><span class="w">  </span>--install<span class="w"> </span>ingress-nginx<span class="w"> </span><span class="se">\</span>
</span><span id="__span-101-3"><a id="__codelineno-101-3" name="__codelineno-101-3" href="#__codelineno-101-3"></a><span class="w">  </span>ingress-nginx/ingress-nginx<span class="w"> </span><span class="se">\</span>
</span><span id="__span-101-4"><a id="__codelineno-101-4" name="__codelineno-101-4" href="#__codelineno-101-4"></a><span class="w">  </span>--create-namespace<span class="w"> </span><span class="se">\</span>
</span><span id="__span-101-5"><a id="__codelineno-101-5" name="__codelineno-101-5" href="#__codelineno-101-5"></a><span class="w">  </span>--namespace<span class="w"> </span>ingress-nginx<span class="w"> </span><span class="se">\</span>
</span><span id="__span-101-6"><a id="__codelineno-101-6" name="__codelineno-101-6" href="#__codelineno-101-6"></a><span class="w">  </span>--dry-run<span class="w"> </span>--debug
</span><span id="__span-101-7"><a id="__codelineno-101-7" name="__codelineno-101-7" href="#__codelineno-101-7"></a><span class="go">...</span>
</span><span id="__span-101-8"><a id="__codelineno-101-8" name="__codelineno-101-8" href="#__codelineno-101-8"></a><span class="go">  service:</span>
</span><span id="__span-101-9"><a id="__codelineno-101-9" name="__codelineno-101-9" href="#__codelineno-101-9"></a><span class="go">    annotations: {}</span>
</span><span id="__span-101-10"><a id="__codelineno-101-10" name="__codelineno-101-10" href="#__codelineno-101-10"></a><span class="go">    appProtocol: true</span>
</span><span id="__span-101-11"><a id="__codelineno-101-11" name="__codelineno-101-11" href="#__codelineno-101-11"></a><span class="go">    clusterIP: ""</span>
</span><span id="__span-101-12"><a id="__codelineno-101-12" name="__codelineno-101-12" href="#__codelineno-101-12"></a><span class="go">    enableHttp: true</span>
</span><span id="__span-101-13"><a id="__codelineno-101-13" name="__codelineno-101-13" href="#__codelineno-101-13"></a><span class="go">    enableHttps: true</span>
</span><span id="__span-101-14"><a id="__codelineno-101-14" name="__codelineno-101-14" href="#__codelineno-101-14"></a><span class="go">    enabled: true</span>
</span><span id="__span-101-15"><a id="__codelineno-101-15" name="__codelineno-101-15" href="#__codelineno-101-15"></a><span class="go">    external:</span>
</span><span id="__span-101-16"><a id="__codelineno-101-16" name="__codelineno-101-16" href="#__codelineno-101-16"></a><span class="go">      enabled: true</span>
</span><span id="__span-101-17"><a id="__codelineno-101-17" name="__codelineno-101-17" href="#__codelineno-101-17"></a><span class="go">    type: LoadBalancer</span>
</span></code></pre></div>
<p>Lets try uninstalling the Helm chart and installing instead the
<a href="https://kubernetes.github.io/ingress-nginx/deploy/#bare-metal-clusters">deployment for bare metal clusters</a>:</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-102-1"><a id="__codelineno-102-1" name="__codelineno-102-1" href="#__codelineno-102-1"></a><span class="gp">$ </span>helm<span class="w"> </span>uninstall<span class="w"> </span>ingress-nginx<span class="w"> </span><span class="se">\</span>
</span><span id="__span-102-2"><a id="__codelineno-102-2" name="__codelineno-102-2" href="#__codelineno-102-2"></a><span class="w">  </span>--namespace<span class="w"> </span>ingress-nginx<span class="w">   </span>
</span><span id="__span-102-3"><a id="__codelineno-102-3" name="__codelineno-102-3" href="#__codelineno-102-3"></a><span class="go">release "ingress-nginx" uninstalled</span>
</span><span id="__span-102-4"><a id="__codelineno-102-4" name="__codelineno-102-4" href="#__codelineno-102-4"></a>
</span><span id="__span-102-5"><a id="__codelineno-102-5" name="__codelineno-102-5" href="#__codelineno-102-5"></a><span class="gp">$ </span>kubectl<span class="w"> </span>get<span class="w"> </span>all<span class="w"> </span>-n<span class="w"> </span>ingress-nginx
</span><span id="__span-102-6"><a id="__codelineno-102-6" name="__codelineno-102-6" href="#__codelineno-102-6"></a><span class="go">NAME                                           READY   STATUS        RESTARTS       AGE</span>
</span><span id="__span-102-7"><a id="__codelineno-102-7" name="__codelineno-102-7" href="#__codelineno-102-7"></a><span class="go">pod/ingress-nginx-controller-cd9d6bbd7-c4cbp   1/1     Terminating   1 (167m ago)   5d20h</span>
</span><span id="__span-102-8"><a id="__codelineno-102-8" name="__codelineno-102-8" href="#__codelineno-102-8"></a>
</span><span id="__span-102-9"><a id="__codelineno-102-9" name="__codelineno-102-9" href="#__codelineno-102-9"></a><span class="gp">$ </span>kubectl<span class="w"> </span>delete<span class="w"> </span>namespace<span class="w"> </span>ingress-nginx
</span><span id="__span-102-10"><a id="__codelineno-102-10" name="__codelineno-102-10" href="#__codelineno-102-10"></a><span class="go">namespace "ingress-nginx" deleted</span>
</span></code></pre></div>
<div class="language-console highlight"><pre><span></span><code><span id="__span-103-1"><a id="__codelineno-103-1" name="__codelineno-103-1" href="#__codelineno-103-1"></a><span class="gp">$ </span>wget<span class="w"> </span>-O<span class="w"> </span>nginx-baremetal.yaml<span class="w"> </span><span class="se">\</span>
</span><span id="__span-103-2"><a id="__codelineno-103-2" name="__codelineno-103-2" href="#__codelineno-103-2"></a><span class="w">  </span>https://raw.githubusercontent.com/kubernetes/ingress-nginx/controller-v1.12.0/deploy/static/provider/baremetal/deploy.yaml
</span><span id="__span-103-3"><a id="__codelineno-103-3" name="__codelineno-103-3" href="#__codelineno-103-3"></a>
</span><span id="__span-103-4"><a id="__codelineno-103-4" name="__codelineno-103-4" href="#__codelineno-103-4"></a><span class="gp">$ </span>kubectl<span class="w"> </span>apply<span class="w"> </span>-f<span class="w"> </span>nginx-baremetal.yaml
</span><span id="__span-103-5"><a id="__codelineno-103-5" name="__codelineno-103-5" href="#__codelineno-103-5"></a><span class="go">namespace/ingress-nginx created</span>
</span><span id="__span-103-6"><a id="__codelineno-103-6" name="__codelineno-103-6" href="#__codelineno-103-6"></a><span class="go">serviceaccount/ingress-nginx created</span>
</span><span id="__span-103-7"><a id="__codelineno-103-7" name="__codelineno-103-7" href="#__codelineno-103-7"></a><span class="go">serviceaccount/ingress-nginx-admission created</span>
</span><span id="__span-103-8"><a id="__codelineno-103-8" name="__codelineno-103-8" href="#__codelineno-103-8"></a><span class="go">role.rbac.authorization.k8s.io/ingress-nginx created</span>
</span><span id="__span-103-9"><a id="__codelineno-103-9" name="__codelineno-103-9" href="#__codelineno-103-9"></a><span class="go">role.rbac.authorization.k8s.io/ingress-nginx-admission created</span>
</span><span id="__span-103-10"><a id="__codelineno-103-10" name="__codelineno-103-10" href="#__codelineno-103-10"></a><span class="go">clusterrole.rbac.authorization.k8s.io/ingress-nginx created</span>
</span><span id="__span-103-11"><a id="__codelineno-103-11" name="__codelineno-103-11" href="#__codelineno-103-11"></a><span class="go">clusterrole.rbac.authorization.k8s.io/ingress-nginx-admission created</span>
</span><span id="__span-103-12"><a id="__codelineno-103-12" name="__codelineno-103-12" href="#__codelineno-103-12"></a><span class="go">rolebinding.rbac.authorization.k8s.io/ingress-nginx created</span>
</span><span id="__span-103-13"><a id="__codelineno-103-13" name="__codelineno-103-13" href="#__codelineno-103-13"></a><span class="go">rolebinding.rbac.authorization.k8s.io/ingress-nginx-admission created</span>
</span><span id="__span-103-14"><a id="__codelineno-103-14" name="__codelineno-103-14" href="#__codelineno-103-14"></a><span class="go">clusterrolebinding.rbac.authorization.k8s.io/ingress-nginx created</span>
</span><span id="__span-103-15"><a id="__codelineno-103-15" name="__codelineno-103-15" href="#__codelineno-103-15"></a><span class="go">clusterrolebinding.rbac.authorization.k8s.io/ingress-nginx-admission created</span>
</span><span id="__span-103-16"><a id="__codelineno-103-16" name="__codelineno-103-16" href="#__codelineno-103-16"></a><span class="go">configmap/ingress-nginx-controller created</span>
</span><span id="__span-103-17"><a id="__codelineno-103-17" name="__codelineno-103-17" href="#__codelineno-103-17"></a><span class="go">service/ingress-nginx-controller created</span>
</span><span id="__span-103-18"><a id="__codelineno-103-18" name="__codelineno-103-18" href="#__codelineno-103-18"></a><span class="go">service/ingress-nginx-controller-admission created</span>
</span><span id="__span-103-19"><a id="__codelineno-103-19" name="__codelineno-103-19" href="#__codelineno-103-19"></a><span class="go">deployment.apps/ingress-nginx-controller created</span>
</span><span id="__span-103-20"><a id="__codelineno-103-20" name="__codelineno-103-20" href="#__codelineno-103-20"></a><span class="go">job.batch/ingress-nginx-admission-create created</span>
</span><span id="__span-103-21"><a id="__codelineno-103-21" name="__codelineno-103-21" href="#__codelineno-103-21"></a><span class="go">job.batch/ingress-nginx-admission-patch created</span>
</span><span id="__span-103-22"><a id="__codelineno-103-22" name="__codelineno-103-22" href="#__codelineno-103-22"></a><span class="go">ingressclass.networking.k8s.io/nginx created</span>
</span><span id="__span-103-23"><a id="__codelineno-103-23" name="__codelineno-103-23" href="#__codelineno-103-23"></a><span class="go">validatingwebhookconfiguration.admissionregistration.k8s.io/ingress-nginx-admission created</span>
</span><span id="__span-103-24"><a id="__codelineno-103-24" name="__codelineno-103-24" href="#__codelineno-103-24"></a>
</span><span id="__span-103-25"><a id="__codelineno-103-25" name="__codelineno-103-25" href="#__codelineno-103-25"></a><span class="gp">$ </span>kubectl<span class="w"> </span>get<span class="w"> </span>all<span class="w"> </span>-n<span class="w"> </span>ingress-nginx
</span><span id="__span-103-26"><a id="__codelineno-103-26" name="__codelineno-103-26" href="#__codelineno-103-26"></a><span class="go">NAME                                            READY   STATUS      RESTARTS   AGE</span>
</span><span id="__span-103-27"><a id="__codelineno-103-27" name="__codelineno-103-27" href="#__codelineno-103-27"></a><span class="go">pod/ingress-nginx-admission-create-55p4r        0/1     Completed   0          37s</span>
</span><span id="__span-103-28"><a id="__codelineno-103-28" name="__codelineno-103-28" href="#__codelineno-103-28"></a><span class="go">pod/ingress-nginx-admission-patch-fhhgq         0/1     Completed   1          37s</span>
</span><span id="__span-103-29"><a id="__codelineno-103-29" name="__codelineno-103-29" href="#__codelineno-103-29"></a><span class="go">pod/ingress-nginx-controller-6d59d95796-5lggl   1/1     Running     0          37s</span>
</span><span id="__span-103-30"><a id="__codelineno-103-30" name="__codelineno-103-30" href="#__codelineno-103-30"></a>
</span><span id="__span-103-31"><a id="__codelineno-103-31" name="__codelineno-103-31" href="#__codelineno-103-31"></a><span class="go">NAME                                         TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)                      AGE</span>
</span><span id="__span-103-32"><a id="__codelineno-103-32" name="__codelineno-103-32" href="#__codelineno-103-32"></a><span class="go">service/ingress-nginx-controller             NodePort    10.110.176.19   &lt;none&gt;        80:31438/TCP,443:32035/TCP   37s</span>
</span><span id="__span-103-33"><a id="__codelineno-103-33" name="__codelineno-103-33" href="#__codelineno-103-33"></a><span class="go">service/ingress-nginx-controller-admission   ClusterIP   10.103.89.225   &lt;none&gt;        443/TCP                      37s</span>
</span><span id="__span-103-34"><a id="__codelineno-103-34" name="__codelineno-103-34" href="#__codelineno-103-34"></a>
</span><span id="__span-103-35"><a id="__codelineno-103-35" name="__codelineno-103-35" href="#__codelineno-103-35"></a><span class="go">NAME                                       READY   UP-TO-DATE   AVAILABLE   AGE</span>
</span><span id="__span-103-36"><a id="__codelineno-103-36" name="__codelineno-103-36" href="#__codelineno-103-36"></a><span class="go">deployment.apps/ingress-nginx-controller   1/1     1            1           37s</span>
</span><span id="__span-103-37"><a id="__codelineno-103-37" name="__codelineno-103-37" href="#__codelineno-103-37"></a>
</span><span id="__span-103-38"><a id="__codelineno-103-38" name="__codelineno-103-38" href="#__codelineno-103-38"></a><span class="go">NAME                                                  DESIRED   CURRENT   READY   AGE</span>
</span><span id="__span-103-39"><a id="__codelineno-103-39" name="__codelineno-103-39" href="#__codelineno-103-39"></a><span class="go">replicaset.apps/ingress-nginx-controller-6d59d95796   1         1         1       37s</span>
</span><span id="__span-103-40"><a id="__codelineno-103-40" name="__codelineno-103-40" href="#__codelineno-103-40"></a>
</span><span id="__span-103-41"><a id="__codelineno-103-41" name="__codelineno-103-41" href="#__codelineno-103-41"></a><span class="go">NAME                                       STATUS     COMPLETIONS   DURATION   AGE</span>
</span><span id="__span-103-42"><a id="__codelineno-103-42" name="__codelineno-103-42" href="#__codelineno-103-42"></a><span class="go">job.batch/ingress-nginx-admission-create   Complete   1/1           3s         37s</span>
</span><span id="__span-103-43"><a id="__codelineno-103-43" name="__codelineno-103-43" href="#__codelineno-103-43"></a><span class="go">job.batch/ingress-nginx-admission-patch    Complete   1/1           4s         37s</span>
</span></code></pre></div>
<p>Finally, at least those <code>NodePort</code> are reachable from other hosts:</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-104-1"><a id="__codelineno-104-1" name="__codelineno-104-1" href="#__codelineno-104-1"></a>$ curl http://192.168.0.124:31438/
</span><span id="__span-104-2"><a id="__codelineno-104-2" name="__codelineno-104-2" href="#__codelineno-104-2"></a>&lt;html&gt;
</span><span id="__span-104-3"><a id="__codelineno-104-3" name="__codelineno-104-3" href="#__codelineno-104-3"></a>&lt;head&gt;&lt;title&gt;404 Not Found&lt;/title&gt;&lt;/head&gt;
</span><span id="__span-104-4"><a id="__codelineno-104-4" name="__codelineno-104-4" href="#__codelineno-104-4"></a>&lt;body&gt;
</span><span id="__span-104-5"><a id="__codelineno-104-5" name="__codelineno-104-5" href="#__codelineno-104-5"></a>&lt;center&gt;&lt;h1&gt;404 Not Found&lt;/h1&gt;&lt;/center&gt;
</span><span id="__span-104-6"><a id="__codelineno-104-6" name="__codelineno-104-6" href="#__codelineno-104-6"></a>&lt;hr&gt;&lt;center&gt;nginx&lt;/center&gt;
</span><span id="__span-104-7"><a id="__codelineno-104-7" name="__codelineno-104-7" href="#__codelineno-104-7"></a>&lt;/body&gt;
</span><span id="__span-104-8"><a id="__codelineno-104-8" name="__codelineno-104-8" href="#__codelineno-104-8"></a>&lt;/html&gt;
</span><span id="__span-104-9"><a id="__codelineno-104-9" name="__codelineno-104-9" href="#__codelineno-104-9"></a>
</span><span id="__span-104-10"><a id="__codelineno-104-10" name="__codelineno-104-10" href="#__codelineno-104-10"></a>$ curl -k https://192.168.0.124:32035/
</span><span id="__span-104-11"><a id="__codelineno-104-11" name="__codelineno-104-11" href="#__codelineno-104-11"></a>&lt;html&gt;
</span><span id="__span-104-12"><a id="__codelineno-104-12" name="__codelineno-104-12" href="#__codelineno-104-12"></a>&lt;head&gt;&lt;title&gt;404 Not Found&lt;/title&gt;&lt;/head&gt;
</span><span id="__span-104-13"><a id="__codelineno-104-13" name="__codelineno-104-13" href="#__codelineno-104-13"></a>&lt;body&gt;
</span><span id="__span-104-14"><a id="__codelineno-104-14" name="__codelineno-104-14" href="#__codelineno-104-14"></a>&lt;center&gt;&lt;h1&gt;404 Not Found&lt;/h1&gt;&lt;/center&gt;
</span><span id="__span-104-15"><a id="__codelineno-104-15" name="__codelineno-104-15" href="#__codelineno-104-15"></a>&lt;hr&gt;&lt;center&gt;nginx&lt;/center&gt;
</span><span id="__span-104-16"><a id="__codelineno-104-16" name="__codelineno-104-16" href="#__codelineno-104-16"></a>&lt;/body&gt;
</span><span id="__span-104-17"><a id="__codelineno-104-17" name="__codelineno-104-17" href="#__codelineno-104-17"></a>&lt;/html&gt;
</span></code></pre></div>
<p>But still, switching the <code>ingress-nginx-controller</code> services back to
<code>LoadBalancer</code> makes the service unreachable; even when connecting to the
Ethernet network, in case the problem would be related to
<a href="https://github.com/kubernetes/kubernetes/issues/70222#issuecomment-1912699834">which NIC Flannel is using</a>,
but neither the cable nor adding <code>--iface=wlan0</code> to the <code>args</code> for <code>flanneld</code>
in <code>kube-flannel.yml</code> made any difference.</p>
<p>Morever, the assigned <code>LoadBalancer</code> IP address does not respond to <code>ping</code> and
there is no ARP resolution for it after trying:</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-105-1"><a id="__codelineno-105-1" name="__codelineno-105-1" href="#__codelineno-105-1"></a><span class="gp">$ </span>ping<span class="w"> </span><span class="m">192</span>.168.0.151<span class="w"> </span>-c<span class="w"> </span><span class="m">1</span>
</span><span id="__span-105-2"><a id="__codelineno-105-2" name="__codelineno-105-2" href="#__codelineno-105-2"></a><span class="go">PING 192.168.0.151 (192.168.0.151) 56(84) bytes of data.</span>
</span><span id="__span-105-3"><a id="__codelineno-105-3" name="__codelineno-105-3" href="#__codelineno-105-3"></a><span class="go">From 192.168.0.2 icmp_seq=1 Destination Host Unreachable</span>
</span><span id="__span-105-4"><a id="__codelineno-105-4" name="__codelineno-105-4" href="#__codelineno-105-4"></a>
</span><span id="__span-105-5"><a id="__codelineno-105-5" name="__codelineno-105-5" href="#__codelineno-105-5"></a><span class="go">--- 192.168.0.151 ping statistics ---</span>
</span><span id="__span-105-6"><a id="__codelineno-105-6" name="__codelineno-105-6" href="#__codelineno-105-6"></a><span class="go">1 packets transmitted, 0 received, +1 errors, 100% packet loss, time 0ms</span>
</span><span id="__span-105-7"><a id="__codelineno-105-7" name="__codelineno-105-7" href="#__codelineno-105-7"></a>
</span><span id="__span-105-8"><a id="__codelineno-105-8" name="__codelineno-105-8" href="#__codelineno-105-8"></a><span class="gp">$ </span>ping<span class="w"> </span><span class="m">192</span>.168.0.121<span class="w"> </span>-c<span class="w"> </span><span class="m">1</span>
</span><span id="__span-105-9"><a id="__codelineno-105-9" name="__codelineno-105-9" href="#__codelineno-105-9"></a><span class="go">PING 192.168.0.121 (192.168.0.121) 56(84) bytes of data.</span>
</span><span id="__span-105-10"><a id="__codelineno-105-10" name="__codelineno-105-10" href="#__codelineno-105-10"></a><span class="go">64 bytes from 192.168.0.121: icmp_seq=1 ttl=64 time=0.183 ms</span>
</span><span id="__span-105-11"><a id="__codelineno-105-11" name="__codelineno-105-11" href="#__codelineno-105-11"></a>
</span><span id="__span-105-12"><a id="__codelineno-105-12" name="__codelineno-105-12" href="#__codelineno-105-12"></a><span class="go">--- 192.168.0.121 ping statistics ---</span>
</span><span id="__span-105-13"><a id="__codelineno-105-13" name="__codelineno-105-13" href="#__codelineno-105-13"></a><span class="go">1 packets transmitted, 1 received, 0% packet loss, time 0ms</span>
</span><span id="__span-105-14"><a id="__codelineno-105-14" name="__codelineno-105-14" href="#__codelineno-105-14"></a><span class="go">rtt min/avg/max/mdev = 0.183/0.183/0.183/0.000 ms</span>
</span><span id="__span-105-15"><a id="__codelineno-105-15" name="__codelineno-105-15" href="#__codelineno-105-15"></a>
</span><span id="__span-105-16"><a id="__codelineno-105-16" name="__codelineno-105-16" href="#__codelineno-105-16"></a><span class="gp">$ </span>ping<span class="w"> </span><span class="m">192</span>.168.0.124<span class="w"> </span>-c<span class="w"> </span><span class="m">1</span>
</span><span id="__span-105-17"><a id="__codelineno-105-17" name="__codelineno-105-17" href="#__codelineno-105-17"></a><span class="go">PING 192.168.0.124 (192.168.0.124) 56(84) bytes of data.</span>
</span><span id="__span-105-18"><a id="__codelineno-105-18" name="__codelineno-105-18" href="#__codelineno-105-18"></a><span class="go">64 bytes from 192.168.0.124: icmp_seq=1 ttl=64 time=92.9 ms</span>
</span><span id="__span-105-19"><a id="__codelineno-105-19" name="__codelineno-105-19" href="#__codelineno-105-19"></a>
</span><span id="__span-105-20"><a id="__codelineno-105-20" name="__codelineno-105-20" href="#__codelineno-105-20"></a><span class="go">--- 192.168.0.124 ping statistics ---</span>
</span><span id="__span-105-21"><a id="__codelineno-105-21" name="__codelineno-105-21" href="#__codelineno-105-21"></a><span class="go">1 packets transmitted, 1 received, 0% packet loss, time 0ms</span>
</span><span id="__span-105-22"><a id="__codelineno-105-22" name="__codelineno-105-22" href="#__codelineno-105-22"></a><span class="go">rtt min/avg/max/mdev = 92.896/92.896/92.896/0.000 ms</span>
</span><span id="__span-105-23"><a id="__codelineno-105-23" name="__codelineno-105-23" href="#__codelineno-105-23"></a>
</span><span id="__span-105-24"><a id="__codelineno-105-24" name="__codelineno-105-24" href="#__codelineno-105-24"></a><span class="gp">$ </span>nc<span class="w"> </span>-v<span class="w"> </span><span class="m">192</span>.168.0.151<span class="w"> </span><span class="m">80</span>
</span><span id="__span-105-25"><a id="__codelineno-105-25" name="__codelineno-105-25" href="#__codelineno-105-25"></a><span class="go">nc: connect to 192.168.0.151 port 80 (tcp) failed: No route to host</span>
</span><span id="__span-105-26"><a id="__codelineno-105-26" name="__codelineno-105-26" href="#__codelineno-105-26"></a>
</span><span id="__span-105-27"><a id="__codelineno-105-27" name="__codelineno-105-27" href="#__codelineno-105-27"></a><span class="gp">$ </span>nc<span class="w"> </span>-v<span class="w"> </span><span class="m">192</span>.168.0.151<span class="w"> </span><span class="m">443</span>
</span><span id="__span-105-28"><a id="__codelineno-105-28" name="__codelineno-105-28" href="#__codelineno-105-28"></a><span class="go">nc: connect to 192.168.0.151 port 443 (tcp) failed: No route to host</span>
</span><span id="__span-105-29"><a id="__codelineno-105-29" name="__codelineno-105-29" href="#__codelineno-105-29"></a>
</span><span id="__span-105-30"><a id="__codelineno-105-30" name="__codelineno-105-30" href="#__codelineno-105-30"></a><span class="gp">$ </span>arp<span class="w"> </span>-a
</span><span id="__span-105-31"><a id="__codelineno-105-31" name="__codelineno-105-31" href="#__codelineno-105-31"></a><span class="go">? (192.168.0.121) at 2c:cf:67:83:6f:3b [ether] on enp5s0</span>
</span><span id="__span-105-32"><a id="__codelineno-105-32" name="__codelineno-105-32" href="#__codelineno-105-32"></a><span class="go">alfred (192.168.0.124) at 2c:cf:67:83:6f:3c [ether] on enp5s0</span>
</span><span id="__span-105-33"><a id="__codelineno-105-33" name="__codelineno-105-33" href="#__codelineno-105-33"></a><span class="go">? (192.168.0.151) at &lt;incomplete&gt; on enp5s0</span>
</span></code></pre></div>
<p><a href="https://stackoverflow.com/a/73307679">The LoadbalancerIP or the External SVC IP will never be pingable</a>
suggest this last test may have been futile, but either way neither <code>ping</code> nor
<code>nc</code> nor <code>tcptraceroute</code> nor <code>mtr</code> can connect to HTTP/S ports on that IP.</p>
<h4 id="fix-metallb-speaker">Fix MetalLB Speaker</h4>
<p>The problem turned out to be that
<a href="https://metallb.universe.tf/troubleshooting/#metallb-is-not-advertising-my-service-from-my-control-plane-nodes-or-from-my-single-node-cluster">MetalLB is not advertising my service from my control-plane nodes or from my single node cluster</a>
and the solutions are to either remove the node label, or make MetalLB circumvent it.</p>
<p>This label is present by default in control panel nodes, so it is found here now:</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-106-1"><a id="__codelineno-106-1" name="__codelineno-106-1" href="#__codelineno-106-1"></a><span class="gp">$ </span>kubectl<span class="w"> </span>describe<span class="w"> </span>node<span class="w"> </span>alfred<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>exclude
</span><span id="__span-106-2"><a id="__codelineno-106-2" name="__codelineno-106-2" href="#__codelineno-106-2"></a><span class="go">                    node.kubernetes.io/exclude-from-external-load-balancers=</span>
</span></code></pre></div>
<p>While this label is in effect, MetalLB virtual IPs are not found even by <code>arping</code>:</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-107-1"><a id="__codelineno-107-1" name="__codelineno-107-1" href="#__codelineno-107-1"></a><span class="gp"># </span>arping<span class="w"> </span><span class="m">192</span>.168.0.124
</span><span id="__span-107-2"><a id="__codelineno-107-2" name="__codelineno-107-2" href="#__codelineno-107-2"></a><span class="go">ARPING 192.168.0.124</span>
</span><span id="__span-107-3"><a id="__codelineno-107-3" name="__codelineno-107-3" href="#__codelineno-107-3"></a><span class="go">60 bytes from 2c:cf:67:83:6f:3b (192.168.0.124): index=0 time=161.545 usec</span>
</span><span id="__span-107-4"><a id="__codelineno-107-4" name="__codelineno-107-4" href="#__codelineno-107-4"></a><span class="go">60 bytes from 2c:cf:67:83:6f:3c (192.168.0.124): index=1 time=176.240 msec</span>
</span><span id="__span-107-5"><a id="__codelineno-107-5" name="__codelineno-107-5" href="#__codelineno-107-5"></a><span class="go">60 bytes from 2c:cf:67:83:6f:3c (192.168.0.124): index=2 time=177.685 msec</span>
</span><span id="__span-107-6"><a id="__codelineno-107-6" name="__codelineno-107-6" href="#__codelineno-107-6"></a><span class="go">60 bytes from 2c:cf:67:83:6f:3b (192.168.0.124): index=3 time=153.981 usec</span>
</span><span id="__span-107-7"><a id="__codelineno-107-7" name="__codelineno-107-7" href="#__codelineno-107-7"></a><span class="go">^C</span>
</span><span id="__span-107-8"><a id="__codelineno-107-8" name="__codelineno-107-8" href="#__codelineno-107-8"></a><span class="go">--- 192.168.0.124 statistics ---</span>
</span><span id="__span-107-9"><a id="__codelineno-107-9" name="__codelineno-107-9" href="#__codelineno-107-9"></a><span class="go">2 packets transmitted, 4 packets received,   0% unanswered (2 extra)</span>
</span><span id="__span-107-10"><a id="__codelineno-107-10" name="__codelineno-107-10" href="#__codelineno-107-10"></a><span class="go">rtt min/avg/max/std-dev = 0.154/88.560/177.685/88.404 ms</span>
</span><span id="__span-107-11"><a id="__codelineno-107-11" name="__codelineno-107-11" href="#__codelineno-107-11"></a>
</span><span id="__span-107-12"><a id="__codelineno-107-12" name="__codelineno-107-12" href="#__codelineno-107-12"></a><span class="gp"># </span>arping<span class="w"> </span><span class="m">192</span>.168.0.151
</span><span id="__span-107-13"><a id="__codelineno-107-13" name="__codelineno-107-13" href="#__codelineno-107-13"></a><span class="go">ARPING 192.168.0.151</span>
</span><span id="__span-107-14"><a id="__codelineno-107-14" name="__codelineno-107-14" href="#__codelineno-107-14"></a><span class="go">Timeout</span>
</span><span id="__span-107-15"><a id="__codelineno-107-15" name="__codelineno-107-15" href="#__codelineno-107-15"></a><span class="go">Timeout</span>
</span><span id="__span-107-16"><a id="__codelineno-107-16" name="__codelineno-107-16" href="#__codelineno-107-16"></a><span class="go">^C</span>
</span><span id="__span-107-17"><a id="__codelineno-107-17" name="__codelineno-107-17" href="#__codelineno-107-17"></a><span class="go">--- 192.168.0.151 statistics ---</span>
</span><span id="__span-107-18"><a id="__codelineno-107-18" name="__codelineno-107-18" href="#__codelineno-107-18"></a><span class="go">3 packets transmitted, 0 packets received, 100% unanswered (0 extra)</span>
</span></code></pre></div>
<p>IP address <code>.124</code> is the node's (non-virtual) address, <code>.154</code> is a <code>LoalBalancder</code>
virtual address issued by MetalLB. </p>
<h5 id="remove-node-label-nodekubernetesioexclude-from-external-load-balancers">Remove node label <code>node.kubernetes.io/exclude-from-external-load-balancers</code></h5>
<p>The recommended solution is to <em>make sure your nodes are not labeled with the</em>
<a href="https://kubernetes.io/docs/reference/labels-annotations-taints/#node-kubernetes-io-exclude-from-external-load-balancers"><em><code>node.kubernetes.io/exclude-from-external-load-balancers</code></em></a>
<em>label</em>. This means <strong>removing</strong> the label (setting the label explicitly to <code>false</code>
is not enough):</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-108-1"><a id="__codelineno-108-1" name="__codelineno-108-1" href="#__codelineno-108-1"></a><span class="gp">$ </span>kubectl<span class="w"> </span>label<span class="w"> </span>nodes<span class="w"> </span>alfred<span class="w"> </span><span class="se">\</span>
</span><span id="__span-108-2"><a id="__codelineno-108-2" name="__codelineno-108-2" href="#__codelineno-108-2"></a><span class="w">  </span>node.kubernetes.io/exclude-from-external-load-balancers-
</span><span id="__span-108-3"><a id="__codelineno-108-3" name="__codelineno-108-3" href="#__codelineno-108-3"></a><span class="go">node/alfred unlabeled</span>
</span></code></pre></div>
<h5 id="make-metallb-circumvent-the-node-label">Make MetalLB circumvent the node label</h5>
<p>An alternative method is provided in the troubleshooting guide as well: <em>one way to
circumvent the issue is to provide the speakers with the <code>--ignore-exclude-lb</code></em>.
In this case, the flag can be added under the <code>args</code> for the Speaker's <code>DaemonSet</code> in
the manifest:</p>
<div class="language-yaml highlight"><table class="highlighttable"><tbody><tr><th colspan="2" class="filename"><span class="filename">metallb/metallb-native.yaml</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-109-1759">1759</a></span>
<span class="normal"><a href="#__codelineno-109-1760">1760</a></span>
<span class="normal"><a href="#__codelineno-109-1761">1761</a></span>
<span class="normal"><a href="#__codelineno-109-1762">1762</a></span>
<span class="normal"><a href="#__codelineno-109-1763">1763</a></span>
<span class="normal"><a href="#__codelineno-109-1764">1764</a></span>
<span class="normal"><a href="#__codelineno-109-1765">1765</a></span>
<span class="normal"><a href="#__codelineno-109-1766">1766</a></span>
<span class="normal"><a href="#__codelineno-109-1767">1767</a></span>
<span class="normal"><a href="#__codelineno-109-1768">1768</a></span>
<span class="normal"><a href="#__codelineno-109-1769">1769</a></span>
<span class="normal"><a href="#__codelineno-109-1770">1770</a></span>
<span class="normal"><a href="#__codelineno-109-1771">1771</a></span>
<span class="normal"><a href="#__codelineno-109-1772">1772</a></span>
<span class="normal"><a href="#__codelineno-109-1773">1773</a></span>
<span class="normal"><a href="#__codelineno-109-1774">1774</a></span>
<span class="normal"><a href="#__codelineno-109-1775">1775</a></span>
<span class="normal"><a href="#__codelineno-109-1776">1776</a></span>
<span class="normal"><a href="#__codelineno-109-1777">1777</a></span>
<span class="normal"><a href="#__codelineno-109-1778">1778</a></span>
<span class="normal"><a href="#__codelineno-109-1779">1779</a></span>
<span class="normal"><a href="#__codelineno-109-1780">1780</a></span>
<span class="normal"><a href="#__codelineno-109-1781">1781</a></span>
<span class="normal"><a href="#__codelineno-109-1782">1782</a></span>
<span class="normal"><a href="#__codelineno-109-1783">1783</a></span>
<span class="normal"><a href="#__codelineno-109-1784">1784</a></span>
<span class="normal"><a href="#__codelineno-109-1785">1785</a></span>
<span class="normal"><a href="#__codelineno-109-1786">1786</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-109-1759"><a id="__codelineno-109-1759" name="__codelineno-109-1759"></a><span class="nn">---</span>
</span><span id="__span-109-1760"><a id="__codelineno-109-1760" name="__codelineno-109-1760"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">apps/v1</span>
</span><span id="__span-109-1761"><a id="__codelineno-109-1761" name="__codelineno-109-1761"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">DaemonSet</span>
</span><span id="__span-109-1762"><a id="__codelineno-109-1762" name="__codelineno-109-1762"></a><span class="nt">metadata</span><span class="p">:</span>
</span><span id="__span-109-1763"><a id="__codelineno-109-1763" name="__codelineno-109-1763"></a><span class="w">  </span><span class="nt">labels</span><span class="p">:</span>
</span><span id="__span-109-1764"><a id="__codelineno-109-1764" name="__codelineno-109-1764"></a><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">metallb</span>
</span><span id="__span-109-1765"><a id="__codelineno-109-1765" name="__codelineno-109-1765"></a><span class="w">    </span><span class="nt">component</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">speaker</span>
</span><span id="__span-109-1766"><a id="__codelineno-109-1766" name="__codelineno-109-1766"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">speaker</span>
</span><span id="__span-109-1767"><a id="__codelineno-109-1767" name="__codelineno-109-1767"></a><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">metallb-system</span>
</span><span id="__span-109-1768"><a id="__codelineno-109-1768" name="__codelineno-109-1768"></a><span class="nt">spec</span><span class="p">:</span>
</span><span id="__span-109-1769"><a id="__codelineno-109-1769" name="__codelineno-109-1769"></a><span class="w">  </span><span class="nt">selector</span><span class="p">:</span>
</span><span id="__span-109-1770"><a id="__codelineno-109-1770" name="__codelineno-109-1770"></a><span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span>
</span><span id="__span-109-1771"><a id="__codelineno-109-1771" name="__codelineno-109-1771"></a><span class="w">      </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">metallb</span>
</span><span id="__span-109-1772"><a id="__codelineno-109-1772" name="__codelineno-109-1772"></a><span class="w">      </span><span class="nt">component</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">speaker</span>
</span><span id="__span-109-1773"><a id="__codelineno-109-1773" name="__codelineno-109-1773"></a><span class="w">  </span><span class="nt">template</span><span class="p">:</span>
</span><span id="__span-109-1774"><a id="__codelineno-109-1774" name="__codelineno-109-1774"></a><span class="w">    </span><span class="nt">metadata</span><span class="p">:</span>
</span><span id="__span-109-1775"><a id="__codelineno-109-1775" name="__codelineno-109-1775"></a><span class="w">      </span><span class="nt">annotations</span><span class="p">:</span>
</span><span id="__span-109-1776"><a id="__codelineno-109-1776" name="__codelineno-109-1776"></a><span class="w">        </span><span class="nt">prometheus.io/port</span><span class="p">:</span><span class="w"> </span><span class="s">"7472"</span>
</span><span id="__span-109-1777"><a id="__codelineno-109-1777" name="__codelineno-109-1777"></a><span class="w">        </span><span class="nt">prometheus.io/scrape</span><span class="p">:</span><span class="w"> </span><span class="s">"true"</span>
</span><span id="__span-109-1778"><a id="__codelineno-109-1778" name="__codelineno-109-1778"></a><span class="w">      </span><span class="nt">labels</span><span class="p">:</span>
</span><span id="__span-109-1779"><a id="__codelineno-109-1779" name="__codelineno-109-1779"></a><span class="w">        </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">metallb</span>
</span><span id="__span-109-1780"><a id="__codelineno-109-1780" name="__codelineno-109-1780"></a><span class="w">        </span><span class="nt">component</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">speaker</span>
</span><span id="__span-109-1781"><a id="__codelineno-109-1781" name="__codelineno-109-1781"></a><span class="w">    </span><span class="nt">spec</span><span class="p">:</span>
</span><span id="__span-109-1782"><a id="__codelineno-109-1782" name="__codelineno-109-1782"></a><span class="w">      </span><span class="nt">containers</span><span class="p">:</span>
</span><span id="__span-109-1783"><a id="__codelineno-109-1783" name="__codelineno-109-1783"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">args</span><span class="p">:</span>
</span><span id="__span-109-1784"><a id="__codelineno-109-1784" name="__codelineno-109-1784"></a><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">--port=7472</span>
</span><span id="__span-109-1785"><a id="__codelineno-109-1785" name="__codelineno-109-1785"></a><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">--log-level=info</span>
</span><span id="__span-109-1786"><a id="__codelineno-109-1786" name="__codelineno-109-1786"></a><span class="hll"><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">--ignore-exclude-lb=true</span>
</span></span></code></pre></div></td></tr></tbody></table></div>
<p>After applying <strong>either</strong> of the above changes, and reverting the
<a href="#ingress-controller">Ingress Controller</a> service to the <code>LoadBalancer</code> type,
NGinx is finally reachable from other hosts:</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-110-1"><a id="__codelineno-110-1" name="__codelineno-110-1" href="#__codelineno-110-1"></a><span class="gp"># </span>arping<span class="w"> </span><span class="m">192</span>.168.0.151
</span><span id="__span-110-2"><a id="__codelineno-110-2" name="__codelineno-110-2" href="#__codelineno-110-2"></a><span class="go">ARPING 192.168.0.151</span>
</span><span id="__span-110-3"><a id="__codelineno-110-3" name="__codelineno-110-3" href="#__codelineno-110-3"></a><span class="go">60 bytes from 2c:cf:67:83:6f:3b (192.168.0.151): index=0 time=224.584 usec</span>
</span><span id="__span-110-4"><a id="__codelineno-110-4" name="__codelineno-110-4" href="#__codelineno-110-4"></a><span class="go">60 bytes from 2c:cf:67:83:6f:3b (192.168.0.151): index=1 time=216.128 usec</span>
</span><span id="__span-110-5"><a id="__codelineno-110-5" name="__codelineno-110-5" href="#__codelineno-110-5"></a><span class="go">^C</span>
</span><span id="__span-110-6"><a id="__codelineno-110-6" name="__codelineno-110-6" href="#__codelineno-110-6"></a><span class="go">--- 192.168.0.151 statistics ---</span>
</span><span id="__span-110-7"><a id="__codelineno-110-7" name="__codelineno-110-7" href="#__codelineno-110-7"></a><span class="go">2 packets transmitted, 2 packets received,   0% unanswered (0 extra)</span>
</span><span id="__span-110-8"><a id="__codelineno-110-8" name="__codelineno-110-8" href="#__codelineno-110-8"></a><span class="go">rtt min/avg/max/std-dev = 0.216/0.220/0.225/0.004 ms</span>
</span><span id="__span-110-9"><a id="__codelineno-110-9" name="__codelineno-110-9" href="#__codelineno-110-9"></a>
</span><span id="__span-110-10"><a id="__codelineno-110-10" name="__codelineno-110-10" href="#__codelineno-110-10"></a><span class="gp">$ </span>curl<span class="w"> </span><span class="m">2</span>&gt;/dev/null<span class="w"> </span><span class="se">\</span>
</span><span id="__span-110-11"><a id="__codelineno-110-11" name="__codelineno-110-11" href="#__codelineno-110-11"></a><span class="w">  </span>-H<span class="w"> </span><span class="s2">"Host: kubernetes-alfred.very-very-dark-gray.top"</span><span class="w"> </span><span class="se">\</span>
</span><span id="__span-110-12"><a id="__codelineno-110-12" name="__codelineno-110-12" href="#__codelineno-110-12"></a><span class="w">  </span>-k<span class="w"> </span>https://192.168.0.151/<span class="w"> </span><span class="p">|</span><span class="w"> </span>head
</span><span id="__span-110-13"><a id="__codelineno-110-13" name="__codelineno-110-13" href="#__codelineno-110-13"></a><span class="go">&lt;!--</span>
</span><span id="__span-110-14"><a id="__codelineno-110-14" name="__codelineno-110-14" href="#__codelineno-110-14"></a><span class="go">Copyright 2017 The Kubernetes Authors.</span>
</span><span id="__span-110-15"><a id="__codelineno-110-15" name="__codelineno-110-15" href="#__codelineno-110-15"></a>
</span><span id="__span-110-16"><a id="__codelineno-110-16" name="__codelineno-110-16" href="#__codelineno-110-16"></a><span class="go">Licensed under the Apache License, Version 2.0 (the "License");</span>
</span><span id="__span-110-17"><a id="__codelineno-110-17" name="__codelineno-110-17" href="#__codelineno-110-17"></a><span class="go">you may not use this file except in compliance with the License.</span>
</span><span id="__span-110-18"><a id="__codelineno-110-18" name="__codelineno-110-18" href="#__codelineno-110-18"></a><span class="go">You may obtain a copy of the License at</span>
</span><span id="__span-110-19"><a id="__codelineno-110-19" name="__codelineno-110-19" href="#__codelineno-110-19"></a>
</span><span id="__span-110-20"><a id="__codelineno-110-20" name="__codelineno-110-20" href="#__codelineno-110-20"></a><span class="go">    http://www.apache.org/licenses/LICENSE-2.0</span>
</span><span id="__span-110-21"><a id="__codelineno-110-21" name="__codelineno-110-21" href="#__codelineno-110-21"></a>
</span><span id="__span-110-22"><a id="__codelineno-110-22" name="__codelineno-110-22" href="#__codelineno-110-22"></a><span class="go">Unless required by applicable law or agreed to in writing, software</span>
</span></code></pre></div>
<p>As a nice bonus, NGinx still replies to the old <code>NodePort</code> port <code>32035</code>.</p>
<details class="terminal">
<summary><code>kubectl apply -f metallb/metallb-native.yaml</code></summary>
<div class="language-console highlight"><pre><span></span><code><span id="__span-111-1"><a id="__codelineno-111-1" name="__codelineno-111-1" href="#__codelineno-111-1"></a><span class="gp">$ </span>kubectl<span class="w"> </span>apply<span class="w"> </span>-f<span class="w"> </span>metallb/metallb-native.yaml
</span><span id="__span-111-2"><a id="__codelineno-111-2" name="__codelineno-111-2" href="#__codelineno-111-2"></a><span class="go">namespace/metallb-system unchanged</span>
</span><span id="__span-111-3"><a id="__codelineno-111-3" name="__codelineno-111-3" href="#__codelineno-111-3"></a><span class="go">customresourcedefinition.apiextensions.k8s.io/bfdprofiles.metallb.io unchanged</span>
</span><span id="__span-111-4"><a id="__codelineno-111-4" name="__codelineno-111-4" href="#__codelineno-111-4"></a><span class="go">customresourcedefinition.apiextensions.k8s.io/bgpadvertisements.metallb.io unchanged</span>
</span><span id="__span-111-5"><a id="__codelineno-111-5" name="__codelineno-111-5" href="#__codelineno-111-5"></a><span class="go">customresourcedefinition.apiextensions.k8s.io/bgppeers.metallb.io configured</span>
</span><span id="__span-111-6"><a id="__codelineno-111-6" name="__codelineno-111-6" href="#__codelineno-111-6"></a><span class="go">customresourcedefinition.apiextensions.k8s.io/communities.metallb.io unchanged</span>
</span><span id="__span-111-7"><a id="__codelineno-111-7" name="__codelineno-111-7" href="#__codelineno-111-7"></a><span class="go">customresourcedefinition.apiextensions.k8s.io/ipaddresspools.metallb.io unchanged</span>
</span><span id="__span-111-8"><a id="__codelineno-111-8" name="__codelineno-111-8" href="#__codelineno-111-8"></a><span class="go">customresourcedefinition.apiextensions.k8s.io/l2advertisements.metallb.io unchanged</span>
</span><span id="__span-111-9"><a id="__codelineno-111-9" name="__codelineno-111-9" href="#__codelineno-111-9"></a><span class="go">customresourcedefinition.apiextensions.k8s.io/servicel2statuses.metallb.io unchanged</span>
</span><span id="__span-111-10"><a id="__codelineno-111-10" name="__codelineno-111-10" href="#__codelineno-111-10"></a><span class="go">serviceaccount/controller unchanged</span>
</span><span id="__span-111-11"><a id="__codelineno-111-11" name="__codelineno-111-11" href="#__codelineno-111-11"></a><span class="go">serviceaccount/speaker unchanged</span>
</span><span id="__span-111-12"><a id="__codelineno-111-12" name="__codelineno-111-12" href="#__codelineno-111-12"></a><span class="go">role.rbac.authorization.k8s.io/controller unchanged</span>
</span><span id="__span-111-13"><a id="__codelineno-111-13" name="__codelineno-111-13" href="#__codelineno-111-13"></a><span class="go">role.rbac.authorization.k8s.io/pod-lister unchanged</span>
</span><span id="__span-111-14"><a id="__codelineno-111-14" name="__codelineno-111-14" href="#__codelineno-111-14"></a><span class="go">clusterrole.rbac.authorization.k8s.io/metallb-system:controller unchanged</span>
</span><span id="__span-111-15"><a id="__codelineno-111-15" name="__codelineno-111-15" href="#__codelineno-111-15"></a><span class="go">clusterrole.rbac.authorization.k8s.io/metallb-system:speaker unchanged</span>
</span><span id="__span-111-16"><a id="__codelineno-111-16" name="__codelineno-111-16" href="#__codelineno-111-16"></a><span class="go">rolebinding.rbac.authorization.k8s.io/controller unchanged</span>
</span><span id="__span-111-17"><a id="__codelineno-111-17" name="__codelineno-111-17" href="#__codelineno-111-17"></a><span class="go">rolebinding.rbac.authorization.k8s.io/pod-lister unchanged</span>
</span><span id="__span-111-18"><a id="__codelineno-111-18" name="__codelineno-111-18" href="#__codelineno-111-18"></a><span class="go">clusterrolebinding.rbac.authorization.k8s.io/metallb-system:controller unchanged</span>
</span><span id="__span-111-19"><a id="__codelineno-111-19" name="__codelineno-111-19" href="#__codelineno-111-19"></a><span class="go">clusterrolebinding.rbac.authorization.k8s.io/metallb-system:speaker unchanged</span>
</span><span id="__span-111-20"><a id="__codelineno-111-20" name="__codelineno-111-20" href="#__codelineno-111-20"></a><span class="go">configmap/metallb-excludel2 unchanged</span>
</span><span id="__span-111-21"><a id="__codelineno-111-21" name="__codelineno-111-21" href="#__codelineno-111-21"></a><span class="go">secret/metallb-webhook-cert unchanged</span>
</span><span id="__span-111-22"><a id="__codelineno-111-22" name="__codelineno-111-22" href="#__codelineno-111-22"></a><span class="go">service/metallb-webhook-service unchanged</span>
</span><span id="__span-111-23"><a id="__codelineno-111-23" name="__codelineno-111-23" href="#__codelineno-111-23"></a><span class="go">deployment.apps/controller unchanged</span>
</span><span id="__span-111-24"><a id="__codelineno-111-24" name="__codelineno-111-24" href="#__codelineno-111-24"></a><span class="go">daemonset.apps/speaker configured</span>
</span><span id="__span-111-25"><a id="__codelineno-111-25" name="__codelineno-111-25" href="#__codelineno-111-25"></a><span class="go">validatingwebhookconfiguration.admissionregistration.k8s.io/metallb-webhook-configuration configured</span>
</span></code></pre></div>
</details>
<h4 id="allow-snippet-directives">Allow snippet directives</h4>
<p>To enable the use of snippets annotations in the next section, it is necessary to override
<a href="https://kubernetes.github.io/ingress-nginx/user-guide/nginx-configuration/configmap/#allow-snippet-annotations"><code>allow-snippet-annotations</code></a>
which is set <code>to false</code> by default to mitigate known vulnerability
<a href="https://nvd.nist.gov/vuln/detail/CVE-2021-25742">CVE-2021-25742</a>.
This vulnerability only applies in clusters where multiple users have Kubernetes
namespace administrator privileges, which is not the case here.</p>
<p>To enable this in the
<a href="https://kubernetes.github.io/ingress-nginx/deploy/#bare-metal-clusters">deployment for bare metal clusters</a>,
replace the <code>data: null</code> in line 323 with the following 3-line section:</p>
<div class="language-yaml highlight"><table class="highlighttable"><tbody><tr><th colspan="2" class="filename"><span class="filename">nginx-baremetal.yaml</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-112-321">321</a></span>
<span class="normal"><a href="#__codelineno-112-322">322</a></span>
<span class="normal"><a href="#__codelineno-112-323">323</a></span>
<span class="normal"><a href="#__codelineno-112-324">324</a></span>
<span class="normal"><a href="#__codelineno-112-325">325</a></span>
<span class="normal"><a href="#__codelineno-112-326">326</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-112-321"><a id="__codelineno-112-321" name="__codelineno-112-321"></a><span class="nn">---</span>
</span><span id="__span-112-322"><a id="__codelineno-112-322" name="__codelineno-112-322"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
</span><span id="__span-112-323"><a id="__codelineno-112-323" name="__codelineno-112-323"></a><span class="hll"><span class="nt">data</span><span class="p">:</span>
</span></span><span id="__span-112-324"><a id="__codelineno-112-324" name="__codelineno-112-324"></a><span class="hll"><span class="w">  </span><span class="nt">allow-snippet-annotations</span><span class="p">:</span><span class="w"> </span><span class="s">"true"</span>
</span></span><span id="__span-112-325"><a id="__codelineno-112-325" name="__codelineno-112-325"></a><span class="hll"><span class="w">  </span><span class="nt">annotations-risk-level</span><span class="p">:</span><span class="w"> </span><span class="s">"Critical"</span>
</span></span><span id="__span-112-326"><a id="__codelineno-112-326" name="__codelineno-112-326"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ConfigMap</span>
</span></code></pre></div></td></tr></tbody></table></div>
<p>Re-applying will only <em>configure</em> the <code>configmap</code> and webhook validation rules:</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-113-1"><a id="__codelineno-113-1" name="__codelineno-113-1" href="#__codelineno-113-1"></a><span class="gp">$ </span>kubectl<span class="w"> </span>apply<span class="w"> </span>-f<span class="w"> </span>nginx-baremetal.yaml
</span><span id="__span-113-2"><a id="__codelineno-113-2" name="__codelineno-113-2" href="#__codelineno-113-2"></a><span class="go">namespace/ingress-nginx unchanged</span>
</span><span id="__span-113-3"><a id="__codelineno-113-3" name="__codelineno-113-3" href="#__codelineno-113-3"></a><span class="go">serviceaccount/ingress-nginx unchanged</span>
</span><span id="__span-113-4"><a id="__codelineno-113-4" name="__codelineno-113-4" href="#__codelineno-113-4"></a><span class="go">serviceaccount/ingress-nginx-admission unchanged</span>
</span><span id="__span-113-5"><a id="__codelineno-113-5" name="__codelineno-113-5" href="#__codelineno-113-5"></a><span class="go">role.rbac.authorization.k8s.io/ingress-nginx unchanged</span>
</span><span id="__span-113-6"><a id="__codelineno-113-6" name="__codelineno-113-6" href="#__codelineno-113-6"></a><span class="go">role.rbac.authorization.k8s.io/ingress-nginx-admission unchanged</span>
</span><span id="__span-113-7"><a id="__codelineno-113-7" name="__codelineno-113-7" href="#__codelineno-113-7"></a><span class="go">clusterrole.rbac.authorization.k8s.io/ingress-nginx unchanged</span>
</span><span id="__span-113-8"><a id="__codelineno-113-8" name="__codelineno-113-8" href="#__codelineno-113-8"></a><span class="go">clusterrole.rbac.authorization.k8s.io/ingress-nginx-admission unchanged</span>
</span><span id="__span-113-9"><a id="__codelineno-113-9" name="__codelineno-113-9" href="#__codelineno-113-9"></a><span class="go">rolebinding.rbac.authorization.k8s.io/ingress-nginx unchanged</span>
</span><span id="__span-113-10"><a id="__codelineno-113-10" name="__codelineno-113-10" href="#__codelineno-113-10"></a><span class="go">rolebinding.rbac.authorization.k8s.io/ingress-nginx-admission unchanged</span>
</span><span id="__span-113-11"><a id="__codelineno-113-11" name="__codelineno-113-11" href="#__codelineno-113-11"></a><span class="go">clusterrolebinding.rbac.authorization.k8s.io/ingress-nginx unchanged</span>
</span><span id="__span-113-12"><a id="__codelineno-113-12" name="__codelineno-113-12" href="#__codelineno-113-12"></a><span class="go">clusterrolebinding.rbac.authorization.k8s.io/ingress-nginx-admission unchanged</span>
</span><span id="__span-113-13"><a id="__codelineno-113-13" name="__codelineno-113-13" href="#__codelineno-113-13"></a><span class="go">configmap/ingress-nginx-controller configured</span>
</span><span id="__span-113-14"><a id="__codelineno-113-14" name="__codelineno-113-14" href="#__codelineno-113-14"></a><span class="go">service/ingress-nginx-controller unchanged</span>
</span><span id="__span-113-15"><a id="__codelineno-113-15" name="__codelineno-113-15" href="#__codelineno-113-15"></a><span class="go">service/ingress-nginx-controller-admission unchanged</span>
</span><span id="__span-113-16"><a id="__codelineno-113-16" name="__codelineno-113-16" href="#__codelineno-113-16"></a><span class="go">deployment.apps/ingress-nginx-controller configured</span>
</span><span id="__span-113-17"><a id="__codelineno-113-17" name="__codelineno-113-17" href="#__codelineno-113-17"></a><span class="go">job.batch/ingress-nginx-admission-create unchanged</span>
</span><span id="__span-113-18"><a id="__codelineno-113-18" name="__codelineno-113-18" href="#__codelineno-113-18"></a><span class="go">job.batch/ingress-nginx-admission-patch unchanged</span>
</span><span id="__span-113-19"><a id="__codelineno-113-19" name="__codelineno-113-19" href="#__codelineno-113-19"></a><span class="go">ingressclass.networking.k8s.io/nginx unchanged</span>
</span><span id="__span-113-20"><a id="__codelineno-113-20" name="__codelineno-113-20" href="#__codelineno-113-20"></a><span class="go">validatingwebhookconfiguration.admissionregistration.k8s.io/ingress-nginx-admission configured</span>
</span></code></pre></div>
<details class="note">
<summary>Exactly why enable <code>allow-snippet-annotations</code> <em>and</em> raise the <code>annotations-risk-level</code>?</summary>
<p>Without enabling <code>allow-snippet-annotations</code>, deploying the <code>Ingress</code> in the next
section fails because the <code>configuration-snippet</code> used to hide server headers makes
the deployment fail:</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-114-1"><a id="__codelineno-114-1" name="__codelineno-114-1" href="#__codelineno-114-1"></a><span class="gp">$ </span>kubectl<span class="w"> </span>apply<span class="w"> </span>-f<span class="w"> </span>dashboard/nginx-ingress.yaml
</span><span id="__span-114-2"><a id="__codelineno-114-2" name="__codelineno-114-2" href="#__codelineno-114-2"></a><span class="go">{"metadata":{"annotations":{"cert-manager.io/issuer":"letsencrypt-staging","kubectl.kubernetes.io/last-applied-configuration":"{\"apiVersion\":\"networking.k8s.io/v1\",\"kind\":\"Ingress\",\"metadata\":{\"annotations\":{\"cert-manager.io/issuer\":\"letsencrypt-staging\",\"nginx.ingress.kubernetes.io/auth-tls-verify-client\":\"false\",\"nginx.ingress.kubernetes.io/backend-protocol\":\"HTTPS\",\"nginx.ingress.kubernetes.io/configuration-snippet\":\"more_set_headers \\\"server: hide\\\";\\n\",\"nginx.ingress.kubernetes.io/whitelist-source-range\":\"10.244.0.0/16\"},\"name\":\"kubernetes-dashboard-ingress\",\"namespace\":\"kubernetes-dashboard\"},\"spec\":{\"ingressClassName\":\"nginx\",\"rules\":[{\"host\":\"k8s.alfred.uu.am\",\"http\":{\"paths\":[{\"backend\":{\"service\":{\"name\":\"kubernetes-dashboard-kong-proxy\",\"port\":{\"number\":443}}},\"path\":\"/\",\"pathType\":\"Prefix\"}]}}],\"tls\":[{\"hosts\":[\"k8s.alfred.uu.am\"],\"secretName\":\"tls-secret\"}]}}\n","nginx.ingress.kubernetes.io/configuration-snippet":"more_set_headers \"server: hide\";\n"}},"spec":{"tls":[{"hosts":["k8s.alfred.uu.am"],"secretName":"tls-secret"}]}}</span>
</span><span id="__span-114-3"><a id="__codelineno-114-3" name="__codelineno-114-3" href="#__codelineno-114-3"></a><span class="go">to:</span>
</span><span id="__span-114-4"><a id="__codelineno-114-4" name="__codelineno-114-4" href="#__codelineno-114-4"></a><span class="go">Resource: "networking.k8s.io/v1, Resource=ingresses", GroupVersionKind: "networking.k8s.io/v1, Kind=Ingress"</span>
</span><span id="__span-114-5"><a id="__codelineno-114-5" name="__codelineno-114-5" href="#__codelineno-114-5"></a><span class="go">Name: "kubernetes-dashboard-ingress", Namespace: "kubernetes-dashboard"</span>
</span><span id="__span-114-6"><a id="__codelineno-114-6" name="__codelineno-114-6" href="#__codelineno-114-6"></a><span class="go">for: "dashboard/nginx-ingress.yaml": error when patching "dashboard/nginx-ingress.yaml": admission webhook "validate.nginx.ingress.kubernetes.io" denied the request: nginx.ingress.kubernetes.io/configuration-snippet annotation cannot be used. Snippet directives are disabled by the Ingress administrator</span>
</span></code></pre></div>
<p>The <code>Snippet directives are disabled by the Ingress administrator</code> and the end of
the error message is the hint that <code>allow-snippet-annotations</code> needs to be enabled.</p>
<p>Without raisig the <code>annotations-risk-level</code> to <code>Critical</code>, the deployment fails
because, since controller 1.12, the annotation used to hide server headers
(<code>nginx.ingress.kubernetes.io/configuration-snippet</code>) is rated <code>Critical</code>.</p>
</details>
<h4 id="kubernetes-dashboard-ingress">Kubernetes Dashboard Ingress</h4>
<p>With both Ngnix and the Kubernetes dashboard up and running, it is now possible to make
the dashboard more conveniently accessible via Nginx. This <code>Ingress</code> is a slightly more
complete one based on the example above:</p>
<div class="language-yaml highlight"><span class="filename">dashboard/nginx-ingress.yaml</span><pre><span></span><code><span id="__span-115-1"><a id="__codelineno-115-1" name="__codelineno-115-1" href="#__codelineno-115-1"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">networking.k8s.io/v1</span>
</span><span id="__span-115-2"><a id="__codelineno-115-2" name="__codelineno-115-2" href="#__codelineno-115-2"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Ingress</span>
</span><span id="__span-115-3"><a id="__codelineno-115-3" name="__codelineno-115-3" href="#__codelineno-115-3"></a><span class="nt">metadata</span><span class="p">:</span>
</span><span id="__span-115-4"><a id="__codelineno-115-4" name="__codelineno-115-4" href="#__codelineno-115-4"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">kubernetes-dashboard-ingress</span>
</span><span id="__span-115-5"><a id="__codelineno-115-5" name="__codelineno-115-5" href="#__codelineno-115-5"></a><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">kubernetes-dashboard</span>
</span><span id="__span-115-6"><a id="__codelineno-115-6" name="__codelineno-115-6" href="#__codelineno-115-6"></a><span class="w">  </span><span class="nt">annotations</span><span class="p">:</span>
</span><span id="__span-115-7"><a id="__codelineno-115-7" name="__codelineno-115-7" href="#__codelineno-115-7"></a><span class="w">    </span><span class="nt">nginx.ingress.kubernetes.io/backend-protocol</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">HTTPS</span>
</span><span id="__span-115-8"><a id="__codelineno-115-8" name="__codelineno-115-8" href="#__codelineno-115-8"></a><span class="w">    </span><span class="nt">nginx.ingress.kubernetes.io/auth-tls-verify-client</span><span class="p">:</span><span class="w"> </span><span class="s">"false"</span>
</span><span id="__span-115-9"><a id="__codelineno-115-9" name="__codelineno-115-9" href="#__codelineno-115-9"></a><span class="w">    </span><span class="nt">nginx.ingress.kubernetes.io/whitelist-source-range</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10.244.0.0/16</span>
</span><span id="__span-115-10"><a id="__codelineno-115-10" name="__codelineno-115-10" href="#__codelineno-115-10"></a><span class="w">    </span><span class="nt">nginx.ingress.kubernetes.io/configuration-snippet</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
</span><span id="__span-115-11"><a id="__codelineno-115-11" name="__codelineno-115-11" href="#__codelineno-115-11"></a><span class="w">      </span><span class="no">more_set_headers "server: hide";</span>
</span><span id="__span-115-12"><a id="__codelineno-115-12" name="__codelineno-115-12" href="#__codelineno-115-12"></a><span class="nt">spec</span><span class="p">:</span>
</span><span id="__span-115-13"><a id="__codelineno-115-13" name="__codelineno-115-13" href="#__codelineno-115-13"></a><span class="w">  </span><span class="nt">ingressClassName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nginx</span>
</span><span id="__span-115-14"><a id="__codelineno-115-14" name="__codelineno-115-14" href="#__codelineno-115-14"></a><span class="w">  </span><span class="nt">rules</span><span class="p">:</span>
</span><span id="__span-115-15"><a id="__codelineno-115-15" name="__codelineno-115-15" href="#__codelineno-115-15"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">host</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">k8s.alfred</span>
</span><span id="__span-115-16"><a id="__codelineno-115-16" name="__codelineno-115-16" href="#__codelineno-115-16"></a><span class="w">      </span><span class="nt">http</span><span class="p">:</span>
</span><span id="__span-115-17"><a id="__codelineno-115-17" name="__codelineno-115-17" href="#__codelineno-115-17"></a><span class="w">        </span><span class="nt">paths</span><span class="p">:</span>
</span><span id="__span-115-18"><a id="__codelineno-115-18" name="__codelineno-115-18" href="#__codelineno-115-18"></a><span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/</span>
</span><span id="__span-115-19"><a id="__codelineno-115-19" name="__codelineno-115-19" href="#__codelineno-115-19"></a><span class="w">            </span><span class="nt">pathType</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Prefix</span>
</span><span id="__span-115-20"><a id="__codelineno-115-20" name="__codelineno-115-20" href="#__codelineno-115-20"></a><span class="w">            </span><span class="nt">backend</span><span class="p">:</span>
</span><span id="__span-115-21"><a id="__codelineno-115-21" name="__codelineno-115-21" href="#__codelineno-115-21"></a><span class="w">              </span><span class="nt">service</span><span class="p">:</span>
</span><span id="__span-115-22"><a id="__codelineno-115-22" name="__codelineno-115-22" href="#__codelineno-115-22"></a><span class="w">                </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">kubernetes-dashboard-kong-proxy</span>
</span><span id="__span-115-23"><a id="__codelineno-115-23" name="__codelineno-115-23" href="#__codelineno-115-23"></a><span class="w">                </span><span class="nt">port</span><span class="p">:</span>
</span><span id="__span-115-24"><a id="__codelineno-115-24" name="__codelineno-115-24" href="#__codelineno-115-24"></a><span class="w">                  </span><span class="nt">number</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">443</span>
</span></code></pre></div>
<p>This will point to the <code>kubernetes-dashboard-kong-proxy</code> which is the one listening on
standard HTTPS port 443. This is the one targeted by the <code>kubectl port-forward</code> command
above, which then exposes it on the node's port 8443.</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-116-1"><a id="__codelineno-116-1" name="__codelineno-116-1" href="#__codelineno-116-1"></a><span class="gp">$ </span>kubectl<span class="w"> </span>apply<span class="w"> </span>-f<span class="w"> </span>dashboard/nginx-ingress.yaml
</span><span id="__span-116-2"><a id="__codelineno-116-2" name="__codelineno-116-2" href="#__codelineno-116-2"></a><span class="go">ingress.networking.k8s.io/kubernetes-dashboard-ingress created</span>
</span></code></pre></div>
<p>A very quick way to test that the new <code>Ingress</code> is working correctly, add the <code>Host</code> header
to the above <code>curl</code> command:</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-117-1"><a id="__codelineno-117-1" name="__codelineno-117-1" href="#__codelineno-117-1"></a><span class="gp">$ </span>curl<span class="w"> </span><span class="m">2</span>&gt;/dev/null<span class="w"> </span><span class="se">\</span>
</span><span id="__span-117-2"><a id="__codelineno-117-2" name="__codelineno-117-2" href="#__codelineno-117-2"></a><span class="w">  </span>-H<span class="w"> </span><span class="s2">"Host: k8s.alfred"</span><span class="w"> </span><span class="se">\</span>
</span><span id="__span-117-3"><a id="__codelineno-117-3" name="__codelineno-117-3" href="#__codelineno-117-3"></a><span class="w">  </span>-k<span class="w"> </span>https://192.168.0.151/<span class="w"> </span><span class="se">\</span>
</span><span id="__span-117-4"><a id="__codelineno-117-4" name="__codelineno-117-4" href="#__codelineno-117-4"></a><span class="p">|</span><span class="w"> </span>head
</span><span id="__span-117-5"><a id="__codelineno-117-5" name="__codelineno-117-5" href="#__codelineno-117-5"></a><span class="go">&lt;!--</span>
</span><span id="__span-117-6"><a id="__codelineno-117-6" name="__codelineno-117-6" href="#__codelineno-117-6"></a><span class="go">Copyright 2017 The Kubernetes Authors.</span>
</span><span id="__span-117-7"><a id="__codelineno-117-7" name="__codelineno-117-7" href="#__codelineno-117-7"></a>
</span><span id="__span-117-8"><a id="__codelineno-117-8" name="__codelineno-117-8" href="#__codelineno-117-8"></a><span class="go">Licensed under the Apache License, Version 2.0 (the "License");</span>
</span><span id="__span-117-9"><a id="__codelineno-117-9" name="__codelineno-117-9" href="#__codelineno-117-9"></a><span class="go">you may not use this file except in compliance with the License.</span>
</span><span id="__span-117-10"><a id="__codelineno-117-10" name="__codelineno-117-10" href="#__codelineno-117-10"></a><span class="go">You may obtain a copy of the License at</span>
</span><span id="__span-117-11"><a id="__codelineno-117-11" name="__codelineno-117-11" href="#__codelineno-117-11"></a>
</span><span id="__span-117-12"><a id="__codelineno-117-12" name="__codelineno-117-12" href="#__codelineno-117-12"></a><span class="go">    http://www.apache.org/licenses/LICENSE-2.0</span>
</span></code></pre></div>
<p>Once this works in the local network, it can be made accessible externally by forwarding
<em>a</em> port (443 if available, any other one otherwise) to the Nginx <code>LoadBalancer</code> IP (or <code>NodePort</code> on the node's local IP address; this should work just as well as if Nginx
had a <code>LoadBalancer</code> IP address). It is also necessary to update (or clone) the ingress
rule to set <code>host</code> to the FQDN that points to the router's exterenal IP address, e.g.
<code>k8s.alfred.uu.am</code>.</p>
<h4 id="more-flannel-troubleshooting">More Flannel Troubleshooting</h4>
<p>It looks like no <code>LoadBalancer</code> or <code>NodePort</code> is reachable from other hosts and
it looks like it may be a consequence of having initially omitted the steps to
<a href="https://v1-29.docs.kubernetes.io/docs/setup/production-environment/container-runtimes/#forwarding-ipv4-and-letting-iptables-see-bridged-traffic">let iptables see bridged traffic</a>,
thus leading to <a href="#troubleshooting-flannel">Flannel problems</a>. Comparing the
output from <code>iptables</code> with that in <code>lexicon</code>, many rules with source and
destination <code>br-*****</code> are missing:</p>
<details class="terminal">
<summary><code>root@lexicon ~ # iptables -nvL</code></summary>
<div class="language-console highlight"><pre><span></span><code><span id="__span-118-1"><a id="__codelineno-118-1" name="__codelineno-118-1" href="#__codelineno-118-1"></a><span class="gp">root@lexicon ~ # </span>iptables<span class="w"> </span>-nvL
</span><span id="__span-118-2"><a id="__codelineno-118-2" name="__codelineno-118-2" href="#__codelineno-118-2"></a><span class="go">Chain FORWARD (policy ACCEPT 0 packets, 0 bytes)</span>
</span><span id="__span-118-3"><a id="__codelineno-118-3" name="__codelineno-118-3" href="#__codelineno-118-3"></a><span class="go">pkts bytes target     prot opt in     out     source               destination         </span>
</span><span id="__span-118-4"><a id="__codelineno-118-4" name="__codelineno-118-4" href="#__codelineno-118-4"></a><span class="go">530K   34M KUBE-PROXY-FIREWALL  all  --  *      *       0.0.0.0/0            0.0.0.0/0            ctstate NEW /* kubernetes load balancer firewall */</span>
</span><span id="__span-118-5"><a id="__codelineno-118-5" name="__codelineno-118-5" href="#__codelineno-118-5"></a><span class="go">2528K 4151M KUBE-FORWARD  all  --  *      *       0.0.0.0/0            0.0.0.0/0            /* kubernetes forwarding rules */</span>
</span><span id="__span-118-6"><a id="__codelineno-118-6" name="__codelineno-118-6" href="#__codelineno-118-6"></a><span class="go">468K   31M KUBE-SERVICES  all  --  *      *       0.0.0.0/0            0.0.0.0/0            ctstate NEW /* kubernetes service portals */</span>
</span><span id="__span-118-7"><a id="__codelineno-118-7" name="__codelineno-118-7" href="#__codelineno-118-7"></a><span class="go">468K   31M KUBE-EXTERNAL-SERVICES  all  --  *      *       0.0.0.0/0            0.0.0.0/0            ctstate NEW /* kubernetes externally-visible service portals */</span>
</span><span id="__span-118-8"><a id="__codelineno-118-8" name="__codelineno-118-8" href="#__codelineno-118-8"></a><span class="go">468K   31M DOCKER-USER  all  --  *      *       0.0.0.0/0            0.0.0.0/0           </span>
</span><span id="__span-118-9"><a id="__codelineno-118-9" name="__codelineno-118-9" href="#__codelineno-118-9"></a><span class="go">  33 16623 ACCEPT     all  --  *      *       0.0.0.0/0            0.0.0.0/0            match-set docker-ext-bridges-v4 dst ctstate RELATED,ESTABLISHED</span>
</span><span id="__span-118-10"><a id="__codelineno-118-10" name="__codelineno-118-10" href="#__codelineno-118-10"></a><span class="go">468K   31M DOCKER-ISOLATION-STAGE-1  all  --  *      *       0.0.0.0/0            0.0.0.0/0           </span>
</span><span id="__span-118-11"><a id="__codelineno-118-11" name="__codelineno-118-11" href="#__codelineno-118-11"></a><span class="go">  26  1560 DOCKER     all  --  *      *       0.0.0.0/0            0.0.0.0/0            match-set docker-ext-bridges-v4 dst</span>
</span><span id="__span-118-12"><a id="__codelineno-118-12" name="__codelineno-118-12" href="#__codelineno-118-12"></a><span class="go">    0     0 ACCEPT     all  --  wg0    *       0.0.0.0/0            0.0.0.0/0           </span>
</span><span id="__span-118-13"><a id="__codelineno-118-13" name="__codelineno-118-13" href="#__codelineno-118-13"></a><span class="go">    0     0 ACCEPT     all  --  br-1352dfaa6e69 *       0.0.0.0/0            0.0.0.0/0           </span>
</span><span id="__span-118-14"><a id="__codelineno-118-14" name="__codelineno-118-14" href="#__codelineno-118-14"></a><span class="go">  139 10023 ACCEPT     all  --  br-26c076fa82f8 *       0.0.0.0/0            0.0.0.0/0           </span>
</span><span id="__span-118-15"><a id="__codelineno-118-15" name="__codelineno-118-15" href="#__codelineno-118-15"></a><span class="go">    0     0 ACCEPT     all  --  br-f461a8ffa6e0 *       0.0.0.0/0            0.0.0.0/0           </span>
</span><span id="__span-118-16"><a id="__codelineno-118-16" name="__codelineno-118-16" href="#__codelineno-118-16"></a><span class="go">    0     0 ACCEPT     all  --  br-f9783559f0e8 *       0.0.0.0/0            0.0.0.0/0           </span>
</span><span id="__span-118-17"><a id="__codelineno-118-17" name="__codelineno-118-17" href="#__codelineno-118-17"></a><span class="go">    0     0 ACCEPT     all  --  docker0 *       0.0.0.0/0            0.0.0.0/0           </span>
</span><span id="__span-118-18"><a id="__codelineno-118-18" name="__codelineno-118-18" href="#__codelineno-118-18"></a><span class="go">468K   31M FLANNEL-FWD  all  --  *      *       0.0.0.0/0            0.0.0.0/0            /* flanneld forward */</span>
</span><span id="__span-118-19"><a id="__codelineno-118-19" name="__codelineno-118-19" href="#__codelineno-118-19"></a>
</span><span id="__span-118-20"><a id="__codelineno-118-20" name="__codelineno-118-20" href="#__codelineno-118-20"></a><span class="go">Chain DOCKER (1 references)</span>
</span><span id="__span-118-21"><a id="__codelineno-118-21" name="__codelineno-118-21" href="#__codelineno-118-21"></a><span class="go">pkts bytes target     prot opt in     out     source               destination         </span>
</span><span id="__span-118-22"><a id="__codelineno-118-22" name="__codelineno-118-22" href="#__codelineno-118-22"></a><span class="go">    0     0 ACCEPT     tcp  --  !br-26c076fa82f8 br-26c076fa82f8  0.0.0.0/0            172.19.0.4           tcp dpt:3000</span>
</span><span id="__span-118-23"><a id="__codelineno-118-23" name="__codelineno-118-23" href="#__codelineno-118-23"></a><span class="go">    0     0 ACCEPT     tcp  --  !br-26c076fa82f8 br-26c076fa82f8  0.0.0.0/0            172.19.0.3           tcp dpt:8086</span>
</span><span id="__span-118-24"><a id="__codelineno-118-24" name="__codelineno-118-24" href="#__codelineno-118-24"></a><span class="go">    0     0 ACCEPT     tcp  --  !br-26c076fa82f8 br-26c076fa82f8  0.0.0.0/0            172.19.0.2           tcp dpt:8125</span>
</span><span id="__span-118-25"><a id="__codelineno-118-25" name="__codelineno-118-25" href="#__codelineno-118-25"></a><span class="go">    0     0 DROP       all  --  !br-1352dfaa6e69 br-1352dfaa6e69  0.0.0.0/0            0.0.0.0/0           </span>
</span><span id="__span-118-26"><a id="__codelineno-118-26" name="__codelineno-118-26" href="#__codelineno-118-26"></a><span class="go">  24  1440 DROP       all  --  !br-26c076fa82f8 br-26c076fa82f8  0.0.0.0/0            0.0.0.0/0           </span>
</span><span id="__span-118-27"><a id="__codelineno-118-27" name="__codelineno-118-27" href="#__codelineno-118-27"></a><span class="go">    0     0 DROP       all  --  !br-f461a8ffa6e0 br-f461a8ffa6e0  0.0.0.0/0            0.0.0.0/0           </span>
</span><span id="__span-118-28"><a id="__codelineno-118-28" name="__codelineno-118-28" href="#__codelineno-118-28"></a><span class="go">    0     0 DROP       all  --  !br-f9783559f0e8 br-f9783559f0e8  0.0.0.0/0            0.0.0.0/0           </span>
</span><span id="__span-118-29"><a id="__codelineno-118-29" name="__codelineno-118-29" href="#__codelineno-118-29"></a><span class="go">    0     0 DROP       all  --  !docker0 docker0  0.0.0.0/0            0.0.0.0/0           </span>
</span><span id="__span-118-30"><a id="__codelineno-118-30" name="__codelineno-118-30" href="#__codelineno-118-30"></a>
</span><span id="__span-118-31"><a id="__codelineno-118-31" name="__codelineno-118-31" href="#__codelineno-118-31"></a><span class="go">Chain DOCKER-ISOLATION-STAGE-1 (1 references)</span>
</span><span id="__span-118-32"><a id="__codelineno-118-32" name="__codelineno-118-32" href="#__codelineno-118-32"></a><span class="go">pkts bytes target     prot opt in     out     source               destination         </span>
</span><span id="__span-118-33"><a id="__codelineno-118-33" name="__codelineno-118-33" href="#__codelineno-118-33"></a><span class="go">    0     0 DOCKER-ISOLATION-STAGE-2  all  --  br-1352dfaa6e69 !br-1352dfaa6e69  0.0.0.0/0            0.0.0.0/0           </span>
</span><span id="__span-118-34"><a id="__codelineno-118-34" name="__codelineno-118-34" href="#__codelineno-118-34"></a><span class="go">  137  9903 DOCKER-ISOLATION-STAGE-2  all  --  br-26c076fa82f8 !br-26c076fa82f8  0.0.0.0/0            0.0.0.0/0           </span>
</span><span id="__span-118-35"><a id="__codelineno-118-35" name="__codelineno-118-35" href="#__codelineno-118-35"></a><span class="go">    0     0 DOCKER-ISOLATION-STAGE-2  all  --  br-f461a8ffa6e0 !br-f461a8ffa6e0  0.0.0.0/0            0.0.0.0/0           </span>
</span><span id="__span-118-36"><a id="__codelineno-118-36" name="__codelineno-118-36" href="#__codelineno-118-36"></a><span class="go">    0     0 DOCKER-ISOLATION-STAGE-2  all  --  br-f9783559f0e8 !br-f9783559f0e8  0.0.0.0/0            0.0.0.0/0           </span>
</span><span id="__span-118-37"><a id="__codelineno-118-37" name="__codelineno-118-37" href="#__codelineno-118-37"></a><span class="go">    0     0 DOCKER-ISOLATION-STAGE-2  all  --  docker0 !docker0  0.0.0.0/0            0.0.0.0/0           </span>
</span><span id="__span-118-38"><a id="__codelineno-118-38" name="__codelineno-118-38" href="#__codelineno-118-38"></a>
</span><span id="__span-118-39"><a id="__codelineno-118-39" name="__codelineno-118-39" href="#__codelineno-118-39"></a><span class="go">Chain DOCKER-ISOLATION-STAGE-2 (5 references)</span>
</span><span id="__span-118-40"><a id="__codelineno-118-40" name="__codelineno-118-40" href="#__codelineno-118-40"></a><span class="go">pkts bytes target     prot opt in     out     source               destination         </span>
</span><span id="__span-118-41"><a id="__codelineno-118-41" name="__codelineno-118-41" href="#__codelineno-118-41"></a><span class="go">    0     0 DROP       all  --  *      docker0  0.0.0.0/0            0.0.0.0/0           </span>
</span><span id="__span-118-42"><a id="__codelineno-118-42" name="__codelineno-118-42" href="#__codelineno-118-42"></a><span class="go">    0     0 DROP       all  --  *      br-f9783559f0e8  0.0.0.0/0            0.0.0.0/0           </span>
</span><span id="__span-118-43"><a id="__codelineno-118-43" name="__codelineno-118-43" href="#__codelineno-118-43"></a><span class="go">    0     0 DROP       all  --  *      br-f461a8ffa6e0  0.0.0.0/0            0.0.0.0/0           </span>
</span><span id="__span-118-44"><a id="__codelineno-118-44" name="__codelineno-118-44" href="#__codelineno-118-44"></a><span class="go">    0     0 DROP       all  --  *      br-26c076fa82f8  0.0.0.0/0            0.0.0.0/0           </span>
</span><span id="__span-118-45"><a id="__codelineno-118-45" name="__codelineno-118-45" href="#__codelineno-118-45"></a><span class="go">    0     0 DROP       all  --  *      br-1352dfaa6e69  0.0.0.0/0            0.0.0.0/0           </span>
</span><span id="__span-118-46"><a id="__codelineno-118-46" name="__codelineno-118-46" href="#__codelineno-118-46"></a>
</span><span id="__span-118-47"><a id="__codelineno-118-47" name="__codelineno-118-47" href="#__codelineno-118-47"></a><span class="go">Chain DOCKER-USER (1 references)</span>
</span><span id="__span-118-48"><a id="__codelineno-118-48" name="__codelineno-118-48" href="#__codelineno-118-48"></a><span class="go">pkts bytes target     prot opt in     out     source               destination         </span>
</span><span id="__span-118-49"><a id="__codelineno-118-49" name="__codelineno-118-49" href="#__codelineno-118-49"></a><span class="go">468K   31M RETURN     all  --  *      *       0.0.0.0/0            0.0.0.0/0           </span>
</span><span id="__span-118-50"><a id="__codelineno-118-50" name="__codelineno-118-50" href="#__codelineno-118-50"></a>
</span><span id="__span-118-51"><a id="__codelineno-118-51" name="__codelineno-118-51" href="#__codelineno-118-51"></a><span class="go">Chain FLANNEL-FWD (1 references)</span>
</span><span id="__span-118-52"><a id="__codelineno-118-52" name="__codelineno-118-52" href="#__codelineno-118-52"></a><span class="go">pkts bytes target     prot opt in     out     source               destination         </span>
</span><span id="__span-118-53"><a id="__codelineno-118-53" name="__codelineno-118-53" href="#__codelineno-118-53"></a><span class="go">468K   31M ACCEPT     all  --  *      *       10.244.0.0/16        0.0.0.0/0            /* flanneld forward */</span>
</span><span id="__span-118-54"><a id="__codelineno-118-54" name="__codelineno-118-54" href="#__codelineno-118-54"></a><span class="go">  16   960 ACCEPT     all  --  *      *       0.0.0.0/0            10.244.0.0/16        /* flanneld forward */</span>
</span><span id="__span-118-55"><a id="__codelineno-118-55" name="__codelineno-118-55" href="#__codelineno-118-55"></a>
</span><span id="__span-118-56"><a id="__codelineno-118-56" name="__codelineno-118-56" href="#__codelineno-118-56"></a><span class="go">Chain KUBE-FIREWALL (2 references)</span>
</span><span id="__span-118-57"><a id="__codelineno-118-57" name="__codelineno-118-57" href="#__codelineno-118-57"></a><span class="go">pkts bytes target     prot opt in     out     source               destination         </span>
</span><span id="__span-118-58"><a id="__codelineno-118-58" name="__codelineno-118-58" href="#__codelineno-118-58"></a><span class="go">    0     0 DROP       all  --  *      *      !127.0.0.0/8          127.0.0.0/8          /* block incoming localnet connections */ ! ctstate RELATED,ESTABLISHED,DNAT</span>
</span><span id="__span-118-59"><a id="__codelineno-118-59" name="__codelineno-118-59" href="#__codelineno-118-59"></a>
</span><span id="__span-118-60"><a id="__codelineno-118-60" name="__codelineno-118-60" href="#__codelineno-118-60"></a><span class="go">Chain KUBE-FORWARD (1 references)</span>
</span><span id="__span-118-61"><a id="__codelineno-118-61" name="__codelineno-118-61" href="#__codelineno-118-61"></a><span class="go">pkts bytes target     prot opt in     out     source               destination         </span>
</span><span id="__span-118-62"><a id="__codelineno-118-62" name="__codelineno-118-62" href="#__codelineno-118-62"></a><span class="go">    0     0 DROP       all  --  *      *       0.0.0.0/0            0.0.0.0/0            ctstate INVALID nfacct-name  ct_state_invalid_dropped_pkts</span>
</span><span id="__span-118-63"><a id="__codelineno-118-63" name="__codelineno-118-63" href="#__codelineno-118-63"></a><span class="go">3206  189K ACCEPT     all  --  *      *       0.0.0.0/0            0.0.0.0/0            /* kubernetes forwarding rules */</span>
</span><span id="__span-118-64"><a id="__codelineno-118-64" name="__codelineno-118-64" href="#__codelineno-118-64"></a><span class="go">448K 1979M ACCEPT     all  --  *      *       0.0.0.0/0            0.0.0.0/0            /* kubernetes forwarding conntrack rule */ ctstate RELATED,ESTABLISHED</span>
</span></code></pre></div>
</details>
<details class="terminal">
<summary><code>root@lexicon ~ # iptables --list-rules</code></summary>
<div class="language-console highlight"><pre><span></span><code><span id="__span-119-1"><a id="__codelineno-119-1" name="__codelineno-119-1" href="#__codelineno-119-1"></a><span class="gp">root@lexicon ~ # </span>iptables<span class="w"> </span>--list-rules
</span><span id="__span-119-2"><a id="__codelineno-119-2" name="__codelineno-119-2" href="#__codelineno-119-2"></a><span class="go">-P INPUT ACCEPT</span>
</span><span id="__span-119-3"><a id="__codelineno-119-3" name="__codelineno-119-3" href="#__codelineno-119-3"></a><span class="go">-P FORWARD ACCEPT</span>
</span><span id="__span-119-4"><a id="__codelineno-119-4" name="__codelineno-119-4" href="#__codelineno-119-4"></a><span class="go">-P OUTPUT ACCEPT</span>
</span><span id="__span-119-5"><a id="__codelineno-119-5" name="__codelineno-119-5" href="#__codelineno-119-5"></a><span class="go">-N DOCKER</span>
</span><span id="__span-119-6"><a id="__codelineno-119-6" name="__codelineno-119-6" href="#__codelineno-119-6"></a><span class="go">-N DOCKER-ISOLATION-STAGE-1</span>
</span><span id="__span-119-7"><a id="__codelineno-119-7" name="__codelineno-119-7" href="#__codelineno-119-7"></a><span class="go">-N DOCKER-ISOLATION-STAGE-2</span>
</span><span id="__span-119-8"><a id="__codelineno-119-8" name="__codelineno-119-8" href="#__codelineno-119-8"></a><span class="go">-N DOCKER-USER</span>
</span><span id="__span-119-9"><a id="__codelineno-119-9" name="__codelineno-119-9" href="#__codelineno-119-9"></a><span class="go">-N FLANNEL-FWD</span>
</span><span id="__span-119-10"><a id="__codelineno-119-10" name="__codelineno-119-10" href="#__codelineno-119-10"></a><span class="go">-N KUBE-EXTERNAL-SERVICES</span>
</span><span id="__span-119-11"><a id="__codelineno-119-11" name="__codelineno-119-11" href="#__codelineno-119-11"></a><span class="go">-N KUBE-FIREWALL</span>
</span><span id="__span-119-12"><a id="__codelineno-119-12" name="__codelineno-119-12" href="#__codelineno-119-12"></a><span class="go">-N KUBE-FORWARD</span>
</span><span id="__span-119-13"><a id="__codelineno-119-13" name="__codelineno-119-13" href="#__codelineno-119-13"></a><span class="go">-N KUBE-KUBELET-CANARY</span>
</span><span id="__span-119-14"><a id="__codelineno-119-14" name="__codelineno-119-14" href="#__codelineno-119-14"></a><span class="go">-N KUBE-NODEPORTS</span>
</span><span id="__span-119-15"><a id="__codelineno-119-15" name="__codelineno-119-15" href="#__codelineno-119-15"></a><span class="go">-N KUBE-PROXY-CANARY</span>
</span><span id="__span-119-16"><a id="__codelineno-119-16" name="__codelineno-119-16" href="#__codelineno-119-16"></a><span class="go">-N KUBE-PROXY-FIREWALL</span>
</span><span id="__span-119-17"><a id="__codelineno-119-17" name="__codelineno-119-17" href="#__codelineno-119-17"></a><span class="go">-N KUBE-SERVICES</span>
</span><span id="__span-119-18"><a id="__codelineno-119-18" name="__codelineno-119-18" href="#__codelineno-119-18"></a><span class="go">-A INPUT -m conntrack --ctstate NEW -m comment --comment "kubernetes load balancer firewall" -j KUBE-PROXY-FIREWALL</span>
</span><span id="__span-119-19"><a id="__codelineno-119-19" name="__codelineno-119-19" href="#__codelineno-119-19"></a><span class="go">-A INPUT -m comment --comment "kubernetes health check service ports" -j KUBE-NODEPORTS</span>
</span><span id="__span-119-20"><a id="__codelineno-119-20" name="__codelineno-119-20" href="#__codelineno-119-20"></a><span class="go">-A INPUT -m conntrack --ctstate NEW -m comment --comment "kubernetes externally-visible service portals" -j KUBE-EXTERNAL-SERVICES</span>
</span><span id="__span-119-21"><a id="__codelineno-119-21" name="__codelineno-119-21" href="#__codelineno-119-21"></a><span class="go">-A INPUT -j KUBE-FIREWALL</span>
</span><span id="__span-119-22"><a id="__codelineno-119-22" name="__codelineno-119-22" href="#__codelineno-119-22"></a><span class="go">-A FORWARD -m conntrack --ctstate NEW -m comment --comment "kubernetes load balancer firewall" -j KUBE-PROXY-FIREWALL</span>
</span><span id="__span-119-23"><a id="__codelineno-119-23" name="__codelineno-119-23" href="#__codelineno-119-23"></a><span class="go">-A FORWARD -m comment --comment "kubernetes forwarding rules" -j KUBE-FORWARD</span>
</span><span id="__span-119-24"><a id="__codelineno-119-24" name="__codelineno-119-24" href="#__codelineno-119-24"></a><span class="go">-A FORWARD -m conntrack --ctstate NEW -m comment --comment "kubernetes service portals" -j KUBE-SERVICES</span>
</span><span id="__span-119-25"><a id="__codelineno-119-25" name="__codelineno-119-25" href="#__codelineno-119-25"></a><span class="go">-A FORWARD -m conntrack --ctstate NEW -m comment --comment "kubernetes externally-visible service portals" -j KUBE-EXTERNAL-SERVICES</span>
</span><span id="__span-119-26"><a id="__codelineno-119-26" name="__codelineno-119-26" href="#__codelineno-119-26"></a><span class="go">-A FORWARD -j DOCKER-USER</span>
</span><span id="__span-119-27"><a id="__codelineno-119-27" name="__codelineno-119-27" href="#__codelineno-119-27"></a><span class="go">-A FORWARD -m set --match-set docker-ext-bridges-v4 dst -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT</span>
</span><span id="__span-119-28"><a id="__codelineno-119-28" name="__codelineno-119-28" href="#__codelineno-119-28"></a><span class="go">-A FORWARD -j DOCKER-ISOLATION-STAGE-1</span>
</span><span id="__span-119-29"><a id="__codelineno-119-29" name="__codelineno-119-29" href="#__codelineno-119-29"></a><span class="go">-A FORWARD -m set --match-set docker-ext-bridges-v4 dst -j DOCKER</span>
</span><span id="__span-119-30"><a id="__codelineno-119-30" name="__codelineno-119-30" href="#__codelineno-119-30"></a><span class="go">-A FORWARD -i wg0 -j ACCEPT</span>
</span><span id="__span-119-31"><a id="__codelineno-119-31" name="__codelineno-119-31" href="#__codelineno-119-31"></a><span class="go">-A FORWARD -i br-1352dfaa6e69 -j ACCEPT</span>
</span><span id="__span-119-32"><a id="__codelineno-119-32" name="__codelineno-119-32" href="#__codelineno-119-32"></a><span class="go">-A FORWARD -i br-26c076fa82f8 -j ACCEPT</span>
</span><span id="__span-119-33"><a id="__codelineno-119-33" name="__codelineno-119-33" href="#__codelineno-119-33"></a><span class="go">-A FORWARD -i br-f461a8ffa6e0 -j ACCEPT</span>
</span><span id="__span-119-34"><a id="__codelineno-119-34" name="__codelineno-119-34" href="#__codelineno-119-34"></a><span class="go">-A FORWARD -i br-f9783559f0e8 -j ACCEPT</span>
</span><span id="__span-119-35"><a id="__codelineno-119-35" name="__codelineno-119-35" href="#__codelineno-119-35"></a><span class="go">-A FORWARD -i docker0 -j ACCEPT</span>
</span><span id="__span-119-36"><a id="__codelineno-119-36" name="__codelineno-119-36" href="#__codelineno-119-36"></a><span class="go">-A FORWARD -m comment --comment "flanneld forward" -j FLANNEL-FWD</span>
</span><span id="__span-119-37"><a id="__codelineno-119-37" name="__codelineno-119-37" href="#__codelineno-119-37"></a><span class="go">-A OUTPUT -m conntrack --ctstate NEW -m comment --comment "kubernetes load balancer firewall" -j KUBE-PROXY-FIREWALL</span>
</span><span id="__span-119-38"><a id="__codelineno-119-38" name="__codelineno-119-38" href="#__codelineno-119-38"></a><span class="go">-A OUTPUT -m conntrack --ctstate NEW -m comment --comment "kubernetes service portals" -j KUBE-SERVICES</span>
</span><span id="__span-119-39"><a id="__codelineno-119-39" name="__codelineno-119-39" href="#__codelineno-119-39"></a><span class="go">-A OUTPUT -j KUBE-FIREWALL</span>
</span><span id="__span-119-40"><a id="__codelineno-119-40" name="__codelineno-119-40" href="#__codelineno-119-40"></a><span class="go">-A DOCKER -d 172.19.0.4/32 ! -i br-26c076fa82f8 -o br-26c076fa82f8 -p tcp -m tcp --dport 3000 -j ACCEPT</span>
</span><span id="__span-119-41"><a id="__codelineno-119-41" name="__codelineno-119-41" href="#__codelineno-119-41"></a><span class="go">-A DOCKER -d 172.19.0.3/32 ! -i br-26c076fa82f8 -o br-26c076fa82f8 -p tcp -m tcp --dport 8086 -j ACCEPT</span>
</span><span id="__span-119-42"><a id="__codelineno-119-42" name="__codelineno-119-42" href="#__codelineno-119-42"></a><span class="go">-A DOCKER -d 172.19.0.2/32 ! -i br-26c076fa82f8 -o br-26c076fa82f8 -p tcp -m tcp --dport 8125 -j ACCEPT</span>
</span><span id="__span-119-43"><a id="__codelineno-119-43" name="__codelineno-119-43" href="#__codelineno-119-43"></a><span class="go">-A DOCKER ! -i br-1352dfaa6e69 -o br-1352dfaa6e69 -j DROP</span>
</span><span id="__span-119-44"><a id="__codelineno-119-44" name="__codelineno-119-44" href="#__codelineno-119-44"></a><span class="go">-A DOCKER ! -i br-26c076fa82f8 -o br-26c076fa82f8 -j DROP</span>
</span><span id="__span-119-45"><a id="__codelineno-119-45" name="__codelineno-119-45" href="#__codelineno-119-45"></a><span class="go">-A DOCKER ! -i br-f461a8ffa6e0 -o br-f461a8ffa6e0 -j DROP</span>
</span><span id="__span-119-46"><a id="__codelineno-119-46" name="__codelineno-119-46" href="#__codelineno-119-46"></a><span class="go">-A DOCKER ! -i br-f9783559f0e8 -o br-f9783559f0e8 -j DROP</span>
</span><span id="__span-119-47"><a id="__codelineno-119-47" name="__codelineno-119-47" href="#__codelineno-119-47"></a><span class="go">-A DOCKER ! -i docker0 -o docker0 -j DROP</span>
</span><span id="__span-119-48"><a id="__codelineno-119-48" name="__codelineno-119-48" href="#__codelineno-119-48"></a><span class="go">-A DOCKER-ISOLATION-STAGE-1 -i br-1352dfaa6e69 ! -o br-1352dfaa6e69 -j DOCKER-ISOLATION-STAGE-2</span>
</span><span id="__span-119-49"><a id="__codelineno-119-49" name="__codelineno-119-49" href="#__codelineno-119-49"></a><span class="go">-A DOCKER-ISOLATION-STAGE-1 -i br-26c076fa82f8 ! -o br-26c076fa82f8 -j DOCKER-ISOLATION-STAGE-2</span>
</span><span id="__span-119-50"><a id="__codelineno-119-50" name="__codelineno-119-50" href="#__codelineno-119-50"></a><span class="go">-A DOCKER-ISOLATION-STAGE-1 -i br-f461a8ffa6e0 ! -o br-f461a8ffa6e0 -j DOCKER-ISOLATION-STAGE-2</span>
</span><span id="__span-119-51"><a id="__codelineno-119-51" name="__codelineno-119-51" href="#__codelineno-119-51"></a><span class="go">-A DOCKER-ISOLATION-STAGE-1 -i br-f9783559f0e8 ! -o br-f9783559f0e8 -j DOCKER-ISOLATION-STAGE-2</span>
</span><span id="__span-119-52"><a id="__codelineno-119-52" name="__codelineno-119-52" href="#__codelineno-119-52"></a><span class="go">-A DOCKER-ISOLATION-STAGE-1 -i docker0 ! -o docker0 -j DOCKER-ISOLATION-STAGE-2</span>
</span><span id="__span-119-53"><a id="__codelineno-119-53" name="__codelineno-119-53" href="#__codelineno-119-53"></a><span class="go">-A DOCKER-ISOLATION-STAGE-2 -o docker0 -j DROP</span>
</span><span id="__span-119-54"><a id="__codelineno-119-54" name="__codelineno-119-54" href="#__codelineno-119-54"></a><span class="go">-A DOCKER-ISOLATION-STAGE-2 -o br-f9783559f0e8 -j DROP</span>
</span><span id="__span-119-55"><a id="__codelineno-119-55" name="__codelineno-119-55" href="#__codelineno-119-55"></a><span class="go">-A DOCKER-ISOLATION-STAGE-2 -o br-f461a8ffa6e0 -j DROP</span>
</span><span id="__span-119-56"><a id="__codelineno-119-56" name="__codelineno-119-56" href="#__codelineno-119-56"></a><span class="go">-A DOCKER-ISOLATION-STAGE-2 -o br-26c076fa82f8 -j DROP</span>
</span><span id="__span-119-57"><a id="__codelineno-119-57" name="__codelineno-119-57" href="#__codelineno-119-57"></a><span class="go">-A DOCKER-ISOLATION-STAGE-2 -o br-1352dfaa6e69 -j DROP</span>
</span><span id="__span-119-58"><a id="__codelineno-119-58" name="__codelineno-119-58" href="#__codelineno-119-58"></a><span class="go">-A DOCKER-USER -j RETURN</span>
</span><span id="__span-119-59"><a id="__codelineno-119-59" name="__codelineno-119-59" href="#__codelineno-119-59"></a><span class="go">-A FLANNEL-FWD -s 10.244.0.0/16 -m comment --comment "flanneld forward" -j ACCEPT</span>
</span><span id="__span-119-60"><a id="__codelineno-119-60" name="__codelineno-119-60" href="#__codelineno-119-60"></a><span class="go">-A FLANNEL-FWD -d 10.244.0.0/16 -m comment --comment "flanneld forward" -j ACCEPT</span>
</span><span id="__span-119-61"><a id="__codelineno-119-61" name="__codelineno-119-61" href="#__codelineno-119-61"></a><span class="go">-A KUBE-FIREWALL ! -s 127.0.0.0/8 -d 127.0.0.0/8 -m comment --comment "block incoming localnet connections" -m conntrack ! --ctstate RELATED,ESTABLISHED,DNAT -j DROP</span>
</span><span id="__span-119-62"><a id="__codelineno-119-62" name="__codelineno-119-62" href="#__codelineno-119-62"></a><span class="go">-A KUBE-FORWARD -m conntrack --ctstate INVALID -m nfacct --nfacct-name  ct_state_invalid_dropped_pkts -j DROP</span>
</span><span id="__span-119-63"><a id="__codelineno-119-63" name="__codelineno-119-63" href="#__codelineno-119-63"></a><span class="go">-A KUBE-FORWARD -m comment --comment "kubernetes forwarding rules" -j ACCEPT</span>
</span><span id="__span-119-64"><a id="__codelineno-119-64" name="__codelineno-119-64" href="#__codelineno-119-64"></a><span class="go">-A KUBE-FORWARD -m comment --comment "kubernetes forwarding conntrack rule" -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT</span>
</span></code></pre></div>
</details>
<details class="terminal">
<summary><code>pi@alfred:~ $ sudo iptables -nvL</code></summary>
<div class="language-console highlight"><pre><span></span><code><span id="__span-120-1"><a id="__codelineno-120-1" name="__codelineno-120-1" href="#__codelineno-120-1"></a><span class="gp">pi@alfred:~ $ </span>sudo<span class="w"> </span>iptables<span class="w"> </span>-nvL
</span><span id="__span-120-2"><a id="__codelineno-120-2" name="__codelineno-120-2" href="#__codelineno-120-2"></a><span class="go">Chain FORWARD (policy ACCEPT 0 packets, 0 bytes)</span>
</span><span id="__span-120-3"><a id="__codelineno-120-3" name="__codelineno-120-3" href="#__codelineno-120-3"></a><span class="go">pkts bytes target     prot opt in     out     source               destination         </span>
</span><span id="__span-120-4"><a id="__codelineno-120-4" name="__codelineno-120-4" href="#__codelineno-120-4"></a><span class="go">  904 68334 KUBE-PROXY-FIREWALL  0    --  *      *       0.0.0.0/0            0.0.0.0/0            ctstate NEW /* kubernetes load balancer firewall */</span>
</span><span id="__span-120-5"><a id="__codelineno-120-5" name="__codelineno-120-5" href="#__codelineno-120-5"></a><span class="go">7786   25M KUBE-FORWARD  0    --  *      *       0.0.0.0/0            0.0.0.0/0            /* kubernetes forwarding rules */</span>
</span><span id="__span-120-6"><a id="__codelineno-120-6" name="__codelineno-120-6" href="#__codelineno-120-6"></a><span class="go">  904 68334 KUBE-SERVICES  0    --  *      *       0.0.0.0/0            0.0.0.0/0            ctstate NEW /* kubernetes service portals */</span>
</span><span id="__span-120-7"><a id="__codelineno-120-7" name="__codelineno-120-7" href="#__codelineno-120-7"></a><span class="go">  904 68334 KUBE-EXTERNAL-SERVICES  0    --  *      *       0.0.0.0/0            0.0.0.0/0            ctstate NEW /* kubernetes externally-visible service portals */</span>
</span><span id="__span-120-8"><a id="__codelineno-120-8" name="__codelineno-120-8" href="#__codelineno-120-8"></a><span class="go">  904 68334 DOCKER-USER  0    --  *      *       0.0.0.0/0            0.0.0.0/0           </span>
</span><span id="__span-120-9"><a id="__codelineno-120-9" name="__codelineno-120-9" href="#__codelineno-120-9"></a><span class="go">    0     0 ACCEPT     0    --  *      *       0.0.0.0/0            0.0.0.0/0            match-set docker-ext-bridges-v4 dst ctstate RELATED,ESTABLISHED</span>
</span><span id="__span-120-10"><a id="__codelineno-120-10" name="__codelineno-120-10" href="#__codelineno-120-10"></a><span class="go">  904 68334 DOCKER-ISOLATION-STAGE-1  0    --  *      *       0.0.0.0/0            0.0.0.0/0           </span>
</span><span id="__span-120-11"><a id="__codelineno-120-11" name="__codelineno-120-11" href="#__codelineno-120-11"></a><span class="go">    0     0 DOCKER     0    --  *      *       0.0.0.0/0            0.0.0.0/0            match-set docker-ext-bridges-v4 dst</span>
</span><span id="__span-120-12"><a id="__codelineno-120-12" name="__codelineno-120-12" href="#__codelineno-120-12"></a><span class="go">    0     0 ACCEPT     0    --  docker0 *       0.0.0.0/0            0.0.0.0/0           </span>
</span><span id="__span-120-13"><a id="__codelineno-120-13" name="__codelineno-120-13" href="#__codelineno-120-13"></a><span class="go">    0     0 FLANNEL-FWD  0    --  *      *       0.0.0.0/0            0.0.0.0/0            /* flanneld forward */</span>
</span><span id="__span-120-14"><a id="__codelineno-120-14" name="__codelineno-120-14" href="#__codelineno-120-14"></a>
</span><span id="__span-120-15"><a id="__codelineno-120-15" name="__codelineno-120-15" href="#__codelineno-120-15"></a><span class="go">Chain DOCKER (1 references)</span>
</span><span id="__span-120-16"><a id="__codelineno-120-16" name="__codelineno-120-16" href="#__codelineno-120-16"></a><span class="go">pkts bytes target     prot opt in     out     source               destination         </span>
</span><span id="__span-120-17"><a id="__codelineno-120-17" name="__codelineno-120-17" href="#__codelineno-120-17"></a><span class="go">    0     0 DROP       0    --  !docker0 docker0  0.0.0.0/0            0.0.0.0/0           </span>
</span><span id="__span-120-18"><a id="__codelineno-120-18" name="__codelineno-120-18" href="#__codelineno-120-18"></a>
</span><span id="__span-120-19"><a id="__codelineno-120-19" name="__codelineno-120-19" href="#__codelineno-120-19"></a><span class="go">Chain DOCKER-ISOLATION-STAGE-1 (1 references)</span>
</span><span id="__span-120-20"><a id="__codelineno-120-20" name="__codelineno-120-20" href="#__codelineno-120-20"></a><span class="go">pkts bytes target     prot opt in     out     source               destination         </span>
</span><span id="__span-120-21"><a id="__codelineno-120-21" name="__codelineno-120-21" href="#__codelineno-120-21"></a><span class="go">    0     0 DOCKER-ISOLATION-STAGE-2  0    --  docker0 !docker0  0.0.0.0/0            0.0.0.0/0           </span>
</span><span id="__span-120-22"><a id="__codelineno-120-22" name="__codelineno-120-22" href="#__codelineno-120-22"></a>
</span><span id="__span-120-23"><a id="__codelineno-120-23" name="__codelineno-120-23" href="#__codelineno-120-23"></a><span class="go">Chain DOCKER-ISOLATION-STAGE-2 (1 references)</span>
</span><span id="__span-120-24"><a id="__codelineno-120-24" name="__codelineno-120-24" href="#__codelineno-120-24"></a><span class="go">pkts bytes target     prot opt in     out     source               destination         </span>
</span><span id="__span-120-25"><a id="__codelineno-120-25" name="__codelineno-120-25" href="#__codelineno-120-25"></a><span class="go">    0     0 DROP       0    --  *      docker0  0.0.0.0/0            0.0.0.0/0           </span>
</span><span id="__span-120-26"><a id="__codelineno-120-26" name="__codelineno-120-26" href="#__codelineno-120-26"></a>
</span><span id="__span-120-27"><a id="__codelineno-120-27" name="__codelineno-120-27" href="#__codelineno-120-27"></a><span class="go">Chain FLANNEL-FWD (1 references)</span>
</span><span id="__span-120-28"><a id="__codelineno-120-28" name="__codelineno-120-28" href="#__codelineno-120-28"></a><span class="go">pkts bytes target     prot opt in     out     source               destination         </span>
</span><span id="__span-120-29"><a id="__codelineno-120-29" name="__codelineno-120-29" href="#__codelineno-120-29"></a><span class="go">    0     0 ACCEPT     0    --  *      *       10.244.0.0/16        0.0.0.0/0            /* flanneld forward */</span>
</span><span id="__span-120-30"><a id="__codelineno-120-30" name="__codelineno-120-30" href="#__codelineno-120-30"></a><span class="go">    0     0 ACCEPT     0    --  *      *       0.0.0.0/0            10.244.0.0/16        /* flanneld forward */</span>
</span><span id="__span-120-31"><a id="__codelineno-120-31" name="__codelineno-120-31" href="#__codelineno-120-31"></a>
</span><span id="__span-120-32"><a id="__codelineno-120-32" name="__codelineno-120-32" href="#__codelineno-120-32"></a><span class="go">Chain KUBE-EXTERNAL-SERVICES (2 references)</span>
</span><span id="__span-120-33"><a id="__codelineno-120-33" name="__codelineno-120-33" href="#__codelineno-120-33"></a><span class="go">pkts bytes target     prot opt in     out     source               destination         </span>
</span><span id="__span-120-34"><a id="__codelineno-120-34" name="__codelineno-120-34" href="#__codelineno-120-34"></a>
</span><span id="__span-120-35"><a id="__codelineno-120-35" name="__codelineno-120-35" href="#__codelineno-120-35"></a><span class="go">Chain KUBE-FIREWALL (2 references)</span>
</span><span id="__span-120-36"><a id="__codelineno-120-36" name="__codelineno-120-36" href="#__codelineno-120-36"></a><span class="go">pkts bytes target     prot opt in     out     source               destination         </span>
</span><span id="__span-120-37"><a id="__codelineno-120-37" name="__codelineno-120-37" href="#__codelineno-120-37"></a><span class="go">    0     0 DROP       0    --  *      *      !127.0.0.0/8          127.0.0.0/8          /* block incoming localnet connections */ ! ctstate RELATED,ESTABLISHED,DNAT</span>
</span><span id="__span-120-38"><a id="__codelineno-120-38" name="__codelineno-120-38" href="#__codelineno-120-38"></a>
</span><span id="__span-120-39"><a id="__codelineno-120-39" name="__codelineno-120-39" href="#__codelineno-120-39"></a><span class="go">Chain KUBE-FORWARD (1 references)</span>
</span><span id="__span-120-40"><a id="__codelineno-120-40" name="__codelineno-120-40" href="#__codelineno-120-40"></a><span class="go">pkts bytes target     prot opt in     out     source               destination         </span>
</span><span id="__span-120-41"><a id="__codelineno-120-41" name="__codelineno-120-41" href="#__codelineno-120-41"></a><span class="go">    0     0 DROP       0    --  *      *       0.0.0.0/0            0.0.0.0/0            ctstate INVALID nfacct-name  ct_state_invalid_dropped_pkts</span>
</span><span id="__span-120-42"><a id="__codelineno-120-42" name="__codelineno-120-42" href="#__codelineno-120-42"></a><span class="go">    0     0 ACCEPT     0    --  *      *       0.0.0.0/0            0.0.0.0/0            /* kubernetes forwarding rules */ mark match 0x4000/0x4000</span>
</span><span id="__span-120-43"><a id="__codelineno-120-43" name="__codelineno-120-43" href="#__codelineno-120-43"></a><span class="go">    0     0 ACCEPT     0    --  *      *       0.0.0.0/0            0.0.0.0/0            /* kubernetes forwarding conntrack rule */ ctstate RELATED,ESTABLISHED</span>
</span></code></pre></div>
</details>
<details class="terminal">
<summary><code>pi@alfred:~ $ sudo iptables --list-rules</code></summary>
<div class="language-console highlight"><pre><span></span><code><span id="__span-121-1"><a id="__codelineno-121-1" name="__codelineno-121-1" href="#__codelineno-121-1"></a><span class="gp">pi@alfred:~ $ </span>sudo<span class="w"> </span>iptables<span class="w"> </span>--list-rules
</span><span id="__span-121-2"><a id="__codelineno-121-2" name="__codelineno-121-2" href="#__codelineno-121-2"></a><span class="go">-P INPUT ACCEPT</span>
</span><span id="__span-121-3"><a id="__codelineno-121-3" name="__codelineno-121-3" href="#__codelineno-121-3"></a><span class="go">-P FORWARD ACCEPT</span>
</span><span id="__span-121-4"><a id="__codelineno-121-4" name="__codelineno-121-4" href="#__codelineno-121-4"></a><span class="go">-P OUTPUT ACCEPT</span>
</span><span id="__span-121-5"><a id="__codelineno-121-5" name="__codelineno-121-5" href="#__codelineno-121-5"></a><span class="go">-N DOCKER</span>
</span><span id="__span-121-6"><a id="__codelineno-121-6" name="__codelineno-121-6" href="#__codelineno-121-6"></a><span class="go">-N DOCKER-ISOLATION-STAGE-1</span>
</span><span id="__span-121-7"><a id="__codelineno-121-7" name="__codelineno-121-7" href="#__codelineno-121-7"></a><span class="go">-N DOCKER-ISOLATION-STAGE-2</span>
</span><span id="__span-121-8"><a id="__codelineno-121-8" name="__codelineno-121-8" href="#__codelineno-121-8"></a><span class="go">-N DOCKER-USER</span>
</span><span id="__span-121-9"><a id="__codelineno-121-9" name="__codelineno-121-9" href="#__codelineno-121-9"></a><span class="go">-N FLANNEL-FWD</span>
</span><span id="__span-121-10"><a id="__codelineno-121-10" name="__codelineno-121-10" href="#__codelineno-121-10"></a><span class="go">-N KUBE-EXTERNAL-SERVICES</span>
</span><span id="__span-121-11"><a id="__codelineno-121-11" name="__codelineno-121-11" href="#__codelineno-121-11"></a><span class="go">-N KUBE-FIREWALL</span>
</span><span id="__span-121-12"><a id="__codelineno-121-12" name="__codelineno-121-12" href="#__codelineno-121-12"></a><span class="go">-N KUBE-FORWARD</span>
</span><span id="__span-121-13"><a id="__codelineno-121-13" name="__codelineno-121-13" href="#__codelineno-121-13"></a><span class="go">-N KUBE-KUBELET-CANARY</span>
</span><span id="__span-121-14"><a id="__codelineno-121-14" name="__codelineno-121-14" href="#__codelineno-121-14"></a><span class="go">-N KUBE-NODEPORTS</span>
</span><span id="__span-121-15"><a id="__codelineno-121-15" name="__codelineno-121-15" href="#__codelineno-121-15"></a><span class="go">-N KUBE-PROXY-CANARY</span>
</span><span id="__span-121-16"><a id="__codelineno-121-16" name="__codelineno-121-16" href="#__codelineno-121-16"></a><span class="go">-N KUBE-PROXY-FIREWALL</span>
</span><span id="__span-121-17"><a id="__codelineno-121-17" name="__codelineno-121-17" href="#__codelineno-121-17"></a><span class="go">-N KUBE-SERVICES</span>
</span><span id="__span-121-18"><a id="__codelineno-121-18" name="__codelineno-121-18" href="#__codelineno-121-18"></a><span class="go">-A INPUT -m conntrack --ctstate NEW -m comment --comment "kubernetes load balancer firewall" -j KUBE-PROXY-FIREWALL</span>
</span><span id="__span-121-19"><a id="__codelineno-121-19" name="__codelineno-121-19" href="#__codelineno-121-19"></a><span class="go">-A INPUT -m comment --comment "kubernetes health check service ports" -j KUBE-NODEPORTS</span>
</span><span id="__span-121-20"><a id="__codelineno-121-20" name="__codelineno-121-20" href="#__codelineno-121-20"></a><span class="go">-A INPUT -m conntrack --ctstate NEW -m comment --comment "kubernetes externally-visible service portals" -j KUBE-EXTERNAL-SERVICES</span>
</span><span id="__span-121-21"><a id="__codelineno-121-21" name="__codelineno-121-21" href="#__codelineno-121-21"></a><span class="go">-A INPUT -j KUBE-FIREWALL</span>
</span><span id="__span-121-22"><a id="__codelineno-121-22" name="__codelineno-121-22" href="#__codelineno-121-22"></a><span class="go">-A FORWARD -m conntrack --ctstate NEW -m comment --comment "kubernetes load balancer firewall" -j KUBE-PROXY-FIREWALL</span>
</span><span id="__span-121-23"><a id="__codelineno-121-23" name="__codelineno-121-23" href="#__codelineno-121-23"></a><span class="go">-A FORWARD -m comment --comment "kubernetes forwarding rules" -j KUBE-FORWARD</span>
</span><span id="__span-121-24"><a id="__codelineno-121-24" name="__codelineno-121-24" href="#__codelineno-121-24"></a><span class="go">-A FORWARD -m conntrack --ctstate NEW -m comment --comment "kubernetes service portals" -j KUBE-SERVICES</span>
</span><span id="__span-121-25"><a id="__codelineno-121-25" name="__codelineno-121-25" href="#__codelineno-121-25"></a><span class="go">-A FORWARD -m conntrack --ctstate NEW -m comment --comment "kubernetes externally-visible service portals" -j KUBE-EXTERNAL-SERVICES</span>
</span><span id="__span-121-26"><a id="__codelineno-121-26" name="__codelineno-121-26" href="#__codelineno-121-26"></a><span class="go">-A FORWARD -j DOCKER-USER</span>
</span><span id="__span-121-27"><a id="__codelineno-121-27" name="__codelineno-121-27" href="#__codelineno-121-27"></a><span class="go">-A FORWARD -m set --match-set docker-ext-bridges-v4 dst -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT</span>
</span><span id="__span-121-28"><a id="__codelineno-121-28" name="__codelineno-121-28" href="#__codelineno-121-28"></a><span class="go">-A FORWARD -j DOCKER-ISOLATION-STAGE-1</span>
</span><span id="__span-121-29"><a id="__codelineno-121-29" name="__codelineno-121-29" href="#__codelineno-121-29"></a><span class="go">-A FORWARD -m set --match-set docker-ext-bridges-v4 dst -j DOCKER</span>
</span><span id="__span-121-30"><a id="__codelineno-121-30" name="__codelineno-121-30" href="#__codelineno-121-30"></a><span class="go">-A FORWARD -i docker0 -j ACCEPT</span>
</span><span id="__span-121-31"><a id="__codelineno-121-31" name="__codelineno-121-31" href="#__codelineno-121-31"></a><span class="go">-A FORWARD -m comment --comment "flanneld forward" -j FLANNEL-FWD</span>
</span><span id="__span-121-32"><a id="__codelineno-121-32" name="__codelineno-121-32" href="#__codelineno-121-32"></a><span class="go">-A OUTPUT -m conntrack --ctstate NEW -m comment --comment "kubernetes load balancer firewall" -j KUBE-PROXY-FIREWALL</span>
</span><span id="__span-121-33"><a id="__codelineno-121-33" name="__codelineno-121-33" href="#__codelineno-121-33"></a><span class="go">-A OUTPUT -m conntrack --ctstate NEW -m comment --comment "kubernetes service portals" -j KUBE-SERVICES</span>
</span><span id="__span-121-34"><a id="__codelineno-121-34" name="__codelineno-121-34" href="#__codelineno-121-34"></a><span class="go">-A OUTPUT -j KUBE-FIREWALL</span>
</span><span id="__span-121-35"><a id="__codelineno-121-35" name="__codelineno-121-35" href="#__codelineno-121-35"></a><span class="go">-A DOCKER ! -i docker0 -o docker0 -j DROP</span>
</span><span id="__span-121-36"><a id="__codelineno-121-36" name="__codelineno-121-36" href="#__codelineno-121-36"></a><span class="go">-A DOCKER-ISOLATION-STAGE-1 -i docker0 ! -o docker0 -j DOCKER-ISOLATION-STAGE-2</span>
</span><span id="__span-121-37"><a id="__codelineno-121-37" name="__codelineno-121-37" href="#__codelineno-121-37"></a><span class="go">-A DOCKER-ISOLATION-STAGE-2 -o docker0 -j DROP</span>
</span><span id="__span-121-38"><a id="__codelineno-121-38" name="__codelineno-121-38" href="#__codelineno-121-38"></a><span class="go">-A DOCKER-USER -j RETURN</span>
</span><span id="__span-121-39"><a id="__codelineno-121-39" name="__codelineno-121-39" href="#__codelineno-121-39"></a><span class="go">-A FLANNEL-FWD -s 10.244.0.0/16 -m comment --comment "flanneld forward" -j ACCEPT</span>
</span><span id="__span-121-40"><a id="__codelineno-121-40" name="__codelineno-121-40" href="#__codelineno-121-40"></a><span class="go">-A FLANNEL-FWD -d 10.244.0.0/16 -m comment --comment "flanneld forward" -j ACCEPT</span>
</span><span id="__span-121-41"><a id="__codelineno-121-41" name="__codelineno-121-41" href="#__codelineno-121-41"></a><span class="go">-A KUBE-FIREWALL ! -s 127.0.0.0/8 -d 127.0.0.0/8 -m comment --comment "block incoming localnet connections" -m conntrack ! --ctstate RELATED,ESTABLISHED,DNAT -j DROP</span>
</span><span id="__span-121-42"><a id="__codelineno-121-42" name="__codelineno-121-42" href="#__codelineno-121-42"></a><span class="go">-A KUBE-FORWARD -m conntrack --ctstate INVALID -m nfacct --nfacct-name  ct_state_invalid_dropped_pkts -j DROP</span>
</span><span id="__span-121-43"><a id="__codelineno-121-43" name="__codelineno-121-43" href="#__codelineno-121-43"></a><span class="go">-A KUBE-FORWARD -m comment --comment "kubernetes forwarding rules" -m mark --mark 0x4000/0x4000 -j ACCEPT</span>
</span><span id="__span-121-44"><a id="__codelineno-121-44" name="__codelineno-121-44" href="#__codelineno-121-44"></a><span class="go">-A KUBE-FORWARD -m comment --comment "kubernetes forwarding conntrack rule" -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT</span>
</span></code></pre></div>
</details>
<p>Removing those <code>DROP</code> rules did not help:</p>
<ul>
<li><code>sudo iptables -D KUBE-FIREWALL 1</code></li>
<li><code>sudo iptables -D KUBE-FORWARD 1</code></li>
</ul>
<h3 id="https-certificates">HTTPS certificates</h3>
<p>The Kubernetes dashboard uses a self-signed certificate, and so does Nginx by default,
which <em>works</em> in so far as encrypting traffic, but provides no guarantee that the traffic
is coming from the actual servers and is just very annoying when browsers complain every
time accessing the service. It is now time to get properly signed HTTPS certificates.
<em>This is the way</em>.</p>
<h4 id="install-cert-manager">Install <code>cert-manager</code></h4>
<p><a href="https://cert-manager.io/">cert-manager</a> is the native Kubernetes certificate
management controller of choice to issue certificates from Let's Encrypt to
<a href="https://cert-manager.io/docs/tutorials/acme/nginx-ingress/">secure NGINX-ingress</a>.</p>
<p>Having already installed Helm (3.17), deployed the NGINX
<a href="#ingress-controller">Ingress Controller</a>, assigned <code>alfred.uu.am</code> to the
router's external IP address, and deployed the
<a href="#kubernetes-dashboard">Kubernetes dashboard</a> service, the system is ready for
<a href="https://cert-manager.io/docs/tutorials/acme/nginx-ingress/#step-5---deploy-cert-manager">Step 5 - Deploy cert-manager</a>,
<a href="https://cert-manager.io/docs/installation/helm/">installing with Helm</a>:</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-122-1"><a id="__codelineno-122-1" name="__codelineno-122-1" href="#__codelineno-122-1"></a><span class="gp">$ </span>helm<span class="w"> </span>repo<span class="w"> </span>add<span class="w"> </span>jetstack<span class="w"> </span>https://charts.jetstack.io<span class="w"> </span>--force-update
</span><span id="__span-122-2"><a id="__codelineno-122-2" name="__codelineno-122-2" href="#__codelineno-122-2"></a><span class="go">"jetstack" has been added to your repositories</span>
</span><span id="__span-122-3"><a id="__codelineno-122-3" name="__codelineno-122-3" href="#__codelineno-122-3"></a>
</span><span id="__span-122-4"><a id="__codelineno-122-4" name="__codelineno-122-4" href="#__codelineno-122-4"></a><span class="gp">$ </span>helm<span class="w"> </span>install<span class="w"> </span><span class="se">\</span>
</span><span id="__span-122-5"><a id="__codelineno-122-5" name="__codelineno-122-5" href="#__codelineno-122-5"></a><span class="w">    </span>cert-manager<span class="w"> </span>jetstack/cert-manager<span class="w"> </span><span class="se">\</span>
</span><span id="__span-122-6"><a id="__codelineno-122-6" name="__codelineno-122-6" href="#__codelineno-122-6"></a><span class="w">    </span>--namespace<span class="w"> </span>cert-manager<span class="w"> </span><span class="se">\</span>
</span><span id="__span-122-7"><a id="__codelineno-122-7" name="__codelineno-122-7" href="#__codelineno-122-7"></a><span class="w">    </span>--create-namespace<span class="w"> </span><span class="se">\</span>
</span><span id="__span-122-8"><a id="__codelineno-122-8" name="__codelineno-122-8" href="#__codelineno-122-8"></a><span class="w">    </span>--version<span class="w"> </span>v1.17.0<span class="w"> </span><span class="se">\</span>
</span><span id="__span-122-9"><a id="__codelineno-122-9" name="__codelineno-122-9" href="#__codelineno-122-9"></a><span class="w">    </span>--set<span class="w"> </span>crds.enabled<span class="o">=</span><span class="nb">true</span>
</span><span id="__span-122-10"><a id="__codelineno-122-10" name="__codelineno-122-10" href="#__codelineno-122-10"></a><span class="go">NAME: cert-manager</span>
</span><span id="__span-122-11"><a id="__codelineno-122-11" name="__codelineno-122-11" href="#__codelineno-122-11"></a><span class="go">LAST DEPLOYED: Sun Mar 23 17:19:57 2025</span>
</span><span id="__span-122-12"><a id="__codelineno-122-12" name="__codelineno-122-12" href="#__codelineno-122-12"></a><span class="go">NAMESPACE: cert-manager</span>
</span><span id="__span-122-13"><a id="__codelineno-122-13" name="__codelineno-122-13" href="#__codelineno-122-13"></a><span class="go">STATUS: deployed</span>
</span><span id="__span-122-14"><a id="__codelineno-122-14" name="__codelineno-122-14" href="#__codelineno-122-14"></a><span class="go">REVISION: 1</span>
</span><span id="__span-122-15"><a id="__codelineno-122-15" name="__codelineno-122-15" href="#__codelineno-122-15"></a><span class="go">TEST SUITE: None</span>
</span><span id="__span-122-16"><a id="__codelineno-122-16" name="__codelineno-122-16" href="#__codelineno-122-16"></a><span class="go">NOTES:</span>
</span><span id="__span-122-17"><a id="__codelineno-122-17" name="__codelineno-122-17" href="#__codelineno-122-17"></a><span class="go">cert-manager v1.17.0 has been deployed successfully!</span>
</span><span id="__span-122-18"><a id="__codelineno-122-18" name="__codelineno-122-18" href="#__codelineno-122-18"></a>
</span><span id="__span-122-19"><a id="__codelineno-122-19" name="__codelineno-122-19" href="#__codelineno-122-19"></a><span class="go">In order to begin issuing certificates, you will need to set up a ClusterIssuer</span>
</span><span id="__span-122-20"><a id="__codelineno-122-20" name="__codelineno-122-20" href="#__codelineno-122-20"></a><span class="go">or Issuer resource (for example, by creating a 'letsencrypt-staging' issuer).</span>
</span><span id="__span-122-21"><a id="__codelineno-122-21" name="__codelineno-122-21" href="#__codelineno-122-21"></a>
</span><span id="__span-122-22"><a id="__codelineno-122-22" name="__codelineno-122-22" href="#__codelineno-122-22"></a><span class="go">More information on the different types of issuers and how to configure them</span>
</span><span id="__span-122-23"><a id="__codelineno-122-23" name="__codelineno-122-23" href="#__codelineno-122-23"></a><span class="go">can be found in our documentation:</span>
</span><span id="__span-122-24"><a id="__codelineno-122-24" name="__codelineno-122-24" href="#__codelineno-122-24"></a>
</span><span id="__span-122-25"><a id="__codelineno-122-25" name="__codelineno-122-25" href="#__codelineno-122-25"></a><span class="go">https://cert-manager.io/docs/configuration/</span>
</span><span id="__span-122-26"><a id="__codelineno-122-26" name="__codelineno-122-26" href="#__codelineno-122-26"></a>
</span><span id="__span-122-27"><a id="__codelineno-122-27" name="__codelineno-122-27" href="#__codelineno-122-27"></a><span class="go">For information on how to configure cert-manager to automatically provision</span>
</span><span id="__span-122-28"><a id="__codelineno-122-28" name="__codelineno-122-28" href="#__codelineno-122-28"></a><span class="go">Certificates for Ingress resources, take a look at the `ingress-shim`</span>
</span><span id="__span-122-29"><a id="__codelineno-122-29" name="__codelineno-122-29" href="#__codelineno-122-29"></a><span class="go">documentation:</span>
</span><span id="__span-122-30"><a id="__codelineno-122-30" name="__codelineno-122-30" href="#__codelineno-122-30"></a>
</span><span id="__span-122-31"><a id="__codelineno-122-31" name="__codelineno-122-31" href="#__codelineno-122-31"></a><span class="go">https://cert-manager.io/docs/usage/ingress/</span>
</span></code></pre></div>
<p>The <code>helm install</code> command takes several seconds to come back with the above output,
at which point the pods and services are all up and running:</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-123-1"><a id="__codelineno-123-1" name="__codelineno-123-1" href="#__codelineno-123-1"></a><span class="gp">$ </span>kubectl<span class="w"> </span>get<span class="w"> </span>all<span class="w"> </span>-n<span class="w"> </span>cert-manager
</span><span id="__span-123-2"><a id="__codelineno-123-2" name="__codelineno-123-2" href="#__codelineno-123-2"></a><span class="go">NAME                                           READY   STATUS    RESTARTS   AGE</span>
</span><span id="__span-123-3"><a id="__codelineno-123-3" name="__codelineno-123-3" href="#__codelineno-123-3"></a><span class="go">pod/cert-manager-665948465f-2574k              1/1     Running   0          73s</span>
</span><span id="__span-123-4"><a id="__codelineno-123-4" name="__codelineno-123-4" href="#__codelineno-123-4"></a><span class="go">pod/cert-manager-cainjector-7c8f7984fb-6phv2   1/1     Running   0          73s</span>
</span><span id="__span-123-5"><a id="__codelineno-123-5" name="__codelineno-123-5" href="#__codelineno-123-5"></a><span class="go">pod/cert-manager-webhook-7594bcdb99-w4tr9      1/1     Running   0          73s</span>
</span><span id="__span-123-6"><a id="__codelineno-123-6" name="__codelineno-123-6" href="#__codelineno-123-6"></a>
</span><span id="__span-123-7"><a id="__codelineno-123-7" name="__codelineno-123-7" href="#__codelineno-123-7"></a><span class="go">NAME                              TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)            AGE</span>
</span><span id="__span-123-8"><a id="__codelineno-123-8" name="__codelineno-123-8" href="#__codelineno-123-8"></a><span class="go">service/cert-manager              ClusterIP   10.109.245.11    &lt;none&gt;        9402/TCP           73s</span>
</span><span id="__span-123-9"><a id="__codelineno-123-9" name="__codelineno-123-9" href="#__codelineno-123-9"></a><span class="go">service/cert-manager-cainjector   ClusterIP   10.104.227.129   &lt;none&gt;        9402/TCP           73s</span>
</span><span id="__span-123-10"><a id="__codelineno-123-10" name="__codelineno-123-10" href="#__codelineno-123-10"></a><span class="go">service/cert-manager-webhook      ClusterIP   10.104.66.87     &lt;none&gt;        443/TCP,9402/TCP   73s</span>
</span><span id="__span-123-11"><a id="__codelineno-123-11" name="__codelineno-123-11" href="#__codelineno-123-11"></a>
</span><span id="__span-123-12"><a id="__codelineno-123-12" name="__codelineno-123-12" href="#__codelineno-123-12"></a><span class="go">NAME                                      READY   UP-TO-DATE   AVAILABLE   AGE</span>
</span><span id="__span-123-13"><a id="__codelineno-123-13" name="__codelineno-123-13" href="#__codelineno-123-13"></a><span class="go">deployment.apps/cert-manager              1/1     1            1           73s</span>
</span><span id="__span-123-14"><a id="__codelineno-123-14" name="__codelineno-123-14" href="#__codelineno-123-14"></a><span class="go">deployment.apps/cert-manager-cainjector   1/1     1            1           73s</span>
</span><span id="__span-123-15"><a id="__codelineno-123-15" name="__codelineno-123-15" href="#__codelineno-123-15"></a><span class="go">deployment.apps/cert-manager-webhook      1/1     1            1           73s</span>
</span><span id="__span-123-16"><a id="__codelineno-123-16" name="__codelineno-123-16" href="#__codelineno-123-16"></a>
</span><span id="__span-123-17"><a id="__codelineno-123-17" name="__codelineno-123-17" href="#__codelineno-123-17"></a><span class="go">NAME                                                 DESIRED   CURRENT   READY   AGE</span>
</span><span id="__span-123-18"><a id="__codelineno-123-18" name="__codelineno-123-18" href="#__codelineno-123-18"></a><span class="go">replicaset.apps/cert-manager-665948465f              1         1         1       73s</span>
</span><span id="__span-123-19"><a id="__codelineno-123-19" name="__codelineno-123-19" href="#__codelineno-123-19"></a><span class="go">replicaset.apps/cert-manager-cainjector-7c8f7984fb   1         1         1       73s</span>
</span><span id="__span-123-20"><a id="__codelineno-123-20" name="__codelineno-123-20" href="#__codelineno-123-20"></a><span class="go">replicaset.apps/cert-manager-webhook-7594bcdb99      1         1         1       73s</span>
</span></code></pre></div>
<h4 id="test-cert-manager">Test <code>cert-manager</code></h4>
<p><a href="https://cert-manager.io/docs/installation/kubectl/#2-optional-end-to-end-verify-the-installation">Verify the installation</a>
by creating a simple self-signed certificate:</p>
<details class="code">
<summary>Test certificate: <code>test-resources.yaml</code></summary>
<div class="language-yaml highlight"><span class="filename">test-resources.yaml</span><pre><span></span><code><span id="__span-124-1"><a id="__codelineno-124-1" name="__codelineno-124-1" href="#__codelineno-124-1"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
</span><span id="__span-124-2"><a id="__codelineno-124-2" name="__codelineno-124-2" href="#__codelineno-124-2"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Namespace</span>
</span><span id="__span-124-3"><a id="__codelineno-124-3" name="__codelineno-124-3" href="#__codelineno-124-3"></a><span class="nt">metadata</span><span class="p">:</span>
</span><span id="__span-124-4"><a id="__codelineno-124-4" name="__codelineno-124-4" href="#__codelineno-124-4"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cert-manager-test</span>
</span><span id="__span-124-5"><a id="__codelineno-124-5" name="__codelineno-124-5" href="#__codelineno-124-5"></a><span class="nn">---</span>
</span><span id="__span-124-6"><a id="__codelineno-124-6" name="__codelineno-124-6" href="#__codelineno-124-6"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cert-manager.io/v1</span>
</span><span id="__span-124-7"><a id="__codelineno-124-7" name="__codelineno-124-7" href="#__codelineno-124-7"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Issuer</span>
</span><span id="__span-124-8"><a id="__codelineno-124-8" name="__codelineno-124-8" href="#__codelineno-124-8"></a><span class="nt">metadata</span><span class="p">:</span>
</span><span id="__span-124-9"><a id="__codelineno-124-9" name="__codelineno-124-9" href="#__codelineno-124-9"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">test-selfsigned</span>
</span><span id="__span-124-10"><a id="__codelineno-124-10" name="__codelineno-124-10" href="#__codelineno-124-10"></a><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cert-manager-test</span>
</span><span id="__span-124-11"><a id="__codelineno-124-11" name="__codelineno-124-11" href="#__codelineno-124-11"></a><span class="nt">spec</span><span class="p">:</span>
</span><span id="__span-124-12"><a id="__codelineno-124-12" name="__codelineno-124-12" href="#__codelineno-124-12"></a><span class="w">  </span><span class="nt">selfSigned</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{}</span>
</span><span id="__span-124-13"><a id="__codelineno-124-13" name="__codelineno-124-13" href="#__codelineno-124-13"></a><span class="nn">---</span>
</span><span id="__span-124-14"><a id="__codelineno-124-14" name="__codelineno-124-14" href="#__codelineno-124-14"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cert-manager.io/v1</span>
</span><span id="__span-124-15"><a id="__codelineno-124-15" name="__codelineno-124-15" href="#__codelineno-124-15"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Certificate</span>
</span><span id="__span-124-16"><a id="__codelineno-124-16" name="__codelineno-124-16" href="#__codelineno-124-16"></a><span class="nt">metadata</span><span class="p">:</span>
</span><span id="__span-124-17"><a id="__codelineno-124-17" name="__codelineno-124-17" href="#__codelineno-124-17"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">selfsigned-cert</span>
</span><span id="__span-124-18"><a id="__codelineno-124-18" name="__codelineno-124-18" href="#__codelineno-124-18"></a><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cert-manager-test</span>
</span><span id="__span-124-19"><a id="__codelineno-124-19" name="__codelineno-124-19" href="#__codelineno-124-19"></a><span class="nt">spec</span><span class="p">:</span>
</span><span id="__span-124-20"><a id="__codelineno-124-20" name="__codelineno-124-20" href="#__codelineno-124-20"></a><span class="w">  </span><span class="nt">dnsNames</span><span class="p">:</span>
</span><span id="__span-124-21"><a id="__codelineno-124-21" name="__codelineno-124-21" href="#__codelineno-124-21"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">example.com</span>
</span><span id="__span-124-22"><a id="__codelineno-124-22" name="__codelineno-124-22" href="#__codelineno-124-22"></a><span class="w">  </span><span class="nt">secretName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">selfsigned-cert-tls</span>
</span><span id="__span-124-23"><a id="__codelineno-124-23" name="__codelineno-124-23" href="#__codelineno-124-23"></a><span class="w">  </span><span class="nt">issuerRef</span><span class="p">:</span>
</span><span id="__span-124-24"><a id="__codelineno-124-24" name="__codelineno-124-24" href="#__codelineno-124-24"></a><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">test-selfsigned</span>
</span></code></pre></div>
</details>
<p>Deploying this succeeds withing seconds, after which it can be cleaned up:</p>
<details class="terminal">
<summary><code>kubectl apply -f test-resources.yaml</code></summary>
<div class="language-console highlight"><pre><span></span><code><span id="__span-125-1"><a id="__codelineno-125-1" name="__codelineno-125-1" href="#__codelineno-125-1"></a><span class="gp">$ </span>kubectl<span class="w"> </span>apply<span class="w"> </span>-f<span class="w"> </span>test-resources.yaml
</span><span id="__span-125-2"><a id="__codelineno-125-2" name="__codelineno-125-2" href="#__codelineno-125-2"></a><span class="go">namespace/cert-manager-test created</span>
</span><span id="__span-125-3"><a id="__codelineno-125-3" name="__codelineno-125-3" href="#__codelineno-125-3"></a><span class="go">issuer.cert-manager.io/test-selfsigned created</span>
</span><span id="__span-125-4"><a id="__codelineno-125-4" name="__codelineno-125-4" href="#__codelineno-125-4"></a><span class="go">certificate.cert-manager.io/selfsigned-cert created</span>
</span><span id="__span-125-5"><a id="__codelineno-125-5" name="__codelineno-125-5" href="#__codelineno-125-5"></a>
</span><span id="__span-125-6"><a id="__codelineno-125-6" name="__codelineno-125-6" href="#__codelineno-125-6"></a><span class="gp">$ </span>kubectl<span class="w"> </span>describe<span class="w"> </span>certificate<span class="w"> </span>-n<span class="w"> </span>cert-manager-test
</span><span id="__span-125-7"><a id="__codelineno-125-7" name="__codelineno-125-7" href="#__codelineno-125-7"></a><span class="go">Name:         selfsigned-cert</span>
</span><span id="__span-125-8"><a id="__codelineno-125-8" name="__codelineno-125-8" href="#__codelineno-125-8"></a><span class="go">Namespace:    cert-manager-test</span>
</span><span id="__span-125-9"><a id="__codelineno-125-9" name="__codelineno-125-9" href="#__codelineno-125-9"></a><span class="go">Labels:       &lt;none&gt;</span>
</span><span id="__span-125-10"><a id="__codelineno-125-10" name="__codelineno-125-10" href="#__codelineno-125-10"></a><span class="go">Annotations:  &lt;none&gt;</span>
</span><span id="__span-125-11"><a id="__codelineno-125-11" name="__codelineno-125-11" href="#__codelineno-125-11"></a><span class="go">API Version:  cert-manager.io/v1</span>
</span><span id="__span-125-12"><a id="__codelineno-125-12" name="__codelineno-125-12" href="#__codelineno-125-12"></a><span class="go">Kind:         Certificate</span>
</span><span id="__span-125-13"><a id="__codelineno-125-13" name="__codelineno-125-13" href="#__codelineno-125-13"></a><span class="go">Metadata:</span>
</span><span id="__span-125-14"><a id="__codelineno-125-14" name="__codelineno-125-14" href="#__codelineno-125-14"></a><span class="go">  Creation Timestamp:  2025-03-23T16:32:58Z</span>
</span><span id="__span-125-15"><a id="__codelineno-125-15" name="__codelineno-125-15" href="#__codelineno-125-15"></a><span class="go">  Generation:          1</span>
</span><span id="__span-125-16"><a id="__codelineno-125-16" name="__codelineno-125-16" href="#__codelineno-125-16"></a><span class="go">  Resource Version:    2931074</span>
</span><span id="__span-125-17"><a id="__codelineno-125-17" name="__codelineno-125-17" href="#__codelineno-125-17"></a><span class="go">  UID:                 f0646ae2-8344-45a0-a453-f46ba16400b6</span>
</span><span id="__span-125-18"><a id="__codelineno-125-18" name="__codelineno-125-18" href="#__codelineno-125-18"></a><span class="go">Spec:</span>
</span><span id="__span-125-19"><a id="__codelineno-125-19" name="__codelineno-125-19" href="#__codelineno-125-19"></a><span class="go">  Dns Names:</span>
</span><span id="__span-125-20"><a id="__codelineno-125-20" name="__codelineno-125-20" href="#__codelineno-125-20"></a><span class="go">    example.com</span>
</span><span id="__span-125-21"><a id="__codelineno-125-21" name="__codelineno-125-21" href="#__codelineno-125-21"></a><span class="go">  Issuer Ref:</span>
</span><span id="__span-125-22"><a id="__codelineno-125-22" name="__codelineno-125-22" href="#__codelineno-125-22"></a><span class="go">    Name:       test-selfsigned</span>
</span><span id="__span-125-23"><a id="__codelineno-125-23" name="__codelineno-125-23" href="#__codelineno-125-23"></a><span class="go">  Secret Name:  selfsigned-cert-tls</span>
</span><span id="__span-125-24"><a id="__codelineno-125-24" name="__codelineno-125-24" href="#__codelineno-125-24"></a><span class="go">Status:</span>
</span><span id="__span-125-25"><a id="__codelineno-125-25" name="__codelineno-125-25" href="#__codelineno-125-25"></a><span class="go">  Conditions:</span>
</span><span id="__span-125-26"><a id="__codelineno-125-26" name="__codelineno-125-26" href="#__codelineno-125-26"></a><span class="go">    Last Transition Time:  2025-03-23T16:32:59Z</span>
</span><span id="__span-125-27"><a id="__codelineno-125-27" name="__codelineno-125-27" href="#__codelineno-125-27"></a><span class="go">    Message:               Certificate is up to date and has not expired</span>
</span><span id="__span-125-28"><a id="__codelineno-125-28" name="__codelineno-125-28" href="#__codelineno-125-28"></a><span class="go">    Observed Generation:   1</span>
</span><span id="__span-125-29"><a id="__codelineno-125-29" name="__codelineno-125-29" href="#__codelineno-125-29"></a><span class="go">    Reason:                Ready</span>
</span><span id="__span-125-30"><a id="__codelineno-125-30" name="__codelineno-125-30" href="#__codelineno-125-30"></a><span class="go">    Status:                True</span>
</span><span id="__span-125-31"><a id="__codelineno-125-31" name="__codelineno-125-31" href="#__codelineno-125-31"></a><span class="go">    Type:                  Ready</span>
</span><span id="__span-125-32"><a id="__codelineno-125-32" name="__codelineno-125-32" href="#__codelineno-125-32"></a><span class="go">  Not After:               2025-06-21T16:32:59Z</span>
</span><span id="__span-125-33"><a id="__codelineno-125-33" name="__codelineno-125-33" href="#__codelineno-125-33"></a><span class="go">  Not Before:              2025-03-23T16:32:59Z</span>
</span><span id="__span-125-34"><a id="__codelineno-125-34" name="__codelineno-125-34" href="#__codelineno-125-34"></a><span class="go">  Renewal Time:            2025-05-22T16:32:59Z</span>
</span><span id="__span-125-35"><a id="__codelineno-125-35" name="__codelineno-125-35" href="#__codelineno-125-35"></a><span class="go">  Revision:                1</span>
</span><span id="__span-125-36"><a id="__codelineno-125-36" name="__codelineno-125-36" href="#__codelineno-125-36"></a><span class="go">Events:</span>
</span><span id="__span-125-37"><a id="__codelineno-125-37" name="__codelineno-125-37" href="#__codelineno-125-37"></a><span class="go">  Type    Reason     Age   From                                       Message</span>
</span><span id="__span-125-38"><a id="__codelineno-125-38" name="__codelineno-125-38" href="#__codelineno-125-38"></a><span class="go">  ----    ------     ----  ----                                       -------</span>
</span><span id="__span-125-39"><a id="__codelineno-125-39" name="__codelineno-125-39" href="#__codelineno-125-39"></a><span class="go">  Normal  Issuing    6s    cert-manager-certificates-trigger          Issuing certificate as Secret does not exist</span>
</span><span id="__span-125-40"><a id="__codelineno-125-40" name="__codelineno-125-40" href="#__codelineno-125-40"></a><span class="go">  Normal  Generated  5s    cert-manager-certificates-key-manager      Stored new private key in temporary Secret resource "selfsigned-cert-g9cv2"</span>
</span><span id="__span-125-41"><a id="__codelineno-125-41" name="__codelineno-125-41" href="#__codelineno-125-41"></a><span class="go">  Normal  Requested  5s    cert-manager-certificates-request-manager  Created new CertificateRequest resource "selfsigned-cert-1"</span>
</span><span id="__span-125-42"><a id="__codelineno-125-42" name="__codelineno-125-42" href="#__codelineno-125-42"></a><span class="go">  Normal  Issuing    5s    cert-manager-certificates-issuing          The certificate has been successfully issued</span>
</span><span id="__span-125-43"><a id="__codelineno-125-43" name="__codelineno-125-43" href="#__codelineno-125-43"></a>
</span><span id="__span-125-44"><a id="__codelineno-125-44" name="__codelineno-125-44" href="#__codelineno-125-44"></a><span class="gp">$ </span>kubectl<span class="w"> </span>delete<span class="w"> </span>-f<span class="w"> </span>test-resources.yaml
</span><span id="__span-125-45"><a id="__codelineno-125-45" name="__codelineno-125-45" href="#__codelineno-125-45"></a><span class="go">namespace "cert-manager-test" deleted</span>
</span><span id="__span-125-46"><a id="__codelineno-125-46" name="__codelineno-125-46" href="#__codelineno-125-46"></a><span class="go">issuer.cert-manager.io "test-selfsigned" deleted</span>
</span><span id="__span-125-47"><a id="__codelineno-125-47" name="__codelineno-125-47" href="#__codelineno-125-47"></a><span class="go">certificate.cert-manager.io "selfsigned-cert" deleted</span>
</span></code></pre></div>
</details>
<h4 id="configure-lets-encrypt">Configure Let's Encrypt</h4>
<p><a href="https://cert-manager.io/docs/tutorials/acme/nginx-ingress/#step-6---configure-a-lets-encrypt-issuer">Step 6 - Configure a Let's Encrypt Issuer</a>
shows how to create an <code>Issuer</code>, but in this system with multiple services running in
different namespaces, a <code>ClusterIssuer</code> is needed instead:</p>
<div class="language-yaml highlight"><span class="filename">cert-manager-issuer.yaml</span><pre><span></span><code><span id="__span-126-1"><a id="__codelineno-126-1" name="__codelineno-126-1" href="#__codelineno-126-1"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cert-manager.io/v1</span>
</span><span id="__span-126-2"><a id="__codelineno-126-2" name="__codelineno-126-2" href="#__codelineno-126-2"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ClusterIssuer</span>
</span><span id="__span-126-3"><a id="__codelineno-126-3" name="__codelineno-126-3" href="#__codelineno-126-3"></a><span class="nt">metadata</span><span class="p">:</span>
</span><span id="__span-126-4"><a id="__codelineno-126-4" name="__codelineno-126-4" href="#__codelineno-126-4"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">letsencrypt-prod</span>
</span><span id="__span-126-5"><a id="__codelineno-126-5" name="__codelineno-126-5" href="#__codelineno-126-5"></a><span class="nt">spec</span><span class="p">:</span>
</span><span id="__span-126-6"><a id="__codelineno-126-6" name="__codelineno-126-6" href="#__codelineno-126-6"></a><span class="w">  </span><span class="nt">acme</span><span class="p">:</span>
</span><span id="__span-126-7"><a id="__codelineno-126-7" name="__codelineno-126-7" href="#__codelineno-126-7"></a><span class="w">    </span><span class="nt">server</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">https://acme-v02.api.letsencrypt.org/directory</span>
</span><span id="__span-126-8"><a id="__codelineno-126-8" name="__codelineno-126-8" href="#__codelineno-126-8"></a><span class="w">    </span><span class="nt">email</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">stibbons@uu.am</span>
</span><span id="__span-126-9"><a id="__codelineno-126-9" name="__codelineno-126-9" href="#__codelineno-126-9"></a><span class="w">    </span><span class="nt">privateKeySecretRef</span><span class="p">:</span>
</span><span id="__span-126-10"><a id="__codelineno-126-10" name="__codelineno-126-10" href="#__codelineno-126-10"></a><span class="w">      </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">letsencrypt-prod</span>
</span><span id="__span-126-11"><a id="__codelineno-126-11" name="__codelineno-126-11" href="#__codelineno-126-11"></a><span class="w">    </span><span class="nt">solvers</span><span class="p">:</span>
</span><span id="__span-126-12"><a id="__codelineno-126-12" name="__codelineno-126-12" href="#__codelineno-126-12"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">http01</span><span class="p">:</span>
</span><span id="__span-126-13"><a id="__codelineno-126-13" name="__codelineno-126-13" href="#__codelineno-126-13"></a><span class="w">          </span><span class="nt">ingress</span><span class="p">:</span>
</span><span id="__span-126-14"><a id="__codelineno-126-14" name="__codelineno-126-14" href="#__codelineno-126-14"></a><span class="w">            </span><span class="nt">class</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nginx</span>
</span></code></pre></div>
<div class="language-console highlight"><pre><span></span><code><span id="__span-127-1"><a id="__codelineno-127-1" name="__codelineno-127-1" href="#__codelineno-127-1"></a><span class="gp">$ </span>kubectl<span class="w"> </span>create<span class="w"> </span>-f<span class="w"> </span>cert-manager-issuer.yaml
</span><span id="__span-127-2"><a id="__codelineno-127-2" name="__codelineno-127-2" href="#__codelineno-127-2"></a><span class="go">clusterissuer.cert-manager.io/letsencrypt-prod created</span>
</span><span id="__span-127-3"><a id="__codelineno-127-3" name="__codelineno-127-3" href="#__codelineno-127-3"></a>
</span><span id="__span-127-4"><a id="__codelineno-127-4" name="__codelineno-127-4" href="#__codelineno-127-4"></a><span class="gp">$ </span>kubectl<span class="w"> </span>describe<span class="w"> </span>clusterissuer.cert-manager.io/letsencrypt-prod
</span><span id="__span-127-5"><a id="__codelineno-127-5" name="__codelineno-127-5" href="#__codelineno-127-5"></a><span class="go">Name:         letsencrypt-prod</span>
</span><span id="__span-127-6"><a id="__codelineno-127-6" name="__codelineno-127-6" href="#__codelineno-127-6"></a><span class="go">Namespace:    </span>
</span><span id="__span-127-7"><a id="__codelineno-127-7" name="__codelineno-127-7" href="#__codelineno-127-7"></a><span class="go">Labels:       &lt;none&gt;</span>
</span><span id="__span-127-8"><a id="__codelineno-127-8" name="__codelineno-127-8" href="#__codelineno-127-8"></a><span class="go">Annotations:  &lt;none&gt;</span>
</span><span id="__span-127-9"><a id="__codelineno-127-9" name="__codelineno-127-9" href="#__codelineno-127-9"></a><span class="go">API Version:  cert-manager.io/v1</span>
</span><span id="__span-127-10"><a id="__codelineno-127-10" name="__codelineno-127-10" href="#__codelineno-127-10"></a><span class="go">Kind:         ClusterIssuer</span>
</span><span id="__span-127-11"><a id="__codelineno-127-11" name="__codelineno-127-11" href="#__codelineno-127-11"></a><span class="go">Metadata:</span>
</span><span id="__span-127-12"><a id="__codelineno-127-12" name="__codelineno-127-12" href="#__codelineno-127-12"></a><span class="go">  Creation Timestamp:  2025-03-23T19:11:39Z</span>
</span><span id="__span-127-13"><a id="__codelineno-127-13" name="__codelineno-127-13" href="#__codelineno-127-13"></a><span class="go">  Generation:          1</span>
</span><span id="__span-127-14"><a id="__codelineno-127-14" name="__codelineno-127-14" href="#__codelineno-127-14"></a><span class="go">  Resource Version:    2945998</span>
</span><span id="__span-127-15"><a id="__codelineno-127-15" name="__codelineno-127-15" href="#__codelineno-127-15"></a><span class="go">  UID:                 f75d8154-b858-4c3b-ae70-c1cb632f7d7c</span>
</span><span id="__span-127-16"><a id="__codelineno-127-16" name="__codelineno-127-16" href="#__codelineno-127-16"></a><span class="go">Spec:</span>
</span><span id="__span-127-17"><a id="__codelineno-127-17" name="__codelineno-127-17" href="#__codelineno-127-17"></a><span class="go">  Acme:</span>
</span><span id="__span-127-18"><a id="__codelineno-127-18" name="__codelineno-127-18" href="#__codelineno-127-18"></a><span class="go">    Email:  stibbons@uu.am</span>
</span><span id="__span-127-19"><a id="__codelineno-127-19" name="__codelineno-127-19" href="#__codelineno-127-19"></a><span class="go">    Private Key Secret Ref:</span>
</span><span id="__span-127-20"><a id="__codelineno-127-20" name="__codelineno-127-20" href="#__codelineno-127-20"></a><span class="go">      Name:  letsencrypt-prod</span>
</span><span id="__span-127-21"><a id="__codelineno-127-21" name="__codelineno-127-21" href="#__codelineno-127-21"></a><span class="go">    Server:  https://acme-v02.api.letsencrypt.org/directory</span>
</span><span id="__span-127-22"><a id="__codelineno-127-22" name="__codelineno-127-22" href="#__codelineno-127-22"></a><span class="go">    Solvers:</span>
</span><span id="__span-127-23"><a id="__codelineno-127-23" name="__codelineno-127-23" href="#__codelineno-127-23"></a><span class="go">      http01:</span>
</span><span id="__span-127-24"><a id="__codelineno-127-24" name="__codelineno-127-24" href="#__codelineno-127-24"></a><span class="go">        Ingress:</span>
</span><span id="__span-127-25"><a id="__codelineno-127-25" name="__codelineno-127-25" href="#__codelineno-127-25"></a><span class="go">          Class:  nginx</span>
</span><span id="__span-127-26"><a id="__codelineno-127-26" name="__codelineno-127-26" href="#__codelineno-127-26"></a><span class="go">Status:</span>
</span><span id="__span-127-27"><a id="__codelineno-127-27" name="__codelineno-127-27" href="#__codelineno-127-27"></a><span class="go">  Acme:</span>
</span><span id="__span-127-28"><a id="__codelineno-127-28" name="__codelineno-127-28" href="#__codelineno-127-28"></a><span class="go">    Last Private Key Hash:  M7S/jp7wvlxuzt4QTkelCzWNe5SqfhFZpqfAcNSOZL0=</span>
</span><span id="__span-127-29"><a id="__codelineno-127-29" name="__codelineno-127-29" href="#__codelineno-127-29"></a><span class="go">    Last Registered Email:  stibbons@uu.am</span>
</span><span id="__span-127-30"><a id="__codelineno-127-30" name="__codelineno-127-30" href="#__codelineno-127-30"></a><span class="go">    Uri:                    https://acme-v02.api.letsencrypt.org/acme/acct/2298686296</span>
</span><span id="__span-127-31"><a id="__codelineno-127-31" name="__codelineno-127-31" href="#__codelineno-127-31"></a><span class="go">  Conditions:</span>
</span><span id="__span-127-32"><a id="__codelineno-127-32" name="__codelineno-127-32" href="#__codelineno-127-32"></a><span class="go">    Last Transition Time:  2025-03-23T19:11:40Z</span>
</span><span id="__span-127-33"><a id="__codelineno-127-33" name="__codelineno-127-33" href="#__codelineno-127-33"></a><span class="go">    Message:               The ACME account was registered with the ACME server</span>
</span><span id="__span-127-34"><a id="__codelineno-127-34" name="__codelineno-127-34" href="#__codelineno-127-34"></a><span class="go">    Observed Generation:   1</span>
</span><span id="__span-127-35"><a id="__codelineno-127-35" name="__codelineno-127-35" href="#__codelineno-127-35"></a><span class="go">    Reason:                ACMEAccountRegistered</span>
</span><span id="__span-127-36"><a id="__codelineno-127-36" name="__codelineno-127-36" href="#__codelineno-127-36"></a><span class="go">    Status:                True</span>
</span><span id="__span-127-37"><a id="__codelineno-127-37" name="__codelineno-127-37" href="#__codelineno-127-37"></a><span class="go">    Type:                  Ready</span>
</span><span id="__span-127-38"><a id="__codelineno-127-38" name="__codelineno-127-38" href="#__codelineno-127-38"></a><span class="go">Events:                    &lt;none&gt;</span>
</span></code></pre></div>
<h4 id="secure-kubernetes-dashboard-ingress">Secure Kubernetes Dashboard Ingress</h4>
<p><a href="https://cert-manager.io/docs/tutorials/acme/nginx-ingress/#step-7---deploy-a-tls-ingress-resource">Step 7 - Deploy a TLS Ingress Resource</a>
is the last step left to actually make pratical use of all the above. Based on the
provided example, apply the equivalent changes to <code>dashboard/nginx-ingress.yaml</code>,
using <code>cert-manager.io/cluster-issuer</code> instead of <code>cert-manager.io/issuer</code> and adding the
<code>tls</code> section with just the relevant FQDN under <code>hosts</code>:</p>
<div class="language-yaml highlight"><span class="filename">dashboard/nginx-ingress.yaml</span><pre><span></span><code><span id="__span-128-1"><a id="__codelineno-128-1" name="__codelineno-128-1" href="#__codelineno-128-1"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">networking.k8s.io/v1</span>
</span><span id="__span-128-2"><a id="__codelineno-128-2" name="__codelineno-128-2" href="#__codelineno-128-2"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Ingress</span>
</span><span id="__span-128-3"><a id="__codelineno-128-3" name="__codelineno-128-3" href="#__codelineno-128-3"></a><span class="nt">metadata</span><span class="p">:</span>
</span><span id="__span-128-4"><a id="__codelineno-128-4" name="__codelineno-128-4" href="#__codelineno-128-4"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">kubernetes-dashboard-ingress</span>
</span><span id="__span-128-5"><a id="__codelineno-128-5" name="__codelineno-128-5" href="#__codelineno-128-5"></a><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">kubernetes-dashboard</span>
</span><span id="__span-128-6"><a id="__codelineno-128-6" name="__codelineno-128-6" href="#__codelineno-128-6"></a><span class="w">  </span><span class="nt">annotations</span><span class="p">:</span>
</span><span id="__span-128-7"><a id="__codelineno-128-7" name="__codelineno-128-7" href="#__codelineno-128-7"></a><span class="hll"><span class="w">    </span><span class="nt">cert-manager.io/cluster-issuer</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">letsencrypt-prod</span>
</span></span><span id="__span-128-8"><a id="__codelineno-128-8" name="__codelineno-128-8" href="#__codelineno-128-8"></a><span class="w">    </span><span class="nt">nginx.ingress.kubernetes.io/backend-protocol</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">HTTPS</span>
</span><span id="__span-128-9"><a id="__codelineno-128-9" name="__codelineno-128-9" href="#__codelineno-128-9"></a><span class="w">    </span><span class="nt">nginx.ingress.kubernetes.io/auth-tls-verify-client</span><span class="p">:</span><span class="w"> </span><span class="s">"false"</span>
</span><span id="__span-128-10"><a id="__codelineno-128-10" name="__codelineno-128-10" href="#__codelineno-128-10"></a><span class="w">    </span><span class="nt">nginx.ingress.kubernetes.io/whitelist-source-range</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10.244.0.0/16</span>
</span><span id="__span-128-11"><a id="__codelineno-128-11" name="__codelineno-128-11" href="#__codelineno-128-11"></a><span class="w">    </span><span class="nt">nginx.ingress.kubernetes.io/configuration-snippet</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
</span><span id="__span-128-12"><a id="__codelineno-128-12" name="__codelineno-128-12" href="#__codelineno-128-12"></a><span class="w">      </span><span class="no">more_set_headers "server: hide";</span>
</span><span id="__span-128-13"><a id="__codelineno-128-13" name="__codelineno-128-13" href="#__codelineno-128-13"></a><span class="nt">spec</span><span class="p">:</span>
</span><span id="__span-128-14"><a id="__codelineno-128-14" name="__codelineno-128-14" href="#__codelineno-128-14"></a><span class="w">  </span><span class="nt">ingressClassName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nginx</span>
</span><span id="__span-128-15"><a id="__codelineno-128-15" name="__codelineno-128-15" href="#__codelineno-128-15"></a><span class="w">  </span><span class="nt">rules</span><span class="p">:</span>
</span><span id="__span-128-16"><a id="__codelineno-128-16" name="__codelineno-128-16" href="#__codelineno-128-16"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">host</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">k8s.alfred.uu.am</span>
</span><span id="__span-128-17"><a id="__codelineno-128-17" name="__codelineno-128-17" href="#__codelineno-128-17"></a><span class="w">      </span><span class="nt">http</span><span class="p">:</span>
</span><span id="__span-128-18"><a id="__codelineno-128-18" name="__codelineno-128-18" href="#__codelineno-128-18"></a><span class="w">        </span><span class="nt">paths</span><span class="p">:</span>
</span><span id="__span-128-19"><a id="__codelineno-128-19" name="__codelineno-128-19" href="#__codelineno-128-19"></a><span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/</span>
</span><span id="__span-128-20"><a id="__codelineno-128-20" name="__codelineno-128-20" href="#__codelineno-128-20"></a><span class="w">            </span><span class="nt">pathType</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Prefix</span>
</span><span id="__span-128-21"><a id="__codelineno-128-21" name="__codelineno-128-21" href="#__codelineno-128-21"></a><span class="w">            </span><span class="nt">backend</span><span class="p">:</span>
</span><span id="__span-128-22"><a id="__codelineno-128-22" name="__codelineno-128-22" href="#__codelineno-128-22"></a><span class="w">              </span><span class="nt">service</span><span class="p">:</span>
</span><span id="__span-128-23"><a id="__codelineno-128-23" name="__codelineno-128-23" href="#__codelineno-128-23"></a><span class="w">                </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">kubernetes-dashboard-kong-proxy</span>
</span><span id="__span-128-24"><a id="__codelineno-128-24" name="__codelineno-128-24" href="#__codelineno-128-24"></a><span class="w">                </span><span class="nt">port</span><span class="p">:</span>
</span><span id="__span-128-25"><a id="__codelineno-128-25" name="__codelineno-128-25" href="#__codelineno-128-25"></a><span class="w">                  </span><span class="nt">number</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">443</span>
</span><span id="__span-128-26"><a id="__codelineno-128-26" name="__codelineno-128-26" href="#__codelineno-128-26"></a><span class="hll"><span class="w">  </span><span class="nt">tls</span><span class="p">:</span>
</span></span><span id="__span-128-27"><a id="__codelineno-128-27" name="__codelineno-128-27" href="#__codelineno-128-27"></a><span class="hll"><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">secretName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">tls-secret</span>
</span></span><span id="__span-128-28"><a id="__codelineno-128-28" name="__codelineno-128-28" href="#__codelineno-128-28"></a><span class="hll"><span class="w">      </span><span class="nt">hosts</span><span class="p">:</span>
</span></span><span id="__span-128-29"><a id="__codelineno-128-29" name="__codelineno-128-29" href="#__codelineno-128-29"></a><span class="hll"><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">k8s.alfred.uu.am</span>
</span></span></code></pre></div>
<p>Re-apply this deployment to trigger the request for a certificate signed by Let's Encrypt:</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-129-1"><a id="__codelineno-129-1" name="__codelineno-129-1" href="#__codelineno-129-1"></a><span class="gp">$ </span>kubectl<span class="w"> </span>apply<span class="w"> </span>-f<span class="w"> </span>dashboard/nginx-ingress.yaml
</span><span id="__span-129-2"><a id="__codelineno-129-2" name="__codelineno-129-2" href="#__codelineno-129-2"></a><span class="go">ingress.networking.k8s.io/kubernetes-dashboard-ingress configured</span>
</span></code></pre></div>
<p>Now there will be a pending order and challenge for a new certificate, so it is
time to forward the router's external port 80 to the <code>NodePort</code> of the ACME solver:</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-130-1"><a id="__codelineno-130-1" name="__codelineno-130-1" href="#__codelineno-130-1"></a><span class="gp">$ </span>kubectl<span class="w"> </span>get<span class="w"> </span>svc<span class="w"> </span>-A<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>acme
</span><span id="__span-130-2"><a id="__codelineno-130-2" name="__codelineno-130-2" href="#__codelineno-130-2"></a><span class="go">kubernetes-dashboard   cm-acme-http-solver-b9ckt              NodePort    10.96.223.114    &lt;none&gt;        8089:31453/TCP               13s</span>
</span></code></pre></div>
<p>The pod behind the service is listening and the logs can be monitored in real time:</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-131-1"><a id="__codelineno-131-1" name="__codelineno-131-1" href="#__codelineno-131-1"></a><span class="gp">$ </span>kubectl<span class="w"> </span>-n<span class="w"> </span>kubernetes-dashboard<span class="w"> </span>logs<span class="w"> </span><span class="se">\</span>
</span><span id="__span-131-2"><a id="__codelineno-131-2" name="__codelineno-131-2" href="#__codelineno-131-2"></a><span class="gp">  $</span><span class="o">(</span>kubectl<span class="w"> </span>get<span class="w"> </span>pods<span class="w"> </span>-n<span class="w"> </span>kubernetes-dashboard<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>acme<span class="w"> </span><span class="p">|</span><span class="w"> </span>cut<span class="w"> </span>-f1<span class="w"> </span>-d<span class="s1">' '</span><span class="o">)</span><span class="w"> </span>-f
</span><span id="__span-131-3"><a id="__codelineno-131-3" name="__codelineno-131-3" href="#__codelineno-131-3"></a>
</span><span id="__span-131-4"><a id="__codelineno-131-4" name="__codelineno-131-4" href="#__codelineno-131-4"></a><span class="go">I0323 20:44:32.293925       1 solver.go:52] "starting listener" logger="cert-manager.acmesolver" expected_domain="k8s.alfred.uu.am" expected_token="Ib9C-k31rDjp2A5SH7jmELo4F0VNBvOfWzXg6Mu6YWc" expected_key="Ib9C-k31rDjp2A5SH7jmELo4F0VNBvOfWzXg6Mu6YWc.AiIi2mdeMBlCng6As7epqFyP8bmjSGQqxIdEbnstHEo" listen_port=8089</span>
</span></code></pre></div>
<p>Now, instead of forwarding directly to the <code>NodePort</code> of <em>this</em> ACME resolver, it is more convinient to update the router's forwarding rules only once, to forward port the
external port 80 to the node's port <strong>32080</strong>, and then <code>patch</code> the ACME resolve
service to
<a href="https://stackoverflow.com/questions/65789509/kubernetes-how-to-change-service-ports-using-patch">change the service's NodePort</a>.</p>
<p>The <code>patch</code> command is directed at the specific ACME resolver service in each namespace:</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-132-1"><a id="__codelineno-132-1" name="__codelineno-132-1" href="#__codelineno-132-1"></a><span class="gp">$ </span>kubectl<span class="w"> </span>-n<span class="w"> </span>kubernetes-dashboard<span class="w"> </span>patch<span class="w"> </span><span class="se">\</span>
</span><span id="__span-132-2"><a id="__codelineno-132-2" name="__codelineno-132-2" href="#__codelineno-132-2"></a><span class="w">    </span>service<span class="w"> </span>cm-acme-http-solver-b9ckt<span class="w"> </span><span class="se">\</span>
</span><span id="__span-132-3"><a id="__codelineno-132-3" name="__codelineno-132-3" href="#__codelineno-132-3"></a><span class="w">     </span>-p<span class="w"> </span><span class="s1">'{"spec":{"ports": [{"port": 8089, "nodePort": 32080}]}}'</span>
</span><span id="__span-132-4"><a id="__codelineno-132-4" name="__codelineno-132-4" href="#__codelineno-132-4"></a><span class="go">service/cm-acme-http-solver-b9ckt patched</span>
</span><span id="__span-132-5"><a id="__codelineno-132-5" name="__codelineno-132-5" href="#__codelineno-132-5"></a>
</span><span id="__span-132-6"><a id="__codelineno-132-6" name="__codelineno-132-6" href="#__codelineno-132-6"></a><span class="gp">$ </span>kubectl<span class="w"> </span>get<span class="w"> </span>svc<span class="w"> </span>-A<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>acme
</span><span id="__span-132-7"><a id="__codelineno-132-7" name="__codelineno-132-7" href="#__codelineno-132-7"></a><span class="go">kubernetes-dashboard   cm-acme-http-solver-b9ckt              NodePort    10.96.223.114    &lt;none&gt;        8089:32080/TCP               5m24s</span>
</span></code></pre></div>
<p>Once the service is patched, the external connection reaches the resolver pod and the
renewal is completed very shortly, which then deletes the pod and service. At that point, the command above to monitor the pod's logs will terminate when the pods
finishes:</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-133-1"><a id="__codelineno-133-1" name="__codelineno-133-1" href="#__codelineno-133-1"></a>I0323 20:49:58.055831       1 solver.go:104] "comparing token" logger="cert-manager.acmesolver" host="k8s.alfred.uu.am" path="/.well-known/acme-challenge/Ib9C-k31rDjp2A5SH7jmELo4F0VNBvOfWzXg6Mu6YWc" base_path="/.well-known/acme-challenge" token="Ib9C-k31rDjp2A5SH7jmELo4F0VNBvOfWzXg6Mu6YWc" headers={"Accept":["*/*"],"Accept-Encoding":["gzip"],"Connection":["close"],"User-Agent":["Mozilla/5.0 (compatible; Let's Encrypt validation server; +https://www.letsencrypt.org)"]} expected_token="Ib9C-k31rDjp2A5SH7jmELo4F0VNBvOfWzXg6Mu6YWc"
</span><span id="__span-133-2"><a id="__codelineno-133-2" name="__codelineno-133-2" href="#__codelineno-133-2"></a><span class="hll">I0323 20:49:58.055843       1 solver.go:112] "got successful challenge request, writing key" logger="cert-manager.acmesolver" host="k8s.alfred.uu.am" path="/.well-known/acme-challenge/Ib9C-k31rDjp2A5SH7jmELo4F0VNBvOfWzXg6Mu6YWc" base_path="/.well-known/acme-challenge" token="Ib9C-k31rDjp2A5SH7jmELo4F0VNBvOfWzXg6Mu6YWc" headers={"Accept":["*/*"],"Accept-Encoding":["gzip"],"Connection":["close"],"User-Agent":["Mozilla/5.0 (compatible; Let's Encrypt validation server; +https://www.letsencrypt.org)"]}
</span></span><span id="__span-133-3"><a id="__codelineno-133-3" name="__codelineno-133-3" href="#__codelineno-133-3"></a>E0323 20:49:59.002384       1 main.go:42] "error executing command" err="http: Server closed" logger="cert-manager"
</span></code></pre></div>
<p>From now on, accessing the Kubernetes dashboard at
<a href="https://k8s.alfred.uu.am/">https://k8s.alfred.uu.am/</a> will no longer result in browsers
complaining about the connection not being secure.</p>
<h4 id="automatic-renovation">Automatic renovation</h4>
<p>The above technique to <code>patch</code> each ACME resolver service can be extended to automatically
patch each service when it is found running:</p>
<div class="language-bash highlight"><span class="filename">cert-renewal-port-fwd.sh</span><pre><span></span><code><span id="__span-134-1"><a id="__codelineno-134-1" name="__codelineno-134-1" href="#__codelineno-134-1"></a><span class="ch">#!/bin/bash</span>
</span><span id="__span-134-2"><a id="__codelineno-134-2" name="__codelineno-134-2" href="#__codelineno-134-2"></a><span class="c1">#</span>
</span><span id="__span-134-3"><a id="__codelineno-134-3" name="__codelineno-134-3" href="#__codelineno-134-3"></a><span class="c1"># Patch the nodePort of running cert-manager renewal challenge, to listen</span>
</span><span id="__span-134-4"><a id="__codelineno-134-4" name="__codelineno-134-4" href="#__codelineno-134-4"></a><span class="c1"># on port 32080 which is the one the router is forwarding port 80 to.</span>
</span><span id="__span-134-5"><a id="__codelineno-134-5" name="__codelineno-134-5" href="#__codelineno-134-5"></a>
</span><span id="__span-134-6"><a id="__codelineno-134-6" name="__codelineno-134-6" href="#__codelineno-134-6"></a><span class="c1"># Check if there is a LetsEncrypt challenge resolver (acme) running.</span>
</span><span id="__span-134-7"><a id="__codelineno-134-7" name="__codelineno-134-7" href="#__codelineno-134-7"></a><span class="nb">export</span><span class="w"> </span><span class="nv">KUBECONFIG</span><span class="o">=</span>/etc/kubernetes/admin.conf
</span><span id="__span-134-8"><a id="__codelineno-134-8" name="__codelineno-134-8" href="#__codelineno-134-8"></a><span class="nv">namespace</span><span class="o">=</span><span class="k">$(</span>kubectl<span class="w"> </span>get<span class="w"> </span>svc<span class="w"> </span>-A<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>acme<span class="w"> </span><span class="p">|</span><span class="w"> </span>awk<span class="w"> </span><span class="s1">'{print $1}'</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>head<span class="w"> </span>-1<span class="k">)</span>
</span><span id="__span-134-9"><a id="__codelineno-134-9" name="__codelineno-134-9" href="#__codelineno-134-9"></a><span class="nv">service</span><span class="o">=</span><span class="k">$(</span>kubectl<span class="w"> </span>get<span class="w"> </span>svc<span class="w"> </span>-A<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>acme<span class="w"> </span><span class="p">|</span><span class="w"> </span>awk<span class="w"> </span><span class="s1">'{print $2}'</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>head<span class="w"> </span>-1<span class="k">)</span>
</span><span id="__span-134-10"><a id="__codelineno-134-10" name="__codelineno-134-10" href="#__codelineno-134-10"></a>
</span><span id="__span-134-11"><a id="__codelineno-134-11" name="__codelineno-134-11" href="#__codelineno-134-11"></a><span class="c1"># Patch the service to listen on port 32080 (set up in router).</span>
</span><span id="__span-134-12"><a id="__codelineno-134-12" name="__codelineno-134-12" href="#__codelineno-134-12"></a><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span>-n<span class="w"> </span><span class="s2">"</span><span class="si">${</span><span class="nv">namespace</span><span class="si">}</span><span class="s2">"</span><span class="w"> </span><span class="o">]</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">[</span><span class="w"> </span>-n<span class="w"> </span><span class="s2">"</span><span class="si">${</span><span class="nv">service</span><span class="si">}</span><span class="s2">"</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
</span><span id="__span-134-13"><a id="__codelineno-134-13" name="__codelineno-134-13" href="#__codelineno-134-13"></a><span class="w">    </span>kubectl<span class="w"> </span>-n<span class="w"> </span><span class="s2">"</span><span class="si">${</span><span class="nv">namespace</span><span class="si">}</span><span class="s2">"</span><span class="w"> </span>patch<span class="w"> </span>service<span class="w"> </span><span class="s2">"</span><span class="si">${</span><span class="nv">service</span><span class="si">}</span><span class="s2">"</span><span class="w"> </span>-p<span class="w"> </span><span class="s1">'{"spec":{"ports": [{"port": 8089, "nodePort":32080}]}}'</span>
</span><span id="__span-134-14"><a id="__codelineno-134-14" name="__codelineno-134-14" href="#__codelineno-134-14"></a><span class="k">fi</span>
</span></code></pre></div>
<p>Install this script in a convenient location and setup <code>crontab</code> to run it hourly:</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-135-1"><a id="__codelineno-135-1" name="__codelineno-135-1" href="#__codelineno-135-1"></a># Hourly patch montly cert renewal solvers.
</span><span id="__span-135-2"><a id="__codelineno-135-2" name="__codelineno-135-2" href="#__codelineno-135-2"></a>30 * * * * /home/pi/cert-renewal-port-fwd.sh
</span></code></pre></div>
<h2 id="cloudflare-tunnel">Cloudflare Tunnel</h2>
<p>Although during the installation process this system was behind a router that
supported port forwarding, so that ports 80 and 443 could be made available
externally, the final destination may not provide this facility. To cope with
an enviromeent without port forwarding capabilities, and/or a static IPv4
address, or possibly even CGNAT in the future, a Cloudflare tunnel will be used.</p>
<h3 id="install-cloudflared">Install <code>cloudflared</code></h3>
<p>Install the latest <code>cloudflared</code> using the instructions provided for
<a href="https://pkg.cloudflare.com/index.html#debian-any">Any Debian Based Distribution</a>:</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-136-1"><a id="__codelineno-136-1" name="__codelineno-136-1" href="#__codelineno-136-1"></a><span class="gp"># </span>curl<span class="w"> </span>-fsSL<span class="w"> </span>https://pkg.cloudflare.com/cloudflare-main.gpg<span class="w"> </span><span class="se">\</span>
</span><span id="__span-136-2"><a id="__codelineno-136-2" name="__codelineno-136-2" href="#__codelineno-136-2"></a><span class="w">  </span><span class="p">|</span><span class="w"> </span>tee<span class="w"> </span>/usr/share/keyrings/cloudflare-main.gpg<span class="w"> </span>&gt;/dev/null
</span><span id="__span-136-3"><a id="__codelineno-136-3" name="__codelineno-136-3" href="#__codelineno-136-3"></a>
</span><span id="__span-136-4"><a id="__codelineno-136-4" name="__codelineno-136-4" href="#__codelineno-136-4"></a><span class="gp"># </span><span class="nb">echo</span><span class="w"> </span><span class="s1">'deb [signed-by=/usr/share/keyrings/cloudflare-main.gpg] https://pkg.cloudflare.com/cloudflared any main'</span><span class="w"> </span><span class="se">\</span>
</span><span id="__span-136-5"><a id="__codelineno-136-5" name="__codelineno-136-5" href="#__codelineno-136-5"></a><span class="w">  </span><span class="p">|</span><span class="w"> </span>tee<span class="w"> </span>/etc/apt/sources.list.d/cloudflared.list
</span><span id="__span-136-6"><a id="__codelineno-136-6" name="__codelineno-136-6" href="#__codelineno-136-6"></a>
</span><span id="__span-136-7"><a id="__codelineno-136-7" name="__codelineno-136-7" href="#__codelineno-136-7"></a><span class="gp"># </span>install<span class="w"> </span>cloudflared
</span><span id="__span-136-8"><a id="__codelineno-136-8" name="__codelineno-136-8" href="#__codelineno-136-8"></a><span class="go">sudo apt-get update &amp;&amp; sudo apt-get install cloudflared</span>
</span></code></pre></div>
<h3 id="create-a-tunnel">Create a tunnel</h3>
<details class="note">
<summary> Cloudflare requires <strong>adding a site</strong> before creating a tunnel.</summary>
<p>Before creating a tunnel, Cloudflare requires 
<a href="../../../03/28/remote-access-options-for-self-hosted-services/#add-a-site/">adding a site</a>,
which in turn requires updating DNS settins in a domain,
as well as on Cloudflare, all of which can take hours to take effect.</p>
</details>
<details class="tip">
<summary><code>very-very-dark-gray.top</code> is an example cheap domain.</summary>
<p><code>very-very-dark-gray.top</code> is an example cheap domain, probably not great
for public or customer-facing applications, but should be fine for purely
self-hosted personal applications.</p>
</details>
<p><a href="https://developers.cloudflare.com/cloudflare-one/connections/connect-networks/get-started/create-remote-tunnel/">Create a tunnel</a>
named <code>alfred</code> using <code>cloudflared</code> as the connector. Cloudflare will provide the
commands to run, including installating the connector (already done) and connecting
the tunnel:</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-137-1"><a id="__codelineno-137-1" name="__codelineno-137-1" href="#__codelineno-137-1"></a>$ sudo cloudflared service install eyJhIjoiMD...
</span><span id="__span-137-2"><a id="__codelineno-137-2" name="__codelineno-137-2" href="#__codelineno-137-2"></a>2025-03-29T10:07:08Z INF Using Systemd
</span><span id="__span-137-3"><a id="__codelineno-137-3" name="__codelineno-137-3" href="#__codelineno-137-3"></a>2025-03-29T10:07:10Z INF Linux service for cloudflared installed successfully
</span></code></pre></div>
<div class="admonition note">
<p class="admonition-title">The token in the command is much longer that Cloudflare shows.</p>
</div>
<p>A few seconds after running the commmand, the Cloudflare console will show the
tunnel as <strong>Connected</strong>; otherwise something is blocking it.</p>
<h4 id="public-hostnames">Public hostnames</h4>
<p>Once the tunnel is working, access to the
<a href="#kubernetes-dashboard-ingress">Kubernetes dashboard ingress</a> can be enabled
by adding a <strong>public hostname</strong> to make <code>localhost:32035</code> (the <code>NodePort</code> of Nginx,
using <strong>HTTPS</strong>), or the <code>LoadBalancer</code> IP, available <em>behind</em>
<a href="https://kubernetes-alfred.very-very-dark-gray.top/">https://kubernetes-alfred.very-very-dark-gray.top/</a>.</p>
<p>Make sure to <strong>enable <em>No TLS Verify</em></strong> under <em>Additional application settings
&gt; TLS</em> because Nginx will not be using the certificate from Let's Encrypt.</p>
<p>Before Cloudflare <em>can</em> reach the Kubernetes dashboard through that URL,
an additional <code>host</code> rule must be added to the
<a href="#kubernetes-dashboard-ingress">Kubernetes Dashboard Ingress</a>, so that
Nginx knows to route requests with that <code>Host</code> value to the right service.
Otherwise, Nginx will not find anything matching that URL:</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-138-1"><a id="__codelineno-138-1" name="__codelineno-138-1" href="#__codelineno-138-1"></a><span class="gp">$ </span>curl<span class="w"> </span><span class="m">2</span>&gt;/dev/null<span class="w"> </span><span class="se">\</span>
</span><span id="__span-138-2"><a id="__codelineno-138-2" name="__codelineno-138-2" href="#__codelineno-138-2"></a><span class="w">  </span>-H<span class="w"> </span><span class="s2">"Host: kubernetes-alfred.very-very-dark-gray.top"</span><span class="w"> </span><span class="se">\</span>
</span><span id="__span-138-3"><a id="__codelineno-138-3" name="__codelineno-138-3" href="#__codelineno-138-3"></a><span class="w">  </span>-k<span class="w"> </span>https://192.168.0.151/<span class="w"> </span><span class="se">\</span>
</span><span id="__span-138-4"><a id="__codelineno-138-4" name="__codelineno-138-4" href="#__codelineno-138-4"></a><span class="p">|</span><span class="w"> </span>head
</span><span id="__span-138-5"><a id="__codelineno-138-5" name="__codelineno-138-5" href="#__codelineno-138-5"></a><span class="go">&lt;html&gt;</span>
</span><span id="__span-138-6"><a id="__codelineno-138-6" name="__codelineno-138-6" href="#__codelineno-138-6"></a><span class="go">&lt;head&gt;&lt;title&gt;404 Not Found&lt;/title&gt;&lt;/head&gt;</span>
</span><span id="__span-138-7"><a id="__codelineno-138-7" name="__codelineno-138-7" href="#__codelineno-138-7"></a><span class="go">&lt;body&gt;</span>
</span><span id="__span-138-8"><a id="__codelineno-138-8" name="__codelineno-138-8" href="#__codelineno-138-8"></a><span class="go">&lt;center&gt;&lt;h1&gt;404 Not Found&lt;/h1&gt;&lt;/center&gt;</span>
</span><span id="__span-138-9"><a id="__codelineno-138-9" name="__codelineno-138-9" href="#__codelineno-138-9"></a><span class="go">&lt;hr&gt;&lt;center&gt;nginx&lt;/center&gt;</span>
</span><span id="__span-138-10"><a id="__codelineno-138-10" name="__codelineno-138-10" href="#__codelineno-138-10"></a><span class="go">&lt;/body&gt;</span>
</span><span id="__span-138-11"><a id="__codelineno-138-11" name="__codelineno-138-11" href="#__codelineno-138-11"></a><span class="go">&lt;/html&gt;</span>
</span><span id="__span-138-12"><a id="__codelineno-138-12" name="__codelineno-138-12" href="#__codelineno-138-12"></a>
</span><span id="__span-138-13"><a id="__codelineno-138-13" name="__codelineno-138-13" href="#__codelineno-138-13"></a><span class="gp">$ </span>curl<span class="w"> </span><span class="m">2</span>&gt;/dev/null<span class="w"> </span><span class="se">\</span>
</span><span id="__span-138-14"><a id="__codelineno-138-14" name="__codelineno-138-14" href="#__codelineno-138-14"></a><span class="w">  </span>-H<span class="w"> </span><span class="s2">"Host: kubernetes-alfred.very-very-dark-gray.top"</span><span class="w"> </span><span class="se">\</span>
</span><span id="__span-138-15"><a id="__codelineno-138-15" name="__codelineno-138-15" href="#__codelineno-138-15"></a><span class="w">  </span>-k<span class="w"> </span>https://192.168.0.124:32035/<span class="w"> </span><span class="se">\</span>
</span><span id="__span-138-16"><a id="__codelineno-138-16" name="__codelineno-138-16" href="#__codelineno-138-16"></a><span class="p">|</span><span class="w"> </span>head
</span><span id="__span-138-17"><a id="__codelineno-138-17" name="__codelineno-138-17" href="#__codelineno-138-17"></a><span class="go">&lt;html&gt;</span>
</span><span id="__span-138-18"><a id="__codelineno-138-18" name="__codelineno-138-18" href="#__codelineno-138-18"></a><span class="go">&lt;head&gt;&lt;title&gt;404 Not Found&lt;/title&gt;&lt;/head&gt;</span>
</span><span id="__span-138-19"><a id="__codelineno-138-19" name="__codelineno-138-19" href="#__codelineno-138-19"></a><span class="go">&lt;body&gt;</span>
</span><span id="__span-138-20"><a id="__codelineno-138-20" name="__codelineno-138-20" href="#__codelineno-138-20"></a><span class="go">&lt;center&gt;&lt;h1&gt;404 Not Found&lt;/h1&gt;&lt;/center&gt;</span>
</span><span id="__span-138-21"><a id="__codelineno-138-21" name="__codelineno-138-21" href="#__codelineno-138-21"></a><span class="go">&lt;hr&gt;&lt;center&gt;nginx&lt;/center&gt;</span>
</span><span id="__span-138-22"><a id="__codelineno-138-22" name="__codelineno-138-22" href="#__codelineno-138-22"></a><span class="go">&lt;/body&gt;</span>
</span><span id="__span-138-23"><a id="__codelineno-138-23" name="__codelineno-138-23" href="#__codelineno-138-23"></a><span class="go">&lt;/html&gt;</span>
</span></code></pre></div>
<p>A rule for <code>host: kubernetes-alfred.very-very-dark-gray.top</code> must be added:</p>
<div class="language-yaml highlight"><table class="highlighttable"><tbody><tr><th colspan="2" class="filename"><span class="filename">dashboard/nginx-ingress.yaml</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-139-14">14</a></span>
<span class="normal"><a href="#__codelineno-139-15">15</a></span>
<span class="normal"><a href="#__codelineno-139-16">16</a></span>
<span class="normal"><a href="#__codelineno-139-17">17</a></span>
<span class="normal"><a href="#__codelineno-139-18">18</a></span>
<span class="normal"><a href="#__codelineno-139-19">19</a></span>
<span class="normal"><a href="#__codelineno-139-20">20</a></span>
<span class="normal"><a href="#__codelineno-139-21">21</a></span>
<span class="normal"><a href="#__codelineno-139-22">22</a></span>
<span class="normal"><a href="#__codelineno-139-23">23</a></span>
<span class="normal"><a href="#__codelineno-139-24">24</a></span>
<span class="normal"><a href="#__codelineno-139-25">25</a></span>
<span class="normal"><a href="#__codelineno-139-26">26</a></span>
<span class="normal"><a href="#__codelineno-139-27">27</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-139-14"><a id="__codelineno-139-14" name="__codelineno-139-14"></a><span class="nt">spec</span><span class="p">:</span>
</span><span id="__span-139-15"><a id="__codelineno-139-15" name="__codelineno-139-15"></a><span class="w">  </span><span class="nt">ingressClassName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nginx</span>
</span><span id="__span-139-16"><a id="__codelineno-139-16" name="__codelineno-139-16"></a><span class="w">  </span><span class="nt">rules</span><span class="p">:</span>
</span><span id="__span-139-17"><a id="__codelineno-139-17" name="__codelineno-139-17"></a><span class="hll"><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">host</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">kubernetes-alfred.very-very-dark-gray.top</span>
</span></span><span id="__span-139-18"><a id="__codelineno-139-18" name="__codelineno-139-18"></a><span class="hll"><span class="w">      </span><span class="nt">http</span><span class="p">:</span>
</span></span><span id="__span-139-19"><a id="__codelineno-139-19" name="__codelineno-139-19"></a><span class="hll"><span class="w">        </span><span class="nt">paths</span><span class="p">:</span>
</span></span><span id="__span-139-20"><a id="__codelineno-139-20" name="__codelineno-139-20"></a><span class="hll"><span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/</span>
</span></span><span id="__span-139-21"><a id="__codelineno-139-21" name="__codelineno-139-21"></a><span class="hll"><span class="w">            </span><span class="nt">pathType</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Prefix</span>
</span></span><span id="__span-139-22"><a id="__codelineno-139-22" name="__codelineno-139-22"></a><span class="hll"><span class="w">            </span><span class="nt">backend</span><span class="p">:</span>
</span></span><span id="__span-139-23"><a id="__codelineno-139-23" name="__codelineno-139-23"></a><span class="hll"><span class="w">              </span><span class="nt">service</span><span class="p">:</span>
</span></span><span id="__span-139-24"><a id="__codelineno-139-24" name="__codelineno-139-24"></a><span class="hll"><span class="w">                </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">kubernetes-dashboard-kong-proxy</span>
</span></span><span id="__span-139-25"><a id="__codelineno-139-25" name="__codelineno-139-25"></a><span class="hll"><span class="w">                </span><span class="nt">port</span><span class="p">:</span>
</span></span><span id="__span-139-26"><a id="__codelineno-139-26" name="__codelineno-139-26"></a><span class="hll"><span class="w">                  </span><span class="nt">number</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">443</span>
</span></span><span id="__span-139-27"><a id="__codelineno-139-27" name="__codelineno-139-27"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">host</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">k8s.alfred.uu.am</span>
</span></code></pre></div></td></tr></tbody></table></div>
<p>After applying this change, the <code>kubernetes-dashboard-kong-proxy</code> service is
available <em>behind</em> <code>kubernetes-alfred.very-very-dark-gray.top</code>:</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-140-1"><a id="__codelineno-140-1" name="__codelineno-140-1" href="#__codelineno-140-1"></a><span class="gp">$ </span>kubectl<span class="w"> </span>apply<span class="w"> </span>-f<span class="w"> </span>dashboard/nginx-ingress.yaml
</span><span id="__span-140-2"><a id="__codelineno-140-2" name="__codelineno-140-2" href="#__codelineno-140-2"></a><span class="go">ingress.networking.k8s.io/kubernetes-dashboard-ingress created</span>
</span><span id="__span-140-3"><a id="__codelineno-140-3" name="__codelineno-140-3" href="#__codelineno-140-3"></a>
</span><span id="__span-140-4"><a id="__codelineno-140-4" name="__codelineno-140-4" href="#__codelineno-140-4"></a><span class="gp">$ </span>curl<span class="w"> </span><span class="m">2</span>&gt;/dev/null<span class="w"> </span><span class="se">\</span>
</span><span id="__span-140-5"><a id="__codelineno-140-5" name="__codelineno-140-5" href="#__codelineno-140-5"></a><span class="w">  </span>-H<span class="w"> </span><span class="s2">"Host: kubernetes-alfred.very-very-dark-gray.top"</span><span class="w"> </span><span class="se">\</span>
</span><span id="__span-140-6"><a id="__codelineno-140-6" name="__codelineno-140-6" href="#__codelineno-140-6"></a><span class="w">  </span>-k<span class="w"> </span>https://192.168.0.151/<span class="w"> </span><span class="se">\</span>
</span><span id="__span-140-7"><a id="__codelineno-140-7" name="__codelineno-140-7" href="#__codelineno-140-7"></a><span class="p">|</span><span class="w"> </span>head
</span><span id="__span-140-8"><a id="__codelineno-140-8" name="__codelineno-140-8" href="#__codelineno-140-8"></a><span class="go">&lt;!--</span>
</span><span id="__span-140-9"><a id="__codelineno-140-9" name="__codelineno-140-9" href="#__codelineno-140-9"></a><span class="go">Copyright 2017 The Kubernetes Authors.</span>
</span><span id="__span-140-10"><a id="__codelineno-140-10" name="__codelineno-140-10" href="#__codelineno-140-10"></a>
</span><span id="__span-140-11"><a id="__codelineno-140-11" name="__codelineno-140-11" href="#__codelineno-140-11"></a><span class="go">Licensed under the Apache License, Version 2.0 (the "License");</span>
</span><span id="__span-140-12"><a id="__codelineno-140-12" name="__codelineno-140-12" href="#__codelineno-140-12"></a><span class="go">you may not use this file except in compliance with the License.</span>
</span><span id="__span-140-13"><a id="__codelineno-140-13" name="__codelineno-140-13" href="#__codelineno-140-13"></a><span class="go">You may obtain a copy of the License at</span>
</span><span id="__span-140-14"><a id="__codelineno-140-14" name="__codelineno-140-14" href="#__codelineno-140-14"></a>
</span><span id="__span-140-15"><a id="__codelineno-140-15" name="__codelineno-140-15" href="#__codelineno-140-15"></a><span class="go">    http://www.apache.org/licenses/LICENSE-2.0</span>
</span></code></pre></div>
<p><a href="https://kubernetes-alfred.very-very-dark-gray.top/">https://kubernetes-alfred.very-very-dark-gray.top/</a>
will now lead to the Kubernetes dashboard, through its own HTTPS tunnel,
provided all the configurations have been applied correctly.</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-141-1"><a id="__codelineno-141-1" name="__codelineno-141-1" href="#__codelineno-141-1"></a><span class="gp">$ </span>curl<span class="w"> </span><span class="m">2</span>&gt;/dev/null<span class="w"> </span><span class="se">\</span>
</span><span id="__span-141-2"><a id="__codelineno-141-2" name="__codelineno-141-2" href="#__codelineno-141-2"></a><span class="w">  </span>-k<span class="w"> </span>https://kubernetes-alfred.very-very-dark-gray.top/<span class="w"> </span><span class="se">\</span>
</span><span id="__span-141-3"><a id="__codelineno-141-3" name="__codelineno-141-3" href="#__codelineno-141-3"></a><span class="p">|</span><span class="w"> </span>head
</span><span id="__span-141-4"><a id="__codelineno-141-4" name="__codelineno-141-4" href="#__codelineno-141-4"></a><span class="go">&lt;!--</span>
</span><span id="__span-141-5"><a id="__codelineno-141-5" name="__codelineno-141-5" href="#__codelineno-141-5"></a><span class="go">Copyright 2017 The Kubernetes Authors.</span>
</span><span id="__span-141-6"><a id="__codelineno-141-6" name="__codelineno-141-6" href="#__codelineno-141-6"></a>
</span><span id="__span-141-7"><a id="__codelineno-141-7" name="__codelineno-141-7" href="#__codelineno-141-7"></a><span class="go">Licensed under the Apache License, Version 2.0 (the "License");</span>
</span><span id="__span-141-8"><a id="__codelineno-141-8" name="__codelineno-141-8" href="#__codelineno-141-8"></a><span class="go">you may not use this file except in compliance with the License.</span>
</span><span id="__span-141-9"><a id="__codelineno-141-9" name="__codelineno-141-9" href="#__codelineno-141-9"></a><span class="go">You may obtain a copy of the License at</span>
</span><span id="__span-141-10"><a id="__codelineno-141-10" name="__codelineno-141-10" href="#__codelineno-141-10"></a>
</span><span id="__span-141-11"><a id="__codelineno-141-11" name="__codelineno-141-11" href="#__codelineno-141-11"></a><span class="go">    http://www.apache.org/licenses/LICENSE-2.0</span>
</span></code></pre></div>
<h4 id="troubleshooting-public-hostnames">Troubleshooting public hostnames</h4>
<details class="warning">
<summary>Do not try using multi-level domains.</summary>
<p>If the same hostname is added as <code>kubernetes.alfred.very-very-dark-gray.top</code>
that's a 2nd-level domain and connections will fail, e.g. in Firefox with
<code>SSL_ERROR_NO_CYPHER_OVERLAP</code> (and <code>curl</code> is also unable to connect)</p>
<p>The reason for this to fail is that the Cloudflare 
<a href="https://developers.cloudflare.com/ssl/edge-certificates/universal-ssl/">Universal SSL certificates</a>
only cover apex domain and one level of subdomain; see
<a href="https://developers.cloudflare.com/ssl/troubleshooting/version-cipher-mismatch/#multi-level-subdomains">Multi-level subdomains</a>.</p>
</details>
<details class="warning">
<summary>Don't forget to <strong>enable</strong> <strong>No TLS Verify</strong>.</summary>
<p>If <strong>No TLS Verify</strong> is not enabled, the <strong>502 Bad Gateway</strong> page will
continue to show, because Cloudflare won't accept connecting to Nginx with
the default self-signed certificate. This can be checked by
<a href="https://developers.cloudflare.com/cloudflare-one/connections/connect-networks/monitor-tunnels/logs/#view-logs">viewing <code>cloudflared</code> logs</a>
in the CLI to get detailed error messages:</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-142-1"><a id="__codelineno-142-1" name="__codelineno-142-1" href="#__codelineno-142-1"></a><span class="gp">$ </span>cloudflared<span class="w"> </span>tail<span class="w"> </span>3923ef0b-986b-43cd-9066-d48035a77f89
</span><span id="__span-142-2"><a id="__codelineno-142-2" name="__codelineno-142-2" href="#__codelineno-142-2"></a><span class="go">2025-03-29T17:50:56Z ERR Cannot determine default origin certificate path. No file cert.pem in [~/.cloudflared ~/.cloudflare-warp ~/cloudflare-warp /etc/cloudflared /usr/local/etc/cloudflared]. You need to specify the origin certificate path by specifying the origincert option in the configuration file, or set TUNNEL_ORIGIN_CERT environment variable originCertPath=</span>
</span><span id="__span-142-3"><a id="__codelineno-142-3" name="__codelineno-142-3" href="#__codelineno-142-3"></a><span class="go">2025-03-29T17:50:56Z ERR unable to construct management request URL error="unable to acquire management token for requested tunnel id: Error locating origin cert: client didn't specify origincert path"</span>
</span></code></pre></div>
<p>Here is the error message in a more readable format:</p>
<blockquote>
<p>Cannot determine default origin certificate path.<br>
No file cert.pem in <code>[~/.cloudflared ~/.cloudflare-warp ~/cloudflare-warp</code>
<code>/etc/cloudflared /usr/local/etc/cloudflared]</code>.<br>
You need to specify the origin certificate path by specifying the
<code>origincert</code> option in the configuration file, or set <code>TUNNEL_ORIGIN_CERT</code>
environment variable <code>originCertPath=</code><br>
2025-03-29T17:50:56Z ERR unable to construct management request URL
<code>error="unable to acquire management token for requested tunnel id:</code>
<code>Error locating origin cert: client didn't specify origincert path"</code></p>
</blockquote>
</details>
<details class="warning">
<summary><strong>HTTP Host Header</strong> must match the hostname <strong>exactly</strong>.</summary>
<p>Overriding <strong>HTTP Settings &gt; HTTP Host Header</strong> in the tunnel should not
be necessary; by default it will send the correct <code>Host</code> header. Otherwise,
if the override header is not exactly the same as the tunnel's hostname,
e.g. <code>kubernetes.alfred.very-very-dark-gray.top</code> instead of
<code>kubernetes-alfred.very-very-dark-gray.top</code>, requests will not match
any rules in Nginx and recieve a <strong>404 Not Found</strong> response:</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-143-1"><a id="__codelineno-143-1" name="__codelineno-143-1" href="#__codelineno-143-1"></a><span class="gp">$ </span>curl<span class="w"> </span><span class="m">2</span>&gt;/dev/null<span class="w"> </span><span class="se">\</span>
</span><span id="__span-143-2"><a id="__codelineno-143-2" name="__codelineno-143-2" href="#__codelineno-143-2"></a><span class="w">  </span>-k<span class="w"> </span>https://kubernetes-alfred.very-very-dark-gray.top/<span class="w"> </span><span class="se">\</span>
</span><span id="__span-143-3"><a id="__codelineno-143-3" name="__codelineno-143-3" href="#__codelineno-143-3"></a><span class="p">|</span><span class="w"> </span>head
</span><span id="__span-143-4"><a id="__codelineno-143-4" name="__codelineno-143-4" href="#__codelineno-143-4"></a><span class="go">&lt;html&gt;</span>
</span><span id="__span-143-5"><a id="__codelineno-143-5" name="__codelineno-143-5" href="#__codelineno-143-5"></a><span class="go">&lt;head&gt;&lt;title&gt;404 Not Found&lt;/title&gt;&lt;/head&gt;</span>
</span><span id="__span-143-6"><a id="__codelineno-143-6" name="__codelineno-143-6" href="#__codelineno-143-6"></a><span class="go">&lt;body&gt;</span>
</span><span id="__span-143-7"><a id="__codelineno-143-7" name="__codelineno-143-7" href="#__codelineno-143-7"></a><span class="go">&lt;center&gt;&lt;h1&gt;404 Not Found&lt;/h1&gt;&lt;/center&gt;</span>
</span><span id="__span-143-8"><a id="__codelineno-143-8" name="__codelineno-143-8" href="#__codelineno-143-8"></a><span class="go">&lt;hr&gt;&lt;center&gt;nginx&lt;/center&gt;</span>
</span><span id="__span-143-9"><a id="__codelineno-143-9" name="__codelineno-143-9" href="#__codelineno-143-9"></a><span class="go">&lt;/body&gt;</span>
</span><span id="__span-143-10"><a id="__codelineno-143-10" name="__codelineno-143-10" href="#__codelineno-143-10"></a><span class="go">&lt;/html&gt;</span>
</span></code></pre></div>
<p>To confirm the problem is in Nginx and not in the <code>cloudflared</code> connector,
temporarily run the <code>port-forward</code> to make the
<a href="#kubernetes-dashboard">Kubernetes Dashboard</a>
accessible directly without going through Nginx:</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-144-1"><a id="__codelineno-144-1" name="__codelineno-144-1" href="#__codelineno-144-1"></a><span class="gp">$ </span>kubectl<span class="w"> </span>-n<span class="w"> </span>kubernetes-dashboard<span class="w"> </span>port-forward<span class="w"> </span><span class="se">\</span>
</span><span id="__span-144-2"><a id="__codelineno-144-2" name="__codelineno-144-2" href="#__codelineno-144-2"></a><span class="w">  </span>svc/kubernetes-dashboard-kong-proxy<span class="w"> </span><span class="m">8443</span>:443<span class="w"> </span><span class="se">\</span>
</span><span id="__span-144-3"><a id="__codelineno-144-3" name="__codelineno-144-3" href="#__codelineno-144-3"></a><span class="w">  </span>--address<span class="w"> </span><span class="m">0</span>.0.0.0
</span><span id="__span-144-4"><a id="__codelineno-144-4" name="__codelineno-144-4" href="#__codelineno-144-4"></a><span class="go">Forwarding from 0.0.0.0:8443 -&gt; 8443</span>
</span><span id="__span-144-5"><a id="__codelineno-144-5" name="__codelineno-144-5" href="#__codelineno-144-5"></a><span class="go">^C</span>
</span></code></pre></div>
<p><strong>Edit</strong> the <code>kubernetes-alfred.very-very-dark-gray.top</code> tunnel to point to
<code>https://localhost:8443</code> and the dashboard becomes immediately available.</p>
<p>To debug the problem in Nginx, increase logging level to the maximum
(<code>debug</code>):</p>
<div class="language-yaml highlight"><table class="highlighttable"><tbody><tr><th colspan="2" class="filename"><span class="filename">nginx-baremetal.yaml</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-145-321">321</a></span>
<span class="normal"><a href="#__codelineno-145-322">322</a></span>
<span class="normal"><a href="#__codelineno-145-323">323</a></span>
<span class="normal"><a href="#__codelineno-145-324">324</a></span>
<span class="normal"><a href="#__codelineno-145-325">325</a></span>
<span class="normal"><a href="#__codelineno-145-326">326</a></span>
<span class="normal"><a href="#__codelineno-145-327">327</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-145-321"><a id="__codelineno-145-321" name="__codelineno-145-321"></a><span class="nn">---</span>
</span><span id="__span-145-322"><a id="__codelineno-145-322" name="__codelineno-145-322"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
</span><span id="__span-145-323"><a id="__codelineno-145-323" name="__codelineno-145-323"></a><span class="nt">data</span><span class="p">:</span>
</span><span id="__span-145-324"><a id="__codelineno-145-324" name="__codelineno-145-324"></a><span class="w">  </span><span class="nt">allow-snippet-annotations</span><span class="p">:</span><span class="w"> </span><span class="s">"true"</span>
</span><span id="__span-145-325"><a id="__codelineno-145-325" name="__codelineno-145-325"></a><span class="w">  </span><span class="nt">annotations-risk-level</span><span class="p">:</span><span class="w"> </span><span class="s">"Critical"</span>
</span><span id="__span-145-326"><a id="__codelineno-145-326" name="__codelineno-145-326"></a><span class="hll"><span class="w">  </span><span class="nt">error-log-level</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">debug</span>
</span></span><span id="__span-145-327"><a id="__codelineno-145-327" name="__codelineno-145-327"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ConfigMap</span>
</span></code></pre></div></td></tr></tbody></table></div>
<p>After applying this change, the logs of the <code>ingress-nginx-controller</code>
will included <strong>lots</strong> of details and will stream <em>fast</em>; be ready to
grep for the relevant hostname to find the log entries for the request:</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-146-1"><a id="__codelineno-146-1" name="__codelineno-146-1" href="#__codelineno-146-1"></a><span class="go">kubectl logs -n ingress-nginx \</span>
</span><span id="__span-146-2"><a id="__codelineno-146-2" name="__codelineno-146-2" href="#__codelineno-146-2"></a><span class="gp">  $</span><span class="o">(</span>kubectl<span class="w"> </span>get<span class="w"> </span>pods<span class="w"> </span>-n<span class="w"> </span>ingress-nginx<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>ingress-nginx-controller<span class="w"> </span><span class="p">|</span><span class="w"> </span>cut<span class="w"> </span>-f1<span class="w"> </span>-d<span class="s1">' '</span><span class="o">)</span><span class="w"> </span>-f
</span><span id="__span-146-3"><a id="__codelineno-146-3" name="__codelineno-146-3" href="#__codelineno-146-3"></a><span class="go">...</span>
</span><span id="__span-146-4"><a id="__codelineno-146-4" name="__codelineno-146-4" href="#__codelineno-146-4"></a><span class="go">"GET / HTTP/1.1</span>
</span><span id="__span-146-5"><a id="__codelineno-146-5" name="__codelineno-146-5" href="#__codelineno-146-5"></a><span class="go">Host: kubernetes.alfred.very-very-dark-gray.top</span>
</span><span id="__span-146-6"><a id="__codelineno-146-6" name="__codelineno-146-6" href="#__codelineno-146-6"></a><span class="hll"><span class="go">X-Request-ID: 3a67e281e598abf5d21dda0679f0be59</span>
</span></span><span id="__span-146-7"><a id="__codelineno-146-7" name="__codelineno-146-7" href="#__codelineno-146-7"></a><span class="go">X-Real-IP: 10.244.0.1</span>
</span><span id="__span-146-8"><a id="__codelineno-146-8" name="__codelineno-146-8" href="#__codelineno-146-8"></a><span class="go">X-Forwarded-For: 10.244.0.1</span>
</span><span id="__span-146-9"><a id="__codelineno-146-9" name="__codelineno-146-9" href="#__codelineno-146-9"></a><span class="go">X-Forwarded-Host: kubernetes.alfred.very-very-dark-gray.top</span>
</span><span id="__span-146-10"><a id="__codelineno-146-10" name="__codelineno-146-10" href="#__codelineno-146-10"></a><span class="hll"><span class="go">X-Forwarded-Port: 443</span>
</span></span><span id="__span-146-11"><a id="__codelineno-146-11" name="__codelineno-146-11" href="#__codelineno-146-11"></a><span class="go">X-Forwarded-Proto: https</span>
</span><span id="__span-146-12"><a id="__codelineno-146-12" name="__codelineno-146-12" href="#__codelineno-146-12"></a><span class="go">X-Forwarded-Scheme: https</span>
</span><span id="__span-146-13"><a id="__codelineno-146-13" name="__codelineno-146-13" href="#__codelineno-146-13"></a><span class="go">X-Scheme: https</span>
</span><span id="__span-146-14"><a id="__codelineno-146-14" name="__codelineno-146-14" href="#__codelineno-146-14"></a><span class="go">X-Original-Forwarded-For: 217.162.57.64</span>
</span><span id="__span-146-15"><a id="__codelineno-146-15" name="__codelineno-146-15" href="#__codelineno-146-15"></a><span class="go">User-Agent: curl/8.5.0</span>
</span><span id="__span-146-16"><a id="__codelineno-146-16" name="__codelineno-146-16" href="#__codelineno-146-16"></a><span class="go">Accept: */*</span>
</span><span id="__span-146-17"><a id="__codelineno-146-17" name="__codelineno-146-17" href="#__codelineno-146-17"></a><span class="go">Accept-Encoding: gzip, br</span>
</span><span id="__span-146-18"><a id="__codelineno-146-18" name="__codelineno-146-18" href="#__codelineno-146-18"></a><span class="go">Cdn-Loop: cloudflare; loops=1</span>
</span><span id="__span-146-19"><a id="__codelineno-146-19" name="__codelineno-146-19" href="#__codelineno-146-19"></a><span class="go">Cf-Connecting-Ip: 217.162.57.64</span>
</span><span id="__span-146-20"><a id="__codelineno-146-20" name="__codelineno-146-20" href="#__codelineno-146-20"></a><span class="go">Cf-Ipcountry: CH</span>
</span><span id="__span-146-21"><a id="__codelineno-146-21" name="__codelineno-146-21" href="#__codelineno-146-21"></a><span class="go">Cf-Ray: 92815e1e1c1a039c-ZRH</span>
</span><span id="__span-146-22"><a id="__codelineno-146-22" name="__codelineno-146-22" href="#__codelineno-146-22"></a><span class="go">Cf-Visitor: {"scheme":"https"}</span>
</span><span id="__span-146-23"><a id="__codelineno-146-23" name="__codelineno-146-23" href="#__codelineno-146-23"></a><span class="go">Cf-Warp-Tag-Id: 3923ef0b-986b-43cd-9066-d48035a77f89</span>
</span><span id="__span-146-24"><a id="__codelineno-146-24" name="__codelineno-146-24" href="#__codelineno-146-24"></a><span class="go">...</span>
</span><span id="__span-146-25"><a id="__codelineno-146-25" name="__codelineno-146-25" href="#__codelineno-146-25"></a><span class="go">2025/03/29 18:18:03 [debug] 1392#1392: *8405048 event timer del: 22: 689556672</span>
</span><span id="__span-146-26"><a id="__codelineno-146-26" name="__codelineno-146-26" href="#__codelineno-146-26"></a><span class="go">2025/03/29 18:18:03 [debug] 1392#1392: *8405048 generic phase: 0</span>
</span><span id="__span-146-27"><a id="__codelineno-146-27" name="__codelineno-146-27" href="#__codelineno-146-27"></a><span class="go">2025/03/29 18:18:03 [debug] 1392#1392: *8405048 rewrite phase: 1</span>
</span><span id="__span-146-28"><a id="__codelineno-146-28" name="__codelineno-146-28" href="#__codelineno-146-28"></a><span class="go">2025/03/29 18:18:03 [debug] 1392#1392: *8405048 http script value: "internal"</span>
</span><span id="__span-146-29"><a id="__codelineno-146-29" name="__codelineno-146-29" href="#__codelineno-146-29"></a><span class="go">2025/03/29 18:18:03 [debug] 1392#1392: *8405048 http script set $proxy_upstream_name</span>
</span><span id="__span-146-30"><a id="__codelineno-146-30" name="__codelineno-146-30" href="#__codelineno-146-30"></a><span class="go">2025/03/29 18:18:03 [debug] 1392#1392: *8405048 test location: "/"</span>
</span><span id="__span-146-31"><a id="__codelineno-146-31" name="__codelineno-146-31" href="#__codelineno-146-31"></a><span class="go">2025/03/29 18:18:03 [debug] 1392#1392: *8405048 using configuration "/"</span>
</span><span id="__span-146-32"><a id="__codelineno-146-32" name="__codelineno-146-32" href="#__codelineno-146-32"></a><span class="go">2025/03/29 18:18:03 [debug] 1392#1392: *8405048 http cl:-1 max:1048576</span>
</span><span id="__span-146-33"><a id="__codelineno-146-33" name="__codelineno-146-33" href="#__codelineno-146-33"></a><span class="go">2025/03/29 18:18:03 [debug] 1392#1392: *8405048 rewrite phase: 3</span>
</span><span id="__span-146-34"><a id="__codelineno-146-34" name="__codelineno-146-34" href="#__codelineno-146-34"></a><span class="go">2025/03/29 18:18:03 [debug] 1392#1392: *8405048 http finalize request: 404, "/?" a:1, c:1</span>
</span><span id="__span-146-35"><a id="__codelineno-146-35" name="__codelineno-146-35" href="#__codelineno-146-35"></a><span class="go">2025/03/29 18:18:03 [debug] 1392#1392: *8405048 http special response: 404, "/?"</span>
</span><span id="__span-146-36"><a id="__codelineno-146-36" name="__codelineno-146-36" href="#__codelineno-146-36"></a><span class="go">2025/03/29 18:18:03 [debug] 1392#1392: *8405048 http set discard body</span>
</span><span id="__span-146-37"><a id="__codelineno-146-37" name="__codelineno-146-37" href="#__codelineno-146-37"></a><span class="go">2025/03/29 18:18:03 [debug] 1392#1392: *8405048 lua header filter for user lua code, uri "/"</span>
</span><span id="__span-146-38"><a id="__codelineno-146-38" name="__codelineno-146-38" href="#__codelineno-146-38"></a><span class="go">2025/03/29 18:18:03 [debug] 1392#1392: *8405048 lua capture header filter, uri "/"</span>
</span><span id="__span-146-39"><a id="__codelineno-146-39" name="__codelineno-146-39" href="#__codelineno-146-39"></a><span class="go">2025/03/29 18:18:03 [debug] 1392#1392: *8405048 headers more header filter, uri "/"</span>
</span><span id="__span-146-40"><a id="__codelineno-146-40" name="__codelineno-146-40" href="#__codelineno-146-40"></a><span class="go">2025/03/29 18:18:03 [debug] 1392#1392: *8405048 HTTP/1.1 404 Not Found</span>
</span></code></pre></div>
</details>
<h3 id="lets-encrypt-via-tunnel">Let's Encrypt via tunnel</h3>
<p>To use Let's Encrypt certificates behind a Cloudflare tunnel, an additional
<strong>Public hostname</strong> must be added to the tunnel, to route requests for paths under
<code>/.well-known/</code> to port <strong>32080</strong> over plain <strong>HTTP</strong>. Combined with the patching of
ACME solvers from <a href="#automatic-renovation">Automatic renovation</a>, this makes solvers
for <code>HTTP01</code> challenges reachable, so certificates can be issued and renewed.</p>
<p>The <strong>Public hostname</strong> to route requests under <code>/.well-known/</code> <strong>must</strong> be the
first one (these can be dragged to rearrange their order):</p>
<p><a class="glightbox" data-type="image" data-width="auto" data-height="auto" href="../../../../media/2025-02-22-home-assistant-on-kubernetes-on-raspberry-pi-5-alfred/tunnel-kubernetes-alfred-public-hostnames.png" data-desc-position="bottom"><img alt="Public hostnames on Cloudflare tunnel" src="../../../../media/2025-02-22-home-assistant-on-kubernetes-on-raspberry-pi-5-alfred/tunnel-kubernetes-alfred-public-hostnames.png" style="height:319px;width:658px"></a></p>
<p><a href="https://stackoverflow.com/a/74006118">To avoid hitting Let's Encrypt rate limits</a>,
<em>use a different secret name for each host</em>:</p>
<div class="language-yaml highlight"><table class="highlighttable"><tbody><tr><th colspan="2" class="filename"><span class="filename">dashboard/nginx-ingress.yaml</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-147-37">37</a></span>
<span class="normal"><a href="#__codelineno-147-38">38</a></span>
<span class="normal"><a href="#__codelineno-147-39">39</a></span>
<span class="normal"><a href="#__codelineno-147-40">40</a></span>
<span class="normal"><a href="#__codelineno-147-41">41</a></span>
<span class="normal"><a href="#__codelineno-147-42">42</a></span>
<span class="normal"><a href="#__codelineno-147-43">43</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-147-37"><a id="__codelineno-147-37" name="__codelineno-147-37"></a><span class="w">  </span><span class="nt">tls</span><span class="p">:</span>
</span><span id="__span-147-38"><a id="__codelineno-147-38" name="__codelineno-147-38"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">secretName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">tls-secret</span>
</span><span id="__span-147-39"><a id="__codelineno-147-39" name="__codelineno-147-39"></a><span class="w">      </span><span class="nt">hosts</span><span class="p">:</span>
</span><span id="__span-147-40"><a id="__codelineno-147-40" name="__codelineno-147-40"></a><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">k8s.alfred.uu.am</span>
</span><span id="__span-147-41"><a id="__codelineno-147-41" name="__codelineno-147-41"></a><span class="hll"><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">secretName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">tls-secret-cloudflare</span>
</span></span><span id="__span-147-42"><a id="__codelineno-147-42" name="__codelineno-147-42"></a><span class="hll"><span class="w">      </span><span class="nt">hosts</span><span class="p">:</span>
</span></span><span id="__span-147-43"><a id="__codelineno-147-43" name="__codelineno-147-43"></a><span class="hll"><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">kubernetes-alfred.very-very-dark-gray.top</span>
</span></span></code></pre></div></td></tr></tbody></table></div>
<p>After applying this update to the ingress, the sequence of events to
<a href="#secure-kubernetes-dashboard-ingress">Secure Kubernetes Dashboard Ingress</a> is repeated,
with a few extra steps involving the Cloudflare tunnel:</p>
<ol>
<li>A new solver starts, listening on a <code>NodePort</code>; this can be found in the list of
    services:
    <div class="language-console highlight"><pre><span></span><code><span id="__span-148-1"><a id="__codelineno-148-1" name="__codelineno-148-1" href="#__codelineno-148-1"></a><span class="gp">$ </span>kubectl<span class="w"> </span>get<span class="w"> </span>svc<span class="w"> </span>-A<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>acme
</span><span id="__span-148-2"><a id="__codelineno-148-2" name="__codelineno-148-2" href="#__codelineno-148-2"></a><span class="go">kubernetes-dashboard   cm-acme-http-solver-chp9k              NodePort    10.103.151.109   &lt;none&gt;        8089:30956/TCP               3s</span>
</span></code></pre></div></li>
<li>The logs indicate the solver is listening:
    <div class="language-console highlight"><pre><span></span><code><span id="__span-149-1"><a id="__codelineno-149-1" name="__codelineno-149-1" href="#__codelineno-149-1"></a><span class="gp">$ </span>kubectl<span class="w"> </span>-n<span class="w"> </span>kubernetes-dashboard<span class="w"> </span>logs<span class="w"> </span><span class="se">\</span>
</span><span id="__span-149-2"><a id="__codelineno-149-2" name="__codelineno-149-2" href="#__codelineno-149-2"></a><span class="gp">  $</span><span class="o">(</span>kubectl<span class="w"> </span>get<span class="w"> </span>pods<span class="w"> </span>-n<span class="w"> </span>kubernetes-dashboard<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>acme<span class="w"> </span><span class="p">|</span><span class="w"> </span>cut<span class="w"> </span>-f1<span class="w"> </span>-d<span class="s1">' '</span><span class="o">)</span><span class="w"> </span>-f
</span><span id="__span-149-3"><a id="__codelineno-149-3" name="__codelineno-149-3" href="#__codelineno-149-3"></a><span class="go">I0330 12:04:55.423524       1 solver.go:52] "starting listener" logger="cert-manager.acmesolver" expected_domain="kubernetes-alfred.very-very-dark-gray.top" expected_token="aqO1GODyRAWRg4nnh6keja5mdYVSJg0zcA01eL0CHtI" expected_key="aqO1GODyRAWRg4nnh6keja5mdYVSJg0zcA01eL0CHtI.AiIi2mdeMBlCng6As7epqFyP8bmjSGQqxIdEbnstHEo" listen_port=8089</span>
</span></code></pre></div></li>
<li>Streaming logs for the Cloudflare tunnel connector shows <strong>Request failed</strong> about
    once a minute, with the URL for the challenge
    (<code>/.well-known/acme-challenge/aqO1GODyRAWRg4nnh6keja5mdYVSJg0zcA01eL0CHtI</code>).
    Error details show it cannot connect to port <strong>32080</strong>:
    <code>"dial tcp [::1]:32080: connect: connection refused"</code>.</li>
<li>After <code>cert-renewal-port-fwd.sh</code> runs and patches the solver, it's listening on port
    <strong>32080</strong>:
    <div class="language-console highlight"><pre><span></span><code><span id="__span-150-1"><a id="__codelineno-150-1" name="__codelineno-150-1" href="#__codelineno-150-1"></a><span class="gp">$ </span>kubectl<span class="w"> </span>get<span class="w"> </span>svc<span class="w"> </span>-A<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>acme
</span><span id="__span-150-2"><a id="__codelineno-150-2" name="__codelineno-150-2" href="#__codelineno-150-2"></a><span class="go">kubernetes-dashboard   cm-acme-http-solver-chp9k              NodePort    10.103.151.109   &lt;none&gt;        8089:32080/TCP               2m35s</span>
</span></code></pre></div></li>
<li>Streaming logs for the tunnel connector now shows <strong>OK</strong> for subsequent requests.</li>
<li>The solver receives the requests and finishes successfully.</li>
</ol>
<p>At this point it is no longer necessary to have <strong>No TLS Verify</strong> enable under
<em>Additional application settings &gt; TLS</em> because Nginx is now using a certificate
signed by Let's Encrypt. However, if <strong>No TLS Verify</strong> is to be disabled, then it
is necessary to set <strong>Origin Server Name</strong> (<code>kubernetes-alfred.very-very-dark-gray.top</code>)
to the FQDN so that Cloudflare accepts the certificate.</p>
<h2 id="tailscale">Tailscale</h2>
<p><a href="../../../03/28/remote-access-options-for-self-hosted-services/#tailscale">Set up Tailscale</a>,
which involved mostly setting this up on the Tailscale admin console,
and several changes in <code>alfred</code>:</p>
<ol>
<li>Install <code>tailscale</code> and connect to a new tailnet when creating the first one.</li>
<li>Install the <a href="../../../03/28/remote-access-options-for-self-hosted-services/#tailscale-kubernetes-operator">Tailscale Kubernetes operator</a>
    and add a <em>Tailscale</em> <code>Ingress</code> to the <a href="#kubernetes-dashboard-ingress">Kubernetes Dashboard Ingress</a>.</li>
<li>As a test, enabled <a href="../../../03/28/remote-access-options-for-self-hosted-services/#public-access-through-funnel">Public access through Funnel</a>
    to check how services can be made accessible from outside the tailnet.<ul>
<li>Not really necessary for the Kubernetes Dashboard, because SSH access is
    necessary to obtain a token and Tailnet Funnel does not offer anything like
    <a href="../../../03/28/remote-access-options-for-self-hosted-services/#cloudflare-access">Cloudflare Access</a>
    that could possibly take over authentication.</li>
</ul>
</li>
</ol>
<h2 id="influxdb-and-grafana">InfluxDB and Grafana</h2>
<p>With all the above in place, this system is now ready to run
<a href="../../../04/12/kubernetes-homelab-server-with-ubuntu-server-2404-octavo/#influxdb-and-grafana">InfluxDB and Grafana</a>
to collect metrics from <a href="../../../../../projects/conmon/">Continuous Monitoring</a>,
<a href="#home-assistant">Home Assistant</a> and any other systems in its final location.</p>
<p>Taking the combined deployment in <code>octavo</code> for
<a href="../../../04/12/kubernetes-homelab-server-with-ubuntu-server-2404-octavo/#influxdb-and-grafana">InfluxDB and Grafana</a>
as the starting point, the deployment for <code>alfred</code> changes only a few details:</p>
<ul>
<li>Remove the <code>influxdb-ingress</code> (will not be receiving metrics remotely).</li>
<li>Set a different FQDN for the <code>grafana-ingress</code> to access Grafana remotely.</li>
<li>Add <code>grafana-ingress-tailscale</code> for access through <a href="#tailscale">Tailscale</a>.</li>
</ul>
<details class="k8s">
<summary>Combined deployment for InfluxDB and Grafana</summary>
<div class="language-yaml highlight"><span class="filename">alfred/monitoring.yaml</span><pre><span></span><code><span id="__span-151-1"><a id="__codelineno-151-1" name="__codelineno-151-1" href="#__codelineno-151-1"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
</span><span id="__span-151-2"><a id="__codelineno-151-2" name="__codelineno-151-2" href="#__codelineno-151-2"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Namespace</span>
</span><span id="__span-151-3"><a id="__codelineno-151-3" name="__codelineno-151-3" href="#__codelineno-151-3"></a><span class="nt">metadata</span><span class="p">:</span>
</span><span id="__span-151-4"><a id="__codelineno-151-4" name="__codelineno-151-4" href="#__codelineno-151-4"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">monitoring</span>
</span><span id="__span-151-5"><a id="__codelineno-151-5" name="__codelineno-151-5" href="#__codelineno-151-5"></a><span class="nn">---</span>
</span><span id="__span-151-6"><a id="__codelineno-151-6" name="__codelineno-151-6" href="#__codelineno-151-6"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
</span><span id="__span-151-7"><a id="__codelineno-151-7" name="__codelineno-151-7" href="#__codelineno-151-7"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">PersistentVolume</span>
</span><span id="__span-151-8"><a id="__codelineno-151-8" name="__codelineno-151-8" href="#__codelineno-151-8"></a><span class="nt">metadata</span><span class="p">:</span>
</span><span id="__span-151-9"><a id="__codelineno-151-9" name="__codelineno-151-9" href="#__codelineno-151-9"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">influxdb-pv</span>
</span><span id="__span-151-10"><a id="__codelineno-151-10" name="__codelineno-151-10" href="#__codelineno-151-10"></a><span class="w">  </span><span class="nt">labels</span><span class="p">:</span>
</span><span id="__span-151-11"><a id="__codelineno-151-11" name="__codelineno-151-11" href="#__codelineno-151-11"></a><span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">local</span>
</span><span id="__span-151-12"><a id="__codelineno-151-12" name="__codelineno-151-12" href="#__codelineno-151-12"></a><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">monitoring</span>
</span><span id="__span-151-13"><a id="__codelineno-151-13" name="__codelineno-151-13" href="#__codelineno-151-13"></a><span class="nt">spec</span><span class="p">:</span>
</span><span id="__span-151-14"><a id="__codelineno-151-14" name="__codelineno-151-14" href="#__codelineno-151-14"></a><span class="w">  </span><span class="nt">storageClassName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">manual</span>
</span><span id="__span-151-15"><a id="__codelineno-151-15" name="__codelineno-151-15" href="#__codelineno-151-15"></a><span class="w">  </span><span class="nt">capacity</span><span class="p">:</span>
</span><span id="__span-151-16"><a id="__codelineno-151-16" name="__codelineno-151-16" href="#__codelineno-151-16"></a><span class="w">    </span><span class="nt">storage</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">30Gi</span>
</span><span id="__span-151-17"><a id="__codelineno-151-17" name="__codelineno-151-17" href="#__codelineno-151-17"></a><span class="w">  </span><span class="nt">accessModes</span><span class="p">:</span>
</span><span id="__span-151-18"><a id="__codelineno-151-18" name="__codelineno-151-18" href="#__codelineno-151-18"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ReadWriteOnce</span>
</span><span id="__span-151-19"><a id="__codelineno-151-19" name="__codelineno-151-19" href="#__codelineno-151-19"></a><span class="w">  </span><span class="nt">hostPath</span><span class="p">:</span>
</span><span id="__span-151-20"><a id="__codelineno-151-20" name="__codelineno-151-20" href="#__codelineno-151-20"></a><span class="w">    </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/home/k8s/influxdb</span>
</span><span id="__span-151-21"><a id="__codelineno-151-21" name="__codelineno-151-21" href="#__codelineno-151-21"></a><span class="nn">---</span>
</span><span id="__span-151-22"><a id="__codelineno-151-22" name="__codelineno-151-22" href="#__codelineno-151-22"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
</span><span id="__span-151-23"><a id="__codelineno-151-23" name="__codelineno-151-23" href="#__codelineno-151-23"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">PersistentVolumeClaim</span>
</span><span id="__span-151-24"><a id="__codelineno-151-24" name="__codelineno-151-24" href="#__codelineno-151-24"></a><span class="nt">metadata</span><span class="p">:</span>
</span><span id="__span-151-25"><a id="__codelineno-151-25" name="__codelineno-151-25" href="#__codelineno-151-25"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">influxdb-pv-claim</span>
</span><span id="__span-151-26"><a id="__codelineno-151-26" name="__codelineno-151-26" href="#__codelineno-151-26"></a><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">monitoring</span>
</span><span id="__span-151-27"><a id="__codelineno-151-27" name="__codelineno-151-27" href="#__codelineno-151-27"></a><span class="nt">spec</span><span class="p">:</span>
</span><span id="__span-151-28"><a id="__codelineno-151-28" name="__codelineno-151-28" href="#__codelineno-151-28"></a><span class="w">  </span><span class="nt">storageClassName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">manual</span>
</span><span id="__span-151-29"><a id="__codelineno-151-29" name="__codelineno-151-29" href="#__codelineno-151-29"></a><span class="w">  </span><span class="nt">volumeName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">influxdb-pv</span>
</span><span id="__span-151-30"><a id="__codelineno-151-30" name="__codelineno-151-30" href="#__codelineno-151-30"></a><span class="w">  </span><span class="nt">accessModes</span><span class="p">:</span>
</span><span id="__span-151-31"><a id="__codelineno-151-31" name="__codelineno-151-31" href="#__codelineno-151-31"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ReadWriteOnce</span>
</span><span id="__span-151-32"><a id="__codelineno-151-32" name="__codelineno-151-32" href="#__codelineno-151-32"></a><span class="w">  </span><span class="nt">resources</span><span class="p">:</span>
</span><span id="__span-151-33"><a id="__codelineno-151-33" name="__codelineno-151-33" href="#__codelineno-151-33"></a><span class="w">    </span><span class="nt">requests</span><span class="p">:</span>
</span><span id="__span-151-34"><a id="__codelineno-151-34" name="__codelineno-151-34" href="#__codelineno-151-34"></a><span class="w">      </span><span class="nt">storage</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">30Gi</span>
</span><span id="__span-151-35"><a id="__codelineno-151-35" name="__codelineno-151-35" href="#__codelineno-151-35"></a><span class="nn">---</span>
</span><span id="__span-151-36"><a id="__codelineno-151-36" name="__codelineno-151-36" href="#__codelineno-151-36"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">apps/v1</span>
</span><span id="__span-151-37"><a id="__codelineno-151-37" name="__codelineno-151-37" href="#__codelineno-151-37"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Deployment</span>
</span><span id="__span-151-38"><a id="__codelineno-151-38" name="__codelineno-151-38" href="#__codelineno-151-38"></a><span class="nt">metadata</span><span class="p">:</span>
</span><span id="__span-151-39"><a id="__codelineno-151-39" name="__codelineno-151-39" href="#__codelineno-151-39"></a><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">monitoring</span>
</span><span id="__span-151-40"><a id="__codelineno-151-40" name="__codelineno-151-40" href="#__codelineno-151-40"></a><span class="w">  </span><span class="nt">labels</span><span class="p">:</span>
</span><span id="__span-151-41"><a id="__codelineno-151-41" name="__codelineno-151-41" href="#__codelineno-151-41"></a><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">influxdb</span>
</span><span id="__span-151-42"><a id="__codelineno-151-42" name="__codelineno-151-42" href="#__codelineno-151-42"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">influxdb</span>
</span><span id="__span-151-43"><a id="__codelineno-151-43" name="__codelineno-151-43" href="#__codelineno-151-43"></a><span class="nt">spec</span><span class="p">:</span>
</span><span id="__span-151-44"><a id="__codelineno-151-44" name="__codelineno-151-44" href="#__codelineno-151-44"></a><span class="w">  </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1</span>
</span><span id="__span-151-45"><a id="__codelineno-151-45" name="__codelineno-151-45" href="#__codelineno-151-45"></a><span class="w">  </span><span class="nt">selector</span><span class="p">:</span>
</span><span id="__span-151-46"><a id="__codelineno-151-46" name="__codelineno-151-46" href="#__codelineno-151-46"></a><span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span>
</span><span id="__span-151-47"><a id="__codelineno-151-47" name="__codelineno-151-47" href="#__codelineno-151-47"></a><span class="w">      </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">influxdb</span>
</span><span id="__span-151-48"><a id="__codelineno-151-48" name="__codelineno-151-48" href="#__codelineno-151-48"></a><span class="w">  </span><span class="nt">template</span><span class="p">:</span>
</span><span id="__span-151-49"><a id="__codelineno-151-49" name="__codelineno-151-49" href="#__codelineno-151-49"></a><span class="w">    </span><span class="nt">metadata</span><span class="p">:</span>
</span><span id="__span-151-50"><a id="__codelineno-151-50" name="__codelineno-151-50" href="#__codelineno-151-50"></a><span class="w">      </span><span class="nt">labels</span><span class="p">:</span>
</span><span id="__span-151-51"><a id="__codelineno-151-51" name="__codelineno-151-51" href="#__codelineno-151-51"></a><span class="w">        </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">influxdb</span>
</span><span id="__span-151-52"><a id="__codelineno-151-52" name="__codelineno-151-52" href="#__codelineno-151-52"></a><span class="w">    </span><span class="nt">spec</span><span class="p">:</span>
</span><span id="__span-151-53"><a id="__codelineno-151-53" name="__codelineno-151-53" href="#__codelineno-151-53"></a><span class="w">      </span><span class="nt">hostname</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">influxdb</span>
</span><span id="__span-151-54"><a id="__codelineno-151-54" name="__codelineno-151-54" href="#__codelineno-151-54"></a><span class="w">      </span><span class="nt">containers</span><span class="p">:</span>
</span><span id="__span-151-55"><a id="__codelineno-151-55" name="__codelineno-151-55" href="#__codelineno-151-55"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">docker.io/influxdb:1.11.8</span>
</span><span id="__span-151-56"><a id="__codelineno-151-56" name="__codelineno-151-56" href="#__codelineno-151-56"></a><span class="w">        </span><span class="nt">env</span><span class="p">:</span>
</span><span id="__span-151-57"><a id="__codelineno-151-57" name="__codelineno-151-57" href="#__codelineno-151-57"></a><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s">"INFLUXDB_HTTP_AUTH_ENABLED"</span>
</span><span id="__span-151-58"><a id="__codelineno-151-58" name="__codelineno-151-58" href="#__codelineno-151-58"></a><span class="w">          </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="s">"true"</span>
</span><span id="__span-151-59"><a id="__codelineno-151-59" name="__codelineno-151-59" href="#__codelineno-151-59"></a><span class="w">        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">influxdb</span>
</span><span id="__span-151-60"><a id="__codelineno-151-60" name="__codelineno-151-60" href="#__codelineno-151-60"></a><span class="w">        </span><span class="nt">volumeMounts</span><span class="p">:</span>
</span><span id="__span-151-61"><a id="__codelineno-151-61" name="__codelineno-151-61" href="#__codelineno-151-61"></a><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">mountPath</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/var/lib/influxdb</span>
</span><span id="__span-151-62"><a id="__codelineno-151-62" name="__codelineno-151-62" href="#__codelineno-151-62"></a><span class="w">          </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">influxdb-data</span>
</span><span id="__span-151-63"><a id="__codelineno-151-63" name="__codelineno-151-63" href="#__codelineno-151-63"></a><span class="w">      </span><span class="nt">securityContext</span><span class="p">:</span>
</span><span id="__span-151-64"><a id="__codelineno-151-64" name="__codelineno-151-64" href="#__codelineno-151-64"></a><span class="w">        </span><span class="nt">runAsUser</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">114</span>
</span><span id="__span-151-65"><a id="__codelineno-151-65" name="__codelineno-151-65" href="#__codelineno-151-65"></a><span class="w">        </span><span class="nt">runAsGroup</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">114</span>
</span><span id="__span-151-66"><a id="__codelineno-151-66" name="__codelineno-151-66" href="#__codelineno-151-66"></a><span class="w">      </span><span class="nt">volumes</span><span class="p">:</span>
</span><span id="__span-151-67"><a id="__codelineno-151-67" name="__codelineno-151-67" href="#__codelineno-151-67"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">influxdb-data</span>
</span><span id="__span-151-68"><a id="__codelineno-151-68" name="__codelineno-151-68" href="#__codelineno-151-68"></a><span class="w">        </span><span class="nt">persistentVolumeClaim</span><span class="p">:</span>
</span><span id="__span-151-69"><a id="__codelineno-151-69" name="__codelineno-151-69" href="#__codelineno-151-69"></a><span class="w">          </span><span class="nt">claimName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">influxdb-pv-claim</span>
</span><span id="__span-151-70"><a id="__codelineno-151-70" name="__codelineno-151-70" href="#__codelineno-151-70"></a><span class="nn">---</span>
</span><span id="__span-151-71"><a id="__codelineno-151-71" name="__codelineno-151-71" href="#__codelineno-151-71"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
</span><span id="__span-151-72"><a id="__codelineno-151-72" name="__codelineno-151-72" href="#__codelineno-151-72"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Service</span>
</span><span id="__span-151-73"><a id="__codelineno-151-73" name="__codelineno-151-73" href="#__codelineno-151-73"></a><span class="nt">metadata</span><span class="p">:</span>
</span><span id="__span-151-74"><a id="__codelineno-151-74" name="__codelineno-151-74" href="#__codelineno-151-74"></a><span class="w">  </span><span class="nt">labels</span><span class="p">:</span>
</span><span id="__span-151-75"><a id="__codelineno-151-75" name="__codelineno-151-75" href="#__codelineno-151-75"></a><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">influxdb</span>
</span><span id="__span-151-76"><a id="__codelineno-151-76" name="__codelineno-151-76" href="#__codelineno-151-76"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">influxdb-svc</span>
</span><span id="__span-151-77"><a id="__codelineno-151-77" name="__codelineno-151-77" href="#__codelineno-151-77"></a><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">monitoring</span>
</span><span id="__span-151-78"><a id="__codelineno-151-78" name="__codelineno-151-78" href="#__codelineno-151-78"></a><span class="nt">spec</span><span class="p">:</span>
</span><span id="__span-151-79"><a id="__codelineno-151-79" name="__codelineno-151-79" href="#__codelineno-151-79"></a><span class="w">  </span><span class="nt">ports</span><span class="p">:</span>
</span><span id="__span-151-80"><a id="__codelineno-151-80" name="__codelineno-151-80" href="#__codelineno-151-80"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">18086</span>
</span><span id="__span-151-81"><a id="__codelineno-151-81" name="__codelineno-151-81" href="#__codelineno-151-81"></a><span class="w">    </span><span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">TCP</span>
</span><span id="__span-151-82"><a id="__codelineno-151-82" name="__codelineno-151-82" href="#__codelineno-151-82"></a><span class="w">    </span><span class="nt">targetPort</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">8086</span>
</span><span id="__span-151-83"><a id="__codelineno-151-83" name="__codelineno-151-83" href="#__codelineno-151-83"></a><span class="w">    </span><span class="nt">nodePort</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">30086</span>
</span><span id="__span-151-84"><a id="__codelineno-151-84" name="__codelineno-151-84" href="#__codelineno-151-84"></a><span class="w">  </span><span class="nt">selector</span><span class="p">:</span>
</span><span id="__span-151-85"><a id="__codelineno-151-85" name="__codelineno-151-85" href="#__codelineno-151-85"></a><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">influxdb</span>
</span><span id="__span-151-86"><a id="__codelineno-151-86" name="__codelineno-151-86" href="#__codelineno-151-86"></a><span class="w">  </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">NodePort</span>
</span><span id="__span-151-87"><a id="__codelineno-151-87" name="__codelineno-151-87" href="#__codelineno-151-87"></a><span class="nn">---</span>
</span><span id="__span-151-88"><a id="__codelineno-151-88" name="__codelineno-151-88" href="#__codelineno-151-88"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
</span><span id="__span-151-89"><a id="__codelineno-151-89" name="__codelineno-151-89" href="#__codelineno-151-89"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">PersistentVolume</span>
</span><span id="__span-151-90"><a id="__codelineno-151-90" name="__codelineno-151-90" href="#__codelineno-151-90"></a><span class="nt">metadata</span><span class="p">:</span>
</span><span id="__span-151-91"><a id="__codelineno-151-91" name="__codelineno-151-91" href="#__codelineno-151-91"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">grafana-pv</span>
</span><span id="__span-151-92"><a id="__codelineno-151-92" name="__codelineno-151-92" href="#__codelineno-151-92"></a><span class="w">  </span><span class="nt">labels</span><span class="p">:</span>
</span><span id="__span-151-93"><a id="__codelineno-151-93" name="__codelineno-151-93" href="#__codelineno-151-93"></a><span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">local</span>
</span><span id="__span-151-94"><a id="__codelineno-151-94" name="__codelineno-151-94" href="#__codelineno-151-94"></a><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">monitoring</span>
</span><span id="__span-151-95"><a id="__codelineno-151-95" name="__codelineno-151-95" href="#__codelineno-151-95"></a><span class="nt">spec</span><span class="p">:</span>
</span><span id="__span-151-96"><a id="__codelineno-151-96" name="__codelineno-151-96" href="#__codelineno-151-96"></a><span class="w">  </span><span class="nt">storageClassName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">manual</span>
</span><span id="__span-151-97"><a id="__codelineno-151-97" name="__codelineno-151-97" href="#__codelineno-151-97"></a><span class="w">  </span><span class="nt">capacity</span><span class="p">:</span>
</span><span id="__span-151-98"><a id="__codelineno-151-98" name="__codelineno-151-98" href="#__codelineno-151-98"></a><span class="w">    </span><span class="nt">storage</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">3Gi</span>
</span><span id="__span-151-99"><a id="__codelineno-151-99" name="__codelineno-151-99" href="#__codelineno-151-99"></a><span class="w">  </span><span class="nt">accessModes</span><span class="p">:</span>
</span><span id="__span-151-100"><a id="__codelineno-151-100" name="__codelineno-151-100" href="#__codelineno-151-100"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ReadWriteOnce</span>
</span><span id="__span-151-101"><a id="__codelineno-151-101" name="__codelineno-151-101" href="#__codelineno-151-101"></a><span class="w">  </span><span class="nt">hostPath</span><span class="p">:</span>
</span><span id="__span-151-102"><a id="__codelineno-151-102" name="__codelineno-151-102" href="#__codelineno-151-102"></a><span class="w">    </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/home/k8s/grafana</span>
</span><span id="__span-151-103"><a id="__codelineno-151-103" name="__codelineno-151-103" href="#__codelineno-151-103"></a><span class="nn">---</span>
</span><span id="__span-151-104"><a id="__codelineno-151-104" name="__codelineno-151-104" href="#__codelineno-151-104"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
</span><span id="__span-151-105"><a id="__codelineno-151-105" name="__codelineno-151-105" href="#__codelineno-151-105"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">PersistentVolumeClaim</span>
</span><span id="__span-151-106"><a id="__codelineno-151-106" name="__codelineno-151-106" href="#__codelineno-151-106"></a><span class="nt">metadata</span><span class="p">:</span>
</span><span id="__span-151-107"><a id="__codelineno-151-107" name="__codelineno-151-107" href="#__codelineno-151-107"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">grafana-pv-claim</span>
</span><span id="__span-151-108"><a id="__codelineno-151-108" name="__codelineno-151-108" href="#__codelineno-151-108"></a><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">monitoring</span>
</span><span id="__span-151-109"><a id="__codelineno-151-109" name="__codelineno-151-109" href="#__codelineno-151-109"></a><span class="nt">spec</span><span class="p">:</span>
</span><span id="__span-151-110"><a id="__codelineno-151-110" name="__codelineno-151-110" href="#__codelineno-151-110"></a><span class="w">  </span><span class="nt">storageClassName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">manual</span>
</span><span id="__span-151-111"><a id="__codelineno-151-111" name="__codelineno-151-111" href="#__codelineno-151-111"></a><span class="w">  </span><span class="nt">volumeName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">grafana-pv</span>
</span><span id="__span-151-112"><a id="__codelineno-151-112" name="__codelineno-151-112" href="#__codelineno-151-112"></a><span class="w">  </span><span class="nt">accessModes</span><span class="p">:</span>
</span><span id="__span-151-113"><a id="__codelineno-151-113" name="__codelineno-151-113" href="#__codelineno-151-113"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ReadWriteOnce</span>
</span><span id="__span-151-114"><a id="__codelineno-151-114" name="__codelineno-151-114" href="#__codelineno-151-114"></a><span class="w">  </span><span class="nt">resources</span><span class="p">:</span>
</span><span id="__span-151-115"><a id="__codelineno-151-115" name="__codelineno-151-115" href="#__codelineno-151-115"></a><span class="w">    </span><span class="nt">requests</span><span class="p">:</span>
</span><span id="__span-151-116"><a id="__codelineno-151-116" name="__codelineno-151-116" href="#__codelineno-151-116"></a><span class="w">      </span><span class="nt">storage</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">3Gi</span>
</span><span id="__span-151-117"><a id="__codelineno-151-117" name="__codelineno-151-117" href="#__codelineno-151-117"></a><span class="nn">---</span>
</span><span id="__span-151-118"><a id="__codelineno-151-118" name="__codelineno-151-118" href="#__codelineno-151-118"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">apps/v1</span>
</span><span id="__span-151-119"><a id="__codelineno-151-119" name="__codelineno-151-119" href="#__codelineno-151-119"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Deployment</span>
</span><span id="__span-151-120"><a id="__codelineno-151-120" name="__codelineno-151-120" href="#__codelineno-151-120"></a><span class="nt">metadata</span><span class="p">:</span>
</span><span id="__span-151-121"><a id="__codelineno-151-121" name="__codelineno-151-121" href="#__codelineno-151-121"></a><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">monitoring</span>
</span><span id="__span-151-122"><a id="__codelineno-151-122" name="__codelineno-151-122" href="#__codelineno-151-122"></a><span class="w">  </span><span class="nt">labels</span><span class="p">:</span>
</span><span id="__span-151-123"><a id="__codelineno-151-123" name="__codelineno-151-123" href="#__codelineno-151-123"></a><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">grafana</span>
</span><span id="__span-151-124"><a id="__codelineno-151-124" name="__codelineno-151-124" href="#__codelineno-151-124"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">grafana</span>
</span><span id="__span-151-125"><a id="__codelineno-151-125" name="__codelineno-151-125" href="#__codelineno-151-125"></a><span class="nt">spec</span><span class="p">:</span>
</span><span id="__span-151-126"><a id="__codelineno-151-126" name="__codelineno-151-126" href="#__codelineno-151-126"></a><span class="w">  </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1</span>
</span><span id="__span-151-127"><a id="__codelineno-151-127" name="__codelineno-151-127" href="#__codelineno-151-127"></a><span class="w">  </span><span class="nt">selector</span><span class="p">:</span>
</span><span id="__span-151-128"><a id="__codelineno-151-128" name="__codelineno-151-128" href="#__codelineno-151-128"></a><span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span>
</span><span id="__span-151-129"><a id="__codelineno-151-129" name="__codelineno-151-129" href="#__codelineno-151-129"></a><span class="w">      </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">grafana</span>
</span><span id="__span-151-130"><a id="__codelineno-151-130" name="__codelineno-151-130" href="#__codelineno-151-130"></a><span class="w">  </span><span class="nt">template</span><span class="p">:</span>
</span><span id="__span-151-131"><a id="__codelineno-151-131" name="__codelineno-151-131" href="#__codelineno-151-131"></a><span class="w">    </span><span class="nt">metadata</span><span class="p">:</span>
</span><span id="__span-151-132"><a id="__codelineno-151-132" name="__codelineno-151-132" href="#__codelineno-151-132"></a><span class="w">      </span><span class="nt">labels</span><span class="p">:</span>
</span><span id="__span-151-133"><a id="__codelineno-151-133" name="__codelineno-151-133" href="#__codelineno-151-133"></a><span class="w">        </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">grafana</span>
</span><span id="__span-151-134"><a id="__codelineno-151-134" name="__codelineno-151-134" href="#__codelineno-151-134"></a><span class="w">    </span><span class="nt">spec</span><span class="p">:</span>
</span><span id="__span-151-135"><a id="__codelineno-151-135" name="__codelineno-151-135" href="#__codelineno-151-135"></a><span class="w">      </span><span class="nt">containers</span><span class="p">:</span>
</span><span id="__span-151-136"><a id="__codelineno-151-136" name="__codelineno-151-136" href="#__codelineno-151-136"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">docker.io/grafana/grafana:11.6.1</span>
</span><span id="__span-151-137"><a id="__codelineno-151-137" name="__codelineno-151-137" href="#__codelineno-151-137"></a><span class="w">        </span><span class="nt">env</span><span class="p">:</span>
</span><span id="__span-151-138"><a id="__codelineno-151-138" name="__codelineno-151-138" href="#__codelineno-151-138"></a><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">HOSTNAME</span>
</span><span id="__span-151-139"><a id="__codelineno-151-139" name="__codelineno-151-139" href="#__codelineno-151-139"></a><span class="w">          </span><span class="nt">valueFrom</span><span class="p">:</span>
</span><span id="__span-151-140"><a id="__codelineno-151-140" name="__codelineno-151-140" href="#__codelineno-151-140"></a><span class="w">            </span><span class="nt">fieldRef</span><span class="p">:</span>
</span><span id="__span-151-141"><a id="__codelineno-151-141" name="__codelineno-151-141" href="#__codelineno-151-141"></a><span class="w">              </span><span class="nt">fieldPath</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">spec.nodeName</span>
</span><span id="__span-151-142"><a id="__codelineno-151-142" name="__codelineno-151-142" href="#__codelineno-151-142"></a><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s">"GF_AUTH_ANONYMOUS_ENABLED"</span>
</span><span id="__span-151-143"><a id="__codelineno-151-143" name="__codelineno-151-143" href="#__codelineno-151-143"></a><span class="w">          </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="s">"true"</span>
</span><span id="__span-151-144"><a id="__codelineno-151-144" name="__codelineno-151-144" href="#__codelineno-151-144"></a><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s">"GF_SECURITY_ADMIN_USER"</span>
</span><span id="__span-151-145"><a id="__codelineno-151-145" name="__codelineno-151-145" href="#__codelineno-151-145"></a><span class="w">          </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="s">"admin"</span>
</span><span id="__span-151-146"><a id="__codelineno-151-146" name="__codelineno-151-146" href="#__codelineno-151-146"></a><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s">"GF_SECURITY_ADMIN_PASSWORD"</span>
</span><span id="__span-151-147"><a id="__codelineno-151-147" name="__codelineno-151-147" href="#__codelineno-151-147"></a><span class="w">          </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="s">"__________________________"</span>
</span><span id="__span-151-148"><a id="__codelineno-151-148" name="__codelineno-151-148" href="#__codelineno-151-148"></a><span class="w">        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">grafana</span>
</span><span id="__span-151-149"><a id="__codelineno-151-149" name="__codelineno-151-149" href="#__codelineno-151-149"></a><span class="w">        </span><span class="nt">volumeMounts</span><span class="p">:</span>
</span><span id="__span-151-150"><a id="__codelineno-151-150" name="__codelineno-151-150" href="#__codelineno-151-150"></a><span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">grafana-data</span>
</span><span id="__span-151-151"><a id="__codelineno-151-151" name="__codelineno-151-151" href="#__codelineno-151-151"></a><span class="w">            </span><span class="nt">mountPath</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/var/lib/grafana</span>
</span><span id="__span-151-152"><a id="__codelineno-151-152" name="__codelineno-151-152" href="#__codelineno-151-152"></a><span class="w">      </span><span class="nt">securityContext</span><span class="p">:</span>
</span><span id="__span-151-153"><a id="__codelineno-151-153" name="__codelineno-151-153" href="#__codelineno-151-153"></a><span class="w">        </span><span class="nt">runAsUser</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">115</span>
</span><span id="__span-151-154"><a id="__codelineno-151-154" name="__codelineno-151-154" href="#__codelineno-151-154"></a><span class="w">        </span><span class="nt">runAsGroup</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">115</span>
</span><span id="__span-151-155"><a id="__codelineno-151-155" name="__codelineno-151-155" href="#__codelineno-151-155"></a><span class="w">        </span><span class="nt">fsGroup</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">115</span>
</span><span id="__span-151-156"><a id="__codelineno-151-156" name="__codelineno-151-156" href="#__codelineno-151-156"></a><span class="w">      </span><span class="nt">volumes</span><span class="p">:</span>
</span><span id="__span-151-157"><a id="__codelineno-151-157" name="__codelineno-151-157" href="#__codelineno-151-157"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">grafana-data</span>
</span><span id="__span-151-158"><a id="__codelineno-151-158" name="__codelineno-151-158" href="#__codelineno-151-158"></a><span class="w">        </span><span class="nt">persistentVolumeClaim</span><span class="p">:</span>
</span><span id="__span-151-159"><a id="__codelineno-151-159" name="__codelineno-151-159" href="#__codelineno-151-159"></a><span class="w">          </span><span class="nt">claimName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">grafana-pv-claim</span>
</span><span id="__span-151-160"><a id="__codelineno-151-160" name="__codelineno-151-160" href="#__codelineno-151-160"></a><span class="nn">---</span>
</span><span id="__span-151-161"><a id="__codelineno-151-161" name="__codelineno-151-161" href="#__codelineno-151-161"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
</span><span id="__span-151-162"><a id="__codelineno-151-162" name="__codelineno-151-162" href="#__codelineno-151-162"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Service</span>
</span><span id="__span-151-163"><a id="__codelineno-151-163" name="__codelineno-151-163" href="#__codelineno-151-163"></a><span class="nt">metadata</span><span class="p">:</span>
</span><span id="__span-151-164"><a id="__codelineno-151-164" name="__codelineno-151-164" href="#__codelineno-151-164"></a><span class="w">  </span><span class="nt">labels</span><span class="p">:</span>
</span><span id="__span-151-165"><a id="__codelineno-151-165" name="__codelineno-151-165" href="#__codelineno-151-165"></a><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">grafana</span>
</span><span id="__span-151-166"><a id="__codelineno-151-166" name="__codelineno-151-166" href="#__codelineno-151-166"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">grafana-svc</span>
</span><span id="__span-151-167"><a id="__codelineno-151-167" name="__codelineno-151-167" href="#__codelineno-151-167"></a><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">monitoring</span>
</span><span id="__span-151-168"><a id="__codelineno-151-168" name="__codelineno-151-168" href="#__codelineno-151-168"></a><span class="nt">spec</span><span class="p">:</span>
</span><span id="__span-151-169"><a id="__codelineno-151-169" name="__codelineno-151-169" href="#__codelineno-151-169"></a><span class="w">  </span><span class="nt">ports</span><span class="p">:</span>
</span><span id="__span-151-170"><a id="__codelineno-151-170" name="__codelineno-151-170" href="#__codelineno-151-170"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">13000</span>
</span><span id="__span-151-171"><a id="__codelineno-151-171" name="__codelineno-151-171" href="#__codelineno-151-171"></a><span class="w">    </span><span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">TCP</span>
</span><span id="__span-151-172"><a id="__codelineno-151-172" name="__codelineno-151-172" href="#__codelineno-151-172"></a><span class="w">    </span><span class="nt">targetPort</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">3000</span>
</span><span id="__span-151-173"><a id="__codelineno-151-173" name="__codelineno-151-173" href="#__codelineno-151-173"></a><span class="w">    </span><span class="nt">nodePort</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">30300</span>
</span><span id="__span-151-174"><a id="__codelineno-151-174" name="__codelineno-151-174" href="#__codelineno-151-174"></a><span class="w">  </span><span class="nt">selector</span><span class="p">:</span>
</span><span id="__span-151-175"><a id="__codelineno-151-175" name="__codelineno-151-175" href="#__codelineno-151-175"></a><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">grafana</span>
</span><span id="__span-151-176"><a id="__codelineno-151-176" name="__codelineno-151-176" href="#__codelineno-151-176"></a><span class="w">  </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">NodePort</span>
</span><span id="__span-151-177"><a id="__codelineno-151-177" name="__codelineno-151-177" href="#__codelineno-151-177"></a><span class="nn">---</span>
</span><span id="__span-151-178"><a id="__codelineno-151-178" name="__codelineno-151-178" href="#__codelineno-151-178"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">networking.k8s.io/v1</span>
</span><span id="__span-151-179"><a id="__codelineno-151-179" name="__codelineno-151-179" href="#__codelineno-151-179"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Ingress</span>
</span><span id="__span-151-180"><a id="__codelineno-151-180" name="__codelineno-151-180" href="#__codelineno-151-180"></a><span class="nt">metadata</span><span class="p">:</span>
</span><span id="__span-151-181"><a id="__codelineno-151-181" name="__codelineno-151-181" href="#__codelineno-151-181"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">grafana-ingress</span>
</span><span id="__span-151-182"><a id="__codelineno-151-182" name="__codelineno-151-182" href="#__codelineno-151-182"></a><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">monitoring</span>
</span><span id="__span-151-183"><a id="__codelineno-151-183" name="__codelineno-151-183" href="#__codelineno-151-183"></a><span class="w">  </span><span class="nt">annotations</span><span class="p">:</span>
</span><span id="__span-151-184"><a id="__codelineno-151-184" name="__codelineno-151-184" href="#__codelineno-151-184"></a><span class="w">    </span><span class="nt">acme.cert-manager.io/http01-edit-in-place</span><span class="p">:</span><span class="w"> </span><span class="s">"true"</span>
</span><span id="__span-151-185"><a id="__codelineno-151-185" name="__codelineno-151-185" href="#__codelineno-151-185"></a><span class="w">    </span><span class="nt">cert-manager.io/issue-temporary-certificate</span><span class="p">:</span><span class="w"> </span><span class="s">"true"</span>
</span><span id="__span-151-186"><a id="__codelineno-151-186" name="__codelineno-151-186" href="#__codelineno-151-186"></a><span class="w">    </span><span class="nt">cert-manager.io/cluster-issuer</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">letsencrypt-prod</span>
</span><span id="__span-151-187"><a id="__codelineno-151-187" name="__codelineno-151-187" href="#__codelineno-151-187"></a><span class="nt">spec</span><span class="p">:</span>
</span><span id="__span-151-188"><a id="__codelineno-151-188" name="__codelineno-151-188" href="#__codelineno-151-188"></a><span class="w">  </span><span class="nt">ingressClassName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nginx</span>
</span><span id="__span-151-189"><a id="__codelineno-151-189" name="__codelineno-151-189" href="#__codelineno-151-189"></a><span class="w">  </span><span class="nt">rules</span><span class="p">:</span>
</span><span id="__span-151-190"><a id="__codelineno-151-190" name="__codelineno-151-190" href="#__codelineno-151-190"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">host</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">grafana-alfred.very-very-dark-gray.top</span>
</span><span id="__span-151-191"><a id="__codelineno-151-191" name="__codelineno-151-191" href="#__codelineno-151-191"></a><span class="w">      </span><span class="nt">http</span><span class="p">:</span>
</span><span id="__span-151-192"><a id="__codelineno-151-192" name="__codelineno-151-192" href="#__codelineno-151-192"></a><span class="w">        </span><span class="nt">paths</span><span class="p">:</span>
</span><span id="__span-151-193"><a id="__codelineno-151-193" name="__codelineno-151-193" href="#__codelineno-151-193"></a><span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/</span>
</span><span id="__span-151-194"><a id="__codelineno-151-194" name="__codelineno-151-194" href="#__codelineno-151-194"></a><span class="w">            </span><span class="nt">pathType</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Prefix</span>
</span><span id="__span-151-195"><a id="__codelineno-151-195" name="__codelineno-151-195" href="#__codelineno-151-195"></a><span class="w">            </span><span class="nt">backend</span><span class="p">:</span>
</span><span id="__span-151-196"><a id="__codelineno-151-196" name="__codelineno-151-196" href="#__codelineno-151-196"></a><span class="w">              </span><span class="nt">service</span><span class="p">:</span>
</span><span id="__span-151-197"><a id="__codelineno-151-197" name="__codelineno-151-197" href="#__codelineno-151-197"></a><span class="w">                </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">grafana-svc</span>
</span><span id="__span-151-198"><a id="__codelineno-151-198" name="__codelineno-151-198" href="#__codelineno-151-198"></a><span class="w">                </span><span class="nt">port</span><span class="p">:</span>
</span><span id="__span-151-199"><a id="__codelineno-151-199" name="__codelineno-151-199" href="#__codelineno-151-199"></a><span class="w">                  </span><span class="nt">number</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">3000</span>
</span><span id="__span-151-200"><a id="__codelineno-151-200" name="__codelineno-151-200" href="#__codelineno-151-200"></a><span class="w">  </span><span class="nt">tls</span><span class="p">:</span>
</span><span id="__span-151-201"><a id="__codelineno-151-201" name="__codelineno-151-201" href="#__codelineno-151-201"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">secretName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">tls-secret-grafana</span>
</span><span id="__span-151-202"><a id="__codelineno-151-202" name="__codelineno-151-202" href="#__codelineno-151-202"></a><span class="w">      </span><span class="nt">hosts</span><span class="p">:</span>
</span><span id="__span-151-203"><a id="__codelineno-151-203" name="__codelineno-151-203" href="#__codelineno-151-203"></a><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">grafana-alfred.very-very-dark-gray.top</span>
</span><span id="__span-151-204"><a id="__codelineno-151-204" name="__codelineno-151-204" href="#__codelineno-151-204"></a><span class="nn">---</span>
</span><span id="__span-151-205"><a id="__codelineno-151-205" name="__codelineno-151-205" href="#__codelineno-151-205"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">networking.k8s.io/v1</span>
</span><span id="__span-151-206"><a id="__codelineno-151-206" name="__codelineno-151-206" href="#__codelineno-151-206"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Ingress</span>
</span><span id="__span-151-207"><a id="__codelineno-151-207" name="__codelineno-151-207" href="#__codelineno-151-207"></a><span class="nt">metadata</span><span class="p">:</span>
</span><span id="__span-151-208"><a id="__codelineno-151-208" name="__codelineno-151-208" href="#__codelineno-151-208"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">grafana-ingress-tailscale</span>
</span><span id="__span-151-209"><a id="__codelineno-151-209" name="__codelineno-151-209" href="#__codelineno-151-209"></a><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">monitoring</span>
</span><span id="__span-151-210"><a id="__codelineno-151-210" name="__codelineno-151-210" href="#__codelineno-151-210"></a><span class="nt">spec</span><span class="p">:</span>
</span><span id="__span-151-211"><a id="__codelineno-151-211" name="__codelineno-151-211" href="#__codelineno-151-211"></a><span class="w">  </span><span class="nt">ingressClassName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">tailscale</span>
</span><span id="__span-151-212"><a id="__codelineno-151-212" name="__codelineno-151-212" href="#__codelineno-151-212"></a><span class="w">  </span><span class="nt">defaultBackend</span><span class="p">:</span>
</span><span id="__span-151-213"><a id="__codelineno-151-213" name="__codelineno-151-213" href="#__codelineno-151-213"></a><span class="w">    </span><span class="nt">service</span><span class="p">:</span>
</span><span id="__span-151-214"><a id="__codelineno-151-214" name="__codelineno-151-214" href="#__codelineno-151-214"></a><span class="w">      </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">grafana-svc</span>
</span><span id="__span-151-215"><a id="__codelineno-151-215" name="__codelineno-151-215" href="#__codelineno-151-215"></a><span class="w">      </span><span class="nt">port</span><span class="p">:</span>
</span><span id="__span-151-216"><a id="__codelineno-151-216" name="__codelineno-151-216" href="#__codelineno-151-216"></a><span class="w">        </span><span class="nt">number</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">3000</span>
</span><span id="__span-151-217"><a id="__codelineno-151-217" name="__codelineno-151-217" href="#__codelineno-151-217"></a><span class="w">  </span><span class="nt">tls</span><span class="p">:</span>
</span><span id="__span-151-218"><a id="__codelineno-151-218" name="__codelineno-151-218" href="#__codelineno-151-218"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">hosts</span><span class="p">:</span>
</span><span id="__span-151-219"><a id="__codelineno-151-219" name="__codelineno-151-219" href="#__codelineno-151-219"></a><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">grafana-alfred</span>
</span></code></pre></div>
</details>
<p>Before deploying the above, dedicated users and home directories must be created for
<code>influxdb</code> and <code>grafana</code>:</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-152-1"><a id="__codelineno-152-1" name="__codelineno-152-1" href="#__codelineno-152-1"></a><span class="gp">$ </span>sudo<span class="w"> </span>groupadd<span class="w"> </span>influxdb<span class="w"> </span>-g<span class="w"> </span><span class="m">114</span>
</span><span id="__span-152-2"><a id="__codelineno-152-2" name="__codelineno-152-2" href="#__codelineno-152-2"></a><span class="gp">$ </span>sudo<span class="w"> </span>groupadd<span class="w"> </span>grafana<span class="w">  </span>-g<span class="w"> </span><span class="m">115</span>
</span><span id="__span-152-3"><a id="__codelineno-152-3" name="__codelineno-152-3" href="#__codelineno-152-3"></a><span class="gp">$ </span>sudo<span class="w"> </span>useradd<span class="w">  </span>influxdb<span class="w"> </span>-u<span class="w"> </span><span class="m">114</span><span class="w"> </span>-g<span class="w"> </span><span class="m">114</span><span class="w"> </span>-s<span class="w"> </span>/usr/sbin/nologin
</span><span id="__span-152-4"><a id="__codelineno-152-4" name="__codelineno-152-4" href="#__codelineno-152-4"></a><span class="gp">$ </span>sudo<span class="w"> </span>useradd<span class="w">  </span>grafana<span class="w">  </span>-u<span class="w"> </span><span class="m">115</span><span class="w"> </span>-g<span class="w"> </span><span class="m">115</span><span class="w"> </span>-s<span class="w"> </span>/usr/sbin/nologin
</span><span id="__span-152-5"><a id="__codelineno-152-5" name="__codelineno-152-5" href="#__codelineno-152-5"></a><span class="gp">$ </span>sudo<span class="w"> </span>mkdir<span class="w"> </span>/home/k8s/influxdb<span class="w"> </span>/home/k8s/grafana
</span><span id="__span-152-6"><a id="__codelineno-152-6" name="__codelineno-152-6" href="#__codelineno-152-6"></a><span class="gp">$ </span>sudo<span class="w"> </span>chown<span class="w"> </span>-R<span class="w"> </span>influxdb:influxdb<span class="w"> </span>/home/k8s/influxdb
</span><span id="__span-152-7"><a id="__codelineno-152-7" name="__codelineno-152-7" href="#__codelineno-152-7"></a><span class="gp">$ </span>sudo<span class="w"> </span>chown<span class="w"> </span>-R<span class="w">  </span>grafana:grafana<span class="w">  </span>/home/k8s/grafana
</span><span id="__span-152-8"><a id="__codelineno-152-8" name="__codelineno-152-8" href="#__codelineno-152-8"></a><span class="gp">$ </span>sudo<span class="w"> </span>ls<span class="w"> </span>-hal<span class="w"> </span>/home/k8s/influxdb<span class="w"> </span>/home/k8s/grafana
</span><span id="__span-152-9"><a id="__codelineno-152-9" name="__codelineno-152-9" href="#__codelineno-152-9"></a><span class="go">/home/k8s/grafana:</span>
</span><span id="__span-152-10"><a id="__codelineno-152-10" name="__codelineno-152-10" href="#__codelineno-152-10"></a><span class="go">total 8.0K</span>
</span><span id="__span-152-11"><a id="__codelineno-152-11" name="__codelineno-152-11" href="#__codelineno-152-11"></a><span class="go">drwxr-xr-x 2 grafana grafana 4.0K May  2 23:54 .</span>
</span><span id="__span-152-12"><a id="__codelineno-152-12" name="__codelineno-152-12" href="#__codelineno-152-12"></a><span class="go">drwxr-xr-x 5 root    root    4.0K May  2 23:54 ..</span>
</span><span id="__span-152-13"><a id="__codelineno-152-13" name="__codelineno-152-13" href="#__codelineno-152-13"></a>
</span><span id="__span-152-14"><a id="__codelineno-152-14" name="__codelineno-152-14" href="#__codelineno-152-14"></a><span class="go">/home/k8s/influxdb:</span>
</span><span id="__span-152-15"><a id="__codelineno-152-15" name="__codelineno-152-15" href="#__codelineno-152-15"></a><span class="go">total 8.0K</span>
</span><span id="__span-152-16"><a id="__codelineno-152-16" name="__codelineno-152-16" href="#__codelineno-152-16"></a><span class="go">drwxr-xr-x 2 influxdb influxdb 4.0K May  2 23:54 .</span>
</span><span id="__span-152-17"><a id="__codelineno-152-17" name="__codelineno-152-17" href="#__codelineno-152-17"></a><span class="go">drwxr-xr-x 5 root     root     4.0K May  2 23:54 ..</span>
</span></code></pre></div>
<p>The apply the new deployment to start InfluxDB and Grafana:</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-153-1"><a id="__codelineno-153-1" name="__codelineno-153-1" href="#__codelineno-153-1"></a><span class="gp">$ </span>kubectl<span class="w"> </span>apply<span class="w"> </span>-f<span class="w"> </span>alfred/monitoring.yaml
</span><span id="__span-153-2"><a id="__codelineno-153-2" name="__codelineno-153-2" href="#__codelineno-153-2"></a><span class="go">namespace/monitoring created</span>
</span><span id="__span-153-3"><a id="__codelineno-153-3" name="__codelineno-153-3" href="#__codelineno-153-3"></a><span class="go">persistentvolume/influxdb-pv created</span>
</span><span id="__span-153-4"><a id="__codelineno-153-4" name="__codelineno-153-4" href="#__codelineno-153-4"></a><span class="go">persistentvolumeclaim/influxdb-pv-claim created</span>
</span><span id="__span-153-5"><a id="__codelineno-153-5" name="__codelineno-153-5" href="#__codelineno-153-5"></a><span class="go">deployment.apps/influxdb created</span>
</span><span id="__span-153-6"><a id="__codelineno-153-6" name="__codelineno-153-6" href="#__codelineno-153-6"></a><span class="go">service/influxdb-svc created</span>
</span><span id="__span-153-7"><a id="__codelineno-153-7" name="__codelineno-153-7" href="#__codelineno-153-7"></a><span class="go">persistentvolume/grafana-pv created</span>
</span><span id="__span-153-8"><a id="__codelineno-153-8" name="__codelineno-153-8" href="#__codelineno-153-8"></a><span class="go">persistentvolumeclaim/grafana-pv-claim created</span>
</span><span id="__span-153-9"><a id="__codelineno-153-9" name="__codelineno-153-9" href="#__codelineno-153-9"></a><span class="go">deployment.apps/grafana created</span>
</span><span id="__span-153-10"><a id="__codelineno-153-10" name="__codelineno-153-10" href="#__codelineno-153-10"></a><span class="go">service/grafana-svc created</span>
</span><span id="__span-153-11"><a id="__codelineno-153-11" name="__codelineno-153-11" href="#__codelineno-153-11"></a><span class="go">ingress.networking.k8s.io/grafana-ingress created</span>
</span><span id="__span-153-12"><a id="__codelineno-153-12" name="__codelineno-153-12" href="#__codelineno-153-12"></a><span class="go">ingress.networking.k8s.io/grafana-ingress-tailscale created</span>
</span><span id="__span-153-13"><a id="__codelineno-153-13" name="__codelineno-153-13" href="#__codelineno-153-13"></a>
</span><span id="__span-153-14"><a id="__codelineno-153-14" name="__codelineno-153-14" href="#__codelineno-153-14"></a><span class="gp">$ </span>kubectl<span class="w"> </span>get<span class="w"> </span>all<span class="w"> </span>-n<span class="w"> </span>monitoring
</span><span id="__span-153-15"><a id="__codelineno-153-15" name="__codelineno-153-15" href="#__codelineno-153-15"></a><span class="go">NAME                            READY   STATUS    RESTARTS   AGE</span>
</span><span id="__span-153-16"><a id="__codelineno-153-16" name="__codelineno-153-16" href="#__codelineno-153-16"></a><span class="go">pod/cm-acme-http-solver-4kh85   1/1     Running   0          18s</span>
</span><span id="__span-153-17"><a id="__codelineno-153-17" name="__codelineno-153-17" href="#__codelineno-153-17"></a><span class="go">pod/grafana-895c94879-j5dnr     1/1     Running   0          22s</span>
</span><span id="__span-153-18"><a id="__codelineno-153-18" name="__codelineno-153-18" href="#__codelineno-153-18"></a><span class="go">pod/influxdb-5974bf664f-zwwrx   1/1     Running   0          23s</span>
</span><span id="__span-153-19"><a id="__codelineno-153-19" name="__codelineno-153-19" href="#__codelineno-153-19"></a>
</span><span id="__span-153-20"><a id="__codelineno-153-20" name="__codelineno-153-20" href="#__codelineno-153-20"></a><span class="go">NAME                                TYPE       CLUSTER-IP     EXTERNAL-IP   PORT(S)           AGE</span>
</span><span id="__span-153-21"><a id="__codelineno-153-21" name="__codelineno-153-21" href="#__codelineno-153-21"></a><span class="go">service/cm-acme-http-solver-p4cxg   NodePort   10.109.30.68   &lt;none&gt;        8089:32080/TCP    18s</span>
</span><span id="__span-153-22"><a id="__codelineno-153-22" name="__codelineno-153-22" href="#__codelineno-153-22"></a><span class="go">service/grafana-svc                 NodePort   10.111.30.81   &lt;none&gt;        13000:30300/TCP   22s</span>
</span><span id="__span-153-23"><a id="__codelineno-153-23" name="__codelineno-153-23" href="#__codelineno-153-23"></a><span class="go">service/influxdb-svc                NodePort   10.104.23.44   &lt;none&gt;        18086:30086/TCP   23s</span>
</span><span id="__span-153-24"><a id="__codelineno-153-24" name="__codelineno-153-24" href="#__codelineno-153-24"></a>
</span><span id="__span-153-25"><a id="__codelineno-153-25" name="__codelineno-153-25" href="#__codelineno-153-25"></a><span class="go">NAME                       READY   UP-TO-DATE   AVAILABLE   AGE</span>
</span><span id="__span-153-26"><a id="__codelineno-153-26" name="__codelineno-153-26" href="#__codelineno-153-26"></a><span class="go">deployment.apps/grafana    1/1     1            1           22s</span>
</span><span id="__span-153-27"><a id="__codelineno-153-27" name="__codelineno-153-27" href="#__codelineno-153-27"></a><span class="go">deployment.apps/influxdb   1/1     1            1           23s</span>
</span><span id="__span-153-28"><a id="__codelineno-153-28" name="__codelineno-153-28" href="#__codelineno-153-28"></a>
</span><span id="__span-153-29"><a id="__codelineno-153-29" name="__codelineno-153-29" href="#__codelineno-153-29"></a><span class="go">NAME                                  DESIRED   CURRENT   READY   AGE</span>
</span><span id="__span-153-30"><a id="__codelineno-153-30" name="__codelineno-153-30" href="#__codelineno-153-30"></a><span class="go">replicaset.apps/grafana-895c94879     1         1         1       22s</span>
</span><span id="__span-153-31"><a id="__codelineno-153-31" name="__codelineno-153-31" href="#__codelineno-153-31"></a><span class="go">replicaset.apps/influxdb-5974bf664f   1         1         1       23s</span>
</span><span id="__span-153-32"><a id="__codelineno-153-32" name="__codelineno-153-32" href="#__codelineno-153-32"></a>
</span><span id="__span-153-33"><a id="__codelineno-153-33" name="__codelineno-153-33" href="#__codelineno-153-33"></a><span class="gp">$ </span>kubectl<span class="w"> </span>get<span class="w"> </span>ingress<span class="w"> </span>-n<span class="w"> </span>monitoring
</span><span id="__span-153-34"><a id="__codelineno-153-34" name="__codelineno-153-34" href="#__codelineno-153-34"></a><span class="go">NAME                        CLASS       HOSTS                                     ADDRESS                              PORTS     AGE</span>
</span><span id="__span-153-35"><a id="__codelineno-153-35" name="__codelineno-153-35" href="#__codelineno-153-35"></a><span class="go">grafana-ingress             nginx       grafana-alfred.very-very-dark-gray.top    192.168.0.124                        80, 443   41h</span>
</span><span id="__span-153-36"><a id="__codelineno-153-36" name="__codelineno-153-36" href="#__codelineno-153-36"></a><span class="go">grafana-ingress-tailscale   tailscale   *                                         grafana-alfred.royal-penny.ts.net    80, 443   3m33s</span>
</span></code></pre></div>
<p>After a couple of minutes both services are running fine and Grafana is available at
<a href="https://grafana-alfred.royal-penny.ts.net">https://grafana-alfred.royal-penny.ts.net</a> and
<a href="https://grafana-alfred.very-very-dark-gray.top">https://grafana-alfred.very-very-dark-gray.top</a> but it will be empty because before
anything and report to InfluxDB, it must be initialized.</p>
<h3 id="secure-influxdb">Secure InfluxDB</h3>
<p><a href="../../../../2024/04/20/monitoring-with-influxdb-and-grafana-on-kubernetes/#secure-influxdb">Secure InfluxDB</a>
by first creating an <code>admin</code> user with a password:</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-154-1"><a id="__codelineno-154-1" name="__codelineno-154-1" href="#__codelineno-154-1"></a><span class="gp">$ </span>influx<span class="w"> </span>-host<span class="w"> </span>localhost<span class="w"> </span>-port<span class="w"> </span><span class="m">30086</span>
</span><span id="__span-154-2"><a id="__codelineno-154-2" name="__codelineno-154-2" href="#__codelineno-154-2"></a><span class="go">Connected to http://localhost:30086 version v1.11.8</span>
</span><span id="__span-154-3"><a id="__codelineno-154-3" name="__codelineno-154-3" href="#__codelineno-154-3"></a><span class="go">InfluxDB shell version: 1.6.7~rc0</span>
</span><span id="__span-154-4"><a id="__codelineno-154-4" name="__codelineno-154-4" href="#__codelineno-154-4"></a><span class="go">&gt; CREATE USER admin WITH PASSWORD '**********' WITH ALL PRIVILEGES</span>
</span></code></pre></div>
<p>After that, re-login with the password and create databases <code>monitoring</code> (for
<a href="#continuous-monitoring">Continuous Monitoring</a>) and <code>home_assistant</code> (for
<a href="#home-assistant">Home Assistant</a>). </p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-155-1"><a id="__codelineno-155-1" name="__codelineno-155-1" href="#__codelineno-155-1"></a><span class="gp">$ </span>influx<span class="w"> </span>-host<span class="w"> </span>localhost<span class="w"> </span>-port<span class="w"> </span><span class="m">30086</span><span class="w"> </span>-username<span class="w"> </span>admin<span class="w"> </span>-password<span class="w"> </span><span class="s1">'**********'</span>
</span><span id="__span-155-2"><a id="__codelineno-155-2" name="__codelineno-155-2" href="#__codelineno-155-2"></a><span class="go">Connected to http://localhost:30086 version v1.11.8</span>
</span><span id="__span-155-3"><a id="__codelineno-155-3" name="__codelineno-155-3" href="#__codelineno-155-3"></a><span class="go">InfluxDB shell version: 1.6.7~rc0</span>
</span><span id="__span-155-4"><a id="__codelineno-155-4" name="__codelineno-155-4" href="#__codelineno-155-4"></a>
</span><span id="__span-155-5"><a id="__codelineno-155-5" name="__codelineno-155-5" href="#__codelineno-155-5"></a><span class="go">&gt; CREATE DATABASE monitoring</span>
</span><span id="__span-155-6"><a id="__codelineno-155-6" name="__codelineno-155-6" href="#__codelineno-155-6"></a><span class="go">&gt; USE monitoring</span>
</span><span id="__span-155-7"><a id="__codelineno-155-7" name="__codelineno-155-7" href="#__codelineno-155-7"></a><span class="go">Using database monitoring</span>
</span><span id="__span-155-8"><a id="__codelineno-155-8" name="__codelineno-155-8" href="#__codelineno-155-8"></a>
</span><span id="__span-155-9"><a id="__codelineno-155-9" name="__codelineno-155-9" href="#__codelineno-155-9"></a><span class="go">&gt; CREATE RETENTION POLICY "90_days" ON "monitoring" DURATION 30d REPLICATION 1</span>
</span><span id="__span-155-10"><a id="__codelineno-155-10" name="__codelineno-155-10" href="#__codelineno-155-10"></a><span class="go">&gt; ALTER RETENTION POLICY "90_days" on "monitoring" DURATION 30d REPLICATION 1 DEFAULT</span>
</span><span id="__span-155-11"><a id="__codelineno-155-11" name="__codelineno-155-11" href="#__codelineno-155-11"></a>
</span><span id="__span-155-12"><a id="__codelineno-155-12" name="__codelineno-155-12" href="#__codelineno-155-12"></a><span class="go">&gt; CREATE DATABASE home_assistant</span>
</span><span id="__span-155-13"><a id="__codelineno-155-13" name="__codelineno-155-13" href="#__codelineno-155-13"></a><span class="go">&gt; USE home_assistant</span>
</span><span id="__span-155-14"><a id="__codelineno-155-14" name="__codelineno-155-14" href="#__codelineno-155-14"></a><span class="go">Using database home_assistant</span>
</span><span id="__span-155-15"><a id="__codelineno-155-15" name="__codelineno-155-15" href="#__codelineno-155-15"></a>
</span><span id="__span-155-16"><a id="__codelineno-155-16" name="__codelineno-155-16" href="#__codelineno-155-16"></a><span class="go">&gt; CREATE RETENTION POLICY "800_days" ON "home_assistant" DURATION 30d REPLICATION 1</span>
</span><span id="__span-155-17"><a id="__codelineno-155-17" name="__codelineno-155-17" href="#__codelineno-155-17"></a><span class="go">&gt; ALTER RETENTION POLICY "800_days" on "home_assistant" DURATION 30d REPLICATION 1 DEFAULT</span>
</span><span id="__span-155-18"><a id="__codelineno-155-18" name="__codelineno-155-18" href="#__codelineno-155-18"></a>
</span><span id="__span-155-19"><a id="__codelineno-155-19" name="__codelineno-155-19" href="#__codelineno-155-19"></a><span class="go">&gt; CREATE USER conmon WITH password ''</span>
</span><span id="__span-155-20"><a id="__codelineno-155-20" name="__codelineno-155-20" href="#__codelineno-155-20"></a><span class="go">&gt; GRANT ALL PRIVILEGES ON "monitoring" TO "conmon"</span>
</span></code></pre></div>
<p><a href="../../../../2024/04/20/monitoring-with-influxdb-and-grafana-on-kubernetes/#influxdb-authentication">InfluxDB Authentication</a>
is enabled by the <code>INFLUXDB_HTTP_AUTH_ENABLED</code> setting in the above deployment.
The user <code>conmon</code> with an empty password, granted read and write access to the
<code>monitoring</code> database, is created to allow the <code>conmon</code> script to report to <em>both</em>
this system (without authentication) and remotely to <code>octavo</code> (with authentication).
The <code>conmon</code> user can then be used to both report metrics from the <code>conmon</code> script
and read metrics from Grafana.</p>
<div class="language-bash highlight"><span class="filename">/usr/local/bin/conmon</span><pre><span></span><code><span id="__span-156-1"><a id="__codelineno-156-1" name="__codelineno-156-1" href="#__codelineno-156-1"></a><span class="ch">#!/bin/bash</span>
</span><span id="__span-156-2"><a id="__codelineno-156-2" name="__codelineno-156-2" href="#__codelineno-156-2"></a><span class="c1">#</span>
</span><span id="__span-156-3"><a id="__codelineno-156-3" name="__codelineno-156-3" href="#__codelineno-156-3"></a><span class="c1"># Export system monitoring metrics to influxdb.</span>
</span><span id="__span-156-4"><a id="__codelineno-156-4" name="__codelineno-156-4" href="#__codelineno-156-4"></a>
</span><span id="__span-156-5"><a id="__codelineno-156-5" name="__codelineno-156-5" href="#__codelineno-156-5"></a><span class="c1"># InfluxDB target.</span>
</span><span id="__span-156-6"><a id="__codelineno-156-6" name="__codelineno-156-6" href="#__codelineno-156-6"></a><span class="c1"># HTTP works only with a 'conmon' user with empty password.</span>
</span><span id="__span-156-7"><a id="__codelineno-156-7" name="__codelineno-156-7" href="#__codelineno-156-7"></a><span class="nv">DBNAME</span><span class="o">=</span>monitoring
</span><span id="__span-156-8"><a id="__codelineno-156-8" name="__codelineno-156-8" href="#__codelineno-156-8"></a><span class="hll"><span class="nv">TARGET_HTTP</span><span class="o">=</span><span class="s1">'http://localhost:30086'</span>
</span></span><span id="__span-156-9"><a id="__codelineno-156-9" name="__codelineno-156-9" href="#__codelineno-156-9"></a><span class="nv">TARGET_HTTPS</span><span class="o">=</span><span class="s1">'https://influxdb.very-very-dark-gray.top:443'</span>
</span></code></pre></div>
<h3 id="grafana-dashboards">Grafana Dashboards</h3>
<p>With the databases in place and <code>conmon</code> reporting metrics to the local InfluxDB,
create <strong>Data sources</strong> for the above databases using the relevant credentails
(or just use <code>admin</code> for all of them). Once Data Sources are successfully setup,
the relevant dashboards can now be exported from Grafana in <code>octavo</code> using the
<strong>Export as JSON</strong> functionality from each existing dashboard, with the option to
<strong>Export the dashboard to use in another instance</strong> enabled.</p>
<h2 id="home-assistant">Home Assistant</h2>
<p>To install <a href="https://www.home-assistant.io/">Home Assistant</a> in Kubernetes,
<a href="https://github.com/abalage/home-assistant-k8s/tree/main?tab=readme-ov-file#home-assistant-k8s">abalage/home-assistant-k8s</a>
offers a very good starting point, including the use of <code>kustomize</code> which
will be useful to have the same <em>base</em> deployment in two systems with
minimal differences.</p>
<p><a href="https://www.reddit.com/r/homeassistant/comments/ygmcpg/anyone_running_it_in_kubernetes_and_if_yes_how/">Additional tweaks</a> 
are needed to make discovery work, based off the
<a href="https://www.home-assistant.io/installation/linux#docker-compose">docker-compose</a>:</p>
<div class="language-yaml highlight"><pre><span></span><code><span id="__span-157-1"><a id="__codelineno-157-1" name="__codelineno-157-1" href="#__codelineno-157-1"></a><span class="nt">services</span><span class="p">:</span>
</span><span id="__span-157-2"><a id="__codelineno-157-2" name="__codelineno-157-2" href="#__codelineno-157-2"></a><span class="w">  </span><span class="nt">homeassistant</span><span class="p">:</span>
</span><span id="__span-157-3"><a id="__codelineno-157-3" name="__codelineno-157-3" href="#__codelineno-157-3"></a><span class="w">    </span><span class="nt">container_name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">homeassistant</span>
</span><span id="__span-157-4"><a id="__codelineno-157-4" name="__codelineno-157-4" href="#__codelineno-157-4"></a><span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="s">"ghcr.io/home-assistant/home-assistant:stable"</span>
</span><span id="__span-157-5"><a id="__codelineno-157-5" name="__codelineno-157-5" href="#__codelineno-157-5"></a><span class="w">    </span><span class="nt">volumes</span><span class="p">:</span>
</span><span id="__span-157-6"><a id="__codelineno-157-6" name="__codelineno-157-6" href="#__codelineno-157-6"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/PATH_TO_YOUR_CONFIG:/config</span>
</span><span id="__span-157-7"><a id="__codelineno-157-7" name="__codelineno-157-7" href="#__codelineno-157-7"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/etc/localtime:/etc/localtime:ro</span>
</span><span id="__span-157-8"><a id="__codelineno-157-8" name="__codelineno-157-8" href="#__codelineno-157-8"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/run/dbus:/run/dbus:ro</span>
</span><span id="__span-157-9"><a id="__codelineno-157-9" name="__codelineno-157-9" href="#__codelineno-157-9"></a><span class="w">    </span><span class="nt">restart</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">unless-stopped</span>
</span><span id="__span-157-10"><a id="__codelineno-157-10" name="__codelineno-157-10" href="#__codelineno-157-10"></a><span class="hll"><span class="w">    </span><span class="nt">privileged</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
</span></span><span id="__span-157-11"><a id="__codelineno-157-11" name="__codelineno-157-11" href="#__codelineno-157-11"></a><span class="hll"><span class="w">    </span><span class="nt">network_mode</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">host</span>
</span></span></code></pre></div>
<h3 id="base-deployment">Base deployment</h3>
<p>In addition to <code>privileged: true</code> and <code>network_mode: host</code>
<a href="https://www.reddit.com/r/homeassistant/comments/ygmcpg/comment/iu9eomv/">it is also necessary to add certain <code>capabilities</code></a>
to make network discover work. It is not yet clear whether this will be
actually necessary for the currently available devices, mostly just
<a href="../../../../2024/12/28/continuous-monitoring-for-tp-link-tapo-devices/">TP-Link Tapo devices</a>.
Further adjustments include adding a hard-coded <code>namespace</code> and adding two
different <code>Ingress</code>; one for use with <a href="#tailscale">Tailscale</a> and the other
one for use with <a href="#cloudflare-tunnel">Cloudflare Tunnel</a>.</p>
<ul>
<li><code>configmap.yaml</code> includes a minimal <code>configuration.yaml</code> needed to allow
     requests through the reverse proxy.</li>
<li><code>persistent-volume.yaml</code> provides a simple physical volume (and claim)
    to store files in a local directory.</li>
<li><code>deployment.yaml</code> defines how the Home Assistant pod runs and updates.</li>
<li><code>service.yaml</code> defines how the pod's port 8123 is exposed, to be used by...</li>
<li><code>ingress.yaml</code> which maps specific hostnames (FQDN) to the pod's port 8123.</li>
<li><code>kustomization.yaml</code> presents all the above to be <em>kustomized</em> for each server.</li>
</ul>
<h4 id="caveat-on-reverse-proxies">Caveat on reverse proxies</h4>
<p>The initial configuration created by Home Assistant includes mostly empty files,
which does not allow request coming through reverse proxies. Services are running,
but Cloudflare and Tailscale are getting nothing but <code>400: Bad Request</code>:</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-158-1"><a id="__codelineno-158-1" name="__codelineno-158-1" href="#__codelineno-158-1"></a><span class="gp">$ </span>curl<span class="w"> </span><span class="m">2</span>&gt;/dev/null<span class="w"> </span><span class="se">\</span>
</span><span id="__span-158-2"><a id="__codelineno-158-2" name="__codelineno-158-2" href="#__codelineno-158-2"></a><span class="w">  </span>-H<span class="w"> </span><span class="s2">"Host: home-assistant-alfred.very-very-dark-gray.top"</span><span class="w"> </span><span class="se">\</span>
</span><span id="__span-158-3"><a id="__codelineno-158-3" name="__codelineno-158-3" href="#__codelineno-158-3"></a><span class="w">  </span>-k<span class="w"> </span>https://192.168.0.151/<span class="w"> </span>
</span><span id="__span-158-4"><a id="__codelineno-158-4" name="__codelineno-158-4" href="#__codelineno-158-4"></a><span class="go">400: Bad Request</span>
</span><span id="__span-158-5"><a id="__codelineno-158-5" name="__codelineno-158-5" href="#__codelineno-158-5"></a>
</span><span id="__span-158-6"><a id="__codelineno-158-6" name="__codelineno-158-6" href="#__codelineno-158-6"></a><span class="gp">$ </span>curl<span class="w"> </span>-I<span class="w"> </span>-k<span class="w"> </span>https://home-assistant-alfred.royal-penny.ts.net/
</span><span id="__span-158-7"><a id="__codelineno-158-7" name="__codelineno-158-7" href="#__codelineno-158-7"></a><span class="go">HTTP/2 400 </span>
</span><span id="__span-158-8"><a id="__codelineno-158-8" name="__codelineno-158-8" href="#__codelineno-158-8"></a><span class="go">content-type: text/plain; charset=utf-8</span>
</span><span id="__span-158-9"><a id="__codelineno-158-9" name="__codelineno-158-9" href="#__codelineno-158-9"></a><span class="go">date: Sun, 20 Apr 2025 19:42:46 GMT</span>
</span><span id="__span-158-10"><a id="__codelineno-158-10" name="__codelineno-158-10" href="#__codelineno-158-10"></a><span class="go">server: Python/3.13 aiohttp/3.11.16</span>
</span><span id="__span-158-11"><a id="__codelineno-158-11" name="__codelineno-158-11" href="#__codelineno-158-11"></a><span class="go">content-length: 16</span>
</span></code></pre></div>
<p>Inspecting the logs from the <code>home-assistant</code> pod shows this is in fact an issue in
Home Assistant itself:</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-159-1"><a id="__codelineno-159-1" name="__codelineno-159-1" href="#__codelineno-159-1"></a><span class="gp">$ </span>kubectl<span class="w"> </span>logs<span class="w"> </span>-n<span class="w"> </span>home-assistant<span class="w"> </span><span class="se">\</span>
</span><span id="__span-159-2"><a id="__codelineno-159-2" name="__codelineno-159-2" href="#__codelineno-159-2"></a><span class="gp">  $</span><span class="o">(</span>kubectl<span class="w"> </span>get<span class="w"> </span>pods<span class="w"> </span>-n<span class="w"> </span>home-assistant<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>home-assistant<span class="w"> </span><span class="p">|</span><span class="w"> </span>cut<span class="w"> </span>-f1<span class="w"> </span>-d<span class="s1">' '</span><span class="o">)</span><span class="w"> </span>-f
</span><span id="__span-159-3"><a id="__codelineno-159-3" name="__codelineno-159-3" href="#__codelineno-159-3"></a><span class="go">s6-rc: info: service legacy-services successfully started</span>
</span><span id="__span-159-4"><a id="__codelineno-159-4" name="__codelineno-159-4" href="#__codelineno-159-4"></a><span class="go">2025-04-20 21:42:26.465 ERROR (MainThread) [homeassistant.components.http.forwarded] A request from a reverse proxy was received from 10.244.0.105, but your HTTP integration is not set-up for reverse proxies</span>
</span></code></pre></div>
<p><a href="https://community.home-assistant.io/t/a-request-from-a-reverse-proxy-was-received-from/314089">This warning became an error in 2021.7</a>
and the solution is to add the following into Home Assistant's <code>configuration.yaml</code>
<a href="https://www.home-assistant.io/integrations/http/#reverse-proxies">to allow the reverse proxy</a>
(allowing the entire Kubernetes IP range):</p>
<div class="language-yaml highlight"><span class="filename">/home/k8s/home-assistant/configuration.yaml</span><pre><span></span><code><span id="__span-160-1"><a id="__codelineno-160-1" name="__codelineno-160-1" href="#__codelineno-160-1"></a><span class="nt">http</span><span class="p">:</span>
</span><span id="__span-160-2"><a id="__codelineno-160-2" name="__codelineno-160-2" href="#__codelineno-160-2"></a><span class="w">  </span><span class="nt">use_x_forwarded_for</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
</span><span id="__span-160-3"><a id="__codelineno-160-3" name="__codelineno-160-3" href="#__codelineno-160-3"></a><span class="w">  </span><span class="nt">trusted_proxies</span><span class="p">:</span>
</span><span id="__span-160-4"><a id="__codelineno-160-4" name="__codelineno-160-4" href="#__codelineno-160-4"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10.244.0.0/16</span>
</span></code></pre></div>
<p>Changes to files in <code>/home/k8s/home-assistant</code> will persist through pod and node 
restarts because this config directory is mounted to a persistent volume. However,
such changes to config files will not be effective without restarting the pod or node.
A <code>ConfigMap</code> can be used to achieve a more permanent solution for the above, which is
why it is included below. Such a <code>ConfigMap</code> is found in the manifests presented in
<a href="https://faun.pub/running-your-home-assistant-on-kubernetes-part-ii-60eb46a73c61">Running your Home Assistant on Kubernetes  Part II</a>,
but these are problematic because (apparently) the use of <code>!</code> in the <code>ConfigMap</code>
leads to Home Assistant failing to parse the config and going into <em>recovery mode</em>.</p>
<h4 id="base-deployment-manifests">Base deployment manifests</h4>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Sometimes the use of <code>!include</code> in the <code>ConfigMap</code> or else Home Assistant will
fail to parse it, go into <em>recovery mode</em> and start without allowing requests
coming in through the reverse proxy. The following <code>ConfigMap</code> omits such
lines to address the <a href="#caveat-on-reverse-proxies">Caveat on reverse proxies</a>.</p>
</div>
<details class="k8s">
<summary><code>base/configmap.yaml</code></summary>
<div class="language-yaml highlight"><pre><span></span><code><span id="__span-161-1"><a id="__codelineno-161-1" name="__codelineno-161-1" href="#__codelineno-161-1"></a><span class="nn">---</span>
</span><span id="__span-161-2"><a id="__codelineno-161-2" name="__codelineno-161-2" href="#__codelineno-161-2"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ConfigMap</span>
</span><span id="__span-161-3"><a id="__codelineno-161-3" name="__codelineno-161-3" href="#__codelineno-161-3"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
</span><span id="__span-161-4"><a id="__codelineno-161-4" name="__codelineno-161-4" href="#__codelineno-161-4"></a><span class="nt">metadata</span><span class="p">:</span>
</span><span id="__span-161-5"><a id="__codelineno-161-5" name="__codelineno-161-5" href="#__codelineno-161-5"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">home-assistant-configmap</span>
</span><span id="__span-161-6"><a id="__codelineno-161-6" name="__codelineno-161-6" href="#__codelineno-161-6"></a><span class="nt">data</span><span class="p">:</span>
</span><span id="__span-161-7"><a id="__codelineno-161-7" name="__codelineno-161-7" href="#__codelineno-161-7"></a><span class="w">  </span><span class="nt">configuration.yaml</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|-</span>
</span><span id="__span-161-8"><a id="__codelineno-161-8" name="__codelineno-161-8" href="#__codelineno-161-8"></a><span class="w">    </span><span class="no">default_config:</span>
</span><span id="__span-161-9"><a id="__codelineno-161-9" name="__codelineno-161-9" href="#__codelineno-161-9"></a><span class="w">    </span><span class="no">http:</span>
</span><span id="__span-161-10"><a id="__codelineno-161-10" name="__codelineno-161-10" href="#__codelineno-161-10"></a><span class="w">      </span><span class="no">use_x_forwarded_for: true</span>
</span><span id="__span-161-11"><a id="__codelineno-161-11" name="__codelineno-161-11" href="#__codelineno-161-11"></a><span class="w">      </span><span class="no">trusted_proxies:</span>
</span><span id="__span-161-12"><a id="__codelineno-161-12" name="__codelineno-161-12" href="#__codelineno-161-12"></a><span class="w">        </span><span class="no">- 10.244.0.0/16</span>
</span></code></pre></div>
</details>
<details class="k8s">
<summary><code>base/persistent-volume.yaml</code></summary>
<div class="language-yaml highlight"><pre><span></span><code><span id="__span-162-1"><a id="__codelineno-162-1" name="__codelineno-162-1" href="#__codelineno-162-1"></a><span class="nn">---</span>
</span><span id="__span-162-2"><a id="__codelineno-162-2" name="__codelineno-162-2" href="#__codelineno-162-2"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
</span><span id="__span-162-3"><a id="__codelineno-162-3" name="__codelineno-162-3" href="#__codelineno-162-3"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">PersistentVolume</span>
</span><span id="__span-162-4"><a id="__codelineno-162-4" name="__codelineno-162-4" href="#__codelineno-162-4"></a><span class="nt">metadata</span><span class="p">:</span>
</span><span id="__span-162-5"><a id="__codelineno-162-5" name="__codelineno-162-5" href="#__codelineno-162-5"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">home-assistant-pv-config</span>
</span><span id="__span-162-6"><a id="__codelineno-162-6" name="__codelineno-162-6" href="#__codelineno-162-6"></a><span class="nt">spec</span><span class="p">:</span>
</span><span id="__span-162-7"><a id="__codelineno-162-7" name="__codelineno-162-7" href="#__codelineno-162-7"></a><span class="w">  </span><span class="nt">storageClassName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">manual</span>
</span><span id="__span-162-8"><a id="__codelineno-162-8" name="__codelineno-162-8" href="#__codelineno-162-8"></a><span class="w">  </span><span class="nt">capacity</span><span class="p">:</span>
</span><span id="__span-162-9"><a id="__codelineno-162-9" name="__codelineno-162-9" href="#__codelineno-162-9"></a><span class="w">    </span><span class="nt">storage</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1Gi</span>
</span><span id="__span-162-10"><a id="__codelineno-162-10" name="__codelineno-162-10" href="#__codelineno-162-10"></a><span class="w">  </span><span class="nt">accessModes</span><span class="p">:</span>
</span><span id="__span-162-11"><a id="__codelineno-162-11" name="__codelineno-162-11" href="#__codelineno-162-11"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ReadWriteOnce</span>
</span><span id="__span-162-12"><a id="__codelineno-162-12" name="__codelineno-162-12" href="#__codelineno-162-12"></a><span class="w">  </span><span class="nt">persistentVolumeReclaimPolicy</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Retain</span>
</span><span id="__span-162-13"><a id="__codelineno-162-13" name="__codelineno-162-13" href="#__codelineno-162-13"></a><span class="w">  </span><span class="nt">hostPath</span><span class="p">:</span>
</span><span id="__span-162-14"><a id="__codelineno-162-14" name="__codelineno-162-14" href="#__codelineno-162-14"></a><span class="w">    </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/home/k8s/home-assistant</span>
</span><span id="__span-162-15"><a id="__codelineno-162-15" name="__codelineno-162-15" href="#__codelineno-162-15"></a><span class="nn">---</span>
</span><span id="__span-162-16"><a id="__codelineno-162-16" name="__codelineno-162-16" href="#__codelineno-162-16"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
</span><span id="__span-162-17"><a id="__codelineno-162-17" name="__codelineno-162-17" href="#__codelineno-162-17"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">PersistentVolumeClaim</span>
</span><span id="__span-162-18"><a id="__codelineno-162-18" name="__codelineno-162-18" href="#__codelineno-162-18"></a><span class="nt">metadata</span><span class="p">:</span>
</span><span id="__span-162-19"><a id="__codelineno-162-19" name="__codelineno-162-19" href="#__codelineno-162-19"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">home-assistant-config-root</span>
</span><span id="__span-162-20"><a id="__codelineno-162-20" name="__codelineno-162-20" href="#__codelineno-162-20"></a><span class="nt">spec</span><span class="p">:</span>
</span><span id="__span-162-21"><a id="__codelineno-162-21" name="__codelineno-162-21" href="#__codelineno-162-21"></a><span class="w">  </span><span class="nt">storageClassName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">manual</span>
</span><span id="__span-162-22"><a id="__codelineno-162-22" name="__codelineno-162-22" href="#__codelineno-162-22"></a><span class="w">  </span><span class="nt">volumeName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">home-assistant-pv-config</span>
</span><span id="__span-162-23"><a id="__codelineno-162-23" name="__codelineno-162-23" href="#__codelineno-162-23"></a><span class="w">  </span><span class="nt">accessModes</span><span class="p">:</span>
</span><span id="__span-162-24"><a id="__codelineno-162-24" name="__codelineno-162-24" href="#__codelineno-162-24"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ReadWriteOnce</span>
</span><span id="__span-162-25"><a id="__codelineno-162-25" name="__codelineno-162-25" href="#__codelineno-162-25"></a><span class="w">  </span><span class="nt">volumeMode</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Filesystem</span>
</span><span id="__span-162-26"><a id="__codelineno-162-26" name="__codelineno-162-26" href="#__codelineno-162-26"></a><span class="w">  </span><span class="nt">resources</span><span class="p">:</span>
</span><span id="__span-162-27"><a id="__codelineno-162-27" name="__codelineno-162-27" href="#__codelineno-162-27"></a><span class="w">    </span><span class="nt">requests</span><span class="p">:</span>
</span><span id="__span-162-28"><a id="__codelineno-162-28" name="__codelineno-162-28" href="#__codelineno-162-28"></a><span class="w">      </span><span class="nt">storage</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1Gi</span>
</span></code></pre></div>
</details>
<details class="k8s">
<summary><code>base/deployment.yaml</code></summary>
<div class="language-yaml highlight"><pre><span></span><code><span id="__span-163-1"><a id="__codelineno-163-1" name="__codelineno-163-1" href="#__codelineno-163-1"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
</span><span id="__span-163-2"><a id="__codelineno-163-2" name="__codelineno-163-2" href="#__codelineno-163-2"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Namespace</span>
</span><span id="__span-163-3"><a id="__codelineno-163-3" name="__codelineno-163-3" href="#__codelineno-163-3"></a><span class="nt">metadata</span><span class="p">:</span>
</span><span id="__span-163-4"><a id="__codelineno-163-4" name="__codelineno-163-4" href="#__codelineno-163-4"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">home-assistant</span>
</span><span id="__span-163-5"><a id="__codelineno-163-5" name="__codelineno-163-5" href="#__codelineno-163-5"></a><span class="nn">---</span>
</span><span id="__span-163-6"><a id="__codelineno-163-6" name="__codelineno-163-6" href="#__codelineno-163-6"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">apps/v1</span>
</span><span id="__span-163-7"><a id="__codelineno-163-7" name="__codelineno-163-7" href="#__codelineno-163-7"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Deployment</span>
</span><span id="__span-163-8"><a id="__codelineno-163-8" name="__codelineno-163-8" href="#__codelineno-163-8"></a><span class="nt">metadata</span><span class="p">:</span>
</span><span id="__span-163-9"><a id="__codelineno-163-9" name="__codelineno-163-9" href="#__codelineno-163-9"></a><span class="w">  </span><span class="nt">labels</span><span class="p">:</span>
</span><span id="__span-163-10"><a id="__codelineno-163-10" name="__codelineno-163-10" href="#__codelineno-163-10"></a><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">home-assistant</span>
</span><span id="__span-163-11"><a id="__codelineno-163-11" name="__codelineno-163-11" href="#__codelineno-163-11"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">home-assistant</span>
</span><span id="__span-163-12"><a id="__codelineno-163-12" name="__codelineno-163-12" href="#__codelineno-163-12"></a><span class="nt">spec</span><span class="p">:</span>
</span><span id="__span-163-13"><a id="__codelineno-163-13" name="__codelineno-163-13" href="#__codelineno-163-13"></a><span class="w">  </span><span class="nt">revisionHistoryLimit</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">3</span>
</span><span id="__span-163-14"><a id="__codelineno-163-14" name="__codelineno-163-14" href="#__codelineno-163-14"></a><span class="w">  </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1</span>
</span><span id="__span-163-15"><a id="__codelineno-163-15" name="__codelineno-163-15" href="#__codelineno-163-15"></a><span class="w">  </span><span class="nt">strategy</span><span class="p">:</span>
</span><span id="__span-163-16"><a id="__codelineno-163-16" name="__codelineno-163-16" href="#__codelineno-163-16"></a><span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Recreate</span>
</span><span id="__span-163-17"><a id="__codelineno-163-17" name="__codelineno-163-17" href="#__codelineno-163-17"></a><span class="w">  </span><span class="nt">selector</span><span class="p">:</span>
</span><span id="__span-163-18"><a id="__codelineno-163-18" name="__codelineno-163-18" href="#__codelineno-163-18"></a><span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span>
</span><span id="__span-163-19"><a id="__codelineno-163-19" name="__codelineno-163-19" href="#__codelineno-163-19"></a><span class="w">      </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">home-assistant</span>
</span><span id="__span-163-20"><a id="__codelineno-163-20" name="__codelineno-163-20" href="#__codelineno-163-20"></a><span class="w">  </span><span class="nt">template</span><span class="p">:</span>
</span><span id="__span-163-21"><a id="__codelineno-163-21" name="__codelineno-163-21" href="#__codelineno-163-21"></a><span class="w">    </span><span class="nt">metadata</span><span class="p">:</span>
</span><span id="__span-163-22"><a id="__codelineno-163-22" name="__codelineno-163-22" href="#__codelineno-163-22"></a><span class="w">      </span><span class="nt">labels</span><span class="p">:</span>
</span><span id="__span-163-23"><a id="__codelineno-163-23" name="__codelineno-163-23" href="#__codelineno-163-23"></a><span class="w">        </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">home-assistant</span>
</span><span id="__span-163-24"><a id="__codelineno-163-24" name="__codelineno-163-24" href="#__codelineno-163-24"></a><span class="w">    </span><span class="nt">spec</span><span class="p">:</span>
</span><span id="__span-163-25"><a id="__codelineno-163-25" name="__codelineno-163-25" href="#__codelineno-163-25"></a><span class="w">    </span><span class="c1"># securityContext:</span>
</span><span id="__span-163-26"><a id="__codelineno-163-26" name="__codelineno-163-26" href="#__codelineno-163-26"></a><span class="w">    </span><span class="c1">#   fsGroup: 33</span>
</span><span id="__span-163-27"><a id="__codelineno-163-27" name="__codelineno-163-27" href="#__codelineno-163-27"></a><span class="w">    </span><span class="c1">#   fsGroupChangePolicy: "OnRootMismatch"</span>
</span><span id="__span-163-28"><a id="__codelineno-163-28" name="__codelineno-163-28" href="#__codelineno-163-28"></a><span class="w">      </span><span class="nt">containers</span><span class="p">:</span>
</span><span id="__span-163-29"><a id="__codelineno-163-29" name="__codelineno-163-29" href="#__codelineno-163-29"></a><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">home-assistant-app</span>
</span><span id="__span-163-30"><a id="__codelineno-163-30" name="__codelineno-163-30" href="#__codelineno-163-30"></a><span class="w">          </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="s">"ghcr.io/home-assistant/home-assistant:stable"</span>
</span><span id="__span-163-31"><a id="__codelineno-163-31" name="__codelineno-163-31" href="#__codelineno-163-31"></a><span class="w">          </span><span class="nt">imagePullPolicy</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Always</span>
</span><span id="__span-163-32"><a id="__codelineno-163-32" name="__codelineno-163-32" href="#__codelineno-163-32"></a><span class="w">          </span><span class="nt">securityContext</span><span class="p">:</span>
</span><span id="__span-163-33"><a id="__codelineno-163-33" name="__codelineno-163-33" href="#__codelineno-163-33"></a><span class="w">            </span><span class="nt">capabilities</span><span class="p">:</span>
</span><span id="__span-163-34"><a id="__codelineno-163-34" name="__codelineno-163-34" href="#__codelineno-163-34"></a><span class="w">              </span><span class="nt">add</span><span class="p">:</span>
</span><span id="__span-163-35"><a id="__codelineno-163-35" name="__codelineno-163-35" href="#__codelineno-163-35"></a><span class="w">                </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">NET_ADMIN</span>
</span><span id="__span-163-36"><a id="__codelineno-163-36" name="__codelineno-163-36" href="#__codelineno-163-36"></a><span class="w">                </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">NET_RAW</span>
</span><span id="__span-163-37"><a id="__codelineno-163-37" name="__codelineno-163-37" href="#__codelineno-163-37"></a><span class="w">                </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">NET_BROADCAST</span>
</span><span id="__span-163-38"><a id="__codelineno-163-38" name="__codelineno-163-38" href="#__codelineno-163-38"></a><span class="w">            </span><span class="nt">privileged</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
</span><span id="__span-163-39"><a id="__codelineno-163-39" name="__codelineno-163-39" href="#__codelineno-163-39"></a><span class="w">          </span><span class="nt">envFrom</span><span class="p">:</span>
</span><span id="__span-163-40"><a id="__codelineno-163-40" name="__codelineno-163-40" href="#__codelineno-163-40"></a><span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">configMapRef</span><span class="p">:</span>
</span><span id="__span-163-41"><a id="__codelineno-163-41" name="__codelineno-163-41" href="#__codelineno-163-41"></a><span class="w">                </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">home-assistant-config</span>
</span><span id="__span-163-42"><a id="__codelineno-163-42" name="__codelineno-163-42" href="#__codelineno-163-42"></a><span class="w">          </span><span class="nt">ports</span><span class="p">:</span>
</span><span id="__span-163-43"><a id="__codelineno-163-43" name="__codelineno-163-43" href="#__codelineno-163-43"></a><span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">http</span>
</span><span id="__span-163-44"><a id="__codelineno-163-44" name="__codelineno-163-44" href="#__codelineno-163-44"></a><span class="w">              </span><span class="nt">containerPort</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">8123</span>
</span><span id="__span-163-45"><a id="__codelineno-163-45" name="__codelineno-163-45" href="#__codelineno-163-45"></a><span class="w">              </span><span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">TCP</span>
</span><span id="__span-163-46"><a id="__codelineno-163-46" name="__codelineno-163-46" href="#__codelineno-163-46"></a><span class="w">          </span><span class="nt">resources</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{}</span>
</span><span id="__span-163-47"><a id="__codelineno-163-47" name="__codelineno-163-47" href="#__codelineno-163-47"></a><span class="w">          </span><span class="nt">livenessProbe</span><span class="p">:</span>
</span><span id="__span-163-48"><a id="__codelineno-163-48" name="__codelineno-163-48" href="#__codelineno-163-48"></a><span class="w">            </span><span class="nt">tcpSocket</span><span class="p">:</span>
</span><span id="__span-163-49"><a id="__codelineno-163-49" name="__codelineno-163-49" href="#__codelineno-163-49"></a><span class="w">              </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">8123</span>
</span><span id="__span-163-50"><a id="__codelineno-163-50" name="__codelineno-163-50" href="#__codelineno-163-50"></a><span class="w">            </span><span class="nt">initialDelaySeconds</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0</span>
</span><span id="__span-163-51"><a id="__codelineno-163-51" name="__codelineno-163-51" href="#__codelineno-163-51"></a><span class="w">            </span><span class="nt">failureThreshold</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">3</span>
</span><span id="__span-163-52"><a id="__codelineno-163-52" name="__codelineno-163-52" href="#__codelineno-163-52"></a><span class="w">            </span><span class="nt">timeoutSeconds</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1</span>
</span><span id="__span-163-53"><a id="__codelineno-163-53" name="__codelineno-163-53" href="#__codelineno-163-53"></a><span class="w">            </span><span class="nt">periodSeconds</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10</span>
</span><span id="__span-163-54"><a id="__codelineno-163-54" name="__codelineno-163-54" href="#__codelineno-163-54"></a><span class="w">          </span><span class="nt">readinessProbe</span><span class="p">:</span>
</span><span id="__span-163-55"><a id="__codelineno-163-55" name="__codelineno-163-55" href="#__codelineno-163-55"></a><span class="w">            </span><span class="nt">tcpSocket</span><span class="p">:</span>
</span><span id="__span-163-56"><a id="__codelineno-163-56" name="__codelineno-163-56" href="#__codelineno-163-56"></a><span class="w">              </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">8123</span>
</span><span id="__span-163-57"><a id="__codelineno-163-57" name="__codelineno-163-57" href="#__codelineno-163-57"></a><span class="w">            </span><span class="nt">initialDelaySeconds</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0</span>
</span><span id="__span-163-58"><a id="__codelineno-163-58" name="__codelineno-163-58" href="#__codelineno-163-58"></a><span class="w">            </span><span class="nt">failureThreshold</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">3</span>
</span><span id="__span-163-59"><a id="__codelineno-163-59" name="__codelineno-163-59" href="#__codelineno-163-59"></a><span class="w">            </span><span class="nt">timeoutSeconds</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1</span>
</span><span id="__span-163-60"><a id="__codelineno-163-60" name="__codelineno-163-60" href="#__codelineno-163-60"></a><span class="w">            </span><span class="nt">periodSeconds</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10</span>
</span><span id="__span-163-61"><a id="__codelineno-163-61" name="__codelineno-163-61" href="#__codelineno-163-61"></a><span class="w">          </span><span class="nt">startupProbe</span><span class="p">:</span>
</span><span id="__span-163-62"><a id="__codelineno-163-62" name="__codelineno-163-62" href="#__codelineno-163-62"></a><span class="w">            </span><span class="nt">tcpSocket</span><span class="p">:</span>
</span><span id="__span-163-63"><a id="__codelineno-163-63" name="__codelineno-163-63" href="#__codelineno-163-63"></a><span class="w">              </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">8123</span>
</span><span id="__span-163-64"><a id="__codelineno-163-64" name="__codelineno-163-64" href="#__codelineno-163-64"></a><span class="w">            </span><span class="nt">initialDelaySeconds</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0</span>
</span><span id="__span-163-65"><a id="__codelineno-163-65" name="__codelineno-163-65" href="#__codelineno-163-65"></a><span class="w">            </span><span class="nt">failureThreshold</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">30</span>
</span><span id="__span-163-66"><a id="__codelineno-163-66" name="__codelineno-163-66" href="#__codelineno-163-66"></a><span class="w">            </span><span class="nt">timeoutSeconds</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1</span>
</span><span id="__span-163-67"><a id="__codelineno-163-67" name="__codelineno-163-67" href="#__codelineno-163-67"></a><span class="w">            </span><span class="nt">periodSeconds</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">5</span>
</span><span id="__span-163-68"><a id="__codelineno-163-68" name="__codelineno-163-68" href="#__codelineno-163-68"></a><span class="w">          </span><span class="nt">volumeMounts</span><span class="p">:</span>
</span><span id="__span-163-69"><a id="__codelineno-163-69" name="__codelineno-163-69" href="#__codelineno-163-69"></a><span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ha-config-root</span>
</span><span id="__span-163-70"><a id="__codelineno-163-70" name="__codelineno-163-70" href="#__codelineno-163-70"></a><span class="w">              </span><span class="nt">mountPath</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/config</span>
</span><span id="__span-163-71"><a id="__codelineno-163-71" name="__codelineno-163-71" href="#__codelineno-163-71"></a><span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">configmap-file</span>
</span><span id="__span-163-72"><a id="__codelineno-163-72" name="__codelineno-163-72" href="#__codelineno-163-72"></a><span class="w">              </span><span class="nt">mountPath</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/config/configuration.yaml</span>
</span><span id="__span-163-73"><a id="__codelineno-163-73" name="__codelineno-163-73" href="#__codelineno-163-73"></a><span class="w">              </span><span class="nt">subPath</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">configuration.yaml</span>
</span><span id="__span-163-74"><a id="__codelineno-163-74" name="__codelineno-163-74" href="#__codelineno-163-74"></a><span class="w">      </span><span class="nt">restartPolicy</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Always</span>
</span><span id="__span-163-75"><a id="__codelineno-163-75" name="__codelineno-163-75" href="#__codelineno-163-75"></a><span class="w">      </span><span class="nt">hostNetwork</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
</span><span id="__span-163-76"><a id="__codelineno-163-76" name="__codelineno-163-76" href="#__codelineno-163-76"></a><span class="w">      </span><span class="nt">volumes</span><span class="p">:</span>
</span><span id="__span-163-77"><a id="__codelineno-163-77" name="__codelineno-163-77" href="#__codelineno-163-77"></a><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ha-config-root</span>
</span><span id="__span-163-78"><a id="__codelineno-163-78" name="__codelineno-163-78" href="#__codelineno-163-78"></a><span class="w">          </span><span class="nt">persistentVolumeClaim</span><span class="p">:</span>
</span><span id="__span-163-79"><a id="__codelineno-163-79" name="__codelineno-163-79" href="#__codelineno-163-79"></a><span class="w">            </span><span class="nt">claimName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">home-assistant-config-root</span>
</span><span id="__span-163-80"><a id="__codelineno-163-80" name="__codelineno-163-80" href="#__codelineno-163-80"></a><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">configmap-file</span>
</span><span id="__span-163-81"><a id="__codelineno-163-81" name="__codelineno-163-81" href="#__codelineno-163-81"></a><span class="w">          </span><span class="nt">configMap</span><span class="p">:</span>
</span><span id="__span-163-82"><a id="__codelineno-163-82" name="__codelineno-163-82" href="#__codelineno-163-82"></a><span class="w">            </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">home-assistant-configmap</span>
</span></code></pre></div>
</details>
<details class="k8s">
<summary><code>base/service.yaml</code></summary>
<div class="language-yaml highlight"><pre><span></span><code><span id="__span-164-1"><a id="__codelineno-164-1" name="__codelineno-164-1" href="#__codelineno-164-1"></a><span class="nn">---</span>
</span><span id="__span-164-2"><a id="__codelineno-164-2" name="__codelineno-164-2" href="#__codelineno-164-2"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
</span><span id="__span-164-3"><a id="__codelineno-164-3" name="__codelineno-164-3" href="#__codelineno-164-3"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Service</span>
</span><span id="__span-164-4"><a id="__codelineno-164-4" name="__codelineno-164-4" href="#__codelineno-164-4"></a><span class="nt">metadata</span><span class="p">:</span>
</span><span id="__span-164-5"><a id="__codelineno-164-5" name="__codelineno-164-5" href="#__codelineno-164-5"></a><span class="w">  </span><span class="nt">labels</span><span class="p">:</span>
</span><span id="__span-164-6"><a id="__codelineno-164-6" name="__codelineno-164-6" href="#__codelineno-164-6"></a><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">home-assistant</span>
</span><span id="__span-164-7"><a id="__codelineno-164-7" name="__codelineno-164-7" href="#__codelineno-164-7"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">home-assistant-svc</span>
</span><span id="__span-164-8"><a id="__codelineno-164-8" name="__codelineno-164-8" href="#__codelineno-164-8"></a><span class="nt">spec</span><span class="p">:</span>
</span><span id="__span-164-9"><a id="__codelineno-164-9" name="__codelineno-164-9" href="#__codelineno-164-9"></a><span class="w">  </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ClusterIP</span>
</span><span id="__span-164-10"><a id="__codelineno-164-10" name="__codelineno-164-10" href="#__codelineno-164-10"></a><span class="w">  </span><span class="nt">ports</span><span class="p">:</span>
</span><span id="__span-164-11"><a id="__codelineno-164-11" name="__codelineno-164-11" href="#__codelineno-164-11"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">8123</span>
</span><span id="__span-164-12"><a id="__codelineno-164-12" name="__codelineno-164-12" href="#__codelineno-164-12"></a><span class="w">    </span><span class="nt">targetPort</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">http</span>
</span><span id="__span-164-13"><a id="__codelineno-164-13" name="__codelineno-164-13" href="#__codelineno-164-13"></a><span class="w">    </span><span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">TCP</span>
</span><span id="__span-164-14"><a id="__codelineno-164-14" name="__codelineno-164-14" href="#__codelineno-164-14"></a><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">http</span>
</span></code></pre></div>
</details>
<details class="k8s">
<summary><code>base/ingress.yaml</code></summary>
<div class="language-yaml highlight"><pre><span></span><code><span id="__span-165-1"><a id="__codelineno-165-1" name="__codelineno-165-1" href="#__codelineno-165-1"></a><span class="nn">---</span>
</span><span id="__span-165-2"><a id="__codelineno-165-2" name="__codelineno-165-2" href="#__codelineno-165-2"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">networking.k8s.io/v1</span>
</span><span id="__span-165-3"><a id="__codelineno-165-3" name="__codelineno-165-3" href="#__codelineno-165-3"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Ingress</span>
</span><span id="__span-165-4"><a id="__codelineno-165-4" name="__codelineno-165-4" href="#__codelineno-165-4"></a><span class="nt">metadata</span><span class="p">:</span>
</span><span id="__span-165-5"><a id="__codelineno-165-5" name="__codelineno-165-5" href="#__codelineno-165-5"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">home-assistant-nginx</span>
</span><span id="__span-165-6"><a id="__codelineno-165-6" name="__codelineno-165-6" href="#__codelineno-165-6"></a><span class="w">  </span><span class="nt">annotations</span><span class="p">:</span>
</span><span id="__span-165-7"><a id="__codelineno-165-7" name="__codelineno-165-7" href="#__codelineno-165-7"></a><span class="w">    </span><span class="nt">cert-manager.io/cluster-issuer</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">letsencrypt-prod</span>
</span><span id="__span-165-8"><a id="__codelineno-165-8" name="__codelineno-165-8" href="#__codelineno-165-8"></a><span class="nt">spec</span><span class="p">:</span>
</span><span id="__span-165-9"><a id="__codelineno-165-9" name="__codelineno-165-9" href="#__codelineno-165-9"></a><span class="w">  </span><span class="nt">ingressClassName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nginx</span>
</span><span id="__span-165-10"><a id="__codelineno-165-10" name="__codelineno-165-10" href="#__codelineno-165-10"></a><span class="w">  </span><span class="nt">rules</span><span class="p">:</span>
</span><span id="__span-165-11"><a id="__codelineno-165-11" name="__codelineno-165-11" href="#__codelineno-165-11"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">host</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">REPLACEME</span><span class="w">  </span><span class="c1"># FQDN for Cloudflare Tunnel or port-forwarded</span>
</span><span id="__span-165-12"><a id="__codelineno-165-12" name="__codelineno-165-12" href="#__codelineno-165-12"></a><span class="w">      </span><span class="nt">http</span><span class="p">:</span>
</span><span id="__span-165-13"><a id="__codelineno-165-13" name="__codelineno-165-13" href="#__codelineno-165-13"></a><span class="w">        </span><span class="nt">paths</span><span class="p">:</span>
</span><span id="__span-165-14"><a id="__codelineno-165-14" name="__codelineno-165-14" href="#__codelineno-165-14"></a><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/</span>
</span><span id="__span-165-15"><a id="__codelineno-165-15" name="__codelineno-165-15" href="#__codelineno-165-15"></a><span class="w">          </span><span class="nt">pathType</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Prefix</span>
</span><span id="__span-165-16"><a id="__codelineno-165-16" name="__codelineno-165-16" href="#__codelineno-165-16"></a><span class="w">          </span><span class="nt">backend</span><span class="p">:</span>
</span><span id="__span-165-17"><a id="__codelineno-165-17" name="__codelineno-165-17" href="#__codelineno-165-17"></a><span class="w">            </span><span class="nt">service</span><span class="p">:</span>
</span><span id="__span-165-18"><a id="__codelineno-165-18" name="__codelineno-165-18" href="#__codelineno-165-18"></a><span class="w">              </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">home-assistant-svc</span>
</span><span id="__span-165-19"><a id="__codelineno-165-19" name="__codelineno-165-19" href="#__codelineno-165-19"></a><span class="w">              </span><span class="nt">port</span><span class="p">:</span>
</span><span id="__span-165-20"><a id="__codelineno-165-20" name="__codelineno-165-20" href="#__codelineno-165-20"></a><span class="w">                </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s">"http"</span>
</span><span id="__span-165-21"><a id="__codelineno-165-21" name="__codelineno-165-21" href="#__codelineno-165-21"></a><span class="w">  </span><span class="nt">tls</span><span class="p">:</span>
</span><span id="__span-165-22"><a id="__codelineno-165-22" name="__codelineno-165-22" href="#__codelineno-165-22"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">hosts</span><span class="p">:</span>
</span><span id="__span-165-23"><a id="__codelineno-165-23" name="__codelineno-165-23" href="#__codelineno-165-23"></a><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">REPLACEME</span><span class="w">  </span><span class="c1"># FQDN for Cloudflare Tunnel or port-forwarded</span>
</span><span id="__span-165-24"><a id="__codelineno-165-24" name="__codelineno-165-24" href="#__codelineno-165-24"></a><span class="w">      </span><span class="nt">secretName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">tls-secret</span>
</span><span id="__span-165-25"><a id="__codelineno-165-25" name="__codelineno-165-25" href="#__codelineno-165-25"></a><span class="nn">---</span>
</span><span id="__span-165-26"><a id="__codelineno-165-26" name="__codelineno-165-26" href="#__codelineno-165-26"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">networking.k8s.io/v1</span>
</span><span id="__span-165-27"><a id="__codelineno-165-27" name="__codelineno-165-27" href="#__codelineno-165-27"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Ingress</span>
</span><span id="__span-165-28"><a id="__codelineno-165-28" name="__codelineno-165-28" href="#__codelineno-165-28"></a><span class="nt">metadata</span><span class="p">:</span>
</span><span id="__span-165-29"><a id="__codelineno-165-29" name="__codelineno-165-29" href="#__codelineno-165-29"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">home-assistant-tailscale</span>
</span><span id="__span-165-30"><a id="__codelineno-165-30" name="__codelineno-165-30" href="#__codelineno-165-30"></a><span class="nt">spec</span><span class="p">:</span>
</span><span id="__span-165-31"><a id="__codelineno-165-31" name="__codelineno-165-31" href="#__codelineno-165-31"></a><span class="w">  </span><span class="nt">ingressClassName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">tailscale</span>
</span><span id="__span-165-32"><a id="__codelineno-165-32" name="__codelineno-165-32" href="#__codelineno-165-32"></a><span class="w">  </span><span class="nt">defaultBackend</span><span class="p">:</span>
</span><span id="__span-165-33"><a id="__codelineno-165-33" name="__codelineno-165-33" href="#__codelineno-165-33"></a><span class="w">    </span><span class="nt">service</span><span class="p">:</span>
</span><span id="__span-165-34"><a id="__codelineno-165-34" name="__codelineno-165-34" href="#__codelineno-165-34"></a><span class="w">      </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">home-assistant-svc</span>
</span><span id="__span-165-35"><a id="__codelineno-165-35" name="__codelineno-165-35" href="#__codelineno-165-35"></a><span class="w">      </span><span class="nt">port</span><span class="p">:</span>
</span><span id="__span-165-36"><a id="__codelineno-165-36" name="__codelineno-165-36" href="#__codelineno-165-36"></a><span class="w">        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s">"http"</span>
</span><span id="__span-165-37"><a id="__codelineno-165-37" name="__codelineno-165-37" href="#__codelineno-165-37"></a><span class="w">  </span><span class="nt">tls</span><span class="p">:</span>
</span><span id="__span-165-38"><a id="__codelineno-165-38" name="__codelineno-165-38" href="#__codelineno-165-38"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">hosts</span><span class="p">:</span>
</span><span id="__span-165-39"><a id="__codelineno-165-39" name="__codelineno-165-39" href="#__codelineno-165-39"></a><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">REPLACEME</span><span class="w">  </span><span class="c1"># Hostname-only for Tailscale [Funnel]</span>
</span></code></pre></div>
</details>
<details class="k8s">
<summary><code>base/kustomization.yaml</code></summary>
<div class="language-yaml highlight"><pre><span></span><code><span id="__span-166-1"><a id="__codelineno-166-1" name="__codelineno-166-1" href="#__codelineno-166-1"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">kustomize.config.k8s.io/v1beta1</span>
</span><span id="__span-166-2"><a id="__codelineno-166-2" name="__codelineno-166-2" href="#__codelineno-166-2"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Kustomization</span>
</span><span id="__span-166-3"><a id="__codelineno-166-3" name="__codelineno-166-3" href="#__codelineno-166-3"></a><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">home-assistant</span>
</span><span id="__span-166-4"><a id="__codelineno-166-4" name="__codelineno-166-4" href="#__codelineno-166-4"></a><span class="nt">resources</span><span class="p">:</span>
</span><span id="__span-166-5"><a id="__codelineno-166-5" name="__codelineno-166-5" href="#__codelineno-166-5"></a><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">configmap.yaml</span>
</span><span id="__span-166-6"><a id="__codelineno-166-6" name="__codelineno-166-6" href="#__codelineno-166-6"></a><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">deployment.yaml</span>
</span><span id="__span-166-7"><a id="__codelineno-166-7" name="__codelineno-166-7" href="#__codelineno-166-7"></a><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ingress.yaml</span>
</span><span id="__span-166-8"><a id="__codelineno-166-8" name="__codelineno-166-8" href="#__codelineno-166-8"></a><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">persistent-volume.yaml</span>
</span><span id="__span-166-9"><a id="__codelineno-166-9" name="__codelineno-166-9" href="#__codelineno-166-9"></a><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">service.yaml</span>
</span><span id="__span-166-10"><a id="__codelineno-166-10" name="__codelineno-166-10" href="#__codelineno-166-10"></a><span class="nt">configMapGenerator</span><span class="p">:</span>
</span><span id="__span-166-11"><a id="__codelineno-166-11" name="__codelineno-166-11" href="#__codelineno-166-11"></a><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">home-assistant-config</span>
</span><span id="__span-166-12"><a id="__codelineno-166-12" name="__codelineno-166-12" href="#__codelineno-166-12"></a><span class="w">  </span><span class="nt">literals</span><span class="p">:</span>
</span><span id="__span-166-13"><a id="__codelineno-166-13" name="__codelineno-166-13" href="#__codelineno-166-13"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">TZ="UTC"</span>
</span><span id="__span-166-14"><a id="__codelineno-166-14" name="__codelineno-166-14" href="#__codelineno-166-14"></a><span class="nt">labels</span><span class="p">:</span>
</span><span id="__span-166-15"><a id="__codelineno-166-15" name="__codelineno-166-15" href="#__codelineno-166-15"></a><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">includeSelectors</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
</span><span id="__span-166-16"><a id="__codelineno-166-16" name="__codelineno-166-16" href="#__codelineno-166-16"></a><span class="w">  </span><span class="nt">pairs</span><span class="p">:</span>
</span><span id="__span-166-17"><a id="__codelineno-166-17" name="__codelineno-166-17" href="#__codelineno-166-17"></a><span class="w">    </span><span class="nt">app.kubernetes.io/name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">home-assistant</span>
</span><span id="__span-166-18"><a id="__codelineno-166-18" name="__codelineno-166-18" href="#__codelineno-166-18"></a><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">home-assistant</span>
</span></code></pre></div>
</details>
<h3 id="kustomized-deployment">Kustomized deployment</h3>
<p>For each server to start this deployment on, create a <code>kustomization.yaml</code>
file under a directory named after the server and adjust the relevant
values:</p>
<ul>
<li>Set <code>TZ</code> under <code>configMapGenerator</code> to the correct time zone.</li>
<li>Set <code>/spec/rules/0/host</code> and <code>/spec/tls/0/hosts/0</code> for the
    <code>Ingress</code> named <code>home-assistant-nginx</code> to the FQDN from Cloudflare.</li>
<li>Set <code>/spec/rules/0/host</code> and <code>/spec/tls/0/hosts/0</code> for the
    <code>Ingress</code> named <code>home-assistant-tailscale</code> to the <em>Machine</em> name
     from Tailscale (just the hostname, not the FQDN).</li>
</ul>
<div class="language-yaml highlight"><table class="highlighttable"><tbody><tr><th colspan="2" class="filename"><span class="filename">alfred/kustomization.yaml</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-167-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-167-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-167-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-167-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-167-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-167-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-167-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-167-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-167-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-167-10">10</a></span>
<span class="normal"><a href="#__codelineno-167-11">11</a></span>
<span class="normal"><a href="#__codelineno-167-12">12</a></span>
<span class="normal"><a href="#__codelineno-167-13">13</a></span>
<span class="normal"><a href="#__codelineno-167-14">14</a></span>
<span class="normal"><a href="#__codelineno-167-15">15</a></span>
<span class="normal"><a href="#__codelineno-167-16">16</a></span>
<span class="normal"><a href="#__codelineno-167-17">17</a></span>
<span class="normal"><a href="#__codelineno-167-18">18</a></span>
<span class="normal"><a href="#__codelineno-167-19">19</a></span>
<span class="normal"><a href="#__codelineno-167-20">20</a></span>
<span class="normal"><a href="#__codelineno-167-21">21</a></span>
<span class="normal"><a href="#__codelineno-167-22">22</a></span>
<span class="normal"><a href="#__codelineno-167-23">23</a></span>
<span class="normal"><a href="#__codelineno-167-24">24</a></span>
<span class="normal"><a href="#__codelineno-167-25">25</a></span>
<span class="normal"><a href="#__codelineno-167-26">26</a></span>
<span class="normal"><a href="#__codelineno-167-27">27</a></span>
<span class="normal"><a href="#__codelineno-167-28">28</a></span>
<span class="normal"><a href="#__codelineno-167-29">29</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-167-1"><a id="__codelineno-167-1" name="__codelineno-167-1"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">kustomize.config.k8s.io/v1beta1</span>
</span><span id="__span-167-2"><a id="__codelineno-167-2" name="__codelineno-167-2"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Kustomization</span>
</span><span id="__span-167-3"><a id="__codelineno-167-3" name="__codelineno-167-3"></a><span class="nt">resources</span><span class="p">:</span>
</span><span id="__span-167-4"><a id="__codelineno-167-4" name="__codelineno-167-4"></a><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">../base</span>
</span><span id="__span-167-5"><a id="__codelineno-167-5" name="__codelineno-167-5"></a>
</span><span id="__span-167-6"><a id="__codelineno-167-6" name="__codelineno-167-6"></a><span class="nt">configMapGenerator</span><span class="p">:</span>
</span><span id="__span-167-7"><a id="__codelineno-167-7" name="__codelineno-167-7"></a><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">home-assistant-config</span>
</span><span id="__span-167-8"><a id="__codelineno-167-8" name="__codelineno-167-8"></a><span class="w">  </span><span class="nt">behavior</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">replace</span>
</span><span id="__span-167-9"><a id="__codelineno-167-9" name="__codelineno-167-9"></a><span class="w">  </span><span class="nt">literals</span><span class="p">:</span>
</span><span id="__span-167-10"><a id="__codelineno-167-10" name="__codelineno-167-10"></a><span class="hll"><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">TZ="Europe/Madrid"</span>
</span></span><span id="__span-167-11"><a id="__codelineno-167-11" name="__codelineno-167-11"></a>
</span><span id="__span-167-12"><a id="__codelineno-167-12" name="__codelineno-167-12"></a><span class="nt">patches</span><span class="p">:</span>
</span><span id="__span-167-13"><a id="__codelineno-167-13" name="__codelineno-167-13"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">target</span><span class="p">:</span><span class="w"> </span><span class="c1">#FQDN for Cloudflare Tunnel or port-forwarded</span>
</span><span id="__span-167-14"><a id="__codelineno-167-14" name="__codelineno-167-14"></a><span class="w">      </span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Ingress</span>
</span><span id="__span-167-15"><a id="__codelineno-167-15" name="__codelineno-167-15"></a><span class="w">      </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">home-assistant-nginx</span>
</span><span id="__span-167-16"><a id="__codelineno-167-16" name="__codelineno-167-16"></a><span class="w">    </span><span class="nt">patch</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|-</span>
</span><span id="__span-167-17"><a id="__codelineno-167-17" name="__codelineno-167-17"></a><span class="w">      </span><span class="no">- op: replace</span>
</span><span id="__span-167-18"><a id="__codelineno-167-18" name="__codelineno-167-18"></a><span class="w">        </span><span class="no">path: /spec/rules/0/host</span>
</span><span id="__span-167-19"><a id="__codelineno-167-19" name="__codelineno-167-19"></a><span class="hll"><span class="w">        </span><span class="no">value: home-assistant-alfred.very-very-dark-gray.top</span>
</span></span><span id="__span-167-20"><a id="__codelineno-167-20" name="__codelineno-167-20"></a><span class="w">      </span><span class="no">- op: replace</span>
</span><span id="__span-167-21"><a id="__codelineno-167-21" name="__codelineno-167-21"></a><span class="w">        </span><span class="no">path: /spec/tls/0/hosts/0</span>
</span><span id="__span-167-22"><a id="__codelineno-167-22" name="__codelineno-167-22"></a><span class="hll"><span class="w">        </span><span class="no">value: home-assistant-alfred.very-very-dark-gray.top</span>
</span></span><span id="__span-167-23"><a id="__codelineno-167-23" name="__codelineno-167-23"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">target</span><span class="p">:</span><span class="w"> </span><span class="c1"># Hostname-only for Tailscale [Funnel]</span>
</span><span id="__span-167-24"><a id="__codelineno-167-24" name="__codelineno-167-24"></a><span class="w">      </span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Ingress</span>
</span><span id="__span-167-25"><a id="__codelineno-167-25" name="__codelineno-167-25"></a><span class="w">      </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">home-assistant-tailscale</span>
</span><span id="__span-167-26"><a id="__codelineno-167-26" name="__codelineno-167-26"></a><span class="w">    </span><span class="nt">patch</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|-</span>
</span><span id="__span-167-27"><a id="__codelineno-167-27" name="__codelineno-167-27"></a><span class="w">      </span><span class="no">- op: replace</span>
</span><span id="__span-167-28"><a id="__codelineno-167-28" name="__codelineno-167-28"></a><span class="w">        </span><span class="no">path: /spec/tls/0/hosts/0</span>
</span><span id="__span-167-29"><a id="__codelineno-167-29" name="__codelineno-167-29"></a><span class="hll"><span class="w">        </span><span class="no">value: home-assistant-alfred</span>
</span></span></code></pre></div></td></tr></tbody></table></div>
<p>There are two different checks to make before applying this deployment:</p>
<ol>
<li>
<p>Run <code>kubectl kustomize alfred</code> to inspect that the generated deployment manifest
    does replace the correct values.</p>
</li>
<li>
<p>Run <code>kubectl apply -k alfred --dry-run=client</code> to verify that <code>kubectl</code> finds
    on errors in the generated manifest.</p>
</li>
</ol>
<h3 id="prepare-remote-access">Prepare remote access</h3>
<p><strong>Before</strong> applying the deployment, Cloudflare Tunnel and Access should be setup so
that the Let's Encrypt certificate can be obtained and the Home Assistant frontend
is easily accessible while at the same time well secured.</p>
<h4 id="cloudflare">Cloudflare</h4>
<p>Since <a href="#cloudflare-tunnel">Cloudflare Tunnel</a> is already working, go in to
<a href="https://one.dash.cloudflare.com/">Zero Trust</a> and go to <strong>Networks &gt; Tunnels</strong>,
find the relevant connector (<strong>alfred</strong>) and
<a href="#public-hostnames">add a public hostname</a> named <code>home-assistant-alfred</code> to point
<a href="https://home-assistant-alfred.very-very-dark-gray.top/">https://home-assistant-alfred.very-very-dark-gray.top/</a> to the appropriate targets
as seen in <a href="#lets-encrypt-via-tunnel">Let's Encrypt via tunnel</a>:</p>
<ol>
<li>Requests for files under <code>.well-known</code> must go to <code>http://localhost:32080</code> so that
    <a href="#https-certificates">HTTPS certificates</a> can be issued.</li>
<li>Requests for everything else (<code>*</code>) must to to the <code>LoadBalancer</code> IP of Nginx
    over HTTP<strong>S</strong> (<code>https://192.168.0.151</code>) with the <strong>TLS &gt; Origin Server Name</strong>
    configured as <code>home-assistant-alfred.very-very-dark-gray.top</code><ul>
<li><em>TLS &gt; No TLS Verify</em> should not be necessary, unless there are issues
    obtaining Let's Encrypt certificates.</li>
</ul>
</li>
</ol>
<p>Restrict access to this public hostname by <strong>creating an Access application</strong> in
<a href="../../../03/28/remote-access-options-for-self-hosted-services/#cloudflare-access">Cloudflare Access</a>,
so that only trusted users can actually access
<a href="https://home-assistant-alfred.very-very-dark-gray.top/">https://home-assistant-alfred.very-very-dark-gray.top/</a>
(with a bypass policy for files under <code>.well-known</code>).</p>
<p>If all the above has been correctly setup, requests for files under <code>.well-known</code>
will receive <code>error code: 502</code> because the <code>Ingress</code> is not deployed yet, and requests
for any other files should receive a redirect to <code>cloudflareaccess.com</code>.</p>
<h4 id="tailscale_1">Tailscale</h4>
<p>No preparation is necessary for <a href="#tailscale">Tailscale</a> if the server already has the
<a href="../../../03/28/remote-access-options-for-self-hosted-services/#tailscale-kubernetes-operator">Tailscale Kubernetes operator</a>
installed. However, Tailscale DNS typically take a day or two to propagate after the
deployment is applied and the <code>home-assistant-alfred</code> <em>machine</em> is created.</p>
<h3 id="deployment-start">Deployment Start</h3>
<div class="language-console highlight"><pre><span></span><code><span id="__span-168-1"><a id="__codelineno-168-1" name="__codelineno-168-1" href="#__codelineno-168-1"></a><span class="gp">$ </span>sudo<span class="w"> </span>mkdir<span class="w"> </span>/home/k8s/home-assistant/
</span><span id="__span-168-2"><a id="__codelineno-168-2" name="__codelineno-168-2" href="#__codelineno-168-2"></a><span class="gp">$ </span>sudo<span class="w"> </span>ls<span class="w"> </span>-lah<span class="w"> </span>/home/k8s/home-assistant/
</span><span id="__span-168-3"><a id="__codelineno-168-3" name="__codelineno-168-3" href="#__codelineno-168-3"></a><span class="go">total 8.0K</span>
</span><span id="__span-168-4"><a id="__codelineno-168-4" name="__codelineno-168-4" href="#__codelineno-168-4"></a><span class="go">drwxr-xr-x 2 root root 4.0K Apr 20 22:44 .</span>
</span><span id="__span-168-5"><a id="__codelineno-168-5" name="__codelineno-168-5" href="#__codelineno-168-5"></a><span class="go">drwxr-xr-x 3 root root 4.0K Apr 20 22:44 ..</span>
</span><span id="__span-168-6"><a id="__codelineno-168-6" name="__codelineno-168-6" href="#__codelineno-168-6"></a>
</span><span id="__span-168-7"><a id="__codelineno-168-7" name="__codelineno-168-7" href="#__codelineno-168-7"></a><span class="gp">$ </span>kubectl<span class="w"> </span>apply<span class="w"> </span>-k<span class="w"> </span>alfred
</span><span id="__span-168-8"><a id="__codelineno-168-8" name="__codelineno-168-8" href="#__codelineno-168-8"></a><span class="go">namespace/home-assistant created</span>
</span><span id="__span-168-9"><a id="__codelineno-168-9" name="__codelineno-168-9" href="#__codelineno-168-9"></a><span class="go">configmap/home-assistant-config-79257h2772 created</span>
</span><span id="__span-168-10"><a id="__codelineno-168-10" name="__codelineno-168-10" href="#__codelineno-168-10"></a><span class="go">configmap/home-assistant-configmap created</span>
</span><span id="__span-168-11"><a id="__codelineno-168-11" name="__codelineno-168-11" href="#__codelineno-168-11"></a><span class="go">service/home-assistant-svc created</span>
</span><span id="__span-168-12"><a id="__codelineno-168-12" name="__codelineno-168-12" href="#__codelineno-168-12"></a><span class="go">persistentvolume/home-assistant-pv-config created</span>
</span><span id="__span-168-13"><a id="__codelineno-168-13" name="__codelineno-168-13" href="#__codelineno-168-13"></a><span class="go">persistentvolumeclaim/home-assistant-config-root created</span>
</span><span id="__span-168-14"><a id="__codelineno-168-14" name="__codelineno-168-14" href="#__codelineno-168-14"></a><span class="go">deployment.apps/home-assistant created</span>
</span><span id="__span-168-15"><a id="__codelineno-168-15" name="__codelineno-168-15" href="#__codelineno-168-15"></a><span class="go">ingress.networking.k8s.io/home-assistant-nginx created</span>
</span><span id="__span-168-16"><a id="__codelineno-168-16" name="__codelineno-168-16" href="#__codelineno-168-16"></a><span class="go">ingress.networking.k8s.io/home-assistant-tailscale created</span>
</span><span id="__span-168-17"><a id="__codelineno-168-17" name="__codelineno-168-17" href="#__codelineno-168-17"></a>
</span><span id="__span-168-18"><a id="__codelineno-168-18" name="__codelineno-168-18" href="#__codelineno-168-18"></a><span class="gp">$ </span>kubectl<span class="w"> </span>get<span class="w"> </span>all<span class="w"> </span>-n<span class="w"> </span>home-assistant
</span><span id="__span-168-19"><a id="__codelineno-168-19" name="__codelineno-168-19" href="#__codelineno-168-19"></a><span class="go">NAME                                  READY   STATUS    RESTARTS   AGE</span>
</span><span id="__span-168-20"><a id="__codelineno-168-20" name="__codelineno-168-20" href="#__codelineno-168-20"></a><span class="go">pod/home-assistant-74fc8db56f-ws6j4   1/1     Running   0          2m21s</span>
</span><span id="__span-168-21"><a id="__codelineno-168-21" name="__codelineno-168-21" href="#__codelineno-168-21"></a>
</span><span id="__span-168-22"><a id="__codelineno-168-22" name="__codelineno-168-22" href="#__codelineno-168-22"></a><span class="go">NAME                         TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)    AGE</span>
</span><span id="__span-168-23"><a id="__codelineno-168-23" name="__codelineno-168-23" href="#__codelineno-168-23"></a><span class="go">service/home-assistant-svc   ClusterIP   10.99.217.239   &lt;none&gt;        8123/TCP   2m21s</span>
</span><span id="__span-168-24"><a id="__codelineno-168-24" name="__codelineno-168-24" href="#__codelineno-168-24"></a>
</span><span id="__span-168-25"><a id="__codelineno-168-25" name="__codelineno-168-25" href="#__codelineno-168-25"></a><span class="go">NAME                             READY   UP-TO-DATE   AVAILABLE   AGE</span>
</span><span id="__span-168-26"><a id="__codelineno-168-26" name="__codelineno-168-26" href="#__codelineno-168-26"></a><span class="go">deployment.apps/home-assistant   1/1     1            1           2m21s</span>
</span><span id="__span-168-27"><a id="__codelineno-168-27" name="__codelineno-168-27" href="#__codelineno-168-27"></a>
</span><span id="__span-168-28"><a id="__codelineno-168-28" name="__codelineno-168-28" href="#__codelineno-168-28"></a><span class="go">NAME                                        DESIRED   CURRENT   READY   AGE</span>
</span><span id="__span-168-29"><a id="__codelineno-168-29" name="__codelineno-168-29" href="#__codelineno-168-29"></a><span class="go">replicaset.apps/home-assistant-74fc8db56f   1         1         1       2m21s</span>
</span><span id="__span-168-30"><a id="__codelineno-168-30" name="__codelineno-168-30" href="#__codelineno-168-30"></a>
</span><span id="__span-168-31"><a id="__codelineno-168-31" name="__codelineno-168-31" href="#__codelineno-168-31"></a><span class="gp">$ </span>kubectl<span class="w"> </span>get<span class="w"> </span>ingress<span class="w"> </span>-n<span class="w"> </span>home-assistant
</span><span id="__span-168-32"><a id="__codelineno-168-32" name="__codelineno-168-32" href="#__codelineno-168-32"></a><span class="go">NAME                       CLASS       HOSTS                                           ADDRESS                                    PORTS     AGE</span>
</span><span id="__span-168-33"><a id="__codelineno-168-33" name="__codelineno-168-33" href="#__codelineno-168-33"></a><span class="go">home-assistant-nginx       nginx       home-assistant-alfred.very-very-dark-gray.top   192.168.0.121                              80, 443   2m26s</span>
</span><span id="__span-168-34"><a id="__codelineno-168-34" name="__codelineno-168-34" href="#__codelineno-168-34"></a><span class="go">home-assistant-tailscale   tailscale   *                                               home-assistant-alfred.royal-penny.ts.net   80, 443   2m26s</span>
</span><span id="__span-168-35"><a id="__codelineno-168-35" name="__codelineno-168-35" href="#__codelineno-168-35"></a>
</span><span id="__span-168-36"><a id="__codelineno-168-36" name="__codelineno-168-36" href="#__codelineno-168-36"></a><span class="gp">$ </span>sudo<span class="w"> </span>ls<span class="w"> </span>-lah<span class="w"> </span>/home/k8s/home-assistant
</span><span id="__span-168-37"><a id="__codelineno-168-37" name="__codelineno-168-37" href="#__codelineno-168-37"></a><span class="go">total 808K</span>
</span><span id="__span-168-38"><a id="__codelineno-168-38" name="__codelineno-168-38" href="#__codelineno-168-38"></a><span class="go">drwxr-xr-x 6 root root 4.0K Apr 20 23:24 .</span>
</span><span id="__span-168-39"><a id="__codelineno-168-39" name="__codelineno-168-39" href="#__codelineno-168-39"></a><span class="go">drwxr-xr-x 3 root root 4.0K Apr 20 23:22 ..</span>
</span><span id="__span-168-40"><a id="__codelineno-168-40" name="__codelineno-168-40" href="#__codelineno-168-40"></a><span class="go">drwxr-xr-x 4 root root 4.0K Apr 20 23:24 blueprints</span>
</span><span id="__span-168-41"><a id="__codelineno-168-41" name="__codelineno-168-41" href="#__codelineno-168-41"></a><span class="go">drwxr-xr-x 2 root root 4.0K Apr 20 23:24 .cloud</span>
</span><span id="__span-168-42"><a id="__codelineno-168-42" name="__codelineno-168-42" href="#__codelineno-168-42"></a><span class="go">-rw-r--r-- 1 root root    0 Apr 20 23:23 configuration.yaml</span>
</span><span id="__span-168-43"><a id="__codelineno-168-43" name="__codelineno-168-43" href="#__codelineno-168-43"></a><span class="go">-rw-r--r-- 1 root root    8 Apr 20 23:24 .HA_VERSION</span>
</span><span id="__span-168-44"><a id="__codelineno-168-44" name="__codelineno-168-44" href="#__codelineno-168-44"></a><span class="go">-rw-r--r-- 1 root root    0 Apr 20 23:24 home-assistant.log</span>
</span><span id="__span-168-45"><a id="__codelineno-168-45" name="__codelineno-168-45" href="#__codelineno-168-45"></a><span class="go">-rw-r--r-- 1 root root    0 Apr 20 23:24 home-assistant.log.1</span>
</span><span id="__span-168-46"><a id="__codelineno-168-46" name="__codelineno-168-46" href="#__codelineno-168-46"></a><span class="go">-rw-r--r-- 1 root root    0 Apr 20 23:24 home-assistant.log.fault</span>
</span><span id="__span-168-47"><a id="__codelineno-168-47" name="__codelineno-168-47" href="#__codelineno-168-47"></a><span class="go">-rw-r--r-- 1 root root 4.0K Apr 20 23:24 home-assistant_v2.db</span>
</span><span id="__span-168-48"><a id="__codelineno-168-48" name="__codelineno-168-48" href="#__codelineno-168-48"></a><span class="go">-rw-r--r-- 1 root root  32K Apr 20 23:40 home-assistant_v2.db-shm</span>
</span><span id="__span-168-49"><a id="__codelineno-168-49" name="__codelineno-168-49" href="#__codelineno-168-49"></a><span class="go">-rw-r--r-- 1 root root 741K Apr 20 23:40 home-assistant_v2.db-wal</span>
</span><span id="__span-168-50"><a id="__codelineno-168-50" name="__codelineno-168-50" href="#__codelineno-168-50"></a><span class="go">drwxr-xr-x 2 root root 4.0K Apr 20 23:39 .storage</span>
</span><span id="__span-168-51"><a id="__codelineno-168-51" name="__codelineno-168-51" href="#__codelineno-168-51"></a><span class="go">drwxr-xr-x 2 root root 4.0K Apr 20 23:24 tts</span>
</span><span id="__span-168-52"><a id="__codelineno-168-52" name="__codelineno-168-52" href="#__codelineno-168-52"></a>
</span><span id="__span-168-53"><a id="__codelineno-168-53" name="__codelineno-168-53" href="#__codelineno-168-53"></a><span class="gp">$ </span>kubectl<span class="w"> </span>get<span class="w"> </span>svc<span class="w"> </span>-A<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>acme
</span><span id="__span-168-54"><a id="__codelineno-168-54" name="__codelineno-168-54" href="#__codelineno-168-54"></a><span class="go">home-assistant         cm-acme-http-solver-7qb57                         NodePort       10.103.172.33    &lt;none&gt;          8089:32447/TCP               0s</span>
</span></code></pre></div>
<p>After less than a minute, the ACME solver is patched to listen on port <code>32080</code>,
and after just about another minute the solver is gone. At that point Home Assistant
is available at both <a href="https://home-assistant-alfred.royal-penny.ts.net/">https://home-assistant-alfred.royal-penny.ts.net/</a> and
<a href="https://home-assistant-alfred.very-very-dark-gray.top/">https://home-assistant-alfred.very-very-dark-gray.top/</a>; ready to start the
onboarding process.</p>
<p>Although it should not be necessary, it is possible to restore now the original
<code>configuration.yaml</code> file, with the additional lines to allow traffic through
reverse proxies (under <code>http</code>):</p>
<div class="language-yaml highlight"><span class="filename">/home/k8s/home-assistant/configuration.yaml</span><pre><span></span><code><span id="__span-169-1"><a id="__codelineno-169-1" name="__codelineno-169-1" href="#__codelineno-169-1"></a><span class="c1"># Loads default set of integrations. Do not remove.</span>
</span><span id="__span-169-2"><a id="__codelineno-169-2" name="__codelineno-169-2" href="#__codelineno-169-2"></a><span class="nt">default_config</span><span class="p">:</span>
</span><span id="__span-169-3"><a id="__codelineno-169-3" name="__codelineno-169-3" href="#__codelineno-169-3"></a>
</span><span id="__span-169-4"><a id="__codelineno-169-4" name="__codelineno-169-4" href="#__codelineno-169-4"></a><span class="c1"># Load frontend themes from the themes folder</span>
</span><span id="__span-169-5"><a id="__codelineno-169-5" name="__codelineno-169-5" href="#__codelineno-169-5"></a><span class="nt">frontend</span><span class="p">:</span>
</span><span id="__span-169-6"><a id="__codelineno-169-6" name="__codelineno-169-6" href="#__codelineno-169-6"></a><span class="w">  </span><span class="nt">themes</span><span class="p">:</span><span class="w"> </span><span class="kt">!include_dir_merge_named</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">themes</span>
</span><span id="__span-169-7"><a id="__codelineno-169-7" name="__codelineno-169-7" href="#__codelineno-169-7"></a>
</span><span id="__span-169-8"><a id="__codelineno-169-8" name="__codelineno-169-8" href="#__codelineno-169-8"></a><span class="nt">automation</span><span class="p">:</span><span class="w"> </span><span class="kt">!include</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">automations.yaml</span>
</span><span id="__span-169-9"><a id="__codelineno-169-9" name="__codelineno-169-9" href="#__codelineno-169-9"></a><span class="nt">script</span><span class="p">:</span><span class="w"> </span><span class="kt">!include</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">scripts.yaml</span>
</span><span id="__span-169-10"><a id="__codelineno-169-10" name="__codelineno-169-10" href="#__codelineno-169-10"></a><span class="nt">scene</span><span class="p">:</span><span class="w"> </span><span class="kt">!include</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">scenes.yaml</span>
</span><span id="__span-169-11"><a id="__codelineno-169-11" name="__codelineno-169-11" href="#__codelineno-169-11"></a>
</span><span id="__span-169-12"><a id="__codelineno-169-12" name="__codelineno-169-12" href="#__codelineno-169-12"></a><span class="nt">http</span><span class="p">:</span>
</span><span id="__span-169-13"><a id="__codelineno-169-13" name="__codelineno-169-13" href="#__codelineno-169-13"></a><span class="w">  </span><span class="nt">use_x_forwarded_for</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
</span><span id="__span-169-14"><a id="__codelineno-169-14" name="__codelineno-169-14" href="#__codelineno-169-14"></a><span class="w">  </span><span class="nt">trusted_proxies</span><span class="p">:</span>
</span><span id="__span-169-15"><a id="__codelineno-169-15" name="__codelineno-169-15" href="#__codelineno-169-15"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10.244.0.0/16</span>
</span></code></pre></div>
<h4 id="deployment-in-lexicon">Deployment in <code>lexicon</code></h4>
<p>To test the <em>portability</em> of this deployment, applied it to <code>lexicon</code> and it
seemed to work, except for an error that shows in the logs every 30 seconds:</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-170-1"><a id="__codelineno-170-1" name="__codelineno-170-1" href="#__codelineno-170-1"></a>2025-04-21 11:14:49.560 ERROR (MainThread) [async_upnp_client.ssdp] Received error: [Errno 126] Required key not available, transport: &lt;_SelectorDatagramTransport fd=40 read=polling write=&lt;idle, bufsize=0&gt;&gt;, socket: &lt;asyncio.TransportSocket fd=40, family=2, type=2, proto=0, laddr=('0.0.0.0', 55239)&gt;
</span><span id="__span-170-2"><a id="__codelineno-170-2" name="__codelineno-170-2" href="#__codelineno-170-2"></a>2025-04-21 11:15:19.561 ERROR (MainThread) [async_upnp_client.ssdp] Received error: [Errno 126] Required key not available, transport: &lt;_SelectorDatagramTransport fd=40 read=polling write=&lt;idle, bufsize=0&gt;&gt;, socket: &lt;asyncio.TransportSocket fd=40, family=2, type=2, proto=0, laddr=('0.0.0.0', 55239)&gt;
</span><span id="__span-170-3"><a id="__codelineno-170-3" name="__codelineno-170-3" href="#__codelineno-170-3"></a>2025-04-21 11:15:49.561 ERROR (MainThread) [async_upnp_client.ssdp] Received error: [Errno 126] Required key not available, transport: &lt;_SelectorDatagramTransport fd=40 read=polling write=&lt;idle, bufsize=0&gt;&gt;, socket: &lt;asyncio.TransportSocket fd=40, family=2, type=2, proto=0, laddr=('0.0.0.0', 55239)&gt;
</span><span id="__span-170-4"><a id="__codelineno-170-4" name="__codelineno-170-4" href="#__codelineno-170-4"></a>2025-04-21 11:16:19.562 ERROR (MainThread) [async_upnp_client.ssdp] Received error: [Errno 126] Required key not available, transport: &lt;_SelectorDatagramTransport fd=40 read=polling write=&lt;idle, bufsize=0&gt;&gt;, socket: &lt;asyncio.TransportSocket fd=40, family=2, type=2, proto=0, laddr=('0.0.0.0', 55239)&gt;
</span></code></pre></div>
<p>There are multiple threads with pretty much exactly the same error lines in the
<a href="https://community.home-assistant.io/t/network-failed-without-reason/843528">Home Assistant Community</a>,
but all of them <em>die out with a solution</em> other than <em>restart Home Assistant</em> or
<em>unplug and replug the network cable</em>:</p>
<ul>
<li>2023-01-08: <a href="https://community.home-assistant.io/t/network-crashing/515157">Network Crashing</a></li>
<li>2021-11-04: <a href="https://community.home-assistant.io/t/ha-blue-loosing-connection-network-unreachable/353001">HA Blue loosing connection - Network unreachable</a></li>
<li>2024-01-09: <a href="https://community.home-assistant.io/t/ha-crashed-with-no-obvious-reason/670042">HA crashed with no obvious reason</a></li>
<li>2024-05-28: <a href="https://community.home-assistant.io/t/async-upnp-client-ssdp-received-error-errno-101-network-unreachable/733815">[async_upnp_client.ssdp] Received error: [Errno 101] Network unreachable</a></li>
<li>2025-02-07: <a href="https://community.home-assistant.io/t/network-failed-without-reason/843528">Network failed without reason</a></li>
</ul>
<p><a href="https://www.reddit.com/r/homeassistant/comments/10mt3ac/comment/j67qt78/">This workaround by <code>/u/TristanDJr</code> (2023-01-28)</a>
seems to embrace the <em>unfixable</em> nature of the issue by constantly checking for loss
of network connectivity and resetting the WiFi interface when trigged. However, these
errors persisted after rebooting the server at least twice, over several hours. And yet,
despite all those errors, Home Assistant seems to be working very well, as it was able
to automatically discover several devices in the network.</p>
<h4 id="bluetooth-failed-setup">Bluetooth failed setup</h4>
<p>The one warning Home Assistant was showing after onboarding was related
to the Bluetooth controller:</p>
<div class="language-text highlight"><pre><span></span><code>Intel Corporate None (DC:21:48:43:B7:C2)  
No devices or entities  
Failed setup, will retry: hci0 (DC:21:48:43:B7:C2): hci0 (DC:21:48:43:B7:C2): DBus service not found; make sure the DBus socket is available: [Errno 2] No such file or directory
</code></pre></div>
<p><a href="https://www.home-assistant.io/integrations/bluetooth/#additional-details-for-container-core-and-supervised-installs">Making the DBus socket available in the container</a>
by <em>mounting</em> <code>/run/dbus</code> helped a bit:</p>
<div class="language-yaml highlight"><table class="highlighttable"><tbody><tr><th colspan="2" class="filename"><span class="filename">base/deployment.yaml</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-171-68">68</a></span>
<span class="normal"><a href="#__codelineno-171-69">69</a></span>
<span class="normal"><a href="#__codelineno-171-70">70</a></span>
<span class="normal"><a href="#__codelineno-171-71">71</a></span>
<span class="normal"><a href="#__codelineno-171-72">72</a></span>
<span class="normal"><a href="#__codelineno-171-73">73</a></span>
<span class="normal"><a href="#__codelineno-171-74">74</a></span>
<span class="normal"><a href="#__codelineno-171-75">75</a></span>
<span class="normal"><a href="#__codelineno-171-76">76</a></span>
<span class="normal"><a href="#__codelineno-171-77">77</a></span>
<span class="normal"><a href="#__codelineno-171-78">78</a></span>
<span class="normal"><a href="#__codelineno-171-79">79</a></span>
<span class="normal"><a href="#__codelineno-171-80">80</a></span>
<span class="normal"><a href="#__codelineno-171-81">81</a></span>
<span class="normal"><a href="#__codelineno-171-82">82</a></span>
<span class="normal"><a href="#__codelineno-171-83">83</a></span>
<span class="normal"><a href="#__codelineno-171-84">84</a></span>
<span class="normal"><a href="#__codelineno-171-85">85</a></span>
<span class="normal"><a href="#__codelineno-171-86">86</a></span>
<span class="normal"><a href="#__codelineno-171-87">87</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-171-68"><a id="__codelineno-171-68" name="__codelineno-171-68"></a><span class="w">          </span><span class="nt">volumeMounts</span><span class="p">:</span>
</span><span id="__span-171-69"><a id="__codelineno-171-69" name="__codelineno-171-69"></a><span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ha-config-root</span>
</span><span id="__span-171-70"><a id="__codelineno-171-70" name="__codelineno-171-70"></a><span class="w">              </span><span class="nt">mountPath</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/config</span>
</span><span id="__span-171-71"><a id="__codelineno-171-71" name="__codelineno-171-71"></a><span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">configmap-file</span>
</span><span id="__span-171-72"><a id="__codelineno-171-72" name="__codelineno-171-72"></a><span class="w">              </span><span class="nt">mountPath</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/config/configuration.yaml</span>
</span><span id="__span-171-73"><a id="__codelineno-171-73" name="__codelineno-171-73"></a><span class="w">              </span><span class="nt">subPath</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">configuration.yaml</span>
</span><span id="__span-171-74"><a id="__codelineno-171-74" name="__codelineno-171-74"></a><span class="hll"><span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">dev-dbus</span>
</span></span><span id="__span-171-75"><a id="__codelineno-171-75" name="__codelineno-171-75"></a><span class="hll"><span class="w">              </span><span class="nt">mountPath</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/run/dbus</span>
</span></span><span id="__span-171-76"><a id="__codelineno-171-76" name="__codelineno-171-76"></a><span class="w">     </span><span class="w w-Error"> </span><span class="nt">restartPolicy</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Always</span>
</span><span id="__span-171-77"><a id="__codelineno-171-77" name="__codelineno-171-77"></a><span class="w">      </span><span class="nt">hostNetwork</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
</span><span id="__span-171-78"><a id="__codelineno-171-78" name="__codelineno-171-78"></a><span class="w">      </span><span class="nt">volumes</span><span class="p">:</span>
</span><span id="__span-171-79"><a id="__codelineno-171-79" name="__codelineno-171-79"></a><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ha-config-root</span>
</span><span id="__span-171-80"><a id="__codelineno-171-80" name="__codelineno-171-80"></a><span class="w">          </span><span class="nt">persistentVolumeClaim</span><span class="p">:</span>
</span><span id="__span-171-81"><a id="__codelineno-171-81" name="__codelineno-171-81"></a><span class="w">            </span><span class="nt">claimName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">home-assistant-config-root</span>
</span><span id="__span-171-82"><a id="__codelineno-171-82" name="__codelineno-171-82"></a><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">configmap-file</span>
</span><span id="__span-171-83"><a id="__codelineno-171-83" name="__codelineno-171-83"></a><span class="w">          </span><span class="nt">configMap</span><span class="p">:</span>
</span><span id="__span-171-84"><a id="__codelineno-171-84" name="__codelineno-171-84"></a><span class="w">            </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">home-assistant-configmap</span>
</span><span id="__span-171-85"><a id="__codelineno-171-85" name="__codelineno-171-85"></a><span class="hll"><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">dev-dbus</span>
</span></span><span id="__span-171-86"><a id="__codelineno-171-86" name="__codelineno-171-86"></a><span class="hll"><span class="w">          </span><span class="nt">hostPath</span><span class="p">:</span>
</span></span><span id="__span-171-87"><a id="__codelineno-171-87" name="__codelineno-171-87"></a><span class="hll"><span class="w">            </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/run/dbus</span>
</span></span></code></pre></div></td></tr></tbody></table></div>
<div class="language-console highlight"><pre><span></span><code><span id="__span-172-1"><a id="__codelineno-172-1" name="__codelineno-172-1" href="#__codelineno-172-1"></a><span class="gp">$ </span>kubectl<span class="w"> </span>apply<span class="w"> </span>-k<span class="w"> </span>lexicon
</span><span id="__span-172-2"><a id="__codelineno-172-2" name="__codelineno-172-2" href="#__codelineno-172-2"></a><span class="go">namespace/home-assistant unchanged</span>
</span><span id="__span-172-3"><a id="__codelineno-172-3" name="__codelineno-172-3" href="#__codelineno-172-3"></a><span class="go">configmap/home-assistant-config-59kccc4bcd unchanged</span>
</span><span id="__span-172-4"><a id="__codelineno-172-4" name="__codelineno-172-4" href="#__codelineno-172-4"></a><span class="go">configmap/home-assistant-configmap unchanged</span>
</span><span id="__span-172-5"><a id="__codelineno-172-5" name="__codelineno-172-5" href="#__codelineno-172-5"></a><span class="go">service/home-assistant-svc unchanged</span>
</span><span id="__span-172-6"><a id="__codelineno-172-6" name="__codelineno-172-6" href="#__codelineno-172-6"></a><span class="go">persistentvolume/home-assistant-pv-config unchanged</span>
</span><span id="__span-172-7"><a id="__codelineno-172-7" name="__codelineno-172-7" href="#__codelineno-172-7"></a><span class="go">persistentvolumeclaim/home-assistant-config-root unchanged</span>
</span><span id="__span-172-8"><a id="__codelineno-172-8" name="__codelineno-172-8" href="#__codelineno-172-8"></a><span class="go">deployment.apps/home-assistant configured</span>
</span><span id="__span-172-9"><a id="__codelineno-172-9" name="__codelineno-172-9" href="#__codelineno-172-9"></a><span class="go">ingress.networking.k8s.io/home-assistant-nginx unchanged</span>
</span><span id="__span-172-10"><a id="__codelineno-172-10" name="__codelineno-172-10" href="#__codelineno-172-10"></a><span class="go">ingress.networking.k8s.io/home-assistant-tailscale unchanged</span>
</span></code></pre></div>
<p>After reloading the integration, the error was different:</p>
<div class="language-text highlight"><pre><span></span><code>Failed setup, will retry: hci0 (DC:21:48:43:B7:C2): hci0 (DC:21:48:43:B7:C2): Failed to start Bluetooth: [org.freedesktop.DBus.Error.ServiceUnknown] The name org.bluez was not provided by any .service files; Try power cycling the Bluetooth hardware.
</code></pre></div>
<p>This suggests <strong>all 3</strong> steps in the Home Assistant documentation are
required, including <em>Switching from dbus-daemon to dbus-broker</em> and
<em>Installing BlueZ</em>.</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-173-1"><a id="__codelineno-173-1" name="__codelineno-173-1" href="#__codelineno-173-1"></a><span class="gp"># </span>apt<span class="w"> </span>install<span class="w"> </span>bluez<span class="w"> </span>dbus-broker<span class="w"> </span>-y
</span><span id="__span-173-2"><a id="__codelineno-173-2" name="__codelineno-173-2" href="#__codelineno-173-2"></a>
</span><span id="__span-173-3"><a id="__codelineno-173-3" name="__codelineno-173-3" href="#__codelineno-173-3"></a><span class="gp"># </span>systemctl<span class="w"> </span>--global<span class="w"> </span><span class="nb">enable</span><span class="w"> </span>dbus-broker.service
</span></code></pre></div>
<p>After this, without reloading the Bluetooth integration, it was instantely
fixed and ready to use.</p>
<p>The same 3 steps were then to <code>alfred</code> so that Bluetooth setup works well when the
onboarding is done.</p>
<h3 id="protect-critical-plugs">Protect critical plugs</h3>
<p>A few smart plugs must never be powered off, at least not accidentally.
To prevent that from happening, these can be <strong>hidden</strong> (not disabled)
<a href="https://community.home-assistant.io/t/is-it-possible-to-protect-a-switch-from-being-turned-off-accidentally/778126">so they don't show in dashboards</a>.
They remain available under <strong>Settings &gt; Devices &amp; services</strong>, where they
can still be powered off if necessary.</p>
<h3 id="home-assistant-community-store">Home Assistant Community Store</h3>
<p>Several of the following improvements require installing components from the
<a href="https://www.hacs.xyz/docs/use/">HACS</a> (<em>Home Assistant Community Store</em>).</p>
<p>This involves running the installation script from inside the pod:</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-174-1"><a id="__codelineno-174-1" name="__codelineno-174-1" href="#__codelineno-174-1"></a><span class="gp">$ </span>kubectl<span class="w"> </span>get<span class="w"> </span>pods<span class="w"> </span>-n<span class="w"> </span>home-assistant
</span><span id="__span-174-2"><a id="__codelineno-174-2" name="__codelineno-174-2" href="#__codelineno-174-2"></a><span class="go">NAME                              READY   STATUS    RESTARTS      AGE</span>
</span><span id="__span-174-3"><a id="__codelineno-174-3" name="__codelineno-174-3" href="#__codelineno-174-3"></a><span class="go">home-assistant-686974fbcb-rqv9t   1/1     Running   1 (17h ago)   26h</span>
</span><span id="__span-174-4"><a id="__codelineno-174-4" name="__codelineno-174-4" href="#__codelineno-174-4"></a>
</span><span id="__span-174-5"><a id="__codelineno-174-5" name="__codelineno-174-5" href="#__codelineno-174-5"></a><span class="gp">$ </span>kubectl<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>--stdin<span class="w"> </span>--tty<span class="w"> </span>home-assistant-686974fbcb-rqv9t<span class="w"> </span>-n<span class="w"> </span>home-assistant<span class="w"> </span>--<span class="w"> </span>/bin/bash
</span></code></pre></div>
<p>Once inside the pods, confirm that <code>wget</code> and <code>unzip</code> are available, then run:</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-175-1"><a id="__codelineno-175-1" name="__codelineno-175-1" href="#__codelineno-175-1"></a><span class="gp">lexicon:/config# </span>wget<span class="w"> </span>-O<span class="w"> </span>install-hacs.sh<span class="w"> </span>https://get.hacs.xyz
</span><span id="__span-175-2"><a id="__codelineno-175-2" name="__codelineno-175-2" href="#__codelineno-175-2"></a><span class="go">Connecting to get.hacs.xyz (172.67.68.101:443)</span>
</span><span id="__span-175-3"><a id="__codelineno-175-3" name="__codelineno-175-3" href="#__codelineno-175-3"></a><span class="go">Connecting to raw.githubusercontent.com (185.199.109.133:443)</span>
</span><span id="__span-175-4"><a id="__codelineno-175-4" name="__codelineno-175-4" href="#__codelineno-175-4"></a><span class="go">saving to 'install-hacs.sh'</span>
</span><span id="__span-175-5"><a id="__codelineno-175-5" name="__codelineno-175-5" href="#__codelineno-175-5"></a><span class="go">install-hacs.sh      100% |**************************************************************|  4990  0:00:00 ETA</span>
</span><span id="__span-175-6"><a id="__codelineno-175-6" name="__codelineno-175-6" href="#__codelineno-175-6"></a><span class="go">'install-hacs.sh' saved</span>
</span><span id="__span-175-7"><a id="__codelineno-175-7" name="__codelineno-175-7" href="#__codelineno-175-7"></a>
</span><span id="__span-175-8"><a id="__codelineno-175-8" name="__codelineno-175-8" href="#__codelineno-175-8"></a><span class="gp">lexicon:/config# </span>bash<span class="w"> </span>install-hacs.sh<span class="w"> </span>
</span><span id="__span-175-9"><a id="__codelineno-175-9" name="__codelineno-175-9" href="#__codelineno-175-9"></a><span class="go">INFO: Trying to find the correct directory...</span>
</span><span id="__span-175-10"><a id="__codelineno-175-10" name="__codelineno-175-10" href="#__codelineno-175-10"></a><span class="go">INFO: Found Home Assistant configuration directory at '/config'</span>
</span><span id="__span-175-11"><a id="__codelineno-175-11" name="__codelineno-175-11" href="#__codelineno-175-11"></a><span class="go">INFO: Creating custom_components directory...</span>
</span><span id="__span-175-12"><a id="__codelineno-175-12" name="__codelineno-175-12" href="#__codelineno-175-12"></a><span class="go">INFO: Changing to the custom_components directory...</span>
</span><span id="__span-175-13"><a id="__codelineno-175-13" name="__codelineno-175-13" href="#__codelineno-175-13"></a><span class="go">INFO: Downloading HACS</span>
</span><span id="__span-175-14"><a id="__codelineno-175-14" name="__codelineno-175-14" href="#__codelineno-175-14"></a><span class="go">Connecting to github.com (140.82.121.4:443)</span>
</span><span id="__span-175-15"><a id="__codelineno-175-15" name="__codelineno-175-15" href="#__codelineno-175-15"></a><span class="go">Connecting to github.com (140.82.121.4:443)</span>
</span><span id="__span-175-16"><a id="__codelineno-175-16" name="__codelineno-175-16" href="#__codelineno-175-16"></a><span class="go">Connecting to objects.githubusercontent.com (185.199.110.133:443)</span>
</span><span id="__span-175-17"><a id="__codelineno-175-17" name="__codelineno-175-17" href="#__codelineno-175-17"></a><span class="go">saving to 'hacs.zip'</span>
</span><span id="__span-175-18"><a id="__codelineno-175-18" name="__codelineno-175-18" href="#__codelineno-175-18"></a><span class="go">hacs.zip             100% |**************************************************************| 18.1M  0:00:00 ETA</span>
</span><span id="__span-175-19"><a id="__codelineno-175-19" name="__codelineno-175-19" href="#__codelineno-175-19"></a><span class="go">'hacs.zip' saved</span>
</span><span id="__span-175-20"><a id="__codelineno-175-20" name="__codelineno-175-20" href="#__codelineno-175-20"></a><span class="go">INFO: Creating HACS directory...</span>
</span><span id="__span-175-21"><a id="__codelineno-175-21" name="__codelineno-175-21" href="#__codelineno-175-21"></a><span class="go">INFO: Unpacking HACS...</span>
</span><span id="__span-175-22"><a id="__codelineno-175-22" name="__codelineno-175-22" href="#__codelineno-175-22"></a>
</span><span id="__span-175-23"><a id="__codelineno-175-23" name="__codelineno-175-23" href="#__codelineno-175-23"></a><span class="go">INFO: Verifying versions</span>
</span><span id="__span-175-24"><a id="__codelineno-175-24" name="__codelineno-175-24" href="#__codelineno-175-24"></a><span class="go">INFO: Current version is 2025.4.3, minimum version is 2024.4.1</span>
</span><span id="__span-175-25"><a id="__codelineno-175-25" name="__codelineno-175-25" href="#__codelineno-175-25"></a>
</span><span id="__span-175-26"><a id="__codelineno-175-26" name="__codelineno-175-26" href="#__codelineno-175-26"></a><span class="go">INFO: Removing HACS zip file...</span>
</span><span id="__span-175-27"><a id="__codelineno-175-27" name="__codelineno-175-27" href="#__codelineno-175-27"></a><span class="go">INFO: Installation complete.</span>
</span><span id="__span-175-28"><a id="__codelineno-175-28" name="__codelineno-175-28" href="#__codelineno-175-28"></a>
</span><span id="__span-175-29"><a id="__codelineno-175-29" name="__codelineno-175-29" href="#__codelineno-175-29"></a><span class="go">INFO: Remember to restart Home Assistant before you configure it</span>
</span><span id="__span-175-30"><a id="__codelineno-175-30" name="__codelineno-175-30" href="#__codelineno-175-30"></a>
</span><span id="__span-175-31"><a id="__codelineno-175-31" name="__codelineno-175-31" href="#__codelineno-175-31"></a><span class="gp">lexicon:/config# </span>
</span><span id="__span-175-32"><a id="__codelineno-175-32" name="__codelineno-175-32" href="#__codelineno-175-32"></a><span class="go">exit</span>
</span></code></pre></div>
<p>One installed, restart Home Assistant using the power button icon at the top-right
under <strong>Settings &gt; Hardware</strong>.</p>
<h4 id="how-to-add-cards">How to add cards</h4>
<p><a href="https://github.com/home-assistant-tutorials/02.hello-world-card?tab=readme-ov-file#hello-world-card">Hello World Card</a>
explains the basics of installing and using custom cards.</p>
<p>To <em>add a Resource</em> go to <strong>Settings &gt; Dashboards</strong> and pick <strong>Resources</strong> from
<a href="https://community.home-assistant.io/t/where-are-dashboard-resources-tab-in-the-new-ui/435822/4">the 3-dot menu in the top-right corner</a>.</p>
<h3 id="real-time-power-monitoring">Real-time power monitoring</h3>
<p>There is no built-in dashboard for real-time power usage, which is precisely what I
need to re-implement 
<a href="../../../../2024/12/28/continuous-monitoring-for-tp-link-tapo-devices/">Continuous Monitoring for TP-Link Tapo devices</a>.</p>
<p>There are multiple solutions to evaluate, all of which seem to require varying degrees
of crafting:</p>
<ul>
<li><a href="https://community.home-assistant.io/t/wth-isn-t-there-a-dashboard-for-real-time-power-usage/802204/3">A <em>dashboard and used a bunch of mushrooms in concert with the sections layout</em></a>
    with a graph of the last hour of usage.</li>
<li><a href="#ha-tdv-bar">ha-tdv-bar</a> shows individual power usage, but not total.</li>
<li><a href="#mini-graph-card">Mini Graph Card</a> supports showing better charts, but it does not
    support showing <strong>stacked</strong> graphs or
    <a href="https://github.com/kalkih/mini-graph-card/discussions/1158">making the title show the total sum of all values</a>.</li>
<li><a href="https://community.home-assistant.io/t/bubble-card-a-minimalist-card-collection-for-home-assistant-with-a-nice-pop-up-touch/609678/">Bubble Card</a>
    is <em>a minimalist card collection for Home Assistant with a nice pop-up touch</em>.</li>
<li><a href="https://community.home-assistant.io/t/bubble-card-a-minimalist-card-collection-for-home-assistant-with-a-nice-pop-up-touch/609678/">Mushroom</a>
    is a collection of cards for Home Assistant Dashboard UI.</li>
<li><a href="https://github.com/shannonhochkins/ha-component-kit?tab=readme-ov-file#ha-component-kit">HA COMPONENT KIT</a> 
    <em>to create seamless, highly customizable interfaces for Home Assistant dashboards</em>.</li>
<li><a href="https://www.reddit.com/r/homeassistant/comments/1hxm7wq/comment/m6fcg8z/">Understand templates to elevate your game</a>.</li>
</ul>
<h4 id="ha-tdv-bar">ha-tdv-bar</h4>
<p>The <a href="https://github.com/tdvtdv/ha-tdv-bar?tab=readme-ov-file#ha-tdv-bar">ha-tdv-bar</a>
cards makes it very easy to show the <em>individual</em> power usage of multiple devices in a
single card, but offers no easy way to show the <strong>total</strong> power usage across them all.</p>
<h4 id="mini-graph-card">Mini Graph Card</h4>
<p><a href="https://github.com/kalkih/mini-graph-card?tab=readme-ov-file#lovelace-mini-graph-card">Lovelace Mini Graph Card</a>
supports showing better charts, where power usage can be in a single graph of multiple
ones, but it does not support showing <strong>stacked</strong> graphs or
<a href="https://github.com/kalkih/mini-graph-card/discussions/1158">making the title show the total sum of all values</a>.</p>
<h4 id="multiple-cards-combined">Multiple cards combined</h4>
<p><a href="https://community.home-assistant.io/t/dashboard-real-time-power-meter-with-device-level-detail/420763">Dashboard real-time power meter with device-level detail</a>
combines
<a href="https://github.com/iantrich/config-template-card?tab=readme-ov-file#config-template-card-card">Config Template Card</a>,
<a href="https://github.com/thomasloven/lovelace-card-mod?tab=readme-ov-file#card-mod-3">Custom Card Mod</a>
(<a href="https://community.home-assistant.io/t/card-mod-add-css-styles-to-any-lovelace-card/120744/9">Add css styles to any lovelace card</a>),
<a href="https://community.home-assistant.io/t/lovelace-bar-card/87503">Bar Card</a>
<em>to create a nice power consumption meter</em>. It also leverages
<a href="https://seanblanchfield.com/2022/02/virtual-energy-meters-with-powercalc">Virtual Energy Meters with PowerCalc</a>
to create <em>virtual sensors</em> to monitor estimated power usage from devices
that have a constant power usage.</p>
<p><a href="https://seanblanchfield.com/2022/05/real-time-device-power-meters-in-home-assistant">Real Time Device Power Meter for Home Assistant</a>
explains pretty well how to make this, including the creation of <strong>virtual sensors</strong> to
account for power usage from devices without actual sensors. This involves creating a
few YAML files directly in the Home Assistant <code>/config</code> directory (and then restarting
Home Assistant to pick them up).</p>
<p>Create the directory  <code>/home/k8s/home-assistant/templates/sensors/</code> to store the
virtual sensors and update <code>configuration.yaml</code> to load files from it:</p>
<div class="language-yaml highlight"><span class="filename">/home/k8s/home-assistant/configuration.yaml</span><pre><span></span><code><span id="__span-176-1"><a id="__codelineno-176-1" name="__codelineno-176-1" href="#__codelineno-176-1"></a><span class="nt">default_config</span><span class="p">:</span>
</span><span id="__span-176-2"><a id="__codelineno-176-2" name="__codelineno-176-2" href="#__codelineno-176-2"></a>
</span><span id="__span-176-3"><a id="__codelineno-176-3" name="__codelineno-176-3" href="#__codelineno-176-3"></a><span class="c1"># Load frontend themes from the themes folder</span>
</span><span id="__span-176-4"><a id="__codelineno-176-4" name="__codelineno-176-4" href="#__codelineno-176-4"></a><span class="nt">frontend</span><span class="p">:</span>
</span><span id="__span-176-5"><a id="__codelineno-176-5" name="__codelineno-176-5" href="#__codelineno-176-5"></a><span class="w">  </span><span class="nt">themes</span><span class="p">:</span><span class="w"> </span><span class="kt">!include_dir_merge_named</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">themes</span>
</span><span id="__span-176-6"><a id="__codelineno-176-6" name="__codelineno-176-6" href="#__codelineno-176-6"></a>
</span><span id="__span-176-7"><a id="__codelineno-176-7" name="__codelineno-176-7" href="#__codelineno-176-7"></a><span class="nt">automation</span><span class="p">:</span><span class="w"> </span><span class="kt">!include</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">automations.yaml</span>
</span><span id="__span-176-8"><a id="__codelineno-176-8" name="__codelineno-176-8" href="#__codelineno-176-8"></a><span class="nt">script</span><span class="p">:</span><span class="w"> </span><span class="kt">!include</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">scripts.yaml</span>
</span><span id="__span-176-9"><a id="__codelineno-176-9" name="__codelineno-176-9" href="#__codelineno-176-9"></a><span class="nt">scene</span><span class="p">:</span><span class="w"> </span><span class="kt">!include</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">scenes.yaml</span>
</span><span id="__span-176-10"><a id="__codelineno-176-10" name="__codelineno-176-10" href="#__codelineno-176-10"></a>
</span><span id="__span-176-11"><a id="__codelineno-176-11" name="__codelineno-176-11" href="#__codelineno-176-11"></a><span class="nt">http</span><span class="p">:</span>
</span><span id="__span-176-12"><a id="__codelineno-176-12" name="__codelineno-176-12" href="#__codelineno-176-12"></a><span class="w">  </span><span class="nt">use_x_forwarded_for</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
</span><span id="__span-176-13"><a id="__codelineno-176-13" name="__codelineno-176-13" href="#__codelineno-176-13"></a><span class="w">  </span><span class="nt">trusted_proxies</span><span class="p">:</span>
</span><span id="__span-176-14"><a id="__codelineno-176-14" name="__codelineno-176-14" href="#__codelineno-176-14"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10.244.0.0/16</span>
</span><span id="__span-176-15"><a id="__codelineno-176-15" name="__codelineno-176-15" href="#__codelineno-176-15"></a>
</span><span id="__span-176-16"><a id="__codelineno-176-16" name="__codelineno-176-16" href="#__codelineno-176-16"></a><span class="hll"><span class="nt">template</span><span class="p">:</span>
</span></span><span id="__span-176-17"><a id="__codelineno-176-17" name="__codelineno-176-17" href="#__codelineno-176-17"></a><span class="hll"><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">sensor</span><span class="p">:</span><span class="w"> </span><span class="kt">!include_dir_merge_list</span><span class="w">  </span><span class="l l-Scalar l-Scalar-Plain">templates/sensors/</span>
</span></span></code></pre></div>
<p>Then create a virtual sensor <code>all_power</code> with the aggregate sum of all power sensors:</p>
<div class="language-yaml highlight"><span class="filename">/home/k8s/home-assistant/template/sensors/power.yaml</span><pre><span></span><code><span id="__span-177-1"><a id="__codelineno-177-1" name="__codelineno-177-1" href="#__codelineno-177-1"></a><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">all_power</span>
</span><span id="__span-177-2"><a id="__codelineno-177-2" name="__codelineno-177-2" href="#__codelineno-177-2"></a><span class="w">  </span><span class="nt">unique_id</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">all_power</span>
</span><span id="__span-177-3"><a id="__codelineno-177-3" name="__codelineno-177-3" href="#__codelineno-177-3"></a><span class="w">  </span><span class="nt">unit_of_measurement</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">W</span>
</span><span id="__span-177-4"><a id="__codelineno-177-4" name="__codelineno-177-4" href="#__codelineno-177-4"></a><span class="w">  </span><span class="nt">device_class</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">power</span>
</span><span id="__span-177-5"><a id="__codelineno-177-5" name="__codelineno-177-5" href="#__codelineno-177-5"></a><span class="w">  </span><span class="nt">state_class</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">measurement</span>
</span><span id="__span-177-6"><a id="__codelineno-177-6" name="__codelineno-177-6" href="#__codelineno-177-6"></a><span class="w">  </span><span class="nt">state</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">&gt;-</span>
</span><span id="__span-177-7"><a id="__codelineno-177-7" name="__codelineno-177-7" href="#__codelineno-177-7"></a><span class="w">    </span><span class="no">{{ </span>
</span><span id="__span-177-8"><a id="__codelineno-177-8" name="__codelineno-177-8" href="#__codelineno-177-8"></a><span class="hll"><span class="w">      </span><span class="no">states('sensor.mystrom_device_power')|float(0)</span>
</span></span><span id="__span-177-9"><a id="__codelineno-177-9" name="__codelineno-177-9" href="#__codelineno-177-9"></a><span class="hll"><span class="w">      </span><span class="no">+ states('sensor.homelab_current_consumption')|float(0)</span>
</span></span><span id="__span-177-10"><a id="__codelineno-177-10" name="__codelineno-177-10" href="#__codelineno-177-10"></a><span class="hll"><span class="w">      </span><span class="no">+ states('sensor.dell_1908fpc_current_consumption')|float(0)</span>
</span></span><span id="__span-177-11"><a id="__codelineno-177-11" name="__codelineno-177-11" href="#__codelineno-177-11"></a><span class="hll"><span class="w">      </span><span class="no">+ states('sensor.bed_heater_current_consumption')|float(0)</span>
</span></span><span id="__span-177-12"><a id="__codelineno-177-12" name="__codelineno-177-12" href="#__codelineno-177-12"></a><span class="hll"><span class="w">      </span><span class="no">+ states('sensor.bedlamp_current_consumption')|float(0)</span>
</span></span><span id="__span-177-13"><a id="__codelineno-177-13" name="__codelineno-177-13" href="#__codelineno-177-13"></a><span class="w">    </span><span class="no">}}</span>
</span></code></pre></div>
<p>At this point it is necessary to restart Home Assistant, or at least reload YAML files.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Home Assistant may fail to reload YAML files or restart due to references in
<code>configuration.yaml</code> to non-existant files; this can be easily solved by creating
those files: <code>touch automations.yaml scripts.yaml scenes.yaml</code>.</p>
</div>
<p>Once YAML files are reloaded, a new virtual sensor <code>all_power</code> should be available
to create cards with it, e.g. a gauge:</p>
<div class="language-yaml highlight"><pre><span></span><code><span id="__span-178-1"><a id="__codelineno-178-1" name="__codelineno-178-1" href="#__codelineno-178-1"></a><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">gauge</span>
</span><span id="__span-178-2"><a id="__codelineno-178-2" name="__codelineno-178-2" href="#__codelineno-178-2"></a><span class="nt">min</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0</span>
</span><span id="__span-178-3"><a id="__codelineno-178-3" name="__codelineno-178-3" href="#__codelineno-178-3"></a><span class="nt">entity</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">sensor.all_power</span>
</span><span id="__span-178-4"><a id="__codelineno-178-4" name="__codelineno-178-4" href="#__codelineno-178-4"></a><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Current Electricity Usage</span>
</span><span id="__span-178-5"><a id="__codelineno-178-5" name="__codelineno-178-5" href="#__codelineno-178-5"></a><span class="nt">max</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">500</span>
</span><span id="__span-178-6"><a id="__codelineno-178-6" name="__codelineno-178-6" href="#__codelineno-178-6"></a><span class="nt">needle</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
</span><span id="__span-178-7"><a id="__codelineno-178-7" name="__codelineno-178-7" href="#__codelineno-178-7"></a><span class="nt">severity</span><span class="p">:</span>
</span><span id="__span-178-8"><a id="__codelineno-178-8" name="__codelineno-178-8" href="#__codelineno-178-8"></a><span class="w">  </span><span class="nt">green</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0</span>
</span><span id="__span-178-9"><a id="__codelineno-178-9" name="__codelineno-178-9" href="#__codelineno-178-9"></a><span class="w">  </span><span class="nt">yellow</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">100</span>
</span><span id="__span-178-10"><a id="__codelineno-178-10" name="__codelineno-178-10" href="#__codelineno-178-10"></a><span class="w">  </span><span class="nt">red</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">400</span>
</span><span id="__span-178-11"><a id="__codelineno-178-11" name="__codelineno-178-11" href="#__codelineno-178-11"></a><span class="nt">unit</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">W</span>
</span></code></pre></div>
<details class="warning">
<summary>Entity is currently unavailable: sensor.all_power</summary>
<p>Sometimes the new entity becomes unavailable. This appears to go away after a few
seconds, or a full Home Assistant restart, without leaving any clue in the logs.</p>
</details>
<p>Combined with the previous cards (<a href="#ha-tdv-bar">ha-tdv-bar</a> and
<a href="#mini-graph-card">Mini Graph Card</a>) this all comes together to offer a useful overview:</p>
<p><a class="glightbox" data-type="image" data-width="auto" data-height="auto" href="../../../../media/2025-02-22-home-assistant-on-kubernetes-on-raspberry-pi-5-alfred/home-assistant-power-dashboard.png" data-desc-position="bottom"><img alt="Home Assistant Power Dashboard" src="../../../../media/2025-02-22-home-assistant-on-kubernetes-on-raspberry-pi-5-alfred/home-assistant-power-dashboard.png" style="height:800px;width:360px"></a></p>
<h4 id="a-better-bar-card">A better bar card</h4>
<p>For a better bar card, install the
<a href="https://github.com/thomasloven/lovelace-card-mod?tab=readme-ov-file#card-mod-3">Custom Card Mod</a>
manually and then add this card to the dashboard:</p>
<details class="code">
<summary>Custom template card for individual power usage sensors.</summary>
<div class="language-yaml highlight"><pre><span></span><code><span id="__span-179-1"><a id="__codelineno-179-1" name="__codelineno-179-1" href="#__codelineno-179-1"></a><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="s">'custom:config-template-card'</span>
</span><span id="__span-179-2"><a id="__codelineno-179-2" name="__codelineno-179-2" href="#__codelineno-179-2"></a><span class="nt">variables</span><span class="p">:</span>
</span><span id="__span-179-3"><a id="__codelineno-179-3" name="__codelineno-179-3" href="#__codelineno-179-3"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">entity</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">sensor.mystrom_device_power</span>
</span><span id="__span-179-4"><a id="__codelineno-179-4" name="__codelineno-179-4" href="#__codelineno-179-4"></a><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Office</span>
</span><span id="__span-179-5"><a id="__codelineno-179-5" name="__codelineno-179-5" href="#__codelineno-179-5"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">entity</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">sensor.homelab_current_consumption</span>
</span><span id="__span-179-6"><a id="__codelineno-179-6" name="__codelineno-179-6" href="#__codelineno-179-6"></a><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Homelab</span>
</span><span id="__span-179-7"><a id="__codelineno-179-7" name="__codelineno-179-7" href="#__codelineno-179-7"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">entity</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">sensor.dell_1908fpc_current_consumption</span>
</span><span id="__span-179-8"><a id="__codelineno-179-8" name="__codelineno-179-8" href="#__codelineno-179-8"></a><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Dell 1908FPc</span>
</span><span id="__span-179-9"><a id="__codelineno-179-9" name="__codelineno-179-9" href="#__codelineno-179-9"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">entity</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">sensor.bed_heater_current_consumption</span>
</span><span id="__span-179-10"><a id="__codelineno-179-10" name="__codelineno-179-10" href="#__codelineno-179-10"></a><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Bed heater</span>
</span><span id="__span-179-11"><a id="__codelineno-179-11" name="__codelineno-179-11" href="#__codelineno-179-11"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">entity</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">sensor.tv_smart_plug_power</span>
</span><span id="__span-179-12"><a id="__codelineno-179-12" name="__codelineno-179-12" href="#__codelineno-179-12"></a><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">TV</span>
</span><span id="__span-179-13"><a id="__codelineno-179-13" name="__codelineno-179-13" href="#__codelineno-179-13"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">entity</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">sensor.bedlamp_current_consumption</span>
</span><span id="__span-179-14"><a id="__codelineno-179-14" name="__codelineno-179-14" href="#__codelineno-179-14"></a><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Bed lamp</span>
</span><span id="__span-179-15"><a id="__codelineno-179-15" name="__codelineno-179-15" href="#__codelineno-179-15"></a><span class="nt">entities</span><span class="p">:</span><span class="w"> </span>
</span><span id="__span-179-16"><a id="__codelineno-179-16" name="__codelineno-179-16" href="#__codelineno-179-16"></a><span class="w">  </span><span class="c1"># Note: this list of entities may seem redundant, but is necessary to inform</span>
</span><span id="__span-179-17"><a id="__codelineno-179-17" name="__codelineno-179-17" href="#__codelineno-179-17"></a><span class="w">  </span><span class="c1"># config-template-card which entities to watch for updates.</span>
</span><span id="__span-179-18"><a id="__codelineno-179-18" name="__codelineno-179-18" href="#__codelineno-179-18"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">sensor.mystrom_device_power</span>
</span><span id="__span-179-19"><a id="__codelineno-179-19" name="__codelineno-179-19" href="#__codelineno-179-19"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">sensor.homelab_current_consumption</span>
</span><span id="__span-179-20"><a id="__codelineno-179-20" name="__codelineno-179-20" href="#__codelineno-179-20"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">sensor.dell_1908fpc_current_consumption</span>
</span><span id="__span-179-21"><a id="__codelineno-179-21" name="__codelineno-179-21" href="#__codelineno-179-21"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">sensor.bed_heater_current_consumption</span>
</span><span id="__span-179-22"><a id="__codelineno-179-22" name="__codelineno-179-22" href="#__codelineno-179-22"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">sensor.bedlamp_current_consumption</span>
</span><span id="__span-179-23"><a id="__codelineno-179-23" name="__codelineno-179-23" href="#__codelineno-179-23"></a><span class="nt">element</span><span class="p">:</span>
</span><span id="__span-179-24"><a id="__codelineno-179-24" name="__codelineno-179-24" href="#__codelineno-179-24"></a><span class="w">  </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="s">'custom:bar-card'</span>
</span><span id="__span-179-25"><a id="__codelineno-179-25" name="__codelineno-179-25" href="#__codelineno-179-25"></a><span class="w">  </span><span class="nt">entities</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|-</span><span class="w"> </span>
</span><span id="__span-179-26"><a id="__codelineno-179-26" name="__codelineno-179-26" href="#__codelineno-179-26"></a><span class="w">    </span><span class="no">${ vars.filter(v =&gt; {</span>
</span><span id="__span-179-27"><a id="__codelineno-179-27" name="__codelineno-179-27" href="#__codelineno-179-27"></a><span class="w">      </span><span class="no">let ent = states[v.entity];</span>
</span><span id="__span-179-28"><a id="__codelineno-179-28" name="__codelineno-179-28" href="#__codelineno-179-28"></a><span class="w">      </span><span class="no">if(ent === undefined || ent.state === undefined) {</span>
</span><span id="__span-179-29"><a id="__codelineno-179-29" name="__codelineno-179-29" href="#__codelineno-179-29"></a><span class="w">        </span><span class="no">console.warn(`Power meter: Entity ${v.entity} not found`);</span>
</span><span id="__span-179-30"><a id="__codelineno-179-30" name="__codelineno-179-30" href="#__codelineno-179-30"></a><span class="w">      </span><span class="no">}</span>
</span><span id="__span-179-31"><a id="__codelineno-179-31" name="__codelineno-179-31" href="#__codelineno-179-31"></a><span class="w">      </span><span class="no">else if(ent.state === 'unknown') {</span>
</span><span id="__span-179-32"><a id="__codelineno-179-32" name="__codelineno-179-32" href="#__codelineno-179-32"></a><span class="w">        </span><span class="no">console.warn(`Power meter: Entity ${v.entity} state is unknown`);</span>
</span><span id="__span-179-33"><a id="__codelineno-179-33" name="__codelineno-179-33" href="#__codelineno-179-33"></a><span class="w">      </span><span class="no">}</span>
</span><span id="__span-179-34"><a id="__codelineno-179-34" name="__codelineno-179-34" href="#__codelineno-179-34"></a><span class="w">      </span><span class="no">else if(isNaN(ent.state)) {</span>
</span><span id="__span-179-35"><a id="__codelineno-179-35" name="__codelineno-179-35" href="#__codelineno-179-35"></a><span class="w">        </span><span class="no">console.warn(`Power meter: Entity ${v.entity} state is not a number`);</span>
</span><span id="__span-179-36"><a id="__codelineno-179-36" name="__codelineno-179-36" href="#__codelineno-179-36"></a><span class="w">      </span><span class="no">}</span>
</span><span id="__span-179-37"><a id="__codelineno-179-37" name="__codelineno-179-37" href="#__codelineno-179-37"></a><span class="w">      </span><span class="no">else return Number(ent.state) &gt; 5;</span>
</span><span id="__span-179-38"><a id="__codelineno-179-38" name="__codelineno-179-38" href="#__codelineno-179-38"></a><span class="w">    </span><span class="no">}).sort((v1,v2) =&gt; states[v2.entity].state - states[v1.entity].state)}</span>
</span><span id="__span-179-39"><a id="__codelineno-179-39" name="__codelineno-179-39" href="#__codelineno-179-39"></a><span class="w">    </span><span class="no">direction: right</span>
</span><span id="__span-179-40"><a id="__codelineno-179-40" name="__codelineno-179-40" href="#__codelineno-179-40"></a><span class="w">    </span><span class="no">entity_row: true</span>
</span><span id="__span-179-41"><a id="__codelineno-179-41" name="__codelineno-179-41" href="#__codelineno-179-41"></a><span class="w">    </span><span class="no">min: 0</span>
</span><span id="__span-179-42"><a id="__codelineno-179-42" name="__codelineno-179-42" href="#__codelineno-179-42"></a><span class="w">    </span><span class="no">max: ${ Math.max(...vars.map(v =&gt; states[v.entity]).filter(e =&gt; !!e).map(e =&gt; e.state).filter(n =&gt; !isNaN(n))) }</span>
</span><span id="__span-179-43"><a id="__codelineno-179-43" name="__codelineno-179-43" href="#__codelineno-179-43"></a><span class="w">  </span><span class="nt">height</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">20px</span>
</span><span id="__span-179-44"><a id="__codelineno-179-44" name="__codelineno-179-44" href="#__codelineno-179-44"></a><span class="w">  </span><span class="nt">stack</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">vertical</span>
</span><span id="__span-179-45"><a id="__codelineno-179-45" name="__codelineno-179-45" href="#__codelineno-179-45"></a><span class="w">  </span><span class="nt">decimal</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0</span>
</span><span id="__span-179-46"><a id="__codelineno-179-46" name="__codelineno-179-46" href="#__codelineno-179-46"></a><span class="w">  </span><span class="nt">icon</span><span class="p">:</span><span class="w"> </span><span class="s">'mdi:flash'</span>
</span><span id="__span-179-47"><a id="__codelineno-179-47" name="__codelineno-179-47" href="#__codelineno-179-47"></a><span class="w">  </span><span class="nt">positions</span><span class="p">:</span>
</span><span id="__span-179-48"><a id="__codelineno-179-48" name="__codelineno-179-48" href="#__codelineno-179-48"></a><span class="w">    </span><span class="nt">icon</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">off</span>
</span><span id="__span-179-49"><a id="__codelineno-179-49" name="__codelineno-179-49" href="#__codelineno-179-49"></a><span class="w">    </span><span class="nt">indicator</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">outside</span>
</span><span id="__span-179-50"><a id="__codelineno-179-50" name="__codelineno-179-50" href="#__codelineno-179-50"></a><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">inside</span>
</span><span id="__span-179-51"><a id="__codelineno-179-51" name="__codelineno-179-51" href="#__codelineno-179-51"></a><span class="w">    </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">inside</span>
</span><span id="__span-179-52"><a id="__codelineno-179-52" name="__codelineno-179-52" href="#__codelineno-179-52"></a><span class="w">  </span><span class="nt">severity</span><span class="p">:</span>
</span><span id="__span-179-53"><a id="__codelineno-179-53" name="__codelineno-179-53" href="#__codelineno-179-53"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">color</span><span class="p">:</span><span class="w"> </span><span class="s">'#a1a1a18a'</span>
</span><span id="__span-179-54"><a id="__codelineno-179-54" name="__codelineno-179-54" href="#__codelineno-179-54"></a><span class="w">    </span><span class="nt">from</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0</span>
</span><span id="__span-179-55"><a id="__codelineno-179-55" name="__codelineno-179-55" href="#__codelineno-179-55"></a><span class="w">    </span><span class="nt">to</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">2</span>
</span><span id="__span-179-56"><a id="__codelineno-179-56" name="__codelineno-179-56" href="#__codelineno-179-56"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">color</span><span class="p">:</span><span class="w"> </span><span class="s">'#3ea8328a'</span>
</span><span id="__span-179-57"><a id="__codelineno-179-57" name="__codelineno-179-57" href="#__codelineno-179-57"></a><span class="w">    </span><span class="nt">from</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">2</span>
</span><span id="__span-179-58"><a id="__codelineno-179-58" name="__codelineno-179-58" href="#__codelineno-179-58"></a><span class="w">    </span><span class="nt">to</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10</span>
</span><span id="__span-179-59"><a id="__codelineno-179-59" name="__codelineno-179-59" href="#__codelineno-179-59"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">color</span><span class="p">:</span><span class="w"> </span><span class="s">'#85a8328a'</span>
</span><span id="__span-179-60"><a id="__codelineno-179-60" name="__codelineno-179-60" href="#__codelineno-179-60"></a><span class="w">    </span><span class="nt">from</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10</span>
</span><span id="__span-179-61"><a id="__codelineno-179-61" name="__codelineno-179-61" href="#__codelineno-179-61"></a><span class="w">    </span><span class="nt">to</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">50</span>
</span><span id="__span-179-62"><a id="__codelineno-179-62" name="__codelineno-179-62" href="#__codelineno-179-62"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">color</span><span class="p">:</span><span class="w"> </span><span class="s">'#a8a4328a'</span>
</span><span id="__span-179-63"><a id="__codelineno-179-63" name="__codelineno-179-63" href="#__codelineno-179-63"></a><span class="w">    </span><span class="nt">from</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">50</span>
</span><span id="__span-179-64"><a id="__codelineno-179-64" name="__codelineno-179-64" href="#__codelineno-179-64"></a><span class="w">    </span><span class="nt">to</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">200</span>
</span><span id="__span-179-65"><a id="__codelineno-179-65" name="__codelineno-179-65" href="#__codelineno-179-65"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">color</span><span class="p">:</span><span class="w"> </span><span class="s">'#a887328a'</span>
</span><span id="__span-179-66"><a id="__codelineno-179-66" name="__codelineno-179-66" href="#__codelineno-179-66"></a><span class="w">    </span><span class="nt">from</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">200</span>
</span><span id="__span-179-67"><a id="__codelineno-179-67" name="__codelineno-179-67" href="#__codelineno-179-67"></a><span class="w">    </span><span class="nt">to</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">500</span>
</span><span id="__span-179-68"><a id="__codelineno-179-68" name="__codelineno-179-68" href="#__codelineno-179-68"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">color</span><span class="p">:</span><span class="w"> </span><span class="s">'#a867328a'</span>
</span><span id="__span-179-69"><a id="__codelineno-179-69" name="__codelineno-179-69" href="#__codelineno-179-69"></a><span class="w">    </span><span class="nt">from</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">500</span>
</span><span id="__span-179-70"><a id="__codelineno-179-70" name="__codelineno-179-70" href="#__codelineno-179-70"></a><span class="w">    </span><span class="nt">to</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1000</span>
</span><span id="__span-179-71"><a id="__codelineno-179-71" name="__codelineno-179-71" href="#__codelineno-179-71"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">color</span><span class="p">:</span><span class="w"> </span><span class="s">'#a846328a'</span>
</span><span id="__span-179-72"><a id="__codelineno-179-72" name="__codelineno-179-72" href="#__codelineno-179-72"></a><span class="w">    </span><span class="nt">from</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1000</span>
</span><span id="__span-179-73"><a id="__codelineno-179-73" name="__codelineno-179-73" href="#__codelineno-179-73"></a><span class="w">    </span><span class="nt">to</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">3000</span>
</span><span id="__span-179-74"><a id="__codelineno-179-74" name="__codelineno-179-74" href="#__codelineno-179-74"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">color</span><span class="p">:</span><span class="w"> </span><span class="s">'#a832328a'</span>
</span><span id="__span-179-75"><a id="__codelineno-179-75" name="__codelineno-179-75" href="#__codelineno-179-75"></a><span class="w">    </span><span class="nt">from</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">3000</span>
</span><span id="__span-179-76"><a id="__codelineno-179-76" name="__codelineno-179-76" href="#__codelineno-179-76"></a><span class="w">    </span><span class="nt">to</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10000</span>
</span><span id="__span-179-77"><a id="__codelineno-179-77" name="__codelineno-179-77" href="#__codelineno-179-77"></a><span class="w">  </span><span class="nt">style</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|-</span>
</span><span id="__span-179-78"><a id="__codelineno-179-78" name="__codelineno-179-78" href="#__codelineno-179-78"></a><span class="w">    </span><span class="no">#states &gt; * {</span>
</span><span id="__span-179-79"><a id="__codelineno-179-79" name="__codelineno-179-79" href="#__codelineno-179-79"></a><span class="w">      </span><span class="no">margin: 1px;</span>
</span><span id="__span-179-80"><a id="__codelineno-179-80" name="__codelineno-179-80" href="#__codelineno-179-80"></a><span class="w">    </span><span class="no">}</span>
</span><span id="__span-179-81"><a id="__codelineno-179-81" name="__codelineno-179-81" href="#__codelineno-179-81"></a><span class="w">    </span><span class="no">bar-card-name,</span>
</span><span id="__span-179-82"><a id="__codelineno-179-82" name="__codelineno-179-82" href="#__codelineno-179-82"></a><span class="w">    </span><span class="no">bar-card-value {</span>
</span><span id="__span-179-83"><a id="__codelineno-179-83" name="__codelineno-179-83" href="#__codelineno-179-83"></a><span class="w">      </span><span class="no">font-size: 0.9rem;</span>
</span><span id="__span-179-84"><a id="__codelineno-179-84" name="__codelineno-179-84" href="#__codelineno-179-84"></a><span class="w">      </span><span class="no">color: #ffffffaa;</span>
</span><span id="__span-179-85"><a id="__codelineno-179-85" name="__codelineno-179-85" href="#__codelineno-179-85"></a><span class="w">      </span><span class="no">font-weight: bold;</span>
</span><span id="__span-179-86"><a id="__codelineno-179-86" name="__codelineno-179-86" href="#__codelineno-179-86"></a><span class="w">    </span><span class="no">}</span>
</span><span id="__span-179-87"><a id="__codelineno-179-87" name="__codelineno-179-87" href="#__codelineno-179-87"></a><span class="w">    </span><span class="no">bar-card-value  {</span>
</span><span id="__span-179-88"><a id="__codelineno-179-88" name="__codelineno-179-88" href="#__codelineno-179-88"></a><span class="w">      </span><span class="no">font-weight: bolder;</span>
</span><span id="__span-179-89"><a id="__codelineno-179-89" name="__codelineno-179-89" href="#__codelineno-179-89"></a><span class="w">    </span><span class="no">}</span>
</span><span id="__span-179-90"><a id="__codelineno-179-90" name="__codelineno-179-90" href="#__codelineno-179-90"></a><span class="w">    </span><span class="no">bar-card-indicator {</span>
</span><span id="__span-179-91"><a id="__codelineno-179-91" name="__codelineno-179-91" href="#__codelineno-179-91"></a><span class="w">      </span><span class="no">margin-top: 4px;</span>
</span><span id="__span-179-92"><a id="__codelineno-179-92" name="__codelineno-179-92" href="#__codelineno-179-92"></a><span class="w">      </span><span class="no">transform: scaleY(-1);</span>
</span><span id="__span-179-93"><a id="__codelineno-179-93" name="__codelineno-179-93" href="#__codelineno-179-93"></a><span class="w">    </span><span class="no">}</span>
</span></code></pre></div>
</details>
<div class="admonition todo">
<p class="admonition-title">Todo</p>
<p>Find out why this doesn't work at all. It doesn't even show anything when editing
the dashboard and can't even be edited afterwards, it can only be deleted.</p>
</div>
<h4 id="influxdb">InfluxDB</h4>
<p><a href="https://www.home-assistant.io/integrations/influxdb/">The influxdb integration</a>
makes it possible to transfer all state changes to an external InfluxDB database.
This could be used to transfer all data to the InfluxDB use for
<a href="#continuous-monitoring">Continuous Monitoring</a> and use a similar Grafana dashboard for
<a href="../../../../2024/12/28/continuous-monitoring-for-tp-link-tapo-devices/">Continuous Monitoring for TP-Link Tapo devices</a>.</p>
<p>To get started, add <code>influxdb:</code> to the main <code>configuration.yaml</code> and restart
Home Assistant, then find the <strong>InfluxDB</strong> will be available under
<strong>Settings &gt; Devices &amp; services</strong>. This integration cannot be configured from the UI;
instead create a new InfluxDB database <code>home_assistant</code> using the InfluxDB CLI,
with a retention policy of 800 days (well over 2 years):</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-180-1"><a id="__codelineno-180-1" name="__codelineno-180-1" href="#__codelineno-180-1"></a><span class="gp">$ </span>influx<span class="w"> </span>-host<span class="w"> </span>localhost<span class="w"> </span>-port<span class="w"> </span><span class="m">30086</span><span class="w"> </span>-username<span class="w"> </span>admin<span class="w"> </span>-password<span class="w"> </span><span class="s1">''</span>
</span><span id="__span-180-2"><a id="__codelineno-180-2" name="__codelineno-180-2" href="#__codelineno-180-2"></a><span class="go">password: </span>
</span><span id="__span-180-3"><a id="__codelineno-180-3" name="__codelineno-180-3" href="#__codelineno-180-3"></a><span class="go">Connected to http://localhost:30086 version 1.8.10</span>
</span><span id="__span-180-4"><a id="__codelineno-180-4" name="__codelineno-180-4" href="#__codelineno-180-4"></a><span class="go">InfluxDB shell version: 1.6</span>
</span><span id="__span-180-5"><a id="__codelineno-180-5" name="__codelineno-180-5" href="#__codelineno-180-5"></a>
</span><span id="__span-180-6"><a id="__codelineno-180-6" name="__codelineno-180-6" href="#__codelineno-180-6"></a><span class="go">&gt; CREATE DATABASE home_assistant</span>
</span><span id="__span-180-7"><a id="__codelineno-180-7" name="__codelineno-180-7" href="#__codelineno-180-7"></a><span class="go">&gt; CREATE RETENTION POLICY "800_days" ON "home_assistant" DURATION 800d REPLICATION 1</span>
</span><span id="__span-180-8"><a id="__codelineno-180-8" name="__codelineno-180-8" href="#__codelineno-180-8"></a><span class="go">&gt; ALTER RETENTION POLICY "800_days" on "home_assistant" DURATION 800d REPLICATION 1 DEFAULT</span>
</span></code></pre></div>
<p>To start sending metrics to InfluxDB, create a configuration based on the
<a href="https://www.home-assistant.io/integrations/influxdb/#full-configuration-for-1xx-installations">full configuration for 1.xx installations</a>, without
rules to <code>exclude</code> or <code>include</code> specific entities; no need to add
<a href="https://www.home-assistant.io/integrations/influxdb/#configure-filter">filters</a>
(by default all entities are sent to InfluxDB):</p>
<div class="language-yaml highlight"><pre><span></span><code><span id="__span-181-1"><a id="__codelineno-181-1" name="__codelineno-181-1" href="#__codelineno-181-1"></a><span class="nt">influxdb</span><span class="p">:</span>
</span><span id="__span-181-2"><a id="__codelineno-181-2" name="__codelineno-181-2" href="#__codelineno-181-2"></a><span class="w">  </span><span class="nt">host</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">192.168.0.6</span>
</span><span id="__span-181-3"><a id="__codelineno-181-3" name="__codelineno-181-3" href="#__codelineno-181-3"></a><span class="w">  </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">30086</span>
</span><span id="__span-181-4"><a id="__codelineno-181-4" name="__codelineno-181-4" href="#__codelineno-181-4"></a><span class="w">  </span><span class="nt">database</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">home_assistant</span>
</span><span id="__span-181-5"><a id="__codelineno-181-5" name="__codelineno-181-5" href="#__codelineno-181-5"></a><span class="w">  </span><span class="nt">username</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">admin</span>
</span><span id="__span-181-6"><a id="__codelineno-181-6" name="__codelineno-181-6" href="#__codelineno-181-6"></a><span class="w">  </span><span class="nt">password</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">MY_PASSWORD</span>
</span><span id="__span-181-7"><a id="__codelineno-181-7" name="__codelineno-181-7" href="#__codelineno-181-7"></a><span class="w">  </span><span class="nt">max_retries</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">3</span>
</span><span id="__span-181-8"><a id="__codelineno-181-8" name="__codelineno-181-8" href="#__codelineno-181-8"></a><span class="w">  </span><span class="nt">default_measurement</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">state</span>
</span><span id="__span-181-9"><a id="__codelineno-181-9" name="__codelineno-181-9" href="#__codelineno-181-9"></a><span class="w">  </span><span class="nt">tags</span><span class="p">:</span>
</span><span id="__span-181-10"><a id="__codelineno-181-10" name="__codelineno-181-10" href="#__codelineno-181-10"></a><span class="w">    </span><span class="nt">instance</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">prod</span>
</span><span id="__span-181-11"><a id="__codelineno-181-11" name="__codelineno-181-11" href="#__codelineno-181-11"></a><span class="w">    </span><span class="nt">source</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">hass</span>
</span><span id="__span-181-12"><a id="__codelineno-181-12" name="__codelineno-181-12" href="#__codelineno-181-12"></a><span class="w">  </span><span class="nt">component_config_glob</span><span class="p">:</span>
</span><span id="__span-181-13"><a id="__codelineno-181-13" name="__codelineno-181-13" href="#__codelineno-181-13"></a><span class="w">    </span><span class="nt">sensor.*humidity*</span><span class="p">:</span>
</span><span id="__span-181-14"><a id="__codelineno-181-14" name="__codelineno-181-14" href="#__codelineno-181-14"></a><span class="w">      </span><span class="nt">override_measurement</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">humidity</span>
</span><span id="__span-181-15"><a id="__codelineno-181-15" name="__codelineno-181-15" href="#__codelineno-181-15"></a><span class="w">    </span><span class="nt">sensor.*temperature*</span><span class="p">:</span>
</span><span id="__span-181-16"><a id="__codelineno-181-16" name="__codelineno-181-16" href="#__codelineno-181-16"></a><span class="w">      </span><span class="nt">override_measurement</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">temperature</span>
</span></code></pre></div>
<p>The <code>component_config_glob</code> is a workaround found in forum thread
<a href="https://community.home-assistant.io/t/influxdb-to-store-data-in-intervals/270896/17">InfluxDB to store data in intervals</a>
to replace the default <code>measurement</code> names, set as the unit of each entity,
(for example <code>C</code> for temperature entities), with more sensible names. This is
particularly useful for those measurements with <code>%</code> as their unit, since that
unit is used for measurements of very different kinds such as humidity, battery level,
cpu load and storage capacity used.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If the InfluxDB is reached over HTTP<strong>S</strong> the above config need to have
<code>ssl: true</code> and, depending on whether SSL certificates are valid or not,
also <code>verify_ssl: true</code> (or <code>false</code>).  </p>
</div>
<p>After restarting Home Assistant metrics start flowing into new measurements
into the new InfluxDB database. These can be used to create dashboards in
Grafana, after adding the new database as a new InfluxDB data source.</p>
<p><a href="https://www.home-assistant.io/integrations/influxdb/#sensor">The InfluxDB <code>sensor</code></a> <em>allows using values from a InfluxDB database to populate a sensor state. This can be used to present statistics as Home Assistant sensors, if used with the influxdb history integration. It can also be used with an external data source.</em> All this sound very
interesting for potential future expansions!</p>
<h4 id="persist-configuration-in-configmap">Persist configuration in <code>ConfigMap</code></h4>
<p>For months after deploying the above monitoring, it was observed that Home
Assistant would regularly lose the configuration and revert to its default,
leading to both the <code>sensor.all_power</code> entity not being available (indefinitely)
and InfluxDB no longer receiving any metrics (also indefinitely). For a long time,
The only workaround found was to revert <code>configuration.yaml</code> to the default,
restart Home Assistant from the web admin UI (not rebooting the node, not
restarting the deployment), then restore the configuration and restart again.</p>
<p>After much thinking about it (and not finding anyone anywhere ever having had the
same problem), it occurred to me that what was happening is that <em>somehow</em> Home
Assistant was reloading the default configuration from the <code>ConfigMap</code>, so the
solution was to add the configuration to <em>that</em> in <code>alfred/kustomization.yaml</code>:</p>
<div class="language-yaml highlight"><table class="highlighttable"><tbody><tr><th colspan="2" class="filename"><span class="filename">alfred/kustomization.yaml</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-182-23">23</a></span>
<span class="normal"><a href="#__codelineno-182-24">24</a></span>
<span class="normal"><a href="#__codelineno-182-25">25</a></span>
<span class="normal"><a href="#__codelineno-182-26">26</a></span>
<span class="normal"><a href="#__codelineno-182-27">27</a></span>
<span class="normal"><a href="#__codelineno-182-28">28</a></span>
<span class="normal"><a href="#__codelineno-182-29">29</a></span>
<span class="normal"><a href="#__codelineno-182-30">30</a></span>
<span class="normal"><a href="#__codelineno-182-31">31</a></span>
<span class="normal"><a href="#__codelineno-182-32">32</a></span>
<span class="normal"><a href="#__codelineno-182-33">33</a></span>
<span class="normal"><a href="#__codelineno-182-34">34</a></span>
<span class="normal"><a href="#__codelineno-182-35">35</a></span>
<span class="normal"><a href="#__codelineno-182-36">36</a></span>
<span class="normal"><a href="#__codelineno-182-37">37</a></span>
<span class="normal"><a href="#__codelineno-182-38">38</a></span>
<span class="normal"><a href="#__codelineno-182-39">39</a></span>
<span class="normal"><a href="#__codelineno-182-40">40</a></span>
<span class="normal"><a href="#__codelineno-182-41">41</a></span>
<span class="normal"><a href="#__codelineno-182-42">42</a></span>
<span class="normal"><a href="#__codelineno-182-43">43</a></span>
<span class="normal"><a href="#__codelineno-182-44">44</a></span>
<span class="normal"><a href="#__codelineno-182-45">45</a></span>
<span class="normal"><a href="#__codelineno-182-46">46</a></span>
<span class="normal"><a href="#__codelineno-182-47">47</a></span>
<span class="normal"><a href="#__codelineno-182-48">48</a></span>
<span class="normal"><a href="#__codelineno-182-49">49</a></span>
<span class="normal"><a href="#__codelineno-182-50">50</a></span>
<span class="normal"><a href="#__codelineno-182-51">51</a></span>
<span class="normal"><a href="#__codelineno-182-52">52</a></span>
<span class="normal"><a href="#__codelineno-182-53">53</a></span>
<span class="normal"><a href="#__codelineno-182-54">54</a></span>
<span class="normal"><a href="#__codelineno-182-55">55</a></span>
<span class="normal"><a href="#__codelineno-182-56">56</a></span>
<span class="normal"><a href="#__codelineno-182-57">57</a></span>
<span class="normal"><a href="#__codelineno-182-58">58</a></span>
<span class="normal"><a href="#__codelineno-182-59">59</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-182-23"><a id="__codelineno-182-23" name="__codelineno-182-23"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">target</span><span class="p">:</span><span class="w"> </span><span class="c1"># Hostname-only for Tailscale [Funnel]</span>
</span><span id="__span-182-24"><a id="__codelineno-182-24" name="__codelineno-182-24"></a><span class="w">      </span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Ingress</span>
</span><span id="__span-182-25"><a id="__codelineno-182-25" name="__codelineno-182-25"></a><span class="w">      </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">home-assistant-tailscale</span>
</span><span id="__span-182-26"><a id="__codelineno-182-26" name="__codelineno-182-26"></a><span class="w">    </span><span class="nt">patch</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|-</span>
</span><span id="__span-182-27"><a id="__codelineno-182-27" name="__codelineno-182-27"></a><span class="w">      </span><span class="no">- op: replace</span>
</span><span id="__span-182-28"><a id="__codelineno-182-28" name="__codelineno-182-28"></a><span class="w">        </span><span class="no">path: /spec/tls/0/hosts/0</span>
</span><span id="__span-182-29"><a id="__codelineno-182-29" name="__codelineno-182-29"></a><span class="w">        </span><span class="no">value: home-assistant-alfred</span>
</span><span id="__span-182-30"><a id="__codelineno-182-30" name="__codelineno-182-30"></a><span class="hll"><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">target</span><span class="p">:</span><span class="w"> </span><span class="c1"># Home Assistant config</span>
</span></span><span id="__span-182-31"><a id="__codelineno-182-31" name="__codelineno-182-31"></a><span class="hll"><span class="w">      </span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ConfigMap</span>
</span></span><span id="__span-182-32"><a id="__codelineno-182-32" name="__codelineno-182-32"></a><span class="hll"><span class="w">      </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">home-assistant-configmap</span>
</span></span><span id="__span-182-33"><a id="__codelineno-182-33" name="__codelineno-182-33"></a><span class="hll"><span class="w">    </span><span class="nt">patch</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|-</span>
</span></span><span id="__span-182-34"><a id="__codelineno-182-34" name="__codelineno-182-34"></a><span class="hll"><span class="w">      </span><span class="no">- op: replace</span>
</span></span><span id="__span-182-35"><a id="__codelineno-182-35" name="__codelineno-182-35"></a><span class="hll"><span class="w">        </span><span class="no">path: /data/configuration.yaml</span>
</span></span><span id="__span-182-36"><a id="__codelineno-182-36" name="__codelineno-182-36"></a><span class="hll"><span class="w">        </span><span class="no">value: |-</span>
</span></span><span id="__span-182-37"><a id="__codelineno-182-37" name="__codelineno-182-37"></a><span class="hll"><span class="w">          </span><span class="no">default_config:</span>
</span></span><span id="__span-182-38"><a id="__codelineno-182-38" name="__codelineno-182-38"></a><span class="hll"><span class="w">          </span><span class="no">http:</span>
</span></span><span id="__span-182-39"><a id="__codelineno-182-39" name="__codelineno-182-39"></a><span class="hll"><span class="w">            </span><span class="no">use_x_forwarded_for: true</span>
</span></span><span id="__span-182-40"><a id="__codelineno-182-40" name="__codelineno-182-40"></a><span class="hll"><span class="w">            </span><span class="no">trusted_proxies:</span>
</span></span><span id="__span-182-41"><a id="__codelineno-182-41" name="__codelineno-182-41"></a><span class="hll"><span class="w">              </span><span class="no">- 10.244.0.0/16</span>
</span></span><span id="__span-182-42"><a id="__codelineno-182-42" name="__codelineno-182-42"></a><span class="hll"><span class="w">          </span><span class="no">template:</span>
</span></span><span id="__span-182-43"><a id="__codelineno-182-43" name="__codelineno-182-43"></a><span class="hll"><span class="w">            </span><span class="no">- sensor: !include_dir_merge_list  templates/sensors/</span>
</span></span><span id="__span-182-44"><a id="__codelineno-182-44" name="__codelineno-182-44"></a><span class="hll"><span class="w">          </span><span class="no">influxdb:</span>
</span></span><span id="__span-182-45"><a id="__codelineno-182-45" name="__codelineno-182-45"></a><span class="hll"><span class="w">            </span><span class="no">host: 192.168.0.6</span>
</span></span><span id="__span-182-46"><a id="__codelineno-182-46" name="__codelineno-182-46"></a><span class="hll"><span class="w">            </span><span class="no">port: 30086</span>
</span></span><span id="__span-182-47"><a id="__codelineno-182-47" name="__codelineno-182-47"></a><span class="hll"><span class="w">            </span><span class="no">database: home_assistant</span>
</span></span><span id="__span-182-48"><a id="__codelineno-182-48" name="__codelineno-182-48"></a><span class="hll"><span class="w">            </span><span class="no">username: admin</span>
</span></span><span id="__span-182-49"><a id="__codelineno-182-49" name="__codelineno-182-49"></a><span class="hll"><span class="w">            </span><span class="no">password: MY_PASSWORD</span>
</span></span><span id="__span-182-50"><a id="__codelineno-182-50" name="__codelineno-182-50"></a><span class="hll"><span class="w">            </span><span class="no">max_retries: 3</span>
</span></span><span id="__span-182-51"><a id="__codelineno-182-51" name="__codelineno-182-51"></a><span class="hll"><span class="w">            </span><span class="no">default_measurement: state</span>
</span></span><span id="__span-182-52"><a id="__codelineno-182-52" name="__codelineno-182-52"></a><span class="hll"><span class="w">            </span><span class="no">tags:</span>
</span></span><span id="__span-182-53"><a id="__codelineno-182-53" name="__codelineno-182-53"></a><span class="hll"><span class="w">              </span><span class="no">instance: prod</span>
</span></span><span id="__span-182-54"><a id="__codelineno-182-54" name="__codelineno-182-54"></a><span class="hll"><span class="w">              </span><span class="no">source: hass</span>
</span></span><span id="__span-182-55"><a id="__codelineno-182-55" name="__codelineno-182-55"></a><span class="hll"><span class="w">            </span><span class="no">component_config_glob:</span>
</span></span><span id="__span-182-56"><a id="__codelineno-182-56" name="__codelineno-182-56"></a><span class="hll"><span class="w">              </span><span class="no">sensor.*humidity*:</span>
</span></span><span id="__span-182-57"><a id="__codelineno-182-57" name="__codelineno-182-57"></a><span class="hll"><span class="w">                </span><span class="no">override_measurement: humidity</span>
</span></span><span id="__span-182-58"><a id="__codelineno-182-58" name="__codelineno-182-58"></a><span class="hll"><span class="w">              </span><span class="no">sensor.*temperature*:</span>
</span></span><span id="__span-182-59"><a id="__codelineno-182-59" name="__codelineno-182-59"></a><span class="hll"><span class="w">                </span><span class="no">override_measurement: temperature</span>
</span></span></code></pre></div></td></tr></tbody></table></div>
<h2 id="audiobookshelf">Audiobookshelf</h2>
<p><a href="../../../../../projects/self-hosting/#audiobookshelf">Audiobookshelf</a> running on <code>octavo</code> is
probably the first service I'd miss if it becomes unavailable or unusable, and since
<code>alfred</code> has a <em>roomy</em> 2000 GB NVMe SSD, it can serve as a backup for the main
service. This does not have to be a <em>complete</em> copy of
<a href="../../../04/12/kubernetes-homelab-server-with-ubuntu-server-2404-octavo/#audiobookshelf">Audiobookshelf on <code>octavo</code></a>
but it does need to be kept in sync with it; and this sync must be <em>pausable</em> and
<em>reversable</em> in the event of the main service <em>becoming the secondary</em> service for
an extended period of time.</p>
<p>To test the syncing strategy, Audiobookshelf on <code>alfred</code> will start entirely empty:</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-183-1"><a id="__codelineno-183-1" name="__codelineno-183-1" href="#__codelineno-183-1"></a><span class="gp">$ </span>sudo<span class="w"> </span>groupadd<span class="w"> </span>audiobookshelf<span class="w"> </span>-g<span class="w"> </span><span class="m">117</span>
</span><span id="__span-183-2"><a id="__codelineno-183-2" name="__codelineno-183-2" href="#__codelineno-183-2"></a><span class="gp">$ </span>sudo<span class="w"> </span>useradd<span class="w">  </span>audiobookshelf<span class="w"> </span>-u<span class="w"> </span><span class="m">117</span><span class="w"> </span>-g<span class="w"> </span><span class="m">117</span><span class="w"> </span>-s<span class="w"> </span>/usr/sbin/nologin
</span><span id="__span-183-3"><a id="__codelineno-183-3" name="__codelineno-183-3" href="#__codelineno-183-3"></a><span class="gp">$ </span>sudo<span class="w"> </span>mkdir<span class="w"> </span>/home/k8s/audiobookshelf
</span><span id="__span-183-4"><a id="__codelineno-183-4" name="__codelineno-183-4" href="#__codelineno-183-4"></a><span class="gp">$ </span>sudo<span class="w"> </span>chown<span class="w"> </span>-R<span class="w"> </span>audiobookshelf:audiobookshelf<span class="w"> </span>/home/k8s/audiobookshelf
</span><span id="__span-183-5"><a id="__codelineno-183-5" name="__codelineno-183-5" href="#__codelineno-183-5"></a><span class="gp">$ </span>sudo<span class="w"> </span>ls<span class="w"> </span>-hal<span class="w"> </span>/home/k8s/audiobookshelf
</span><span id="__span-183-6"><a id="__codelineno-183-6" name="__codelineno-183-6" href="#__codelineno-183-6"></a><span class="go">total 8.0K</span>
</span><span id="__span-183-7"><a id="__codelineno-183-7" name="__codelineno-183-7" href="#__codelineno-183-7"></a><span class="go">drwxr-xr-x 2 audiobookshelf audiobookshelf 4.0K May  4 18:25 .</span>
</span><span id="__span-183-8"><a id="__codelineno-183-8" name="__codelineno-183-8" href="#__codelineno-183-8"></a><span class="go">drwxr-xr-x 6 root           root           4.0K May  4 18:25 ..</span>
</span><span id="__span-183-9"><a id="__codelineno-183-9" name="__codelineno-183-9" href="#__codelineno-183-9"></a>
</span><span id="__span-183-10"><a id="__codelineno-183-10" name="__codelineno-183-10" href="#__codelineno-183-10"></a><span class="gp">$ </span>sudo<span class="w"> </span>mkdir<span class="w"> </span>/home/depot
</span><span id="__span-183-11"><a id="__codelineno-183-11" name="__codelineno-183-11" href="#__codelineno-183-11"></a><span class="gp">$ </span>sudo<span class="w"> </span>chown<span class="w"> </span>pi:pi<span class="w"> </span>/home/depot
</span><span id="__span-183-12"><a id="__codelineno-183-12" name="__codelineno-183-12" href="#__codelineno-183-12"></a><span class="gp">$ </span>mkdir<span class="w"> </span>-p<span class="w"> </span>/home/depot/audio/Audiobooks<span class="w"> </span>/home/depot/audio/Podcasts
</span><span id="__span-183-13"><a id="__codelineno-183-13" name="__codelineno-183-13" href="#__codelineno-183-13"></a><span class="gp">$ </span>ls<span class="w"> </span>-hal<span class="w"> </span>/home/depot/audio/
</span><span id="__span-183-14"><a id="__codelineno-183-14" name="__codelineno-183-14" href="#__codelineno-183-14"></a><span class="go">total 16K</span>
</span><span id="__span-183-15"><a id="__codelineno-183-15" name="__codelineno-183-15" href="#__codelineno-183-15"></a><span class="go">drwxr-xr-x 4 pi pi 4.0K May  4 18:32 .</span>
</span><span id="__span-183-16"><a id="__codelineno-183-16" name="__codelineno-183-16" href="#__codelineno-183-16"></a><span class="go">drwxr-xr-x 3 pi pi 4.0K May  4 18:32 ..</span>
</span><span id="__span-183-17"><a id="__codelineno-183-17" name="__codelineno-183-17" href="#__codelineno-183-17"></a><span class="go">drwxr-xr-x 2 pi pi 4.0K May  4 18:32 Audiobooks</span>
</span><span id="__span-183-18"><a id="__codelineno-183-18" name="__codelineno-183-18" href="#__codelineno-183-18"></a><span class="go">drwxr-xr-x 2 pi pi 4.0K May  4 18:32 Podcasts</span>
</span></code></pre></div>
<p>Taking the deployment of
<a href="../../../04/12/kubernetes-homelab-server-with-ubuntu-server-2404-octavo/#audiobookshelf">Audiobookshelf in <code>octavo</code></a>
as the starting point, the deployment for <code>alfred</code> changes only a few details:</p>
<ul>
<li>Change the mounting points for audio files to <code>/home/depot/audio</code> in the local
    filesystem, because the NAS will be too far away from the final destination.</li>
<li>Remove the <code>audiobookshelf-ingress</code> because this system will likely not be
    directly reachable from outside its network on destination, and
    <a href="#cloudflare-tunnel">Cloudflare Tunnel</a> is not suitable for streaming audio.</li>
<li>Add <code>audiobookshelf-ingress-tailscale</code> for access through <a href="#tailscale">Tailscale</a>.<ul>
<li>Add the <code>nginx.ingress.kubernetes.io/websocket-services</code> annotation which is
    required by Audiobookshelf.</li>
</ul>
</li>
</ul>
<details class="k8s">
<summary>Audiobookshelf deployment on <code>alfred</code></summary>
<div class="language-yaml highlight"><span class="filename">alfred/audiobookshelf.yaml</span><pre><span></span><code><span id="__span-184-1"><a id="__codelineno-184-1" name="__codelineno-184-1" href="#__codelineno-184-1"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
</span><span id="__span-184-2"><a id="__codelineno-184-2" name="__codelineno-184-2" href="#__codelineno-184-2"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Namespace</span>
</span><span id="__span-184-3"><a id="__codelineno-184-3" name="__codelineno-184-3" href="#__codelineno-184-3"></a><span class="nt">metadata</span><span class="p">:</span>
</span><span id="__span-184-4"><a id="__codelineno-184-4" name="__codelineno-184-4" href="#__codelineno-184-4"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">audiobookshelf</span>
</span><span id="__span-184-5"><a id="__codelineno-184-5" name="__codelineno-184-5" href="#__codelineno-184-5"></a><span class="nn">---</span>
</span><span id="__span-184-6"><a id="__codelineno-184-6" name="__codelineno-184-6" href="#__codelineno-184-6"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
</span><span id="__span-184-7"><a id="__codelineno-184-7" name="__codelineno-184-7" href="#__codelineno-184-7"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">PersistentVolume</span>
</span><span id="__span-184-8"><a id="__codelineno-184-8" name="__codelineno-184-8" href="#__codelineno-184-8"></a><span class="nt">metadata</span><span class="p">:</span>
</span><span id="__span-184-9"><a id="__codelineno-184-9" name="__codelineno-184-9" href="#__codelineno-184-9"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">audiobookshelf-pv-config</span>
</span><span id="__span-184-10"><a id="__codelineno-184-10" name="__codelineno-184-10" href="#__codelineno-184-10"></a><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">audiobookshelf</span>
</span><span id="__span-184-11"><a id="__codelineno-184-11" name="__codelineno-184-11" href="#__codelineno-184-11"></a><span class="nt">spec</span><span class="p">:</span>
</span><span id="__span-184-12"><a id="__codelineno-184-12" name="__codelineno-184-12" href="#__codelineno-184-12"></a><span class="w">  </span><span class="nt">storageClassName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">manual</span>
</span><span id="__span-184-13"><a id="__codelineno-184-13" name="__codelineno-184-13" href="#__codelineno-184-13"></a><span class="w">  </span><span class="nt">capacity</span><span class="p">:</span>
</span><span id="__span-184-14"><a id="__codelineno-184-14" name="__codelineno-184-14" href="#__codelineno-184-14"></a><span class="w">    </span><span class="nt">storage</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1Gi</span>
</span><span id="__span-184-15"><a id="__codelineno-184-15" name="__codelineno-184-15" href="#__codelineno-184-15"></a><span class="w">  </span><span class="nt">accessModes</span><span class="p">:</span>
</span><span id="__span-184-16"><a id="__codelineno-184-16" name="__codelineno-184-16" href="#__codelineno-184-16"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ReadWriteOnce</span>
</span><span id="__span-184-17"><a id="__codelineno-184-17" name="__codelineno-184-17" href="#__codelineno-184-17"></a><span class="w">  </span><span class="nt">persistentVolumeReclaimPolicy</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Retain</span>
</span><span id="__span-184-18"><a id="__codelineno-184-18" name="__codelineno-184-18" href="#__codelineno-184-18"></a><span class="w">  </span><span class="nt">hostPath</span><span class="p">:</span>
</span><span id="__span-184-19"><a id="__codelineno-184-19" name="__codelineno-184-19" href="#__codelineno-184-19"></a><span class="w">    </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/home/k8s/audiobookshelf/config</span>
</span><span id="__span-184-20"><a id="__codelineno-184-20" name="__codelineno-184-20" href="#__codelineno-184-20"></a><span class="nn">---</span>
</span><span id="__span-184-21"><a id="__codelineno-184-21" name="__codelineno-184-21" href="#__codelineno-184-21"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
</span><span id="__span-184-22"><a id="__codelineno-184-22" name="__codelineno-184-22" href="#__codelineno-184-22"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">PersistentVolume</span>
</span><span id="__span-184-23"><a id="__codelineno-184-23" name="__codelineno-184-23" href="#__codelineno-184-23"></a><span class="nt">metadata</span><span class="p">:</span>
</span><span id="__span-184-24"><a id="__codelineno-184-24" name="__codelineno-184-24" href="#__codelineno-184-24"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">audiobookshelf-pv-metadata</span>
</span><span id="__span-184-25"><a id="__codelineno-184-25" name="__codelineno-184-25" href="#__codelineno-184-25"></a><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">audiobookshelf</span>
</span><span id="__span-184-26"><a id="__codelineno-184-26" name="__codelineno-184-26" href="#__codelineno-184-26"></a><span class="nt">spec</span><span class="p">:</span>
</span><span id="__span-184-27"><a id="__codelineno-184-27" name="__codelineno-184-27" href="#__codelineno-184-27"></a><span class="w">  </span><span class="nt">storageClassName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">manual</span>
</span><span id="__span-184-28"><a id="__codelineno-184-28" name="__codelineno-184-28" href="#__codelineno-184-28"></a><span class="w">  </span><span class="nt">capacity</span><span class="p">:</span>
</span><span id="__span-184-29"><a id="__codelineno-184-29" name="__codelineno-184-29" href="#__codelineno-184-29"></a><span class="w">    </span><span class="nt">storage</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1Gi</span>
</span><span id="__span-184-30"><a id="__codelineno-184-30" name="__codelineno-184-30" href="#__codelineno-184-30"></a><span class="w">  </span><span class="nt">accessModes</span><span class="p">:</span>
</span><span id="__span-184-31"><a id="__codelineno-184-31" name="__codelineno-184-31" href="#__codelineno-184-31"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ReadWriteOnce</span>
</span><span id="__span-184-32"><a id="__codelineno-184-32" name="__codelineno-184-32" href="#__codelineno-184-32"></a><span class="w">  </span><span class="nt">persistentVolumeReclaimPolicy</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Retain</span>
</span><span id="__span-184-33"><a id="__codelineno-184-33" name="__codelineno-184-33" href="#__codelineno-184-33"></a><span class="w">  </span><span class="nt">hostPath</span><span class="p">:</span>
</span><span id="__span-184-34"><a id="__codelineno-184-34" name="__codelineno-184-34" href="#__codelineno-184-34"></a><span class="w">    </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/home/k8s/audiobookshelf/metadata</span>
</span><span id="__span-184-35"><a id="__codelineno-184-35" name="__codelineno-184-35" href="#__codelineno-184-35"></a><span class="nn">---</span>
</span><span id="__span-184-36"><a id="__codelineno-184-36" name="__codelineno-184-36" href="#__codelineno-184-36"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
</span><span id="__span-184-37"><a id="__codelineno-184-37" name="__codelineno-184-37" href="#__codelineno-184-37"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">PersistentVolume</span>
</span><span id="__span-184-38"><a id="__codelineno-184-38" name="__codelineno-184-38" href="#__codelineno-184-38"></a><span class="nt">metadata</span><span class="p">:</span>
</span><span id="__span-184-39"><a id="__codelineno-184-39" name="__codelineno-184-39" href="#__codelineno-184-39"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">audiobookshelf-pv-audiobooks</span>
</span><span id="__span-184-40"><a id="__codelineno-184-40" name="__codelineno-184-40" href="#__codelineno-184-40"></a><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">audiobookshelf</span>
</span><span id="__span-184-41"><a id="__codelineno-184-41" name="__codelineno-184-41" href="#__codelineno-184-41"></a><span class="nt">spec</span><span class="p">:</span>
</span><span id="__span-184-42"><a id="__codelineno-184-42" name="__codelineno-184-42" href="#__codelineno-184-42"></a><span class="w">  </span><span class="nt">storageClassName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">manual</span>
</span><span id="__span-184-43"><a id="__codelineno-184-43" name="__codelineno-184-43" href="#__codelineno-184-43"></a><span class="w">  </span><span class="nt">capacity</span><span class="p">:</span>
</span><span id="__span-184-44"><a id="__codelineno-184-44" name="__codelineno-184-44" href="#__codelineno-184-44"></a><span class="w">    </span><span class="nt">storage</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1Gi</span>
</span><span id="__span-184-45"><a id="__codelineno-184-45" name="__codelineno-184-45" href="#__codelineno-184-45"></a><span class="w">  </span><span class="nt">accessModes</span><span class="p">:</span>
</span><span id="__span-184-46"><a id="__codelineno-184-46" name="__codelineno-184-46" href="#__codelineno-184-46"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ReadWriteOnce</span>
</span><span id="__span-184-47"><a id="__codelineno-184-47" name="__codelineno-184-47" href="#__codelineno-184-47"></a><span class="w">  </span><span class="nt">persistentVolumeReclaimPolicy</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Retain</span>
</span><span id="__span-184-48"><a id="__codelineno-184-48" name="__codelineno-184-48" href="#__codelineno-184-48"></a><span class="w">  </span><span class="nt">hostPath</span><span class="p">:</span>
</span><span id="__span-184-49"><a id="__codelineno-184-49" name="__codelineno-184-49" href="#__codelineno-184-49"></a><span class="w">    </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/home/depot/audio/Audiobooks</span>
</span><span id="__span-184-50"><a id="__codelineno-184-50" name="__codelineno-184-50" href="#__codelineno-184-50"></a><span class="nn">---</span>
</span><span id="__span-184-51"><a id="__codelineno-184-51" name="__codelineno-184-51" href="#__codelineno-184-51"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
</span><span id="__span-184-52"><a id="__codelineno-184-52" name="__codelineno-184-52" href="#__codelineno-184-52"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">PersistentVolume</span>
</span><span id="__span-184-53"><a id="__codelineno-184-53" name="__codelineno-184-53" href="#__codelineno-184-53"></a><span class="nt">metadata</span><span class="p">:</span>
</span><span id="__span-184-54"><a id="__codelineno-184-54" name="__codelineno-184-54" href="#__codelineno-184-54"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">audiobookshelf-pv-podcasts</span>
</span><span id="__span-184-55"><a id="__codelineno-184-55" name="__codelineno-184-55" href="#__codelineno-184-55"></a><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">audiobookshelf</span>
</span><span id="__span-184-56"><a id="__codelineno-184-56" name="__codelineno-184-56" href="#__codelineno-184-56"></a><span class="nt">spec</span><span class="p">:</span>
</span><span id="__span-184-57"><a id="__codelineno-184-57" name="__codelineno-184-57" href="#__codelineno-184-57"></a><span class="w">  </span><span class="nt">storageClassName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">manual</span>
</span><span id="__span-184-58"><a id="__codelineno-184-58" name="__codelineno-184-58" href="#__codelineno-184-58"></a><span class="w">  </span><span class="nt">capacity</span><span class="p">:</span>
</span><span id="__span-184-59"><a id="__codelineno-184-59" name="__codelineno-184-59" href="#__codelineno-184-59"></a><span class="w">    </span><span class="nt">storage</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1Gi</span>
</span><span id="__span-184-60"><a id="__codelineno-184-60" name="__codelineno-184-60" href="#__codelineno-184-60"></a><span class="w">  </span><span class="nt">accessModes</span><span class="p">:</span>
</span><span id="__span-184-61"><a id="__codelineno-184-61" name="__codelineno-184-61" href="#__codelineno-184-61"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ReadWriteOnce</span>
</span><span id="__span-184-62"><a id="__codelineno-184-62" name="__codelineno-184-62" href="#__codelineno-184-62"></a><span class="w">  </span><span class="nt">persistentVolumeReclaimPolicy</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Retain</span>
</span><span id="__span-184-63"><a id="__codelineno-184-63" name="__codelineno-184-63" href="#__codelineno-184-63"></a><span class="w">  </span><span class="nt">hostPath</span><span class="p">:</span>
</span><span id="__span-184-64"><a id="__codelineno-184-64" name="__codelineno-184-64" href="#__codelineno-184-64"></a><span class="w">    </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/home/depot/audio/Podcasts</span>
</span><span id="__span-184-65"><a id="__codelineno-184-65" name="__codelineno-184-65" href="#__codelineno-184-65"></a><span class="nn">---</span>
</span><span id="__span-184-66"><a id="__codelineno-184-66" name="__codelineno-184-66" href="#__codelineno-184-66"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
</span><span id="__span-184-67"><a id="__codelineno-184-67" name="__codelineno-184-67" href="#__codelineno-184-67"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">PersistentVolume</span>
</span><span id="__span-184-68"><a id="__codelineno-184-68" name="__codelineno-184-68" href="#__codelineno-184-68"></a><span class="nt">metadata</span><span class="p">:</span>
</span><span id="__span-184-69"><a id="__codelineno-184-69" name="__codelineno-184-69" href="#__codelineno-184-69"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">audiobookshelf-pv-depot-podcasts</span>
</span><span id="__span-184-70"><a id="__codelineno-184-70" name="__codelineno-184-70" href="#__codelineno-184-70"></a><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">audiobookshelf</span>
</span><span id="__span-184-71"><a id="__codelineno-184-71" name="__codelineno-184-71" href="#__codelineno-184-71"></a><span class="nt">spec</span><span class="p">:</span>
</span><span id="__span-184-72"><a id="__codelineno-184-72" name="__codelineno-184-72" href="#__codelineno-184-72"></a><span class="w">  </span><span class="nt">storageClassName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">manual</span>
</span><span id="__span-184-73"><a id="__codelineno-184-73" name="__codelineno-184-73" href="#__codelineno-184-73"></a><span class="w">  </span><span class="nt">capacity</span><span class="p">:</span>
</span><span id="__span-184-74"><a id="__codelineno-184-74" name="__codelineno-184-74" href="#__codelineno-184-74"></a><span class="w">    </span><span class="nt">storage</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1Gi</span>
</span><span id="__span-184-75"><a id="__codelineno-184-75" name="__codelineno-184-75" href="#__codelineno-184-75"></a><span class="w">  </span><span class="nt">accessModes</span><span class="p">:</span>
</span><span id="__span-184-76"><a id="__codelineno-184-76" name="__codelineno-184-76" href="#__codelineno-184-76"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ReadWriteOnce</span>
</span><span id="__span-184-77"><a id="__codelineno-184-77" name="__codelineno-184-77" href="#__codelineno-184-77"></a><span class="w">  </span><span class="nt">persistentVolumeReclaimPolicy</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Retain</span>
</span><span id="__span-184-78"><a id="__codelineno-184-78" name="__codelineno-184-78" href="#__codelineno-184-78"></a><span class="w">  </span><span class="nt">hostPath</span><span class="p">:</span>
</span><span id="__span-184-79"><a id="__codelineno-184-79" name="__codelineno-184-79" href="#__codelineno-184-79"></a><span class="w">    </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/home/depot/audio/Podcasts</span>
</span><span id="__span-184-80"><a id="__codelineno-184-80" name="__codelineno-184-80" href="#__codelineno-184-80"></a><span class="nn">---</span>
</span><span id="__span-184-81"><a id="__codelineno-184-81" name="__codelineno-184-81" href="#__codelineno-184-81"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
</span><span id="__span-184-82"><a id="__codelineno-184-82" name="__codelineno-184-82" href="#__codelineno-184-82"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">PersistentVolumeClaim</span>
</span><span id="__span-184-83"><a id="__codelineno-184-83" name="__codelineno-184-83" href="#__codelineno-184-83"></a><span class="nt">metadata</span><span class="p">:</span>
</span><span id="__span-184-84"><a id="__codelineno-184-84" name="__codelineno-184-84" href="#__codelineno-184-84"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">audiobookshelf-pvc-config</span>
</span><span id="__span-184-85"><a id="__codelineno-184-85" name="__codelineno-184-85" href="#__codelineno-184-85"></a><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">audiobookshelf</span>
</span><span id="__span-184-86"><a id="__codelineno-184-86" name="__codelineno-184-86" href="#__codelineno-184-86"></a><span class="nt">spec</span><span class="p">:</span>
</span><span id="__span-184-87"><a id="__codelineno-184-87" name="__codelineno-184-87" href="#__codelineno-184-87"></a><span class="w">  </span><span class="nt">storageClassName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">manual</span>
</span><span id="__span-184-88"><a id="__codelineno-184-88" name="__codelineno-184-88" href="#__codelineno-184-88"></a><span class="w">  </span><span class="nt">volumeName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">audiobookshelf-pv-config</span>
</span><span id="__span-184-89"><a id="__codelineno-184-89" name="__codelineno-184-89" href="#__codelineno-184-89"></a><span class="w">  </span><span class="nt">accessModes</span><span class="p">:</span>
</span><span id="__span-184-90"><a id="__codelineno-184-90" name="__codelineno-184-90" href="#__codelineno-184-90"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ReadWriteOnce</span>
</span><span id="__span-184-91"><a id="__codelineno-184-91" name="__codelineno-184-91" href="#__codelineno-184-91"></a><span class="w">  </span><span class="nt">volumeMode</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Filesystem</span>
</span><span id="__span-184-92"><a id="__codelineno-184-92" name="__codelineno-184-92" href="#__codelineno-184-92"></a><span class="w">  </span><span class="nt">resources</span><span class="p">:</span>
</span><span id="__span-184-93"><a id="__codelineno-184-93" name="__codelineno-184-93" href="#__codelineno-184-93"></a><span class="w">    </span><span class="nt">requests</span><span class="p">:</span>
</span><span id="__span-184-94"><a id="__codelineno-184-94" name="__codelineno-184-94" href="#__codelineno-184-94"></a><span class="w">      </span><span class="nt">storage</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1Gi</span>
</span><span id="__span-184-95"><a id="__codelineno-184-95" name="__codelineno-184-95" href="#__codelineno-184-95"></a><span class="nn">---</span>
</span><span id="__span-184-96"><a id="__codelineno-184-96" name="__codelineno-184-96" href="#__codelineno-184-96"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
</span><span id="__span-184-97"><a id="__codelineno-184-97" name="__codelineno-184-97" href="#__codelineno-184-97"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">PersistentVolumeClaim</span>
</span><span id="__span-184-98"><a id="__codelineno-184-98" name="__codelineno-184-98" href="#__codelineno-184-98"></a><span class="nt">metadata</span><span class="p">:</span>
</span><span id="__span-184-99"><a id="__codelineno-184-99" name="__codelineno-184-99" href="#__codelineno-184-99"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">audiobookshelf-pvc-metadata</span>
</span><span id="__span-184-100"><a id="__codelineno-184-100" name="__codelineno-184-100" href="#__codelineno-184-100"></a><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">audiobookshelf</span>
</span><span id="__span-184-101"><a id="__codelineno-184-101" name="__codelineno-184-101" href="#__codelineno-184-101"></a><span class="nt">spec</span><span class="p">:</span>
</span><span id="__span-184-102"><a id="__codelineno-184-102" name="__codelineno-184-102" href="#__codelineno-184-102"></a><span class="w">  </span><span class="nt">storageClassName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">manual</span>
</span><span id="__span-184-103"><a id="__codelineno-184-103" name="__codelineno-184-103" href="#__codelineno-184-103"></a><span class="w">  </span><span class="nt">volumeName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">audiobookshelf-pv-metadata</span>
</span><span id="__span-184-104"><a id="__codelineno-184-104" name="__codelineno-184-104" href="#__codelineno-184-104"></a><span class="w">  </span><span class="nt">accessModes</span><span class="p">:</span>
</span><span id="__span-184-105"><a id="__codelineno-184-105" name="__codelineno-184-105" href="#__codelineno-184-105"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ReadWriteOnce</span>
</span><span id="__span-184-106"><a id="__codelineno-184-106" name="__codelineno-184-106" href="#__codelineno-184-106"></a><span class="w">  </span><span class="nt">volumeMode</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Filesystem</span>
</span><span id="__span-184-107"><a id="__codelineno-184-107" name="__codelineno-184-107" href="#__codelineno-184-107"></a><span class="w">  </span><span class="nt">resources</span><span class="p">:</span>
</span><span id="__span-184-108"><a id="__codelineno-184-108" name="__codelineno-184-108" href="#__codelineno-184-108"></a><span class="w">    </span><span class="nt">requests</span><span class="p">:</span>
</span><span id="__span-184-109"><a id="__codelineno-184-109" name="__codelineno-184-109" href="#__codelineno-184-109"></a><span class="w">      </span><span class="nt">storage</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1Gi</span>
</span><span id="__span-184-110"><a id="__codelineno-184-110" name="__codelineno-184-110" href="#__codelineno-184-110"></a><span class="nn">---</span>
</span><span id="__span-184-111"><a id="__codelineno-184-111" name="__codelineno-184-111" href="#__codelineno-184-111"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
</span><span id="__span-184-112"><a id="__codelineno-184-112" name="__codelineno-184-112" href="#__codelineno-184-112"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">PersistentVolumeClaim</span>
</span><span id="__span-184-113"><a id="__codelineno-184-113" name="__codelineno-184-113" href="#__codelineno-184-113"></a><span class="nt">metadata</span><span class="p">:</span>
</span><span id="__span-184-114"><a id="__codelineno-184-114" name="__codelineno-184-114" href="#__codelineno-184-114"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">audiobookshelf-pvc-audiobooks</span>
</span><span id="__span-184-115"><a id="__codelineno-184-115" name="__codelineno-184-115" href="#__codelineno-184-115"></a><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">audiobookshelf</span>
</span><span id="__span-184-116"><a id="__codelineno-184-116" name="__codelineno-184-116" href="#__codelineno-184-116"></a><span class="nt">spec</span><span class="p">:</span>
</span><span id="__span-184-117"><a id="__codelineno-184-117" name="__codelineno-184-117" href="#__codelineno-184-117"></a><span class="w">  </span><span class="nt">storageClassName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">manual</span>
</span><span id="__span-184-118"><a id="__codelineno-184-118" name="__codelineno-184-118" href="#__codelineno-184-118"></a><span class="w">  </span><span class="nt">volumeName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">audiobookshelf-pv-audiobooks</span>
</span><span id="__span-184-119"><a id="__codelineno-184-119" name="__codelineno-184-119" href="#__codelineno-184-119"></a><span class="w">  </span><span class="nt">accessModes</span><span class="p">:</span>
</span><span id="__span-184-120"><a id="__codelineno-184-120" name="__codelineno-184-120" href="#__codelineno-184-120"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ReadWriteOnce</span>
</span><span id="__span-184-121"><a id="__codelineno-184-121" name="__codelineno-184-121" href="#__codelineno-184-121"></a><span class="w">  </span><span class="nt">volumeMode</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Filesystem</span>
</span><span id="__span-184-122"><a id="__codelineno-184-122" name="__codelineno-184-122" href="#__codelineno-184-122"></a><span class="w">  </span><span class="nt">resources</span><span class="p">:</span>
</span><span id="__span-184-123"><a id="__codelineno-184-123" name="__codelineno-184-123" href="#__codelineno-184-123"></a><span class="w">    </span><span class="nt">requests</span><span class="p">:</span>
</span><span id="__span-184-124"><a id="__codelineno-184-124" name="__codelineno-184-124" href="#__codelineno-184-124"></a><span class="w">      </span><span class="nt">storage</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1Gi</span>
</span><span id="__span-184-125"><a id="__codelineno-184-125" name="__codelineno-184-125" href="#__codelineno-184-125"></a><span class="nn">---</span>
</span><span id="__span-184-126"><a id="__codelineno-184-126" name="__codelineno-184-126" href="#__codelineno-184-126"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
</span><span id="__span-184-127"><a id="__codelineno-184-127" name="__codelineno-184-127" href="#__codelineno-184-127"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">PersistentVolumeClaim</span>
</span><span id="__span-184-128"><a id="__codelineno-184-128" name="__codelineno-184-128" href="#__codelineno-184-128"></a><span class="nt">metadata</span><span class="p">:</span>
</span><span id="__span-184-129"><a id="__codelineno-184-129" name="__codelineno-184-129" href="#__codelineno-184-129"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">audiobookshelf-pvc-podcasts</span>
</span><span id="__span-184-130"><a id="__codelineno-184-130" name="__codelineno-184-130" href="#__codelineno-184-130"></a><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">audiobookshelf</span>
</span><span id="__span-184-131"><a id="__codelineno-184-131" name="__codelineno-184-131" href="#__codelineno-184-131"></a><span class="nt">spec</span><span class="p">:</span>
</span><span id="__span-184-132"><a id="__codelineno-184-132" name="__codelineno-184-132" href="#__codelineno-184-132"></a><span class="w">  </span><span class="nt">storageClassName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">manual</span>
</span><span id="__span-184-133"><a id="__codelineno-184-133" name="__codelineno-184-133" href="#__codelineno-184-133"></a><span class="w">  </span><span class="nt">volumeName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">audiobookshelf-pv-podcasts</span>
</span><span id="__span-184-134"><a id="__codelineno-184-134" name="__codelineno-184-134" href="#__codelineno-184-134"></a><span class="w">  </span><span class="nt">accessModes</span><span class="p">:</span>
</span><span id="__span-184-135"><a id="__codelineno-184-135" name="__codelineno-184-135" href="#__codelineno-184-135"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ReadWriteOnce</span>
</span><span id="__span-184-136"><a id="__codelineno-184-136" name="__codelineno-184-136" href="#__codelineno-184-136"></a><span class="w">  </span><span class="nt">volumeMode</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Filesystem</span>
</span><span id="__span-184-137"><a id="__codelineno-184-137" name="__codelineno-184-137" href="#__codelineno-184-137"></a><span class="w">  </span><span class="nt">resources</span><span class="p">:</span>
</span><span id="__span-184-138"><a id="__codelineno-184-138" name="__codelineno-184-138" href="#__codelineno-184-138"></a><span class="w">    </span><span class="nt">requests</span><span class="p">:</span>
</span><span id="__span-184-139"><a id="__codelineno-184-139" name="__codelineno-184-139" href="#__codelineno-184-139"></a><span class="w">      </span><span class="nt">storage</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1Gi</span>
</span><span id="__span-184-140"><a id="__codelineno-184-140" name="__codelineno-184-140" href="#__codelineno-184-140"></a><span class="nn">---</span>
</span><span id="__span-184-141"><a id="__codelineno-184-141" name="__codelineno-184-141" href="#__codelineno-184-141"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
</span><span id="__span-184-142"><a id="__codelineno-184-142" name="__codelineno-184-142" href="#__codelineno-184-142"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">PersistentVolumeClaim</span>
</span><span id="__span-184-143"><a id="__codelineno-184-143" name="__codelineno-184-143" href="#__codelineno-184-143"></a><span class="nt">metadata</span><span class="p">:</span>
</span><span id="__span-184-144"><a id="__codelineno-184-144" name="__codelineno-184-144" href="#__codelineno-184-144"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">audiobookshelf-pvc-depot-podcasts</span>
</span><span id="__span-184-145"><a id="__codelineno-184-145" name="__codelineno-184-145" href="#__codelineno-184-145"></a><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">audiobookshelf</span>
</span><span id="__span-184-146"><a id="__codelineno-184-146" name="__codelineno-184-146" href="#__codelineno-184-146"></a><span class="nt">spec</span><span class="p">:</span>
</span><span id="__span-184-147"><a id="__codelineno-184-147" name="__codelineno-184-147" href="#__codelineno-184-147"></a><span class="w">  </span><span class="nt">storageClassName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">manual</span>
</span><span id="__span-184-148"><a id="__codelineno-184-148" name="__codelineno-184-148" href="#__codelineno-184-148"></a><span class="w">  </span><span class="nt">volumeName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">audiobookshelf-pv-depot-podcasts</span>
</span><span id="__span-184-149"><a id="__codelineno-184-149" name="__codelineno-184-149" href="#__codelineno-184-149"></a><span class="w">  </span><span class="nt">accessModes</span><span class="p">:</span>
</span><span id="__span-184-150"><a id="__codelineno-184-150" name="__codelineno-184-150" href="#__codelineno-184-150"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ReadWriteOnce</span>
</span><span id="__span-184-151"><a id="__codelineno-184-151" name="__codelineno-184-151" href="#__codelineno-184-151"></a><span class="w">  </span><span class="nt">volumeMode</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Filesystem</span>
</span><span id="__span-184-152"><a id="__codelineno-184-152" name="__codelineno-184-152" href="#__codelineno-184-152"></a><span class="w">  </span><span class="nt">resources</span><span class="p">:</span>
</span><span id="__span-184-153"><a id="__codelineno-184-153" name="__codelineno-184-153" href="#__codelineno-184-153"></a><span class="w">    </span><span class="nt">requests</span><span class="p">:</span>
</span><span id="__span-184-154"><a id="__codelineno-184-154" name="__codelineno-184-154" href="#__codelineno-184-154"></a><span class="w">      </span><span class="nt">storage</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1Gi</span>
</span><span id="__span-184-155"><a id="__codelineno-184-155" name="__codelineno-184-155" href="#__codelineno-184-155"></a><span class="nn">---</span>
</span><span id="__span-184-156"><a id="__codelineno-184-156" name="__codelineno-184-156" href="#__codelineno-184-156"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">apps/v1</span>
</span><span id="__span-184-157"><a id="__codelineno-184-157" name="__codelineno-184-157" href="#__codelineno-184-157"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Deployment</span>
</span><span id="__span-184-158"><a id="__codelineno-184-158" name="__codelineno-184-158" href="#__codelineno-184-158"></a><span class="nt">metadata</span><span class="p">:</span>
</span><span id="__span-184-159"><a id="__codelineno-184-159" name="__codelineno-184-159" href="#__codelineno-184-159"></a><span class="w">  </span><span class="nt">labels</span><span class="p">:</span>
</span><span id="__span-184-160"><a id="__codelineno-184-160" name="__codelineno-184-160" href="#__codelineno-184-160"></a><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">audiobookshelf</span>
</span><span id="__span-184-161"><a id="__codelineno-184-161" name="__codelineno-184-161" href="#__codelineno-184-161"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">audiobookshelf</span>
</span><span id="__span-184-162"><a id="__codelineno-184-162" name="__codelineno-184-162" href="#__codelineno-184-162"></a><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">audiobookshelf</span>
</span><span id="__span-184-163"><a id="__codelineno-184-163" name="__codelineno-184-163" href="#__codelineno-184-163"></a><span class="nt">spec</span><span class="p">:</span>
</span><span id="__span-184-164"><a id="__codelineno-184-164" name="__codelineno-184-164" href="#__codelineno-184-164"></a><span class="w">  </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1</span>
</span><span id="__span-184-165"><a id="__codelineno-184-165" name="__codelineno-184-165" href="#__codelineno-184-165"></a><span class="w">  </span><span class="nt">revisionHistoryLimit</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0</span>
</span><span id="__span-184-166"><a id="__codelineno-184-166" name="__codelineno-184-166" href="#__codelineno-184-166"></a><span class="w">  </span><span class="nt">selector</span><span class="p">:</span>
</span><span id="__span-184-167"><a id="__codelineno-184-167" name="__codelineno-184-167" href="#__codelineno-184-167"></a><span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span>
</span><span id="__span-184-168"><a id="__codelineno-184-168" name="__codelineno-184-168" href="#__codelineno-184-168"></a><span class="w">      </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">audiobookshelf</span>
</span><span id="__span-184-169"><a id="__codelineno-184-169" name="__codelineno-184-169" href="#__codelineno-184-169"></a><span class="w">  </span><span class="nt">strategy</span><span class="p">:</span>
</span><span id="__span-184-170"><a id="__codelineno-184-170" name="__codelineno-184-170" href="#__codelineno-184-170"></a><span class="w">    </span><span class="nt">rollingUpdate</span><span class="p">:</span>
</span><span id="__span-184-171"><a id="__codelineno-184-171" name="__codelineno-184-171" href="#__codelineno-184-171"></a><span class="w">      </span><span class="nt">maxSurge</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0</span>
</span><span id="__span-184-172"><a id="__codelineno-184-172" name="__codelineno-184-172" href="#__codelineno-184-172"></a><span class="w">      </span><span class="nt">maxUnavailable</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1</span>
</span><span id="__span-184-173"><a id="__codelineno-184-173" name="__codelineno-184-173" href="#__codelineno-184-173"></a><span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">RollingUpdate</span>
</span><span id="__span-184-174"><a id="__codelineno-184-174" name="__codelineno-184-174" href="#__codelineno-184-174"></a><span class="w">  </span><span class="nt">template</span><span class="p">:</span>
</span><span id="__span-184-175"><a id="__codelineno-184-175" name="__codelineno-184-175" href="#__codelineno-184-175"></a><span class="w">    </span><span class="nt">metadata</span><span class="p">:</span>
</span><span id="__span-184-176"><a id="__codelineno-184-176" name="__codelineno-184-176" href="#__codelineno-184-176"></a><span class="w">      </span><span class="nt">labels</span><span class="p">:</span>
</span><span id="__span-184-177"><a id="__codelineno-184-177" name="__codelineno-184-177" href="#__codelineno-184-177"></a><span class="w">        </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">audiobookshelf</span>
</span><span id="__span-184-178"><a id="__codelineno-184-178" name="__codelineno-184-178" href="#__codelineno-184-178"></a><span class="w">    </span><span class="nt">spec</span><span class="p">:</span>
</span><span id="__span-184-179"><a id="__codelineno-184-179" name="__codelineno-184-179" href="#__codelineno-184-179"></a><span class="w">      </span><span class="nt">containers</span><span class="p">:</span>
</span><span id="__span-184-180"><a id="__codelineno-184-180" name="__codelineno-184-180" href="#__codelineno-184-180"></a><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ghcr.io/advplyr/audiobookshelf:latest</span>
</span><span id="__span-184-181"><a id="__codelineno-184-181" name="__codelineno-184-181" href="#__codelineno-184-181"></a><span class="w">          </span><span class="nt">imagePullPolicy</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Always</span>
</span><span id="__span-184-182"><a id="__codelineno-184-182" name="__codelineno-184-182" href="#__codelineno-184-182"></a><span class="w">          </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">audiobookshelf</span>
</span><span id="__span-184-183"><a id="__codelineno-184-183" name="__codelineno-184-183" href="#__codelineno-184-183"></a><span class="w">          </span><span class="nt">env</span><span class="p">:</span>
</span><span id="__span-184-184"><a id="__codelineno-184-184" name="__codelineno-184-184" href="#__codelineno-184-184"></a><span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">PORT</span>
</span><span id="__span-184-185"><a id="__codelineno-184-185" name="__codelineno-184-185" href="#__codelineno-184-185"></a><span class="w">            </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="s">"13378"</span>
</span><span id="__span-184-186"><a id="__codelineno-184-186" name="__codelineno-184-186" href="#__codelineno-184-186"></a><span class="w">          </span><span class="nt">ports</span><span class="p">:</span>
</span><span id="__span-184-187"><a id="__codelineno-184-187" name="__codelineno-184-187" href="#__codelineno-184-187"></a><span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">containerPort</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">13378</span>
</span><span id="__span-184-188"><a id="__codelineno-184-188" name="__codelineno-184-188" href="#__codelineno-184-188"></a><span class="w">          </span><span class="nt">resources</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{}</span>
</span><span id="__span-184-189"><a id="__codelineno-184-189" name="__codelineno-184-189" href="#__codelineno-184-189"></a><span class="w">          </span><span class="nt">stdin</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
</span><span id="__span-184-190"><a id="__codelineno-184-190" name="__codelineno-184-190" href="#__codelineno-184-190"></a><span class="w">          </span><span class="nt">tty</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
</span><span id="__span-184-191"><a id="__codelineno-184-191" name="__codelineno-184-191" href="#__codelineno-184-191"></a><span class="w">          </span><span class="nt">volumeMounts</span><span class="p">:</span>
</span><span id="__span-184-192"><a id="__codelineno-184-192" name="__codelineno-184-192" href="#__codelineno-184-192"></a><span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">mountPath</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/config</span>
</span><span id="__span-184-193"><a id="__codelineno-184-193" name="__codelineno-184-193" href="#__codelineno-184-193"></a><span class="w">            </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">audiobookshelf-config</span>
</span><span id="__span-184-194"><a id="__codelineno-184-194" name="__codelineno-184-194" href="#__codelineno-184-194"></a><span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">mountPath</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/metadata</span>
</span><span id="__span-184-195"><a id="__codelineno-184-195" name="__codelineno-184-195" href="#__codelineno-184-195"></a><span class="w">            </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">audiobookshelf-metadata</span>
</span><span id="__span-184-196"><a id="__codelineno-184-196" name="__codelineno-184-196" href="#__codelineno-184-196"></a><span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">mountPath</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/audiobooks</span>
</span><span id="__span-184-197"><a id="__codelineno-184-197" name="__codelineno-184-197" href="#__codelineno-184-197"></a><span class="w">            </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">audiobookshelf-audiobooks</span>
</span><span id="__span-184-198"><a id="__codelineno-184-198" name="__codelineno-184-198" href="#__codelineno-184-198"></a><span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">mountPath</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/podcasts</span>
</span><span id="__span-184-199"><a id="__codelineno-184-199" name="__codelineno-184-199" href="#__codelineno-184-199"></a><span class="w">            </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">audiobookshelf-podcasts</span>
</span><span id="__span-184-200"><a id="__codelineno-184-200" name="__codelineno-184-200" href="#__codelineno-184-200"></a><span class="w">          </span><span class="nt">securityContext</span><span class="p">:</span>
</span><span id="__span-184-201"><a id="__codelineno-184-201" name="__codelineno-184-201" href="#__codelineno-184-201"></a><span class="w">            </span><span class="nt">allowPrivilegeEscalation</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">false</span>
</span><span id="__span-184-202"><a id="__codelineno-184-202" name="__codelineno-184-202" href="#__codelineno-184-202"></a><span class="w">            </span><span class="nt">runAsUser</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">117</span>
</span><span id="__span-184-203"><a id="__codelineno-184-203" name="__codelineno-184-203" href="#__codelineno-184-203"></a><span class="w">            </span><span class="nt">runAsGroup</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">117</span>
</span><span id="__span-184-204"><a id="__codelineno-184-204" name="__codelineno-184-204" href="#__codelineno-184-204"></a><span class="w">      </span><span class="nt">restartPolicy</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Always</span>
</span><span id="__span-184-205"><a id="__codelineno-184-205" name="__codelineno-184-205" href="#__codelineno-184-205"></a><span class="w">      </span><span class="nt">volumes</span><span class="p">:</span>
</span><span id="__span-184-206"><a id="__codelineno-184-206" name="__codelineno-184-206" href="#__codelineno-184-206"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">audiobookshelf-config</span>
</span><span id="__span-184-207"><a id="__codelineno-184-207" name="__codelineno-184-207" href="#__codelineno-184-207"></a><span class="w">        </span><span class="nt">persistentVolumeClaim</span><span class="p">:</span>
</span><span id="__span-184-208"><a id="__codelineno-184-208" name="__codelineno-184-208" href="#__codelineno-184-208"></a><span class="w">          </span><span class="nt">claimName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">audiobookshelf-pvc-config</span>
</span><span id="__span-184-209"><a id="__codelineno-184-209" name="__codelineno-184-209" href="#__codelineno-184-209"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">audiobookshelf-metadata</span>
</span><span id="__span-184-210"><a id="__codelineno-184-210" name="__codelineno-184-210" href="#__codelineno-184-210"></a><span class="w">        </span><span class="nt">persistentVolumeClaim</span><span class="p">:</span>
</span><span id="__span-184-211"><a id="__codelineno-184-211" name="__codelineno-184-211" href="#__codelineno-184-211"></a><span class="w">          </span><span class="nt">claimName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">audiobookshelf-pvc-metadata</span>
</span><span id="__span-184-212"><a id="__codelineno-184-212" name="__codelineno-184-212" href="#__codelineno-184-212"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">audiobookshelf-audiobooks</span>
</span><span id="__span-184-213"><a id="__codelineno-184-213" name="__codelineno-184-213" href="#__codelineno-184-213"></a><span class="w">        </span><span class="nt">persistentVolumeClaim</span><span class="p">:</span>
</span><span id="__span-184-214"><a id="__codelineno-184-214" name="__codelineno-184-214" href="#__codelineno-184-214"></a><span class="w">          </span><span class="nt">claimName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">audiobookshelf-pvc-audiobooks</span>
</span><span id="__span-184-215"><a id="__codelineno-184-215" name="__codelineno-184-215" href="#__codelineno-184-215"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">audiobookshelf-podcasts</span>
</span><span id="__span-184-216"><a id="__codelineno-184-216" name="__codelineno-184-216" href="#__codelineno-184-216"></a><span class="w">        </span><span class="nt">persistentVolumeClaim</span><span class="p">:</span>
</span><span id="__span-184-217"><a id="__codelineno-184-217" name="__codelineno-184-217" href="#__codelineno-184-217"></a><span class="w">          </span><span class="nt">claimName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">audiobookshelf-pvc-depot-podcasts</span>
</span><span id="__span-184-218"><a id="__codelineno-184-218" name="__codelineno-184-218" href="#__codelineno-184-218"></a><span class="nn">---</span>
</span><span id="__span-184-219"><a id="__codelineno-184-219" name="__codelineno-184-219" href="#__codelineno-184-219"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Service</span>
</span><span id="__span-184-220"><a id="__codelineno-184-220" name="__codelineno-184-220" href="#__codelineno-184-220"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
</span><span id="__span-184-221"><a id="__codelineno-184-221" name="__codelineno-184-221" href="#__codelineno-184-221"></a><span class="nt">metadata</span><span class="p">:</span>
</span><span id="__span-184-222"><a id="__codelineno-184-222" name="__codelineno-184-222" href="#__codelineno-184-222"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">audiobookshelf-svc</span>
</span><span id="__span-184-223"><a id="__codelineno-184-223" name="__codelineno-184-223" href="#__codelineno-184-223"></a><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">audiobookshelf</span>
</span><span id="__span-184-224"><a id="__codelineno-184-224" name="__codelineno-184-224" href="#__codelineno-184-224"></a><span class="nt">spec</span><span class="p">:</span>
</span><span id="__span-184-225"><a id="__codelineno-184-225" name="__codelineno-184-225" href="#__codelineno-184-225"></a><span class="w">  </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">NodePort</span>
</span><span id="__span-184-226"><a id="__codelineno-184-226" name="__codelineno-184-226" href="#__codelineno-184-226"></a><span class="w">  </span><span class="nt">ports</span><span class="p">:</span>
</span><span id="__span-184-227"><a id="__codelineno-184-227" name="__codelineno-184-227" href="#__codelineno-184-227"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">13388</span>
</span><span id="__span-184-228"><a id="__codelineno-184-228" name="__codelineno-184-228" href="#__codelineno-184-228"></a><span class="w">    </span><span class="nt">nodePort</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">31378</span>
</span><span id="__span-184-229"><a id="__codelineno-184-229" name="__codelineno-184-229" href="#__codelineno-184-229"></a><span class="w">    </span><span class="nt">targetPort</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">13378</span>
</span><span id="__span-184-230"><a id="__codelineno-184-230" name="__codelineno-184-230" href="#__codelineno-184-230"></a><span class="w">  </span><span class="nt">selector</span><span class="p">:</span>
</span><span id="__span-184-231"><a id="__codelineno-184-231" name="__codelineno-184-231" href="#__codelineno-184-231"></a><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">audiobookshelf</span>
</span><span id="__span-184-232"><a id="__codelineno-184-232" name="__codelineno-184-232" href="#__codelineno-184-232"></a><span class="nn">---</span>
</span><span id="__span-184-233"><a id="__codelineno-184-233" name="__codelineno-184-233" href="#__codelineno-184-233"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">networking.k8s.io/v1</span>
</span><span id="__span-184-234"><a id="__codelineno-184-234" name="__codelineno-184-234" href="#__codelineno-184-234"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Ingress</span>
</span><span id="__span-184-235"><a id="__codelineno-184-235" name="__codelineno-184-235" href="#__codelineno-184-235"></a><span class="nt">metadata</span><span class="p">:</span>
</span><span id="__span-184-236"><a id="__codelineno-184-236" name="__codelineno-184-236" href="#__codelineno-184-236"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">audiobookshelf-ingress-tailscale</span>
</span><span id="__span-184-237"><a id="__codelineno-184-237" name="__codelineno-184-237" href="#__codelineno-184-237"></a><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">audiobookshelf</span>
</span><span id="__span-184-238"><a id="__codelineno-184-238" name="__codelineno-184-238" href="#__codelineno-184-238"></a><span class="w">  </span><span class="nt">annotations</span><span class="p">:</span>
</span><span id="__span-184-239"><a id="__codelineno-184-239" name="__codelineno-184-239" href="#__codelineno-184-239"></a><span class="w">    </span><span class="nt">nginx.ingress.kubernetes.io/websocket-services</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">audiobookshelf-svc</span>
</span><span id="__span-184-240"><a id="__codelineno-184-240" name="__codelineno-184-240" href="#__codelineno-184-240"></a><span class="nt">spec</span><span class="p">:</span>
</span><span id="__span-184-241"><a id="__codelineno-184-241" name="__codelineno-184-241" href="#__codelineno-184-241"></a><span class="w">  </span><span class="nt">ingressClassName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">tailscale</span>
</span><span id="__span-184-242"><a id="__codelineno-184-242" name="__codelineno-184-242" href="#__codelineno-184-242"></a><span class="w">  </span><span class="nt">defaultBackend</span><span class="p">:</span>
</span><span id="__span-184-243"><a id="__codelineno-184-243" name="__codelineno-184-243" href="#__codelineno-184-243"></a><span class="w">    </span><span class="nt">service</span><span class="p">:</span>
</span><span id="__span-184-244"><a id="__codelineno-184-244" name="__codelineno-184-244" href="#__codelineno-184-244"></a><span class="w">      </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">audiobookshelf-svc</span>
</span><span id="__span-184-245"><a id="__codelineno-184-245" name="__codelineno-184-245" href="#__codelineno-184-245"></a><span class="w">      </span><span class="nt">port</span><span class="p">:</span>
</span><span id="__span-184-246"><a id="__codelineno-184-246" name="__codelineno-184-246" href="#__codelineno-184-246"></a><span class="w">        </span><span class="nt">number</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">13378</span>
</span><span id="__span-184-247"><a id="__codelineno-184-247" name="__codelineno-184-247" href="#__codelineno-184-247"></a><span class="w">  </span><span class="nt">tls</span><span class="p">:</span>
</span><span id="__span-184-248"><a id="__codelineno-184-248" name="__codelineno-184-248" href="#__codelineno-184-248"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">hosts</span><span class="p">:</span>
</span><span id="__span-184-249"><a id="__codelineno-184-249" name="__codelineno-184-249" href="#__codelineno-184-249"></a><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">audiobookshelf-alfred</span>
</span></code></pre></div>
</details>
<p>The apply the new deployment to start InfluxDB and Grafana:</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-185-1"><a id="__codelineno-185-1" name="__codelineno-185-1" href="#__codelineno-185-1"></a><span class="gp">$ </span>kubectl<span class="w"> </span>apply<span class="w"> </span>-f<span class="w"> </span>alfred/audiobookshelf.yaml
</span><span id="__span-185-2"><a id="__codelineno-185-2" name="__codelineno-185-2" href="#__codelineno-185-2"></a><span class="go">namespace/audiobookshelf created</span>
</span><span id="__span-185-3"><a id="__codelineno-185-3" name="__codelineno-185-3" href="#__codelineno-185-3"></a><span class="go">persistentvolume/audiobookshelf-pv-config created</span>
</span><span id="__span-185-4"><a id="__codelineno-185-4" name="__codelineno-185-4" href="#__codelineno-185-4"></a><span class="go">persistentvolume/audiobookshelf-pv-metadata created</span>
</span><span id="__span-185-5"><a id="__codelineno-185-5" name="__codelineno-185-5" href="#__codelineno-185-5"></a><span class="go">persistentvolume/audiobookshelf-pv-audiobooks created</span>
</span><span id="__span-185-6"><a id="__codelineno-185-6" name="__codelineno-185-6" href="#__codelineno-185-6"></a><span class="go">persistentvolume/audiobookshelf-pv-podcasts created</span>
</span><span id="__span-185-7"><a id="__codelineno-185-7" name="__codelineno-185-7" href="#__codelineno-185-7"></a><span class="go">persistentvolume/audiobookshelf-pv-depot-podcasts created</span>
</span><span id="__span-185-8"><a id="__codelineno-185-8" name="__codelineno-185-8" href="#__codelineno-185-8"></a><span class="go">persistentvolumeclaim/audiobookshelf-pvc-config created</span>
</span><span id="__span-185-9"><a id="__codelineno-185-9" name="__codelineno-185-9" href="#__codelineno-185-9"></a><span class="go">persistentvolumeclaim/audiobookshelf-pvc-metadata created</span>
</span><span id="__span-185-10"><a id="__codelineno-185-10" name="__codelineno-185-10" href="#__codelineno-185-10"></a><span class="go">persistentvolumeclaim/audiobookshelf-pvc-audiobooks created</span>
</span><span id="__span-185-11"><a id="__codelineno-185-11" name="__codelineno-185-11" href="#__codelineno-185-11"></a><span class="go">persistentvolumeclaim/audiobookshelf-pvc-podcasts created</span>
</span><span id="__span-185-12"><a id="__codelineno-185-12" name="__codelineno-185-12" href="#__codelineno-185-12"></a><span class="go">persistentvolumeclaim/audiobookshelf-pvc-depot-podcasts created</span>
</span><span id="__span-185-13"><a id="__codelineno-185-13" name="__codelineno-185-13" href="#__codelineno-185-13"></a><span class="go">deployment.apps/audiobookshelf created</span>
</span><span id="__span-185-14"><a id="__codelineno-185-14" name="__codelineno-185-14" href="#__codelineno-185-14"></a><span class="go">service/audiobookshelf-svc created</span>
</span><span id="__span-185-15"><a id="__codelineno-185-15" name="__codelineno-185-15" href="#__codelineno-185-15"></a><span class="go">ingress.networking.k8s.io/audiobookshelf-ingress-tailscale created</span>
</span><span id="__span-185-16"><a id="__codelineno-185-16" name="__codelineno-185-16" href="#__codelineno-185-16"></a>
</span><span id="__span-185-17"><a id="__codelineno-185-17" name="__codelineno-185-17" href="#__codelineno-185-17"></a><span class="gp">$ </span>kubectl<span class="w"> </span>get<span class="w"> </span>all<span class="w"> </span>-n<span class="w"> </span>audiobookshelf
</span><span id="__span-185-18"><a id="__codelineno-185-18" name="__codelineno-185-18" href="#__codelineno-185-18"></a><span class="go">NAME                                 READY   STATUS    RESTARTS   AGE</span>
</span><span id="__span-185-19"><a id="__codelineno-185-19" name="__codelineno-185-19" href="#__codelineno-185-19"></a><span class="go">pod/audiobookshelf-b49c49757-74rv5   1/1     Running   0          46s</span>
</span><span id="__span-185-20"><a id="__codelineno-185-20" name="__codelineno-185-20" href="#__codelineno-185-20"></a>
</span><span id="__span-185-21"><a id="__codelineno-185-21" name="__codelineno-185-21" href="#__codelineno-185-21"></a><span class="go">NAME                         TYPE       CLUSTER-IP       EXTERNAL-IP   PORT(S)           AGE</span>
</span><span id="__span-185-22"><a id="__codelineno-185-22" name="__codelineno-185-22" href="#__codelineno-185-22"></a><span class="go">service/audiobookshelf-svc   NodePort   10.108.207.194   &lt;none&gt;        13388:31378/TCP   46s</span>
</span><span id="__span-185-23"><a id="__codelineno-185-23" name="__codelineno-185-23" href="#__codelineno-185-23"></a>
</span><span id="__span-185-24"><a id="__codelineno-185-24" name="__codelineno-185-24" href="#__codelineno-185-24"></a><span class="go">NAME                             READY   UP-TO-DATE   AVAILABLE   AGE</span>
</span><span id="__span-185-25"><a id="__codelineno-185-25" name="__codelineno-185-25" href="#__codelineno-185-25"></a><span class="go">deployment.apps/audiobookshelf   1/1     1            1           46s</span>
</span><span id="__span-185-26"><a id="__codelineno-185-26" name="__codelineno-185-26" href="#__codelineno-185-26"></a>
</span><span id="__span-185-27"><a id="__codelineno-185-27" name="__codelineno-185-27" href="#__codelineno-185-27"></a><span class="go">NAME                                       DESIRED   CURRENT   READY   AGE</span>
</span><span id="__span-185-28"><a id="__codelineno-185-28" name="__codelineno-185-28" href="#__codelineno-185-28"></a><span class="go">replicaset.apps/audiobookshelf-b49c49757   1         1         1       46s</span>
</span><span id="__span-185-29"><a id="__codelineno-185-29" name="__codelineno-185-29" href="#__codelineno-185-29"></a>
</span><span id="__span-185-30"><a id="__codelineno-185-30" name="__codelineno-185-30" href="#__codelineno-185-30"></a><span class="gp">$ </span>kubectl<span class="w"> </span>get<span class="w"> </span>ingress<span class="w"> </span>-n<span class="w"> </span>audiobookshelf
</span><span id="__span-185-31"><a id="__codelineno-185-31" name="__codelineno-185-31" href="#__codelineno-185-31"></a><span class="go">NAME                               CLASS       HOSTS   ADDRESS                                    PORTS     AGE</span>
</span><span id="__span-185-32"><a id="__codelineno-185-32" name="__codelineno-185-32" href="#__codelineno-185-32"></a><span class="go">audiobookshelf-ingress-tailscale   tailscale   *       audiobookshelf-alfred.royal-penny.ts.net   80, 443   52s</span>
</span></code></pre></div>
<p>After nearly a minute the service is running, but the web UI is not yet available
because somehow the process is having access denied to its own files:</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-186-1"><a id="__codelineno-186-1" name="__codelineno-186-1" href="#__codelineno-186-1"></a><span class="gp">$ </span>klogs<span class="w"> </span>audiobookshelf<span class="w"> </span>audiobookshelf
</span><span id="__span-186-2"><a id="__codelineno-186-2" name="__codelineno-186-2" href="#__codelineno-186-2"></a><span class="go">[2025-05-04 17:10:17.354] FATAL: [Server] Unhandled rejection: [Error: EACCES: permission denied, mkdir '/metadata/logs'] {</span>
</span><span id="__span-186-3"><a id="__codelineno-186-3" name="__codelineno-186-3" href="#__codelineno-186-3"></a><span class="go">  errno: -13,</span>
</span><span id="__span-186-4"><a id="__codelineno-186-4" name="__codelineno-186-4" href="#__codelineno-186-4"></a><span class="go">  code: 'EACCES',</span>
</span><span id="__span-186-5"><a id="__codelineno-186-5" name="__codelineno-186-5" href="#__codelineno-186-5"></a><span class="go">  syscall: 'mkdir',</span>
</span><span id="__span-186-6"><a id="__codelineno-186-6" name="__codelineno-186-6" href="#__codelineno-186-6"></a><span class="go">  path: '/metadata/logs'</span>
</span><span id="__span-186-7"><a id="__codelineno-186-7" name="__codelineno-186-7" href="#__codelineno-186-7"></a><span class="go">} </span>
</span><span id="__span-186-8"><a id="__codelineno-186-8" name="__codelineno-186-8" href="#__codelineno-186-8"></a><span class="go">promise: Promise {</span>
</span><span id="__span-186-9"><a id="__codelineno-186-9" name="__codelineno-186-9" href="#__codelineno-186-9"></a><span class="go">  &lt;rejected&gt; [Error: EACCES: permission denied, mkdir '/metadata/logs'] {</span>
</span><span id="__span-186-10"><a id="__codelineno-186-10" name="__codelineno-186-10" href="#__codelineno-186-10"></a><span class="go">    errno: -13,</span>
</span><span id="__span-186-11"><a id="__codelineno-186-11" name="__codelineno-186-11" href="#__codelineno-186-11"></a><span class="go">    code: 'EACCES',</span>
</span><span id="__span-186-12"><a id="__codelineno-186-12" name="__codelineno-186-12" href="#__codelineno-186-12"></a><span class="go">    syscall: 'mkdir',</span>
</span><span id="__span-186-13"><a id="__codelineno-186-13" name="__codelineno-186-13" href="#__codelineno-186-13"></a><span class="go">    path: '/metadata/logs'</span>
</span><span id="__span-186-14"><a id="__codelineno-186-14" name="__codelineno-186-14" href="#__codelineno-186-14"></a><span class="go">  }</span>
</span><span id="__span-186-15"><a id="__codelineno-186-15" name="__codelineno-186-15" href="#__codelineno-186-15"></a><span class="go">}</span>
</span></code></pre></div>
<p>This error repeats at a very high rate and the directory is indeed empty,
because somehow the directories have been <em>claimed</em> by <code>root</code> and need to be
<em>re-claimed</em> by <code>audiobookshelf</code>:</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-187-1"><a id="__codelineno-187-1" name="__codelineno-187-1" href="#__codelineno-187-1"></a><span class="gp">$ </span>sudo<span class="w"> </span>ls<span class="w"> </span>-lad<span class="w"> </span>/home/k8s/audiobookshelf/*
</span><span id="__span-187-2"><a id="__codelineno-187-2" name="__codelineno-187-2" href="#__codelineno-187-2"></a><span class="go">drwxr-xr-x  6 root root 4096 May  4 19:11 /home/k8s/audiobookshelf/config</span>
</span><span id="__span-187-3"><a id="__codelineno-187-3" name="__codelineno-187-3" href="#__codelineno-187-3"></a><span class="go">drwxr-xr-x  2 root root 4096 May  4 19:11 /home/k8s/audiobookshelf/metadata</span>
</span><span id="__span-187-4"><a id="__codelineno-187-4" name="__codelineno-187-4" href="#__codelineno-187-4"></a>
</span><span id="__span-187-5"><a id="__codelineno-187-5" name="__codelineno-187-5" href="#__codelineno-187-5"></a><span class="gp">$ </span>sudo<span class="w"> </span>chown<span class="w"> </span>-R<span class="w"> </span>audiobookshelf:audiobookshelf<span class="w"> </span>/home/k8s/audiobookshelf/
</span><span id="__span-187-6"><a id="__codelineno-187-6" name="__codelineno-187-6" href="#__codelineno-187-6"></a><span class="gp">$ </span>sudo<span class="w"> </span>ls<span class="w"> </span>-lad<span class="w"> </span>/home/k8s/audiobookshelf/*
</span><span id="__span-187-7"><a id="__codelineno-187-7" name="__codelineno-187-7" href="#__codelineno-187-7"></a><span class="go">drwxr-xr-x 3 audiobookshelf audiobookshelf 4096 May  4 19:11 /home/k8s/audiobookshelf/config</span>
</span><span id="__span-187-8"><a id="__codelineno-187-8" name="__codelineno-187-8" href="#__codelineno-187-8"></a><span class="go">drwxr-xr-x 6 audiobookshelf audiobookshelf 4096 May  4 19:11 /home/k8s/audiobookshelf/metadata</span>
</span></code></pre></div>
<p>After some more time, because Tailscale DNS need time to propagate, it becomes
available at <a href="https://audiobookshelf-alfred.royal-penny.ts.net">https://audiobookshelf-alfred.royal-penny.ts.net</a>, but it will be
empty because it has not yet been <em>synced</em> with <code>octavo</code>.</p>
<h3 id="audiobookshelf-sync-scripts">Audiobookshelf sync scripts</h3>
<p>To keep alfred in sync with octavo, the trick is to copy <code>/home/k8s/audiobookshelf</code>
over while the service is not running; so long as the <code>config/absdatabase.sqlite</code>
database is copied over, Audiobookshelf on <code>alfred</code> will mirror exactly the status
in <code>octavo</code>.</p>
<details class="code">
<summary>Sync script: Audiobookshelf and audio from <code>octavo</code></summary>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-188-1"><a id="__codelineno-188-1" name="__codelineno-188-1" href="#__codelineno-188-1"></a><span class="ch">#!/bin/bash</span>
</span><span id="__span-188-2"><a id="__codelineno-188-2" name="__codelineno-188-2" href="#__codelineno-188-2"></a><span class="c1">#</span>
</span><span id="__span-188-3"><a id="__codelineno-188-3" name="__codelineno-188-3" href="#__codelineno-188-3"></a><span class="c1"># Sync specific directories from /home/nas (NAS) to /home/depot (NVMe).</span>
</span><span id="__span-188-4"><a id="__codelineno-188-4" name="__codelineno-188-4" href="#__codelineno-188-4"></a>
</span><span id="__span-188-5"><a id="__codelineno-188-5" name="__codelineno-188-5" href="#__codelineno-188-5"></a><span class="c1"># Audiobooks: active (authors).</span>
</span><span id="__span-188-6"><a id="__codelineno-188-6" name="__codelineno-188-6" href="#__codelineno-188-6"></a><span class="k">for</span><span class="w"> </span>d<span class="w"> </span><span class="k">in</span><span class="w"> </span>Andy.Weir<span class="w"> </span>Carl.Sagan<span class="w"> </span>Douglas.Adams<span class="w"> </span>James.S.A.Corey<span class="w"> </span>Terry.Pratchett<span class="p">;</span><span class="w"> </span><span class="k">do</span>
</span><span id="__span-188-7"><a id="__codelineno-188-7" name="__codelineno-188-7" href="#__codelineno-188-7"></a><span class="w">  </span>rsync<span class="w"> </span>-ua<span class="w"> </span><span class="se">\</span>
</span><span id="__span-188-8"><a id="__codelineno-188-8" name="__codelineno-188-8" href="#__codelineno-188-8"></a><span class="w">    </span>root@octavo.royal-penny.ts.net:/home/nas/public/audio/Audiobooks/<span class="nv">$d</span><span class="w"> </span><span class="se">\</span>
</span><span id="__span-188-9"><a id="__codelineno-188-9" name="__codelineno-188-9" href="#__codelineno-188-9"></a><span class="w">    </span>/home/depot/audio/Audiobooks
</span><span id="__span-188-10"><a id="__codelineno-188-10" name="__codelineno-188-10" href="#__codelineno-188-10"></a><span class="k">done</span>
</span><span id="__span-188-11"><a id="__codelineno-188-11" name="__codelineno-188-11" href="#__codelineno-188-11"></a>
</span><span id="__span-188-12"><a id="__codelineno-188-12" name="__codelineno-188-12" href="#__codelineno-188-12"></a><span class="c1"># Podcasts: active.</span>
</span><span id="__span-188-13"><a id="__codelineno-188-13" name="__codelineno-188-13" href="#__codelineno-188-13"></a><span class="k">for</span><span class="w"> </span>d<span class="w"> </span><span class="k">in</span><span class="w"> </span>Linux.Matters<span class="w"> </span>Making.It<span class="w"> </span>Nextlander<span class="p">;</span><span class="w"> </span><span class="k">do</span>
</span><span id="__span-188-14"><a id="__codelineno-188-14" name="__codelineno-188-14" href="#__codelineno-188-14"></a><span class="w">  </span>rsync<span class="w"> </span>-ua<span class="w"> </span><span class="se">\</span>
</span><span id="__span-188-15"><a id="__codelineno-188-15" name="__codelineno-188-15" href="#__codelineno-188-15"></a><span class="w">    </span>root@octavo.royal-penny.ts.net:/home/depot/audio/Podcasts/<span class="nv">$d</span><span class="w"> </span><span class="se">\</span>
</span><span id="__span-188-16"><a id="__codelineno-188-16" name="__codelineno-188-16" href="#__codelineno-188-16"></a><span class="w">    </span>/home/depot/audio/Podcasts/
</span><span id="__span-188-17"><a id="__codelineno-188-17" name="__codelineno-188-17" href="#__codelineno-188-17"></a><span class="k">done</span>
</span><span id="__span-188-18"><a id="__codelineno-188-18" name="__codelineno-188-18" href="#__codelineno-188-18"></a>
</span><span id="__span-188-19"><a id="__codelineno-188-19" name="__codelineno-188-19" href="#__codelineno-188-19"></a><span class="c1"># Audiobookshelf: stop, sync, start.</span>
</span><span id="__span-188-20"><a id="__codelineno-188-20" name="__codelineno-188-20" href="#__codelineno-188-20"></a>kubectl<span class="w"> </span>scale<span class="w"> </span>-n<span class="w"> </span>audiobookshelf<span class="w"> </span>deployment<span class="w"> </span>audiobookshelf<span class="w"> </span>--replicas<span class="o">=</span><span class="m">0</span>
</span><span id="__span-188-21"><a id="__codelineno-188-21" name="__codelineno-188-21" href="#__codelineno-188-21"></a>sleep<span class="w"> </span><span class="m">20</span>
</span><span id="__span-188-22"><a id="__codelineno-188-22" name="__codelineno-188-22" href="#__codelineno-188-22"></a>sudo<span class="w"> </span>rsync<span class="w"> </span>-ua<span class="w"> </span>--del<span class="w"> </span><span class="se">\</span>
</span><span id="__span-188-23"><a id="__codelineno-188-23" name="__codelineno-188-23" href="#__codelineno-188-23"></a><span class="w">  </span>root@octavo.royal-penny.ts.net:/home/k8s/audiobookshelf/*<span class="w"> </span><span class="se">\</span>
</span><span id="__span-188-24"><a id="__codelineno-188-24" name="__codelineno-188-24" href="#__codelineno-188-24"></a><span class="w">  </span>/home/k8s/audiobookshelf/
</span><span id="__span-188-25"><a id="__codelineno-188-25" name="__codelineno-188-25" href="#__codelineno-188-25"></a>kubectl<span class="w"> </span>scale<span class="w"> </span>-n<span class="w"> </span>audiobookshelf<span class="w"> </span>deployment<span class="w"> </span>audiobookshelf<span class="w"> </span>--replicas<span class="o">=</span><span class="m">1</span>
</span></code></pre></div>
</details>
<p>Running this hourly should provide a good mirror.</p>
<h2 id="navidrome">Navidrome</h2>
<p><a href="../../../../../projects/self-hosting/#navidrome">Navidrome</a> would be missed too, should it
become unavailable. Following the same method as above, taking the deployment of
<a href="../../../04/12/kubernetes-homelab-server-with-ubuntu-server-2404-octavo/#navidrome">Navidrome in <code>octavo</code></a>
as the starting point, the deployment for <code>alfred</code> changes about the same details
as with <a href="#audiobookshelf">Audiobookshelf</a>:</p>
<ul>
<li>Change the mounting points for audio files to <code>/home/depot/audio</code> in the local
    filesystem, because the NAS will be too far away from the final destination.</li>
<li>Remove the <code>navidrome-ingress</code> because this system will likely not be
    directly reachable from outside its network on destination, and
    <a href="#cloudflare-tunnel">Cloudflare Tunnel</a> is not suitable for streaming.</li>
<li>Add <code>navidrome-ingress-tailscale</code> for access through <a href="#tailscale">Tailscale</a>.</li>
<li>Modify the <code>ND_BASEURL</code> variable to reflect the expected FQND from Tailscale.</li>
</ul>
<details class="k8s">
<summary>Navidrome deployment on <code>alfred</code></summary>
<div class="language-yaml highlight"><span class="filename">alfred/navidrome.yaml</span><pre><span></span><code><span id="__span-189-1"><a id="__codelineno-189-1" name="__codelineno-189-1" href="#__codelineno-189-1"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
</span><span id="__span-189-2"><a id="__codelineno-189-2" name="__codelineno-189-2" href="#__codelineno-189-2"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Namespace</span>
</span><span id="__span-189-3"><a id="__codelineno-189-3" name="__codelineno-189-3" href="#__codelineno-189-3"></a><span class="nt">metadata</span><span class="p">:</span>
</span><span id="__span-189-4"><a id="__codelineno-189-4" name="__codelineno-189-4" href="#__codelineno-189-4"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">navidrome</span>
</span><span id="__span-189-5"><a id="__codelineno-189-5" name="__codelineno-189-5" href="#__codelineno-189-5"></a><span class="nn">---</span>
</span><span id="__span-189-6"><a id="__codelineno-189-6" name="__codelineno-189-6" href="#__codelineno-189-6"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
</span><span id="__span-189-7"><a id="__codelineno-189-7" name="__codelineno-189-7" href="#__codelineno-189-7"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">PersistentVolume</span>
</span><span id="__span-189-8"><a id="__codelineno-189-8" name="__codelineno-189-8" href="#__codelineno-189-8"></a><span class="nt">metadata</span><span class="p">:</span>
</span><span id="__span-189-9"><a id="__codelineno-189-9" name="__codelineno-189-9" href="#__codelineno-189-9"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">navidrome-pv-data</span>
</span><span id="__span-189-10"><a id="__codelineno-189-10" name="__codelineno-189-10" href="#__codelineno-189-10"></a><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">navidrome</span>
</span><span id="__span-189-11"><a id="__codelineno-189-11" name="__codelineno-189-11" href="#__codelineno-189-11"></a><span class="nt">spec</span><span class="p">:</span>
</span><span id="__span-189-12"><a id="__codelineno-189-12" name="__codelineno-189-12" href="#__codelineno-189-12"></a><span class="w">  </span><span class="nt">storageClassName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">manual</span>
</span><span id="__span-189-13"><a id="__codelineno-189-13" name="__codelineno-189-13" href="#__codelineno-189-13"></a><span class="w">  </span><span class="nt">capacity</span><span class="p">:</span>
</span><span id="__span-189-14"><a id="__codelineno-189-14" name="__codelineno-189-14" href="#__codelineno-189-14"></a><span class="w">    </span><span class="nt">storage</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1Gi</span>
</span><span id="__span-189-15"><a id="__codelineno-189-15" name="__codelineno-189-15" href="#__codelineno-189-15"></a><span class="w">  </span><span class="nt">accessModes</span><span class="p">:</span>
</span><span id="__span-189-16"><a id="__codelineno-189-16" name="__codelineno-189-16" href="#__codelineno-189-16"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ReadWriteOnce</span>
</span><span id="__span-189-17"><a id="__codelineno-189-17" name="__codelineno-189-17" href="#__codelineno-189-17"></a><span class="w">  </span><span class="nt">persistentVolumeReclaimPolicy</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Retain</span>
</span><span id="__span-189-18"><a id="__codelineno-189-18" name="__codelineno-189-18" href="#__codelineno-189-18"></a><span class="w">  </span><span class="nt">hostPath</span><span class="p">:</span>
</span><span id="__span-189-19"><a id="__codelineno-189-19" name="__codelineno-189-19" href="#__codelineno-189-19"></a><span class="w">    </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/home/k8s/navidrome</span>
</span><span id="__span-189-20"><a id="__codelineno-189-20" name="__codelineno-189-20" href="#__codelineno-189-20"></a><span class="nn">---</span>
</span><span id="__span-189-21"><a id="__codelineno-189-21" name="__codelineno-189-21" href="#__codelineno-189-21"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
</span><span id="__span-189-22"><a id="__codelineno-189-22" name="__codelineno-189-22" href="#__codelineno-189-22"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">PersistentVolume</span>
</span><span id="__span-189-23"><a id="__codelineno-189-23" name="__codelineno-189-23" href="#__codelineno-189-23"></a><span class="nt">metadata</span><span class="p">:</span>
</span><span id="__span-189-24"><a id="__codelineno-189-24" name="__codelineno-189-24" href="#__codelineno-189-24"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">navidrome-pv-music</span>
</span><span id="__span-189-25"><a id="__codelineno-189-25" name="__codelineno-189-25" href="#__codelineno-189-25"></a><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">navidrome</span>
</span><span id="__span-189-26"><a id="__codelineno-189-26" name="__codelineno-189-26" href="#__codelineno-189-26"></a><span class="nt">spec</span><span class="p">:</span>
</span><span id="__span-189-27"><a id="__codelineno-189-27" name="__codelineno-189-27" href="#__codelineno-189-27"></a><span class="w">  </span><span class="nt">storageClassName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">manual</span>
</span><span id="__span-189-28"><a id="__codelineno-189-28" name="__codelineno-189-28" href="#__codelineno-189-28"></a><span class="w">  </span><span class="nt">capacity</span><span class="p">:</span>
</span><span id="__span-189-29"><a id="__codelineno-189-29" name="__codelineno-189-29" href="#__codelineno-189-29"></a><span class="w">    </span><span class="nt">storage</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">100Gi</span>
</span><span id="__span-189-30"><a id="__codelineno-189-30" name="__codelineno-189-30" href="#__codelineno-189-30"></a><span class="w">  </span><span class="nt">accessModes</span><span class="p">:</span>
</span><span id="__span-189-31"><a id="__codelineno-189-31" name="__codelineno-189-31" href="#__codelineno-189-31"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ReadWriteOnce</span>
</span><span id="__span-189-32"><a id="__codelineno-189-32" name="__codelineno-189-32" href="#__codelineno-189-32"></a><span class="w">  </span><span class="nt">persistentVolumeReclaimPolicy</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Retain</span>
</span><span id="__span-189-33"><a id="__codelineno-189-33" name="__codelineno-189-33" href="#__codelineno-189-33"></a><span class="w">  </span><span class="nt">hostPath</span><span class="p">:</span>
</span><span id="__span-189-34"><a id="__codelineno-189-34" name="__codelineno-189-34" href="#__codelineno-189-34"></a><span class="w">    </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/home/depot/audio/Music</span>
</span><span id="__span-189-35"><a id="__codelineno-189-35" name="__codelineno-189-35" href="#__codelineno-189-35"></a><span class="nn">---</span>
</span><span id="__span-189-36"><a id="__codelineno-189-36" name="__codelineno-189-36" href="#__codelineno-189-36"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
</span><span id="__span-189-37"><a id="__codelineno-189-37" name="__codelineno-189-37" href="#__codelineno-189-37"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">PersistentVolumeClaim</span>
</span><span id="__span-189-38"><a id="__codelineno-189-38" name="__codelineno-189-38" href="#__codelineno-189-38"></a><span class="nt">metadata</span><span class="p">:</span>
</span><span id="__span-189-39"><a id="__codelineno-189-39" name="__codelineno-189-39" href="#__codelineno-189-39"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">navidrome-pvc-data</span>
</span><span id="__span-189-40"><a id="__codelineno-189-40" name="__codelineno-189-40" href="#__codelineno-189-40"></a><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">navidrome</span>
</span><span id="__span-189-41"><a id="__codelineno-189-41" name="__codelineno-189-41" href="#__codelineno-189-41"></a><span class="nt">spec</span><span class="p">:</span>
</span><span id="__span-189-42"><a id="__codelineno-189-42" name="__codelineno-189-42" href="#__codelineno-189-42"></a><span class="w">  </span><span class="nt">storageClassName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">manual</span>
</span><span id="__span-189-43"><a id="__codelineno-189-43" name="__codelineno-189-43" href="#__codelineno-189-43"></a><span class="w">  </span><span class="nt">volumeName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">navidrome-pv-data</span>
</span><span id="__span-189-44"><a id="__codelineno-189-44" name="__codelineno-189-44" href="#__codelineno-189-44"></a><span class="w">  </span><span class="nt">accessModes</span><span class="p">:</span>
</span><span id="__span-189-45"><a id="__codelineno-189-45" name="__codelineno-189-45" href="#__codelineno-189-45"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ReadWriteOnce</span>
</span><span id="__span-189-46"><a id="__codelineno-189-46" name="__codelineno-189-46" href="#__codelineno-189-46"></a><span class="w">  </span><span class="nt">volumeMode</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Filesystem</span>
</span><span id="__span-189-47"><a id="__codelineno-189-47" name="__codelineno-189-47" href="#__codelineno-189-47"></a><span class="w">  </span><span class="nt">resources</span><span class="p">:</span>
</span><span id="__span-189-48"><a id="__codelineno-189-48" name="__codelineno-189-48" href="#__codelineno-189-48"></a><span class="w">    </span><span class="nt">requests</span><span class="p">:</span>
</span><span id="__span-189-49"><a id="__codelineno-189-49" name="__codelineno-189-49" href="#__codelineno-189-49"></a><span class="w">      </span><span class="nt">storage</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1Gi</span>
</span><span id="__span-189-50"><a id="__codelineno-189-50" name="__codelineno-189-50" href="#__codelineno-189-50"></a><span class="nn">---</span>
</span><span id="__span-189-51"><a id="__codelineno-189-51" name="__codelineno-189-51" href="#__codelineno-189-51"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
</span><span id="__span-189-52"><a id="__codelineno-189-52" name="__codelineno-189-52" href="#__codelineno-189-52"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">PersistentVolumeClaim</span>
</span><span id="__span-189-53"><a id="__codelineno-189-53" name="__codelineno-189-53" href="#__codelineno-189-53"></a><span class="nt">metadata</span><span class="p">:</span>
</span><span id="__span-189-54"><a id="__codelineno-189-54" name="__codelineno-189-54" href="#__codelineno-189-54"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">navidrome-pvc-music</span>
</span><span id="__span-189-55"><a id="__codelineno-189-55" name="__codelineno-189-55" href="#__codelineno-189-55"></a><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">navidrome</span>
</span><span id="__span-189-56"><a id="__codelineno-189-56" name="__codelineno-189-56" href="#__codelineno-189-56"></a><span class="nt">spec</span><span class="p">:</span>
</span><span id="__span-189-57"><a id="__codelineno-189-57" name="__codelineno-189-57" href="#__codelineno-189-57"></a><span class="w">  </span><span class="nt">storageClassName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">manual</span>
</span><span id="__span-189-58"><a id="__codelineno-189-58" name="__codelineno-189-58" href="#__codelineno-189-58"></a><span class="w">  </span><span class="nt">volumeName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">navidrome-pv-music</span>
</span><span id="__span-189-59"><a id="__codelineno-189-59" name="__codelineno-189-59" href="#__codelineno-189-59"></a><span class="w">  </span><span class="nt">accessModes</span><span class="p">:</span>
</span><span id="__span-189-60"><a id="__codelineno-189-60" name="__codelineno-189-60" href="#__codelineno-189-60"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ReadWriteOnce</span>
</span><span id="__span-189-61"><a id="__codelineno-189-61" name="__codelineno-189-61" href="#__codelineno-189-61"></a><span class="w">  </span><span class="nt">volumeMode</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Filesystem</span>
</span><span id="__span-189-62"><a id="__codelineno-189-62" name="__codelineno-189-62" href="#__codelineno-189-62"></a><span class="w">  </span><span class="nt">resources</span><span class="p">:</span>
</span><span id="__span-189-63"><a id="__codelineno-189-63" name="__codelineno-189-63" href="#__codelineno-189-63"></a><span class="w">    </span><span class="nt">requests</span><span class="p">:</span>
</span><span id="__span-189-64"><a id="__codelineno-189-64" name="__codelineno-189-64" href="#__codelineno-189-64"></a><span class="w">      </span><span class="nt">storage</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1Gi</span>
</span><span id="__span-189-65"><a id="__codelineno-189-65" name="__codelineno-189-65" href="#__codelineno-189-65"></a><span class="nn">---</span>
</span><span id="__span-189-66"><a id="__codelineno-189-66" name="__codelineno-189-66" href="#__codelineno-189-66"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">apps/v1</span>
</span><span id="__span-189-67"><a id="__codelineno-189-67" name="__codelineno-189-67" href="#__codelineno-189-67"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Deployment</span>
</span><span id="__span-189-68"><a id="__codelineno-189-68" name="__codelineno-189-68" href="#__codelineno-189-68"></a><span class="nt">metadata</span><span class="p">:</span>
</span><span id="__span-189-69"><a id="__codelineno-189-69" name="__codelineno-189-69" href="#__codelineno-189-69"></a><span class="w">  </span><span class="nt">labels</span><span class="p">:</span>
</span><span id="__span-189-70"><a id="__codelineno-189-70" name="__codelineno-189-70" href="#__codelineno-189-70"></a><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">navidrome</span>
</span><span id="__span-189-71"><a id="__codelineno-189-71" name="__codelineno-189-71" href="#__codelineno-189-71"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">navidrome</span>
</span><span id="__span-189-72"><a id="__codelineno-189-72" name="__codelineno-189-72" href="#__codelineno-189-72"></a><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">navidrome</span>
</span><span id="__span-189-73"><a id="__codelineno-189-73" name="__codelineno-189-73" href="#__codelineno-189-73"></a><span class="nt">spec</span><span class="p">:</span>
</span><span id="__span-189-74"><a id="__codelineno-189-74" name="__codelineno-189-74" href="#__codelineno-189-74"></a><span class="w">  </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1</span>
</span><span id="__span-189-75"><a id="__codelineno-189-75" name="__codelineno-189-75" href="#__codelineno-189-75"></a><span class="w">  </span><span class="nt">revisionHistoryLimit</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0</span>
</span><span id="__span-189-76"><a id="__codelineno-189-76" name="__codelineno-189-76" href="#__codelineno-189-76"></a><span class="w">  </span><span class="nt">selector</span><span class="p">:</span>
</span><span id="__span-189-77"><a id="__codelineno-189-77" name="__codelineno-189-77" href="#__codelineno-189-77"></a><span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span>
</span><span id="__span-189-78"><a id="__codelineno-189-78" name="__codelineno-189-78" href="#__codelineno-189-78"></a><span class="w">      </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">navidrome</span>
</span><span id="__span-189-79"><a id="__codelineno-189-79" name="__codelineno-189-79" href="#__codelineno-189-79"></a><span class="w">  </span><span class="nt">strategy</span><span class="p">:</span>
</span><span id="__span-189-80"><a id="__codelineno-189-80" name="__codelineno-189-80" href="#__codelineno-189-80"></a><span class="w">    </span><span class="nt">rollingUpdate</span><span class="p">:</span>
</span><span id="__span-189-81"><a id="__codelineno-189-81" name="__codelineno-189-81" href="#__codelineno-189-81"></a><span class="w">      </span><span class="nt">maxSurge</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0</span>
</span><span id="__span-189-82"><a id="__codelineno-189-82" name="__codelineno-189-82" href="#__codelineno-189-82"></a><span class="w">      </span><span class="nt">maxUnavailable</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1</span>
</span><span id="__span-189-83"><a id="__codelineno-189-83" name="__codelineno-189-83" href="#__codelineno-189-83"></a><span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">RollingUpdate</span>
</span><span id="__span-189-84"><a id="__codelineno-189-84" name="__codelineno-189-84" href="#__codelineno-189-84"></a><span class="w">  </span><span class="nt">template</span><span class="p">:</span>
</span><span id="__span-189-85"><a id="__codelineno-189-85" name="__codelineno-189-85" href="#__codelineno-189-85"></a><span class="w">    </span><span class="nt">metadata</span><span class="p">:</span>
</span><span id="__span-189-86"><a id="__codelineno-189-86" name="__codelineno-189-86" href="#__codelineno-189-86"></a><span class="w">      </span><span class="nt">labels</span><span class="p">:</span>
</span><span id="__span-189-87"><a id="__codelineno-189-87" name="__codelineno-189-87" href="#__codelineno-189-87"></a><span class="w">        </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">navidrome</span>
</span><span id="__span-189-88"><a id="__codelineno-189-88" name="__codelineno-189-88" href="#__codelineno-189-88"></a><span class="w">    </span><span class="nt">spec</span><span class="p">:</span>
</span><span id="__span-189-89"><a id="__codelineno-189-89" name="__codelineno-189-89" href="#__codelineno-189-89"></a><span class="w">      </span><span class="nt">containers</span><span class="p">:</span>
</span><span id="__span-189-90"><a id="__codelineno-189-90" name="__codelineno-189-90" href="#__codelineno-189-90"></a><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">deluan/navidrome:latest</span>
</span><span id="__span-189-91"><a id="__codelineno-189-91" name="__codelineno-189-91" href="#__codelineno-189-91"></a><span class="w">          </span><span class="nt">imagePullPolicy</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Always</span>
</span><span id="__span-189-92"><a id="__codelineno-189-92" name="__codelineno-189-92" href="#__codelineno-189-92"></a><span class="w">          </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">navidrome</span>
</span><span id="__span-189-93"><a id="__codelineno-189-93" name="__codelineno-189-93" href="#__codelineno-189-93"></a><span class="w">          </span><span class="nt">env</span><span class="p">:</span>
</span><span id="__span-189-94"><a id="__codelineno-189-94" name="__codelineno-189-94" href="#__codelineno-189-94"></a><span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ND_BASEURL</span>
</span><span id="__span-189-95"><a id="__codelineno-189-95" name="__codelineno-189-95" href="#__codelineno-189-95"></a><span class="w">            </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="s">"https://navidrome-alfred.royal-penny.ts.net/"</span>
</span><span id="__span-189-96"><a id="__codelineno-189-96" name="__codelineno-189-96" href="#__codelineno-189-96"></a><span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ND_LOGLEVEL</span>
</span><span id="__span-189-97"><a id="__codelineno-189-97" name="__codelineno-189-97" href="#__codelineno-189-97"></a><span class="w">            </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="s">"info"</span>
</span><span id="__span-189-98"><a id="__codelineno-189-98" name="__codelineno-189-98" href="#__codelineno-189-98"></a><span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ND_SCANSCHEDULE</span>
</span><span id="__span-189-99"><a id="__codelineno-189-99" name="__codelineno-189-99" href="#__codelineno-189-99"></a><span class="w">            </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="s">"1h"</span>
</span><span id="__span-189-100"><a id="__codelineno-189-100" name="__codelineno-189-100" href="#__codelineno-189-100"></a><span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ND_SESSIONTIMEOUT</span>
</span><span id="__span-189-101"><a id="__codelineno-189-101" name="__codelineno-189-101" href="#__codelineno-189-101"></a><span class="w">            </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="s">"24h"</span>
</span><span id="__span-189-102"><a id="__codelineno-189-102" name="__codelineno-189-102" href="#__codelineno-189-102"></a><span class="w">          </span><span class="nt">ports</span><span class="p">:</span>
</span><span id="__span-189-103"><a id="__codelineno-189-103" name="__codelineno-189-103" href="#__codelineno-189-103"></a><span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">containerPort</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">4533</span>
</span><span id="__span-189-104"><a id="__codelineno-189-104" name="__codelineno-189-104" href="#__codelineno-189-104"></a><span class="w">          </span><span class="nt">resources</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{}</span>
</span><span id="__span-189-105"><a id="__codelineno-189-105" name="__codelineno-189-105" href="#__codelineno-189-105"></a><span class="w">          </span><span class="nt">stdin</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
</span><span id="__span-189-106"><a id="__codelineno-189-106" name="__codelineno-189-106" href="#__codelineno-189-106"></a><span class="w">          </span><span class="nt">tty</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
</span><span id="__span-189-107"><a id="__codelineno-189-107" name="__codelineno-189-107" href="#__codelineno-189-107"></a><span class="w">          </span><span class="nt">volumeMounts</span><span class="p">:</span>
</span><span id="__span-189-108"><a id="__codelineno-189-108" name="__codelineno-189-108" href="#__codelineno-189-108"></a><span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">mountPath</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/data</span>
</span><span id="__span-189-109"><a id="__codelineno-189-109" name="__codelineno-189-109" href="#__codelineno-189-109"></a><span class="w">            </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">navidrome-data</span>
</span><span id="__span-189-110"><a id="__codelineno-189-110" name="__codelineno-189-110" href="#__codelineno-189-110"></a><span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">mountPath</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/music</span>
</span><span id="__span-189-111"><a id="__codelineno-189-111" name="__codelineno-189-111" href="#__codelineno-189-111"></a><span class="w">            </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">navidrome-music</span>
</span><span id="__span-189-112"><a id="__codelineno-189-112" name="__codelineno-189-112" href="#__codelineno-189-112"></a><span class="w">          </span><span class="nt">securityContext</span><span class="p">:</span>
</span><span id="__span-189-113"><a id="__codelineno-189-113" name="__codelineno-189-113" href="#__codelineno-189-113"></a><span class="w">            </span><span class="nt">allowPrivilegeEscalation</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">false</span>
</span><span id="__span-189-114"><a id="__codelineno-189-114" name="__codelineno-189-114" href="#__codelineno-189-114"></a><span class="w">            </span><span class="nt">runAsUser</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">116</span>
</span><span id="__span-189-115"><a id="__codelineno-189-115" name="__codelineno-189-115" href="#__codelineno-189-115"></a><span class="w">            </span><span class="nt">runAsGroup</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">116</span>
</span><span id="__span-189-116"><a id="__codelineno-189-116" name="__codelineno-189-116" href="#__codelineno-189-116"></a><span class="w">      </span><span class="nt">restartPolicy</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Always</span>
</span><span id="__span-189-117"><a id="__codelineno-189-117" name="__codelineno-189-117" href="#__codelineno-189-117"></a><span class="w">      </span><span class="nt">volumes</span><span class="p">:</span>
</span><span id="__span-189-118"><a id="__codelineno-189-118" name="__codelineno-189-118" href="#__codelineno-189-118"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">navidrome-data</span>
</span><span id="__span-189-119"><a id="__codelineno-189-119" name="__codelineno-189-119" href="#__codelineno-189-119"></a><span class="w">        </span><span class="nt">persistentVolumeClaim</span><span class="p">:</span>
</span><span id="__span-189-120"><a id="__codelineno-189-120" name="__codelineno-189-120" href="#__codelineno-189-120"></a><span class="w">          </span><span class="nt">claimName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">navidrome-pvc-data</span>
</span><span id="__span-189-121"><a id="__codelineno-189-121" name="__codelineno-189-121" href="#__codelineno-189-121"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">navidrome-music</span>
</span><span id="__span-189-122"><a id="__codelineno-189-122" name="__codelineno-189-122" href="#__codelineno-189-122"></a><span class="w">        </span><span class="nt">persistentVolumeClaim</span><span class="p">:</span>
</span><span id="__span-189-123"><a id="__codelineno-189-123" name="__codelineno-189-123" href="#__codelineno-189-123"></a><span class="w">          </span><span class="nt">claimName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">navidrome-pvc-music</span>
</span><span id="__span-189-124"><a id="__codelineno-189-124" name="__codelineno-189-124" href="#__codelineno-189-124"></a><span class="nn">---</span>
</span><span id="__span-189-125"><a id="__codelineno-189-125" name="__codelineno-189-125" href="#__codelineno-189-125"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Service</span>
</span><span id="__span-189-126"><a id="__codelineno-189-126" name="__codelineno-189-126" href="#__codelineno-189-126"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
</span><span id="__span-189-127"><a id="__codelineno-189-127" name="__codelineno-189-127" href="#__codelineno-189-127"></a><span class="nt">metadata</span><span class="p">:</span>
</span><span id="__span-189-128"><a id="__codelineno-189-128" name="__codelineno-189-128" href="#__codelineno-189-128"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">navidrome-svc</span>
</span><span id="__span-189-129"><a id="__codelineno-189-129" name="__codelineno-189-129" href="#__codelineno-189-129"></a><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">navidrome</span>
</span><span id="__span-189-130"><a id="__codelineno-189-130" name="__codelineno-189-130" href="#__codelineno-189-130"></a><span class="nt">spec</span><span class="p">:</span>
</span><span id="__span-189-131"><a id="__codelineno-189-131" name="__codelineno-189-131" href="#__codelineno-189-131"></a><span class="w">  </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">NodePort</span>
</span><span id="__span-189-132"><a id="__codelineno-189-132" name="__codelineno-189-132" href="#__codelineno-189-132"></a><span class="w">  </span><span class="nt">ports</span><span class="p">:</span>
</span><span id="__span-189-133"><a id="__codelineno-189-133" name="__codelineno-189-133" href="#__codelineno-189-133"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">4533</span>
</span><span id="__span-189-134"><a id="__codelineno-189-134" name="__codelineno-189-134" href="#__codelineno-189-134"></a><span class="w">    </span><span class="nt">nodePort</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">30533</span>
</span><span id="__span-189-135"><a id="__codelineno-189-135" name="__codelineno-189-135" href="#__codelineno-189-135"></a><span class="w">    </span><span class="nt">targetPort</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">4533</span>
</span><span id="__span-189-136"><a id="__codelineno-189-136" name="__codelineno-189-136" href="#__codelineno-189-136"></a><span class="w">  </span><span class="nt">selector</span><span class="p">:</span>
</span><span id="__span-189-137"><a id="__codelineno-189-137" name="__codelineno-189-137" href="#__codelineno-189-137"></a><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">navidrome</span>
</span><span id="__span-189-138"><a id="__codelineno-189-138" name="__codelineno-189-138" href="#__codelineno-189-138"></a><span class="nn">---</span>
</span><span id="__span-189-139"><a id="__codelineno-189-139" name="__codelineno-189-139" href="#__codelineno-189-139"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">networking.k8s.io/v1</span>
</span><span id="__span-189-140"><a id="__codelineno-189-140" name="__codelineno-189-140" href="#__codelineno-189-140"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Ingress</span>
</span><span id="__span-189-141"><a id="__codelineno-189-141" name="__codelineno-189-141" href="#__codelineno-189-141"></a><span class="nt">metadata</span><span class="p">:</span>
</span><span id="__span-189-142"><a id="__codelineno-189-142" name="__codelineno-189-142" href="#__codelineno-189-142"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">navidrome-ingress-tailscale</span>
</span><span id="__span-189-143"><a id="__codelineno-189-143" name="__codelineno-189-143" href="#__codelineno-189-143"></a><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">navidrome</span>
</span><span id="__span-189-144"><a id="__codelineno-189-144" name="__codelineno-189-144" href="#__codelineno-189-144"></a><span class="nt">spec</span><span class="p">:</span>
</span><span id="__span-189-145"><a id="__codelineno-189-145" name="__codelineno-189-145" href="#__codelineno-189-145"></a><span class="w">  </span><span class="nt">ingressClassName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">tailscale</span>
</span><span id="__span-189-146"><a id="__codelineno-189-146" name="__codelineno-189-146" href="#__codelineno-189-146"></a><span class="w">  </span><span class="nt">defaultBackend</span><span class="p">:</span>
</span><span id="__span-189-147"><a id="__codelineno-189-147" name="__codelineno-189-147" href="#__codelineno-189-147"></a><span class="w">    </span><span class="nt">service</span><span class="p">:</span>
</span><span id="__span-189-148"><a id="__codelineno-189-148" name="__codelineno-189-148" href="#__codelineno-189-148"></a><span class="w">      </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">navidrome-svc</span>
</span><span id="__span-189-149"><a id="__codelineno-189-149" name="__codelineno-189-149" href="#__codelineno-189-149"></a><span class="w">      </span><span class="nt">port</span><span class="p">:</span>
</span><span id="__span-189-150"><a id="__codelineno-189-150" name="__codelineno-189-150" href="#__codelineno-189-150"></a><span class="w">        </span><span class="nt">number</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">4533</span>
</span><span id="__span-189-151"><a id="__codelineno-189-151" name="__codelineno-189-151" href="#__codelineno-189-151"></a><span class="w">  </span><span class="nt">tls</span><span class="p">:</span>
</span><span id="__span-189-152"><a id="__codelineno-189-152" name="__codelineno-189-152" href="#__codelineno-189-152"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">hosts</span><span class="p">:</span>
</span><span id="__span-189-153"><a id="__codelineno-189-153" name="__codelineno-189-153" href="#__codelineno-189-153"></a><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">navidrome-alfred</span>
</span></code></pre></div>
</details>
<p>Before deploying Navidrome, it makes sense to also import its <code>/data</code> directory
from <code>octavo</code>, at least once if not on a regular sync:</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-190-1"><a id="__codelineno-190-1" name="__codelineno-190-1" href="#__codelineno-190-1"></a><span class="gp">$ </span>sudo<span class="w"> </span>groupadd<span class="w"> </span>navidrome<span class="w"> </span>-g<span class="w"> </span><span class="m">116</span>
</span><span id="__span-190-2"><a id="__codelineno-190-2" name="__codelineno-190-2" href="#__codelineno-190-2"></a><span class="gp">$ </span>sudo<span class="w"> </span>useradd<span class="w">  </span>navidrome<span class="w"> </span>-u<span class="w"> </span><span class="m">116</span><span class="w"> </span>-g<span class="w"> </span><span class="m">116</span><span class="w"> </span>-s<span class="w"> </span>/usr/sbin/nologin
</span><span id="__span-190-3"><a id="__codelineno-190-3" name="__codelineno-190-3" href="#__codelineno-190-3"></a><span class="gp">$ </span>sudo<span class="w"> </span>rsync<span class="w"> </span>-ua<span class="w"> </span>root@octavo.royal-penny.ts.net:/home/k8s/navidrome<span class="w"> </span>/home/k8s/
</span><span id="__span-190-4"><a id="__codelineno-190-4" name="__codelineno-190-4" href="#__codelineno-190-4"></a><span class="gp">$ </span>sudo<span class="w"> </span>chown<span class="w"> </span>-R<span class="w"> </span>navidrome:navidrome<span class="w"> </span>/home/k8s/navidrome
</span><span id="__span-190-5"><a id="__codelineno-190-5" name="__codelineno-190-5" href="#__codelineno-190-5"></a><span class="gp">$ </span>sudo<span class="w"> </span>ls<span class="w"> </span>-hal<span class="w"> </span>/home/k8s/navidrome
</span><span id="__span-190-6"><a id="__codelineno-190-6" name="__codelineno-190-6" href="#__codelineno-190-6"></a><span class="go">total 32M</span>
</span><span id="__span-190-7"><a id="__codelineno-190-7" name="__codelineno-190-7" href="#__codelineno-190-7"></a><span class="go">drwxr-xr-x 3 navidrome navidrome 4.0K Apr 30 00:27 .</span>
</span><span id="__span-190-8"><a id="__codelineno-190-8" name="__codelineno-190-8" href="#__codelineno-190-8"></a><span class="go">drwxr-xr-x 7 root      root      4.0K May  4 22:37 ..</span>
</span><span id="__span-190-9"><a id="__codelineno-190-9" name="__codelineno-190-9" href="#__codelineno-190-9"></a><span class="go">drwxr-xr-x 5 navidrome navidrome 4.0K Dec 23 06:09 cache</span>
</span><span id="__span-190-10"><a id="__codelineno-190-10" name="__codelineno-190-10" href="#__codelineno-190-10"></a><span class="go">-rw-r--r-- 1 navidrome navidrome  32M Apr 30 00:25 navidrome.db</span>
</span><span id="__span-190-11"><a id="__codelineno-190-11" name="__codelineno-190-11" href="#__codelineno-190-11"></a><span class="go">-rw-r--r-- 1 navidrome navidrome  32K May  3 23:14 navidrome.db-shm</span>
</span><span id="__span-190-12"><a id="__codelineno-190-12" name="__codelineno-190-12" href="#__codelineno-190-12"></a><span class="go">-rw-r--r-- 1 navidrome navidrome 165K May  3 23:14 navidrome.db-wal</span>
</span></code></pre></div>
<p>Then apply the deployment and allow time for Tailscale DNS to propagate.</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-191-1"><a id="__codelineno-191-1" name="__codelineno-191-1" href="#__codelineno-191-1"></a><span class="gp">$ </span>kubectl<span class="w"> </span>apply<span class="w"> </span>-f<span class="w"> </span>alfred/navidrome.yaml
</span><span id="__span-191-2"><a id="__codelineno-191-2" name="__codelineno-191-2" href="#__codelineno-191-2"></a><span class="go">namespace/navidrome created</span>
</span><span id="__span-191-3"><a id="__codelineno-191-3" name="__codelineno-191-3" href="#__codelineno-191-3"></a><span class="go">persistentvolume/navidrome-pv-data created</span>
</span><span id="__span-191-4"><a id="__codelineno-191-4" name="__codelineno-191-4" href="#__codelineno-191-4"></a><span class="go">persistentvolume/navidrome-pv-music created</span>
</span><span id="__span-191-5"><a id="__codelineno-191-5" name="__codelineno-191-5" href="#__codelineno-191-5"></a><span class="go">persistentvolumeclaim/navidrome-pvc-data created</span>
</span><span id="__span-191-6"><a id="__codelineno-191-6" name="__codelineno-191-6" href="#__codelineno-191-6"></a><span class="go">persistentvolumeclaim/navidrome-pvc-music created</span>
</span><span id="__span-191-7"><a id="__codelineno-191-7" name="__codelineno-191-7" href="#__codelineno-191-7"></a><span class="go">deployment.apps/navidrome created</span>
</span><span id="__span-191-8"><a id="__codelineno-191-8" name="__codelineno-191-8" href="#__codelineno-191-8"></a><span class="go">service/navidrome-svc created</span>
</span><span id="__span-191-9"><a id="__codelineno-191-9" name="__codelineno-191-9" href="#__codelineno-191-9"></a><span class="go">ingress.networking.k8s.io/navidrome-ingress-tailscale created</span>
</span><span id="__span-191-10"><a id="__codelineno-191-10" name="__codelineno-191-10" href="#__codelineno-191-10"></a>
</span><span id="__span-191-11"><a id="__codelineno-191-11" name="__codelineno-191-11" href="#__codelineno-191-11"></a><span class="gp">$ </span>kubectl<span class="w"> </span>get<span class="w"> </span>all<span class="w"> </span>-n<span class="w"> </span>navidrome
</span><span id="__span-191-12"><a id="__codelineno-191-12" name="__codelineno-191-12" href="#__codelineno-191-12"></a><span class="go">NAME                             READY   STATUS    RESTARTS   AGE</span>
</span><span id="__span-191-13"><a id="__codelineno-191-13" name="__codelineno-191-13" href="#__codelineno-191-13"></a><span class="go">pod/navidrome-6f6bf7d87c-qrtz2   1/1     Running   0          25s</span>
</span><span id="__span-191-14"><a id="__codelineno-191-14" name="__codelineno-191-14" href="#__codelineno-191-14"></a>
</span><span id="__span-191-15"><a id="__codelineno-191-15" name="__codelineno-191-15" href="#__codelineno-191-15"></a><span class="go">NAME                    TYPE       CLUSTER-IP      EXTERNAL-IP   PORT(S)          AGE</span>
</span><span id="__span-191-16"><a id="__codelineno-191-16" name="__codelineno-191-16" href="#__codelineno-191-16"></a><span class="go">service/navidrome-svc   NodePort   10.104.114.45   &lt;none&gt;        4533:30533/TCP   25s</span>
</span><span id="__span-191-17"><a id="__codelineno-191-17" name="__codelineno-191-17" href="#__codelineno-191-17"></a>
</span><span id="__span-191-18"><a id="__codelineno-191-18" name="__codelineno-191-18" href="#__codelineno-191-18"></a><span class="go">NAME                        READY   UP-TO-DATE   AVAILABLE   AGE</span>
</span><span id="__span-191-19"><a id="__codelineno-191-19" name="__codelineno-191-19" href="#__codelineno-191-19"></a><span class="go">deployment.apps/navidrome   1/1     1            1           25s</span>
</span><span id="__span-191-20"><a id="__codelineno-191-20" name="__codelineno-191-20" href="#__codelineno-191-20"></a>
</span><span id="__span-191-21"><a id="__codelineno-191-21" name="__codelineno-191-21" href="#__codelineno-191-21"></a><span class="go">NAME                                   DESIRED   CURRENT   READY   AGE</span>
</span><span id="__span-191-22"><a id="__codelineno-191-22" name="__codelineno-191-22" href="#__codelineno-191-22"></a><span class="go">replicaset.apps/navidrome-6f6bf7d87c   1         1         1       25s</span>
</span><span id="__span-191-23"><a id="__codelineno-191-23" name="__codelineno-191-23" href="#__codelineno-191-23"></a>
</span><span id="__span-191-24"><a id="__codelineno-191-24" name="__codelineno-191-24" href="#__codelineno-191-24"></a><span class="gp">$ </span>kubectl<span class="w"> </span>get<span class="w"> </span>ingress<span class="w"> </span>-n<span class="w"> </span>navidrome
</span><span id="__span-191-25"><a id="__codelineno-191-25" name="__codelineno-191-25" href="#__codelineno-191-25"></a><span class="go">NAME                          CLASS       HOSTS   ADDRESS                                PORTS     AGE</span>
</span><span id="__span-191-26"><a id="__codelineno-191-26" name="__codelineno-191-26" href="#__codelineno-191-26"></a><span class="go">navidrome-ingress-tailscale   tailscale   *       navidrome-alfred.royal-penny.ts.net    80, 443   30s</span>
</span></code></pre></div>
<p>Eventually the service is available at <a href="https://navidrome-alfred.royal-penny.ts.net">https://navidrome-alfred.royal-penny.ts.net</a>
and <em>everything works just fine</em>. Otherwise, consider removing the contents of
<code>/home/k8s/navidrome</code> to let Navidrome initialize itself anew.</p>
<h2 id="conclusion">Conclusion</h2>
<p><em>One does not simply...</em> anything!</p>
<p>All this started with a <em>fairly simple</em> goal: run Home Assistant on a Raspberry Pi 5.
Adding Kubernetes to the mix certainly adds complexity, but at the same time enables
future expansion by <em>easily</em> adding more services later.</p>
<p>The choice of <a href="#hardware">hardware</a> turned out to be the least problematic part of
this project, although the Raspberry Pi OS can be attributed the issues leading to
<a href="#troubleshooting-bootstrap">troubleshooting the Kubernetes bootstrap</a>. Installing
<a href="#kubernetes">Kubernetes v1.32.2</a> may be responsible for most of the other issues
and complications encountered, such as <a href="#troubleshooting-flannel">Flannel troubles</a>,
<a href="#troubleshooting-dashboard">trouble with the Kubernetes dashboard</a>,
<a href="#fix-metallb-speaker">MetalLB speaker</a>,
<a href="#allow-snippet-directives">Ingress directives</a> and possibly even
<a href="#more-flannel-troubleshooting">more toubles with Flannel</a>. And then Home Assistant
itself had to present <a href="#caveat-on-reverse-proxies">its own issues with reverse proxies</a>.</p>
<p>On the plus side, this project has been a good test run to learn about
<a href="#cloudflare-tunnel">Cloudflare Tunnel</a> (and
<a href="../../../03/28/remote-access-options-for-self-hosted-services/#cloudflare-access">Cloudflare Access</a>),
<a href="#tailscale">Tailscale</a> and <a href="#kustomized-deployment">Kustomize</a>, all of which will
be reused to setup remote access and services in the new
<a href="../../../04/12/kubernetes-homelab-server-with-ubuntu-server-2404-octavo/"> Kubernetes homelab server with Ubuntu Server 24.04 (octavo)</a>.</p>







  
  



  


  



<script src="https://giscus.app/client.js" data-repo="stibbons1990/hex" data-repo-id="R_kgDOKXTsSg" data-category="Announcements" data-category-id="DIC_kwDOKXTsSs4CqHDX" data-mapping="pathname" data-strict="0" data-reactions-enabled="1" data-emit-metadata="1" data-input-position="top" data-theme="preferred_color_scheme" data-lang="en" crossorigin="anonymous" async>
</script>

      
    </article>
  </div>

          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"></path></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
    
      
        
      
      <nav class="md-footer__inner md-grid" aria-label="Footer">
        
          
          <a href="../../../01/10/upgrading-single-node-kubernetes-cluster-on-ubuntu-studio-2404-lexicon/" class="md-footer__link md-footer__link--prev" aria-label="Previous: Upgrading single-node Kubernetes cluster on Ubuntu Studio 24.04 (lexicon)">
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"></path></svg>
            </div>
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Previous
              </span>
              <div class="md-ellipsis">
                Upgrading single-node Kubernetes cluster on Ubuntu Studio 24.04 (lexicon)
              </div>
            </div>
          </a>
        
        
          
          <a href="../../../03/08/adopting-firefox-and-bitwarden-as-daily-drivers/" class="md-footer__link md-footer__link--next" aria-label="Next: Adopting Firefox and Bitwarden as daily drivers">
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Next
              </span>
              <div class="md-ellipsis">
                Adopting Firefox and Bitwarden as daily drivers
              </div>
            </div>
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11z"></path></svg>
            </div>
          </a>
        
      </nav>
    
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright  2019-2025 Ponder Stibbons
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      
      <script id="__config" type="application/json">{"annotate": null, "base": "../../../../..", "features": ["content.code.copy", "navigation.expand", "navigation.footer", "navigation.top", "search.highlight", "search.suggest"], "search": "../../../../../assets/javascripts/workers/search.2c215733.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../../../../assets/javascripts/bundle.79ae519e.min.js"></script>
      
    
  
<script id="init-glightbox">const lightbox = GLightbox({"touchNavigation": true, "loop": false, "zoomable": true, "draggable": true, "openEffect": "zoom", "closeEffect": "zoom", "slideEffect": "slide"});
document$.subscribe(()=>{ lightbox.reload(); });
</script></body></html>