<!DOCTYPE html><html lang="en" class="no-js"><head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://stibbons1990.github.io/hex/blog/2025/12/18/replacing-ingress-nginx-with-pomerium/">
      
      
        <link rel="prev" href="../../14/fotocx-on-ubuntu-studio-2404/">
      
      
        <link rel="next" href="../../21/monitoring-a-kubernetes-cluster-for-vulnerabilities/">
      
      
        
      
      
      <link rel="icon" href="../../../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.7.1">
    
    
      
        <title>Replacing Ingress-NGINX with Pomerium - Inadvisably Applied Magic</title>
      
    
    
      <link rel="stylesheet" href="../../../../../assets/stylesheets/main.484c7ddc.min.css">
      
        
        <link rel="stylesheet" href="../../../../../assets/stylesheets/palette.ab4e12ef.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&amp;display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../../../../stylesheets/extra.css">
    
    <script>__md_scope=new URL("../../../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      
  


  
  

<script id="__analytics">function __md_analytics(){function e(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],e("js",new Date),e("config","G-Y167L3ZVGY"),document.addEventListener("DOMContentLoaded",(function(){document.forms.search&&document.forms.search.query.addEventListener("blur",(function(){this.value&&e("event","search",{search_term:this.value})}));document$.subscribe((function(){var t=document.forms.feedback;if(void 0!==t)for(var a of t.querySelectorAll("[type=submit]"))a.addEventListener("click",(function(a){a.preventDefault();var n=document.location.pathname,d=this.getAttribute("data-md-value");e("event","feedback",{page:n,data:d}),t.firstElementChild.disabled=!0;var r=t.querySelector(".md-feedback__note [data-md-value='"+d+"']");r&&(r.hidden=!1)})),t.hidden=!1})),location$.subscribe((function(t){e("config","G-Y167L3ZVGY",{page_path:t.pathname})}))}));var t=document.createElement("script");t.async=!0,t.src="https://www.googletagmanager.com/gtag/js?id=G-Y167L3ZVGY",document.getElementById("__analytics").insertAdjacentElement("afterEnd",t)}</script>
  
    <script>"undefined"!=typeof __md_analytics&&__md_analytics()</script>
  

    
    
  <link href="../../../../../assets/stylesheets/glightbox.min.css" rel="stylesheet"><script src="../../../../../assets/javascripts/glightbox.min.js"></script><style id="glightbox-style">
            html.glightbox-open { overflow: initial; height: 100%; }
            .gslide-title { margin-top: 0px; user-select: text; }
            .gslide-desc { color: #666; user-select: text; }
            .gslide-image img { background: white; }
            .gscrollbar-fixer { padding-right: 15px; }
            .gdesc-inner { font-size: 0.75rem; }
            body[data-md-color-scheme="slate"] .gdesc-inner { background: var(--md-default-bg-color); }
            body[data-md-color-scheme="slate"] .gslide-title { color: var(--md-default-fg-color); }
            body[data-md-color-scheme="slate"] .gslide-desc { color: var(--md-default-fg-color); }
        </style></head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="slate" data-md-color-primary="deep-purple" data-md-color-accent="green">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#installation" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../../../.." title="Inadvisably Applied Magic" class="md-header__button md-logo" aria-label="Inadvisably Applied Magic" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="m64 400 85.7-208.2c17-41.3 47.8-75.3 87.2-96.3l146.9-78.3c12.3-6.6 26.5 4.7 23 18.2l-37.2 142.4c-1.1 4.1-1.6 8.3-1.6 12.6 0 6.3 1.2 12.6 3.6 18.5L448 400H240.9l11.8-35.4 40.4-13.5c6.5-2.2 10.9-8.3 10.9-15.2s-4.4-13-10.9-15.2l-40.4-13.5-13.5-40.4c-2.2-6.4-8.3-10.8-15.2-10.8s-13 4.4-15.2 10.9l-13.5 40.4-40.4 13.5c-6.5 2.2-10.9 8.3-10.9 15.2s4.4 13 10.9 15.2l40.4 13.5 11.8 35.4H64zm215.6-258.5c-1.1-3.3-4.1-5.5-7.6-5.5s-6.5 2.2-7.6 5.5l-6.7 20.2-20.2 6.7c-3.3 1.1-5.5 4.1-5.5 7.6s2.2 6.5 5.5 7.6l20.2 6.7 6.7 20.2c1.1 3.3 4.1 5.5 7.6 5.5s6.5-2.2 7.6-5.5l6.7-20.2 20.2-6.7c3.3-1.1 5.5-4.1 5.5-7.6s-2.2-6.5-5.5-7.6l-20.2-6.7zM32 448h448c17.7 0 32 14.3 32 32s-14.3 32-32 32H32c-17.7 0-32-14.3-32-32s14.3-32 32-32"></path></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"></path></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Inadvisably Applied Magic
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Replacing Ingress-NGINX with Pomerium
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="deep-purple" data-md-color-accent="green" aria-label="Dark mode" type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 7a5 5 0 0 1 5 5 5 5 0 0 1-5 5 5 5 0 0 1-5-5 5 5 0 0 1 5-5m0 2a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3m0-7 2.39 3.42C13.65 5.15 12.84 5 12 5s-1.65.15-2.39.42zM3.34 7l4.16-.35A7.2 7.2 0 0 0 5.94 8.5c-.44.74-.69 1.5-.83 2.29zm.02 10 1.76-3.77a7.131 7.131 0 0 0 2.38 4.14zM20.65 7l-1.77 3.79a7.02 7.02 0 0 0-2.38-4.15zm-.01 10-4.14.36c.59-.51 1.12-1.14 1.54-1.86.42-.73.69-1.5.83-2.29zM12 22l-2.41-3.44c.74.27 1.55.44 2.41.44.82 0 1.63-.17 2.37-.44z"></path></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="deep-purple" data-md-color-accent="green" aria-label="Light mode" type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m17.75 4.09-2.53 1.94.91 3.06-2.63-1.81-2.63 1.81.91-3.06-2.53-1.94L12.44 4l1.06-3 1.06 3zm3.5 6.91-1.64 1.25.59 1.98-1.7-1.17-1.7 1.17.59-1.98L15.75 11l2.06-.05L18.5 9l.69 1.95zm-2.28 4.95c.83-.08 1.72 1.1 1.19 1.85-.32.45-.66.87-1.08 1.27C15.17 23 8.84 23 4.94 19.07c-3.91-3.9-3.91-10.24 0-14.14.4-.4.82-.76 1.27-1.08.75-.53 1.93.36 1.85 1.19-.27 2.86.69 5.83 2.89 8.02a9.96 9.96 0 0 0 8.02 2.89m-1.64 2.02a12.08 12.08 0 0 1-7.8-3.47c-2.17-2.19-3.33-5-3.49-7.82-2.81 3.14-2.7 7.96.31 10.98 3.02 3.01 7.84 3.12 10.98.31"></path></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"></path></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"></path></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"></path></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"></path></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
                
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" hidden>
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../../../.." title="Inadvisably Applied Magic" class="md-nav__button md-logo" aria-label="Inadvisably Applied Magic" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="m64 400 85.7-208.2c17-41.3 47.8-75.3 87.2-96.3l146.9-78.3c12.3-6.6 26.5 4.7 23 18.2l-37.2 142.4c-1.1 4.1-1.6 8.3-1.6 12.6 0 6.3 1.2 12.6 3.6 18.5L448 400H240.9l11.8-35.4 40.4-13.5c6.5-2.2 10.9-8.3 10.9-15.2s-4.4-13-10.9-15.2l-40.4-13.5-13.5-40.4c-2.2-6.4-8.3-10.8-15.2-10.8s-13 4.4-15.2 10.9l-13.5 40.4-40.4 13.5c-6.5 2.2-10.9 8.3-10.9 15.2s4.4 13 10.9 15.2l40.4 13.5 11.8 35.4H64zm215.6-258.5c-1.1-3.3-4.1-5.5-7.6-5.5s-6.5 2.2-7.6 5.5l-6.7 20.2-20.2 6.7c-3.3 1.1-5.5 4.1-5.5 7.6s2.2 6.5 5.5 7.6l20.2 6.7 6.7 20.2c1.1 3.3 4.1 5.5 7.6 5.5s6.5-2.2 7.6-5.5l6.7-20.2 20.2-6.7c3.3-1.1 5.5-4.1 5.5-7.6s-2.2-6.5-5.5-7.6l-20.2-6.7zM32 448h448c17.7 0 32 14.3 32 32s-14.3 32-32 32H32c-17.7 0-32-14.3-32-32s14.3-32 32-32"></path></svg>

    </a>
    Inadvisably Applied Magic
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    About This Place
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_2">
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Projects
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    Projects
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../projects/conmon/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Continuous Monitoring
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../projects/self-hosting/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Self-hosting
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      <a href="../../../../" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Unexpected Linux Adventures
  

    
  </span>
  
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
                
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#installation" class="md-nav__link">
    <span class="md-ellipsis">
      
        Installation
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Installation">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#prerequisites" class="md-nav__link">
    <span class="md-ellipsis">
      
        Prerequisites
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#deploy-ingress-controller" class="md-nav__link">
    <span class="md-ellipsis">
      
        Deploy ingress-controller
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Deploy ingress-controller">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#pebble-storage" class="md-nav__link">
    <span class="md-ellipsis">
      
        Pebble Storage
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#global-pomerium-settings" class="md-nav__link">
    <span class="md-ellipsis">
      
        Global Pomerium Settings
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Global Pomerium Settings">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#pomerium-crd" class="md-nav__link">
    <span class="md-ellipsis">
      
        Pomerium CRD
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#certifiate-for-the-auth-endpoint" class="md-nav__link">
    <span class="md-ellipsis">
      
        Certifiate for the auth endpoint
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#identity-provider-idp" class="md-nav__link">
    <span class="md-ellipsis">
      
        Identity Provider (IdP)
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#test-with-verify" class="md-nav__link">
    <span class="md-ellipsis">
      
        Test with Verify
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#additional-settings" class="md-nav__link">
    <span class="md-ellipsis">
      
        Additional Settings
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Additional Settings">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#access-control-for-users" class="md-nav__link">
    <span class="md-ellipsis">
      
        Access Control for Users
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#api-access" class="md-nav__link">
    <span class="md-ellipsis">
      
        API access
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="API access">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#audiobookshelf" class="md-nav__link">
    <span class="md-ellipsis">
      
        Audiobookshelf
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#firefly-iii" class="md-nav__link">
    <span class="md-ellipsis">
      
        Firefly III
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#grafana" class="md-nav__link">
    <span class="md-ellipsis">
      
        Grafana
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#influxdb" class="md-nav__link">
    <span class="md-ellipsis">
      
        InfluxDB
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#komga" class="md-nav__link">
    <span class="md-ellipsis">
      
        Komga
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#home-assistant" class="md-nav__link">
    <span class="md-ellipsis">
      
        Home Assistant
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#jellyfin" class="md-nav__link">
    <span class="md-ellipsis">
      
        Jellyfin
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#navidrome" class="md-nav__link">
    <span class="md-ellipsis">
      
        Navidrome
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#https-backends" class="md-nav__link">
    <span class="md-ellipsis">
      
        HTTPS backends
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#streaming" class="md-nav__link">
    <span class="md-ellipsis">
      
        Streaming
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#websockets" class="md-nav__link">
    <span class="md-ellipsis">
      
        WebSockets
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#convert-ngnix-ingress-to-pomerium" class="md-nav__link">
    <span class="md-ellipsis">
      
        Convert Ngnix Ingress to Pomerium
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Convert Ngnix Ingress to Pomerium">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#cloudflare-tunnels" class="md-nav__link">
    <span class="md-ellipsis">
      
        Cloudflare Tunnels
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#update-kustomized-ingress" class="md-nav__link">
    <span class="md-ellipsis">
      
        Update Kustomized Ingress
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#kustomize-per-service-acls" class="md-nav__link">
    <span class="md-ellipsis">
      
        Kustomize per-service ACLs
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#final-traffic-migration" class="md-nav__link">
    <span class="md-ellipsis">
      
        Final Traffic Migration
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#clean-up-retired-nginx-ingress" class="md-nav__link">
    <span class="md-ellipsis">
      
        Clean-up retired Nginx Ingress
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Clean-up retired Nginx Ingress">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#tailscale" class="md-nav__link">
    <span class="md-ellipsis">
      
        Tailscale
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#migrate-lets-encrypt-solvers" class="md-nav__link">
    <span class="md-ellipsis">
      
        Migrate Let's Encrypt solvers
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Migrate Let's Encrypt solvers">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#switch-to-dns-01-solvers" class="md-nav__link">
    <span class="md-ellipsis">
      
        Switch to DNS-01 solvers
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#uninstall-ingress-nginx" class="md-nav__link">
    <span class="md-ellipsis">
      
        Uninstall Ingress-NGINX
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#appendix-updating-pomerium" class="md-nav__link">
    <span class="md-ellipsis">
      
        Appendix: updating Pomerium
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#appendix-alfred-migration" class="md-nav__link">
    <span class="md-ellipsis">
      
        Appendix: alfred migration
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Appendix: alfred migration">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#alfred-pomerium-crd" class="md-nav__link">
    <span class="md-ellipsis">
      
        Alfred Pomerium CRD
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#alfred-certifiate-for-the-auth-endpoint" class="md-nav__link">
    <span class="md-ellipsis">
      
        Alfred Certifiate for the auth endpoint
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#alfred-cloudflare-hostnames" class="md-nav__link">
    <span class="md-ellipsis">
      
        Alfred CloudFlare hostnames
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#alfred-identity-provider-idp" class="md-nav__link">
    <span class="md-ellipsis">
      
        Alfred Identity Provider (IdP)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#alfred-test-with-verify" class="md-nav__link">
    <span class="md-ellipsis">
      
        Alfred test with Verify
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#alfred-additional-settings" class="md-nav__link">
    <span class="md-ellipsis">
      
        Alfred Additional Settings
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#alfred-lets-encrypt-solvers" class="md-nav__link">
    <span class="md-ellipsis">
      
        Alfred Let's Encrypt solvers
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#alfred-clean-up" class="md-nav__link">
    <span class="md-ellipsis">
      
        Alfred clean-up
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#appendix-streaming-support" class="md-nav__link">
    <span class="md-ellipsis">
      
        Appendix: streaming support
      
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
  <div class="md-content md-content--post" data-md-component="content">
    <div class="md-sidebar md-sidebar--post" data-md-component="sidebar" data-md-type="navigation">
      <div class="md-sidebar__scrollwrap">
        <div class="md-sidebar__inner md-post">
          <nav class="md-nav md-nav--primary">
            <div class="md-post__back">
              <div class="md-nav__title md-nav__container">
                <a href="../../../../" class="md-nav__link">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"></path></svg>
                  <span class="md-ellipsis">
                    Back to index
                  </span>
                </a>
              </div>
            </div>
            
            <ul class="md-post__meta md-nav__list">
              <li class="md-nav__item md-nav__item--section">
                <div class="md-post__title">
                  <span class="md-ellipsis">
                    Metadata
                  </span>
                </div>
                <nav class="md-nav">
                  <ul class="md-nav__list">
                    <li class="md-nav__item">
                      <div class="md-nav__link">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 19H5V8h14m-3-7v2H8V1H6v2H5c-1.11 0-2 .89-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V5a2 2 0 0 0-2-2h-1V1m-1 11h-5v5h5z"></path></svg>
                        <time datetime="2025-12-18 00:00:00+00:00" class="md-ellipsis">December 18, 2025</time>
                      </div>
                    </li>
                    
                    
                      <li class="md-nav__item">
                        <div class="md-nav__link">
                          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9 3v15h3V3zm3 2 4 13 3-1-4-13zM5 5v13h3V5zM3 19v2h18v-2z"></path></svg>
                          <span class="md-ellipsis">
                            in
                            
                              <a href="../../../../category/linux/">linux</a>, 
                              <a href="../../../../category/ubuntu/">Ubuntu</a>, 
                              <a href="../../../../category/server/">Server</a>, 
                              <a href="../../../../category/kubernetes/">kubernetes</a>, 
                              <a href="../../../../category/docker/">docker</a></span>
                        </div>
                      </li>
                    
                    
                      
                      <li class="md-nav__item">
                        <div class="md-nav__link">
                          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 20a8 8 0 0 0 8-8 8 8 0 0 0-8-8 8 8 0 0 0-8 8 8 8 0 0 0 8 8m0-18a10 10 0 0 1 10 10 10 10 0 0 1-10 10C6.47 22 2 17.5 2 12A10 10 0 0 1 12 2m.5 5v5.25l4.5 2.67-.75 1.23L11 13V7z"></path></svg>
                          <span class="md-ellipsis">
                            
                              40 min read
                            
                          </span>
                        </div>
                      </li>
                    
                  </ul>
                </nav>
              </li>
            </ul>
            
          </nav>
          
        </div>
      </div>
    </div>
    <article class="md-content__inner md-typeset">
      
        
  




  <h1>Replacing Ingress-NGINX with Pomerium</h1>

<p>The community
<a href="https://github.com/kubernetes/ingress-nginx?tab=readme-ov-file#ingress-nginx-controller">Ingress-NGINX controller</a>
is scheduled for
<a href="https://kubernetes.io/blog/2025/11/11/ingress-nginx-retirement/">retirement in March 2026</a>,
so the time comes near to replace it with either a compatible Ingress-NGINX controller or
migrate to the new Gateway API. Given the relatively short migration timeline, the former
promises the least friction and complexity for self-hosted, single-node clusters.</p>
<p>The clusters (<code>octavo</code> and <code>alfred</code>) are currently running Kubernetes version 1.32 which
is will be the next one up to go
<a href="https://kubernetes.io/releases/patch-releases/#non-active-branch-history/#1-32">End Of Life in Feb 28, 2026</a>.
Updating the cluster to Kubernetes version 1.34 would first require updating
Ingress-NGINX to version 1.14 according to its
<a href="https://github.com/kubernetes/ingress-nginx?tab=readme-ov-file#supported-versions-table">Supported Versions table</a>.</p>
<p>Instead, it is possible to replace Ingress-NGINX entirely with
<a href="https://www.pomerium.com/"><strong>Pomerium</strong></a>,
which serves as a direct, secure-by-default alternative that combines standard reverse
proxy functionality with integrated Zero Trust identity verification.</p>
<!-- more -->

<h2 id="installation">Installation</h2>
<p>Helm installation of Pomerium is no longer recommended for new deployments, instead use
<a href="https://www.pomerium.com/docs/k8s/quickstart">Manifests based deployment</a>
(using Kustomize) which ensures the most current Zero Trust architecture is used. This
natively handles WebSockets and media streaming without the limitations found in standard
NGINX setups.</p>
<h3 id="prerequisites">Prerequisites</h3>
<p>Besides Kubernetes v1.19.0 or higher, 
<a href="https://www.pomerium.com/docs/deploy/k8s/quickstart#prerequisites">Pomerium Prerequisites</a>
recomends <strong>a domain space</strong> and <strong>TLS certificates</strong>. Since the cluster is already
running cert-manager v1.17.2 and every subdomain of <code>very-very-dark-gray.top</code> is already
pointing to the public IP address, it is <strong>not</strong> necessary and <em>generally discouraged</em> to
use <code>mkcert</code> to create locally trusted certificates.</p>
<h3 id="deploy-ingress-controller">Deploy <code>ingress-controller</code></h3>
<p>The official documentation recommends to install
<a href="https://www.pomerium.com/docs/deploy/k8s/quickstart#install-pomerium">Install Pomerium</a>
by deploying the (Kustomize-based) manifests directly from their GitHub repository:</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="gp">$ </span>kubectl<span class="w"> </span>apply<span class="w"> </span>-k<span class="w"> </span>github.com/pomerium/ingress-controller/config/default<span class="se">\?</span><span class="nv">ref</span><span class="o">=</span>v0.31.0
</span></code></pre></div>
<p>To later make modifications to the deployment (add <a href="#pebble-storage">Pebble storage</a> for
persistance) the repository can be cloned locally and pinned to the
<a href="https://github.com/pomerium/ingress-controller/releases">latest state release</a>:</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a><span class="gp">$ </span><span class="nb">cd</span><span class="w"> </span>~/src
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a><span class="gp">$ </span>git<span class="w"> </span>clone<span class="w"> </span>https://github.com/pomerium/ingress-controller.git
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a><span class="gp">$ </span><span class="nb">cd</span><span class="w"> </span>ingress-controller/
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4" href="#__codelineno-1-4"></a><span class="gp">$ </span>git<span class="w"> </span>checkout<span class="w"> </span>v0.31.3
</span></code></pre></div>
<p>Deploy Pomerium using its default configuration to start with:</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a><span class="gp">$ </span><span class="nb">cd</span><span class="w"> </span>config/default/
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a><span class="gp">$ </span>kubectl<span class="w"> </span>apply<span class="w"> </span>-k<span class="w"> </span>.
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a><span class="gp"># </span>Warning:<span class="w"> </span><span class="s1">'commonLabels'</span><span class="w"> </span>is<span class="w"> </span>deprecated.<span class="w"> </span>Please<span class="w"> </span>use<span class="w"> </span><span class="s1">'labels'</span><span class="w"> </span>instead.<span class="w"> </span>Run<span class="w"> </span><span class="s1">'kustomize edit fix'</span><span class="w"> </span>to<span class="w"> </span>update<span class="w"> </span>your<span class="w"> </span>Kustomization<span class="w"> </span>automatically.
</span><span id="__span-2-4"><a id="__codelineno-2-4" name="__codelineno-2-4" href="#__codelineno-2-4"></a><span class="go">namespace/pomerium created</span>
</span><span id="__span-2-5"><a id="__codelineno-2-5" name="__codelineno-2-5" href="#__codelineno-2-5"></a><span class="go">customresourcedefinition.apiextensions.k8s.io/policyfilters.gateway.pomerium.io created</span>
</span><span id="__span-2-6"><a id="__codelineno-2-6" name="__codelineno-2-6" href="#__codelineno-2-6"></a><span class="go">customresourcedefinition.apiextensions.k8s.io/pomerium.ingress.pomerium.io created</span>
</span><span id="__span-2-7"><a id="__codelineno-2-7" name="__codelineno-2-7" href="#__codelineno-2-7"></a><span class="go">serviceaccount/pomerium-controller created</span>
</span><span id="__span-2-8"><a id="__codelineno-2-8" name="__codelineno-2-8" href="#__codelineno-2-8"></a><span class="go">serviceaccount/pomerium-gen-secrets created</span>
</span><span id="__span-2-9"><a id="__codelineno-2-9" name="__codelineno-2-9" href="#__codelineno-2-9"></a><span class="go">clusterrole.rbac.authorization.k8s.io/pomerium-controller created</span>
</span><span id="__span-2-10"><a id="__codelineno-2-10" name="__codelineno-2-10" href="#__codelineno-2-10"></a><span class="go">clusterrole.rbac.authorization.k8s.io/pomerium-gen-secrets created</span>
</span><span id="__span-2-11"><a id="__codelineno-2-11" name="__codelineno-2-11" href="#__codelineno-2-11"></a><span class="go">clusterrolebinding.rbac.authorization.k8s.io/pomerium-controller created</span>
</span><span id="__span-2-12"><a id="__codelineno-2-12" name="__codelineno-2-12" href="#__codelineno-2-12"></a><span class="go">clusterrolebinding.rbac.authorization.k8s.io/pomerium-gen-secrets created</span>
</span><span id="__span-2-13"><a id="__codelineno-2-13" name="__codelineno-2-13" href="#__codelineno-2-13"></a><span class="go">service/pomerium-metrics created</span>
</span><span id="__span-2-14"><a id="__codelineno-2-14" name="__codelineno-2-14" href="#__codelineno-2-14"></a><span class="go">service/pomerium-proxy created</span>
</span><span id="__span-2-15"><a id="__codelineno-2-15" name="__codelineno-2-15" href="#__codelineno-2-15"></a><span class="go">deployment.apps/pomerium created</span>
</span><span id="__span-2-16"><a id="__codelineno-2-16" name="__codelineno-2-16" href="#__codelineno-2-16"></a><span class="go">job.batch/pomerium-gen-secrets created</span>
</span><span id="__span-2-17"><a id="__codelineno-2-17" name="__codelineno-2-17" href="#__codelineno-2-17"></a><span class="go">ingressclass.networking.k8s.io/pomerium created</span>
</span></code></pre></div>
<p>Pomerium pod is running but not yet ready; it appears to be unhealthy:</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a>$ kubectl get pods -n pomerium
</span><span id="__span-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a>NAME                         READY   STATUS      RESTARTS   AGE
</span><span id="__span-3-3"><a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a>pomerium-75d45cf7f8-c9tlx    0/1     Running     0          4m28s
</span><span id="__span-3-4"><a id="__codelineno-3-4" name="__codelineno-3-4" href="#__codelineno-3-4"></a>pomerium-gen-secrets-8sx7m   0/1     Completed   0          4m28s
</span><span id="__span-3-5"><a id="__codelineno-3-5" name="__codelineno-3-5" href="#__codelineno-3-5"></a>
</span><span id="__span-3-6"><a id="__codelineno-3-6" name="__codelineno-3-6" href="#__codelineno-3-6"></a>$ kubectl describe pod pomerium-75d45cf7f8-c9tlx -n pomerium | tail
</span><span id="__span-3-7"><a id="__codelineno-3-7" name="__codelineno-3-7" href="#__codelineno-3-7"></a>
</span><span id="__span-3-8"><a id="__codelineno-3-8" name="__codelineno-3-8" href="#__codelineno-3-8"></a>Events:
</span><span id="__span-3-9"><a id="__codelineno-3-9" name="__codelineno-3-9" href="#__codelineno-3-9"></a>  Type     Reason     Age                  From               Message
</span><span id="__span-3-10"><a id="__codelineno-3-10" name="__codelineno-3-10" href="#__codelineno-3-10"></a>  ----     ------     ----                 ----               -------
</span><span id="__span-3-11"><a id="__codelineno-3-11" name="__codelineno-3-11" href="#__codelineno-3-11"></a>  Normal   Scheduled  4m2s                 default-scheduler  Successfully assigned pomerium/pomerium-75d45cf7f8-c9tlx to octavo
</span><span id="__span-3-12"><a id="__codelineno-3-12" name="__codelineno-3-12" href="#__codelineno-3-12"></a>  Normal   Pulling    4m2s                 kubelet            Pulling image "pomerium/ingress-controller:v0.31.3"
</span><span id="__span-3-13"><a id="__codelineno-3-13" name="__codelineno-3-13" href="#__codelineno-3-13"></a>  Normal   Pulled     3m57s                kubelet            Successfully pulled image "pomerium/ingress-controller:v0.31.3" in 5.39s (5.39s including waiting). Image size: 101804642 bytes.
</span><span id="__span-3-14"><a id="__codelineno-3-14" name="__codelineno-3-14" href="#__codelineno-3-14"></a>  Normal   Created    3m57s                kubelet            Created container: pomerium
</span><span id="__span-3-15"><a id="__codelineno-3-15" name="__codelineno-3-15" href="#__codelineno-3-15"></a>  Normal   Started    3m57s                kubelet            Started container pomerium
</span><span id="__span-3-16"><a id="__codelineno-3-16" name="__codelineno-3-16" href="#__codelineno-3-16"></a>  Warning  Unhealthy  2s (x16 over 3m47s)  kubelet            Startup probe failed: Get "http://10.244.0.167:28080/startupz": dial tcp 10.244.0.167:28080: connect: connection refused
</span></code></pre></div>
<p>This <code>connection refused</code> on port <strong>28080</strong> during the startup probe indicates the
Pomerium Ingress Controller is waiting for its mandatory global configuration before it
starts its health check listeners. The Pomerium Ingress Controller is designed to fail
its health probes until it has a valid <a href="#pomerium-crd"><strong>Pomerium CRD</strong></a> applied, which
is not ready yet.</p>
<p>Until then, the controller is running in a loop waiting for the global settings that
define its Identity Provider and internal secrets.</p>
<h4 id="pebble-storage">Pebble Storage</h4>
<p><a href="https://www.pomerium.com/docs/deploy/k8s/install#system-requirements">System requirements</a>
for Pomerium include <em>PostgreSQL 11 or higher</em>, but this is not necessary for a
single-node cluster. Instead, a self-healing file-based databroker that embeds Pebble
(the storage engine behind CockroachDB) can be used to provide persistence across
restarts without the complexity of managing a full PostgreSQL instance.</p>
<p>Using a Manifest-based deployment, the standard Deployment can be modified into a
StatefulSet to attach a <code>PersistentVolume</code> to the Pomerium Databroker. As has been done
for previous deployments, the <code>PersistentVolume</code> will be using a <code>hostPath</code> pointing to a
local directory owned by the user <code>pomerium</code> runs as (65532 as revealed by
<code>ps aux | grep -i pomerium</code>).</p>
<p>Create the local directory with the appropriate permissions: </p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a><span class="gp"># </span>mkdir<span class="w"> </span>-p<span class="w"> </span>/home/k8s/pomerium/data
</span><span id="__span-4-2"><a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a><span class="gp"># </span>chown<span class="w"> </span>-R<span class="w"> </span><span class="m">65532</span>:65532<span class="w"> </span>/home/k8s/pomerium/
</span><span id="__span-4-3"><a id="__codelineno-4-3" name="__codelineno-4-3" href="#__codelineno-4-3"></a><span class="gp"># </span>chmod<span class="w"> </span>-R<span class="w"> </span><span class="m">750</span><span class="w"> </span>/home/k8s/pomerium/
</span><span id="__span-4-4"><a id="__codelineno-4-4" name="__codelineno-4-4" href="#__codelineno-4-4"></a><span class="gp"># </span>ls<span class="w"> </span>-laR<span class="w"> </span>/home/k8s/pomerium/
</span><span id="__span-4-5"><a id="__codelineno-4-5" name="__codelineno-4-5" href="#__codelineno-4-5"></a><span class="go">/home/k8s/pomerium:</span>
</span><span id="__span-4-6"><a id="__codelineno-4-6" name="__codelineno-4-6" href="#__codelineno-4-6"></a><span class="go">total 0</span>
</span><span id="__span-4-7"><a id="__codelineno-4-7" name="__codelineno-4-7" href="#__codelineno-4-7"></a><span class="go">drwxr-x--- 1 65532 root    8 Dec 18 23:06 .</span>
</span><span id="__span-4-8"><a id="__codelineno-4-8" name="__codelineno-4-8" href="#__codelineno-4-8"></a><span class="go">drwxr-xr-x 1 root  root  478 Dec 18 23:06 ..</span>
</span><span id="__span-4-9"><a id="__codelineno-4-9" name="__codelineno-4-9" href="#__codelineno-4-9"></a><span class="go">drwxr-x--- 1 65532 65532   0 Dec 18 23:06 data</span>
</span><span id="__span-4-10"><a id="__codelineno-4-10" name="__codelineno-4-10" href="#__codelineno-4-10"></a>
</span><span id="__span-4-11"><a id="__codelineno-4-11" name="__codelineno-4-11" href="#__codelineno-4-11"></a><span class="go">/home/k8s/pomerium/data:</span>
</span><span id="__span-4-12"><a id="__codelineno-4-12" name="__codelineno-4-12" href="#__codelineno-4-12"></a><span class="go">total 0</span>
</span><span id="__span-4-13"><a id="__codelineno-4-13" name="__codelineno-4-13" href="#__codelineno-4-13"></a><span class="go">drwxr-x--- 1 65532 65532 0 Dec 18 23:06 .</span>
</span><span id="__span-4-14"><a id="__codelineno-4-14" name="__codelineno-4-14" href="#__codelineno-4-14"></a><span class="go">drwxr-x--- 1 65532 root  8 Dec 18 23:06 ..</span>
</span></code></pre></div>
<p>Create the Local Storage manifests and <code>kustomization.yaml</code> in a new <code>pomerium-overlay</code>
directory and patch the Deployment to mount the volume:</p>
<details class="k8s" open="open">
<summary><code>pomerium-overlay/pomerium-storage.yaml</code></summary>
<div class="language-yaml highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-5-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-5-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-5-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-5-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-5-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-5-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-5-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-5-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-5-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-5-10">10</a></span>
<span class="normal"><a href="#__codelineno-5-11">11</a></span>
<span class="normal"><a href="#__codelineno-5-12">12</a></span>
<span class="normal"><a href="#__codelineno-5-13">13</a></span>
<span class="normal"><a href="#__codelineno-5-14">14</a></span>
<span class="normal"><a href="#__codelineno-5-15">15</a></span>
<span class="normal"><a href="#__codelineno-5-16">16</a></span>
<span class="normal"><a href="#__codelineno-5-17">17</a></span>
<span class="normal"><a href="#__codelineno-5-18">18</a></span>
<span class="normal"><a href="#__codelineno-5-19">19</a></span>
<span class="normal"><a href="#__codelineno-5-20">20</a></span>
<span class="normal"><a href="#__codelineno-5-21">21</a></span>
<span class="normal"><a href="#__codelineno-5-22">22</a></span>
<span class="normal"><a href="#__codelineno-5-23">23</a></span>
<span class="normal"><a href="#__codelineno-5-24">24</a></span>
<span class="normal"><a href="#__codelineno-5-25">25</a></span>
<span class="normal"><a href="#__codelineno-5-26">26</a></span>
<span class="normal"><a href="#__codelineno-5-27">27</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
</span><span id="__span-5-2"><a id="__codelineno-5-2" name="__codelineno-5-2"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">PersistentVolume</span>
</span><span id="__span-5-3"><a id="__codelineno-5-3" name="__codelineno-5-3"></a><span class="nt">metadata</span><span class="p">:</span>
</span><span id="__span-5-4"><a id="__codelineno-5-4" name="__codelineno-5-4"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">pomerium-pv-data</span>
</span><span id="__span-5-5"><a id="__codelineno-5-5" name="__codelineno-5-5"></a><span class="nt">spec</span><span class="p">:</span>
</span><span id="__span-5-6"><a id="__codelineno-5-6" name="__codelineno-5-6"></a><span class="w">  </span><span class="nt">storageClassName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">manual</span>
</span><span id="__span-5-7"><a id="__codelineno-5-7" name="__codelineno-5-7"></a><span class="w">  </span><span class="nt">capacity</span><span class="p">:</span>
</span><span id="__span-5-8"><a id="__codelineno-5-8" name="__codelineno-5-8"></a><span class="w">    </span><span class="nt">storage</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">2Gi</span>
</span><span id="__span-5-9"><a id="__codelineno-5-9" name="__codelineno-5-9"></a><span class="w">  </span><span class="nt">accessModes</span><span class="p">:</span>
</span><span id="__span-5-10"><a id="__codelineno-5-10" name="__codelineno-5-10"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ReadWriteOnce</span>
</span><span id="__span-5-11"><a id="__codelineno-5-11" name="__codelineno-5-11"></a><span class="w">  </span><span class="nt">persistentVolumeReclaimPolicy</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Retain</span>
</span><span id="__span-5-12"><a id="__codelineno-5-12" name="__codelineno-5-12"></a><span class="w">  </span><span class="nt">hostPath</span><span class="p">:</span>
</span><span id="__span-5-13"><a id="__codelineno-5-13" name="__codelineno-5-13"></a><span class="hll"><span class="w">    </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/home/k8s/pomerium/data</span>
</span></span><span id="__span-5-14"><a id="__codelineno-5-14" name="__codelineno-5-14"></a><span class="nn">---</span>
</span><span id="__span-5-15"><a id="__codelineno-5-15" name="__codelineno-5-15"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
</span><span id="__span-5-16"><a id="__codelineno-5-16" name="__codelineno-5-16"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">PersistentVolumeClaim</span>
</span><span id="__span-5-17"><a id="__codelineno-5-17" name="__codelineno-5-17"></a><span class="nt">metadata</span><span class="p">:</span>
</span><span id="__span-5-18"><a id="__codelineno-5-18" name="__codelineno-5-18"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">pomerium-pvc-data</span>
</span><span id="__span-5-19"><a id="__codelineno-5-19" name="__codelineno-5-19"></a><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">pomerium</span>
</span><span id="__span-5-20"><a id="__codelineno-5-20" name="__codelineno-5-20"></a><span class="nt">spec</span><span class="p">:</span>
</span><span id="__span-5-21"><a id="__codelineno-5-21" name="__codelineno-5-21"></a><span class="w">  </span><span class="nt">storageClassName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">manual</span>
</span><span id="__span-5-22"><a id="__codelineno-5-22" name="__codelineno-5-22"></a><span class="w">  </span><span class="nt">volumeName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">pomerium-pv-data</span>
</span><span id="__span-5-23"><a id="__codelineno-5-23" name="__codelineno-5-23"></a><span class="w">  </span><span class="nt">accessModes</span><span class="p">:</span>
</span><span id="__span-5-24"><a id="__codelineno-5-24" name="__codelineno-5-24"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ReadWriteOnce</span>
</span><span id="__span-5-25"><a id="__codelineno-5-25" name="__codelineno-5-25"></a><span class="w">  </span><span class="nt">resources</span><span class="p">:</span>
</span><span id="__span-5-26"><a id="__codelineno-5-26" name="__codelineno-5-26"></a><span class="w">    </span><span class="nt">requests</span><span class="p">:</span>
</span><span id="__span-5-27"><a id="__codelineno-5-27" name="__codelineno-5-27"></a><span class="w">      </span><span class="nt">storage</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">2Gi</span>
</span></code></pre></div></td></tr></tbody></table></div>
</details>
<details class="k8s" open="open">
<summary><code>pomerium-overlay/kustomization.yaml</code></summary>
<div class="language-yaml highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-6-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-6-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-6-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-6-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-6-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-6-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-6-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-6-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-6-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-6-10">10</a></span>
<span class="normal"><a href="#__codelineno-6-11">11</a></span>
<span class="normal"><a href="#__codelineno-6-12">12</a></span>
<span class="normal"><a href="#__codelineno-6-13">13</a></span>
<span class="normal"><a href="#__codelineno-6-14">14</a></span>
<span class="normal"><a href="#__codelineno-6-15">15</a></span>
<span class="normal"><a href="#__codelineno-6-16">16</a></span>
<span class="normal"><a href="#__codelineno-6-17">17</a></span>
<span class="normal"><a href="#__codelineno-6-18">18</a></span>
<span class="normal"><a href="#__codelineno-6-19">19</a></span>
<span class="normal"><a href="#__codelineno-6-20">20</a></span>
<span class="normal"><a href="#__codelineno-6-21">21</a></span>
<span class="normal"><a href="#__codelineno-6-22">22</a></span>
<span class="normal"><a href="#__codelineno-6-23">23</a></span>
<span class="normal"><a href="#__codelineno-6-24">24</a></span>
<span class="normal"><a href="#__codelineno-6-25">25</a></span>
<span class="normal"><a href="#__codelineno-6-26">26</a></span>
<span class="normal"><a href="#__codelineno-6-27">27</a></span>
<span class="normal"><a href="#__codelineno-6-28">28</a></span>
<span class="normal"><a href="#__codelineno-6-29">29</a></span>
<span class="normal"><a href="#__codelineno-6-30">30</a></span>
<span class="normal"><a href="#__codelineno-6-31">31</a></span>
<span class="normal"><a href="#__codelineno-6-32">32</a></span>
<span class="normal"><a href="#__codelineno-6-33">33</a></span>
<span class="normal"><a href="#__codelineno-6-34">34</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-6-1"><a id="__codelineno-6-1" name="__codelineno-6-1"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">kustomize.config.k8s.io/v1beta1</span>
</span><span id="__span-6-2"><a id="__codelineno-6-2" name="__codelineno-6-2"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Kustomization</span>
</span><span id="__span-6-3"><a id="__codelineno-6-3" name="__codelineno-6-3"></a>
</span><span id="__span-6-4"><a id="__codelineno-6-4" name="__codelineno-6-4"></a><span class="nt">resources</span><span class="p">:</span>
</span><span id="__span-6-5"><a id="__codelineno-6-5" name="__codelineno-6-5"></a><span class="hll"><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">../../../ingress-controller/config/default</span>
</span></span><span id="__span-6-6"><a id="__codelineno-6-6" name="__codelineno-6-6"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">pomerium-storage.yaml</span>
</span><span id="__span-6-7"><a id="__codelineno-6-7" name="__codelineno-6-7"></a>
</span><span id="__span-6-8"><a id="__codelineno-6-8" name="__codelineno-6-8"></a><span class="nt">patches</span><span class="p">:</span>
</span><span id="__span-6-9"><a id="__codelineno-6-9" name="__codelineno-6-9"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">target</span><span class="p">:</span>
</span><span id="__span-6-10"><a id="__codelineno-6-10" name="__codelineno-6-10"></a><span class="w">      </span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Deployment</span>
</span><span id="__span-6-11"><a id="__codelineno-6-11" name="__codelineno-6-11"></a><span class="w">      </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">pomerium</span>
</span><span id="__span-6-12"><a id="__codelineno-6-12" name="__codelineno-6-12"></a><span class="w">    </span><span class="nt">patch</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|-</span>
</span><span id="__span-6-13"><a id="__codelineno-6-13" name="__codelineno-6-13"></a><span class="w">      </span><span class="no">- op: add</span>
</span><span id="__span-6-14"><a id="__codelineno-6-14" name="__codelineno-6-14"></a><span class="hll"><span class="w">        </span><span class="no">path: /spec/template/spec/containers/0/volumeMounts/-</span>
</span></span><span id="__span-6-15"><a id="__codelineno-6-15" name="__codelineno-6-15"></a><span class="hll"><span class="w">        </span><span class="no">value:</span>
</span></span><span id="__span-6-16"><a id="__codelineno-6-16" name="__codelineno-6-16"></a><span class="hll"><span class="w">          </span><span class="no">name: pomerium-data</span>
</span></span><span id="__span-6-17"><a id="__codelineno-6-17" name="__codelineno-6-17"></a><span class="hll"><span class="w">          </span><span class="no">mountPath: /data</span>
</span></span><span id="__span-6-18"><a id="__codelineno-6-18" name="__codelineno-6-18"></a><span class="w">      </span><span class="no">- op: add</span>
</span><span id="__span-6-19"><a id="__codelineno-6-19" name="__codelineno-6-19"></a><span class="hll"><span class="w">        </span><span class="no">path: /spec/template/spec/volumes/-</span>
</span></span><span id="__span-6-20"><a id="__codelineno-6-20" name="__codelineno-6-20"></a><span class="hll"><span class="w">        </span><span class="no">value: </span>
</span></span><span id="__span-6-21"><a id="__codelineno-6-21" name="__codelineno-6-21"></a><span class="hll"><span class="w">          </span><span class="no">name: pomerium-data</span>
</span></span><span id="__span-6-22"><a id="__codelineno-6-22" name="__codelineno-6-22"></a><span class="hll"><span class="w">          </span><span class="no">persistentVolumeClaim:</span>
</span></span><span id="__span-6-23"><a id="__codelineno-6-23" name="__codelineno-6-23"></a><span class="hll"><span class="w">            </span><span class="no">claimName: pomerium-pvc-data</span>
</span></span><span id="__span-6-24"><a id="__codelineno-6-24" name="__codelineno-6-24"></a><span class="w">      </span><span class="no">- op: replace</span>
</span><span id="__span-6-25"><a id="__codelineno-6-25" name="__codelineno-6-25"></a><span class="hll"><span class="w">        </span><span class="no">path: /spec/strategy</span>
</span></span><span id="__span-6-26"><a id="__codelineno-6-26" name="__codelineno-6-26"></a><span class="hll"><span class="w">        </span><span class="no">value:</span>
</span></span><span id="__span-6-27"><a id="__codelineno-6-27" name="__codelineno-6-27"></a><span class="hll"><span class="w">          </span><span class="no">type: Recreate  # Terminates old pods before starting new ones</span>
</span></span><span id="__span-6-28"><a id="__codelineno-6-28" name="__codelineno-6-28"></a><span class="w">      </span><span class="no">- op: add</span>
</span><span id="__span-6-29"><a id="__codelineno-6-29" name="__codelineno-6-29"></a><span class="hll"><span class="w">        </span><span class="no">path: /spec/template/spec/containers/0/lifecycle</span>
</span></span><span id="__span-6-30"><a id="__codelineno-6-30" name="__codelineno-6-30"></a><span class="hll"><span class="w">        </span><span class="no">value:</span>
</span></span><span id="__span-6-31"><a id="__codelineno-6-31" name="__codelineno-6-31"></a><span class="hll"><span class="w">          </span><span class="no">preStop:</span>
</span></span><span id="__span-6-32"><a id="__codelineno-6-32" name="__codelineno-6-32"></a><span class="hll"><span class="w">            </span><span class="no">exec:</span>
</span></span><span id="__span-6-33"><a id="__codelineno-6-33" name="__codelineno-6-33"></a><span class="hll"><span class="w">              </span><span class="no"># Gives the process 5 seconds to flush Pebble logs and release locks</span>
</span></span><span id="__span-6-34"><a id="__codelineno-6-34" name="__codelineno-6-34"></a><span class="hll"><span class="w">              </span><span class="no">command: ["/bin/sh", "-c", "sleep 5"]</span>
</span></span></code></pre></div></td></tr></tbody></table></div>
<p>To avoid file lock conflicts in the Pebble database across pods, lines 25-27 set the
<code>Recreate</code> strategy so that the running pod are shut down before starting a new one.
Otherwise, Kubernetes defaults to a <code>RollingUpdate</code> strategy which starts a new pod
before the old one is terminated, leading to a deadlock situation where the old pod
still has the lock on the database, which keeps the new pod stuck as  <code>ContainersNotReady</code>.</p>
<p>Lines 29-34 force graceful shutdown to let the old pod flush Pebble logs
and release locks.</p>
</details>
<p>There are two different checks to make before applying this deployment:</p>
<ol>
<li>
<p>Run <code>kubectl kustomize pomerium-overlay</code> to inspect that the generated deployment
    manifest does replace the correct values.</p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>This step is particularly useful to confirm the right amount of <code>../</code> has been
added in front of <code>ingress-controller/config/default</code> depending on where files
are.</p>
</div>
</li>
<li>
<p>Run <code>kubectl apply -k pomerium-overlay --dry-run=client</code> to verify that <code>kubectl</code>
    finds no errors in the generated manifest.</p>
</li>
</ol>
<p>Once the above manifests are confirmed valid, patch the deployment with it:</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-7-1"><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a><span class="gp">$ </span>kubectl<span class="w"> </span>apply<span class="w"> </span>-k<span class="w"> </span>pomerium-overlay<span class="w"> </span>
</span><span id="__span-7-2"><a id="__codelineno-7-2" name="__codelineno-7-2" href="#__codelineno-7-2"></a><span class="go">namespace/pomerium unchanged</span>
</span><span id="__span-7-3"><a id="__codelineno-7-3" name="__codelineno-7-3" href="#__codelineno-7-3"></a><span class="go">customresourcedefinition.apiextensions.k8s.io/policyfilters.gateway.pomerium.io unchanged</span>
</span><span id="__span-7-4"><a id="__codelineno-7-4" name="__codelineno-7-4" href="#__codelineno-7-4"></a><span class="go">customresourcedefinition.apiextensions.k8s.io/pomerium.ingress.pomerium.io unchanged</span>
</span><span id="__span-7-5"><a id="__codelineno-7-5" name="__codelineno-7-5" href="#__codelineno-7-5"></a><span class="go">serviceaccount/pomerium-controller unchanged</span>
</span><span id="__span-7-6"><a id="__codelineno-7-6" name="__codelineno-7-6" href="#__codelineno-7-6"></a><span class="go">serviceaccount/pomerium-gen-secrets unchanged</span>
</span><span id="__span-7-7"><a id="__codelineno-7-7" name="__codelineno-7-7" href="#__codelineno-7-7"></a><span class="go">clusterrole.rbac.authorization.k8s.io/pomerium-controller unchanged</span>
</span><span id="__span-7-8"><a id="__codelineno-7-8" name="__codelineno-7-8" href="#__codelineno-7-8"></a><span class="go">clusterrole.rbac.authorization.k8s.io/pomerium-gen-secrets unchanged</span>
</span><span id="__span-7-9"><a id="__codelineno-7-9" name="__codelineno-7-9" href="#__codelineno-7-9"></a><span class="go">clusterrolebinding.rbac.authorization.k8s.io/pomerium-controller unchanged</span>
</span><span id="__span-7-10"><a id="__codelineno-7-10" name="__codelineno-7-10" href="#__codelineno-7-10"></a><span class="go">clusterrolebinding.rbac.authorization.k8s.io/pomerium-gen-secrets unchanged</span>
</span><span id="__span-7-11"><a id="__codelineno-7-11" name="__codelineno-7-11" href="#__codelineno-7-11"></a><span class="go">service/pomerium-metrics unchanged</span>
</span><span id="__span-7-12"><a id="__codelineno-7-12" name="__codelineno-7-12" href="#__codelineno-7-12"></a><span class="go">service/pomerium-proxy unchanged</span>
</span><span id="__span-7-13"><a id="__codelineno-7-13" name="__codelineno-7-13" href="#__codelineno-7-13"></a><span class="hll"><span class="go">persistentvolume/pomerium-pv-data created</span>
</span></span><span id="__span-7-14"><a id="__codelineno-7-14" name="__codelineno-7-14" href="#__codelineno-7-14"></a><span class="hll"><span class="go">persistentvolumeclaim/pomerium-pvc-data created</span>
</span></span><span id="__span-7-15"><a id="__codelineno-7-15" name="__codelineno-7-15" href="#__codelineno-7-15"></a><span class="hll"><span class="go">deployment.apps/pomerium configured</span>
</span></span><span id="__span-7-16"><a id="__codelineno-7-16" name="__codelineno-7-16" href="#__codelineno-7-16"></a><span class="go">job.batch/pomerium-gen-secrets unchanged</span>
</span><span id="__span-7-17"><a id="__codelineno-7-17" name="__codelineno-7-17" href="#__codelineno-7-17"></a><span class="go">ingressclass.networking.k8s.io/pomerium unchanged</span>
</span></code></pre></div>
<h2 id="global-pomerium-settings">Global Pomerium Settings</h2>
<h3 id="pomerium-crd">Pomerium CRD</h3>
<p>Define the global settings in <code>pomerium-settings.yaml</code>, with <code>spec.storage.file.path</code>
pointing to storage defined above (<code>/data/databroker</code>) and <code>spec.authenticate.url</code>
pointing to the cluster's real domain to use the self-hosted identity-aware proxy,
instead of the domain <a href="https://authenticate.pomerium.app">https://authenticate.pomerium.app</a> which is the endpoint for
<a href="https://www.pomerium.com/zero">Pomerium Zero</a> (their SaaS control plane):</p>
<details class="k8s" open="open">
<summary><code>pomerium-settings.yaml</code></summary>
<div class="language-yaml highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-8-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-8-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-8-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-8-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-8-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-8-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-8-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-8-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-8-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-8-10">10</a></span>
<span class="normal"><a href="#__codelineno-8-11">11</a></span>
<span class="normal"><a href="#__codelineno-8-12">12</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-8-1"><a id="__codelineno-8-1" name="__codelineno-8-1"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ingress.pomerium.io/v1</span>
</span><span id="__span-8-2"><a id="__codelineno-8-2" name="__codelineno-8-2"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Pomerium</span>
</span><span id="__span-8-3"><a id="__codelineno-8-3" name="__codelineno-8-3"></a><span class="nt">metadata</span><span class="p">:</span>
</span><span id="__span-8-4"><a id="__codelineno-8-4" name="__codelineno-8-4"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">global</span>
</span><span id="__span-8-5"><a id="__codelineno-8-5" name="__codelineno-8-5"></a><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">pomerium</span>
</span><span id="__span-8-6"><a id="__codelineno-8-6" name="__codelineno-8-6"></a><span class="nt">spec</span><span class="p">:</span>
</span><span id="__span-8-7"><a id="__codelineno-8-7" name="__codelineno-8-7"></a><span class="w">  </span><span class="nt">secrets</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">pomerium/bootstrap</span>
</span><span id="__span-8-8"><a id="__codelineno-8-8" name="__codelineno-8-8"></a><span class="w">  </span><span class="nt">authenticate</span><span class="p">:</span>
</span><span id="__span-8-9"><a id="__codelineno-8-9" name="__codelineno-8-9"></a><span class="hll"><span class="w">    </span><span class="nt">url</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">https://authenticate.very-very-dark-gray.top:8443</span>
</span></span><span id="__span-8-10"><a id="__codelineno-8-10" name="__codelineno-8-10"></a><span class="w">  </span><span class="nt">storage</span><span class="p">:</span>
</span><span id="__span-8-11"><a id="__codelineno-8-11" name="__codelineno-8-11"></a><span class="w">    </span><span class="nt">file</span><span class="p">:</span>
</span><span id="__span-8-12"><a id="__codelineno-8-12" name="__codelineno-8-12"></a><span class="hll"><span class="w">      </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/data/databroker</span>
</span></span></code></pre></div></td></tr></tbody></table></div>
</details>
<div class="admonition note">
<p class="admonition-title">Using a non-standard port like 8443 mostly works, if port 443 is taken.</p>
</div>
<p>Applying the settings does not restart the <code>pomerium</code> pods, but it is now <code>READY</code>:</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-9-1"><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a><span class="gp">$ </span>kubectl<span class="w"> </span>apply<span class="w"> </span>-f<span class="w"> </span>pomerium-settings.yaml
</span><span id="__span-9-2"><a id="__codelineno-9-2" name="__codelineno-9-2" href="#__codelineno-9-2"></a><span class="go">pomerium.ingress.pomerium.io/global created</span>
</span><span id="__span-9-3"><a id="__codelineno-9-3" name="__codelineno-9-3" href="#__codelineno-9-3"></a>
</span><span id="__span-9-4"><a id="__codelineno-9-4" name="__codelineno-9-4" href="#__codelineno-9-4"></a><span class="gp">$ </span>kubectl<span class="w"> </span>get<span class="w"> </span>pods<span class="w"> </span>-n<span class="w"> </span>pomerium
</span><span id="__span-9-5"><a id="__codelineno-9-5" name="__codelineno-9-5" href="#__codelineno-9-5"></a><span class="go">NAME                         READY   STATUS      RESTARTS      AGE</span>
</span><span id="__span-9-6"><a id="__codelineno-9-6" name="__codelineno-9-6" href="#__codelineno-9-6"></a><span class="go">pomerium-58bdd56668-6p5q5    1/1     Running     2 (16m ago)   36m</span>
</span><span id="__span-9-7"><a id="__codelineno-9-7" name="__codelineno-9-7" href="#__codelineno-9-7"></a><span class="go">pomerium-gen-secrets-8sx7m   0/1     Completed   0             163m</span>
</span></code></pre></div>
<p>The Pomerium Proxy service is now running in the cluster:</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-10-1"><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a><span class="gp">$ </span>kubectl<span class="w"> </span>describe<span class="w"> </span>pomerium
</span><span id="__span-10-2"><a id="__codelineno-10-2" name="__codelineno-10-2" href="#__codelineno-10-2"></a><span class="go">Name:         global</span>
</span><span id="__span-10-3"><a id="__codelineno-10-3" name="__codelineno-10-3" href="#__codelineno-10-3"></a><span class="go">Namespace:    </span>
</span><span id="__span-10-4"><a id="__codelineno-10-4" name="__codelineno-10-4" href="#__codelineno-10-4"></a><span class="go">Labels:       &lt;none&gt;</span>
</span><span id="__span-10-5"><a id="__codelineno-10-5" name="__codelineno-10-5" href="#__codelineno-10-5"></a><span class="go">Annotations:  &lt;none&gt;</span>
</span><span id="__span-10-6"><a id="__codelineno-10-6" name="__codelineno-10-6" href="#__codelineno-10-6"></a><span class="go">API Version:  ingress.pomerium.io/v1</span>
</span><span id="__span-10-7"><a id="__codelineno-10-7" name="__codelineno-10-7" href="#__codelineno-10-7"></a><span class="go">Kind:         Pomerium</span>
</span><span id="__span-10-8"><a id="__codelineno-10-8" name="__codelineno-10-8" href="#__codelineno-10-8"></a><span class="go">Metadata:</span>
</span><span id="__span-10-9"><a id="__codelineno-10-9" name="__codelineno-10-9" href="#__codelineno-10-9"></a><span class="go">  Creation Timestamp:  2025-12-18T23:53:05Z</span>
</span><span id="__span-10-10"><a id="__codelineno-10-10" name="__codelineno-10-10" href="#__codelineno-10-10"></a><span class="go">  Generation:          1</span>
</span><span id="__span-10-11"><a id="__codelineno-10-11" name="__codelineno-10-11" href="#__codelineno-10-11"></a><span class="go">  Resource Version:    51753377</span>
</span><span id="__span-10-12"><a id="__codelineno-10-12" name="__codelineno-10-12" href="#__codelineno-10-12"></a><span class="go">  UID:                 288ab14d-3cdc-490c-9650-cd09a463a72b</span>
</span><span id="__span-10-13"><a id="__codelineno-10-13" name="__codelineno-10-13" href="#__codelineno-10-13"></a><span class="go">Spec:</span>
</span><span id="__span-10-14"><a id="__codelineno-10-14" name="__codelineno-10-14" href="#__codelineno-10-14"></a><span class="go">  Authenticate:</span>
</span><span id="__span-10-15"><a id="__codelineno-10-15" name="__codelineno-10-15" href="#__codelineno-10-15"></a><span class="go">    URL:    https://authenticate.very-very-dark-gray.top</span>
</span><span id="__span-10-16"><a id="__codelineno-10-16" name="__codelineno-10-16" href="#__codelineno-10-16"></a><span class="go">  Secrets:  pomerium/bootstrap</span>
</span><span id="__span-10-17"><a id="__codelineno-10-17" name="__codelineno-10-17" href="#__codelineno-10-17"></a><span class="go">  Storage:</span>
</span><span id="__span-10-18"><a id="__codelineno-10-18" name="__codelineno-10-18" href="#__codelineno-10-18"></a><span class="go">    File:</span>
</span><span id="__span-10-19"><a id="__codelineno-10-19" name="__codelineno-10-19" href="#__codelineno-10-19"></a><span class="go">      Path:  /data/databroker</span>
</span><span id="__span-10-20"><a id="__codelineno-10-20" name="__codelineno-10-20" href="#__codelineno-10-20"></a><span class="go">Status:</span>
</span><span id="__span-10-21"><a id="__codelineno-10-21" name="__codelineno-10-21" href="#__codelineno-10-21"></a><span class="go">  Settings Status:</span>
</span><span id="__span-10-22"><a id="__codelineno-10-22" name="__codelineno-10-22" href="#__codelineno-10-22"></a><span class="go">    Observed At:          2025-12-18T23:53:06Z</span>
</span><span id="__span-10-23"><a id="__codelineno-10-23" name="__codelineno-10-23" href="#__codelineno-10-23"></a><span class="go">    Observed Generation:  1</span>
</span><span id="__span-10-24"><a id="__codelineno-10-24" name="__codelineno-10-24" href="#__codelineno-10-24"></a><span class="go">    Reconciled:           true</span>
</span><span id="__span-10-25"><a id="__codelineno-10-25" name="__codelineno-10-25" href="#__codelineno-10-25"></a><span class="go">Events:</span>
</span><span id="__span-10-26"><a id="__codelineno-10-26" name="__codelineno-10-26" href="#__codelineno-10-26"></a><span class="go">  Type     Reason      Age   From                                     Message</span>
</span><span id="__span-10-27"><a id="__codelineno-10-27" name="__codelineno-10-27" href="#__codelineno-10-27"></a><span class="go">  ----     ------      ----  ----                                     -------</span>
</span><span id="__span-10-28"><a id="__codelineno-10-28" name="__codelineno-10-28" href="#__codelineno-10-28"></a><span class="go">  Normal   Updated     17s   bootstrap pod/pomerium-58bdd56668-6p5q5  config updated</span>
</span></code></pre></div>
<p>The <code>connection refused</code> on port <strong>28080</strong> errors are still present in the <code>Events</code>
section, but they are now only old entries, and no more errors have been produced in
the last <strong>6 minutes</strong>:</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-11-1"><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a><span class="gp">$ </span>kubectl<span class="w"> </span>describe<span class="w"> </span>pod<span class="w"> </span>pomerium-58bdd56668-6p5q5<span class="w"> </span>-n<span class="w"> </span>pomerium<span class="w"> </span><span class="p">|</span><span class="w"> </span>tail
</span><span id="__span-11-2"><a id="__codelineno-11-2" name="__codelineno-11-2" href="#__codelineno-11-2"></a>
</span><span id="__span-11-3"><a id="__codelineno-11-3" name="__codelineno-11-3" href="#__codelineno-11-3"></a><span class="go">Events:</span>
</span><span id="__span-11-4"><a id="__codelineno-11-4" name="__codelineno-11-4" href="#__codelineno-11-4"></a><span class="go">  Type     Reason     Age                  From               Message</span>
</span><span id="__span-11-5"><a id="__codelineno-11-5" name="__codelineno-11-5" href="#__codelineno-11-5"></a><span class="go">  ----     ------     ----                 ----               -------</span>
</span><span id="__span-11-6"><a id="__codelineno-11-6" name="__codelineno-11-6" href="#__codelineno-11-6"></a><span class="go">  Normal   Scheduled  31m                  default-scheduler  Successfully assigned pomerium/pomerium-58bdd56668-6p5q5 to octavo</span>
</span><span id="__span-11-7"><a id="__codelineno-11-7" name="__codelineno-11-7" href="#__codelineno-11-7"></a><span class="go">  Normal   Pulled     11m (x3 over 43m)    kubelet            Container image "pomerium/ingress-controller:v0.31.3" already present on machine</span>
</span><span id="__span-11-8"><a id="__codelineno-11-8" name="__codelineno-11-8" href="#__codelineno-11-8"></a><span class="go">  Normal   Created    11m (x3 over 43m)    kubelet            Created container: pomerium</span>
</span><span id="__span-11-9"><a id="__codelineno-11-9" name="__codelineno-11-9" href="#__codelineno-11-9"></a><span class="go">  Normal   Started    11m (x3 over 43m)    kubelet            Started container pomerium</span>
</span><span id="__span-11-10"><a id="__codelineno-11-10" name="__codelineno-11-10" href="#__codelineno-11-10"></a><span class="go">  Normal   Killing    11m (x2 over 33m)    kubelet            Container pomerium failed startup probe, will be restarted</span>
</span><span id="__span-11-11"><a id="__codelineno-11-11" name="__codelineno-11-11" href="#__codelineno-11-11"></a><span class="go">  Warning  Unhealthy   6m (x102 over 43m)  kubelet            Startup probe failed: Get "http://10.244.0.169:28080/startupz": dial tcp 10.244.0.169:28080: connect: connection refused</span>
</span></code></pre></div>
<h3 id="certifiate-for-the-auth-endpoint">Certifiate for the auth endpoint</h3>
<p>Without a dedicated certificate for the <code>authenticate.very-very-dark-gray.top</code> domain,
users will see a security error when redirected here from other subdomains, because
Pomeriums Authenticate service is a separate internal "virtual route" that requires its
own certificate to be explicitly defined in your global settings.</p>
<p>Generate a separate certificate for the authenticate domain and link it to the Pomerium
global configuration CRD. First, create the certificate from <code>auth-certificate.yaml</code></p>
<details class="k8s" open="open">
<summary><code>auth-certificate.yaml</code></summary>
<div class="language-yaml highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-12-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-12-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-12-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-12-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-12-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-12-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-12-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-12-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-12-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-12-10">10</a></span>
<span class="normal"><a href="#__codelineno-12-11">11</a></span>
<span class="normal"><a href="#__codelineno-12-12">12</a></span>
<span class="normal"><a href="#__codelineno-12-13">13</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-12-1"><a id="__codelineno-12-1" name="__codelineno-12-1"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cert-manager.io/v1</span>
</span><span id="__span-12-2"><a id="__codelineno-12-2" name="__codelineno-12-2"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Certificate</span>
</span><span id="__span-12-3"><a id="__codelineno-12-3" name="__codelineno-12-3"></a><span class="nt">metadata</span><span class="p">:</span>
</span><span id="__span-12-4"><a id="__codelineno-12-4" name="__codelineno-12-4"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">pomerium-auth-cert</span>
</span><span id="__span-12-5"><a id="__codelineno-12-5" name="__codelineno-12-5"></a><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">pomerium</span>
</span><span id="__span-12-6"><a id="__codelineno-12-6" name="__codelineno-12-6"></a><span class="nt">spec</span><span class="p">:</span>
</span><span id="__span-12-7"><a id="__codelineno-12-7" name="__codelineno-12-7"></a><span class="w">  </span><span class="nt">secretName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">pomerium-auth-tls</span>
</span><span id="__span-12-8"><a id="__codelineno-12-8" name="__codelineno-12-8"></a><span class="w">  </span><span class="nt">issuerRef</span><span class="p">:</span>
</span><span id="__span-12-9"><a id="__codelineno-12-9" name="__codelineno-12-9"></a><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">letsencrypt-prod</span>
</span><span id="__span-12-10"><a id="__codelineno-12-10" name="__codelineno-12-10"></a><span class="w">    </span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ClusterIssuer</span>
</span><span id="__span-12-11"><a id="__codelineno-12-11" name="__codelineno-12-11"></a><span class="hll"><span class="w">  </span><span class="nt">commonName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">authenticate.very-very-dark-gray.top</span>
</span></span><span id="__span-12-12"><a id="__codelineno-12-12" name="__codelineno-12-12"></a><span class="hll"><span class="w">  </span><span class="nt">dnsNames</span><span class="p">:</span>
</span></span><span id="__span-12-13"><a id="__codelineno-12-13" name="__codelineno-12-13"></a><span class="hll"><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">authenticate.very-very-dark-gray.top</span>
</span></span></code></pre></div></td></tr></tbody></table></div>
</details>
<p>Apply this manifest to crete the certificate:</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-13-1"><a id="__codelineno-13-1" name="__codelineno-13-1" href="#__codelineno-13-1"></a><span class="gp">$ </span>kubectl<span class="w"> </span>apply<span class="w"> </span>-f<span class="w"> </span>auth-certificate.yaml
</span></code></pre></div>
<p>Wait for it to show <code>READY: True</code> via <code>kubectl get certificate -n pomerium</code> and then
link the Certificate to Pomerium Settings by updating the Pomerium CRD to reference it:</p>
<details class="k8s" open="open">
<summary><code>pomerium-settings.yaml</code></summary>
<div class="language-yaml highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-14-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-14-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-14-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-14-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-14-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-14-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-14-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-14-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-14-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-14-10">10</a></span>
<span class="normal"><a href="#__codelineno-14-11">11</a></span>
<span class="normal"><a href="#__codelineno-14-12">12</a></span>
<span class="normal"><a href="#__codelineno-14-13">13</a></span>
<span class="normal"><a href="#__codelineno-14-14">14</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-14-1"><a id="__codelineno-14-1" name="__codelineno-14-1"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ingress.pomerium.io/v1</span>
</span><span id="__span-14-2"><a id="__codelineno-14-2" name="__codelineno-14-2"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Pomerium</span>
</span><span id="__span-14-3"><a id="__codelineno-14-3" name="__codelineno-14-3"></a><span class="nt">metadata</span><span class="p">:</span>
</span><span id="__span-14-4"><a id="__codelineno-14-4" name="__codelineno-14-4"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">global</span>
</span><span id="__span-14-5"><a id="__codelineno-14-5" name="__codelineno-14-5"></a><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">pomerium</span>
</span><span id="__span-14-6"><a id="__codelineno-14-6" name="__codelineno-14-6"></a><span class="nt">spec</span><span class="p">:</span>
</span><span id="__span-14-7"><a id="__codelineno-14-7" name="__codelineno-14-7"></a><span class="w">  </span><span class="nt">secrets</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">pomerium/bootstrap</span>
</span><span id="__span-14-8"><a id="__codelineno-14-8" name="__codelineno-14-8"></a><span class="w">  </span><span class="nt">authenticate</span><span class="p">:</span>
</span><span id="__span-14-9"><a id="__codelineno-14-9" name="__codelineno-14-9"></a><span class="w">    </span><span class="nt">url</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">https://authenticate.very-very-dark-gray.top:8443</span>
</span><span id="__span-14-10"><a id="__codelineno-14-10" name="__codelineno-14-10"></a><span class="hll"><span class="w">  </span><span class="nt">certificates</span><span class="p">:</span>
</span></span><span id="__span-14-11"><a id="__codelineno-14-11" name="__codelineno-14-11"></a><span class="hll"><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">pomerium/pomerium-auth-tls</span>
</span></span><span id="__span-14-12"><a id="__codelineno-14-12" name="__codelineno-14-12"></a><span class="w">  </span><span class="nt">storage</span><span class="p">:</span>
</span><span id="__span-14-13"><a id="__codelineno-14-13" name="__codelineno-14-13"></a><span class="w">    </span><span class="nt">file</span><span class="p">:</span>
</span><span id="__span-14-14"><a id="__codelineno-14-14" name="__codelineno-14-14"></a><span class="w">      </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/data/databroker</span>
</span></code></pre></div></td></tr></tbody></table></div>
</details>
<p>And apply the updated settings: </p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-15-1"><a id="__codelineno-15-1" name="__codelineno-15-1" href="#__codelineno-15-1"></a><span class="go">kubectl apply -f pomerium-settings.yaml</span>
</span><span id="__span-15-2"><a id="__codelineno-15-2" name="__codelineno-15-2" href="#__codelineno-15-2"></a><span class="go">pomerium.ingress.pomerium.io/global configured</span>
</span></code></pre></div>
<h3 id="identity-provider-idp">Identity Provider (IdP)</h3>
<p>Before configuring the Ingress, store credentials for the chosen provider. In this case,
start with Google to authenticate @gmail.com users,
<a href="https://developers.google.com/identity/protocols/oauth2/web-server#creatingcred">create an OAuth 2.0 Client ID for Web Server Applications</a>,
obtain the client ID and secret from and store them in <code>google-idp-secret.yaml</code>:</p>
<details class="k8s" open="open">
<summary><code>google-idp-secret.yaml</code></summary>
<div class="language-yaml highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-16-1">1</a></span>
<span class="normal"><a href="#__codelineno-16-2">2</a></span>
<span class="normal"><a href="#__codelineno-16-3">3</a></span>
<span class="normal"><a href="#__codelineno-16-4">4</a></span>
<span class="normal"><a href="#__codelineno-16-5">5</a></span>
<span class="normal"><a href="#__codelineno-16-6">6</a></span>
<span class="normal"><a href="#__codelineno-16-7">7</a></span>
<span class="normal"><a href="#__codelineno-16-8">8</a></span>
<span class="normal"><a href="#__codelineno-16-9">9</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-16-1"><a id="__codelineno-16-1" name="__codelineno-16-1"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
</span><span id="__span-16-2"><a id="__codelineno-16-2" name="__codelineno-16-2"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Secret</span>
</span><span id="__span-16-3"><a id="__codelineno-16-3" name="__codelineno-16-3"></a><span class="nt">metadata</span><span class="p">:</span>
</span><span id="__span-16-4"><a id="__codelineno-16-4" name="__codelineno-16-4"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">idp-secret</span>
</span><span id="__span-16-5"><a id="__codelineno-16-5" name="__codelineno-16-5"></a><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">pomerium</span>
</span><span id="__span-16-6"><a id="__codelineno-16-6" name="__codelineno-16-6"></a><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Opaque</span>
</span><span id="__span-16-7"><a id="__codelineno-16-7" name="__codelineno-16-7"></a><span class="nt">stringData</span><span class="p">:</span>
</span><span id="__span-16-8"><a id="__codelineno-16-8" name="__codelineno-16-8"></a><span class="hll"><span class="w">  </span><span class="nt">client_id</span><span class="p">:</span><span class="w"> </span><span class="s">"your-google-client-id.apps.googleusercontent.com"</span>
</span></span><span id="__span-16-9"><a id="__codelineno-16-9" name="__codelineno-16-9"></a><span class="hll"><span class="w">  </span><span class="nt">client_secret</span><span class="p">:</span><span class="w"> </span><span class="s">"GOCSPX-your-google-client-secret"</span>
</span></span></code></pre></div></td></tr></tbody></table></div>
</details>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>In the Google Cloud Console, the OAuth consent screen should be set to <strong>External</strong>
(<a href="https://console.cloud.google.com/auth/audience?project=very-very-dark-gray"><strong>Google Auth Platform &gt; Audience</strong></a>)
when using standard @gmail.com accounts. While the app status is <strong>Testing</strong> there is
a 7-day token expiration and a 100-user limit. To increase or remove those limits,
<strong>Publish app</strong> in the Console, although this is only necessary when requesting
<a href="https://support.google.com/cloud/answer/15549945#publishing-status-testing&amp;zippy=%2Ctesting%2Cin-production%2Cexternal%2Cinternal">sensitive scopes beyond name, email address, and user profile</a>.    </p>
</div>
<p>Configure Pomerium to recognize Google as the provider and set a generous 30-day
expiration for sessions:</p>
<details class="k8s" open="open">
<summary><code>pomerium-settings.yaml</code></summary>
<div class="language-yaml highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-17-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-17-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-17-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-17-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-17-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-17-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-17-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-17-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-17-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-17-10">10</a></span>
<span class="normal"><a href="#__codelineno-17-11">11</a></span>
<span class="normal"><a href="#__codelineno-17-12">12</a></span>
<span class="normal"><a href="#__codelineno-17-13">13</a></span>
<span class="normal"><a href="#__codelineno-17-14">14</a></span>
<span class="normal"><a href="#__codelineno-17-15">15</a></span>
<span class="normal"><a href="#__codelineno-17-16">16</a></span>
<span class="normal"><a href="#__codelineno-17-17">17</a></span>
<span class="normal"><a href="#__codelineno-17-18">18</a></span>
<span class="normal"><a href="#__codelineno-17-19">19</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-17-1"><a id="__codelineno-17-1" name="__codelineno-17-1"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ingress.pomerium.io/v1</span>
</span><span id="__span-17-2"><a id="__codelineno-17-2" name="__codelineno-17-2"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Pomerium</span>
</span><span id="__span-17-3"><a id="__codelineno-17-3" name="__codelineno-17-3"></a><span class="nt">metadata</span><span class="p">:</span>
</span><span id="__span-17-4"><a id="__codelineno-17-4" name="__codelineno-17-4"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">global</span>
</span><span id="__span-17-5"><a id="__codelineno-17-5" name="__codelineno-17-5"></a><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">pomerium</span>
</span><span id="__span-17-6"><a id="__codelineno-17-6" name="__codelineno-17-6"></a><span class="nt">spec</span><span class="p">:</span>
</span><span id="__span-17-7"><a id="__codelineno-17-7" name="__codelineno-17-7"></a><span class="hll"><span class="w">  </span><span class="nt">cookie</span><span class="p">:</span>
</span></span><span id="__span-17-8"><a id="__codelineno-17-8" name="__codelineno-17-8"></a><span class="hll"><span class="w">    </span><span class="nt">expire</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">720h</span>
</span></span><span id="__span-17-9"><a id="__codelineno-17-9" name="__codelineno-17-9"></a><span class="w">  </span><span class="nt">secrets</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">pomerium/bootstrap</span>
</span><span id="__span-17-10"><a id="__codelineno-17-10" name="__codelineno-17-10"></a><span class="w">  </span><span class="nt">authenticate</span><span class="p">:</span>
</span><span id="__span-17-11"><a id="__codelineno-17-11" name="__codelineno-17-11"></a><span class="w">    </span><span class="nt">url</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">https://authenticate.very-very-dark-gray.top:8443</span>
</span><span id="__span-17-12"><a id="__codelineno-17-12" name="__codelineno-17-12"></a><span class="w">  </span><span class="nt">certificates</span><span class="p">:</span>
</span><span id="__span-17-13"><a id="__codelineno-17-13" name="__codelineno-17-13"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">pomerium/pomerium-auth-tls</span>
</span><span id="__span-17-14"><a id="__codelineno-17-14" name="__codelineno-17-14"></a><span class="hll"><span class="w">  </span><span class="nt">identityProvider</span><span class="p">:</span>
</span></span><span id="__span-17-15"><a id="__codelineno-17-15" name="__codelineno-17-15"></a><span class="hll"><span class="w">    </span><span class="nt">provider</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">google</span>
</span></span><span id="__span-17-16"><a id="__codelineno-17-16" name="__codelineno-17-16"></a><span class="hll"><span class="w">    </span><span class="nt">secret</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">pomerium/idp-secret</span>
</span></span><span id="__span-17-17"><a id="__codelineno-17-17" name="__codelineno-17-17"></a><span class="w">  </span><span class="nt">storage</span><span class="p">:</span>
</span><span id="__span-17-18"><a id="__codelineno-17-18" name="__codelineno-17-18"></a><span class="w">    </span><span class="nt">file</span><span class="p">:</span>
</span><span id="__span-17-19"><a id="__codelineno-17-19" name="__codelineno-17-19"></a><span class="w">      </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/data/databroker</span>
</span></code></pre></div></td></tr></tbody></table></div>
</details>
<p>Apply the above in this order, so the secret is available for Pomerium:</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-18-1"><a id="__codelineno-18-1" name="__codelineno-18-1" href="#__codelineno-18-1"></a><span class="gp">$ </span>kubectl<span class="w"> </span>apply<span class="w"> </span>-f<span class="w"> </span>google-idp-secret.yaml
</span><span id="__span-18-2"><a id="__codelineno-18-2" name="__codelineno-18-2" href="#__codelineno-18-2"></a><span class="go">secret/idp-secret created</span>
</span><span id="__span-18-3"><a id="__codelineno-18-3" name="__codelineno-18-3" href="#__codelineno-18-3"></a>
</span><span id="__span-18-4"><a id="__codelineno-18-4" name="__codelineno-18-4" href="#__codelineno-18-4"></a><span class="gp">$ </span>kubectl<span class="w"> </span>apply<span class="w"> </span>-f<span class="w"> </span>pomerium-settings.yaml
</span><span id="__span-18-5"><a id="__codelineno-18-5" name="__codelineno-18-5" href="#__codelineno-18-5"></a><span class="go">pomerium.ingress.pomerium.io/global configured</span>
</span></code></pre></div>
<h2 id="test-with-verify">Test with Verify</h2>
<p>To verify that the authentication and authorization flow works, use Pomerium's
<a href="https://www.pomerium.com/docs/deploy/k8s/quickstart#test-service">Test Service</a>
with an initial policy to allow only uses with @gmail.com addresses:</p>
<details class="k8s">
<summary><code>verify-service.yaml</code></summary>
<div class="language-yaml highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-19-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-19-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-19-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-19-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-19-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-19-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-19-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-19-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-19-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-19-10">10</a></span>
<span class="normal"><a href="#__codelineno-19-11">11</a></span>
<span class="normal"><a href="#__codelineno-19-12">12</a></span>
<span class="normal"><a href="#__codelineno-19-13">13</a></span>
<span class="normal"><a href="#__codelineno-19-14">14</a></span>
<span class="normal"><a href="#__codelineno-19-15">15</a></span>
<span class="normal"><a href="#__codelineno-19-16">16</a></span>
<span class="normal"><a href="#__codelineno-19-17">17</a></span>
<span class="normal"><a href="#__codelineno-19-18">18</a></span>
<span class="normal"><a href="#__codelineno-19-19">19</a></span>
<span class="normal"><a href="#__codelineno-19-20">20</a></span>
<span class="normal"><a href="#__codelineno-19-21">21</a></span>
<span class="normal"><a href="#__codelineno-19-22">22</a></span>
<span class="normal"><a href="#__codelineno-19-23">23</a></span>
<span class="normal"><a href="#__codelineno-19-24">24</a></span>
<span class="normal"><a href="#__codelineno-19-25">25</a></span>
<span class="normal"><a href="#__codelineno-19-26">26</a></span>
<span class="normal"><a href="#__codelineno-19-27">27</a></span>
<span class="normal"><a href="#__codelineno-19-28">28</a></span>
<span class="normal"><a href="#__codelineno-19-29">29</a></span>
<span class="normal"><a href="#__codelineno-19-30">30</a></span>
<span class="normal"><a href="#__codelineno-19-31">31</a></span>
<span class="normal"><a href="#__codelineno-19-32">32</a></span>
<span class="normal"><a href="#__codelineno-19-33">33</a></span>
<span class="normal"><a href="#__codelineno-19-34">34</a></span>
<span class="normal"><a href="#__codelineno-19-35">35</a></span>
<span class="normal"><a href="#__codelineno-19-36">36</a></span>
<span class="normal"><a href="#__codelineno-19-37">37</a></span>
<span class="normal"><a href="#__codelineno-19-38">38</a></span>
<span class="normal"><a href="#__codelineno-19-39">39</a></span>
<span class="normal"><a href="#__codelineno-19-40">40</a></span>
<span class="normal"><a href="#__codelineno-19-41">41</a></span>
<span class="normal"><a href="#__codelineno-19-42">42</a></span>
<span class="normal"><a href="#__codelineno-19-43">43</a></span>
<span class="normal"><a href="#__codelineno-19-44">44</a></span>
<span class="normal"><a href="#__codelineno-19-45">45</a></span>
<span class="normal"><a href="#__codelineno-19-46">46</a></span>
<span class="normal"><a href="#__codelineno-19-47">47</a></span>
<span class="normal"><a href="#__codelineno-19-48">48</a></span>
<span class="normal"><a href="#__codelineno-19-49">49</a></span>
<span class="normal"><a href="#__codelineno-19-50">50</a></span>
<span class="normal"><a href="#__codelineno-19-51">51</a></span>
<span class="normal"><a href="#__codelineno-19-52">52</a></span>
<span class="normal"><a href="#__codelineno-19-53">53</a></span>
<span class="normal"><a href="#__codelineno-19-54">54</a></span>
<span class="normal"><a href="#__codelineno-19-55">55</a></span>
<span class="normal"><a href="#__codelineno-19-56">56</a></span>
<span class="normal"><a href="#__codelineno-19-57">57</a></span>
<span class="normal"><a href="#__codelineno-19-58">58</a></span>
<span class="normal"><a href="#__codelineno-19-59">59</a></span>
<span class="normal"><a href="#__codelineno-19-60">60</a></span>
<span class="normal"><a href="#__codelineno-19-61">61</a></span>
<span class="normal"><a href="#__codelineno-19-62">62</a></span>
<span class="normal"><a href="#__codelineno-19-63">63</a></span>
<span class="normal"><a href="#__codelineno-19-64">64</a></span>
<span class="normal"><a href="#__codelineno-19-65">65</a></span>
<span class="normal"><a href="#__codelineno-19-66">66</a></span>
<span class="normal"><a href="#__codelineno-19-67">67</a></span>
<span class="normal"><a href="#__codelineno-19-68">68</a></span>
<span class="normal"><a href="#__codelineno-19-69">69</a></span>
<span class="normal"><a href="#__codelineno-19-70">70</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-19-1"><a id="__codelineno-19-1" name="__codelineno-19-1"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
</span><span id="__span-19-2"><a id="__codelineno-19-2" name="__codelineno-19-2"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Service</span>
</span><span id="__span-19-3"><a id="__codelineno-19-3" name="__codelineno-19-3"></a><span class="nt">metadata</span><span class="p">:</span>
</span><span id="__span-19-4"><a id="__codelineno-19-4" name="__codelineno-19-4"></a><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">pomerium</span>
</span><span id="__span-19-5"><a id="__codelineno-19-5" name="__codelineno-19-5"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">verify</span>
</span><span id="__span-19-6"><a id="__codelineno-19-6" name="__codelineno-19-6"></a><span class="w">  </span><span class="nt">labels</span><span class="p">:</span>
</span><span id="__span-19-7"><a id="__codelineno-19-7" name="__codelineno-19-7"></a><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">verify</span>
</span><span id="__span-19-8"><a id="__codelineno-19-8" name="__codelineno-19-8"></a><span class="w">    </span><span class="nt">service</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">verify</span>
</span><span id="__span-19-9"><a id="__codelineno-19-9" name="__codelineno-19-9"></a><span class="nt">spec</span><span class="p">:</span>
</span><span id="__span-19-10"><a id="__codelineno-19-10" name="__codelineno-19-10"></a><span class="w">  </span><span class="nt">ports</span><span class="p">:</span>
</span><span id="__span-19-11"><a id="__codelineno-19-11" name="__codelineno-19-11"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">8000</span>
</span><span id="__span-19-12"><a id="__codelineno-19-12" name="__codelineno-19-12"></a><span class="w">      </span><span class="nt">targetPort</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">8000</span>
</span><span id="__span-19-13"><a id="__codelineno-19-13" name="__codelineno-19-13"></a><span class="w">      </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">http</span>
</span><span id="__span-19-14"><a id="__codelineno-19-14" name="__codelineno-19-14"></a><span class="w">  </span><span class="nt">selector</span><span class="p">:</span>
</span><span id="__span-19-15"><a id="__codelineno-19-15" name="__codelineno-19-15"></a><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">pomerium-verify</span>
</span><span id="__span-19-16"><a id="__codelineno-19-16" name="__codelineno-19-16"></a><span class="nn">---</span>
</span><span id="__span-19-17"><a id="__codelineno-19-17" name="__codelineno-19-17"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">apps/v1</span>
</span><span id="__span-19-18"><a id="__codelineno-19-18" name="__codelineno-19-18"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Deployment</span>
</span><span id="__span-19-19"><a id="__codelineno-19-19" name="__codelineno-19-19"></a><span class="nt">metadata</span><span class="p">:</span>
</span><span id="__span-19-20"><a id="__codelineno-19-20" name="__codelineno-19-20"></a><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">pomerium</span>
</span><span id="__span-19-21"><a id="__codelineno-19-21" name="__codelineno-19-21"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">verify</span>
</span><span id="__span-19-22"><a id="__codelineno-19-22" name="__codelineno-19-22"></a><span class="nt">spec</span><span class="p">:</span>
</span><span id="__span-19-23"><a id="__codelineno-19-23" name="__codelineno-19-23"></a><span class="w">  </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1</span>
</span><span id="__span-19-24"><a id="__codelineno-19-24" name="__codelineno-19-24"></a><span class="w">  </span><span class="nt">selector</span><span class="p">:</span>
</span><span id="__span-19-25"><a id="__codelineno-19-25" name="__codelineno-19-25"></a><span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span>
</span><span id="__span-19-26"><a id="__codelineno-19-26" name="__codelineno-19-26"></a><span class="w">      </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">pomerium-verify</span>
</span><span id="__span-19-27"><a id="__codelineno-19-27" name="__codelineno-19-27"></a><span class="w">  </span><span class="nt">template</span><span class="p">:</span>
</span><span id="__span-19-28"><a id="__codelineno-19-28" name="__codelineno-19-28"></a><span class="w">    </span><span class="nt">metadata</span><span class="p">:</span>
</span><span id="__span-19-29"><a id="__codelineno-19-29" name="__codelineno-19-29"></a><span class="w">      </span><span class="nt">labels</span><span class="p">:</span>
</span><span id="__span-19-30"><a id="__codelineno-19-30" name="__codelineno-19-30"></a><span class="w">        </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">pomerium-verify</span>
</span><span id="__span-19-31"><a id="__codelineno-19-31" name="__codelineno-19-31"></a><span class="w">    </span><span class="nt">spec</span><span class="p">:</span>
</span><span id="__span-19-32"><a id="__codelineno-19-32" name="__codelineno-19-32"></a><span class="w">      </span><span class="nt">containers</span><span class="p">:</span>
</span><span id="__span-19-33"><a id="__codelineno-19-33" name="__codelineno-19-33"></a><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">docker.io/pomerium/verify</span>
</span><span id="__span-19-34"><a id="__codelineno-19-34" name="__codelineno-19-34"></a><span class="w">          </span><span class="nt">imagePullPolicy</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">IfNotPresent</span>
</span><span id="__span-19-35"><a id="__codelineno-19-35" name="__codelineno-19-35"></a><span class="w">          </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">httpbin</span>
</span><span id="__span-19-36"><a id="__codelineno-19-36" name="__codelineno-19-36"></a><span class="w">          </span><span class="nt">ports</span><span class="p">:</span>
</span><span id="__span-19-37"><a id="__codelineno-19-37" name="__codelineno-19-37"></a><span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">containerPort</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">8000</span>
</span><span id="__span-19-38"><a id="__codelineno-19-38" name="__codelineno-19-38"></a><span class="w">              </span><span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">TCP</span>
</span><span id="__span-19-39"><a id="__codelineno-19-39" name="__codelineno-19-39"></a><span class="w">              </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">http</span>
</span><span id="__span-19-40"><a id="__codelineno-19-40" name="__codelineno-19-40"></a><span class="nn">---</span>
</span><span id="__span-19-41"><a id="__codelineno-19-41" name="__codelineno-19-41"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">networking.k8s.io/v1</span>
</span><span id="__span-19-42"><a id="__codelineno-19-42" name="__codelineno-19-42"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Ingress</span>
</span><span id="__span-19-43"><a id="__codelineno-19-43" name="__codelineno-19-43"></a><span class="nt">metadata</span><span class="p">:</span>
</span><span id="__span-19-44"><a id="__codelineno-19-44" name="__codelineno-19-44"></a><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">pomerium</span>
</span><span id="__span-19-45"><a id="__codelineno-19-45" name="__codelineno-19-45"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">verify</span>
</span><span id="__span-19-46"><a id="__codelineno-19-46" name="__codelineno-19-46"></a><span class="w">  </span><span class="nt">annotations</span><span class="p">:</span>
</span><span id="__span-19-47"><a id="__codelineno-19-47" name="__codelineno-19-47"></a><span class="w">    </span><span class="nt">cert-manager.io/cluster-issuer</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">letsencrypt-prod</span>
</span><span id="__span-19-48"><a id="__codelineno-19-48" name="__codelineno-19-48"></a><span class="w">    </span><span class="nt">ingress.pomerium.io/pass_identity_headers</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
</span><span id="__span-19-49"><a id="__codelineno-19-49" name="__codelineno-19-49"></a><span class="hll"><span class="w">    </span><span class="nt">ingress.pomerium.io/policy</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
</span></span><span id="__span-19-50"><a id="__codelineno-19-50" name="__codelineno-19-50"></a><span class="hll"><span class="w">      </span><span class="no">- allow:</span>
</span></span><span id="__span-19-51"><a id="__codelineno-19-51" name="__codelineno-19-51"></a><span class="hll"><span class="w">          </span><span class="no">or:</span>
</span></span><span id="__span-19-52"><a id="__codelineno-19-52" name="__codelineno-19-52"></a><span class="hll"><span class="w">            </span><span class="no">- email:</span>
</span></span><span id="__span-19-53"><a id="__codelineno-19-53" name="__codelineno-19-53"></a><span class="hll"><span class="w">                </span><span class="no">ends_with: "@gmail.com"</span>
</span></span><span id="__span-19-54"><a id="__codelineno-19-54" name="__codelineno-19-54"></a><span class="nt">spec</span><span class="p">:</span>
</span><span id="__span-19-55"><a id="__codelineno-19-55" name="__codelineno-19-55"></a><span class="w">  </span><span class="nt">ingressClassName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">pomerium</span>
</span><span id="__span-19-56"><a id="__codelineno-19-56" name="__codelineno-19-56"></a><span class="w">  </span><span class="nt">rules</span><span class="p">:</span>
</span><span id="__span-19-57"><a id="__codelineno-19-57" name="__codelineno-19-57"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">host</span><span class="p">:</span><span class="w"> </span><span class="s">'verify.very-very-dark-gray.top'</span>
</span><span id="__span-19-58"><a id="__codelineno-19-58" name="__codelineno-19-58"></a><span class="w">      </span><span class="nt">http</span><span class="p">:</span>
</span><span id="__span-19-59"><a id="__codelineno-19-59" name="__codelineno-19-59"></a><span class="w">        </span><span class="nt">paths</span><span class="p">:</span>
</span><span id="__span-19-60"><a id="__codelineno-19-60" name="__codelineno-19-60"></a><span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">pathType</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Prefix</span>
</span><span id="__span-19-61"><a id="__codelineno-19-61" name="__codelineno-19-61"></a><span class="w">            </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/</span>
</span><span id="__span-19-62"><a id="__codelineno-19-62" name="__codelineno-19-62"></a><span class="w">            </span><span class="nt">backend</span><span class="p">:</span>
</span><span id="__span-19-63"><a id="__codelineno-19-63" name="__codelineno-19-63"></a><span class="w">              </span><span class="nt">service</span><span class="p">:</span>
</span><span id="__span-19-64"><a id="__codelineno-19-64" name="__codelineno-19-64"></a><span class="w">                </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">verify</span>
</span><span id="__span-19-65"><a id="__codelineno-19-65" name="__codelineno-19-65"></a><span class="w">                </span><span class="nt">port</span><span class="p">:</span>
</span><span id="__span-19-66"><a id="__codelineno-19-66" name="__codelineno-19-66"></a><span class="w">                  </span><span class="nt">number</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">8000</span>
</span><span id="__span-19-67"><a id="__codelineno-19-67" name="__codelineno-19-67"></a><span class="w">  </span><span class="nt">tls</span><span class="p">:</span>
</span><span id="__span-19-68"><a id="__codelineno-19-68" name="__codelineno-19-68"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">secretName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">tls-secret-verify</span>
</span><span id="__span-19-69"><a id="__codelineno-19-69" name="__codelineno-19-69"></a><span class="w">      </span><span class="nt">hosts</span><span class="p">:</span>
</span><span id="__span-19-70"><a id="__codelineno-19-70" name="__codelineno-19-70"></a><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">verify.very-very-dark-gray.top</span>
</span></code></pre></div></td></tr></tbody></table></div>
</details>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The <code>ingress.pomerium.io/allowed_domains</code> annotation and domain-based policies like
<code>'domain: is: gmail.com'</code> fail with @gmail.com users because Pomerium's domain check
looks for an OIDC claim called <strong>hd</strong> (Hosted Domain) and @gmail.com accounts do not
have an hd claim, this is only present for Google Workspace/Enterprise accounts.</p>
</div>
<p>Apply this manifest to start the verify service:</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-20-1"><a id="__codelineno-20-1" name="__codelineno-20-1" href="#__codelineno-20-1"></a><span class="gp">$ </span>kubectl<span class="w"> </span>apply<span class="w"> </span>-f<span class="w"> </span>verify-service.yaml
</span><span id="__span-20-2"><a id="__codelineno-20-2" name="__codelineno-20-2" href="#__codelineno-20-2"></a><span class="go">service/verify created</span>
</span><span id="__span-20-3"><a id="__codelineno-20-3" name="__codelineno-20-3" href="#__codelineno-20-3"></a><span class="go">deployment.apps/verify created</span>
</span><span id="__span-20-4"><a id="__codelineno-20-4" name="__codelineno-20-4" href="#__codelineno-20-4"></a><span class="go">ingress.networking.k8s.io/verify created</span>
</span></code></pre></div>
<p>Visiting <a href="https://verify.very-very-dark-gray.top:8443">https://verify.very-very-dark-gray.top:8443</a> now redirects to the Google login
page, which redirects back to the application after the user logs in and agrees to
disclose their identity to the application. When the user is authenticated with an email
address that ends with <code>@gmail.com</code> the application grants access, although it shows an
<em>Identity verification failed</em> due to other issues:</p>
<p><a class="glightbox" data-type="image" data-width="auto" data-height="auto" href="../../../../media/2025-12-18-replacing-ingress-nginx-with-pomerium/pomerium-identity-verified.png" data-desc-position="bottom"><img alt="Pomerium &quot;Identity verified&quot; page" src="../../../../media/2025-12-18-replacing-ingress-nginx-with-pomerium/pomerium-identity-verified.png"></a></p>
<details class="note">
<summary>about <strong>Identity verification failed</strong> error page.</summary>
<p>When accessing Pomerium through a non-standard HTTPS port (e.g. 8443), this page
shows an "Identity verification failed" error:</p>
<p><a class="glightbox" data-type="image" data-width="auto" data-height="auto" href="../../../../media/2025-12-18-replacing-ingress-nginx-with-pomerium/pomerium-identity-verification-failed.png" data-desc-position="bottom"><img alt="Pomerium &quot;Identity verification failed&quot; page" src="../../../../media/2025-12-18-replacing-ingress-nginx-with-pomerium/pomerium-identity-verification-failed.png"></a></p>
<p>This is because the app is unable to fetch the JWKS file due to the application
assuming it must be reachable on the standard HTTPS port 443. The file is available
on port 8443 and this can be verified using <code>wget</code> from inside the <code>verify</code> pod:</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-21-1"><a id="__codelineno-21-1" name="__codelineno-21-1" href="#__codelineno-21-1"></a><span class="gp">$ </span>kubectl<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>-it<span class="w"> </span>deployment/verify<span class="w"> </span>-n<span class="w"> </span>pomerium<span class="w"> </span>--<span class="w"> </span>wget<span class="w"> </span>-qO-<span class="w"> </span><span class="se">\</span>
</span><span id="__span-21-2"><a id="__codelineno-21-2" name="__codelineno-21-2" href="#__codelineno-21-2"></a><span class="w">  </span>https://authenticate.very-very-dark-gray.top:8443/.well-known/pomerium/jwks.json
</span><span id="__span-21-3"><a id="__codelineno-21-3" name="__codelineno-21-3" href="#__codelineno-21-3"></a><span class="go">wget: note: TLS certificate validation not implemented</span>
</span><span id="__span-21-4"><a id="__codelineno-21-4" name="__codelineno-21-4" href="#__codelineno-21-4"></a><span class="go">{"keys":[{"use":"sig","kty":"EC","kid":"...","crv":"P-256","alg":"ES256","x":"...","y":"..."}]</span>
</span></code></pre></div>
</details>
<p>If the user is denied access, e.g. logged in with an email address on a different domain,
then the result is a clear <em>403 Forbidden</em> page:</p>
<p><a class="glightbox" data-type="image" data-width="auto" data-height="auto" href="../../../../media/2025-12-18-replacing-ingress-nginx-with-pomerium/pomerium-verify-403-forbidden.png" data-desc-position="bottom"><img alt="Pomerium &quot;403 Forbidden&quot; page" src="../../../../media/2025-12-18-replacing-ingress-nginx-with-pomerium/pomerium-verify-403-forbidden.png"></a></p>
<h2 id="additional-settings">Additional Settings</h2>
<p>To replace the existing Nginx-based <code>Ingress</code> for currently running applications,
additional settings are necessary for specific purposes.</p>
<h3 id="access-control-for-users">Access Control for Users</h3>
<p>To restrict access to a concrete list of users by their email address, replace the above
<code>allow</code> with a list of <code>'email: is: user@gmail.com'</code> conditions under the <code>or</code> condition:</p>
<div class="language-yaml highlight"><pre><span></span><code><span id="__span-22-1"><a id="__codelineno-22-1" name="__codelineno-22-1" href="#__codelineno-22-1"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">networking.k8s.io/v1</span>
</span><span id="__span-22-2"><a id="__codelineno-22-2" name="__codelineno-22-2" href="#__codelineno-22-2"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Ingress</span>
</span><span id="__span-22-3"><a id="__codelineno-22-3" name="__codelineno-22-3" href="#__codelineno-22-3"></a><span class="nt">metadata</span><span class="p">:</span>
</span><span id="__span-22-4"><a id="__codelineno-22-4" name="__codelineno-22-4" href="#__codelineno-22-4"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">audiobookshelf-ingress</span>
</span><span id="__span-22-5"><a id="__codelineno-22-5" name="__codelineno-22-5" href="#__codelineno-22-5"></a><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">audiobookshelf</span>
</span><span id="__span-22-6"><a id="__codelineno-22-6" name="__codelineno-22-6" href="#__codelineno-22-6"></a><span class="w">  </span><span class="nt">annotations</span><span class="p">:</span>
</span><span id="__span-22-7"><a id="__codelineno-22-7" name="__codelineno-22-7" href="#__codelineno-22-7"></a><span class="w">    </span><span class="nt">cert-manager.io/cluster-issuer</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">letsencrypt-prod</span>
</span><span id="__span-22-8"><a id="__codelineno-22-8" name="__codelineno-22-8" href="#__codelineno-22-8"></a><span class="w">    </span><span class="nt">ingress.pomerium.io/pass_identity_headers</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
</span><span id="__span-22-9"><a id="__codelineno-22-9" name="__codelineno-22-9" href="#__codelineno-22-9"></a><span class="hll"><span class="w">    </span><span class="nt">ingress.pomerium.io/policy</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
</span></span><span id="__span-22-10"><a id="__codelineno-22-10" name="__codelineno-22-10" href="#__codelineno-22-10"></a><span class="hll"><span class="w">      </span><span class="no">- allow:</span>
</span></span><span id="__span-22-11"><a id="__codelineno-22-11" name="__codelineno-22-11" href="#__codelineno-22-11"></a><span class="hll"><span class="w">          </span><span class="no">or:</span>
</span></span><span id="__span-22-12"><a id="__codelineno-22-12" name="__codelineno-22-12" href="#__codelineno-22-12"></a><span class="hll"><span class="w">            </span><span class="no">- email:</span>
</span></span><span id="__span-22-13"><a id="__codelineno-22-13" name="__codelineno-22-13" href="#__codelineno-22-13"></a><span class="hll"><span class="w">                </span><span class="no">is: "alice@gmail.com"</span>
</span></span><span id="__span-22-14"><a id="__codelineno-22-14" name="__codelineno-22-14" href="#__codelineno-22-14"></a><span class="hll"><span class="w">            </span><span class="no">- email:</span>
</span></span><span id="__span-22-15"><a id="__codelineno-22-15" name="__codelineno-22-15" href="#__codelineno-22-15"></a><span class="hll"><span class="w">                </span><span class="no">is: "bob@gmail.com"</span>
</span></span></code></pre></div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>The YAML parser will fail when multiple operator ending with a colon (<code>:</code>) are put
on a single line (<code>email: is: "bob@gmail.com"</code>). The correct syntax is to either put
each operator ending with a colon (<code>:</code>) on its own line (as seen above), or to wrap
the entire condition in single quotes (<code>'email: is: "bob@gmail.com"'</code>).</p>
</div>
<h3 id="api-access">API access</h3>
<p>Each service that exposes an API, authenticated or not, needs an additional <code>allow</code>
policy to allow traffic directed to the API, so that it bypasses Pomerium authentication
and relies instead on the API's own authentication. This policy should match <strong>only</strong>
requests to the APIs used by applications other than web frontends, to keep Web frontends
protected by Pomerium while allowing traffic to the APIs from mobile apps, etc.</p>
<p>Finding the required <code>path</code> prefixes for each service is best done by consulting their
API reference. In cases where that turns out to be not enough, Pomerium logs can be
filtered for specific lines to find URL paths for those requests that are not allowed:</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-23-1"><a id="__codelineno-23-1" name="__codelineno-23-1" href="#__codelineno-23-1"></a><span class="ch">#!/bin/bash</span>
</span><span id="__span-23-2"><a id="__codelineno-23-2" name="__codelineno-23-2" href="#__codelineno-23-2"></a><span class="c1"># Extrat URL paths for requests going through Pomerium</span>
</span><span id="__span-23-3"><a id="__codelineno-23-3" name="__codelineno-23-3" href="#__codelineno-23-3"></a>
</span><span id="__span-23-4"><a id="__codelineno-23-4" name="__codelineno-23-4" href="#__codelineno-23-4"></a><span class="nv">pod</span><span class="o">=</span><span class="k">$(</span>kubectl<span class="w"> </span>get<span class="w"> </span>pods<span class="w"> </span>-n<span class="w"> </span>pomerium<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span><span class="s2">"^pomerium-.*Running"</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>awk<span class="w"> </span><span class="s1">'{print $1}'</span><span class="k">)</span>
</span><span id="__span-23-5"><a id="__codelineno-23-5" name="__codelineno-23-5" href="#__codelineno-23-5"></a><span class="nb">echo</span><span class="w"> </span><span class="nv">$pod</span>
</span><span id="__span-23-6"><a id="__codelineno-23-6" name="__codelineno-23-6" href="#__codelineno-23-6"></a>
</span><span id="__span-23-7"><a id="__codelineno-23-7" name="__codelineno-23-7" href="#__codelineno-23-7"></a>kubectl<span class="w"> </span>get<span class="w"> </span>ingress<span class="w"> </span>-A<span class="w"> </span><span class="p">|</span><span class="w"> </span>awk<span class="w"> </span><span class="s1">'NR &gt; 1 {print $1, $2, $3, $4}'</span><span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="se">\</span>
</span><span id="__span-23-8"><a id="__codelineno-23-8" name="__codelineno-23-8" href="#__codelineno-23-8"></a><span class="k">while</span><span class="w"> </span><span class="nv">IFS</span><span class="o">=</span><span class="s1">$' '</span><span class="w"> </span><span class="nb">read</span><span class="w"> </span>-r<span class="w"> </span>namespace<span class="w"> </span>name<span class="w"> </span>class<span class="w"> </span>host<span class="p">;</span><span class="w"> </span><span class="k">do</span>
</span><span id="__span-23-9"><a id="__codelineno-23-9" name="__codelineno-23-9" href="#__codelineno-23-9"></a><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="o">[[</span><span class="w"> </span><span class="s2">"</span><span class="nv">$class</span><span class="s2">"</span><span class="w"> </span>!<span class="o">=</span><span class="w"> </span><span class="s2">"pomerium"</span><span class="w"> </span><span class="o">]]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span><span class="w"> </span><span class="k">continue</span><span class="p">;</span><span class="w"> </span><span class="k">fi</span>
</span><span id="__span-23-10"><a id="__codelineno-23-10" name="__codelineno-23-10" href="#__codelineno-23-10"></a><span class="w">  </span><span class="nb">echo</span><span class="w">  </span><span class="s2">"requests to </span><span class="si">${</span><span class="nv">host</span><span class="si">}</span><span class="s2"> via </span><span class="si">${</span><span class="nv">name</span><span class="si">}</span><span class="s2">: "</span>
</span><span id="__span-23-11"><a id="__codelineno-23-11" name="__codelineno-23-11" href="#__codelineno-23-11"></a><span class="w">  </span>kubectl<span class="w"> </span>logs<span class="w"> </span><span class="s2">"</span><span class="si">${</span><span class="nv">pod</span><span class="si">}</span><span class="s2">"</span><span class="w"> </span>-n<span class="w"> </span>pomerium<span class="w"> </span><span class="se">\</span>
</span><span id="__span-23-12"><a id="__codelineno-23-12" name="__codelineno-23-12" href="#__codelineno-23-12"></a><span class="w">  </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span><span class="s2">"authority.*</span><span class="si">${</span><span class="nv">host</span><span class="si">}</span><span class="s2">"</span><span class="w"> </span><span class="se">\</span>
</span><span id="__span-23-13"><a id="__codelineno-23-13" name="__codelineno-23-13" href="#__codelineno-23-13"></a><span class="w">  </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>-v<span class="w"> </span><span class="s1">'"response-code":200'</span><span class="w"> </span><span class="se">\</span>
</span><span id="__span-23-14"><a id="__codelineno-23-14" name="__codelineno-23-14" href="#__codelineno-23-14"></a><span class="w">  </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>-oE<span class="w"> </span><span class="s1">'"path":"[^"]+"'</span><span class="w"> </span><span class="se">\</span>
</span><span id="__span-23-15"><a id="__codelineno-23-15" name="__codelineno-23-15" href="#__codelineno-23-15"></a><span class="w">  </span><span class="p">|</span><span class="w"> </span>cut<span class="w"> </span>-f4<span class="w"> </span>-d<span class="s1">'"'</span><span class="w"> </span><span class="se">\</span>
</span><span id="__span-23-16"><a id="__codelineno-23-16" name="__codelineno-23-16" href="#__codelineno-23-16"></a><span class="w">  </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>-oE<span class="w"> </span><span class="s1">'^/[^/]+'</span><span class="w"> </span><span class="se">\</span>
</span><span id="__span-23-17"><a id="__codelineno-23-17" name="__codelineno-23-17" href="#__codelineno-23-17"></a><span class="w">  </span><span class="p">|</span><span class="w"> </span>sort<span class="w"> </span>-u
</span><span id="__span-23-18"><a id="__codelineno-23-18" name="__codelineno-23-18" href="#__codelineno-23-18"></a><span class="k">done</span>
</span></code></pre></div>
<h4 id="audiobookshelf">Audiobookshelf</h4>
<p>The <a href="https://api.audiobookshelf.org/">Audiobookshelf API reference</a> turned out not so
convenient to find all the URL paths needed for the 
<a href="https://play.google.com/store/apps/details?id=com.audiobookshelf.app&amp;hl=en">Audiobookshelf Android app</a>,
the above method of filtering Pomerium logs was needed to find the following prefixes:</p>
<div class="language-yaml highlight"><pre><span></span><code><span id="__span-24-1"><a id="__codelineno-24-1" name="__codelineno-24-1" href="#__codelineno-24-1"></a><span class="nt">metadata</span><span class="p">:</span>
</span><span id="__span-24-2"><a id="__codelineno-24-2" name="__codelineno-24-2" href="#__codelineno-24-2"></a><span class="w">  </span><span class="nt">annotations</span><span class="p">:</span>
</span><span id="__span-24-3"><a id="__codelineno-24-3" name="__codelineno-24-3" href="#__codelineno-24-3"></a><span class="w">    </span><span class="l l-Scalar l-Scalar-Plain">...</span>
</span><span id="__span-24-4"><a id="__codelineno-24-4" name="__codelineno-24-4" href="#__codelineno-24-4"></a><span class="w">    </span><span class="l l-Scalar l-Scalar-Plain">ingress.pomerium.io/policy</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
</span><span id="__span-24-5"><a id="__codelineno-24-5" name="__codelineno-24-5" href="#__codelineno-24-5"></a><span class="hll"><span class="w">      </span><span class="no">- allow:</span>
</span></span><span id="__span-24-6"><a id="__codelineno-24-6" name="__codelineno-24-6" href="#__codelineno-24-6"></a><span class="hll"><span class="w">          </span><span class="no">or:</span>
</span></span><span id="__span-24-7"><a id="__codelineno-24-7" name="__codelineno-24-7" href="#__codelineno-24-7"></a><span class="hll"><span class="w">            </span><span class="no">- http_path:</span>
</span></span><span id="__span-24-8"><a id="__codelineno-24-8" name="__codelineno-24-8" href="#__codelineno-24-8"></a><span class="hll"><span class="w">                </span><span class="no">starts_with: "/api"</span>
</span></span><span id="__span-24-9"><a id="__codelineno-24-9" name="__codelineno-24-9" href="#__codelineno-24-9"></a><span class="hll"><span class="w">            </span><span class="no">- http_path:</span>
</span></span><span id="__span-24-10"><a id="__codelineno-24-10" name="__codelineno-24-10" href="#__codelineno-24-10"></a><span class="hll"><span class="w">                </span><span class="no">starts_with: "/auth/refresh"</span>
</span></span><span id="__span-24-11"><a id="__codelineno-24-11" name="__codelineno-24-11" href="#__codelineno-24-11"></a><span class="hll"><span class="w">            </span><span class="no">- http_path:</span>
</span></span><span id="__span-24-12"><a id="__codelineno-24-12" name="__codelineno-24-12" href="#__codelineno-24-12"></a><span class="hll"><span class="w">                </span><span class="no">starts_with: "/audiobookshelf/socket.io"</span>
</span></span><span id="__span-24-13"><a id="__codelineno-24-13" name="__codelineno-24-13" href="#__codelineno-24-13"></a><span class="hll"><span class="w">            </span><span class="no">- http_path:</span>
</span></span><span id="__span-24-14"><a id="__codelineno-24-14" name="__codelineno-24-14" href="#__codelineno-24-14"></a><span class="hll"><span class="w">                </span><span class="no">starts_with: "/hls"</span>
</span></span><span id="__span-24-15"><a id="__codelineno-24-15" name="__codelineno-24-15" href="#__codelineno-24-15"></a><span class="hll"><span class="w">            </span><span class="no">- http_path:</span>
</span></span><span id="__span-24-16"><a id="__codelineno-24-16" name="__codelineno-24-16" href="#__codelineno-24-16"></a><span class="hll"><span class="w">                </span><span class="no">starts_with: "/login"</span>
</span></span><span id="__span-24-17"><a id="__codelineno-24-17" name="__codelineno-24-17" href="#__codelineno-24-17"></a><span class="hll"><span class="w">            </span><span class="no">- http_path:</span>
</span></span><span id="__span-24-18"><a id="__codelineno-24-18" name="__codelineno-24-18" href="#__codelineno-24-18"></a><span class="hll"><span class="w">                </span><span class="no">starts_with: "/public"</span>
</span></span><span id="__span-24-19"><a id="__codelineno-24-19" name="__codelineno-24-19" href="#__codelineno-24-19"></a><span class="hll"><span class="w">            </span><span class="no">- http_path:</span>
</span></span><span id="__span-24-20"><a id="__codelineno-24-20" name="__codelineno-24-20" href="#__codelineno-24-20"></a><span class="hll"><span class="w">                </span><span class="no">starts_with: "/socket.io"</span>
</span></span><span id="__span-24-21"><a id="__codelineno-24-21" name="__codelineno-24-21" href="#__codelineno-24-21"></a><span class="hll"><span class="w">            </span><span class="no">- http_path:</span>
</span></span><span id="__span-24-22"><a id="__codelineno-24-22" name="__codelineno-24-22" href="#__codelineno-24-22"></a><span class="hll"><span class="w">                </span><span class="no">starts_with: "/status"</span>
</span></span><span id="__span-24-23"><a id="__codelineno-24-23" name="__codelineno-24-23" href="#__codelineno-24-23"></a><span class="w">      </span><span class="no">- allow:</span>
</span><span id="__span-24-24"><a id="__codelineno-24-24" name="__codelineno-24-24" href="#__codelineno-24-24"></a><span class="w">          </span><span class="no">or:</span>
</span><span id="__span-24-25"><a id="__codelineno-24-25" name="__codelineno-24-25" href="#__codelineno-24-25"></a><span class="w">            </span><span class="no">- email:</span>
</span></code></pre></div>
<h4 id="firefly-iii">Firefly III</h4>
<p><a href="../../../../2024/05/19/self-hosted-accountancy-with-firefly-iii/">Firefly III</a> includes a
<a href="https://docs.firefly-iii.org/how-to/firefly-iii/features/api/">REST-based JSON API</a>
all under a single <code>/v1</code> prefix (full reference at <a href="https://api-docs.firefly-iii.org/">https://api-docs.firefly-iii.org/</a>).
The application itself is not actually in use, but that single prefix is all that would
be necessary to <code>allow</code> if it was to be used, e.g. from
<a href="https://community.home-assistant.io/t/anyone-doing-anything-with-the-firefly-iii-api/433491/10">a Home Assistant integration</a>.</p>
<h4 id="grafana">Grafana</h4>
<p><a href="https://grafana.com/docs/grafana/latest/developer-resources/api-reference/http-api/">Grafana HTTP API reference</a>
suggests the entire API is under <code>/api</code>, including authentication.</p>
<h4 id="influxdb">InfluxDB</h4>
<p><a href="../../../../2024/04/20/monitoring-with-influxdb-and-grafana-on-kubernetes/#influxdb-authentication">InfluxDB Authentication</a>
being enabled for all exposed endpoints, similar rules are added to bypass Pomerium
authentication for the relevant API paths. There is no policy to allow human users
because this API is not meant to be accessed directly by users from browsers.</p>
<p>All the legacy
<a href="https://docs.influxdata.com/influxdb/v1/tools/api/#influxdb-1x-http-endpoints">InfluxDB 1.x HTTP endpoints</a>
are under the following prefixes:</p>
<div class="language-yaml highlight"><pre><span></span><code><span id="__span-25-1"><a id="__codelineno-25-1" name="__codelineno-25-1" href="#__codelineno-25-1"></a><span class="nt">metadata</span><span class="p">:</span>
</span><span id="__span-25-2"><a id="__codelineno-25-2" name="__codelineno-25-2" href="#__codelineno-25-2"></a><span class="w">  </span><span class="nt">annotations</span><span class="p">:</span>
</span><span id="__span-25-3"><a id="__codelineno-25-3" name="__codelineno-25-3" href="#__codelineno-25-3"></a><span class="w">    </span><span class="l l-Scalar l-Scalar-Plain">...</span>
</span><span id="__span-25-4"><a id="__codelineno-25-4" name="__codelineno-25-4" href="#__codelineno-25-4"></a><span class="w">    </span><span class="l l-Scalar l-Scalar-Plain">ingress.pomerium.io/policy</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
</span><span id="__span-25-5"><a id="__codelineno-25-5" name="__codelineno-25-5" href="#__codelineno-25-5"></a><span class="hll"><span class="w">      </span><span class="no">- allow:</span>
</span></span><span id="__span-25-6"><a id="__codelineno-25-6" name="__codelineno-25-6" href="#__codelineno-25-6"></a><span class="hll"><span class="w">          </span><span class="no">or:</span>
</span></span><span id="__span-25-7"><a id="__codelineno-25-7" name="__codelineno-25-7" href="#__codelineno-25-7"></a><span class="hll"><span class="w">            </span><span class="no">- http_path:</span>
</span></span><span id="__span-25-8"><a id="__codelineno-25-8" name="__codelineno-25-8" href="#__codelineno-25-8"></a><span class="hll"><span class="w">                </span><span class="no">starts_with: "/debug"</span>
</span></span><span id="__span-25-9"><a id="__codelineno-25-9" name="__codelineno-25-9" href="#__codelineno-25-9"></a><span class="hll"><span class="w">            </span><span class="no">- http_path:</span>
</span></span><span id="__span-25-10"><a id="__codelineno-25-10" name="__codelineno-25-10" href="#__codelineno-25-10"></a><span class="hll"><span class="w">                </span><span class="no">starts_with: "/ping"</span>
</span></span><span id="__span-25-11"><a id="__codelineno-25-11" name="__codelineno-25-11" href="#__codelineno-25-11"></a><span class="hll"><span class="w">            </span><span class="no">- http_path:</span>
</span></span><span id="__span-25-12"><a id="__codelineno-25-12" name="__codelineno-25-12" href="#__codelineno-25-12"></a><span class="hll"><span class="w">                </span><span class="no">starts_with: "/query"</span>
</span></span><span id="__span-25-13"><a id="__codelineno-25-13" name="__codelineno-25-13" href="#__codelineno-25-13"></a><span class="hll"><span class="w">            </span><span class="no">- http_path:</span>
</span></span><span id="__span-25-14"><a id="__codelineno-25-14" name="__codelineno-25-14" href="#__codelineno-25-14"></a><span class="hll"><span class="w">                </span><span class="no">starts_with: "/write"</span>
</span></span></code></pre></div>
<h4 id="komga">Komga</h4>
<p>The <a href="../../../../2024/05/26/self-hosted-ebook-library-with-komga/">Komga eBook library</a> exposes
several API endpoints to make books
<a href="../../../../2024/05/26/self-hosted-ebook-library-with-komga/#ereaders">accessible to eReaders</a>
and these all need to be allowed without enforcing the Gmail-based authentication:</p>
<div class="language-yaml highlight"><pre><span></span><code><span id="__span-26-1"><a id="__codelineno-26-1" name="__codelineno-26-1" href="#__codelineno-26-1"></a><span class="nt">metadata</span><span class="p">:</span>
</span><span id="__span-26-2"><a id="__codelineno-26-2" name="__codelineno-26-2" href="#__codelineno-26-2"></a><span class="w">  </span><span class="nt">annotations</span><span class="p">:</span>
</span><span id="__span-26-3"><a id="__codelineno-26-3" name="__codelineno-26-3" href="#__codelineno-26-3"></a><span class="w">    </span><span class="l l-Scalar l-Scalar-Plain">...</span>
</span><span id="__span-26-4"><a id="__codelineno-26-4" name="__codelineno-26-4" href="#__codelineno-26-4"></a><span class="w">    </span><span class="l l-Scalar l-Scalar-Plain">ingress.pomerium.io/policy</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
</span><span id="__span-26-5"><a id="__codelineno-26-5" name="__codelineno-26-5" href="#__codelineno-26-5"></a><span class="hll"><span class="w">      </span><span class="no">- allow:</span>
</span></span><span id="__span-26-6"><a id="__codelineno-26-6" name="__codelineno-26-6" href="#__codelineno-26-6"></a><span class="hll"><span class="w">          </span><span class="no">or:</span>
</span></span><span id="__span-26-7"><a id="__codelineno-26-7" name="__codelineno-26-7" href="#__codelineno-26-7"></a><span class="hll"><span class="w">            </span><span class="no">- http_path:</span>
</span></span><span id="__span-26-8"><a id="__codelineno-26-8" name="__codelineno-26-8" href="#__codelineno-26-8"></a><span class="hll"><span class="w">                </span><span class="no">starts_with: "/api"</span>
</span></span><span id="__span-26-9"><a id="__codelineno-26-9" name="__codelineno-26-9" href="#__codelineno-26-9"></a><span class="hll"><span class="w">            </span><span class="no">- http_path:</span>
</span></span><span id="__span-26-10"><a id="__codelineno-26-10" name="__codelineno-26-10" href="#__codelineno-26-10"></a><span class="hll"><span class="w">                </span><span class="no">starts_with: "/kobo"</span>
</span></span><span id="__span-26-11"><a id="__codelineno-26-11" name="__codelineno-26-11" href="#__codelineno-26-11"></a><span class="hll"><span class="w">            </span><span class="no">- http_path:</span>
</span></span><span id="__span-26-12"><a id="__codelineno-26-12" name="__codelineno-26-12" href="#__codelineno-26-12"></a><span class="hll"><span class="w">                </span><span class="no">starts_with: "/opds"</span>
</span></span><span id="__span-26-13"><a id="__codelineno-26-13" name="__codelineno-26-13" href="#__codelineno-26-13"></a><span class="hll"><span class="w">            </span><span class="no">- http_path:</span>
</span></span><span id="__span-26-14"><a id="__codelineno-26-14" name="__codelineno-26-14" href="#__codelineno-26-14"></a><span class="hll"><span class="w">                </span><span class="no">starts_with: "//sse"</span>
</span></span><span id="__span-26-15"><a id="__codelineno-26-15" name="__codelineno-26-15" href="#__codelineno-26-15"></a><span class="w">      </span><span class="no">- allow:</span>
</span><span id="__span-26-16"><a id="__codelineno-26-16" name="__codelineno-26-16" href="#__codelineno-26-16"></a><span class="w">          </span><span class="no">or:</span>
</span><span id="__span-26-17"><a id="__codelineno-26-17" name="__codelineno-26-17" href="#__codelineno-26-17"></a><span class="w">            </span><span class="no">- email:</span>
</span></code></pre></div>
<h4 id="home-assistant">Home Assistant</h4>
<p>Home Assistant hosts a
<a href="https://developers.home-assistant.io/docs/api/websocket">WebSocket API at <code>/api/websocket</code></a>
and a <a href="https://developers.home-assistant.io/docs/api/rest">RESTful API at <code>/api</code></a>,
which needs to be allowed for the Home Assistant mobile app. In addition to that,
Home Assistant <a href="https://developers.home-assistant.io/docs/auth_api">Authentication API</a>
also needs to be allowed for the Home Assistant mobile app to be able to directly
authenticate against the service.</p>
<div class="language-yaml highlight"><pre><span></span><code><span id="__span-27-1"><a id="__codelineno-27-1" name="__codelineno-27-1" href="#__codelineno-27-1"></a><span class="nt">metadata</span><span class="p">:</span>
</span><span id="__span-27-2"><a id="__codelineno-27-2" name="__codelineno-27-2" href="#__codelineno-27-2"></a><span class="w">  </span><span class="nt">annotations</span><span class="p">:</span>
</span><span id="__span-27-3"><a id="__codelineno-27-3" name="__codelineno-27-3" href="#__codelineno-27-3"></a><span class="w">    </span><span class="l l-Scalar l-Scalar-Plain">...</span>
</span><span id="__span-27-4"><a id="__codelineno-27-4" name="__codelineno-27-4" href="#__codelineno-27-4"></a><span class="w">    </span><span class="l l-Scalar l-Scalar-Plain">ingress.pomerium.io/policy</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
</span><span id="__span-27-5"><a id="__codelineno-27-5" name="__codelineno-27-5" href="#__codelineno-27-5"></a><span class="hll"><span class="w">      </span><span class="no">- allow:</span>
</span></span><span id="__span-27-6"><a id="__codelineno-27-6" name="__codelineno-27-6" href="#__codelineno-27-6"></a><span class="hll"><span class="w">          </span><span class="no">or:</span>
</span></span><span id="__span-27-7"><a id="__codelineno-27-7" name="__codelineno-27-7" href="#__codelineno-27-7"></a><span class="hll"><span class="w">            </span><span class="no">- http_path:</span>
</span></span><span id="__span-27-8"><a id="__codelineno-27-8" name="__codelineno-27-8" href="#__codelineno-27-8"></a><span class="hll"><span class="w">                </span><span class="no">starts_with: "/api"</span>
</span></span><span id="__span-27-9"><a id="__codelineno-27-9" name="__codelineno-27-9" href="#__codelineno-27-9"></a><span class="hll"><span class="w">            </span><span class="no">- http_path:</span>
</span></span><span id="__span-27-10"><a id="__codelineno-27-10" name="__codelineno-27-10" href="#__codelineno-27-10"></a><span class="hll"><span class="w">                </span><span class="no">starts_with: "/auth"</span>
</span></span><span id="__span-27-11"><a id="__codelineno-27-11" name="__codelineno-27-11" href="#__codelineno-27-11"></a><span class="w">      </span><span class="no">- allow:</span>
</span><span id="__span-27-12"><a id="__codelineno-27-12" name="__codelineno-27-12" href="#__codelineno-27-12"></a><span class="w">          </span><span class="no">or:</span>
</span><span id="__span-27-13"><a id="__codelineno-27-13" name="__codelineno-27-13" href="#__codelineno-27-13"></a><span class="w">            </span><span class="no">- email:</span>
</span></code></pre></div>
<h4 id="jellyfin">Jellyfin</h4>
<p>To keep the Web UI locked by Pomerium while allowing traffic from mobile apps in, allow
API paths to bypass authentication; the Jellyfin API uses a few path prefixes:</p>
<p>Jellyfin API reference can be downloaded from <a href="https://api.jellyfin.org/">https://api.jellyfin.org/</a> as a
<a href="https://api.jellyfin.org/openapi/jellyfin-openapi-stable.json">JSON file</a> and
API <code>path</code> prefixes can be extracted from the keys in its <code>paths[]</code> object. This way,
the full list of request path prefixes can be extracted easily:</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-28-1"><a id="__codelineno-28-1" name="__codelineno-28-1" href="#__codelineno-28-1"></a><span class="ch">#!/bin/bash</span>
</span><span id="__span-28-2"><a id="__codelineno-28-2" name="__codelineno-28-2" href="#__codelineno-28-2"></a><span class="c1"># Extrat request path prefixes from the Jellyfin API reference.</span>
</span><span id="__span-28-3"><a id="__codelineno-28-3" name="__codelineno-28-3" href="#__codelineno-28-3"></a><span class="nv">json</span><span class="o">=</span><span class="nv">$1</span>
</span><span id="__span-28-4"><a id="__codelineno-28-4" name="__codelineno-28-4" href="#__codelineno-28-4"></a>
</span><span id="__span-28-5"><a id="__codelineno-28-5" name="__codelineno-28-5" href="#__codelineno-28-5"></a>jq<span class="w"> </span>-r<span class="w"> </span><span class="s1">'.paths | keys[]'</span><span class="w"> </span><span class="si">${</span><span class="nv">json</span><span class="si">}</span><span class="w"> </span><span class="se">\</span>
</span><span id="__span-28-6"><a id="__codelineno-28-6" name="__codelineno-28-6" href="#__codelineno-28-6"></a><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>-oE<span class="w"> </span><span class="s1">'^/[^/]+'</span><span class="w"> </span><span class="se">\</span>
</span><span id="__span-28-7"><a id="__codelineno-28-7" name="__codelineno-28-7" href="#__codelineno-28-7"></a><span class="p">|</span><span class="w"> </span>sort<span class="w"> </span>-u<span class="w"> </span><span class="se">\</span>
</span><span id="__span-28-8"><a id="__codelineno-28-8" name="__codelineno-28-8" href="#__codelineno-28-8"></a><span class="p">|</span><span class="w"> </span><span class="k">while</span><span class="w"> </span><span class="nb">read</span><span class="w"> </span>dir<span class="p">;</span><span class="w"> </span><span class="k">do</span>
</span><span id="__span-28-9"><a id="__codelineno-28-9" name="__codelineno-28-9" href="#__codelineno-28-9"></a>cat<span class="w"> </span><span class="s">&lt;&lt; ___EOF___</span>
</span><span id="__span-28-10"><a id="__codelineno-28-10" name="__codelineno-28-10" href="#__codelineno-28-10"></a><span class="s">                - http_path:</span>
</span><span id="__span-28-11"><a id="__codelineno-28-11" name="__codelineno-28-11" href="#__codelineno-28-11"></a><span class="s">                    starts_with: "${dir}"</span>
</span><span id="__span-28-12"><a id="__codelineno-28-12" name="__codelineno-28-12" href="#__codelineno-28-12"></a><span class="s">___EOF___</span>
</span><span id="__span-28-13"><a id="__codelineno-28-13" name="__codelineno-28-13" href="#__codelineno-28-13"></a><span class="k">done</span>
</span></code></pre></div>
<p>The list of prefixes may need to be updated when the API changes.</p>
<div class="language-yaml highlight"><pre><span></span><code><span id="__span-29-1"><a id="__codelineno-29-1" name="__codelineno-29-1" href="#__codelineno-29-1"></a><span class="nt">metadata</span><span class="p">:</span>
</span><span id="__span-29-2"><a id="__codelineno-29-2" name="__codelineno-29-2" href="#__codelineno-29-2"></a><span class="w">  </span><span class="nt">annotations</span><span class="p">:</span>
</span><span id="__span-29-3"><a id="__codelineno-29-3" name="__codelineno-29-3" href="#__codelineno-29-3"></a><span class="w">    </span><span class="l l-Scalar l-Scalar-Plain">...</span>
</span><span id="__span-29-4"><a id="__codelineno-29-4" name="__codelineno-29-4" href="#__codelineno-29-4"></a><span class="w">    </span><span class="l l-Scalar l-Scalar-Plain">ingress.pomerium.io/policy</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
</span><span id="__span-29-5"><a id="__codelineno-29-5" name="__codelineno-29-5" href="#__codelineno-29-5"></a><span class="hll"><span class="w">      </span><span class="no">- allow:</span>
</span></span><span id="__span-29-6"><a id="__codelineno-29-6" name="__codelineno-29-6" href="#__codelineno-29-6"></a><span class="hll"><span class="w">          </span><span class="no">or:</span>
</span></span><span id="__span-29-7"><a id="__codelineno-29-7" name="__codelineno-29-7" href="#__codelineno-29-7"></a><span class="hll"><span class="w">            </span><span class="no">- http_path:</span>
</span></span><span id="__span-29-8"><a id="__codelineno-29-8" name="__codelineno-29-8" href="#__codelineno-29-8"></a><span class="hll"><span class="w">                </span><span class="no">starts_with: "/api"</span>
</span></span><span id="__span-29-9"><a id="__codelineno-29-9" name="__codelineno-29-9" href="#__codelineno-29-9"></a><span class="hll"><span class="w">            </span><span class="no">- http_path:</span>
</span></span><span id="__span-29-10"><a id="__codelineno-29-10" name="__codelineno-29-10" href="#__codelineno-29-10"></a><span class="hll"><span class="w">                </span><span class="no">starts_with: "/Users/Public"</span>
</span></span><span id="__span-29-11"><a id="__codelineno-29-11" name="__codelineno-29-11" href="#__codelineno-29-11"></a><span class="hll"><span class="w">            </span><span class="no">- http_path:</span>
</span></span><span id="__span-29-12"><a id="__codelineno-29-12" name="__codelineno-29-12" href="#__codelineno-29-12"></a><span class="hll"><span class="w">                </span><span class="no">starts_with: "/System/Info/Public"</span>
</span></span><span id="__span-29-13"><a id="__codelineno-29-13" name="__codelineno-29-13" href="#__codelineno-29-13"></a><span class="w">      </span><span class="no">- allow:</span>
</span><span id="__span-29-14"><a id="__codelineno-29-14" name="__codelineno-29-14" href="#__codelineno-29-14"></a><span class="w">          </span><span class="no">or:</span>
</span><span id="__span-29-15"><a id="__codelineno-29-15" name="__codelineno-29-15" href="#__codelineno-29-15"></a><span class="w">            </span><span class="no">- email:</span>
</span></code></pre></div>
<h4 id="navidrome">Navidrome</h4>
<p>To keep <a href="../../../../2024/10/26/self-hosted-music-streaming-with-navidrome/">Navidrome</a> Web UI
behind Pomerium while allowing traffic from mobile apps (e.g. my favorite one,
<a href="https://play.google.com/store/apps/details?id=org.moire.ultrasonic">Ultrasonic</a>),
allow <a href="https://www.subsonic.org/pages/api.jsp#updatePlaylist">Subsonic API</a> requests
to bypass authentication; this requires a single path prefix:</p>
<div class="language-yaml highlight"><pre><span></span><code><span id="__span-30-1"><a id="__codelineno-30-1" name="__codelineno-30-1" href="#__codelineno-30-1"></a><span class="nt">metadata</span><span class="p">:</span>
</span><span id="__span-30-2"><a id="__codelineno-30-2" name="__codelineno-30-2" href="#__codelineno-30-2"></a><span class="w">  </span><span class="nt">annotations</span><span class="p">:</span>
</span><span id="__span-30-3"><a id="__codelineno-30-3" name="__codelineno-30-3" href="#__codelineno-30-3"></a><span class="w">    </span><span class="l l-Scalar l-Scalar-Plain">...</span>
</span><span id="__span-30-4"><a id="__codelineno-30-4" name="__codelineno-30-4" href="#__codelineno-30-4"></a><span class="w">    </span><span class="l l-Scalar l-Scalar-Plain">ingress.pomerium.io/policy</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
</span><span id="__span-30-5"><a id="__codelineno-30-5" name="__codelineno-30-5" href="#__codelineno-30-5"></a><span class="hll"><span class="w">      </span><span class="no">- allow:</span>
</span></span><span id="__span-30-6"><a id="__codelineno-30-6" name="__codelineno-30-6" href="#__codelineno-30-6"></a><span class="hll"><span class="w">          </span><span class="no">or:</span>
</span></span><span id="__span-30-7"><a id="__codelineno-30-7" name="__codelineno-30-7" href="#__codelineno-30-7"></a><span class="hll"><span class="w">            </span><span class="no">- http_path:</span>
</span></span><span id="__span-30-8"><a id="__codelineno-30-8" name="__codelineno-30-8" href="#__codelineno-30-8"></a><span class="hll"><span class="w">                </span><span class="no">starts_with: "/rest/"</span>
</span></span><span id="__span-30-9"><a id="__codelineno-30-9" name="__codelineno-30-9" href="#__codelineno-30-9"></a><span class="w">      </span><span class="no">- allow:</span>
</span><span id="__span-30-10"><a id="__codelineno-30-10" name="__codelineno-30-10" href="#__codelineno-30-10"></a><span class="w">          </span><span class="no">or:</span>
</span><span id="__span-30-11"><a id="__codelineno-30-11" name="__codelineno-30-11" href="#__codelineno-30-11"></a><span class="w">            </span><span class="no">- email:</span>
</span></code></pre></div>
<h3 id="https-backends">HTTPS backends</h3>
<p>Some applications provide only an HTTPS endpoint and come with self-signed certificates,
forcing reverse proxies to use that protocoal and skip TLS certificate validation. For
these, Pomerium has policies equivalents to those NGinx provides for the same purpose:</p>
<div class="language-yaml highlight"><pre><span></span><code><span id="__span-31-1"><a id="__codelineno-31-1" name="__codelineno-31-1" href="#__codelineno-31-1"></a><span class="nt">metadata</span><span class="p">:</span>
</span><span id="__span-31-2"><a id="__codelineno-31-2" name="__codelineno-31-2" href="#__codelineno-31-2"></a><span class="w">  </span><span class="nt">annotations</span><span class="p">:</span>
</span><span id="__span-31-3"><a id="__codelineno-31-3" name="__codelineno-31-3" href="#__codelineno-31-3"></a><span class="w">    </span><span class="nt">ingress.pomerium.io/policy</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
</span><span id="__span-31-4"><a id="__codelineno-31-4" name="__codelineno-31-4" href="#__codelineno-31-4"></a><span class="w">      </span><span class="no">...</span>
</span><span id="__span-31-5"><a id="__codelineno-31-5" name="__codelineno-31-5" href="#__codelineno-31-5"></a><span class="hll"><span class="w">    </span><span class="nt">ingress.pomerium.io/secure_upstream</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span><span class="w"> </span><span class="c1"># Support HTTPS backend</span>
</span></span><span id="__span-31-6"><a id="__codelineno-31-6" name="__codelineno-31-6" href="#__codelineno-31-6"></a><span class="hll"><span class="w">    </span><span class="nt">ingress.pomerium.io/tls_skip_verify</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span><span class="w"> </span><span class="c1"># Skip verification of backend certs</span>
</span></span></code></pre></div>
<p>Previously, these services used equivalent Nginx annotations to the same effect:</p>
<div class="language-yaml highlight"><pre><span></span><code><span id="__span-32-1"><a id="__codelineno-32-1" name="__codelineno-32-1" href="#__codelineno-32-1"></a><span class="nt">metadata</span><span class="p">:</span>
</span><span id="__span-32-2"><a id="__codelineno-32-2" name="__codelineno-32-2" href="#__codelineno-32-2"></a><span class="w">  </span><span class="nt">annotations</span><span class="p">:</span>
</span><span id="__span-32-3"><a id="__codelineno-32-3" name="__codelineno-32-3" href="#__codelineno-32-3"></a><span class="w">    </span><span class="nt">ingress.pomerium.io/policy</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
</span><span id="__span-32-4"><a id="__codelineno-32-4" name="__codelineno-32-4" href="#__codelineno-32-4"></a><span class="w">      </span><span class="no">...</span>
</span><span id="__span-32-5"><a id="__codelineno-32-5" name="__codelineno-32-5" href="#__codelineno-32-5"></a><span class="hll"><span class="w">    </span><span class="nt">nginx.ingress.kubernetes.io/backend-protocol</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">HTTPS</span>
</span></span><span id="__span-32-6"><a id="__codelineno-32-6" name="__codelineno-32-6" href="#__codelineno-32-6"></a><span class="hll"><span class="w">    </span><span class="nt">nginx.ingress.kubernetes.io/auth-tls-verify-client</span><span class="p">:</span><span class="w"> </span><span class="s">"false"</span>
</span></span></code></pre></div>
<h3 id="streaming">Streaming</h3>
<p>Applications that transfer large files, such as audio/video streaming or file-sharing
applications, will require (or largely benefit from) higher CPU and Memory limits than
the default. The following should be enough for 4K video and multiple concurrent streams;
this can be added to the <code>kustomization.yaml</code> file used above to configure
<a href="#pebble-storage">Pebble storage</a>:</p>
<details class="k8s" open="open">
<summary><code>pomerium-overlay/kustomization.yaml</code></summary>
<div class="language-yaml highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-33-28">28</a></span>
<span class="normal"><a href="#__codelineno-33-29">29</a></span>
<span class="normal"><a href="#__codelineno-33-30">30</a></span>
<span class="normal"><a href="#__codelineno-33-31">31</a></span>
<span class="normal"><a href="#__codelineno-33-32">32</a></span>
<span class="normal"><a href="#__codelineno-33-33">33</a></span>
<span class="normal"><a href="#__codelineno-33-34">34</a></span>
<span class="normal"><a href="#__codelineno-33-35">35</a></span>
<span class="normal"><a href="#__codelineno-33-36">36</a></span>
<span class="normal"><a href="#__codelineno-33-37">37</a></span>
<span class="normal"><a href="#__codelineno-33-38">38</a></span>
<span class="normal"><a href="#__codelineno-33-39">39</a></span>
<span class="normal"><a href="#__codelineno-33-40">40</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-33-28"><a id="__codelineno-33-28" name="__codelineno-33-28"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">target</span><span class="p">:</span>
</span><span id="__span-33-29"><a id="__codelineno-33-29" name="__codelineno-33-29"></a><span class="w">      </span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Deployment</span>
</span><span id="__span-33-30"><a id="__codelineno-33-30" name="__codelineno-33-30"></a><span class="w">      </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">pomerium</span>
</span><span id="__span-33-31"><a id="__codelineno-33-31" name="__codelineno-33-31"></a><span class="w">    </span><span class="nt">patch</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|-</span>
</span><span id="__span-33-32"><a id="__codelineno-33-32" name="__codelineno-33-32"></a><span class="w">      </span><span class="no">- op: replace</span>
</span><span id="__span-33-33"><a id="__codelineno-33-33" name="__codelineno-33-33"></a><span class="w">        </span><span class="no">path: /spec/template/spec/containers/0/resources</span>
</span><span id="__span-33-34"><a id="__codelineno-33-34" name="__codelineno-33-34"></a><span class="w">        </span><span class="no">value:</span>
</span><span id="__span-33-35"><a id="__codelineno-33-35" name="__codelineno-33-35"></a><span class="w">          </span><span class="no">requests:</span>
</span><span id="__span-33-36"><a id="__codelineno-33-36" name="__codelineno-33-36"></a><span class="hll"><span class="w">            </span><span class="no">cpu: "500m"</span>
</span></span><span id="__span-33-37"><a id="__codelineno-33-37" name="__codelineno-33-37"></a><span class="hll"><span class="w">            </span><span class="no">memory: "512Mi"</span>
</span></span><span id="__span-33-38"><a id="__codelineno-33-38" name="__codelineno-33-38"></a><span class="w">          </span><span class="no">limits:</span>
</span><span id="__span-33-39"><a id="__codelineno-33-39" name="__codelineno-33-39"></a><span class="w">            </span><span class="no">cpu: "1000m"</span>
</span><span id="__span-33-40"><a id="__codelineno-33-40" name="__codelineno-33-40"></a><span class="w">            </span><span class="no">memory: "1Gi"</span>
</span></code></pre></div></td></tr></tbody></table></div>
</details>
<h3 id="websockets">WebSockets</h3>
<p>For the best experience with audio and video streaming applications, <code>Ingress</code> for
streaming services should have the <code>timeout</code> disabled and explicitly allow "upgrades"
like <strong>WebSockets</strong>:</p>
<div class="language-yaml highlight"><pre><span></span><code><span id="__span-34-1"><a id="__codelineno-34-1" name="__codelineno-34-1" href="#__codelineno-34-1"></a><span class="nt">metadata</span><span class="p">:</span>
</span><span id="__span-34-2"><a id="__codelineno-34-2" name="__codelineno-34-2" href="#__codelineno-34-2"></a><span class="w">  </span><span class="nt">annotations</span><span class="p">:</span>
</span><span id="__span-34-3"><a id="__codelineno-34-3" name="__codelineno-34-3" href="#__codelineno-34-3"></a><span class="w">    </span><span class="nt">ingress.pomerium.io/policy</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
</span><span id="__span-34-4"><a id="__codelineno-34-4" name="__codelineno-34-4" href="#__codelineno-34-4"></a><span class="w">      </span><span class="no">...</span>
</span><span id="__span-34-5"><a id="__codelineno-34-5" name="__codelineno-34-5" href="#__codelineno-34-5"></a><span class="hll"><span class="w">    </span><span class="c1"># Keeps the "pipe" open even during quiet parts of a stream.</span>
</span></span><span id="__span-34-6"><a id="__codelineno-34-6" name="__codelineno-34-6" href="#__codelineno-34-6"></a><span class="hll"><span class="w">    </span><span class="nt">ingress.pomerium.io/idle_timeout</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0s</span>
</span></span><span id="__span-34-7"><a id="__codelineno-34-7" name="__codelineno-34-7" href="#__codelineno-34-7"></a><span class="hll"><span class="w">    </span><span class="c1"># Prevents long-running streams (like a 2-hour movie) from timing out.</span>
</span></span><span id="__span-34-8"><a id="__codelineno-34-8" name="__codelineno-34-8" href="#__codelineno-34-8"></a><span class="hll"><span class="w">    </span><span class="nt">ingress.pomerium.io/timeout</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0s</span>
</span></span><span id="__span-34-9"><a id="__codelineno-34-9" name="__codelineno-34-9" href="#__codelineno-34-9"></a><span class="hll"><span class="w">    </span><span class="c1"># Allow requests to be upgraded to WebSockets</span>
</span></span><span id="__span-34-10"><a id="__codelineno-34-10" name="__codelineno-34-10" href="#__codelineno-34-10"></a><span class="hll"><span class="w">    </span><span class="nt">ingress.pomerium.io/allow_websockets</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
</span></span></code></pre></div>
<p>While NGINX handles WebSocket upgrades somewhat permissively, Pomerium (Envoy) is
stricter regarding the <code>Connection</code> and <code>Upgrade</code> headers, especially when multiple
proxies or non-standard ports are involved. Pomerium requires an explicit setting to
allow <em>Upgrades</em> (like WebSockets) for specific routes; this is handled via the
<code>allow_websockets</code> annotation.</p>
<p>Enabling WebSockets is a recommended <em>best practice</em> for most modern media and streaming
applications, and even some non-media applications, including:</p>
<ul>
<li><strong>Audiobookshelf</strong> uses WebSockets to for almost all of its "live" functionality.</li>
<li><strong>Jellyfin</strong> uses WebSockets extensively for several core features.</li>
<li><strong>Headless Steam</strong> and other gaming streaming protocols that handle low-latency video
    and input (Steam Remote Play, Moonlight/Sunshine, etc.) typically use WebSockets or
    specialized protocols to exchange encryption keys and handle input (mouse/keyboard)
    before the heavy UDP video stream begins.</li>
<li><strong>Home Assistant</strong> entire dashboard UI relies on a single persistent WebSocket.</li>
<li><strong>Navidrome</strong> and the Subsonic API are strictly HTTP-based and do not use WebSockets,
    but enabling this future-proofs against potential future real-time extensions.</li>
</ul>
<h2 id="convert-ngnix-ingress-to-pomerium">Convert Ngnix <code>Ingress</code> to Pomerium</h2>
<p>Copy the current <code>Ingress</code> and make the following changes:</p>
<ul>
<li>
<p>Change the <code>ingressClassName</code> to <code>pomerium</code>.</p>
</li>
<li>
<p>Change the <code>name</code> so that both can temporarily coexist in the same namespace.</p>
</li>
<li>
<p>Remove <em>all</em> (see note below) <code>annotations</code> except <code>cert-manager.io/cluster-issuer</code>.</p>
</li>
<li>
<p>Add <code>ingress.pomerium.io/pass_identity_headers: true</code> to the <code>annotations</code> for
    services that will be restricted and accessed by human users.</p>
</li>
<li>
<p>Add <code>ingress.pomerium.io/preserve_host_header: true</code> to the <code>annotations</code> so that
    Pomerium does not rewrite the <code>Host</code> header. This is required by certain applications
    (e.g. Grafana) because their backend checks request headers to enforce the
    <a href="https://en.wikipedia.org/wiki/Same-origin_policy">same-origin policy</a>.</p>
<p>Many applications that rely on <a href="#websockets">WebSockets</a> will also need this, because
they will reject the WebSocket handshake if the <code>Origin</code> sent by the browser does not
match the <code>Host</code> header seen by the server.</p>
<p>The UniFi Network application also requires this annotation, without it the login
page fails with a generic error message asking to simply "try again later".</p>
</li>
<li>
<p>Add <code>annotations</code> for applications that rely on <a href="#https-backends">HTTPS backends</a>,
    <a href="#streaming">streaming</a> or <a href="#websockets">WebSockets</a>.</p>
</li>
<li>
<p>Add <strong>one of</strong></p>
<ul>
<li>
<p><code>ingress.pomerium.io/policy</code> to the <code>annotations</code> for services that require
    access controls for <a href="#access-control-for-individual-users">human users</a> or 
    <a href="#api-access">API access</a>.</p>
</li>
<li>
<p><code>ingress.pomerium.io/allow_public_unauthenticated_access: true</code> to the
    <code>annotations</code> for services do not require access to be controlled by Pomerium.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Use with caution, e.g. only with
<a href="#cloudflare-tunnels">Cloudflare Tunnels</a>, as it enables <strong>unrestricted</strong>
<a href="https://www.pomerium.com/docs/reference/routes/public-access">Public Access</a>.</p>
</div>
</li>
</ul>
</li>
</ul>
<details class="note">
<summary>Why remove <em>all</em> annotations other than <code>cert-manager.io/cluster-issuer</code>?</summary>
<p>The following <code>annotations</code> not under <code>nginx.ingress.*</code> are unnecessary for Pomerium:</p>
<ul>
<li>
<p><code>acme.cert-manager.io/http01-edit-in-place: true</code> is an NGINX-specific legacy
    annotation that forces <code>cert-manager</code> to add the ACME challenge path directly to
    the existing <code>Ingress</code> instead of creating a <em>temporary challenge ingress</em>.
    Pomerium does not need this because the Pomerium Ingress Controller is designed
    to watch for the temporary Ingresses created by <code>cert-manager</code> during the HTTP-01
    challenge and automatically merges those challenge paths into its routing table.
    Unlike early versions of NGINX, Pomerium's underlying Envoy engine can handle
    dynamic routing updates (adding the <code>/.well-known/acme-challenge/</code> path) without
    reloading or needing to <em>edit the Ingress in place</em>.</p>
</li>
<li>
<p><code>cert-manager.io/issue-temporary-certificate: true</code> tells <code>cert-manager</code> to
    issue a <em>Fake Let's Encrypt</em> or self-signed certificate immediately, so that the
    <code>Ingress</code> has <em>something</em> to serve while waiting for the real Let's Encrypt
    certificate. Pomerium does not need this because it has a built-in <em>Fallback CA</em>
    to serve its own certificate (the "Pomerium PSK CA") when a referenced TLS secret
    is missing or not yet ready. Once a new TLS secret is ready, Pomerium uses
    Envoy's SDS (Secret Discovery Service) to <em>hot-swap</em> certificates; as soon as
    <code>cert-manager</code> finishes the challenge and populates the secret, Pomerium detects
    the update and swaps the internal certificate for the real Let's Encrypt
    certificate without dropping active connections or requiring a temporary
    placeholder.</p>
</li>
<li>
<p><code>ingress.kubernetes.io/force-ssl-redirect: true</code> is unnecessary with Pomerium
    because it automatically enforces HTTPS for all managed routes.</p>
</li>
</ul>
<p>The following <code>annotations</code> under <code>nginx.ingress.*</code> are made unnecessary by Pomerium:</p>
<ul>
<li>
<p><code>nginx.ingress.kubernetes.io/proxy-buffer-size: 16k</code> is not necessary because
    Envoy (the engine inside Pomerium) defaults to 64 KB for maximum request headers
    to prevent <em>Header too large</em> errors, especially when handling large cookies or
    OIDC tokens.</p>
</li>
<li>
<p><code>nginx.ingress.kubernetes.io/websocket-services</code> is entirely unnecessary because
    Pomerium handles WebSockets automatically for all routes. Unlike NGINX, Pomerium
    treats all HTTP traffic as potentially upgradable to <a href="#websockets">WebSockets</a>.</p>
</li>
<li>
<p><code>nginx.ingress.kubernetes.io/whitelist-source-range: 10.244.0.0/16</code> is
    unnecessary and generally unsupported by the Pomerium Ingress Controller.
    NGINX relies on the assumption that if a request comes from 10.244.0.0/16 (the
    internal pod network), it is "safe", while Pomerium requires that every request
    be authenticated regardless of its origin.</p>
</li>
</ul>
</details>
<h3 id="cloudflare-tunnels">Cloudflare Tunnels</h3>
<p>In addition to the above changes, for each <code>Ingress</code> behind a
<a href="../../../02/22/home-assistant-on-kubernetes-on-raspberry-pi-5-alfred/#cloudflare-tunnel">Cloudflare Tunnel</a>,
<strong>Edit</strong> the corresponding <strong>Connectors</strong> in <a href="https://one.dash.cloudflare.com/">https://one.dash.cloudflare.com/</a> (under
<strong>Networks</strong>) to route traffic to port 443 to the <code>LoadBalancer</code> IP of Pomerium, instead
of that of Nginx.</p>
<p>Changing the <code>name</code> is not necessary because there is no point in having multiple
<code>Ingress</code> in the same namespace; traffic is only ever routed to the one <code>LoadBalancer</code>
IP set as the target for the corresponding <strong>Connector</strong> above. If the name is changed
to be consistent with other Pomerium <code>Ingress</code> (e.g. <code>&lt;service-name&gt;-pomerium-ingress</code>),
delete the old one since it won't be used:</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-35-1"><a id="__codelineno-35-1" name="__codelineno-35-1" href="#__codelineno-35-1"></a><span class="gp">$ </span>kubectl<span class="w"> </span>delete<span class="w"> </span>ingress<span class="w"> </span>ddns-updater-nginx
</span><span id="__span-35-2"><a id="__codelineno-35-2" name="__codelineno-35-2" href="#__codelineno-35-2"></a><span class="go">ingress.networking.k8s.io "ddns-updater-nginx" deleted</span>
</span></code></pre></div>
<h3 id="update-kustomized-ingress">Update Kustomized <code>Ingress</code></h3>
<p><a href="../../../02/22/home-assistant-on-kubernetes-on-raspberry-pi-5-alfred/#home-assistant">Home Assistant</a>
was deployed in several clusters (<code>alfred</code> and <code>lexicon</code>, later replaced by <code>octavo</code>)
with very similar manifests by using <code>kustomize</code>, so the above changes may need to be
applied in different files depending on the specific structure of the manifests.</p>
<p>For the current Home Assistant manifests, all the above changes need to be applied in the
<code>base/ingress.yaml</code> file, so the same migration is applied to all Home Assistant 
instances, while each cluster's <code>kustomization.yaml</code> needs only to reflect the change in
the <code>name</code> of those <code>Ingress</code> that have their <code>ingressClassName</code> changed from <code>nginx</code> to <code>pomerium</code>.</p>
<p>For now, all Home Assistant instances are accessed exclusively through
<a href="#cloudflare-tunnels">Cloudflare Tunnels</a> only, so they need only
<code>ingress.pomerium.io/allow_public_unauthenticated_access: true</code> added to their
<code>annotations</code>.</p>
<h3 id="kustomize-per-service-acls">Kustomize per-service ACLs</h3>
<p>Most of the <a href="#additional-settings">Additional Settings</a> above will be fixed for each
application, with only sporadic updates, but the set of people to be added as
<a href="#access-control-for-users">authorized users</a> is subject to change over time, so it
would be convenient to have those centralized in a single file for all the applications.</p>
<p>This can be done by leveraging <code>kustomize</code> to <em>patch</em> the <code>ingress.pomerium.io/policy</code>
annotation for every application from a single file, so that authorizing a new user to
access a number of applications can be quickly done by updating only that one file.</p>
<p>The most reliable way to achieve a setup with a <em>global policy</em> (with 1 admin user who
is authorized to access everything) and <em>per-application overrides</em> in Kustomize is to
use a base resource for the global policy and a patch that targets each application to
replace its policy to override the list of authorized users and/or API paths.</p>
<p>The follow shows, as <em>extreme</em> examples, the least and most complex of the many
applications currently running in <code>octavo</code>, along with a global policy that authorizes
one <code>admin</code> user access to all applications:</p>
<ul>
<li><code>audiobookshelf</code> requires policy overrides for both <a href="#api-access">API access</a> and
    <a href="#access-control-for-users">human users</a>, as well as <code>annotations</code> for 
    <a href="#streaming">streaming</a> and <a href="#websockets">WebSockets</a>.</li>
<li><code>dashboard</code> needs only <code>annotations</code> for <a href="#https-backends">HTTPS backends</a>.</li>
<li><code>ddns-updater</code> needs <em>none</em> of that; in fact it needs not any access control because
    it is only accessible through a <a href="#cloudflare-tunnels">Cloudflare Tunnel</a>.</li>
</ul>
<p><code>audiobookshelf</code> is the only one that needs a patch on its <code>ingress.pomerium.io/policy</code>
annotation, the others could be taken out of this <code>kustomize</code> setup entirely, but it also
seems convenient to have all Pomerium <code>Ingress</code> manifests in a single place and it makes
them also easier to update should they need a patch later.</p>
<details class="k8s">
<summary><code>pomerium-ingress/kustomization.yaml</code></summary>
<div class="language-yaml highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-36-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-36-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-36-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-36-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-36-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-36-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-36-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-36-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-36-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-36-10">10</a></span>
<span class="normal"><a href="#__codelineno-36-11">11</a></span>
<span class="normal"><a href="#__codelineno-36-12">12</a></span>
<span class="normal"><a href="#__codelineno-36-13">13</a></span>
<span class="normal"><a href="#__codelineno-36-14">14</a></span>
<span class="normal"><a href="#__codelineno-36-15">15</a></span>
<span class="normal"><a href="#__codelineno-36-16">16</a></span>
<span class="normal"><a href="#__codelineno-36-17">17</a></span>
<span class="normal"><a href="#__codelineno-36-18">18</a></span>
<span class="normal"><a href="#__codelineno-36-19">19</a></span>
<span class="normal"><a href="#__codelineno-36-20">20</a></span>
<span class="normal"><a href="#__codelineno-36-21">21</a></span>
<span class="normal"><a href="#__codelineno-36-22">22</a></span>
<span class="normal"><a href="#__codelineno-36-23">23</a></span>
<span class="normal"><a href="#__codelineno-36-24">24</a></span>
<span class="normal"><a href="#__codelineno-36-25">25</a></span>
<span class="normal"><a href="#__codelineno-36-26">26</a></span>
<span class="normal"><a href="#__codelineno-36-27">27</a></span>
<span class="normal"><a href="#__codelineno-36-28">28</a></span>
<span class="normal"><a href="#__codelineno-36-29">29</a></span>
<span class="normal"><a href="#__codelineno-36-30">30</a></span>
<span class="normal"><a href="#__codelineno-36-31">31</a></span>
<span class="normal"><a href="#__codelineno-36-32">32</a></span>
<span class="normal"><a href="#__codelineno-36-33">33</a></span>
<span class="normal"><a href="#__codelineno-36-34">34</a></span>
<span class="normal"><a href="#__codelineno-36-35">35</a></span>
<span class="normal"><a href="#__codelineno-36-36">36</a></span>
<span class="normal"><a href="#__codelineno-36-37">37</a></span>
<span class="normal"><a href="#__codelineno-36-38">38</a></span>
<span class="normal"><a href="#__codelineno-36-39">39</a></span>
<span class="normal"><a href="#__codelineno-36-40">40</a></span>
<span class="normal"><a href="#__codelineno-36-41">41</a></span>
<span class="normal"><a href="#__codelineno-36-42">42</a></span>
<span class="normal"><a href="#__codelineno-36-43">43</a></span>
<span class="normal"><a href="#__codelineno-36-44">44</a></span>
<span class="normal"><a href="#__codelineno-36-45">45</a></span>
<span class="normal"><a href="#__codelineno-36-46">46</a></span>
<span class="normal"><a href="#__codelineno-36-47">47</a></span>
<span class="normal"><a href="#__codelineno-36-48">48</a></span>
<span class="normal"><a href="#__codelineno-36-49">49</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-36-1"><a id="__codelineno-36-1" name="__codelineno-36-1"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">kustomize.config.k8s.io/v1beta1</span>
</span><span id="__span-36-2"><a id="__codelineno-36-2" name="__codelineno-36-2"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Kustomization</span>
</span><span id="__span-36-3"><a id="__codelineno-36-3" name="__codelineno-36-3"></a>
</span><span id="__span-36-4"><a id="__codelineno-36-4" name="__codelineno-36-4"></a><span class="hll"><span class="nt">resources</span><span class="p">:</span>
</span></span><span id="__span-36-5"><a id="__codelineno-36-5" name="__codelineno-36-5"></a><span class="hll"><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">audiobookshelf.yaml</span>
</span></span><span id="__span-36-6"><a id="__codelineno-36-6" name="__codelineno-36-6"></a><span class="hll"><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">dashboard.yaml</span>
</span></span><span id="__span-36-7"><a id="__codelineno-36-7" name="__codelineno-36-7"></a><span class="hll"><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ddns-updater.yaml</span><span class="w"> </span>
</span></span><span id="__span-36-8"><a id="__codelineno-36-8" name="__codelineno-36-8"></a>
</span><span id="__span-36-9"><a id="__codelineno-36-9" name="__codelineno-36-9"></a><span class="nt">patches</span><span class="p">:</span>
</span><span id="__span-36-10"><a id="__codelineno-36-10" name="__codelineno-36-10"></a><span class="w">  </span><span class="c1"># Global policy (targeting all Ingress)</span>
</span><span id="__span-36-11"><a id="__codelineno-36-11" name="__codelineno-36-11"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">target</span><span class="p">:</span>
</span><span id="__span-36-12"><a id="__codelineno-36-12" name="__codelineno-36-12"></a><span class="w">      </span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Ingress</span>
</span><span id="__span-36-13"><a id="__codelineno-36-13" name="__codelineno-36-13"></a><span class="w">    </span><span class="nt">patch</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|-</span>
</span><span id="__span-36-14"><a id="__codelineno-36-14" name="__codelineno-36-14"></a><span class="w">      </span><span class="no">apiVersion: networking.k8s.io/v1</span>
</span><span id="__span-36-15"><a id="__codelineno-36-15" name="__codelineno-36-15"></a><span class="w">      </span><span class="no">kind: Ingress</span>
</span><span id="__span-36-16"><a id="__codelineno-36-16" name="__codelineno-36-16"></a><span class="w">      </span><span class="no">metadata:</span>
</span><span id="__span-36-17"><a id="__codelineno-36-17" name="__codelineno-36-17"></a><span class="w">        </span><span class="no">name: all-ingresses # Kustomize uses the target selector, this name is a placeholder</span>
</span><span id="__span-36-18"><a id="__codelineno-36-18" name="__codelineno-36-18"></a><span class="w">        </span><span class="no">annotations:</span>
</span><span id="__span-36-19"><a id="__codelineno-36-19" name="__codelineno-36-19"></a><span class="hll"><span class="w">          </span><span class="no">ingress.pomerium.io/policy: |</span>
</span></span><span id="__span-36-20"><a id="__codelineno-36-20" name="__codelineno-36-20"></a><span class="hll"><span class="w">            </span><span class="no">- allow:</span>
</span></span><span id="__span-36-21"><a id="__codelineno-36-21" name="__codelineno-36-21"></a><span class="hll"><span class="w">                </span><span class="no">or:</span>
</span></span><span id="__span-36-22"><a id="__codelineno-36-22" name="__codelineno-36-22"></a><span class="hll"><span class="w">                  </span><span class="no">- email:</span>
</span></span><span id="__span-36-23"><a id="__codelineno-36-23" name="__codelineno-36-23"></a><span class="hll"><span class="w">                      </span><span class="no">is: "admin-user@gmail.com"</span>
</span></span><span id="__span-36-24"><a id="__codelineno-36-24" name="__codelineno-36-24"></a>
</span><span id="__span-36-25"><a id="__codelineno-36-25" name="__codelineno-36-25"></a><span class="w">  </span><span class="c1"># Override for audiobookshelf (targeting only its Ingress)</span>
</span><span id="__span-36-26"><a id="__codelineno-36-26" name="__codelineno-36-26"></a><span class="w">  </span><span class="c1"># This patch must come after the global policy, to override it.</span>
</span><span id="__span-36-27"><a id="__codelineno-36-27" name="__codelineno-36-27"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">target</span><span class="p">:</span>
</span><span id="__span-36-28"><a id="__codelineno-36-28" name="__codelineno-36-28"></a><span class="w">      </span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Ingress</span>
</span><span id="__span-36-29"><a id="__codelineno-36-29" name="__codelineno-36-29"></a><span class="w">      </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">audiobookshelf-pomerium-ingress</span>
</span><span id="__span-36-30"><a id="__codelineno-36-30" name="__codelineno-36-30"></a><span class="hll"><span class="w">    </span><span class="nt">patch</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|-</span>
</span></span><span id="__span-36-31"><a id="__codelineno-36-31" name="__codelineno-36-31"></a><span class="hll"><span class="w">      </span><span class="no">- op: replace</span>
</span></span><span id="__span-36-32"><a id="__codelineno-36-32" name="__codelineno-36-32"></a><span class="hll"><span class="w">        </span><span class="no">path: "/metadata/annotations/ingress.pomerium.io~1policy"</span>
</span></span><span id="__span-36-33"><a id="__codelineno-36-33" name="__codelineno-36-33"></a><span class="hll"><span class="w">        </span><span class="no">value: |</span>
</span></span><span id="__span-36-34"><a id="__codelineno-36-34" name="__codelineno-36-34"></a><span class="hll"><span class="w">          </span><span class="no">- allow:</span>
</span></span><span id="__span-36-35"><a id="__codelineno-36-35" name="__codelineno-36-35"></a><span class="hll"><span class="w">              </span><span class="no">or:</span>
</span></span><span id="__span-36-36"><a id="__codelineno-36-36" name="__codelineno-36-36"></a><span class="hll"><span class="w">                </span><span class="no">- http_path:</span>
</span></span><span id="__span-36-37"><a id="__codelineno-36-37" name="__codelineno-36-37"></a><span class="hll"><span class="w">                    </span><span class="no">starts_with: "/api"</span>
</span></span><span id="__span-36-38"><a id="__codelineno-36-38" name="__codelineno-36-38"></a><span class="hll"><span class="w">                </span><span class="no">- http_path:</span>
</span></span><span id="__span-36-39"><a id="__codelineno-36-39" name="__codelineno-36-39"></a><span class="hll"><span class="w">                    </span><span class="no">starts_with: "/login"</span>
</span></span><span id="__span-36-40"><a id="__codelineno-36-40" name="__codelineno-36-40"></a><span class="hll"><span class="w">                </span><span class="no">- http_path:</span>
</span></span><span id="__span-36-41"><a id="__codelineno-36-41" name="__codelineno-36-41"></a><span class="hll"><span class="w">                    </span><span class="no">starts_with: "/status"</span>
</span></span><span id="__span-36-42"><a id="__codelineno-36-42" name="__codelineno-36-42"></a><span class="hll"><span class="w">          </span><span class="no">- allow:</span>
</span></span><span id="__span-36-43"><a id="__codelineno-36-43" name="__codelineno-36-43"></a><span class="hll"><span class="w">              </span><span class="no">or:</span>
</span></span><span id="__span-36-44"><a id="__codelineno-36-44" name="__codelineno-36-44"></a><span class="hll"><span class="w">                </span><span class="no">- email:</span>
</span></span><span id="__span-36-45"><a id="__codelineno-36-45" name="__codelineno-36-45"></a><span class="hll"><span class="w">                    </span><span class="no">is: "admin-user@gmail.com"</span>
</span></span><span id="__span-36-46"><a id="__codelineno-36-46" name="__codelineno-36-46"></a><span class="hll"><span class="w">                </span><span class="no">- email:</span>
</span></span><span id="__span-36-47"><a id="__codelineno-36-47" name="__codelineno-36-47"></a><span class="hll"><span class="w">                    </span><span class="no">is: "alice@gmail.com"</span>
</span></span><span id="__span-36-48"><a id="__codelineno-36-48" name="__codelineno-36-48"></a><span class="hll"><span class="w">                </span><span class="no">- email:</span>
</span></span><span id="__span-36-49"><a id="__codelineno-36-49" name="__codelineno-36-49"></a><span class="hll"><span class="w">                    </span><span class="no">is: "bob@gmail.com"</span>
</span></span></code></pre></div></td></tr></tbody></table></div>
</details>
<details class="k8s">
<summary><code>pomerium-ingress/audiobookshelf.yaml</code></summary>
<div class="language-yaml highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-37-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-37-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-37-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-37-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-37-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-37-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-37-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-37-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-37-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-37-10">10</a></span>
<span class="normal"><a href="#__codelineno-37-11">11</a></span>
<span class="normal"><a href="#__codelineno-37-12">12</a></span>
<span class="normal"><a href="#__codelineno-37-13">13</a></span>
<span class="normal"><a href="#__codelineno-37-14">14</a></span>
<span class="normal"><a href="#__codelineno-37-15">15</a></span>
<span class="normal"><a href="#__codelineno-37-16">16</a></span>
<span class="normal"><a href="#__codelineno-37-17">17</a></span>
<span class="normal"><a href="#__codelineno-37-18">18</a></span>
<span class="normal"><a href="#__codelineno-37-19">19</a></span>
<span class="normal"><a href="#__codelineno-37-20">20</a></span>
<span class="normal"><a href="#__codelineno-37-21">21</a></span>
<span class="normal"><a href="#__codelineno-37-22">22</a></span>
<span class="normal"><a href="#__codelineno-37-23">23</a></span>
<span class="normal"><a href="#__codelineno-37-24">24</a></span>
<span class="normal"><a href="#__codelineno-37-25">25</a></span>
<span class="normal"><a href="#__codelineno-37-26">26</a></span>
<span class="normal"><a href="#__codelineno-37-27">27</a></span>
<span class="normal"><a href="#__codelineno-37-28">28</a></span>
<span class="normal"><a href="#__codelineno-37-29">29</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-37-1"><a id="__codelineno-37-1" name="__codelineno-37-1"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">networking.k8s.io/v1</span>
</span><span id="__span-37-2"><a id="__codelineno-37-2" name="__codelineno-37-2"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Ingress</span>
</span><span id="__span-37-3"><a id="__codelineno-37-3" name="__codelineno-37-3"></a><span class="nt">metadata</span><span class="p">:</span>
</span><span id="__span-37-4"><a id="__codelineno-37-4" name="__codelineno-37-4"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">audiobookshelf-pomerium-ingress</span>
</span><span id="__span-37-5"><a id="__codelineno-37-5" name="__codelineno-37-5"></a><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">audiobookshelf</span>
</span><span id="__span-37-6"><a id="__codelineno-37-6" name="__codelineno-37-6"></a><span class="w">  </span><span class="nt">annotations</span><span class="p">:</span>
</span><span id="__span-37-7"><a id="__codelineno-37-7" name="__codelineno-37-7"></a><span class="w">    </span><span class="nt">cert-manager.io/cluster-issuer</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">letsencrypt-prod</span>
</span><span id="__span-37-8"><a id="__codelineno-37-8" name="__codelineno-37-8"></a><span class="hll"><span class="w">    </span><span class="nt">ingress.pomerium.io/allow_websockets</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
</span></span><span id="__span-37-9"><a id="__codelineno-37-9" name="__codelineno-37-9"></a><span class="hll"><span class="w">    </span><span class="nt">ingress.pomerium.io/idle_timeout</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0s</span>
</span></span><span id="__span-37-10"><a id="__codelineno-37-10" name="__codelineno-37-10"></a><span class="hll"><span class="w">    </span><span class="nt">ingress.pomerium.io/pass_identity_headers</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
</span></span><span id="__span-37-11"><a id="__codelineno-37-11" name="__codelineno-37-11"></a><span class="hll"><span class="w">    </span><span class="nt">ingress.pomerium.io/preserve_host_header</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
</span></span><span id="__span-37-12"><a id="__codelineno-37-12" name="__codelineno-37-12"></a><span class="hll"><span class="w">    </span><span class="nt">ingress.pomerium.io/timeout</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0s</span>
</span></span><span id="__span-37-13"><a id="__codelineno-37-13" name="__codelineno-37-13"></a><span class="nt">spec</span><span class="p">:</span>
</span><span id="__span-37-14"><a id="__codelineno-37-14" name="__codelineno-37-14"></a><span class="w">  </span><span class="nt">ingressClassName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">pomerium</span>
</span><span id="__span-37-15"><a id="__codelineno-37-15" name="__codelineno-37-15"></a><span class="w">  </span><span class="nt">rules</span><span class="p">:</span>
</span><span id="__span-37-16"><a id="__codelineno-37-16" name="__codelineno-37-16"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">host</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">audiobookshelf.very-very-dark-gray.top</span>
</span><span id="__span-37-17"><a id="__codelineno-37-17" name="__codelineno-37-17"></a><span class="w">      </span><span class="nt">http</span><span class="p">:</span>
</span><span id="__span-37-18"><a id="__codelineno-37-18" name="__codelineno-37-18"></a><span class="w">        </span><span class="nt">paths</span><span class="p">:</span>
</span><span id="__span-37-19"><a id="__codelineno-37-19" name="__codelineno-37-19"></a><span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/</span>
</span><span id="__span-37-20"><a id="__codelineno-37-20" name="__codelineno-37-20"></a><span class="w">            </span><span class="nt">pathType</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Prefix</span>
</span><span id="__span-37-21"><a id="__codelineno-37-21" name="__codelineno-37-21"></a><span class="w">            </span><span class="nt">backend</span><span class="p">:</span>
</span><span id="__span-37-22"><a id="__codelineno-37-22" name="__codelineno-37-22"></a><span class="w">              </span><span class="nt">service</span><span class="p">:</span>
</span><span id="__span-37-23"><a id="__codelineno-37-23" name="__codelineno-37-23"></a><span class="w">                </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">audiobookshelf-svc</span>
</span><span id="__span-37-24"><a id="__codelineno-37-24" name="__codelineno-37-24"></a><span class="w">                </span><span class="nt">port</span><span class="p">:</span>
</span><span id="__span-37-25"><a id="__codelineno-37-25" name="__codelineno-37-25"></a><span class="w">                  </span><span class="nt">number</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">13388</span>
</span><span id="__span-37-26"><a id="__codelineno-37-26" name="__codelineno-37-26"></a><span class="w">  </span><span class="nt">tls</span><span class="p">:</span>
</span><span id="__span-37-27"><a id="__codelineno-37-27" name="__codelineno-37-27"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">secretName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">tls-secret</span>
</span><span id="__span-37-28"><a id="__codelineno-37-28" name="__codelineno-37-28"></a><span class="w">      </span><span class="nt">hosts</span><span class="p">:</span>
</span><span id="__span-37-29"><a id="__codelineno-37-29" name="__codelineno-37-29"></a><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">audiobookshelf.very-very-dark-gray.top</span>
</span></code></pre></div></td></tr></tbody></table></div>
</details>
<details class="k8s">
<summary><code>pomerium-ingress/dashboard.yaml</code></summary>
<div class="language-yaml highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-38-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-38-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-38-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-38-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-38-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-38-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-38-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-38-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-38-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-38-10">10</a></span>
<span class="normal"><a href="#__codelineno-38-11">11</a></span>
<span class="normal"><a href="#__codelineno-38-12">12</a></span>
<span class="normal"><a href="#__codelineno-38-13">13</a></span>
<span class="normal"><a href="#__codelineno-38-14">14</a></span>
<span class="normal"><a href="#__codelineno-38-15">15</a></span>
<span class="normal"><a href="#__codelineno-38-16">16</a></span>
<span class="normal"><a href="#__codelineno-38-17">17</a></span>
<span class="normal"><a href="#__codelineno-38-18">18</a></span>
<span class="normal"><a href="#__codelineno-38-19">19</a></span>
<span class="normal"><a href="#__codelineno-38-20">20</a></span>
<span class="normal"><a href="#__codelineno-38-21">21</a></span>
<span class="normal"><a href="#__codelineno-38-22">22</a></span>
<span class="normal"><a href="#__codelineno-38-23">23</a></span>
<span class="normal"><a href="#__codelineno-38-24">24</a></span>
<span class="normal"><a href="#__codelineno-38-25">25</a></span>
<span class="normal"><a href="#__codelineno-38-26">26</a></span>
<span class="normal"><a href="#__codelineno-38-27">27</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-38-1"><a id="__codelineno-38-1" name="__codelineno-38-1"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">networking.k8s.io/v1</span>
</span><span id="__span-38-2"><a id="__codelineno-38-2" name="__codelineno-38-2"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Ingress</span>
</span><span id="__span-38-3"><a id="__codelineno-38-3" name="__codelineno-38-3"></a><span class="nt">metadata</span><span class="p">:</span>
</span><span id="__span-38-4"><a id="__codelineno-38-4" name="__codelineno-38-4"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">dashboard-pomerium-ingress</span>
</span><span id="__span-38-5"><a id="__codelineno-38-5" name="__codelineno-38-5"></a><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">kubernetes-dashboard</span>
</span><span id="__span-38-6"><a id="__codelineno-38-6" name="__codelineno-38-6"></a><span class="w">  </span><span class="nt">annotations</span><span class="p">:</span>
</span><span id="__span-38-7"><a id="__codelineno-38-7" name="__codelineno-38-7"></a><span class="w">    </span><span class="nt">cert-manager.io/cluster-issuer</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">letsencrypt-prod</span>
</span><span id="__span-38-8"><a id="__codelineno-38-8" name="__codelineno-38-8"></a><span class="w">    </span><span class="nt">ingress.pomerium.io/pass_identity_headers</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
</span><span id="__span-38-9"><a id="__codelineno-38-9" name="__codelineno-38-9"></a><span class="hll"><span class="w">    </span><span class="nt">ingress.pomerium.io/secure_upstream</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
</span></span><span id="__span-38-10"><a id="__codelineno-38-10" name="__codelineno-38-10"></a><span class="hll"><span class="w">    </span><span class="nt">ingress.pomerium.io/tls_skip_verify</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
</span></span><span id="__span-38-11"><a id="__codelineno-38-11" name="__codelineno-38-11"></a><span class="nt">spec</span><span class="p">:</span>
</span><span id="__span-38-12"><a id="__codelineno-38-12" name="__codelineno-38-12"></a><span class="w">  </span><span class="nt">ingressClassName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">pomerium</span>
</span><span id="__span-38-13"><a id="__codelineno-38-13" name="__codelineno-38-13"></a><span class="w">  </span><span class="nt">rules</span><span class="p">:</span>
</span><span id="__span-38-14"><a id="__codelineno-38-14" name="__codelineno-38-14"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">host</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">kubernetes.very-very-dark-gray.top</span>
</span><span id="__span-38-15"><a id="__codelineno-38-15" name="__codelineno-38-15"></a><span class="w">      </span><span class="nt">http</span><span class="p">:</span>
</span><span id="__span-38-16"><a id="__codelineno-38-16" name="__codelineno-38-16"></a><span class="w">        </span><span class="nt">paths</span><span class="p">:</span>
</span><span id="__span-38-17"><a id="__codelineno-38-17" name="__codelineno-38-17"></a><span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/</span>
</span><span id="__span-38-18"><a id="__codelineno-38-18" name="__codelineno-38-18"></a><span class="w">            </span><span class="nt">pathType</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Prefix</span>
</span><span id="__span-38-19"><a id="__codelineno-38-19" name="__codelineno-38-19"></a><span class="w">            </span><span class="nt">backend</span><span class="p">:</span>
</span><span id="__span-38-20"><a id="__codelineno-38-20" name="__codelineno-38-20"></a><span class="w">              </span><span class="nt">service</span><span class="p">:</span>
</span><span id="__span-38-21"><a id="__codelineno-38-21" name="__codelineno-38-21"></a><span class="w">                </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">kubernetes-dashboard-kong-proxy</span>
</span><span id="__span-38-22"><a id="__codelineno-38-22" name="__codelineno-38-22"></a><span class="w">                </span><span class="nt">port</span><span class="p">:</span>
</span><span id="__span-38-23"><a id="__codelineno-38-23" name="__codelineno-38-23"></a><span class="w">                  </span><span class="nt">number</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">443</span>
</span><span id="__span-38-24"><a id="__codelineno-38-24" name="__codelineno-38-24"></a><span class="w">  </span><span class="nt">tls</span><span class="p">:</span>
</span><span id="__span-38-25"><a id="__codelineno-38-25" name="__codelineno-38-25"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">secretName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">tls-secret</span>
</span><span id="__span-38-26"><a id="__codelineno-38-26" name="__codelineno-38-26"></a><span class="w">      </span><span class="nt">hosts</span><span class="p">:</span>
</span><span id="__span-38-27"><a id="__codelineno-38-27" name="__codelineno-38-27"></a><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">kubernetes.very-very-dark-gray.top</span>
</span></code></pre></div></td></tr></tbody></table></div>
</details>
<details class="k8s">
<summary><code>pomerium-ingress/ddns-updater.yaml</code></summary>
<div class="language-yaml highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-39-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-39-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-39-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-39-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-39-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-39-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-39-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-39-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-39-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-39-10">10</a></span>
<span class="normal"><a href="#__codelineno-39-11">11</a></span>
<span class="normal"><a href="#__codelineno-39-12">12</a></span>
<span class="normal"><a href="#__codelineno-39-13">13</a></span>
<span class="normal"><a href="#__codelineno-39-14">14</a></span>
<span class="normal"><a href="#__codelineno-39-15">15</a></span>
<span class="normal"><a href="#__codelineno-39-16">16</a></span>
<span class="normal"><a href="#__codelineno-39-17">17</a></span>
<span class="normal"><a href="#__codelineno-39-18">18</a></span>
<span class="normal"><a href="#__codelineno-39-19">19</a></span>
<span class="normal"><a href="#__codelineno-39-20">20</a></span>
<span class="normal"><a href="#__codelineno-39-21">21</a></span>
<span class="normal"><a href="#__codelineno-39-22">22</a></span>
<span class="normal"><a href="#__codelineno-39-23">23</a></span>
<span class="normal"><a href="#__codelineno-39-24">24</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-39-1"><a id="__codelineno-39-1" name="__codelineno-39-1"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">networking.k8s.io/v1</span>
</span><span id="__span-39-2"><a id="__codelineno-39-2" name="__codelineno-39-2"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Ingress</span>
</span><span id="__span-39-3"><a id="__codelineno-39-3" name="__codelineno-39-3"></a><span class="nt">metadata</span><span class="p">:</span>
</span><span id="__span-39-4"><a id="__codelineno-39-4" name="__codelineno-39-4"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ddns-updater-pomerium-ingress</span>
</span><span id="__span-39-5"><a id="__codelineno-39-5" name="__codelineno-39-5"></a><span class="w">  </span><span class="nt">annotations</span><span class="p">:</span>
</span><span id="__span-39-6"><a id="__codelineno-39-6" name="__codelineno-39-6"></a><span class="w">    </span><span class="nt">cert-manager.io/cluster-issuer</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">letsencrypt-prod</span>
</span><span id="__span-39-7"><a id="__codelineno-39-7" name="__codelineno-39-7"></a><span class="hll"><span class="w">    </span><span class="nt">ingress.pomerium.io/allow_public_unauthenticated_access</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
</span></span><span id="__span-39-8"><a id="__codelineno-39-8" name="__codelineno-39-8"></a><span class="nt">spec</span><span class="p">:</span>
</span><span id="__span-39-9"><a id="__codelineno-39-9" name="__codelineno-39-9"></a><span class="w">  </span><span class="nt">ingressClassName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">pomerium</span>
</span><span id="__span-39-10"><a id="__codelineno-39-10" name="__codelineno-39-10"></a><span class="w">  </span><span class="nt">rules</span><span class="p">:</span>
</span><span id="__span-39-11"><a id="__codelineno-39-11" name="__codelineno-39-11"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">host</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ddns-updater.very-very-dark-gray.top</span>
</span><span id="__span-39-12"><a id="__codelineno-39-12" name="__codelineno-39-12"></a><span class="w">      </span><span class="nt">http</span><span class="p">:</span>
</span><span id="__span-39-13"><a id="__codelineno-39-13" name="__codelineno-39-13"></a><span class="w">        </span><span class="nt">paths</span><span class="p">:</span>
</span><span id="__span-39-14"><a id="__codelineno-39-14" name="__codelineno-39-14"></a><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/</span>
</span><span id="__span-39-15"><a id="__codelineno-39-15" name="__codelineno-39-15"></a><span class="w">          </span><span class="nt">pathType</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Prefix</span>
</span><span id="__span-39-16"><a id="__codelineno-39-16" name="__codelineno-39-16"></a><span class="w">          </span><span class="nt">backend</span><span class="p">:</span>
</span><span id="__span-39-17"><a id="__codelineno-39-17" name="__codelineno-39-17"></a><span class="w">            </span><span class="nt">service</span><span class="p">:</span>
</span><span id="__span-39-18"><a id="__codelineno-39-18" name="__codelineno-39-18"></a><span class="w">              </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ddns-updater-svc</span>
</span><span id="__span-39-19"><a id="__codelineno-39-19" name="__codelineno-39-19"></a><span class="w">              </span><span class="nt">port</span><span class="p">:</span>
</span><span id="__span-39-20"><a id="__codelineno-39-20" name="__codelineno-39-20"></a><span class="w">                </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s">"http"</span>
</span><span id="__span-39-21"><a id="__codelineno-39-21" name="__codelineno-39-21"></a><span class="w">  </span><span class="nt">tls</span><span class="p">:</span>
</span><span id="__span-39-22"><a id="__codelineno-39-22" name="__codelineno-39-22"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">hosts</span><span class="p">:</span>
</span><span id="__span-39-23"><a id="__codelineno-39-23" name="__codelineno-39-23"></a><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ddns-updater.very-very-dark-gray.top</span>
</span><span id="__span-39-24"><a id="__codelineno-39-24" name="__codelineno-39-24"></a><span class="w">      </span><span class="nt">secretName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">tls-secret</span>
</span></code></pre></div></td></tr></tbody></table></div>
</details>
<p>Applying the above setup will create (or update) all the Pomerium <code>Ingress</code> at once:</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-40-1"><a id="__codelineno-40-1" name="__codelineno-40-1" href="#__codelineno-40-1"></a><span class="gp">$ </span>kubectl<span class="w"> </span>apply<span class="w"> </span>-k<span class="w"> </span>pomerium-ingress
</span><span id="__span-40-2"><a id="__codelineno-40-2" name="__codelineno-40-2" href="#__codelineno-40-2"></a><span class="go">ingress.networking.k8s.io/audiobookshelf-pomerium-ingress created</span>
</span><span id="__span-40-3"><a id="__codelineno-40-3" name="__codelineno-40-3" href="#__codelineno-40-3"></a><span class="go">ingress.networking.k8s.io/dashboard-pomerium-ingress created</span>
</span><span id="__span-40-4"><a id="__codelineno-40-4" name="__codelineno-40-4" href="#__codelineno-40-4"></a><span class="go">ingress.networking.k8s.io/ddns-updater-pomerium-ingress created</span>
</span></code></pre></div>
<p>By having both the global policy and the overrides in the <code>patches</code> list, Kustomize
applies them sequentially, so that each application-specific patch overrides the global 
policy in the first patch. This is more reliable and easier to work with than
<code>commonAnnotations</code> which is a "global transformer" and rather difficult to override
because it applies to everything in the final build.</p>
<h2 id="final-traffic-migration">Final Traffic Migration</h2>
<p>Once all services have a Pomerium <code>Ingress</code> and are reachable on their assigned FQDN on
port 8443, move traffic on port 443 over to the new Pomerium <code>Ingress</code>:</p>
<ol>
<li>Confirm the UniFi router and access points have their inform URL set to the 
    <code>LoadBalancer</code> IP of the UniFi Network application, which will not change.<ul>
<li>UniFi access points accessible through SSH can be easily checked: the IP address
    is in the <code>cfg/mgmt</code> file, under variables<code>mgmt.servers.1.url</code> and <code>mgmt_url</code>.</li>
</ul>
</li>
<li>Log into the UniFi Network application at port 8443 on its <code>LoadBalancer</code> IP (e.g.
    <a href="https://192.168.0.173:8443/">https://192.168.0.173:8443/</a>)</li>
<li>Update port forwarding rules on the router to point port 443 to the <code>LoadBalancer</code>
    IP of Pomerium, and 8443 to Nginx, i.e. the opposite as the current setup.</li>
<li>Remove <code>:8443</code> from the <code>authenticate.url</code> in <code>pomerium-settings.yaml</code> (and <code>apply</code>).</li>
</ol>
<h2 id="clean-up-retired-nginx-ingress">Clean-up retired Nginx Ingress</h2>
<p>Once all the traffic has been migrated and there is no need for Nginx ingresses, they
can be deleted with this script:</p>
<div class="language-bash highlight"><span class="filename">delete-nginx-ingress.sh</span><pre><span></span><code><span id="__span-41-1"><a id="__codelineno-41-1" name="__codelineno-41-1" href="#__codelineno-41-1"></a><span class="ch">#!/bin/bash</span>
</span><span id="__span-41-2"><a id="__codelineno-41-2" name="__codelineno-41-2" href="#__codelineno-41-2"></a><span class="c1"># Find and delete Nginx Ingress</span>
</span><span id="__span-41-3"><a id="__codelineno-41-3" name="__codelineno-41-3" href="#__codelineno-41-3"></a>
</span><span id="__span-41-4"><a id="__codelineno-41-4" name="__codelineno-41-4" href="#__codelineno-41-4"></a>kubectl<span class="w"> </span>get<span class="w"> </span>ingress<span class="w"> </span>-A<span class="w"> </span><span class="p">|</span><span class="w"> </span>awk<span class="w"> </span><span class="s1">'NR &gt; 1 {print $1, $2, $3}'</span><span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="se">\</span>
</span><span id="__span-41-5"><a id="__codelineno-41-5" name="__codelineno-41-5" href="#__codelineno-41-5"></a><span class="k">while</span><span class="w"> </span><span class="nv">IFS</span><span class="o">=</span><span class="s1">$' '</span><span class="w"> </span><span class="nb">read</span><span class="w"> </span>-r<span class="w"> </span>namespace<span class="w"> </span>name<span class="w"> </span>class<span class="p">;</span><span class="w"> </span><span class="k">do</span>
</span><span id="__span-41-6"><a id="__codelineno-41-6" name="__codelineno-41-6" href="#__codelineno-41-6"></a><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="o">[[</span><span class="w"> </span><span class="s2">"</span><span class="nv">$class</span><span class="s2">"</span><span class="w"> </span>!<span class="o">=</span><span class="w"> </span><span class="s2">"nginx"</span><span class="w"> </span><span class="o">]]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span><span class="w"> </span><span class="k">continue</span><span class="p">;</span><span class="w"> </span><span class="k">fi</span>
</span><span id="__span-41-7"><a id="__codelineno-41-7" name="__codelineno-41-7" href="#__codelineno-41-7"></a><span class="w">  </span><span class="nb">echo</span><span class="w"> </span>-e<span class="w"> </span><span class="s2">"\nRemoving </span><span class="si">${</span><span class="nv">name</span><span class="si">}</span><span class="s2"> from </span><span class="si">${</span><span class="nv">namespace</span><span class="si">}</span><span class="s2">: "</span>
</span><span id="__span-41-8"><a id="__codelineno-41-8" name="__codelineno-41-8" href="#__codelineno-41-8"></a><span class="w">  </span>kubectl<span class="w"> </span>get<span class="w"> </span>ingress<span class="w"> </span><span class="s2">"</span><span class="si">${</span><span class="nv">name</span><span class="si">}</span><span class="s2">"</span><span class="w"> </span>-n<span class="w"> </span><span class="s2">"</span><span class="si">${</span><span class="nv">namespace</span><span class="si">}</span><span class="s2">"</span>
</span><span id="__span-41-9"><a id="__codelineno-41-9" name="__codelineno-41-9" href="#__codelineno-41-9"></a><span class="w">  </span>kubectl<span class="w"> </span>delete<span class="w"> </span>ingress<span class="w"> </span><span class="s2">"</span><span class="si">${</span><span class="nv">name</span><span class="si">}</span><span class="s2">"</span><span class="w"> </span>-n<span class="w"> </span><span class="s2">"</span><span class="si">${</span><span class="nv">namespace</span><span class="si">}</span><span class="s2">"</span>
</span><span id="__span-41-10"><a id="__codelineno-41-10" name="__codelineno-41-10" href="#__codelineno-41-10"></a><span class="k">done</span>
</span></code></pre></div>
<details class="terminal">
<summary>Result from running <code>delete-nginx-ingress.sh</code>.</summary>
<div class="language-console highlight"><pre><span></span><code><span id="__span-42-1"><a id="__codelineno-42-1" name="__codelineno-42-1" href="#__codelineno-42-1"></a><span class="gp">$ </span>delete-nginx-ingress
</span><span id="__span-42-2"><a id="__codelineno-42-2" name="__codelineno-42-2" href="#__codelineno-42-2"></a>
</span><span id="__span-42-3"><a id="__codelineno-42-3" name="__codelineno-42-3" href="#__codelineno-42-3"></a><span class="go">Removing audiobookshelf-ingress from audiobookshelf: </span>
</span><span id="__span-42-4"><a id="__codelineno-42-4" name="__codelineno-42-4" href="#__codelineno-42-4"></a><span class="go">NAME                     CLASS   HOSTS                     ADDRESS         PORTS     AGE</span>
</span><span id="__span-42-5"><a id="__codelineno-42-5" name="__codelineno-42-5" href="#__codelineno-42-5"></a><span class="go">audiobookshelf-ingress   nginx   audiobookshelf.very-very-dark-gray.top   192.168.0.171   80, 443   239d</span>
</span><span id="__span-42-6"><a id="__codelineno-42-6" name="__codelineno-42-6" href="#__codelineno-42-6"></a><span class="go">ingress.networking.k8s.io "audiobookshelf-ingress" deleted</span>
</span><span id="__span-42-7"><a id="__codelineno-42-7" name="__codelineno-42-7" href="#__codelineno-42-7"></a>
</span><span id="__span-42-8"><a id="__codelineno-42-8" name="__codelineno-42-8" href="#__codelineno-42-8"></a><span class="go">Removing code-server-ingress from code-server: </span>
</span><span id="__span-42-9"><a id="__codelineno-42-9" name="__codelineno-42-9" href="#__codelineno-42-9"></a><span class="go">NAME                  CLASS   HOSTS                            ADDRESS         PORTS     AGE</span>
</span><span id="__span-42-10"><a id="__codelineno-42-10" name="__codelineno-42-10" href="#__codelineno-42-10"></a><span class="go">code-server-ingress   nginx   code.very-very-dark-gray.top   192.168.0.171   80, 443   237d</span>
</span><span id="__span-42-11"><a id="__codelineno-42-11" name="__codelineno-42-11" href="#__codelineno-42-11"></a><span class="go">ingress.networking.k8s.io "code-server-ingress" deleted</span>
</span><span id="__span-42-12"><a id="__codelineno-42-12" name="__codelineno-42-12" href="#__codelineno-42-12"></a>
</span><span id="__span-42-13"><a id="__codelineno-42-13" name="__codelineno-42-13" href="#__codelineno-42-13"></a><span class="go">Removing firefly-iii-ingress from firefly-iii: </span>
</span><span id="__span-42-14"><a id="__codelineno-42-14" name="__codelineno-42-14" href="#__codelineno-42-14"></a><span class="go">NAME                  CLASS   HOSTS                           ADDRESS         PORTS     AGE</span>
</span><span id="__span-42-15"><a id="__codelineno-42-15" name="__codelineno-42-15" href="#__codelineno-42-15"></a><span class="go">firefly-iii-ingress   nginx   firefly.very-very-dark-gray.top   192.168.0.171   80, 443   237d</span>
</span><span id="__span-42-16"><a id="__codelineno-42-16" name="__codelineno-42-16" href="#__codelineno-42-16"></a><span class="go">ingress.networking.k8s.io "firefly-iii-ingress" deleted</span>
</span><span id="__span-42-17"><a id="__codelineno-42-17" name="__codelineno-42-17" href="#__codelineno-42-17"></a>
</span><span id="__span-42-18"><a id="__codelineno-42-18" name="__codelineno-42-18" href="#__codelineno-42-18"></a><span class="go">Removing komga-ingress from komga: </span>
</span><span id="__span-42-19"><a id="__codelineno-42-19" name="__codelineno-42-19" href="#__codelineno-42-19"></a><span class="go">NAME            CLASS   HOSTS                  ADDRESS         PORTS     AGE</span>
</span><span id="__span-42-20"><a id="__codelineno-42-20" name="__codelineno-42-20" href="#__codelineno-42-20"></a><span class="go">komga-ingress   nginx   komga.very-very-dark-gray.top   192.168.0.171   80, 443   239d</span>
</span><span id="__span-42-21"><a id="__codelineno-42-21" name="__codelineno-42-21" href="#__codelineno-42-21"></a><span class="go">ingress.networking.k8s.io "komga-ingress" deleted</span>
</span><span id="__span-42-22"><a id="__codelineno-42-22" name="__codelineno-42-22" href="#__codelineno-42-22"></a>
</span><span id="__span-42-23"><a id="__codelineno-42-23" name="__codelineno-42-23" href="#__codelineno-42-23"></a><span class="go">Removing jellyfin-ingress from media-center: </span>
</span><span id="__span-42-24"><a id="__codelineno-42-24" name="__codelineno-42-24" href="#__codelineno-42-24"></a><span class="go">NAME               CLASS   HOSTS                          ADDRESS         PORTS     AGE</span>
</span><span id="__span-42-25"><a id="__codelineno-42-25" name="__codelineno-42-25" href="#__codelineno-42-25"></a><span class="go">jellyfin-ingress   nginx   jellyfin.very-very-dark-gray.top   192.168.0.171   80, 443   238d</span>
</span><span id="__span-42-26"><a id="__codelineno-42-26" name="__codelineno-42-26" href="#__codelineno-42-26"></a><span class="go">ingress.networking.k8s.io "jellyfin-ingress" deleted</span>
</span><span id="__span-42-27"><a id="__codelineno-42-27" name="__codelineno-42-27" href="#__codelineno-42-27"></a>
</span><span id="__span-42-28"><a id="__codelineno-42-28" name="__codelineno-42-28" href="#__codelineno-42-28"></a><span class="go">Removing grafana-ingress from monitoring: </span>
</span><span id="__span-42-29"><a id="__codelineno-42-29" name="__codelineno-42-29" href="#__codelineno-42-29"></a><span class="go">NAME              CLASS   HOSTS                   ADDRESS         PORTS     AGE</span>
</span><span id="__span-42-30"><a id="__codelineno-42-30" name="__codelineno-42-30" href="#__codelineno-42-30"></a><span class="go">grafana-ingress   nginx   grafana.very-very-dark-gray.top   192.168.0.171   80, 443   240d</span>
</span><span id="__span-42-31"><a id="__codelineno-42-31" name="__codelineno-42-31" href="#__codelineno-42-31"></a><span class="go">ingress.networking.k8s.io "grafana-ingress" deleted</span>
</span><span id="__span-42-32"><a id="__codelineno-42-32" name="__codelineno-42-32" href="#__codelineno-42-32"></a>
</span><span id="__span-42-33"><a id="__codelineno-42-33" name="__codelineno-42-33" href="#__codelineno-42-33"></a><span class="go">Removing influxdb-ingress from monitoring: </span>
</span><span id="__span-42-34"><a id="__codelineno-42-34" name="__codelineno-42-34" href="#__codelineno-42-34"></a><span class="go">NAME               CLASS   HOSTS                         ADDRESS         PORTS     AGE</span>
</span><span id="__span-42-35"><a id="__codelineno-42-35" name="__codelineno-42-35" href="#__codelineno-42-35"></a><span class="go">influxdb-ingress   nginx   influxdb.very-very-dark-gray.top   192.168.0.171   80, 443   240d</span>
</span><span id="__span-42-36"><a id="__codelineno-42-36" name="__codelineno-42-36" href="#__codelineno-42-36"></a><span class="go">ingress.networking.k8s.io "influxdb-ingress" deleted</span>
</span><span id="__span-42-37"><a id="__codelineno-42-37" name="__codelineno-42-37" href="#__codelineno-42-37"></a>
</span><span id="__span-42-38"><a id="__codelineno-42-38" name="__codelineno-42-38" href="#__codelineno-42-38"></a><span class="go">Removing navidrome-ingress from navidrome: </span>
</span><span id="__span-42-39"><a id="__codelineno-42-39" name="__codelineno-42-39" href="#__codelineno-42-39"></a><span class="go">NAME                CLASS   HOSTS                              ADDRESS         PORTS     AGE</span>
</span><span id="__span-42-40"><a id="__codelineno-42-40" name="__codelineno-42-40" href="#__codelineno-42-40"></a><span class="go">navidrome-ingress   nginx   navidrome.very-very-dark-gray.top   192.168.0.171   80, 443   239d</span>
</span><span id="__span-42-41"><a id="__codelineno-42-41" name="__codelineno-42-41" href="#__codelineno-42-41"></a><span class="go">ingress.networking.k8s.io "navidrome-ingress" deleted</span>
</span><span id="__span-42-42"><a id="__codelineno-42-42" name="__codelineno-42-42" href="#__codelineno-42-42"></a>
</span><span id="__span-42-43"><a id="__codelineno-42-43" name="__codelineno-42-43" href="#__codelineno-42-43"></a><span class="go">Removing ryot-ingress from ryot: </span>
</span><span id="__span-42-44"><a id="__codelineno-42-44" name="__codelineno-42-44" href="#__codelineno-42-44"></a><span class="go">NAME           CLASS   HOSTS                          ADDRESS         PORTS     AGE</span>
</span><span id="__span-42-45"><a id="__codelineno-42-45" name="__codelineno-42-45" href="#__codelineno-42-45"></a><span class="go">ryot-ingress   nginx   ryot.very-very-dark-gray.top   192.168.0.171   80, 443   187d</span>
</span><span id="__span-42-46"><a id="__codelineno-42-46" name="__codelineno-42-46" href="#__codelineno-42-46"></a><span class="go">ingress.networking.k8s.io "ryot-ingress" deleted</span>
</span><span id="__span-42-47"><a id="__codelineno-42-47" name="__codelineno-42-47" href="#__codelineno-42-47"></a>
</span><span id="__span-42-48"><a id="__codelineno-42-48" name="__codelineno-42-48" href="#__codelineno-42-48"></a><span class="go">Removing steam-headless-ingress from steam-headless: </span>
</span><span id="__span-42-49"><a id="__codelineno-42-49" name="__codelineno-42-49" href="#__codelineno-42-49"></a><span class="go">NAME                     CLASS   HOSTS                          ADDRESS         PORTS     AGE</span>
</span><span id="__span-42-50"><a id="__codelineno-42-50" name="__codelineno-42-50" href="#__codelineno-42-50"></a><span class="go">steam-headless-ingress   nginx   steam.very-very-dark-gray.top   192.168.0.171   80, 443   149d</span>
</span><span id="__span-42-51"><a id="__codelineno-42-51" name="__codelineno-42-51" href="#__codelineno-42-51"></a><span class="go">ingress.networking.k8s.io "steam-headless-ingress" deleted</span>
</span><span id="__span-42-52"><a id="__codelineno-42-52" name="__codelineno-42-52" href="#__codelineno-42-52"></a>
</span><span id="__span-42-53"><a id="__codelineno-42-53" name="__codelineno-42-53" href="#__codelineno-42-53"></a><span class="go">Removing unifi-ingress from unifi: </span>
</span><span id="__span-42-54"><a id="__codelineno-42-54" name="__codelineno-42-54" href="#__codelineno-42-54"></a><span class="go">NAME            CLASS   HOSTS                       ADDRESS         PORTS     AGE</span>
</span><span id="__span-42-55"><a id="__codelineno-42-55" name="__codelineno-42-55" href="#__codelineno-42-55"></a><span class="go">unifi-ingress   nginx   unifi.very-very-dark-gray.top   192.168.0.171   80, 443   236d</span>
</span><span id="__span-42-56"><a id="__codelineno-42-56" name="__codelineno-42-56" href="#__codelineno-42-56"></a><span class="go">ingress.networking.k8s.io "unifi-ingress" deleted</span>
</span></code></pre></div>
</details>
<h3 id="tailscale">Tailscale</h3>
<p>The Tailscale Kubernetes operator does not depend on the NGINX Ingress Controller.</p>
<p>Creating an Ingress with <code>ingressClassName: tailscale</code>, the operator provisions its own
dedicated Tailscale proxy pods. Traffic from the tailnet goes directly to these
Tailscale proxy pods, which then route it to the backend services. It does not pass
through an NGINX ingress unless manually configured a "funnel" to do so.
The Tailscale operator handles its own TLS certificate management (via Let's Encrypt
and MagicDNS), independent of NGINX or cert-manager.</p>
<p><a href="https://tailscale.com/kb/1620/kubernetes-operator-byod-gateway-api">Custom domains with Kubernetes Gateway API and Tailscale</a>
may be desirable in the future, but it requires
<a href="https://gateway.envoyproxy.io/docs/install/install-helm/">Envoy Gateway (Helm)</a> and
<a href="https://github.com/kubernetes-sigs/external-dns?tab=readme-ov-file#externaldns">ExternalDNS</a>
to be installed first, plus a few more requirement that seem less straight-forward.
<strong>To be revisited</strong>.</p>
<h2 id="migrate-lets-encrypt-solvers">Migrate Let's Encrypt solvers</h2>
<p>Another use of the Ingress class <code>nginx</code> is made by the 
<a href="../../../04/12/kubernetes-homelab-server-with-ubuntu-server-2404-octavo/#configure-lets-encrypt">Let's Encrypt HTTP-01 solvers</a>
to obtain and renew HTTPS certificates.</p>
<p>Activating HTTP-01 solvers at this point will still use Ingress-NGINX, because
<code>cert-manager</code> was originally setup to use its ingress class <code>nginx</code>:</p>
<div class="admonition k8s">
<p class="admonition-title"><code>cert-manager-issuer.yaml</code></p>
<div class="language-yaml highlight"><pre><span></span><code><span id="__span-43-1"><a id="__codelineno-43-1" name="__codelineno-43-1" href="#__codelineno-43-1"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cert-manager.io/v1</span>
</span><span id="__span-43-2"><a id="__codelineno-43-2" name="__codelineno-43-2" href="#__codelineno-43-2"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ClusterIssuer</span>
</span><span id="__span-43-3"><a id="__codelineno-43-3" name="__codelineno-43-3" href="#__codelineno-43-3"></a><span class="nt">metadata</span><span class="p">:</span>
</span><span id="__span-43-4"><a id="__codelineno-43-4" name="__codelineno-43-4" href="#__codelineno-43-4"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">letsencrypt-prod</span>
</span><span id="__span-43-5"><a id="__codelineno-43-5" name="__codelineno-43-5" href="#__codelineno-43-5"></a><span class="nt">spec</span><span class="p">:</span>
</span><span id="__span-43-6"><a id="__codelineno-43-6" name="__codelineno-43-6" href="#__codelineno-43-6"></a><span class="w">  </span><span class="nt">acme</span><span class="p">:</span>
</span><span id="__span-43-7"><a id="__codelineno-43-7" name="__codelineno-43-7" href="#__codelineno-43-7"></a><span class="w">    </span><span class="nt">server</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">https://acme-v02.api.letsencrypt.org/directory</span>
</span><span id="__span-43-8"><a id="__codelineno-43-8" name="__codelineno-43-8" href="#__codelineno-43-8"></a><span class="w">    </span><span class="nt">privateKeySecretRef</span><span class="p">:</span>
</span><span id="__span-43-9"><a id="__codelineno-43-9" name="__codelineno-43-9" href="#__codelineno-43-9"></a><span class="w">      </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">letsencrypt-prod</span>
</span><span id="__span-43-10"><a id="__codelineno-43-10" name="__codelineno-43-10" href="#__codelineno-43-10"></a><span class="w">    </span><span class="nt">solvers</span><span class="p">:</span>
</span><span id="__span-43-11"><a id="__codelineno-43-11" name="__codelineno-43-11" href="#__codelineno-43-11"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">http01</span><span class="p">:</span>
</span><span id="__span-43-12"><a id="__codelineno-43-12" name="__codelineno-43-12" href="#__codelineno-43-12"></a><span class="w">          </span><span class="nt">ingress</span><span class="p">:</span>
</span><span id="__span-43-13"><a id="__codelineno-43-13" name="__codelineno-43-13" href="#__codelineno-43-13"></a><span class="hll"><span class="w">            </span><span class="nt">class</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nginx</span>
</span></span></code></pre></div>
</div>
<p>If Ingress-NGINX is uninstalled at this point, new HTTP-01 solvers will fail,
because they'll attempt to create a temporary Ingress with the <code>class: nginx</code>
annotation, which no longer has an active controller to fulfill it.</p>
<p>In other environments it may be possible to transition certificate renewals to
Pomerium, but Pomerium running in Kubernetes is not able to route requests to port
80 to the HTTP-01 solvers, it can only redirect to port 443 instead.</p>
<h3 id="switch-to-dns-01-solvers">Switch to DNS-01 solvers</h3>
<p>The better alternative is to switch <code>cert-manager</code> to DNS-01 solvers, which do not
require external requests to reach internal services, so it can be used to obtain
certificates even for internal-only services that are not externally reachable.</p>
<p>While CloudFlare DNS are supported by a native <code>cert-manager</code> driver, Porkbun is
supported for DNS-01 challenges only via webhook solvers, so one must install an
external webhook to bridge the Porkbun API with <code>cert-manager</code>. One such option is
<a href="https://github.com/Talinx/cert-manager-webhook-porkbun?tab=readme-ov-file#porkbun-webhook-for-cert-manager">Porkbun Webhook for cert-manager</a>;
install this via Helm into the <code>cert-manager</code> namespace:</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-44-1"><a id="__codelineno-44-1" name="__codelineno-44-1" href="#__codelineno-44-1"></a><span class="gp">$ </span>helm<span class="w"> </span>repo<span class="w"> </span>add<span class="w"> </span>cert-manager-webhook-porkbun<span class="w"> </span><span class="se">\</span>
</span><span id="__span-44-2"><a id="__codelineno-44-2" name="__codelineno-44-2" href="#__codelineno-44-2"></a><span class="w">  </span>https://talinx.github.io/cert-manager-webhook-porkbun
</span><span id="__span-44-3"><a id="__codelineno-44-3" name="__codelineno-44-3" href="#__codelineno-44-3"></a><span class="go">"cert-manager-webhook-porkbun" has been added to your repositories</span>
</span><span id="__span-44-4"><a id="__codelineno-44-4" name="__codelineno-44-4" href="#__codelineno-44-4"></a>
</span><span id="__span-44-5"><a id="__codelineno-44-5" name="__codelineno-44-5" href="#__codelineno-44-5"></a><span class="gp">$ </span>helm<span class="w"> </span>install<span class="w"> </span>cert-manager-webhook-porkbun<span class="w"> </span><span class="se">\</span>
</span><span id="__span-44-6"><a id="__codelineno-44-6" name="__codelineno-44-6" href="#__codelineno-44-6"></a><span class="w">  </span>cert-manager-webhook-porkbun/cert-manager-webhook-porkbun<span class="w"> </span><span class="se">\</span>
</span><span id="__span-44-7"><a id="__codelineno-44-7" name="__codelineno-44-7" href="#__codelineno-44-7"></a><span class="w">  </span>-n<span class="w"> </span>cert-manager<span class="w"> </span><span class="se">\</span>
</span><span id="__span-44-8"><a id="__codelineno-44-8" name="__codelineno-44-8" href="#__codelineno-44-8"></a><span class="w">  </span>--set<span class="w"> </span><span class="nv">groupName</span><span class="o">=</span>uu.am
</span><span id="__span-44-9"><a id="__codelineno-44-9" name="__codelineno-44-9" href="#__codelineno-44-9"></a><span class="go">NAME: cert-manager-webhook-porkbun</span>
</span><span id="__span-44-10"><a id="__codelineno-44-10" name="__codelineno-44-10" href="#__codelineno-44-10"></a><span class="go">LAST DEPLOYED: Fri Jan 16 23:30:55 2026</span>
</span><span id="__span-44-11"><a id="__codelineno-44-11" name="__codelineno-44-11" href="#__codelineno-44-11"></a><span class="go">NAMESPACE: cert-manager</span>
</span><span id="__span-44-12"><a id="__codelineno-44-12" name="__codelineno-44-12" href="#__codelineno-44-12"></a><span class="go">STATUS: deployed</span>
</span><span id="__span-44-13"><a id="__codelineno-44-13" name="__codelineno-44-13" href="#__codelineno-44-13"></a><span class="go">REVISION: 1</span>
</span><span id="__span-44-14"><a id="__codelineno-44-14" name="__codelineno-44-14" href="#__codelineno-44-14"></a><span class="go">NOTES:</span>
</span><span id="__span-44-15"><a id="__codelineno-44-15" name="__codelineno-44-15" href="#__codelineno-44-15"></a><span class="go">Porkbun cert-manager Webhook</span>
</span><span id="__span-44-16"><a id="__codelineno-44-16" name="__codelineno-44-16" href="#__codelineno-44-16"></a><span class="go">Create an issuer and a certificate to issue a certificate for a domain.</span>
</span><span id="__span-44-17"><a id="__codelineno-44-17" name="__codelineno-44-17" href="#__codelineno-44-17"></a>
</span><span id="__span-44-18"><a id="__codelineno-44-18" name="__codelineno-44-18" href="#__codelineno-44-18"></a><span class="gp">$ </span>helm<span class="w"> </span>get<span class="w"> </span>values<span class="w"> </span>cert-manager-webhook-porkbun<span class="w"> </span>-n<span class="w"> </span>cert-manager
</span><span id="__span-44-19"><a id="__codelineno-44-19" name="__codelineno-44-19" href="#__codelineno-44-19"></a><span class="go">USER-SUPPLIED VALUES:</span>
</span><span id="__span-44-20"><a id="__codelineno-44-20" name="__codelineno-44-20" href="#__codelineno-44-20"></a><span class="go">groupName: uu.am</span>
</span></code></pre></div>
<p>Create a <code>ClusterRole</code> and <code>ClusterRoleBinding</code> to allow the <code>cert-manager</code> controller
to access the Porkbun webhook's API:</p>
<div class="admonition k8s">
<p class="admonition-title"><code>cert-manager-issuer-rbac.yaml</code></p>
<div class="language-yaml highlight"><pre><span></span><code><span id="__span-45-1"><a id="__codelineno-45-1" name="__codelineno-45-1" href="#__codelineno-45-1"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">rbac.authorization.k8s.io/v1</span>
</span><span id="__span-45-2"><a id="__codelineno-45-2" name="__codelineno-45-2" href="#__codelineno-45-2"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ClusterRole</span>
</span><span id="__span-45-3"><a id="__codelineno-45-3" name="__codelineno-45-3" href="#__codelineno-45-3"></a><span class="nt">metadata</span><span class="p">:</span>
</span><span id="__span-45-4"><a id="__codelineno-45-4" name="__codelineno-45-4" href="#__codelineno-45-4"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cert-manager-webhook-porkbun:domain-solver</span>
</span><span id="__span-45-5"><a id="__codelineno-45-5" name="__codelineno-45-5" href="#__codelineno-45-5"></a><span class="nt">rules</span><span class="p">:</span>
</span><span id="__span-45-6"><a id="__codelineno-45-6" name="__codelineno-45-6" href="#__codelineno-45-6"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">apiGroups</span><span class="p">:</span>
</span><span id="__span-45-7"><a id="__codelineno-45-7" name="__codelineno-45-7" href="#__codelineno-45-7"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">uu.am</span><span class="w">          </span><span class="c1"># must match webhook's groupName</span>
</span><span id="__span-45-8"><a id="__codelineno-45-8" name="__codelineno-45-8" href="#__codelineno-45-8"></a><span class="w">    </span><span class="nt">resources</span><span class="p">:</span>
</span><span id="__span-45-9"><a id="__codelineno-45-9" name="__codelineno-45-9" href="#__codelineno-45-9"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">porkbun</span><span class="w">        </span><span class="c1"># must match webhook's solverName</span>
</span><span id="__span-45-10"><a id="__codelineno-45-10" name="__codelineno-45-10" href="#__codelineno-45-10"></a><span class="w">    </span><span class="nt">verbs</span><span class="p">:</span>
</span><span id="__span-45-11"><a id="__codelineno-45-11" name="__codelineno-45-11" href="#__codelineno-45-11"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">create</span>
</span><span id="__span-45-12"><a id="__codelineno-45-12" name="__codelineno-45-12" href="#__codelineno-45-12"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">get</span>
</span><span id="__span-45-13"><a id="__codelineno-45-13" name="__codelineno-45-13" href="#__codelineno-45-13"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">list</span>
</span><span id="__span-45-14"><a id="__codelineno-45-14" name="__codelineno-45-14" href="#__codelineno-45-14"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">watch</span>
</span><span id="__span-45-15"><a id="__codelineno-45-15" name="__codelineno-45-15" href="#__codelineno-45-15"></a><span class="nn">---</span>
</span><span id="__span-45-16"><a id="__codelineno-45-16" name="__codelineno-45-16" href="#__codelineno-45-16"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">rbac.authorization.k8s.io/v1</span>
</span><span id="__span-45-17"><a id="__codelineno-45-17" name="__codelineno-45-17" href="#__codelineno-45-17"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ClusterRoleBinding</span>
</span><span id="__span-45-18"><a id="__codelineno-45-18" name="__codelineno-45-18" href="#__codelineno-45-18"></a><span class="nt">metadata</span><span class="p">:</span>
</span><span id="__span-45-19"><a id="__codelineno-45-19" name="__codelineno-45-19" href="#__codelineno-45-19"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cert-manager-webhook-porkbun:domain-solver</span>
</span><span id="__span-45-20"><a id="__codelineno-45-20" name="__codelineno-45-20" href="#__codelineno-45-20"></a><span class="nt">roleRef</span><span class="p">:</span>
</span><span id="__span-45-21"><a id="__codelineno-45-21" name="__codelineno-45-21" href="#__codelineno-45-21"></a><span class="w">  </span><span class="nt">apiGroup</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">rbac.authorization.k8s.io</span>
</span><span id="__span-45-22"><a id="__codelineno-45-22" name="__codelineno-45-22" href="#__codelineno-45-22"></a><span class="w">  </span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ClusterRole</span>
</span><span id="__span-45-23"><a id="__codelineno-45-23" name="__codelineno-45-23" href="#__codelineno-45-23"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cert-manager-webhook-porkbun:domain-solver</span>
</span><span id="__span-45-24"><a id="__codelineno-45-24" name="__codelineno-45-24" href="#__codelineno-45-24"></a><span class="nt">subjects</span><span class="p">:</span>
</span><span id="__span-45-25"><a id="__codelineno-45-25" name="__codelineno-45-25" href="#__codelineno-45-25"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ServiceAccount</span>
</span><span id="__span-45-26"><a id="__codelineno-45-26" name="__codelineno-45-26" href="#__codelineno-45-26"></a><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cert-manager</span>
</span><span id="__span-45-27"><a id="__codelineno-45-27" name="__codelineno-45-27" href="#__codelineno-45-27"></a><span class="w">    </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cert-manager</span>
</span></code></pre></div>
</div>
<div class="language-console highlight"><pre><span></span><code><span id="__span-46-1"><a id="__codelineno-46-1" name="__codelineno-46-1" href="#__codelineno-46-1"></a><span class="gp">$ </span>kubectl<span class="w"> </span>apply<span class="w"> </span>-f<span class="w"> </span>cert-manager-issuer-rbac.yaml<span class="w"> </span>
</span><span id="__span-46-2"><a id="__codelineno-46-2" name="__codelineno-46-2" href="#__codelineno-46-2"></a><span class="go">Warning: resource clusterroles/cert-manager-webhook-porkbun:domain-solver is missing the kubectl.kubernetes.io/last-applied-configuration annotation which is required by kubectl apply. kubectl apply should only be used on resources created declaratively by either kubectl create --save-config or kubectl apply. The missing annotation will be patched automatically.</span>
</span><span id="__span-46-3"><a id="__codelineno-46-3" name="__codelineno-46-3" href="#__codelineno-46-3"></a><span class="go">clusterrole.rbac.authorization.k8s.io/cert-manager-webhook-porkbun:domain-solver configured</span>
</span><span id="__span-46-4"><a id="__codelineno-46-4" name="__codelineno-46-4" href="#__codelineno-46-4"></a><span class="go">Warning: resource clusterrolebindings/cert-manager-webhook-porkbun:domain-solver is missing the kubectl.kubernetes.io/last-applied-configuration annotation which is required by kubectl apply. kubectl apply should only be used on resources created declaratively by either kubectl create --save-config or kubectl apply. The missing annotation will be patched automatically.</span>
</span><span id="__span-46-5"><a id="__codelineno-46-5" name="__codelineno-46-5" href="#__codelineno-46-5"></a><span class="go">clusterrolebinding.rbac.authorization.k8s.io/cert-manager-webhook-porkbun:domain-solver configured</span>
</span></code></pre></div>
<p>While HTTP-01 solvers work independently of domain name, DNS-01 solvers are specific to
each domain name if they are managed by different DNS providers. In this case, one
domain is managed by Porkbun while another is managed by Cloudflare.</p>
<p>For CloudFlare, to allow <code>cert-manager</code> to perform DNS-01 challenges, create a scoped
API token in the Cloudflare Dashboard: </p>
<ol>
<li>Navigate to <strong>My Profile</strong> (top right corner) and select <strong>API Tokens</strong>.</li>
<li>Click <strong>Create Token</strong>.</li>
<li>Select the <strong>Edit zone DNS</strong> template.</li>
<li>Configure the following Permissions:<ul>
<li><strong>Zone &gt; DNS &gt; Edit</strong></li>
<li><strong>Zone &gt; Zone &gt; Read</strong></li>
</ul>
</li>
<li>Under <strong>Zone Resources</strong>, select <strong>Include</strong> and choose the specific zones this
    token should manage (e.g., <code>very-very-dark-gray.top</code>).</li>
<li>Click <strong>Continue to summary</strong>, then <strong>Create Toke</strong>n.</li>
<li><strong>Copy the token immediately</strong>; it will only be displayed once. </li>
</ol>
<p>Create also <a href="https://kb.porkbun.com/article/190-getting-started-with-the-porkbun-api">a porkbun API key</a>,
or re-use the one already created for
<a href="../../../09/25/ddns-updater-on-kubernetes/"><code>ddns-updater</code></a>,
and store all the above in two Kubernetes secrets within the <code>cert-manager</code> namespace:</p>
<div class="admonition k8s">
<p class="admonition-title"><code>cert-manager-issuer-dns-secrets.yaml</code></p>
<div class="language-yaml highlight"><pre><span></span><code><span id="__span-47-1"><a id="__codelineno-47-1" name="__codelineno-47-1" href="#__codelineno-47-1"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
</span><span id="__span-47-2"><a id="__codelineno-47-2" name="__codelineno-47-2" href="#__codelineno-47-2"></a><span class="nt">stringData</span><span class="p">:</span>
</span><span id="__span-47-3"><a id="__codelineno-47-3" name="__codelineno-47-3" href="#__codelineno-47-3"></a><span class="w">  </span><span class="nt">PORKBUN_API_KEY</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">PORKBUN_API_KEY</span>
</span><span id="__span-47-4"><a id="__codelineno-47-4" name="__codelineno-47-4" href="#__codelineno-47-4"></a><span class="w">  </span><span class="nt">PORKBUN_SECRET_API_KEY</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">PORKBUN_SECRET_API_KEY</span>
</span><span id="__span-47-5"><a id="__codelineno-47-5" name="__codelineno-47-5" href="#__codelineno-47-5"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Secret</span>
</span><span id="__span-47-6"><a id="__codelineno-47-6" name="__codelineno-47-6" href="#__codelineno-47-6"></a><span class="nt">metadata</span><span class="p">:</span>
</span><span id="__span-47-7"><a id="__codelineno-47-7" name="__codelineno-47-7" href="#__codelineno-47-7"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">porkbun-secret</span>
</span><span id="__span-47-8"><a id="__codelineno-47-8" name="__codelineno-47-8" href="#__codelineno-47-8"></a><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cert-manager</span>
</span><span id="__span-47-9"><a id="__codelineno-47-9" name="__codelineno-47-9" href="#__codelineno-47-9"></a><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Opaque</span>
</span><span id="__span-47-10"><a id="__codelineno-47-10" name="__codelineno-47-10" href="#__codelineno-47-10"></a><span class="nn">---</span>
</span><span id="__span-47-11"><a id="__codelineno-47-11" name="__codelineno-47-11" href="#__codelineno-47-11"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
</span><span id="__span-47-12"><a id="__codelineno-47-12" name="__codelineno-47-12" href="#__codelineno-47-12"></a><span class="nt">stringData</span><span class="p">:</span>
</span><span id="__span-47-13"><a id="__codelineno-47-13" name="__codelineno-47-13" href="#__codelineno-47-13"></a><span class="w">  </span><span class="nt">CLOUDFLARE_API_TOKEN</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">CLOUDFLARE_API_TOKEN</span>
</span><span id="__span-47-14"><a id="__codelineno-47-14" name="__codelineno-47-14" href="#__codelineno-47-14"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Secret</span>
</span><span id="__span-47-15"><a id="__codelineno-47-15" name="__codelineno-47-15" href="#__codelineno-47-15"></a><span class="nt">metadata</span><span class="p">:</span>
</span><span id="__span-47-16"><a id="__codelineno-47-16" name="__codelineno-47-16" href="#__codelineno-47-16"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cloudflare-secret</span>
</span><span id="__span-47-17"><a id="__codelineno-47-17" name="__codelineno-47-17" href="#__codelineno-47-17"></a><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cert-manager</span>
</span><span id="__span-47-18"><a id="__codelineno-47-18" name="__codelineno-47-18" href="#__codelineno-47-18"></a><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Opaque</span>
</span></code></pre></div>
</div>
<div class="language-console highlight"><pre><span></span><code><span id="__span-48-1"><a id="__codelineno-48-1" name="__codelineno-48-1" href="#__codelineno-48-1"></a><span class="gp">$ </span>kubectl<span class="w"> </span>apply<span class="w"> </span>-f<span class="w"> </span>cert-manager-issuer-dns-secrets.yaml<span class="w"> </span>
</span><span id="__span-48-2"><a id="__codelineno-48-2" name="__codelineno-48-2" href="#__codelineno-48-2"></a><span class="go">secret/porkbun-secret created</span>
</span><span id="__span-48-3"><a id="__codelineno-48-3" name="__codelineno-48-3" href="#__codelineno-48-3"></a><span class="go">secret/cloudflare-secret created</span>
</span></code></pre></div>
<p>Update <code>ClusterIssuer</code> to use the native CloudFlare and the Porkbun webhook solvers;
these replaces the <code>http01</code> section completely (thus bypassing Pomerium redirects).
The <code>ClusterIssuer</code> configuration needs two separate <code>dns01</code> solvers, one for each
DNS provider:</p>
<div class="admonition k8s">
<p class="admonition-title"><code>cert-manager-issuer-dns-secrets.yaml</code></p>
<div class="language-yaml highlight"><pre><span></span><code><span id="__span-49-1"><a id="__codelineno-49-1" name="__codelineno-49-1" href="#__codelineno-49-1"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cert-manager.io/v1</span>
</span><span id="__span-49-2"><a id="__codelineno-49-2" name="__codelineno-49-2" href="#__codelineno-49-2"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ClusterIssuer</span>
</span><span id="__span-49-3"><a id="__codelineno-49-3" name="__codelineno-49-3" href="#__codelineno-49-3"></a><span class="nt">metadata</span><span class="p">:</span>
</span><span id="__span-49-4"><a id="__codelineno-49-4" name="__codelineno-49-4" href="#__codelineno-49-4"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">letsencrypt-prod</span>
</span><span id="__span-49-5"><a id="__codelineno-49-5" name="__codelineno-49-5" href="#__codelineno-49-5"></a><span class="nt">spec</span><span class="p">:</span>
</span><span id="__span-49-6"><a id="__codelineno-49-6" name="__codelineno-49-6" href="#__codelineno-49-6"></a><span class="w">  </span><span class="nt">acme</span><span class="p">:</span>
</span><span id="__span-49-7"><a id="__codelineno-49-7" name="__codelineno-49-7" href="#__codelineno-49-7"></a><span class="w">    </span><span class="nt">server</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">https://acme-v02.api.letsencrypt.org/directory</span>
</span><span id="__span-49-8"><a id="__codelineno-49-8" name="__codelineno-49-8" href="#__codelineno-49-8"></a><span class="w">    </span><span class="nt">email</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">root@uu.am</span>
</span><span id="__span-49-9"><a id="__codelineno-49-9" name="__codelineno-49-9" href="#__codelineno-49-9"></a><span class="w">    </span><span class="nt">privateKeySecretRef</span><span class="p">:</span>
</span><span id="__span-49-10"><a id="__codelineno-49-10" name="__codelineno-49-10" href="#__codelineno-49-10"></a><span class="w">      </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">letsencrypt-prod</span>
</span><span id="__span-49-11"><a id="__codelineno-49-11" name="__codelineno-49-11" href="#__codelineno-49-11"></a><span class="w">    </span><span class="nt">solvers</span><span class="p">:</span>
</span><span id="__span-49-12"><a id="__codelineno-49-12" name="__codelineno-49-12" href="#__codelineno-49-12"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">selector</span><span class="p">:</span>
</span><span id="__span-49-13"><a id="__codelineno-49-13" name="__codelineno-49-13" href="#__codelineno-49-13"></a><span class="w">          </span><span class="nt">dnsZones</span><span class="p">:</span>
</span><span id="__span-49-14"><a id="__codelineno-49-14" name="__codelineno-49-14" href="#__codelineno-49-14"></a><span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">uu.am</span>
</span><span id="__span-49-15"><a id="__codelineno-49-15" name="__codelineno-49-15" href="#__codelineno-49-15"></a><span class="w">        </span><span class="nt">dns01</span><span class="p">:</span>
</span><span id="__span-49-16"><a id="__codelineno-49-16" name="__codelineno-49-16" href="#__codelineno-49-16"></a><span class="w">          </span><span class="nt">webhook</span><span class="p">:</span>
</span><span id="__span-49-17"><a id="__codelineno-49-17" name="__codelineno-49-17" href="#__codelineno-49-17"></a><span class="w">            </span><span class="nt">groupName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">uu.am</span>
</span><span id="__span-49-18"><a id="__codelineno-49-18" name="__codelineno-49-18" href="#__codelineno-49-18"></a><span class="w">            </span><span class="nt">solverName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">porkbun</span>
</span><span id="__span-49-19"><a id="__codelineno-49-19" name="__codelineno-49-19" href="#__codelineno-49-19"></a><span class="w">            </span><span class="nt">config</span><span class="p">:</span>
</span><span id="__span-49-20"><a id="__codelineno-49-20" name="__codelineno-49-20" href="#__codelineno-49-20"></a><span class="w">              </span><span class="nt">apiKey</span><span class="p">:</span>
</span><span id="__span-49-21"><a id="__codelineno-49-21" name="__codelineno-49-21" href="#__codelineno-49-21"></a><span class="w">                </span><span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">PORKBUN_API_KEY</span>
</span><span id="__span-49-22"><a id="__codelineno-49-22" name="__codelineno-49-22" href="#__codelineno-49-22"></a><span class="w">                </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">porkbun-secret</span>
</span><span id="__span-49-23"><a id="__codelineno-49-23" name="__codelineno-49-23" href="#__codelineno-49-23"></a><span class="w">              </span><span class="nt">secretApiKey</span><span class="p">:</span>
</span><span id="__span-49-24"><a id="__codelineno-49-24" name="__codelineno-49-24" href="#__codelineno-49-24"></a><span class="w">                </span><span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">PORKBUN_SECRET_API_KEY</span>
</span><span id="__span-49-25"><a id="__codelineno-49-25" name="__codelineno-49-25" href="#__codelineno-49-25"></a><span class="w">                </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">porkbun-secret</span>
</span><span id="__span-49-26"><a id="__codelineno-49-26" name="__codelineno-49-26" href="#__codelineno-49-26"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">selector</span><span class="p">:</span>
</span><span id="__span-49-27"><a id="__codelineno-49-27" name="__codelineno-49-27" href="#__codelineno-49-27"></a><span class="w">          </span><span class="nt">dnsZones</span><span class="p">:</span>
</span><span id="__span-49-28"><a id="__codelineno-49-28" name="__codelineno-49-28" href="#__codelineno-49-28"></a><span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">very-very-dark-gray.top</span>
</span><span id="__span-49-29"><a id="__codelineno-49-29" name="__codelineno-49-29" href="#__codelineno-49-29"></a><span class="w">        </span><span class="nt">dns01</span><span class="p">:</span>
</span><span id="__span-49-30"><a id="__codelineno-49-30" name="__codelineno-49-30" href="#__codelineno-49-30"></a><span class="w">          </span><span class="nt">cloudflare</span><span class="p">:</span>
</span><span id="__span-49-31"><a id="__codelineno-49-31" name="__codelineno-49-31" href="#__codelineno-49-31"></a><span class="w">            </span><span class="nt">apiTokenSecretRef</span><span class="p">:</span>
</span><span id="__span-49-32"><a id="__codelineno-49-32" name="__codelineno-49-32" href="#__codelineno-49-32"></a><span class="w">              </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cloudflare-secret</span>
</span><span id="__span-49-33"><a id="__codelineno-49-33" name="__codelineno-49-33" href="#__codelineno-49-33"></a><span class="w">              </span><span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">CLOUDFLARE_API_TOKEN</span>
</span></code></pre></div>
</div>
<div class="language-console highlight"><pre><span></span><code><span id="__span-50-1"><a id="__codelineno-50-1" name="__codelineno-50-1" href="#__codelineno-50-1"></a><span class="gp">$ </span>kubectl<span class="w"> </span>apply<span class="w"> </span>-f<span class="w"> </span>cert-manager-issuer.yaml<span class="w"> </span>
</span><span id="__span-50-2"><a id="__codelineno-50-2" name="__codelineno-50-2" href="#__codelineno-50-2"></a><span class="go">clusterissuer.cert-manager.io/letsencrypt-prod configured</span>
</span></code></pre></div>
<p>To test the new DNS solvers, add an <code>Ingress</code> under each domain for a simple service
(e.g. <code>ddns-updater</code>) to trigger the creation of a certificate under each one:</p>
<div class="admonition k8s">
<p class="admonition-title"><code>pomerium/pomerium-ingress/ddns-updater.yaml</code></p>
<div class="language-yaml highlight"><pre><span></span><code><span id="__span-51-1"><a id="__codelineno-51-1" name="__codelineno-51-1" href="#__codelineno-51-1"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">networking.k8s.io/v1</span>
</span><span id="__span-51-2"><a id="__codelineno-51-2" name="__codelineno-51-2" href="#__codelineno-51-2"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Ingress</span>
</span><span id="__span-51-3"><a id="__codelineno-51-3" name="__codelineno-51-3" href="#__codelineno-51-3"></a><span class="nt">metadata</span><span class="p">:</span>
</span><span id="__span-51-4"><a id="__codelineno-51-4" name="__codelineno-51-4" href="#__codelineno-51-4"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ddns-updater-pomerium-ingress</span>
</span><span id="__span-51-5"><a id="__codelineno-51-5" name="__codelineno-51-5" href="#__codelineno-51-5"></a><span class="w">  </span><span class="nt">annotations</span><span class="p">:</span>
</span><span id="__span-51-6"><a id="__codelineno-51-6" name="__codelineno-51-6" href="#__codelineno-51-6"></a><span class="w">    </span><span class="nt">cert-manager.io/cluster-issuer</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">letsencrypt-prod</span>
</span><span id="__span-51-7"><a id="__codelineno-51-7" name="__codelineno-51-7" href="#__codelineno-51-7"></a><span class="nt">spec</span><span class="p">:</span>
</span><span id="__span-51-8"><a id="__codelineno-51-8" name="__codelineno-51-8" href="#__codelineno-51-8"></a><span class="w">  </span><span class="nt">ingressClassName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">pomerium</span>
</span><span id="__span-51-9"><a id="__codelineno-51-9" name="__codelineno-51-9" href="#__codelineno-51-9"></a><span class="w">  </span><span class="nt">rules</span><span class="p">:</span>
</span><span id="__span-51-10"><a id="__codelineno-51-10" name="__codelineno-51-10" href="#__codelineno-51-10"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">host</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ddns-updater.uu.am</span>
</span><span id="__span-51-11"><a id="__codelineno-51-11" name="__codelineno-51-11" href="#__codelineno-51-11"></a><span class="w">      </span><span class="nt">http</span><span class="p">:</span>
</span><span id="__span-51-12"><a id="__codelineno-51-12" name="__codelineno-51-12" href="#__codelineno-51-12"></a><span class="w">        </span><span class="nt">paths</span><span class="p">:</span>
</span><span id="__span-51-13"><a id="__codelineno-51-13" name="__codelineno-51-13" href="#__codelineno-51-13"></a><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/</span>
</span><span id="__span-51-14"><a id="__codelineno-51-14" name="__codelineno-51-14" href="#__codelineno-51-14"></a><span class="w">          </span><span class="nt">pathType</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Prefix</span>
</span><span id="__span-51-15"><a id="__codelineno-51-15" name="__codelineno-51-15" href="#__codelineno-51-15"></a><span class="w">          </span><span class="nt">backend</span><span class="p">:</span>
</span><span id="__span-51-16"><a id="__codelineno-51-16" name="__codelineno-51-16" href="#__codelineno-51-16"></a><span class="w">            </span><span class="nt">service</span><span class="p">:</span>
</span><span id="__span-51-17"><a id="__codelineno-51-17" name="__codelineno-51-17" href="#__codelineno-51-17"></a><span class="w">              </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ddns-updater-svc</span>
</span><span id="__span-51-18"><a id="__codelineno-51-18" name="__codelineno-51-18" href="#__codelineno-51-18"></a><span class="w">              </span><span class="nt">port</span><span class="p">:</span>
</span><span id="__span-51-19"><a id="__codelineno-51-19" name="__codelineno-51-19" href="#__codelineno-51-19"></a><span class="w">                </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s">"http"</span>
</span><span id="__span-51-20"><a id="__codelineno-51-20" name="__codelineno-51-20" href="#__codelineno-51-20"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">host</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ddns-updater.very-very-dark-gray.top</span>
</span><span id="__span-51-21"><a id="__codelineno-51-21" name="__codelineno-51-21" href="#__codelineno-51-21"></a><span class="w">      </span><span class="nt">http</span><span class="p">:</span>
</span><span id="__span-51-22"><a id="__codelineno-51-22" name="__codelineno-51-22" href="#__codelineno-51-22"></a><span class="w">        </span><span class="nt">paths</span><span class="p">:</span>
</span><span id="__span-51-23"><a id="__codelineno-51-23" name="__codelineno-51-23" href="#__codelineno-51-23"></a><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/</span>
</span><span id="__span-51-24"><a id="__codelineno-51-24" name="__codelineno-51-24" href="#__codelineno-51-24"></a><span class="w">          </span><span class="nt">pathType</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Prefix</span>
</span><span id="__span-51-25"><a id="__codelineno-51-25" name="__codelineno-51-25" href="#__codelineno-51-25"></a><span class="w">          </span><span class="nt">backend</span><span class="p">:</span>
</span><span id="__span-51-26"><a id="__codelineno-51-26" name="__codelineno-51-26" href="#__codelineno-51-26"></a><span class="w">            </span><span class="nt">service</span><span class="p">:</span>
</span><span id="__span-51-27"><a id="__codelineno-51-27" name="__codelineno-51-27" href="#__codelineno-51-27"></a><span class="w">              </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ddns-updater-svc</span>
</span><span id="__span-51-28"><a id="__codelineno-51-28" name="__codelineno-51-28" href="#__codelineno-51-28"></a><span class="w">              </span><span class="nt">port</span><span class="p">:</span>
</span><span id="__span-51-29"><a id="__codelineno-51-29" name="__codelineno-51-29" href="#__codelineno-51-29"></a><span class="w">                </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s">"http"</span>
</span><span id="__span-51-30"><a id="__codelineno-51-30" name="__codelineno-51-30" href="#__codelineno-51-30"></a><span class="w">  </span><span class="nt">tls</span><span class="p">:</span>
</span><span id="__span-51-31"><a id="__codelineno-51-31" name="__codelineno-51-31" href="#__codelineno-51-31"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">hosts</span><span class="p">:</span>
</span><span id="__span-51-32"><a id="__codelineno-51-32" name="__codelineno-51-32" href="#__codelineno-51-32"></a><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ddns-updater.uu.am</span>
</span><span id="__span-51-33"><a id="__codelineno-51-33" name="__codelineno-51-33" href="#__codelineno-51-33"></a><span class="w">      </span><span class="nt">secretName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">tls-secret-uu-am</span>
</span><span id="__span-51-34"><a id="__codelineno-51-34" name="__codelineno-51-34" href="#__codelineno-51-34"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">hosts</span><span class="p">:</span>
</span><span id="__span-51-35"><a id="__codelineno-51-35" name="__codelineno-51-35" href="#__codelineno-51-35"></a><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ddns-updater.very-very-dark-gray.top</span>
</span><span id="__span-51-36"><a id="__codelineno-51-36" name="__codelineno-51-36" href="#__codelineno-51-36"></a><span class="w">      </span><span class="nt">secretName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">tls-secret-cloudflare</span>
</span></code></pre></div>
</div>
<p>A few minutes after applying these to Pomerium, both certificates should be <code>READY</code>:</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-52-1"><a id="__codelineno-52-1" name="__codelineno-52-1" href="#__codelineno-52-1"></a><span class="gp">$ </span>kubectl<span class="w"> </span>get<span class="w"> </span>certificate
</span><span id="__span-52-2"><a id="__codelineno-52-2" name="__codelineno-52-2" href="#__codelineno-52-2"></a><span class="go">NAME                    READY   SECRET                  AGE</span>
</span><span id="__span-52-3"><a id="__codelineno-52-3" name="__codelineno-52-3" href="#__codelineno-52-3"></a><span class="go">tls-secret-cloudflare   True    tls-secret-cloudflare   14m</span>
</span><span id="__span-52-4"><a id="__codelineno-52-4" name="__codelineno-52-4" href="#__codelineno-52-4"></a><span class="go">tls-secret-uu-am        True    tls-secret-uu-am        14m</span>
</span></code></pre></div>
<h2 id="uninstall-ingress-nginx">Uninstall Ingress-NGINX</h2>
<p>After all the above migrations and consideration, the time finally comes to remove
Ingress-NGINX entirely:</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-53-1"><a id="__codelineno-53-1" name="__codelineno-53-1" href="#__codelineno-53-1"></a><span class="gp">$ </span>helm<span class="w"> </span>uninstall<span class="w"> </span>ingress-nginx<span class="w"> </span>-n<span class="w"> </span>ingress-nginx<span class="w"> </span>
</span><span id="__span-53-2"><a id="__codelineno-53-2" name="__codelineno-53-2" href="#__codelineno-53-2"></a><span class="go">release "ingress-nginx" uninstalled</span>
</span><span id="__span-53-3"><a id="__codelineno-53-3" name="__codelineno-53-3" href="#__codelineno-53-3"></a>
</span><span id="__span-53-4"><a id="__codelineno-53-4" name="__codelineno-53-4" href="#__codelineno-53-4"></a><span class="gp">$ </span>kubectl<span class="w"> </span>get<span class="w"> </span>all<span class="w"> </span>-n<span class="w"> </span>ingress-nginx
</span><span id="__span-53-5"><a id="__codelineno-53-5" name="__codelineno-53-5" href="#__codelineno-53-5"></a><span class="go">NAME                                           READY   STATUS        RESTARTS       AGE</span>
</span><span id="__span-53-6"><a id="__codelineno-53-6" name="__codelineno-53-6" href="#__codelineno-53-6"></a><span class="go">pod/ingress-nginx-controller-b49d9c7b9-w26hb   1/1     Terminating   20 (17h ago)   258d</span>
</span></code></pre></div>
<p>After a minute or so, there should be nothing left in the <code>ingress-nginx</code> namespace,
and the <code>ingress-nginx-admission</code> should be no longer found as one of the active
<code>validatingwebhookconfiguration</code>:</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-54-1"><a id="__codelineno-54-1" name="__codelineno-54-1" href="#__codelineno-54-1"></a><span class="gp">$ </span>kubectl<span class="w"> </span>get<span class="w"> </span>all<span class="w"> </span>-n<span class="w"> </span>ingress-nginx
</span><span id="__span-54-2"><a id="__codelineno-54-2" name="__codelineno-54-2" href="#__codelineno-54-2"></a><span class="go">No resources found in ingress-nginx namespace.</span>
</span></code></pre></div>
<div class="language-console highlight"><pre><span></span><code><span id="__span-55-1"><a id="__codelineno-55-1" name="__codelineno-55-1" href="#__codelineno-55-1"></a><span class="gp">$ </span>kubectl<span class="w"> </span>get<span class="w"> </span>validatingwebhookconfigurations<span class="w"> </span>
</span><span id="__span-55-2"><a id="__codelineno-55-2" name="__codelineno-55-2" href="#__codelineno-55-2"></a><span class="go">NAME                                                  WEBHOOKS   AGE</span>
</span><span id="__span-55-3"><a id="__codelineno-55-3" name="__codelineno-55-3" href="#__codelineno-55-3"></a><span class="go">cert-manager-webhook                                  1          258d</span>
</span><span id="__span-55-4"><a id="__codelineno-55-4" name="__codelineno-55-4" href="#__codelineno-55-4"></a><span class="go">inteldeviceplugins-validating-webhook-configuration   7          255d</span>
</span><span id="__span-55-5"><a id="__codelineno-55-5" name="__codelineno-55-5" href="#__codelineno-55-5"></a><span class="go">metallb-webhook-configuration                         6          258d</span>
</span><span id="__span-55-6"><a id="__codelineno-55-6" name="__codelineno-55-6" href="#__codelineno-55-6"></a><span class="go">prom-kube-prometheus-stack-admission                  2          19d</span>
</span></code></pre></div>
<p>There are actually a few resources left in the namespace:</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-56-1"><a id="__codelineno-56-1" name="__codelineno-56-1" href="#__codelineno-56-1"></a><span class="gp">$ </span>kubectl<span class="w"> </span>get<span class="w"> </span><span class="se">\</span>
</span><span id="__span-56-2"><a id="__codelineno-56-2" name="__codelineno-56-2" href="#__codelineno-56-2"></a><span class="w">  </span>-n<span class="w"> </span>ingress-nginx<span class="w"> </span><span class="se">\</span>
</span><span id="__span-56-3"><a id="__codelineno-56-3" name="__codelineno-56-3" href="#__codelineno-56-3"></a><span class="gp">  $</span><span class="o">(</span>kubectl<span class="w"> </span>api-resources<span class="w"> </span>--namespaced<span class="o">=</span><span class="nb">true</span><span class="w"> </span>--verbs<span class="o">=</span>list<span class="w"> </span>-o<span class="w"> </span>name<span class="w"> </span><span class="p">|</span><span class="w"> </span>tr<span class="w"> </span><span class="s1">'\n'</span><span class="w"> </span><span class="s1">','</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>sed<span class="w"> </span><span class="s1">'s/,$//'</span><span class="o">)</span>
</span><span id="__span-56-4"><a id="__codelineno-56-4" name="__codelineno-56-4" href="#__codelineno-56-4"></a><span class="go">NAME                         DATA   AGE</span>
</span><span id="__span-56-5"><a id="__codelineno-56-5" name="__codelineno-56-5" href="#__codelineno-56-5"></a><span class="go">configmap/kube-root-ca.crt   1      258d</span>
</span><span id="__span-56-6"><a id="__codelineno-56-6" name="__codelineno-56-6" href="#__codelineno-56-6"></a>
</span><span id="__span-56-7"><a id="__codelineno-56-7" name="__codelineno-56-7" href="#__codelineno-56-7"></a><span class="go">NAME                             TYPE     DATA   AGE</span>
</span><span id="__span-56-8"><a id="__codelineno-56-8" name="__codelineno-56-8" href="#__codelineno-56-8"></a><span class="go">secret/ingress-nginx-admission   Opaque   3      258d</span>
</span><span id="__span-56-9"><a id="__codelineno-56-9" name="__codelineno-56-9" href="#__codelineno-56-9"></a>
</span><span id="__span-56-10"><a id="__codelineno-56-10" name="__codelineno-56-10" href="#__codelineno-56-10"></a><span class="go">NAME                     SECRETS   AGE</span>
</span><span id="__span-56-11"><a id="__codelineno-56-11" name="__codelineno-56-11" href="#__codelineno-56-11"></a><span class="go">serviceaccount/default   0         258d</span>
</span><span id="__span-56-12"><a id="__codelineno-56-12" name="__codelineno-56-12" href="#__codelineno-56-12"></a>
</span><span id="__span-56-13"><a id="__codelineno-56-13" name="__codelineno-56-13" href="#__codelineno-56-13"></a><span class="go">NAME                                             HOLDER                                     AGE</span>
</span><span id="__span-56-14"><a id="__codelineno-56-14" name="__codelineno-56-14" href="#__codelineno-56-14"></a><span class="go">lease.coordination.k8s.io/ingress-nginx-leader   ingress-nginx-controller-b49d9c7b9-w26hb   258d</span>
</span></code></pre></div>
<p>These are all safe to remove:</p>
<ul>
<li><code>configmap/kube-root-ca.crt</code> is a standard Kubernetes resource automatically
    injected into every namespace. it contains the public certificate for the cluster's
    Certificate Authority (CA) so pods can verify the API server.</li>
<li><code>secret/ingress-nginx-admission</code> is a certificate used by the Validating Admission
    Webhook. It secured the communication that allowed the API server to ask NGINX
    "Is this new Ingress rule valid?" before saving it. Since the webhook configuration
    itself is gone, this certificate is orphaned and useless.</li>
<li><code>serviceaccount/default</code> is the default identity for pods in this namespace.</li>
<li><code>lease.coordination.k8s.io/ingress-nginx-leader</code> is a lock used by NGINX-ingress
    for "leader election". It ensures that when running multiple replicas of the ingress
    controller, only one acts as the "leader" to handle tasks like updating status
    fields on Ingress objects. It is a small, lightweight object that has no purpose
    without the NGINX pods. Helm often fails to delete these because they are created
    dynamically by the application at runtime rather than being part of the manifest.</li>
</ul>
<p>Since all these resources are either orphaned (lease, secret) or boilerplate
(configmap, serviceaccount), the cleanest and most efficient action is to delete the
entire namespace:</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-57-1"><a id="__codelineno-57-1" name="__codelineno-57-1" href="#__codelineno-57-1"></a><span class="gp">$ </span>kubectl<span class="w"> </span>delete<span class="w"> </span>namespace<span class="w"> </span>ingress-nginx
</span><span id="__span-57-2"><a id="__codelineno-57-2" name="__codelineno-57-2" href="#__codelineno-57-2"></a><span class="go">namespace "ingress-nginx" deleted</span>
</span></code></pre></div>
<h2 id="appendix-updating-pomerium">Appendix: updating Pomerium</h2>
<p>To update Pomerium, check the official documentation to
<a href="https://www.pomerium.com/docs/deploy/k8s/quickstart#install-pomerium">Install Pomerium</a>
for the URL it recommends to deploy from, e.g.</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-58-1"><a id="__codelineno-58-1" name="__codelineno-58-1" href="#__codelineno-58-1"></a><span class="gp">$ </span>kubectl<span class="w"> </span>apply<span class="w"> </span>-k<span class="w"> </span>github.com/pomerium/ingress-controller/config/default<span class="se">\?</span><span class="nv">ref</span><span class="o">=</span>v0.32.0
</span></code></pre></div>
<p>Go back to the local copy of the <code>pomerium/ingress-controller</code> repository, pull updates
and check that branch out:</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-59-1"><a id="__codelineno-59-1" name="__codelineno-59-1" href="#__codelineno-59-1"></a><span class="gp">$ </span>git<span class="w"> </span>status
</span><span id="__span-59-2"><a id="__codelineno-59-2" name="__codelineno-59-2" href="#__codelineno-59-2"></a><span class="go">HEAD detached at v0.31.3</span>
</span><span id="__span-59-3"><a id="__codelineno-59-3" name="__codelineno-59-3" href="#__codelineno-59-3"></a><span class="go">nothing to commit, working tree clean</span>
</span><span id="__span-59-4"><a id="__codelineno-59-4" name="__codelineno-59-4" href="#__codelineno-59-4"></a>
</span><span id="__span-59-5"><a id="__codelineno-59-5" name="__codelineno-59-5" href="#__codelineno-59-5"></a><span class="gp">$ </span>git<span class="w"> </span>pull
</span><span id="__span-59-6"><a id="__codelineno-59-6" name="__codelineno-59-6" href="#__codelineno-59-6"></a><span class="go">remote: Enumerating objects: 70, done.</span>
</span><span id="__span-59-7"><a id="__codelineno-59-7" name="__codelineno-59-7" href="#__codelineno-59-7"></a><span class="go">remote: Counting objects: 100% (24/24), done.</span>
</span><span id="__span-59-8"><a id="__codelineno-59-8" name="__codelineno-59-8" href="#__codelineno-59-8"></a><span class="go">remote: Compressing objects: 100% (11/11), done.</span>
</span><span id="__span-59-9"><a id="__codelineno-59-9" name="__codelineno-59-9" href="#__codelineno-59-9"></a><span class="go">remote: Total 70 (delta 14), reused 13 (delta 13), pack-reused 46 (from 1)</span>
</span><span id="__span-59-10"><a id="__codelineno-59-10" name="__codelineno-59-10" href="#__codelineno-59-10"></a><span class="go">Unpacking objects: 100% (70/70), 151.32 KiB | 968.00 KiB/s, done.</span>
</span><span id="__span-59-11"><a id="__codelineno-59-11" name="__codelineno-59-11" href="#__codelineno-59-11"></a><span class="go">From https://github.com/pomerium/ingress-controller</span>
</span><span id="__span-59-12"><a id="__codelineno-59-12" name="__codelineno-59-12" href="#__codelineno-59-12"></a><span class="go"> * [new branch]      0-32-0                -&gt; origin/0-32-0</span>
</span><span id="__span-59-13"><a id="__codelineno-59-13" name="__codelineno-59-13" href="#__codelineno-59-13"></a><span class="go"> * [new branch]      cagocs/release-script -&gt; origin/cagocs/release-script</span>
</span><span id="__span-59-14"><a id="__codelineno-59-14" name="__codelineno-59-14" href="#__codelineno-59-14"></a><span class="go">   a93102d..338ba7f  main                  -&gt; origin/main</span>
</span><span id="__span-59-15"><a id="__codelineno-59-15" name="__codelineno-59-15" href="#__codelineno-59-15"></a><span class="hll"><span class="go"> * [new tag]         v0.32.0               -&gt; v0.32.0</span>
</span></span><span id="__span-59-16"><a id="__codelineno-59-16" name="__codelineno-59-16" href="#__codelineno-59-16"></a><span class="go">You are not currently on a branch.</span>
</span><span id="__span-59-17"><a id="__codelineno-59-17" name="__codelineno-59-17" href="#__codelineno-59-17"></a><span class="go">Please specify which branch you want to merge with.</span>
</span><span id="__span-59-18"><a id="__codelineno-59-18" name="__codelineno-59-18" href="#__codelineno-59-18"></a><span class="go">See git-pull(1) for details.</span>
</span><span id="__span-59-19"><a id="__codelineno-59-19" name="__codelineno-59-19" href="#__codelineno-59-19"></a>
</span><span id="__span-59-20"><a id="__codelineno-59-20" name="__codelineno-59-20" href="#__codelineno-59-20"></a><span class="go">    git pull &lt;remote&gt; &lt;branch&gt;</span>
</span><span id="__span-59-21"><a id="__codelineno-59-21" name="__codelineno-59-21" href="#__codelineno-59-21"></a>
</span><span id="__span-59-22"><a id="__codelineno-59-22" name="__codelineno-59-22" href="#__codelineno-59-22"></a><span class="gp">$ </span>git<span class="w"> </span>checkout<span class="w"> </span>v0.32.0
</span><span id="__span-59-23"><a id="__codelineno-59-23" name="__codelineno-59-23" href="#__codelineno-59-23"></a><span class="go">Previous HEAD position was 14de0a0 prepare for v0.31.3 release (#1286)</span>
</span><span id="__span-59-24"><a id="__codelineno-59-24" name="__codelineno-59-24" href="#__codelineno-59-24"></a><span class="go">HEAD is now at d9e3e06 Customize ingress controller v0.32.0</span>
</span></code></pre></div>
<p>Now go back to the <code>pomerium-overlay</code> directory created to deploy
<a href="#pebble-storage">Pebble storage</a> and apply it again; check first with
<code>kubectl kustomize</code> that the new image will be pulled:</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-60-1"><a id="__codelineno-60-1" name="__codelineno-60-1" href="#__codelineno-60-1"></a><span class="gp">$ </span>kubectl<span class="w"> </span>kustomize<span class="w"> </span>pomerium-overlay<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span><span class="s1">'image:'</span>
</span><span id="__span-60-2"><a id="__codelineno-60-2" name="__codelineno-60-2" href="#__codelineno-60-2"></a><span class="gp"># </span>Warning:<span class="w"> </span><span class="s1">'commonLabels'</span><span class="w"> </span>is<span class="w"> </span>deprecated.<span class="w"> </span>Please<span class="w"> </span>use<span class="w"> </span><span class="s1">'labels'</span><span class="w"> </span>instead.<span class="w"> </span>Run<span class="w"> </span><span class="s1">'kustomize edit fix'</span><span class="w"> </span>to<span class="w"> </span>update<span class="w"> </span>your<span class="w"> </span>Kustomization<span class="w"> </span>automatically.
</span><span id="__span-60-3"><a id="__codelineno-60-3" name="__codelineno-60-3" href="#__codelineno-60-3"></a><span class="go">        image: pomerium/ingress-controller:v0.32.0</span>
</span><span id="__span-60-4"><a id="__codelineno-60-4" name="__codelineno-60-4" href="#__codelineno-60-4"></a><span class="go">        image: pomerium/ingress-controller:main</span>
</span></code></pre></div>
<p>After applying the change, Pomerium will be running the new version:</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-61-1"><a id="__codelineno-61-1" name="__codelineno-61-1" href="#__codelineno-61-1"></a><span class="gp">$ </span>kubectl<span class="w"> </span>apply<span class="w"> </span>-k<span class="w"> </span>pomerium-overlay<span class="w"> </span>
</span><span id="__span-61-2"><a id="__codelineno-61-2" name="__codelineno-61-2" href="#__codelineno-61-2"></a><span class="gp"># </span>Warning:<span class="w"> </span><span class="s1">'commonLabels'</span><span class="w"> </span>is<span class="w"> </span>deprecated.<span class="w"> </span>Please<span class="w"> </span>use<span class="w"> </span><span class="s1">'labels'</span><span class="w"> </span>instead.<span class="w"> </span>Run<span class="w"> </span><span class="s1">'kustomize edit fix'</span><span class="w"> </span>to<span class="w"> </span>update<span class="w"> </span>your<span class="w"> </span>Kustomization<span class="w"> </span>automatically.
</span><span id="__span-61-3"><a id="__codelineno-61-3" name="__codelineno-61-3" href="#__codelineno-61-3"></a><span class="go">namespace/pomerium unchanged</span>
</span><span id="__span-61-4"><a id="__codelineno-61-4" name="__codelineno-61-4" href="#__codelineno-61-4"></a><span class="go">customresourcedefinition.apiextensions.k8s.io/policyfilters.gateway.pomerium.io unchanged</span>
</span><span id="__span-61-5"><a id="__codelineno-61-5" name="__codelineno-61-5" href="#__codelineno-61-5"></a><span class="hll"><span class="go">customresourcedefinition.apiextensions.k8s.io/pomerium.ingress.pomerium.io configured</span>
</span></span><span id="__span-61-6"><a id="__codelineno-61-6" name="__codelineno-61-6" href="#__codelineno-61-6"></a><span class="go">serviceaccount/pomerium-controller unchanged</span>
</span><span id="__span-61-7"><a id="__codelineno-61-7" name="__codelineno-61-7" href="#__codelineno-61-7"></a><span class="go">serviceaccount/pomerium-gen-secrets unchanged</span>
</span><span id="__span-61-8"><a id="__codelineno-61-8" name="__codelineno-61-8" href="#__codelineno-61-8"></a><span class="go">clusterrole.rbac.authorization.k8s.io/pomerium-controller unchanged</span>
</span><span id="__span-61-9"><a id="__codelineno-61-9" name="__codelineno-61-9" href="#__codelineno-61-9"></a><span class="go">clusterrole.rbac.authorization.k8s.io/pomerium-gen-secrets unchanged</span>
</span><span id="__span-61-10"><a id="__codelineno-61-10" name="__codelineno-61-10" href="#__codelineno-61-10"></a><span class="go">clusterrolebinding.rbac.authorization.k8s.io/pomerium-controller unchanged</span>
</span><span id="__span-61-11"><a id="__codelineno-61-11" name="__codelineno-61-11" href="#__codelineno-61-11"></a><span class="go">clusterrolebinding.rbac.authorization.k8s.io/pomerium-gen-secrets unchanged</span>
</span><span id="__span-61-12"><a id="__codelineno-61-12" name="__codelineno-61-12" href="#__codelineno-61-12"></a><span class="go">service/pomerium-metrics unchanged</span>
</span><span id="__span-61-13"><a id="__codelineno-61-13" name="__codelineno-61-13" href="#__codelineno-61-13"></a><span class="go">service/pomerium-proxy unchanged</span>
</span><span id="__span-61-14"><a id="__codelineno-61-14" name="__codelineno-61-14" href="#__codelineno-61-14"></a><span class="go">persistentvolume/pomerium-pv-data unchanged</span>
</span><span id="__span-61-15"><a id="__codelineno-61-15" name="__codelineno-61-15" href="#__codelineno-61-15"></a><span class="go">persistentvolumeclaim/pomerium-pvc-data unchanged</span>
</span><span id="__span-61-16"><a id="__codelineno-61-16" name="__codelineno-61-16" href="#__codelineno-61-16"></a><span class="hll"><span class="go">deployment.apps/pomerium configured</span>
</span></span><span id="__span-61-17"><a id="__codelineno-61-17" name="__codelineno-61-17" href="#__codelineno-61-17"></a><span class="go">job.batch/pomerium-gen-secrets unchanged</span>
</span><span id="__span-61-18"><a id="__codelineno-61-18" name="__codelineno-61-18" href="#__codelineno-61-18"></a><span class="go">ingressclass.networking.k8s.io/pomerium unchanged</span>
</span><span id="__span-61-19"><a id="__codelineno-61-19" name="__codelineno-61-19" href="#__codelineno-61-19"></a>
</span><span id="__span-61-20"><a id="__codelineno-61-20" name="__codelineno-61-20" href="#__codelineno-61-20"></a><span class="gp">$ </span>kubectl<span class="w"> </span>-n<span class="w"> </span>pomerium<span class="w"> </span>describe<span class="w"> </span>pod<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span><span class="s1">'Image:'</span>
</span><span id="__span-61-21"><a id="__codelineno-61-21" name="__codelineno-61-21" href="#__codelineno-61-21"></a><span class="hll"><span class="go">    Image:         pomerium/ingress-controller:v0.32.0</span>
</span></span></code></pre></div>
<h2 id="appendix-alfred-migration">Appendix: <code>alfred</code> migration</h2>
<p>Same setup can be applied to <code>alfred</code>, which has all services behind either Tailscale
or CloudFlare, with the following changes.</p>
<h3 id="alfred-pomerium-crd">Alfred Pomerium CRD</h3>
<p>While <code>octavo</code> was moved to a different domain, configured with
<a href="../../../09/25/ddns-updater-on-kubernetes/">ddns-updater</a> to route external traffic
directly through the router to Pomerium, <code>alfred</code> is behind a router that does not
allow routing external traffic via port forwarding. This means, while Pomerium in
<code>octavo</code> has <code>authenticate.url</code> pointing to that other domain, <code>alfred</code> needs
<a href="#pomerium-crd">Pomerium CRD</a> to have <code>authenticate.url</code> pointing to the domain that is
setup with CloudFlare.</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-62-1"><a id="__codelineno-62-1" name="__codelineno-62-1" href="#__codelineno-62-1"></a><span class="gp">$ </span>kubectl<span class="w"> </span>apply<span class="w"> </span>-f<span class="w"> </span>pomerium-settings-alfred.yaml<span class="w"> </span>
</span><span id="__span-62-2"><a id="__codelineno-62-2" name="__codelineno-62-2" href="#__codelineno-62-2"></a><span class="go">pomerium.ingress.pomerium.io/global configured</span>
</span></code></pre></div>
<h3 id="alfred-certifiate-for-the-auth-endpoint">Alfred Certifiate for the auth endpoint</h3>
<p>Similarly, a dedicated certificate for the <code>authenticate.very-very-dark-gray.top</code>
domain must be created, with the domain setup behind CloudFlare:</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-63-1"><a id="__codelineno-63-1" name="__codelineno-63-1" href="#__codelineno-63-1"></a><span class="gp">$ </span>kubectl<span class="w"> </span>apply<span class="w"> </span>-f<span class="w"> </span>auth-certificate-alfred.yaml<span class="w"> </span>
</span><span id="__span-63-2"><a id="__codelineno-63-2" name="__codelineno-63-2" href="#__codelineno-63-2"></a><span class="go">certificate.cert-manager.io/pomerium-auth-cert created</span>
</span></code></pre></div>
<h3 id="alfred-cloudflare-hostnames">Alfred CloudFlare hostnames</h3>
<p>Because <code>alfred</code> is only reachable through the CloudFlare tunnel, additional hostnames
have to be added in CloudFlare to make the <code>authenticate.very-very-dark-gray.top</code> route</p>
<ul>
<li>HTTP (port 80) requests to <code>/.well-known</code> to the <code>cm-acme-http-solver</code> service port,
    typically http://localhost:32080</li>
<li>HTTP (port 80) requests to the IP <code>LoadBalancer</code> IP address given to the
    <code>pomerium-proxy</code> service.</li>
</ul>
<div class="language-console highlight"><pre><span></span><code><span id="__span-64-1"><a id="__codelineno-64-1" name="__codelineno-64-1" href="#__codelineno-64-1"></a><span class="gp">$ </span>kubectl<span class="w"> </span>get<span class="w"> </span>svc<span class="w"> </span>-n<span class="w"> </span>pomerium
</span><span id="__span-64-2"><a id="__codelineno-64-2" name="__codelineno-64-2" href="#__codelineno-64-2"></a><span class="go">NAME                        TYPE           CLUSTER-IP       EXTERNAL-IP     PORT(S)                                    AGE</span>
</span><span id="__span-64-3"><a id="__codelineno-64-3" name="__codelineno-64-3" href="#__codelineno-64-3"></a><span class="go">cm-acme-http-solver-t6zdh   NodePort       10.101.209.98    &lt;none&gt;          8089:32080/TCP                             13m</span>
</span><span id="__span-64-4"><a id="__codelineno-64-4" name="__codelineno-64-4" href="#__codelineno-64-4"></a><span class="go">pomerium-metrics            ClusterIP      10.104.197.212   &lt;none&gt;          9090/TCP                                   25m</span>
</span><span id="__span-64-5"><a id="__codelineno-64-5" name="__codelineno-64-5" href="#__codelineno-64-5"></a><span class="go">pomerium-proxy              LoadBalancer   10.105.126.132   192.168.0.154   443:31936/TCP,443:31936/UDP,80:31514/TCP   25m</span>
</span></code></pre></div>
<p>Without the route to port 80, the <code>pomerium-auth-tls</code> certificate won't become <code>READY</code>.</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-65-1"><a id="__codelineno-65-1" name="__codelineno-65-1" href="#__codelineno-65-1"></a><span class="gp">$ </span>kubectl<span class="w"> </span>get<span class="w"> </span>certificate<span class="w"> </span>-n<span class="w"> </span>pomerium
</span><span id="__span-65-2"><a id="__codelineno-65-2" name="__codelineno-65-2" href="#__codelineno-65-2"></a><span class="go">NAME                 READY   SECRET              AGE</span>
</span><span id="__span-65-3"><a id="__codelineno-65-3" name="__codelineno-65-3" href="#__codelineno-65-3"></a><span class="go">pomerium-auth-cert   False   pomerium-auth-tls   7m25s</span>
</span></code></pre></div>
<p>Once the setup is ready in CloudFlare, it may take some time for <code>alfred</code> to pick up the
new DNS records.</p>
<h3 id="alfred-identity-provider-idp">Alfred Identity Provider (IdP)</h3>
<p>Again, <code>alfred</code> needs its own credentials for Google to authenticate @gmail.com users;
<a href="https://developers.google.com/identity/protocols/oauth2/web-server#creatingcred">create an OAuth 2.0 Client ID for Web Server Applications</a>,
obtain the client ID and secret from and store them in <code>google-idp-secret-alfred.yaml</code>:</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-66-1"><a id="__codelineno-66-1" name="__codelineno-66-1" href="#__codelineno-66-1"></a><span class="gp">$ </span>kubectl<span class="w"> </span>apply<span class="w"> </span>-f<span class="w"> </span>google-idp-secret-alfred.yaml<span class="w"> </span>
</span><span id="__span-66-2"><a id="__codelineno-66-2" name="__codelineno-66-2" href="#__codelineno-66-2"></a><span class="go">secret/idp-secret created</span>
</span></code></pre></div>
<h3 id="alfred-test-with-verify">Alfred test with Verify</h3>
<p>At this point Pomerium <em>should</em> be ready to <a href="#test-with-verify">test with Verify</a>,
but first additional <a href="#alfred-cloudflare-hostnames">CloudFlare hostnames</a> must be setup
to route requests to the <code>verify.</code> subdomain on ports 80 and 443. Once those are ready,
and the new certificate is <code>READY</code> too, applying the same <code>verify-service.yaml</code>
manifest get the application ready at <a href="https://verify.very-very-dark-gray.top">https://verify.very-very-dark-gray.top</a>.</p>
<h3 id="alfred-additional-settings">Alfred Additional Settings</h3>
<p><a href="#additional-settings">Additional Settings</a> can be copied directly for those services
running in <code>alfred</code> based on their counterparts in <code>octavo</code>, simply copying the
<code>pomerium-ingress</code> to <a href="#kustomize-per-service-acls">Kustomize per-service ACLs</a> as
a new directory (e.g. <code>alfred-ingress</code>); removing the files for services not running,
updating the FQDN for the services running in <code>alfred</code> behind CloudFlare tunnels,
and applying the directory:</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-67-1"><a id="__codelineno-67-1" name="__codelineno-67-1" href="#__codelineno-67-1"></a><span class="gp">$ </span>kubectl<span class="w"> </span>apply<span class="w"> </span>-k<span class="w"> </span>alfred-ingress
</span><span id="__span-67-2"><a id="__codelineno-67-2" name="__codelineno-67-2" href="#__codelineno-67-2"></a><span class="go">ingress.networking.k8s.io/audiobookshelf-pomerium-ingress created</span>
</span><span id="__span-67-3"><a id="__codelineno-67-3" name="__codelineno-67-3" href="#__codelineno-67-3"></a><span class="go">ingress.networking.k8s.io/home-assistant-pomerium-ingress created</span>
</span><span id="__span-67-4"><a id="__codelineno-67-4" name="__codelineno-67-4" href="#__codelineno-67-4"></a><span class="go">ingress.networking.k8s.io/dashboard-pomerium-ingress created</span>
</span><span id="__span-67-5"><a id="__codelineno-67-5" name="__codelineno-67-5" href="#__codelineno-67-5"></a><span class="go">ingress.networking.k8s.io/grafana-pomerium-ingress created</span>
</span><span id="__span-67-6"><a id="__codelineno-67-6" name="__codelineno-67-6" href="#__codelineno-67-6"></a>
</span><span id="__span-67-7"><a id="__codelineno-67-7" name="__codelineno-67-7" href="#__codelineno-67-7"></a><span class="gp">$ </span>kubectl<span class="w"> </span>get<span class="w"> </span>ingress<span class="w"> </span>-A<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>pomerium
</span><span id="__span-67-8"><a id="__codelineno-67-8" name="__codelineno-67-8" href="#__codelineno-67-8"></a><span class="go">audiobookshelf         audiobookshelf-pomerium-ingress          pomerium         arkham-library.very-very-dark-gray.top          192.168.0.154                               80, 443   62s</span>
</span><span id="__span-67-9"><a id="__codelineno-67-9" name="__codelineno-67-9" href="#__codelineno-67-9"></a><span class="go">home-assistant         home-assistant-pomerium-ingress          pomerium         home-assistant-alfred.very-very-dark-gray.top   192.168.0.154                               80, 443   22s</span>
</span><span id="__span-67-10"><a id="__codelineno-67-10" name="__codelineno-67-10" href="#__codelineno-67-10"></a><span class="go">kubernetes-dashboard   dashboard-pomerium-ingress               pomerium         kubernetes-alfred.very-very-dark-gray.top       192.168.0.154                               80, 443   62s</span>
</span><span id="__span-67-11"><a id="__codelineno-67-11" name="__codelineno-67-11" href="#__codelineno-67-11"></a><span class="go">monitoring             grafana-pomerium-ingress                 pomerium         bat-signal.very-very-dark-gray.top              192.168.0.154                               80, 443   62s</span>
</span></code></pre></div>
<p>At this point the hostnames in CloudFlare can be updated to route requests to the
LoadBalancer IP of the Pomerium service and that should complete the migration.</p>
<h3 id="alfred-lets-encrypt-solvers">Alfred Let's Encrypt solvers</h3>
<p>Alfred <code>cert-manager</code> also must <a href="#switch-to-dns-01-solvers">switch to DNS-01 solvers</a>
before uninstalling Ingress-NGINX. Since the setup is exactly the same as in Octavo,
the same manifests can be applied without any changes.</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-68-1"><a id="__codelineno-68-1" name="__codelineno-68-1" href="#__codelineno-68-1"></a><span class="gp">$ </span>helm<span class="w"> </span>repo<span class="w"> </span>add<span class="w"> </span>cert-manager-webhook-porkbun<span class="w"> </span><span class="se">\</span>
</span><span id="__span-68-2"><a id="__codelineno-68-2" name="__codelineno-68-2" href="#__codelineno-68-2"></a><span class="w">  </span>https://talinx.github.io/cert-manager-webhook-porkbun
</span><span id="__span-68-3"><a id="__codelineno-68-3" name="__codelineno-68-3" href="#__codelineno-68-3"></a><span class="go">"cert-manager-webhook-porkbun" has been added to your repositories</span>
</span><span id="__span-68-4"><a id="__codelineno-68-4" name="__codelineno-68-4" href="#__codelineno-68-4"></a>
</span><span id="__span-68-5"><a id="__codelineno-68-5" name="__codelineno-68-5" href="#__codelineno-68-5"></a><span class="gp">$ </span>helm<span class="w"> </span>install<span class="w"> </span>cert-manager-webhook-porkbun<span class="w"> </span><span class="se">\</span>
</span><span id="__span-68-6"><a id="__codelineno-68-6" name="__codelineno-68-6" href="#__codelineno-68-6"></a><span class="w">  </span>cert-manager-webhook-porkbun/cert-manager-webhook-porkbun<span class="w"> </span><span class="se">\</span>
</span><span id="__span-68-7"><a id="__codelineno-68-7" name="__codelineno-68-7" href="#__codelineno-68-7"></a><span class="w">  </span>-n<span class="w"> </span>cert-manager<span class="w"> </span><span class="se">\</span>
</span><span id="__span-68-8"><a id="__codelineno-68-8" name="__codelineno-68-8" href="#__codelineno-68-8"></a><span class="w">  </span>--set<span class="w"> </span><span class="nv">groupName</span><span class="o">=</span>uu.am
</span><span id="__span-68-9"><a id="__codelineno-68-9" name="__codelineno-68-9" href="#__codelineno-68-9"></a><span class="go">NAME: cert-manager-webhook-porkbun</span>
</span><span id="__span-68-10"><a id="__codelineno-68-10" name="__codelineno-68-10" href="#__codelineno-68-10"></a><span class="go">LAST DEPLOYED: Sat Jan 17 21:27:45 2026</span>
</span><span id="__span-68-11"><a id="__codelineno-68-11" name="__codelineno-68-11" href="#__codelineno-68-11"></a><span class="go">NAMESPACE: cert-manager</span>
</span><span id="__span-68-12"><a id="__codelineno-68-12" name="__codelineno-68-12" href="#__codelineno-68-12"></a><span class="go">STATUS: deployed</span>
</span><span id="__span-68-13"><a id="__codelineno-68-13" name="__codelineno-68-13" href="#__codelineno-68-13"></a><span class="go">REVISION: 1</span>
</span><span id="__span-68-14"><a id="__codelineno-68-14" name="__codelineno-68-14" href="#__codelineno-68-14"></a><span class="go">NOTES:</span>
</span><span id="__span-68-15"><a id="__codelineno-68-15" name="__codelineno-68-15" href="#__codelineno-68-15"></a><span class="go">Porkbun cert-manager Webhook</span>
</span><span id="__span-68-16"><a id="__codelineno-68-16" name="__codelineno-68-16" href="#__codelineno-68-16"></a><span class="go">Create an issuer and a certificate to issue a certificate for a domain.</span>
</span><span id="__span-68-17"><a id="__codelineno-68-17" name="__codelineno-68-17" href="#__codelineno-68-17"></a>
</span><span id="__span-68-18"><a id="__codelineno-68-18" name="__codelineno-68-18" href="#__codelineno-68-18"></a><span class="gp">$ </span>kubectl<span class="w"> </span>apply<span class="w"> </span>-f<span class="w"> </span>cert-manager-issuer-dns-secrets.yaml<span class="w"> </span>
</span><span id="__span-68-19"><a id="__codelineno-68-19" name="__codelineno-68-19" href="#__codelineno-68-19"></a><span class="go">secret/porkbun-secret created</span>
</span><span id="__span-68-20"><a id="__codelineno-68-20" name="__codelineno-68-20" href="#__codelineno-68-20"></a><span class="go">secret/cloudflare-secret created</span>
</span><span id="__span-68-21"><a id="__codelineno-68-21" name="__codelineno-68-21" href="#__codelineno-68-21"></a>
</span><span id="__span-68-22"><a id="__codelineno-68-22" name="__codelineno-68-22" href="#__codelineno-68-22"></a><span class="gp">$ </span>kubectl<span class="w"> </span>apply<span class="w"> </span>-f<span class="w"> </span>cert-manager-issuer-rbac.yaml<span class="w"> </span>
</span><span id="__span-68-23"><a id="__codelineno-68-23" name="__codelineno-68-23" href="#__codelineno-68-23"></a><span class="go">Warning: resource clusterroles/cert-manager-webhook-porkbun:domain-solver is missing the kubectl.kubernetes.io/last-applied-configuration annotation which is required by kubectl apply. kubectl apply should only be used on resources created declaratively by either kubectl create --save-config or kubectl apply. The missing annotation will be patched automatically.</span>
</span><span id="__span-68-24"><a id="__codelineno-68-24" name="__codelineno-68-24" href="#__codelineno-68-24"></a><span class="go">clusterrole.rbac.authorization.k8s.io/cert-manager-webhook-porkbun:domain-solver configured</span>
</span><span id="__span-68-25"><a id="__codelineno-68-25" name="__codelineno-68-25" href="#__codelineno-68-25"></a><span class="go">Warning: resource clusterrolebindings/cert-manager-webhook-porkbun:domain-solver is missing the kubectl.kubernetes.io/last-applied-configuration annotation which is required by kubectl apply. kubectl apply should only be used on resources created declaratively by either kubectl create --save-config or kubectl apply. The missing annotation will be patched automatically.</span>
</span><span id="__span-68-26"><a id="__codelineno-68-26" name="__codelineno-68-26" href="#__codelineno-68-26"></a><span class="go">clusterrolebinding.rbac.authorization.k8s.io/cert-manager-webhook-porkbun:domain-solver configured</span>
</span><span id="__span-68-27"><a id="__codelineno-68-27" name="__codelineno-68-27" href="#__codelineno-68-27"></a>
</span><span id="__span-68-28"><a id="__codelineno-68-28" name="__codelineno-68-28" href="#__codelineno-68-28"></a><span class="gp">$ </span>kubectl<span class="w"> </span>apply<span class="w"> </span>-f<span class="w"> </span>cert-manager-issuer.yaml<span class="w"> </span>
</span><span id="__span-68-29"><a id="__codelineno-68-29" name="__codelineno-68-29" href="#__codelineno-68-29"></a><span class="go">Warning: resource clusterissuers/letsencrypt-prod is missing the kubectl.kubernetes.io/last-applied-configuration annotation which is required by kubectl apply. kubectl apply should only be used on resources created declaratively by either kubectl create --save-config or kubectl apply. The missing annotation will be patched automatically.</span>
</span><span id="__span-68-30"><a id="__codelineno-68-30" name="__codelineno-68-30" href="#__codelineno-68-30"></a><span class="go">clusterissuer.cert-manager.io/letsencrypt-prod configured</span>
</span></code></pre></div>
<h3 id="alfred-clean-up">Alfred clean-up</h3>
<p>Ingress-NGINX was installed in <code>alfred</code> using the <code>nginx-baremetal.yaml</code> manifest from
<a href="https://raw.githubusercontent.com/kubernetes/ingress-nginx/controller-v1.12.0/deploy/static/provider/baremetal/deploy.yaml">kubernetes/ingress-nginx</a>
so the recommended method to uninstall it is to <code>delete</code> all those resources, since a
few of them will not be deleted when deleting the <code>ingress-nginx</code> namespace:</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-69-1"><a id="__codelineno-69-1" name="__codelineno-69-1" href="#__codelineno-69-1"></a><span class="gp">$ </span>kubectl<span class="w"> </span>delete<span class="w"> </span>-f<span class="w"> </span>nginx-baremetal.yaml
</span><span id="__span-69-2"><a id="__codelineno-69-2" name="__codelineno-69-2" href="#__codelineno-69-2"></a><span class="go">namespace "ingress-nginx" deleted</span>
</span><span id="__span-69-3"><a id="__codelineno-69-3" name="__codelineno-69-3" href="#__codelineno-69-3"></a><span class="go">serviceaccount "ingress-nginx" deleted</span>
</span><span id="__span-69-4"><a id="__codelineno-69-4" name="__codelineno-69-4" href="#__codelineno-69-4"></a><span class="go">serviceaccount "ingress-nginx-admission" deleted</span>
</span><span id="__span-69-5"><a id="__codelineno-69-5" name="__codelineno-69-5" href="#__codelineno-69-5"></a><span class="go">role.rbac.authorization.k8s.io "ingress-nginx" deleted</span>
</span><span id="__span-69-6"><a id="__codelineno-69-6" name="__codelineno-69-6" href="#__codelineno-69-6"></a><span class="go">role.rbac.authorization.k8s.io "ingress-nginx-admission" deleted</span>
</span><span id="__span-69-7"><a id="__codelineno-69-7" name="__codelineno-69-7" href="#__codelineno-69-7"></a><span class="go">clusterrole.rbac.authorization.k8s.io "ingress-nginx" deleted</span>
</span><span id="__span-69-8"><a id="__codelineno-69-8" name="__codelineno-69-8" href="#__codelineno-69-8"></a><span class="go">clusterrole.rbac.authorization.k8s.io "ingress-nginx-admission" deleted</span>
</span><span id="__span-69-9"><a id="__codelineno-69-9" name="__codelineno-69-9" href="#__codelineno-69-9"></a><span class="go">rolebinding.rbac.authorization.k8s.io "ingress-nginx" deleted</span>
</span><span id="__span-69-10"><a id="__codelineno-69-10" name="__codelineno-69-10" href="#__codelineno-69-10"></a><span class="go">rolebinding.rbac.authorization.k8s.io "ingress-nginx-admission" deleted</span>
</span><span id="__span-69-11"><a id="__codelineno-69-11" name="__codelineno-69-11" href="#__codelineno-69-11"></a><span class="go">clusterrolebinding.rbac.authorization.k8s.io "ingress-nginx" deleted</span>
</span><span id="__span-69-12"><a id="__codelineno-69-12" name="__codelineno-69-12" href="#__codelineno-69-12"></a><span class="go">clusterrolebinding.rbac.authorization.k8s.io "ingress-nginx-admission" deleted</span>
</span><span id="__span-69-13"><a id="__codelineno-69-13" name="__codelineno-69-13" href="#__codelineno-69-13"></a><span class="go">configmap "ingress-nginx-controller" deleted</span>
</span><span id="__span-69-14"><a id="__codelineno-69-14" name="__codelineno-69-14" href="#__codelineno-69-14"></a><span class="go">service "ingress-nginx-controller" deleted</span>
</span><span id="__span-69-15"><a id="__codelineno-69-15" name="__codelineno-69-15" href="#__codelineno-69-15"></a><span class="go">service "ingress-nginx-controller-admission" deleted</span>
</span><span id="__span-69-16"><a id="__codelineno-69-16" name="__codelineno-69-16" href="#__codelineno-69-16"></a><span class="go">deployment.apps "ingress-nginx-controller" deleted</span>
</span><span id="__span-69-17"><a id="__codelineno-69-17" name="__codelineno-69-17" href="#__codelineno-69-17"></a><span class="go">job.batch "ingress-nginx-admission-create" deleted</span>
</span><span id="__span-69-18"><a id="__codelineno-69-18" name="__codelineno-69-18" href="#__codelineno-69-18"></a><span class="go">job.batch "ingress-nginx-admission-patch" deleted</span>
</span><span id="__span-69-19"><a id="__codelineno-69-19" name="__codelineno-69-19" href="#__codelineno-69-19"></a><span class="go">ingressclass.networking.k8s.io "nginx" deleted</span>
</span><span id="__span-69-20"><a id="__codelineno-69-20" name="__codelineno-69-20" href="#__codelineno-69-20"></a><span class="go">validatingwebhookconfiguration.admissionregistration.k8s.io "ingress-nginx-admission" deleted</span>
</span></code></pre></div>
<p>This takes a few minutes, after which the following test should find nothing left:</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-70-1"><a id="__codelineno-70-1" name="__codelineno-70-1" href="#__codelineno-70-1"></a><span class="gp">$ </span>kubectl<span class="w"> </span>get<span class="w"> </span><span class="se">\</span>
</span><span id="__span-70-2"><a id="__codelineno-70-2" name="__codelineno-70-2" href="#__codelineno-70-2"></a><span class="w">  </span>-n<span class="w"> </span>ingress-nginx<span class="w"> </span><span class="se">\</span>
</span><span id="__span-70-3"><a id="__codelineno-70-3" name="__codelineno-70-3" href="#__codelineno-70-3"></a><span class="gp">  $</span><span class="o">(</span>kubectl<span class="w"> </span>api-resources<span class="w"> </span>--namespaced<span class="o">=</span><span class="nb">true</span><span class="w"> </span>--verbs<span class="o">=</span>list<span class="w"> </span>-o<span class="w"> </span>name<span class="w"> </span><span class="p">|</span><span class="w"> </span>tr<span class="w"> </span><span class="s1">'\n'</span><span class="w"> </span><span class="s1">','</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>sed<span class="w"> </span><span class="s1">'s/,$//'</span><span class="o">)</span>
</span><span id="__span-70-4"><a id="__codelineno-70-4" name="__codelineno-70-4" href="#__codelineno-70-4"></a><span class="go">No resources found in ingress-nginx namespace.</span>
</span></code></pre></div>
<p>Finally, the <code>ingress-nginx</code> namespace can be deleted:</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-71-1"><a id="__codelineno-71-1" name="__codelineno-71-1" href="#__codelineno-71-1"></a><span class="gp">$ </span>kubectl<span class="w"> </span>delete<span class="w"> </span>namespace<span class="w"> </span>ingress-nginx
</span><span id="__span-71-2"><a id="__codelineno-71-2" name="__codelineno-71-2" href="#__codelineno-71-2"></a><span class="go">namespace "ingress-nginx" deleted</span>
</span></code></pre></div>
<h2 id="appendix-streaming-support">Appendix: streaming support</h2>
<p>Cloudflare Tunnels does not support or allow audio streaming on its Free plan, as it
prohibits using its CDN (which Tunnels use by default) to serve a "disproportionate
percentage" of audio files or other large media unless you are using a dedicated paid
service like Cloudflare Stream or R2. Neither of those are actually suitable for
self-hosted web-based audio streaming applications like Audiobookshelf or Navidrone;
the closest match would be to offload storage of media files to Cloudflare R2 and then
point those applications to that off-site storage. Not a great setup, specially since
billing is based on the storage capacity rqeuired for the entire catalog, while only a
portion of it is typically needed for listening.</p>
<p>Discarding VPN-based solutions and Cloudflare-like tunnels, other solutions that offer
improved security over exposing applications directly on the HTTPS port on a public IP
address via Ingress-NGINX, could be one of the following <strong>Identity-Aware Proxies (IAP)</strong>
to move from Passive Security (opening a port and hoping SSL/TLS is enough) to Active
Zero-Trust Security, where access is denied until identity is verified at the network
edge; users must first authenticate against a specialized "gatekeeper" service.</p>
<ul>
<li><strong>Pomerium</strong>: A high-performance, Layer 7 reverse proxy that requires authentication
    (via Google, GitHub, or OIDC) before a request ever reaches your Audiobookshelf
    server. It treats your local app as if it were behind a corporate Zero-Trust wall.</li>
<li><strong>Authentik</strong>: A feature-rich identity provider that can act as a frontend for almost
    any app. It allows you to enforce Multi-Factor Authentication (MFA) and specific
    device posture checks before granting access to your audio library.</li>
<li><strong>Authelia</strong>: A lightweight alternative to Authentik that integrates directly with
    existing reverse proxies like Nginx or Traefik to provide a unified login portal with
    2FA.</li>
</ul>
<p><a href="https://www.pomerium.com/docs/deploy/k8s/ingress">Pomerium Ingress Controller</a>
was chosen because it can entirely replace Ingress-NGINX.</p>







  
  



  


  



<script src="https://giscus.app/client.js" data-repo="stibbons1990/hex" data-repo-id="R_kgDOKXTsSg" data-category="Announcements" data-category-id="DIC_kwDOKXTsSs4CqHDX" data-mapping="pathname" data-strict="0" data-reactions-enabled="1" data-emit-metadata="1" data-input-position="top" data-theme="preferred_color_scheme" data-lang="en" crossorigin="anonymous" async>
</script>

      
    </article>
  </div>

          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"></path></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
    
      
        
      
      <nav class="md-footer__inner md-grid" aria-label="Footer">
        
          
          <a href="../../14/fotocx-on-ubuntu-studio-2404/" class="md-footer__link md-footer__link--prev" aria-label="Previous: Fotocx on Ubuntu Studio 24.04">
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"></path></svg>
            </div>
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Previous
              </span>
              <div class="md-ellipsis">
                Fotocx on Ubuntu Studio 24.04
              </div>
            </div>
          </a>
        
        
          
          <a href="../../21/monitoring-a-kubernetes-cluster-for-vulnerabilities/" class="md-footer__link md-footer__link--next" aria-label="Next: Monitoring a Kubernetes cluster for vulnerabilities">
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Next
              </span>
              <div class="md-ellipsis">
                Monitoring a Kubernetes cluster for vulnerabilities
              </div>
            </div>
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11z"></path></svg>
            </div>
          </a>
        
      </nav>
    
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright  2019-2025 Ponder Stibbons
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      
      <script id="__config" type="application/json">{"annotate": null, "base": "../../../../..", "features": ["content.code.copy", "navigation.expand", "navigation.footer", "navigation.top", "search.highlight", "search.suggest"], "search": "../../../../../assets/javascripts/workers/search.2c215733.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../../../../assets/javascripts/bundle.79ae519e.min.js"></script>
      
    
  
<script id="init-glightbox">const lightbox = GLightbox({"touchNavigation": true, "loop": false, "zoomable": true, "draggable": true, "openEffect": "zoom", "closeEffect": "zoom", "slideEffect": "slide"});
document$.subscribe(()=>{ lightbox.reload(); });
</script></body></html>