
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://stibbons1990.github.io/hex/conmon/">
      
      
        <link rel="prev" href="..">
      
      
        <link rel="next" href="../blog/">
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.5.3, mkdocs-material-9.4.0">
    
    
      
        <title>Continuous Monitoring - Inadvisably Applied Magic</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.9f615399.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.649f08f9.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../stylesheets/extra.css">
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      
  


  
  

<script id="__analytics">function __md_analytics(){function n(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],n("js",new Date),n("config","G-Y167L3ZVGY"),document.addEventListener("DOMContentLoaded",function(){document.forms.search&&document.forms.search.query.addEventListener("blur",function(){this.value&&n("event","search",{search_term:this.value})}),document$.subscribe(function(){var a=document.forms.feedback;if(void 0!==a)for(var e of a.querySelectorAll("[type=submit]"))e.addEventListener("click",function(e){e.preventDefault();var t=document.location.pathname,e=this.getAttribute("data-md-value");n("event","feedback",{page:t,data:e}),a.firstElementChild.disabled=!0;e=a.querySelector(".md-feedback__note [data-md-value='"+e+"']");e&&(e.hidden=!1)}),a.hidden=!1}),location$.subscribe(function(e){n("config","G-Y167L3ZVGY",{page_path:e.pathname})})});var e=document.createElement("script");e.async=!0,e.src="https://www.googletagmanager.com/gtag/js?id=G-Y167L3ZVGY",document.getElementById("__analytics").insertAdjacentElement("afterEnd",e)}</script>
  
    <script>"undefined"!=typeof __md_analytics&&__md_analytics()</script>
  

    
    
    
   <link href="../assets/stylesheets/glightbox.min.css" rel="stylesheet"/><style>
    html.glightbox-open { overflow: initial; height: 100%; }
    .gslide-title { margin-top: 0px; user-select: text; }
    .gslide-desc { color: #666; user-select: text; }
    .gslide-image img { background: white; }
    .gscrollbar-fixer { padding-right: 15px; }
    .gdesc-inner { font-size: 0.75rem; }
    body[data-md-color-scheme="slate"] .gdesc-inner { background: var(--md-default-bg-color);}
    body[data-md-color-scheme="slate"] .gslide-title { color: var(--md-default-fg-color);}
    body[data-md-color-scheme="slate"] .gslide-desc { color: var(--md-default-fg-color);}</style> <script src="../assets/javascripts/glightbox.min.js"></script></head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="slate" data-md-color-primary="deep-purple" data-md-color-accent="green">
  
    
    
      <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#about-continuous-monitoring" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="Inadvisably Applied Magic" class="md-header__button md-logo" aria-label="Inadvisably Applied Magic" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.4.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="m64 416 104.6-235.3c15.3-34.4 40.3-63.5 72-83.7L387.5 3c3-1.9 6.5-2.9 10-2.9C407.7 0 416 8.3 416 18.6v1.6c0 2.6-.5 5.1-1.4 7.5l-59.8 149.2c-1.9 4.7-2.8 9.7-2.8 14.7 0 5.5 1.2 11 3.4 16.1L448 416H240.9l11.8-35.4 40.4-13.5c6.5-2.2 10.9-8.3 10.9-15.2s-4.4-13-10.9-15.2l-40.4-13.5-13.5-40.4c-2.2-6.4-8.3-10.8-15.2-10.8s-13 4.4-15.2 10.9l-13.5 40.4-40.4 13.5c-6.5 2.2-10.9 8.3-10.9 15.2s4.4 13 10.9 15.2l40.4 13.5 11.8 35.3H64zm215.6-274.5c-1.1-3.3-4.1-5.5-7.6-5.5s-6.5 2.2-7.6 5.5l-6.7 20.2-20.2 6.7c-3.3 1.1-5.5 4.1-5.5 7.6s2.2 6.5 5.5 7.6l20.2 6.7 6.7 20.2c1.1 3.3 4.1 5.5 7.6 5.5s6.5-2.2 7.6-5.5l6.7-20.2 20.2-6.7c3.3-1.1 5.5-4.1 5.5-7.6s-2.2-6.5-5.5-7.6l-20.2-6.7-6.7-20.2zM32 448h448c17.7 0 32 14.3 32 32s-14.3 32-32 32H32c-17.7 0-32-14.3-32-32s14.3-32 32-32z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Inadvisably Applied Magic
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Continuous Monitoring
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="deep-purple" data-md-color-accent="green"  aria-label="Dark mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Dark mode" for="__palette_2" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 7a5 5 0 0 1 5 5 5 5 0 0 1-5 5 5 5 0 0 1-5-5 5 5 0 0 1 5-5m0 2a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3m0-7 2.39 3.42C13.65 5.15 12.84 5 12 5c-.84 0-1.65.15-2.39.42L12 2M3.34 7l4.16-.35A7.2 7.2 0 0 0 5.94 8.5c-.44.74-.69 1.5-.83 2.29L3.34 7m.02 10 1.76-3.77a7.131 7.131 0 0 0 2.38 4.14L3.36 17M20.65 7l-1.77 3.79a7.023 7.023 0 0 0-2.38-4.15l4.15.36m-.01 10-4.14.36c.59-.51 1.12-1.14 1.54-1.86.42-.73.69-1.5.83-2.29L20.64 17M12 22l-2.41-3.44c.74.27 1.55.44 2.41.44.82 0 1.63-.17 2.37-.44L12 22Z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="deep-purple" data-md-color-accent="green"  aria-label="Light mode"  type="radio" name="__palette" id="__palette_2">
    
      <label class="md-header__button md-icon" title="Light mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m17.75 4.09-2.53 1.94.91 3.06-2.63-1.81-2.63 1.81.91-3.06-2.53-1.94L12.44 4l1.06-3 1.06 3 3.19.09m3.5 6.91-1.64 1.25.59 1.98-1.7-1.17-1.7 1.17.59-1.98L15.75 11l2.06-.05L18.5 9l.69 1.95 2.06.05m-2.28 4.95c.83-.08 1.72 1.1 1.19 1.85-.32.45-.66.87-1.08 1.27C15.17 23 8.84 23 4.94 19.07c-3.91-3.9-3.91-10.24 0-14.14.4-.4.82-.76 1.27-1.08.75-.53 1.93.36 1.85 1.19-.27 2.86.69 5.83 2.89 8.02a9.96 9.96 0 0 0 8.02 2.89m-1.64 2.02a12.08 12.08 0 0 1-7.8-3.47c-2.17-2.19-3.33-5-3.49-7.82-2.81 3.14-2.7 7.96.31 10.98 3.02 3.01 7.84 3.12 10.98.31Z"/></svg>
      </label>
    
  
</form>
      
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="Inadvisably Applied Magic" class="md-nav__button md-logo" aria-label="Inadvisably Applied Magic" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.4.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="m64 416 104.6-235.3c15.3-34.4 40.3-63.5 72-83.7L387.5 3c3-1.9 6.5-2.9 10-2.9C407.7 0 416 8.3 416 18.6v1.6c0 2.6-.5 5.1-1.4 7.5l-59.8 149.2c-1.9 4.7-2.8 9.7-2.8 14.7 0 5.5 1.2 11 3.4 16.1L448 416H240.9l11.8-35.4 40.4-13.5c6.5-2.2 10.9-8.3 10.9-15.2s-4.4-13-10.9-15.2l-40.4-13.5-13.5-40.4c-2.2-6.4-8.3-10.8-15.2-10.8s-13 4.4-15.2 10.9l-13.5 40.4-40.4 13.5c-6.5 2.2-10.9 8.3-10.9 15.2s4.4 13 10.9 15.2l40.4 13.5 11.8 35.3H64zm215.6-274.5c-1.1-3.3-4.1-5.5-7.6-5.5s-6.5 2.2-7.6 5.5l-6.7 20.2-20.2 6.7c-3.3 1.1-5.5 4.1-5.5 7.6s2.2 6.5 5.5 7.6l20.2 6.7 6.7 20.2c1.1 3.3 4.1 5.5 7.6 5.5s6.5-2.2 7.6-5.5l6.7-20.2 20.2-6.7c3.3-1.1 5.5-4.1 5.5-7.6s-2.2-6.5-5.5-7.6l-20.2-6.7-6.7-20.2zM32 448h448c17.7 0 32 14.3 32 32s-14.3 32-32 32H32c-17.7 0-32-14.3-32-32s14.3-32 32-32z"/></svg>

    </a>
    Inadvisably Applied Magic
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    About This Place
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    Continuous Monitoring
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    Continuous Monitoring
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#about-continuous-monitoring" class="md-nav__link">
    About Continuous Monitoring
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#kubernetes-setup" class="md-nav__link">
    Kubernetes Setup
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#install-influxdb" class="md-nav__link">
    Install InfluxDB
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#install-conmon" class="md-nav__link">
    Install Conmon
  </a>
  
    <nav class="md-nav" aria-label="Install Conmon">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#the-future-of-flux" class="md-nav__link">
    The future of Flux
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#install-grafana" class="md-nav__link">
    Install Grafana
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#install-conmon_1" class="md-nav__link">
    Install Conmon
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#single-thread" class="md-nav__link">
    Single-thread
  </a>
  
    <nav class="md-nav" aria-label="Single-thread">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#deploy-to-rpis" class="md-nav__link">
    deploy-to-rpis
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#conmon-st" class="md-nav__link">
    conmon-st
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#multi-thread" class="md-nav__link">
    Multi-thread
  </a>
  
    <nav class="md-nav" aria-label="Multi-thread">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#deploy-to-pcs" class="md-nav__link">
    deploy-to-pcs
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#conmon-mt" class="md-nav__link">
    conmon-mt
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#additional-scripts" class="md-nav__link">
    Additional scripts
  </a>
  
    <nav class="md-nav" aria-label="Additional scripts">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#conmon-speedtest" class="md-nav__link">
    conmon-speedtest
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#conmon-mystrom" class="md-nav__link">
    conmon-mystrom
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#conmon-tapopy" class="md-nav__link">
    conmon-tapo.py
  </a>
  
    <nav class="md-nav" aria-label="conmon-tapo.py">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#tapoyaml" class="md-nav__link">
    tapo.yaml
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#python-dependencies" class="md-nav__link">
    Python dependencies
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#device-ip-dependencies" class="md-nav__link">
    Device IP dependencies
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
      
      
  
  
  
    <li class="md-nav__item">
      <a href="../blog/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Unexpected Linux Adventures
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
        
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Archive
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            Archive
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../blog/archive/2024/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2024
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../blog/archive/2023/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2023
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../blog/archive/2022/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2022
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../blog/archive/2020/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2020
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../blog/archive/2019/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2019
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" >
        
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Categories
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            Categories
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../blog/category/monitoring/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    monitoring
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../blog/category/python/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    python
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../blog/category/tapo/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    tapo
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../blog/category/linux/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    linux
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../blog/category/ubuntu/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ubuntu
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../blog/category/installation/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    installation
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../blog/category/setup/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    setup
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../blog/category/github/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    github
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../blog/category/markdown/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    markdown
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../blog/category/blog/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    blog
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../blog/category/migration/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    migration
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../blog/category/mkdocs/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    mkdocs
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../blog/category/material/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    material
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../blog/category/intel/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    intel
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../blog/category/nuc/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    nuc
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../blog/category/kubernetes/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    kubernetes
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../blog/category/docker/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    docker
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../blog/category/server/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    server
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../blog/category/self-hosted/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    self-hosted
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../blog/category/music/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    music
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../blog/category/streaming/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    streaming
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../blog/category/media/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    media
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../blog/category/navidrome/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    navidrome
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../blog/category/dns/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    dns
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../blog/category/photo-albums/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    photo-albums
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../blog/category/photoprism/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    photoprism
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../blog/category/homebox/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    homebox
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../blog/category/inventory/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    inventory
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../blog/category/activitywatch/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ActivityWatch
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../blog/category/time-tracking/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    time-tracking
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../blog/category/ebook/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ebook
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../blog/category/komga/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    komga
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../blog/category/firefly-iii/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    firefly-iii
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../blog/category/studio/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    studio
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../blog/category/desktop/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    desktop
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../blog/category/steam/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    steam
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../blog/category/proton/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    proton
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../blog/category/videogames/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    videogames
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../blog/category/bethesda/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    bethesda
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../blog/category/fallout/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    fallout
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../blog/category/raspberrypi/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    raspberrypi
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../blog/category/influxdb/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    influxdb
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../blog/category/grafana/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    grafana
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../blog/category/minecraft/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    minecraft
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../blog/category/java/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    java
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../blog/category/bedrock/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    bedrock
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../blog/category/audiobookshelf/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    audiobookshelf
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../blog/category/audiobooks/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    audiobooks
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../blog/category/encryption/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    encryption
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../blog/category/veracrypt/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    veracrypt
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../blog/category/luks/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    luks
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../blog/category/cryptsetup/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    cryptsetup
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../blog/category/displaycal/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    displaycal
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../blog/category/skyrim/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    skyrim
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../blog/category/mods/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    mods
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../blog/category/audio/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    audio
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../blog/category/recording/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    recording
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../blog/category/alsa/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    alsa
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../blog/category/headphones/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    headphones
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../blog/category/ea/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ea
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../blog/category/bioware/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    bioware
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../blog/category/jekyll/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    jekyll
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../blog/category/plex/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    plex
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../blog/category/xhci/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    xhci
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../blog/category/usb/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    usb
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../blog/category/hardware/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    hardware
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../blog/category/failure/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    failure
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../blog/category/workaround/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    workaround
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../blog/category/asus/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    asus
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../blog/category/mediatek/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    mediatek
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../blog/category/glitch/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    glitch
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../blog/category/timeout/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    timeout
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../blog/category/keyboard/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    keyboard
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../blog/category/macropad/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    macropad
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../blog/category/qmk/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    qmk
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../blog/category/firmware/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    firmware
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../blog/category/vscode/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    vscode
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../blog/category/nvidia/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    nvidia
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../blog/category/troubleshooting/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    troubleshooting
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../blog/category/gpuburn/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    gpuburn
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../blog/category/cuda/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    cuda
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../blog/category/crucial/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    crucial
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../blog/category/ssd/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ssd
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../blog/category/locales/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    locales
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../blog/category/chrome/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    chrome
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../blog/category/firefox/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    firefox
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../blog/category/raid/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    RAID
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../blog/category/btrfs/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Btrfs
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../blog/category/intel-nuc/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Intel NUC
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../blog/category/audible/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Audible
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../blog/category/bash/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Bash
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../blog/category/mp3/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    MP3
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#about-continuous-monitoring" class="md-nav__link">
    About Continuous Monitoring
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#kubernetes-setup" class="md-nav__link">
    Kubernetes Setup
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#install-influxdb" class="md-nav__link">
    Install InfluxDB
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#install-conmon" class="md-nav__link">
    Install Conmon
  </a>
  
    <nav class="md-nav" aria-label="Install Conmon">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#the-future-of-flux" class="md-nav__link">
    The future of Flux
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#install-grafana" class="md-nav__link">
    Install Grafana
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#install-conmon_1" class="md-nav__link">
    Install Conmon
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#single-thread" class="md-nav__link">
    Single-thread
  </a>
  
    <nav class="md-nav" aria-label="Single-thread">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#deploy-to-rpis" class="md-nav__link">
    deploy-to-rpis
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#conmon-st" class="md-nav__link">
    conmon-st
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#multi-thread" class="md-nav__link">
    Multi-thread
  </a>
  
    <nav class="md-nav" aria-label="Multi-thread">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#deploy-to-pcs" class="md-nav__link">
    deploy-to-pcs
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#conmon-mt" class="md-nav__link">
    conmon-mt
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#additional-scripts" class="md-nav__link">
    Additional scripts
  </a>
  
    <nav class="md-nav" aria-label="Additional scripts">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#conmon-speedtest" class="md-nav__link">
    conmon-speedtest
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#conmon-mystrom" class="md-nav__link">
    conmon-mystrom
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#conmon-tapopy" class="md-nav__link">
    conmon-tapo.py
  </a>
  
    <nav class="md-nav" aria-label="conmon-tapo.py">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#tapoyaml" class="md-nav__link">
    tapo.yaml
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#python-dependencies" class="md-nav__link">
    Python dependencies
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#device-ip-dependencies" class="md-nav__link">
    Device IP dependencies
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  <h1>Continuous Monitoring</h1>

<div><h2 id="about-continuous-monitoring">About Continuous Monitoring</h2>
<p>This is the latest, most complete version of the scripts for
<a href="../blog/2020/03/31/detailed-system-and-process-monitoring/">Detailed system and process monitoring</a>.</p>
<p>To run in slow systems such as Raspberry Pi computers, including any one from the 
<a href="https://www.raspberrypi.com/products/raspberry-pi-zero-w/">Zero W (v1)</a>
to the 
<a href="https://www.raspberrypi.com/products/raspberry-pi-4-model-b/">4 model B</a>, the <strong>single-thread</strong> script
(<a href="#conmon-st"><code>conmon-st</code></a>) is preferred, with a sampling
delay based on each Raspberry CPU to avoid interfering with
other processes.
To run in faster systems such as servers and desktop PCs,
the <strong>multi-thread</strong> script (<a href="#conmon-mt"><code>conmon-mt</code></a>)
is preferred, with much smaller sampling delays to capture
fast changes in resource utilization more accurately.</p>
<p>In addition to the main <code>conmon</code> process, there are a few
scripts that usually only make sense to run on a single host
in the network:</p>
<ul>
<li><a href="#conmon-speedtest"><code>conmon-speedtest</code></a> reports the
   download and upload speeds (<strong>Mbps</strong>) and ping (<strong>ms</strong>)
   as reported by
   <a href="https://github.com/sivel/speedtest-cli">sivel/speedtest-cli</a></li>
<li><a href="#conmon-mystrom"><code>conmon-mystrom</code></a> reports the telemetry
   obtained via the <strong>Get report</strong> method in the
   <a href="https://api.mystrom.ch/">myStrom REST API</a> from one or
   more smart plug/switch devices that report energy usage.</li>
<li><a href="#conmon-tapopy"><code>conmon-tapo.py</code></a> reports temperature, humidity,
   power consumption and other monitoring data from TAPO devices.</li>
<li><a href="#tapoyaml"><code>tapo.yaml</code></a> is a minimal configuration file for
      <code>conmon-tapo.py</code>.</li>
</ul>
<h2 id="kubernetes-setup">Kubernetes Setup</h2>
<p>This setup has been 
<a href="../blog/2024/04/20/monitoring-with-influxdb-and-grafana-on-kubernetes/">migrated</a>
to run on a
<a href="../blog/2023/03/25/single-node-kubernetes-cluster-on-ubuntu-server-lexicon/">single-node Kubernetes cluster</a>
and the scripts have been updated to support dual-targeting
InfluxDB over HTTP without auth and/or HTTPS with Basic Auth.</p>
<h2 id="install-influxdb">Install InfluxDB</h2>
<p><a href="https://docs.influxdata.com/influxdb/v1/introduction/install/">Install InfluxDB OSS</a>
or simply</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a># apt install influxdb influxdb-client -y
</span></code></pre></div>
<p><a href="https://docs.influxdata.com/influxdb/v1/introduction/get-started/">Set it up</a>
and test 
<a href="https://docs.influxdata.com/influxdb/v1/guides/write_data/">test writing data</a>.</p>
<p>Create a <code>monitoring</code> database (name can be different,
then update the <code>DBNAME</code> variable in the <code>conmon</code> scripts).</p>
<h2 id="install-conmon">Install Conmon</h2>
<p>Choose <em>a</em> version of the <code>conmon</code> script and install it as
<code>/usr/local/bin/conmon</code> and run it as a service by creating
<code>/etc/systemd/system/conmon.service</code> as follows:</p>
<div class="language-ini highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a><span class="k">[Unit]</span>
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a><span class="na">Description</span><span class="o">=</span><span class="s">Continuous Monitoring</span>
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a><span class="na">After</span><span class="o">=</span><span class="s">influxd.service</span>
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4" href="#__codelineno-1-4"></a><span class="na">Wants</span><span class="o">=</span><span class="s">influxd.service</span>
</span><span id="__span-1-5"><a id="__codelineno-1-5" name="__codelineno-1-5" href="#__codelineno-1-5"></a>
</span><span id="__span-1-6"><a id="__codelineno-1-6" name="__codelineno-1-6" href="#__codelineno-1-6"></a><span class="k">[Service]</span>
</span><span id="__span-1-7"><a id="__codelineno-1-7" name="__codelineno-1-7" href="#__codelineno-1-7"></a><span class="na">ExecStart</span><span class="o">=</span><span class="s">/usr/local/bin/conmon</span>
</span><span id="__span-1-8"><a id="__codelineno-1-8" name="__codelineno-1-8" href="#__codelineno-1-8"></a><span class="na">Restart</span><span class="o">=</span><span class="s">on-failure</span>
</span><span id="__span-1-9"><a id="__codelineno-1-9" name="__codelineno-1-9" href="#__codelineno-1-9"></a><span class="na">StandardOutput</span><span class="o">=</span><span class="s">null</span>
</span><span id="__span-1-10"><a id="__codelineno-1-10" name="__codelineno-1-10" href="#__codelineno-1-10"></a>
</span><span id="__span-1-11"><a id="__codelineno-1-11" name="__codelineno-1-11" href="#__codelineno-1-11"></a><span class="k">[Install]</span>
</span><span id="__span-1-12"><a id="__codelineno-1-12" name="__codelineno-1-12" href="#__codelineno-1-12"></a><span class="na">WantedBy</span><span class="o">=</span><span class="s">multi-user.target</span>
</span></code></pre></div>
<p>Then enable and start the services in <code>systemd</code>:</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a># systemctl enable conmon.service
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a># systemctl daemon-reload
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a># systemctl start conmon.service
</span><span id="__span-2-4"><a id="__codelineno-2-4" name="__codelineno-2-4" href="#__codelineno-2-4"></a># systemctl status conmon.service
</span></code></pre></div>
<h3 id="the-future-of-flux">The future of Flux</h3>
<p>Flux is going into maintenance mode. You can continue
using it as you currently are without any changes to
your code.</p>
<p>Flux is going into maintenance mode and will not be
supported in InfluxDB 3.0. This was a decision based
on the broad demand for SQL and the continued growth
and adoption of InfluxQL. We are continuing to
support Flux for users in 1.x and 2.x so you can
continue using it with no changes to your code.
If you are interested in transitioning to InfluxDB
3.0 and want to future-proof your code, we suggest
using InfluxQL.</p>
<p>For information about the future of Flux, see the following:</p>
<ul>
<li><a href="https://www.influxdata.com/blog/the-plan-for-influxdb-3-0-open-source/">The plan for InfluxDB 3.0 Open Source</a></li>
<li><a href="https://www.influxdata.com/blog/influxdb-3-0-is-2.5x-45x-faster-compared-to-influxdb-open-source/">InfluxDB 3.0 benchmarks</a></li>
</ul>
<h2 id="install-grafana">Install Grafana</h2>
<p>To visualize monitoring in this setup
<a href="https://grafana.com/grafana/">Grafana</a>
is used.</p>
<p>Follow the steps to
<a href="https://grafana.com/docs/grafana/latest/setup-grafana/installation/debian/">install Grafana on Ubuntu</a>,
<a href="https://grafana.com/docs/grafana/latest/setup-grafana/start-restart-grafana/#start-the-grafana-server-with-systemd">start the server with systemd</a>
and reset its <code>admin</code> password:</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a># grafana-cli admin reset-admin-password \
</span><span id="__span-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a>  PLEASE_CHOOSE_A_SENSIBLE_PASSWORD
</span><span id="__span-3-3"><a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a>INFO[03-20|15:02:11] Connecting to DB                         logger=sqlstore dbtype=sqlite3
</span><span id="__span-3-4"><a id="__codelineno-3-4" name="__codelineno-3-4" href="#__codelineno-3-4"></a>INFO[03-20|15:02:11] Starting DB migrations                   logger=migrator
</span><span id="__span-3-5"><a id="__codelineno-3-5" name="__codelineno-3-5" href="#__codelineno-3-5"></a>Admin password changed successfully ✔
</span></code></pre></div>
<p><a href="https://grafana.com/docs/grafana/latest/getting-started/get-started-grafana-influxdb/#add-your-influxdb-data-source-to-grafana">Add your InfluxDB data source to Grafana</a>,
create a new Dashboard and <strong>Add &gt; Visualization</strong> for each measurement.</p>
<p>Finally, enable
<a href="https://grafana.com/docs/grafana/latest/setup-grafana/start-restart-grafana/#start-the-grafana-server-with-systemd">anonymous authentication</a>.
by tweaking <code>/etc/grafana/grafana.ini</code> as follows:</p>
<div class="language-ini highlight"><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a><span class="c1">#################################### Anonymous Auth ######################</span>
</span><span id="__span-4-2"><a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a><span class="k">[auth.anonymous]</span>
</span><span id="__span-4-3"><a id="__codelineno-4-3" name="__codelineno-4-3" href="#__codelineno-4-3"></a><span class="c1"># enable anonymous access</span>
</span><span id="__span-4-4"><a id="__codelineno-4-4" name="__codelineno-4-4" href="#__codelineno-4-4"></a><span class="na">enabled</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">true</span>
</span><span id="__span-4-5"><a id="__codelineno-4-5" name="__codelineno-4-5" href="#__codelineno-4-5"></a>
</span><span id="__span-4-6"><a id="__codelineno-4-6" name="__codelineno-4-6" href="#__codelineno-4-6"></a><span class="c1"># specify organization name that should be used for unauthenticated users</span>
</span><span id="__span-4-7"><a id="__codelineno-4-7" name="__codelineno-4-7" href="#__codelineno-4-7"></a><span class="na">org_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">Main Org.</span>
</span><span id="__span-4-8"><a id="__codelineno-4-8" name="__codelineno-4-8" href="#__codelineno-4-8"></a>
</span><span id="__span-4-9"><a id="__codelineno-4-9" name="__codelineno-4-9" href="#__codelineno-4-9"></a><span class="c1"># specify role for unauthenticated users</span>
</span><span id="__span-4-10"><a id="__codelineno-4-10" name="__codelineno-4-10" href="#__codelineno-4-10"></a><span class="na">org_role</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">Viewer</span>
</span><span id="__span-4-11"><a id="__codelineno-4-11" name="__codelineno-4-11" href="#__codelineno-4-11"></a>
</span><span id="__span-4-12"><a id="__codelineno-4-12" name="__codelineno-4-12" href="#__codelineno-4-12"></a><span class="c1"># systemctl restart grafana-server.service</span>
</span></code></pre></div>
<h2 id="install-conmon_1">Install Conmon</h2>
<h2 id="single-thread">Single-thread</h2>
<h3 id="deploy-to-rpis"><code>deploy-to-rpis</code></h3>
<p>In environments with multiple Raspberry Pi computers, it may
be useful to use this script (<code>deploy-to-rpis</code>) to deploy the
latest version of the script to all computers at once.</p>
<div class="language-bash highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">deploy-to-rpis</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-5-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-5-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-5-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-5-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-5-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-5-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-5-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-5-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-5-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-5-10">10</a></span>
<span class="normal"><a href="#__codelineno-5-11">11</a></span>
<span class="normal"><a href="#__codelineno-5-12">12</a></span>
<span class="normal"><a href="#__codelineno-5-13">13</a></span>
<span class="normal"><a href="#__codelineno-5-14">14</a></span>
<span class="normal"><a href="#__codelineno-5-15">15</a></span>
<span class="normal"><a href="#__codelineno-5-16">16</a></span>
<span class="normal"><a href="#__codelineno-5-17">17</a></span>
<span class="normal"><a href="#__codelineno-5-18">18</a></span>
<span class="normal"><a href="#__codelineno-5-19">19</a></span>
<span class="normal"><a href="#__codelineno-5-20">20</a></span>
<span class="normal"><a href="#__codelineno-5-21">21</a></span>
<span class="normal"><a href="#__codelineno-5-22">22</a></span>
<span class="normal"><a href="#__codelineno-5-23">23</a></span>
<span class="normal"><a href="#__codelineno-5-24">24</a></span>
<span class="normal"><a href="#__codelineno-5-25">25</a></span>
<span class="normal"><a href="#__codelineno-5-26">26</a></span>
<span class="normal"><a href="#__codelineno-5-27">27</a></span>
<span class="normal"><a href="#__codelineno-5-28">28</a></span>
<span class="normal"><a href="#__codelineno-5-29">29</a></span>
<span class="normal"><a href="#__codelineno-5-30">30</a></span>
<span class="normal"><a href="#__codelineno-5-31">31</a></span>
<span class="normal"><a href="#__codelineno-5-32">32</a></span>
<span class="normal"><a href="#__codelineno-5-33">33</a></span>
<span class="normal"><a href="#__codelineno-5-34">34</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1"></a><span class="ch">#!/bin/bash</span>
</span><span id="__span-5-2"><a id="__codelineno-5-2" name="__codelineno-5-2"></a><span class="c1">#</span>
</span><span id="__span-5-3"><a id="__codelineno-5-3" name="__codelineno-5-3"></a><span class="c1"># Deplay conmon-st to Raspberry Pi hosts.</span>
</span><span id="__span-5-4"><a id="__codelineno-5-4" name="__codelineno-5-4"></a>
</span><span id="__span-5-5"><a id="__codelineno-5-5" name="__codelineno-5-5"></a><span class="k">for</span><span class="w"> </span>host<span class="w"> </span><span class="k">in</span><span class="w"> </span>pi-f1<span class="w"> </span>pi-z1<span class="w"> </span>pi-z2<span class="w"> </span>pi3a<span class="p">;</span><span class="w"> </span><span class="k">do</span>
</span><span id="__span-5-6"><a id="__codelineno-5-6" name="__codelineno-5-6"></a><span class="w">  </span><span class="k">if</span><span class="w"> </span>nc<span class="w"> </span><span class="m">2</span>&gt;<span class="p">&amp;</span><span class="m">1</span><span class="w"> </span>-zv<span class="w"> </span><span class="si">${</span><span class="nv">host</span><span class="si">}</span><span class="w"> </span><span class="m">22</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>-q<span class="w"> </span>succeeded<span class="p">;</span><span class="w"> </span><span class="k">then</span>
</span><span id="__span-5-7"><a id="__codelineno-5-7" name="__codelineno-5-7"></a><span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">"Deploying to </span><span class="si">${</span><span class="nv">host</span><span class="si">}</span><span class="s2"> ..."</span>
</span><span id="__span-5-8"><a id="__codelineno-5-8" name="__codelineno-5-8"></a><span class="w">    </span>scp<span class="w"> </span><span class="m">2</span>&gt;/dev/null<span class="w"> </span><span class="se">\</span>
</span><span id="__span-5-9"><a id="__codelineno-5-9" name="__codelineno-5-9"></a><span class="w">      </span>-qr<span class="w"> </span><span class="se">\</span>
</span><span id="__span-5-10"><a id="__codelineno-5-10" name="__codelineno-5-10"></a><span class="w">      </span>../conmon<span class="w"> </span><span class="se">\</span>
</span><span id="__span-5-11"><a id="__codelineno-5-11" name="__codelineno-5-11"></a><span class="w">      </span>pi@<span class="si">${</span><span class="nv">host</span><span class="si">}</span>:src/
</span><span id="__span-5-12"><a id="__codelineno-5-12" name="__codelineno-5-12"></a><span class="w">    </span>ssh<span class="w"> </span><span class="m">2</span>&gt;/dev/null<span class="w"> </span><span class="se">\</span>
</span><span id="__span-5-13"><a id="__codelineno-5-13" name="__codelineno-5-13"></a><span class="w">      </span>pi@<span class="si">${</span><span class="nv">host</span><span class="si">}</span><span class="w"> </span><span class="se">\</span>
</span><span id="__span-5-14"><a id="__codelineno-5-14" name="__codelineno-5-14"></a><span class="w">      </span><span class="s2">"sudo cp /home/pi/src/conmon/conmon-st /usr/local/bin/conmon"</span>
</span><span id="__span-5-15"><a id="__codelineno-5-15" name="__codelineno-5-15"></a><span class="w">    </span>ssh<span class="w"> </span><span class="m">2</span>&gt;/dev/null<span class="w"> </span><span class="se">\</span>
</span><span id="__span-5-16"><a id="__codelineno-5-16" name="__codelineno-5-16"></a><span class="w">      </span>pi@<span class="si">${</span><span class="nv">host</span><span class="si">}</span><span class="w"> </span><span class="se">\</span>
</span><span id="__span-5-17"><a id="__codelineno-5-17" name="__codelineno-5-17"></a><span class="w">      </span><span class="s2">"sudo systemctl restart conmon.service"</span>
</span><span id="__span-5-18"><a id="__codelineno-5-18" name="__codelineno-5-18"></a><span class="w">    </span><span class="nv">etc_influxdb_auth</span><span class="o">=</span>/etc/conmon/influxdb-auth
</span><span id="__span-5-19"><a id="__codelineno-5-19" name="__codelineno-5-19"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span>src_influxdb_auth<span class="w"> </span><span class="k">in</span><span class="w"> </span>/etc/conmon/influxdb-auth<span class="w"> </span><span class="s2">"</span><span class="si">${</span><span class="nv">HOME</span><span class="si">}</span><span class="s2">/.conmon-influxdb-auth"</span><span class="p">;</span><span class="w"> </span><span class="k">do</span>
</span><span id="__span-5-20"><a id="__codelineno-5-20" name="__codelineno-5-20"></a><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span>-f<span class="w"> </span><span class="nv">$src_influxdb_auth</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
</span><span id="__span-5-21"><a id="__codelineno-5-21" name="__codelineno-5-21"></a><span class="w">        </span><span class="nv">auth</span><span class="o">=</span><span class="k">$(</span>cat<span class="w"> </span><span class="nv">$src_influxdb_auth</span><span class="w"> </span><span class="m">2</span>&gt;/dev/null<span class="k">)</span>
</span><span id="__span-5-22"><a id="__codelineno-5-22" name="__codelineno-5-22"></a><span class="w">        </span>ssh<span class="w"> </span><span class="m">2</span>&gt;/dev/null<span class="w"> </span><span class="se">\</span>
</span><span id="__span-5-23"><a id="__codelineno-5-23" name="__codelineno-5-23"></a><span class="w">          </span>pi@<span class="si">${</span><span class="nv">host</span><span class="si">}</span><span class="w"> </span><span class="se">\</span>
</span><span id="__span-5-24"><a id="__codelineno-5-24" name="__codelineno-5-24"></a><span class="w">          </span><span class="s2">"sudo mkdir -p </span><span class="k">$(</span>dirname<span class="w"> </span><span class="nv">$etc_influxdb_auth</span><span class="k">)</span><span class="s2">"</span>
</span><span id="__span-5-25"><a id="__codelineno-5-25" name="__codelineno-5-25"></a><span class="w">        </span>ssh<span class="w"> </span><span class="m">2</span>&gt;<span class="p">&amp;</span><span class="m">1</span><span class="w"> </span>&gt;/dev/null<span class="w"> </span><span class="se">\</span>
</span><span id="__span-5-26"><a id="__codelineno-5-26" name="__codelineno-5-26"></a><span class="w">          </span>pi@<span class="si">${</span><span class="nv">host</span><span class="si">}</span><span class="w"> </span><span class="se">\</span>
</span><span id="__span-5-27"><a id="__codelineno-5-27" name="__codelineno-5-27"></a><span class="w">          </span><span class="s2">"echo '</span><span class="si">${</span><span class="nv">auth</span><span class="si">}</span><span class="s2">' | sudo tee </span><span class="nv">$etc_influxdb_auth</span><span class="s2">"</span>
</span><span id="__span-5-28"><a id="__codelineno-5-28" name="__codelineno-5-28"></a><span class="w">        </span>ssh<span class="w"> </span><span class="m">2</span>&gt;/dev/null<span class="w"> </span><span class="se">\</span>
</span><span id="__span-5-29"><a id="__codelineno-5-29" name="__codelineno-5-29"></a><span class="w">          </span>pi@<span class="si">${</span><span class="nv">host</span><span class="si">}</span><span class="w"> </span><span class="se">\</span>
</span><span id="__span-5-30"><a id="__codelineno-5-30" name="__codelineno-5-30"></a><span class="w">          </span><span class="s2">"sudo chmod 400 </span><span class="nv">$etc_influxdb_auth</span><span class="s2">"</span>
</span><span id="__span-5-31"><a id="__codelineno-5-31" name="__codelineno-5-31"></a><span class="w">      </span><span class="k">fi</span>
</span><span id="__span-5-32"><a id="__codelineno-5-32" name="__codelineno-5-32"></a><span class="w">    </span><span class="k">done</span>
</span><span id="__span-5-33"><a id="__codelineno-5-33" name="__codelineno-5-33"></a><span class="w">  </span><span class="k">fi</span>
</span><span id="__span-5-34"><a id="__codelineno-5-34" name="__codelineno-5-34"></a><span class="k">done</span>
</span></code></pre></div></td></tr></table></div>
<h3 id="conmon-st"><code>conmon-st</code></h3>
<div class="language-bash highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">conmon-st</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-6-1">  1</a></span>
<span class="normal"><a href="#__codelineno-6-2">  2</a></span>
<span class="normal"><a href="#__codelineno-6-3">  3</a></span>
<span class="normal"><a href="#__codelineno-6-4">  4</a></span>
<span class="normal"><a href="#__codelineno-6-5">  5</a></span>
<span class="normal"><a href="#__codelineno-6-6">  6</a></span>
<span class="normal"><a href="#__codelineno-6-7">  7</a></span>
<span class="normal"><a href="#__codelineno-6-8">  8</a></span>
<span class="normal"><a href="#__codelineno-6-9">  9</a></span>
<span class="normal"><a href="#__codelineno-6-10"> 10</a></span>
<span class="normal"><a href="#__codelineno-6-11"> 11</a></span>
<span class="normal"><a href="#__codelineno-6-12"> 12</a></span>
<span class="normal"><a href="#__codelineno-6-13"> 13</a></span>
<span class="normal"><a href="#__codelineno-6-14"> 14</a></span>
<span class="normal"><a href="#__codelineno-6-15"> 15</a></span>
<span class="normal"><a href="#__codelineno-6-16"> 16</a></span>
<span class="normal"><a href="#__codelineno-6-17"> 17</a></span>
<span class="normal"><a href="#__codelineno-6-18"> 18</a></span>
<span class="normal"><a href="#__codelineno-6-19"> 19</a></span>
<span class="normal"><a href="#__codelineno-6-20"> 20</a></span>
<span class="normal"><a href="#__codelineno-6-21"> 21</a></span>
<span class="normal"><a href="#__codelineno-6-22"> 22</a></span>
<span class="normal"><a href="#__codelineno-6-23"> 23</a></span>
<span class="normal"><a href="#__codelineno-6-24"> 24</a></span>
<span class="normal"><a href="#__codelineno-6-25"> 25</a></span>
<span class="normal"><a href="#__codelineno-6-26"> 26</a></span>
<span class="normal"><a href="#__codelineno-6-27"> 27</a></span>
<span class="normal"><a href="#__codelineno-6-28"> 28</a></span>
<span class="normal"><a href="#__codelineno-6-29"> 29</a></span>
<span class="normal"><a href="#__codelineno-6-30"> 30</a></span>
<span class="normal"><a href="#__codelineno-6-31"> 31</a></span>
<span class="normal"><a href="#__codelineno-6-32"> 32</a></span>
<span class="normal"><a href="#__codelineno-6-33"> 33</a></span>
<span class="normal"><a href="#__codelineno-6-34"> 34</a></span>
<span class="normal"><a href="#__codelineno-6-35"> 35</a></span>
<span class="normal"><a href="#__codelineno-6-36"> 36</a></span>
<span class="normal"><a href="#__codelineno-6-37"> 37</a></span>
<span class="normal"><a href="#__codelineno-6-38"> 38</a></span>
<span class="normal"><a href="#__codelineno-6-39"> 39</a></span>
<span class="normal"><a href="#__codelineno-6-40"> 40</a></span>
<span class="normal"><a href="#__codelineno-6-41"> 41</a></span>
<span class="normal"><a href="#__codelineno-6-42"> 42</a></span>
<span class="normal"><a href="#__codelineno-6-43"> 43</a></span>
<span class="normal"><a href="#__codelineno-6-44"> 44</a></span>
<span class="normal"><a href="#__codelineno-6-45"> 45</a></span>
<span class="normal"><a href="#__codelineno-6-46"> 46</a></span>
<span class="normal"><a href="#__codelineno-6-47"> 47</a></span>
<span class="normal"><a href="#__codelineno-6-48"> 48</a></span>
<span class="normal"><a href="#__codelineno-6-49"> 49</a></span>
<span class="normal"><a href="#__codelineno-6-50"> 50</a></span>
<span class="normal"><a href="#__codelineno-6-51"> 51</a></span>
<span class="normal"><a href="#__codelineno-6-52"> 52</a></span>
<span class="normal"><a href="#__codelineno-6-53"> 53</a></span>
<span class="normal"><a href="#__codelineno-6-54"> 54</a></span>
<span class="normal"><a href="#__codelineno-6-55"> 55</a></span>
<span class="normal"><a href="#__codelineno-6-56"> 56</a></span>
<span class="normal"><a href="#__codelineno-6-57"> 57</a></span>
<span class="normal"><a href="#__codelineno-6-58"> 58</a></span>
<span class="normal"><a href="#__codelineno-6-59"> 59</a></span>
<span class="normal"><a href="#__codelineno-6-60"> 60</a></span>
<span class="normal"><a href="#__codelineno-6-61"> 61</a></span>
<span class="normal"><a href="#__codelineno-6-62"> 62</a></span>
<span class="normal"><a href="#__codelineno-6-63"> 63</a></span>
<span class="normal"><a href="#__codelineno-6-64"> 64</a></span>
<span class="normal"><a href="#__codelineno-6-65"> 65</a></span>
<span class="normal"><a href="#__codelineno-6-66"> 66</a></span>
<span class="normal"><a href="#__codelineno-6-67"> 67</a></span>
<span class="normal"><a href="#__codelineno-6-68"> 68</a></span>
<span class="normal"><a href="#__codelineno-6-69"> 69</a></span>
<span class="normal"><a href="#__codelineno-6-70"> 70</a></span>
<span class="normal"><a href="#__codelineno-6-71"> 71</a></span>
<span class="normal"><a href="#__codelineno-6-72"> 72</a></span>
<span class="normal"><a href="#__codelineno-6-73"> 73</a></span>
<span class="normal"><a href="#__codelineno-6-74"> 74</a></span>
<span class="normal"><a href="#__codelineno-6-75"> 75</a></span>
<span class="normal"><a href="#__codelineno-6-76"> 76</a></span>
<span class="normal"><a href="#__codelineno-6-77"> 77</a></span>
<span class="normal"><a href="#__codelineno-6-78"> 78</a></span>
<span class="normal"><a href="#__codelineno-6-79"> 79</a></span>
<span class="normal"><a href="#__codelineno-6-80"> 80</a></span>
<span class="normal"><a href="#__codelineno-6-81"> 81</a></span>
<span class="normal"><a href="#__codelineno-6-82"> 82</a></span>
<span class="normal"><a href="#__codelineno-6-83"> 83</a></span>
<span class="normal"><a href="#__codelineno-6-84"> 84</a></span>
<span class="normal"><a href="#__codelineno-6-85"> 85</a></span>
<span class="normal"><a href="#__codelineno-6-86"> 86</a></span>
<span class="normal"><a href="#__codelineno-6-87"> 87</a></span>
<span class="normal"><a href="#__codelineno-6-88"> 88</a></span>
<span class="normal"><a href="#__codelineno-6-89"> 89</a></span>
<span class="normal"><a href="#__codelineno-6-90"> 90</a></span>
<span class="normal"><a href="#__codelineno-6-91"> 91</a></span>
<span class="normal"><a href="#__codelineno-6-92"> 92</a></span>
<span class="normal"><a href="#__codelineno-6-93"> 93</a></span>
<span class="normal"><a href="#__codelineno-6-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-6-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-6-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-6-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-6-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-6-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-6-100">100</a></span>
<span class="normal"><a href="#__codelineno-6-101">101</a></span>
<span class="normal"><a href="#__codelineno-6-102">102</a></span>
<span class="normal"><a href="#__codelineno-6-103">103</a></span>
<span class="normal"><a href="#__codelineno-6-104">104</a></span>
<span class="normal"><a href="#__codelineno-6-105">105</a></span>
<span class="normal"><a href="#__codelineno-6-106">106</a></span>
<span class="normal"><a href="#__codelineno-6-107">107</a></span>
<span class="normal"><a href="#__codelineno-6-108">108</a></span>
<span class="normal"><a href="#__codelineno-6-109">109</a></span>
<span class="normal"><a href="#__codelineno-6-110">110</a></span>
<span class="normal"><a href="#__codelineno-6-111">111</a></span>
<span class="normal"><a href="#__codelineno-6-112">112</a></span>
<span class="normal"><a href="#__codelineno-6-113">113</a></span>
<span class="normal"><a href="#__codelineno-6-114">114</a></span>
<span class="normal"><a href="#__codelineno-6-115">115</a></span>
<span class="normal"><a href="#__codelineno-6-116">116</a></span>
<span class="normal"><a href="#__codelineno-6-117">117</a></span>
<span class="normal"><a href="#__codelineno-6-118">118</a></span>
<span class="normal"><a href="#__codelineno-6-119">119</a></span>
<span class="normal"><a href="#__codelineno-6-120">120</a></span>
<span class="normal"><a href="#__codelineno-6-121">121</a></span>
<span class="normal"><a href="#__codelineno-6-122">122</a></span>
<span class="normal"><a href="#__codelineno-6-123">123</a></span>
<span class="normal"><a href="#__codelineno-6-124">124</a></span>
<span class="normal"><a href="#__codelineno-6-125">125</a></span>
<span class="normal"><a href="#__codelineno-6-126">126</a></span>
<span class="normal"><a href="#__codelineno-6-127">127</a></span>
<span class="normal"><a href="#__codelineno-6-128">128</a></span>
<span class="normal"><a href="#__codelineno-6-129">129</a></span>
<span class="normal"><a href="#__codelineno-6-130">130</a></span>
<span class="normal"><a href="#__codelineno-6-131">131</a></span>
<span class="normal"><a href="#__codelineno-6-132">132</a></span>
<span class="normal"><a href="#__codelineno-6-133">133</a></span>
<span class="normal"><a href="#__codelineno-6-134">134</a></span>
<span class="normal"><a href="#__codelineno-6-135">135</a></span>
<span class="normal"><a href="#__codelineno-6-136">136</a></span>
<span class="normal"><a href="#__codelineno-6-137">137</a></span>
<span class="normal"><a href="#__codelineno-6-138">138</a></span>
<span class="normal"><a href="#__codelineno-6-139">139</a></span>
<span class="normal"><a href="#__codelineno-6-140">140</a></span>
<span class="normal"><a href="#__codelineno-6-141">141</a></span>
<span class="normal"><a href="#__codelineno-6-142">142</a></span>
<span class="normal"><a href="#__codelineno-6-143">143</a></span>
<span class="normal"><a href="#__codelineno-6-144">144</a></span>
<span class="normal"><a href="#__codelineno-6-145">145</a></span>
<span class="normal"><a href="#__codelineno-6-146">146</a></span>
<span class="normal"><a href="#__codelineno-6-147">147</a></span>
<span class="normal"><a href="#__codelineno-6-148">148</a></span>
<span class="normal"><a href="#__codelineno-6-149">149</a></span>
<span class="normal"><a href="#__codelineno-6-150">150</a></span>
<span class="normal"><a href="#__codelineno-6-151">151</a></span>
<span class="normal"><a href="#__codelineno-6-152">152</a></span>
<span class="normal"><a href="#__codelineno-6-153">153</a></span>
<span class="normal"><a href="#__codelineno-6-154">154</a></span>
<span class="normal"><a href="#__codelineno-6-155">155</a></span>
<span class="normal"><a href="#__codelineno-6-156">156</a></span>
<span class="normal"><a href="#__codelineno-6-157">157</a></span>
<span class="normal"><a href="#__codelineno-6-158">158</a></span>
<span class="normal"><a href="#__codelineno-6-159">159</a></span>
<span class="normal"><a href="#__codelineno-6-160">160</a></span>
<span class="normal"><a href="#__codelineno-6-161">161</a></span>
<span class="normal"><a href="#__codelineno-6-162">162</a></span>
<span class="normal"><a href="#__codelineno-6-163">163</a></span>
<span class="normal"><a href="#__codelineno-6-164">164</a></span>
<span class="normal"><a href="#__codelineno-6-165">165</a></span>
<span class="normal"><a href="#__codelineno-6-166">166</a></span>
<span class="normal"><a href="#__codelineno-6-167">167</a></span>
<span class="normal"><a href="#__codelineno-6-168">168</a></span>
<span class="normal"><a href="#__codelineno-6-169">169</a></span>
<span class="normal"><a href="#__codelineno-6-170">170</a></span>
<span class="normal"><a href="#__codelineno-6-171">171</a></span>
<span class="normal"><a href="#__codelineno-6-172">172</a></span>
<span class="normal"><a href="#__codelineno-6-173">173</a></span>
<span class="normal"><a href="#__codelineno-6-174">174</a></span>
<span class="normal"><a href="#__codelineno-6-175">175</a></span>
<span class="normal"><a href="#__codelineno-6-176">176</a></span>
<span class="normal"><a href="#__codelineno-6-177">177</a></span>
<span class="normal"><a href="#__codelineno-6-178">178</a></span>
<span class="normal"><a href="#__codelineno-6-179">179</a></span>
<span class="normal"><a href="#__codelineno-6-180">180</a></span>
<span class="normal"><a href="#__codelineno-6-181">181</a></span>
<span class="normal"><a href="#__codelineno-6-182">182</a></span>
<span class="normal"><a href="#__codelineno-6-183">183</a></span>
<span class="normal"><a href="#__codelineno-6-184">184</a></span>
<span class="normal"><a href="#__codelineno-6-185">185</a></span>
<span class="normal"><a href="#__codelineno-6-186">186</a></span>
<span class="normal"><a href="#__codelineno-6-187">187</a></span>
<span class="normal"><a href="#__codelineno-6-188">188</a></span>
<span class="normal"><a href="#__codelineno-6-189">189</a></span>
<span class="normal"><a href="#__codelineno-6-190">190</a></span>
<span class="normal"><a href="#__codelineno-6-191">191</a></span>
<span class="normal"><a href="#__codelineno-6-192">192</a></span>
<span class="normal"><a href="#__codelineno-6-193">193</a></span>
<span class="normal"><a href="#__codelineno-6-194">194</a></span>
<span class="normal"><a href="#__codelineno-6-195">195</a></span>
<span class="normal"><a href="#__codelineno-6-196">196</a></span>
<span class="normal"><a href="#__codelineno-6-197">197</a></span>
<span class="normal"><a href="#__codelineno-6-198">198</a></span>
<span class="normal"><a href="#__codelineno-6-199">199</a></span>
<span class="normal"><a href="#__codelineno-6-200">200</a></span>
<span class="normal"><a href="#__codelineno-6-201">201</a></span>
<span class="normal"><a href="#__codelineno-6-202">202</a></span>
<span class="normal"><a href="#__codelineno-6-203">203</a></span>
<span class="normal"><a href="#__codelineno-6-204">204</a></span>
<span class="normal"><a href="#__codelineno-6-205">205</a></span>
<span class="normal"><a href="#__codelineno-6-206">206</a></span>
<span class="normal"><a href="#__codelineno-6-207">207</a></span>
<span class="normal"><a href="#__codelineno-6-208">208</a></span>
<span class="normal"><a href="#__codelineno-6-209">209</a></span>
<span class="normal"><a href="#__codelineno-6-210">210</a></span>
<span class="normal"><a href="#__codelineno-6-211">211</a></span>
<span class="normal"><a href="#__codelineno-6-212">212</a></span>
<span class="normal"><a href="#__codelineno-6-213">213</a></span>
<span class="normal"><a href="#__codelineno-6-214">214</a></span>
<span class="normal"><a href="#__codelineno-6-215">215</a></span>
<span class="normal"><a href="#__codelineno-6-216">216</a></span>
<span class="normal"><a href="#__codelineno-6-217">217</a></span>
<span class="normal"><a href="#__codelineno-6-218">218</a></span>
<span class="normal"><a href="#__codelineno-6-219">219</a></span>
<span class="normal"><a href="#__codelineno-6-220">220</a></span>
<span class="normal"><a href="#__codelineno-6-221">221</a></span>
<span class="normal"><a href="#__codelineno-6-222">222</a></span>
<span class="normal"><a href="#__codelineno-6-223">223</a></span>
<span class="normal"><a href="#__codelineno-6-224">224</a></span>
<span class="normal"><a href="#__codelineno-6-225">225</a></span>
<span class="normal"><a href="#__codelineno-6-226">226</a></span>
<span class="normal"><a href="#__codelineno-6-227">227</a></span>
<span class="normal"><a href="#__codelineno-6-228">228</a></span>
<span class="normal"><a href="#__codelineno-6-229">229</a></span>
<span class="normal"><a href="#__codelineno-6-230">230</a></span>
<span class="normal"><a href="#__codelineno-6-231">231</a></span>
<span class="normal"><a href="#__codelineno-6-232">232</a></span>
<span class="normal"><a href="#__codelineno-6-233">233</a></span>
<span class="normal"><a href="#__codelineno-6-234">234</a></span>
<span class="normal"><a href="#__codelineno-6-235">235</a></span>
<span class="normal"><a href="#__codelineno-6-236">236</a></span>
<span class="normal"><a href="#__codelineno-6-237">237</a></span>
<span class="normal"><a href="#__codelineno-6-238">238</a></span>
<span class="normal"><a href="#__codelineno-6-239">239</a></span>
<span class="normal"><a href="#__codelineno-6-240">240</a></span>
<span class="normal"><a href="#__codelineno-6-241">241</a></span>
<span class="normal"><a href="#__codelineno-6-242">242</a></span>
<span class="normal"><a href="#__codelineno-6-243">243</a></span>
<span class="normal"><a href="#__codelineno-6-244">244</a></span>
<span class="normal"><a href="#__codelineno-6-245">245</a></span>
<span class="normal"><a href="#__codelineno-6-246">246</a></span>
<span class="normal"><a href="#__codelineno-6-247">247</a></span>
<span class="normal"><a href="#__codelineno-6-248">248</a></span>
<span class="normal"><a href="#__codelineno-6-249">249</a></span>
<span class="normal"><a href="#__codelineno-6-250">250</a></span>
<span class="normal"><a href="#__codelineno-6-251">251</a></span>
<span class="normal"><a href="#__codelineno-6-252">252</a></span>
<span class="normal"><a href="#__codelineno-6-253">253</a></span>
<span class="normal"><a href="#__codelineno-6-254">254</a></span>
<span class="normal"><a href="#__codelineno-6-255">255</a></span>
<span class="normal"><a href="#__codelineno-6-256">256</a></span>
<span class="normal"><a href="#__codelineno-6-257">257</a></span>
<span class="normal"><a href="#__codelineno-6-258">258</a></span>
<span class="normal"><a href="#__codelineno-6-259">259</a></span>
<span class="normal"><a href="#__codelineno-6-260">260</a></span>
<span class="normal"><a href="#__codelineno-6-261">261</a></span>
<span class="normal"><a href="#__codelineno-6-262">262</a></span>
<span class="normal"><a href="#__codelineno-6-263">263</a></span>
<span class="normal"><a href="#__codelineno-6-264">264</a></span>
<span class="normal"><a href="#__codelineno-6-265">265</a></span>
<span class="normal"><a href="#__codelineno-6-266">266</a></span>
<span class="normal"><a href="#__codelineno-6-267">267</a></span>
<span class="normal"><a href="#__codelineno-6-268">268</a></span>
<span class="normal"><a href="#__codelineno-6-269">269</a></span>
<span class="normal"><a href="#__codelineno-6-270">270</a></span>
<span class="normal"><a href="#__codelineno-6-271">271</a></span>
<span class="normal"><a href="#__codelineno-6-272">272</a></span>
<span class="normal"><a href="#__codelineno-6-273">273</a></span>
<span class="normal"><a href="#__codelineno-6-274">274</a></span>
<span class="normal"><a href="#__codelineno-6-275">275</a></span>
<span class="normal"><a href="#__codelineno-6-276">276</a></span>
<span class="normal"><a href="#__codelineno-6-277">277</a></span>
<span class="normal"><a href="#__codelineno-6-278">278</a></span>
<span class="normal"><a href="#__codelineno-6-279">279</a></span>
<span class="normal"><a href="#__codelineno-6-280">280</a></span>
<span class="normal"><a href="#__codelineno-6-281">281</a></span>
<span class="normal"><a href="#__codelineno-6-282">282</a></span>
<span class="normal"><a href="#__codelineno-6-283">283</a></span>
<span class="normal"><a href="#__codelineno-6-284">284</a></span>
<span class="normal"><a href="#__codelineno-6-285">285</a></span>
<span class="normal"><a href="#__codelineno-6-286">286</a></span>
<span class="normal"><a href="#__codelineno-6-287">287</a></span>
<span class="normal"><a href="#__codelineno-6-288">288</a></span>
<span class="normal"><a href="#__codelineno-6-289">289</a></span>
<span class="normal"><a href="#__codelineno-6-290">290</a></span>
<span class="normal"><a href="#__codelineno-6-291">291</a></span>
<span class="normal"><a href="#__codelineno-6-292">292</a></span>
<span class="normal"><a href="#__codelineno-6-293">293</a></span>
<span class="normal"><a href="#__codelineno-6-294">294</a></span>
<span class="normal"><a href="#__codelineno-6-295">295</a></span>
<span class="normal"><a href="#__codelineno-6-296">296</a></span>
<span class="normal"><a href="#__codelineno-6-297">297</a></span>
<span class="normal"><a href="#__codelineno-6-298">298</a></span>
<span class="normal"><a href="#__codelineno-6-299">299</a></span>
<span class="normal"><a href="#__codelineno-6-300">300</a></span>
<span class="normal"><a href="#__codelineno-6-301">301</a></span>
<span class="normal"><a href="#__codelineno-6-302">302</a></span>
<span class="normal"><a href="#__codelineno-6-303">303</a></span>
<span class="normal"><a href="#__codelineno-6-304">304</a></span>
<span class="normal"><a href="#__codelineno-6-305">305</a></span>
<span class="normal"><a href="#__codelineno-6-306">306</a></span>
<span class="normal"><a href="#__codelineno-6-307">307</a></span>
<span class="normal"><a href="#__codelineno-6-308">308</a></span>
<span class="normal"><a href="#__codelineno-6-309">309</a></span>
<span class="normal"><a href="#__codelineno-6-310">310</a></span>
<span class="normal"><a href="#__codelineno-6-311">311</a></span>
<span class="normal"><a href="#__codelineno-6-312">312</a></span>
<span class="normal"><a href="#__codelineno-6-313">313</a></span>
<span class="normal"><a href="#__codelineno-6-314">314</a></span>
<span class="normal"><a href="#__codelineno-6-315">315</a></span>
<span class="normal"><a href="#__codelineno-6-316">316</a></span>
<span class="normal"><a href="#__codelineno-6-317">317</a></span>
<span class="normal"><a href="#__codelineno-6-318">318</a></span>
<span class="normal"><a href="#__codelineno-6-319">319</a></span>
<span class="normal"><a href="#__codelineno-6-320">320</a></span>
<span class="normal"><a href="#__codelineno-6-321">321</a></span>
<span class="normal"><a href="#__codelineno-6-322">322</a></span>
<span class="normal"><a href="#__codelineno-6-323">323</a></span>
<span class="normal"><a href="#__codelineno-6-324">324</a></span>
<span class="normal"><a href="#__codelineno-6-325">325</a></span>
<span class="normal"><a href="#__codelineno-6-326">326</a></span>
<span class="normal"><a href="#__codelineno-6-327">327</a></span>
<span class="normal"><a href="#__codelineno-6-328">328</a></span>
<span class="normal"><a href="#__codelineno-6-329">329</a></span>
<span class="normal"><a href="#__codelineno-6-330">330</a></span>
<span class="normal"><a href="#__codelineno-6-331">331</a></span>
<span class="normal"><a href="#__codelineno-6-332">332</a></span>
<span class="normal"><a href="#__codelineno-6-333">333</a></span>
<span class="normal"><a href="#__codelineno-6-334">334</a></span>
<span class="normal"><a href="#__codelineno-6-335">335</a></span>
<span class="normal"><a href="#__codelineno-6-336">336</a></span>
<span class="normal"><a href="#__codelineno-6-337">337</a></span>
<span class="normal"><a href="#__codelineno-6-338">338</a></span>
<span class="normal"><a href="#__codelineno-6-339">339</a></span>
<span class="normal"><a href="#__codelineno-6-340">340</a></span>
<span class="normal"><a href="#__codelineno-6-341">341</a></span>
<span class="normal"><a href="#__codelineno-6-342">342</a></span>
<span class="normal"><a href="#__codelineno-6-343">343</a></span>
<span class="normal"><a href="#__codelineno-6-344">344</a></span>
<span class="normal"><a href="#__codelineno-6-345">345</a></span>
<span class="normal"><a href="#__codelineno-6-346">346</a></span>
<span class="normal"><a href="#__codelineno-6-347">347</a></span>
<span class="normal"><a href="#__codelineno-6-348">348</a></span>
<span class="normal"><a href="#__codelineno-6-349">349</a></span>
<span class="normal"><a href="#__codelineno-6-350">350</a></span>
<span class="normal"><a href="#__codelineno-6-351">351</a></span>
<span class="normal"><a href="#__codelineno-6-352">352</a></span>
<span class="normal"><a href="#__codelineno-6-353">353</a></span>
<span class="normal"><a href="#__codelineno-6-354">354</a></span>
<span class="normal"><a href="#__codelineno-6-355">355</a></span>
<span class="normal"><a href="#__codelineno-6-356">356</a></span>
<span class="normal"><a href="#__codelineno-6-357">357</a></span>
<span class="normal"><a href="#__codelineno-6-358">358</a></span>
<span class="normal"><a href="#__codelineno-6-359">359</a></span>
<span class="normal"><a href="#__codelineno-6-360">360</a></span>
<span class="normal"><a href="#__codelineno-6-361">361</a></span>
<span class="normal"><a href="#__codelineno-6-362">362</a></span>
<span class="normal"><a href="#__codelineno-6-363">363</a></span>
<span class="normal"><a href="#__codelineno-6-364">364</a></span>
<span class="normal"><a href="#__codelineno-6-365">365</a></span>
<span class="normal"><a href="#__codelineno-6-366">366</a></span>
<span class="normal"><a href="#__codelineno-6-367">367</a></span>
<span class="normal"><a href="#__codelineno-6-368">368</a></span>
<span class="normal"><a href="#__codelineno-6-369">369</a></span>
<span class="normal"><a href="#__codelineno-6-370">370</a></span>
<span class="normal"><a href="#__codelineno-6-371">371</a></span>
<span class="normal"><a href="#__codelineno-6-372">372</a></span>
<span class="normal"><a href="#__codelineno-6-373">373</a></span>
<span class="normal"><a href="#__codelineno-6-374">374</a></span>
<span class="normal"><a href="#__codelineno-6-375">375</a></span>
<span class="normal"><a href="#__codelineno-6-376">376</a></span>
<span class="normal"><a href="#__codelineno-6-377">377</a></span>
<span class="normal"><a href="#__codelineno-6-378">378</a></span>
<span class="normal"><a href="#__codelineno-6-379">379</a></span>
<span class="normal"><a href="#__codelineno-6-380">380</a></span>
<span class="normal"><a href="#__codelineno-6-381">381</a></span>
<span class="normal"><a href="#__codelineno-6-382">382</a></span>
<span class="normal"><a href="#__codelineno-6-383">383</a></span>
<span class="normal"><a href="#__codelineno-6-384">384</a></span>
<span class="normal"><a href="#__codelineno-6-385">385</a></span>
<span class="normal"><a href="#__codelineno-6-386">386</a></span>
<span class="normal"><a href="#__codelineno-6-387">387</a></span>
<span class="normal"><a href="#__codelineno-6-388">388</a></span>
<span class="normal"><a href="#__codelineno-6-389">389</a></span>
<span class="normal"><a href="#__codelineno-6-390">390</a></span>
<span class="normal"><a href="#__codelineno-6-391">391</a></span>
<span class="normal"><a href="#__codelineno-6-392">392</a></span>
<span class="normal"><a href="#__codelineno-6-393">393</a></span>
<span class="normal"><a href="#__codelineno-6-394">394</a></span>
<span class="normal"><a href="#__codelineno-6-395">395</a></span>
<span class="normal"><a href="#__codelineno-6-396">396</a></span>
<span class="normal"><a href="#__codelineno-6-397">397</a></span>
<span class="normal"><a href="#__codelineno-6-398">398</a></span>
<span class="normal"><a href="#__codelineno-6-399">399</a></span>
<span class="normal"><a href="#__codelineno-6-400">400</a></span>
<span class="normal"><a href="#__codelineno-6-401">401</a></span>
<span class="normal"><a href="#__codelineno-6-402">402</a></span>
<span class="normal"><a href="#__codelineno-6-403">403</a></span>
<span class="normal"><a href="#__codelineno-6-404">404</a></span>
<span class="normal"><a href="#__codelineno-6-405">405</a></span>
<span class="normal"><a href="#__codelineno-6-406">406</a></span>
<span class="normal"><a href="#__codelineno-6-407">407</a></span>
<span class="normal"><a href="#__codelineno-6-408">408</a></span>
<span class="normal"><a href="#__codelineno-6-409">409</a></span>
<span class="normal"><a href="#__codelineno-6-410">410</a></span>
<span class="normal"><a href="#__codelineno-6-411">411</a></span>
<span class="normal"><a href="#__codelineno-6-412">412</a></span>
<span class="normal"><a href="#__codelineno-6-413">413</a></span>
<span class="normal"><a href="#__codelineno-6-414">414</a></span>
<span class="normal"><a href="#__codelineno-6-415">415</a></span>
<span class="normal"><a href="#__codelineno-6-416">416</a></span>
<span class="normal"><a href="#__codelineno-6-417">417</a></span>
<span class="normal"><a href="#__codelineno-6-418">418</a></span>
<span class="normal"><a href="#__codelineno-6-419">419</a></span>
<span class="normal"><a href="#__codelineno-6-420">420</a></span>
<span class="normal"><a href="#__codelineno-6-421">421</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-6-1"><a id="__codelineno-6-1" name="__codelineno-6-1"></a><span class="ch">#!/bin/bash</span>
</span><span id="__span-6-2"><a id="__codelineno-6-2" name="__codelineno-6-2"></a><span class="c1">#</span>
</span><span id="__span-6-3"><a id="__codelineno-6-3" name="__codelineno-6-3"></a><span class="c1"># Export system monitoring metrics to influxdb.</span>
</span><span id="__span-6-4"><a id="__codelineno-6-4" name="__codelineno-6-4"></a>
</span><span id="__span-6-5"><a id="__codelineno-6-5" name="__codelineno-6-5"></a><span class="c1"># InfluxDB target.</span>
</span><span id="__span-6-6"><a id="__codelineno-6-6" name="__codelineno-6-6"></a><span class="nv">DBNAME</span><span class="o">=</span>monitoring
</span><span id="__span-6-7"><a id="__codelineno-6-7" name="__codelineno-6-7"></a><span class="nv">TARGET_HTTP</span><span class="o">=</span><span class="s1">''</span><span class="w"> </span><span class="c1"># Leave empty to skip.</span>
</span><span id="__span-6-8"><a id="__codelineno-6-8" name="__codelineno-6-8"></a><span class="nv">TARGET_HTTPS</span><span class="o">=</span><span class="s1">'http://lexicon:30086'</span>
</span><span id="__span-6-9"><a id="__codelineno-6-9" name="__codelineno-6-9"></a>
</span><span id="__span-6-10"><a id="__codelineno-6-10" name="__codelineno-6-10"></a><span class="c1"># Default delay between each POST request to InfluxDB.</span>
</span><span id="__span-6-11"><a id="__codelineno-6-11" name="__codelineno-6-11"></a><span class="nv">DELAY_POST</span><span class="o">=</span><span class="m">4</span>
</span><span id="__span-6-12"><a id="__codelineno-6-12" name="__codelineno-6-12"></a>
</span><span id="__span-6-13"><a id="__codelineno-6-13" name="__codelineno-6-13"></a><span class="c1"># Data file for batch POST.</span>
</span><span id="__span-6-14"><a id="__codelineno-6-14" name="__codelineno-6-14"></a><span class="nv">DDIR</span><span class="o">=</span><span class="s2">"/dev/shm/</span><span class="nv">$$</span><span class="s2">"</span>
</span><span id="__span-6-15"><a id="__codelineno-6-15" name="__codelineno-6-15"></a><span class="nv">DATA</span><span class="o">=</span><span class="s2">"</span><span class="si">${</span><span class="nv">DDIR</span><span class="si">}</span><span class="s2">/DATA.txt"</span>
</span><span id="__span-6-16"><a id="__codelineno-6-16" name="__codelineno-6-16"></a>mkdir<span class="w"> </span>-p<span class="w"> </span><span class="s2">"</span><span class="si">${</span><span class="nv">DDIR</span><span class="si">}</span><span class="s2">"</span>
</span><span id="__span-6-17"><a id="__codelineno-6-17" name="__codelineno-6-17"></a>
</span><span id="__span-6-18"><a id="__codelineno-6-18" name="__codelineno-6-18"></a><span class="nv">host</span><span class="o">=</span><span class="k">$(</span>hostname<span class="k">)</span>
</span><span id="__span-6-19"><a id="__codelineno-6-19" name="__codelineno-6-19"></a>
</span><span id="__span-6-20"><a id="__codelineno-6-20" name="__codelineno-6-20"></a>timestamp_ns<span class="o">()</span><span class="w"> </span><span class="o">{</span>
</span><span id="__span-6-21"><a id="__codelineno-6-21" name="__codelineno-6-21"></a><span class="w">  </span>date<span class="w"> </span>+<span class="s1">'%s%N'</span>
</span><span id="__span-6-22"><a id="__codelineno-6-22" name="__codelineno-6-22"></a><span class="o">}</span>
</span><span id="__span-6-23"><a id="__codelineno-6-23" name="__codelineno-6-23"></a>
</span><span id="__span-6-24"><a id="__codelineno-6-24" name="__codelineno-6-24"></a>store_line<span class="o">()</span><span class="w"> </span><span class="o">{</span>
</span><span id="__span-6-25"><a id="__codelineno-6-25" name="__codelineno-6-25"></a><span class="w">  </span><span class="c1"># Write a line of data to the temporary in-memory file.</span>
</span><span id="__span-6-26"><a id="__codelineno-6-26" name="__codelineno-6-26"></a><span class="w">  </span><span class="c1"># Exit immediately if this fails.</span>
</span><span id="__span-6-27"><a id="__codelineno-6-27" name="__codelineno-6-27"></a><span class="w">  </span><span class="nb">echo</span><span class="w"> </span><span class="nv">$1</span><span class="w"> </span>&gt;&gt;<span class="s2">"</span><span class="si">${</span><span class="nv">DATA</span><span class="si">}</span><span class="s2">"</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nb">exit</span><span class="w"> </span><span class="m">1</span>
</span><span id="__span-6-28"><a id="__codelineno-6-28" name="__codelineno-6-28"></a><span class="o">}</span>
</span><span id="__span-6-29"><a id="__codelineno-6-29" name="__codelineno-6-29"></a>
</span><span id="__span-6-30"><a id="__codelineno-6-30" name="__codelineno-6-30"></a>report_top_per_process<span class="o">()</span><span class="w"> </span><span class="o">{</span>
</span><span id="__span-6-31"><a id="__codelineno-6-31" name="__codelineno-6-31"></a><span class="w">  </span><span class="c1"># Per-process CPU(%) &amp; MEM(bytes) usage.</span>
</span><span id="__span-6-32"><a id="__codelineno-6-32" name="__codelineno-6-32"></a><span class="w">  </span><span class="c1"># Re-use the ptop file created by report_top().</span>
</span><span id="__span-6-33"><a id="__codelineno-6-33" name="__codelineno-6-33"></a><span class="w">  </span><span class="nv">ts</span><span class="o">=</span><span class="nv">$1</span>
</span><span id="__span-6-34"><a id="__codelineno-6-34" name="__codelineno-6-34"></a><span class="w">  </span><span class="nv">ptop</span><span class="o">=</span><span class="nv">$2</span>
</span><span id="__span-6-35"><a id="__codelineno-6-35" name="__codelineno-6-35"></a><span class="w">  </span>awk<span class="w"> </span><span class="s1">'{print $4}'</span><span class="w"> </span><span class="s2">"</span><span class="si">${</span><span class="nv">ptop</span><span class="si">}</span><span class="s2">"</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>sort<span class="w"> </span>-u<span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="k">while</span><span class="w"> </span><span class="nb">read</span><span class="w"> </span>cmd<span class="p">;</span><span class="w"> </span><span class="k">do</span>
</span><span id="__span-6-36"><a id="__codelineno-6-36" name="__codelineno-6-36"></a><span class="w">    </span><span class="nv">user</span><span class="o">=</span><span class="k">$(</span>grep<span class="w"> </span><span class="s2">" </span><span class="si">${</span><span class="nv">cmd</span><span class="si">}</span><span class="s2">\$"</span><span class="w"> </span><span class="si">${</span><span class="nv">ptop</span><span class="si">}</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>cut<span class="w"> </span>-f1<span class="w"> </span>-d<span class="s1">' '</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>sort<span class="w"> </span>-u<span class="w"> </span><span class="p">|</span><span class="w"> </span>head<span class="w"> </span>-1<span class="k">)</span>
</span><span id="__span-6-37"><a id="__codelineno-6-37" name="__codelineno-6-37"></a><span class="w">    </span><span class="c1"># CPU per proccess, only when &gt; 0</span>
</span><span id="__span-6-38"><a id="__codelineno-6-38" name="__codelineno-6-38"></a><span class="w">    </span><span class="nv">cpu</span><span class="o">=</span><span class="k">$(</span>grep<span class="w"> </span><span class="s2">" </span><span class="si">${</span><span class="nv">cmd</span><span class="si">}</span><span class="s2">\$"</span><span class="w"> </span><span class="si">${</span><span class="nv">ptop</span><span class="si">}</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>cut<span class="w"> </span>-f2<span class="w"> </span>-d<span class="s1">' '</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>-v<span class="w"> </span><span class="s1">'^0\.0$'</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>tr<span class="w"> </span><span class="s1">'\n'</span><span class="w"> </span><span class="s1">'+'</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>sed<span class="w"> </span><span class="s1">'s/+$/\n/'</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>bc<span class="w"> </span>-ql<span class="k">)</span>
</span><span id="__span-6-39"><a id="__codelineno-6-39" name="__codelineno-6-39"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="o">[[</span><span class="w"> </span>!<span class="w"> </span>-z<span class="w"> </span><span class="s2">"</span><span class="si">${</span><span class="nv">cpu</span><span class="si">}</span><span class="s2">"</span><span class="w"> </span><span class="o">]]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
</span><span id="__span-6-40"><a id="__codelineno-6-40" name="__codelineno-6-40"></a><span class="w">      </span>store_line<span class="w"> </span><span class="s2">"top_cpu,host=</span><span class="si">${</span><span class="nv">host</span><span class="si">}</span><span class="s2">,user=</span><span class="si">${</span><span class="nv">user</span><span class="si">}</span><span class="s2">,command=</span><span class="si">${</span><span class="nv">cmd</span><span class="si">}</span><span class="s2"> value=</span><span class="si">${</span><span class="nv">cpu</span><span class="si">}</span><span class="s2"> </span><span class="si">${</span><span class="nv">ts</span><span class="si">}</span><span class="s2">"</span>
</span><span id="__span-6-41"><a id="__codelineno-6-41" name="__codelineno-6-41"></a><span class="w">    </span><span class="k">fi</span>
</span><span id="__span-6-42"><a id="__codelineno-6-42" name="__codelineno-6-42"></a><span class="w">    </span><span class="c1"># Memory per proccess, only when &gt; 1%</span>
</span><span id="__span-6-43"><a id="__codelineno-6-43" name="__codelineno-6-43"></a><span class="w">    </span><span class="nv">mem</span><span class="o">=</span><span class="k">$(</span>grep<span class="w"> </span><span class="s2">" </span><span class="si">${</span><span class="nv">cmd</span><span class="si">}</span><span class="s2">\$"</span><span class="w"> </span><span class="si">${</span><span class="nv">ptop</span><span class="si">}</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>cut<span class="w"> </span>-f3<span class="w"> </span>-d<span class="s1">' '</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>-v<span class="w"> </span><span class="s1">'^0\.0$'</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>tr<span class="w"> </span><span class="s1">'\n'</span><span class="w"> </span><span class="s1">'+'</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>sed<span class="w"> </span><span class="s1">'s/+$/\n/'</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>bc<span class="w"> </span>-ql<span class="w"> </span><span class="p">|</span><span class="w"> </span>sed<span class="w"> </span><span class="s1">'s/^\./0./'</span><span class="k">)</span>
</span><span id="__span-6-44"><a id="__codelineno-6-44" name="__codelineno-6-44"></a><span class="w">    </span><span class="c1"># Multiply %mem by total system RAM.</span>
</span><span id="__span-6-45"><a id="__codelineno-6-45" name="__codelineno-6-45"></a><span class="w">    </span><span class="nv">tot</span><span class="o">=</span><span class="k">$(</span>free<span class="w"> </span>-b<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span><span class="s1">'Mem:'</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>awk<span class="w"> </span><span class="s1">'{print $2}'</span><span class="k">)</span>
</span><span id="__span-6-46"><a id="__codelineno-6-46" name="__codelineno-6-46"></a><span class="w">    </span><span class="nv">ram</span><span class="o">=</span><span class="k">$(</span>bc<span class="w"> </span>-ql<span class="w"> </span><span class="o">&lt;&lt;&lt;</span><span class="s2">"</span><span class="si">${</span><span class="nv">tot</span><span class="si">}</span><span class="s2"> * </span><span class="si">${</span><span class="nv">mem</span><span class="si">}</span><span class="s2"> / 100"</span><span class="k">)</span>
</span><span id="__span-6-47"><a id="__codelineno-6-47" name="__codelineno-6-47"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="o">[[</span><span class="w"> </span>!<span class="w"> </span>-z<span class="w"> </span><span class="s2">"</span><span class="si">${</span><span class="nv">ram</span><span class="si">}</span><span class="s2">"</span><span class="w"> </span><span class="o">]]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
</span><span id="__span-6-48"><a id="__codelineno-6-48" name="__codelineno-6-48"></a><span class="w">      </span>store_line<span class="w"> </span><span class="s2">"top_mem,host=</span><span class="si">${</span><span class="nv">host</span><span class="si">}</span><span class="s2">,user=</span><span class="si">${</span><span class="nv">user</span><span class="si">}</span><span class="s2">,command=</span><span class="si">${</span><span class="nv">cmd</span><span class="si">}</span><span class="s2"> value=</span><span class="si">${</span><span class="nv">ram</span><span class="si">}</span><span class="s2"> </span><span class="si">${</span><span class="nv">ts</span><span class="si">}</span><span class="s2">"</span>
</span><span id="__span-6-49"><a id="__codelineno-6-49" name="__codelineno-6-49"></a><span class="w">    </span><span class="k">fi</span>
</span><span id="__span-6-50"><a id="__codelineno-6-50" name="__codelineno-6-50"></a><span class="w">  </span><span class="k">done</span>
</span><span id="__span-6-51"><a id="__codelineno-6-51" name="__codelineno-6-51"></a><span class="w">  </span>rm<span class="w"> </span>-f<span class="w"> </span><span class="s2">"</span><span class="si">${</span><span class="nv">ptop</span><span class="si">}</span><span class="s2">"</span>
</span><span id="__span-6-52"><a id="__codelineno-6-52" name="__codelineno-6-52"></a><span class="o">}</span>
</span><span id="__span-6-53"><a id="__codelineno-6-53" name="__codelineno-6-53"></a>
</span><span id="__span-6-54"><a id="__codelineno-6-54" name="__codelineno-6-54"></a>report_top<span class="o">()</span><span class="w"> </span><span class="o">{</span>
</span><span id="__span-6-55"><a id="__codelineno-6-55" name="__codelineno-6-55"></a><span class="w">  </span><span class="c1"># Stats from top: CPU (overall and per process) and RAM (per process).</span>
</span><span id="__span-6-56"><a id="__codelineno-6-56" name="__codelineno-6-56"></a><span class="w">  </span><span class="c1"># Depends on: top, free.</span>
</span><span id="__span-6-57"><a id="__codelineno-6-57" name="__codelineno-6-57"></a><span class="w">  </span><span class="nv">top_cmd</span><span class="o">=</span><span class="k">$(</span><span class="nb">command</span><span class="w"> </span>-v<span class="w"> </span>top<span class="k">)</span>
</span><span id="__span-6-58"><a id="__codelineno-6-58" name="__codelineno-6-58"></a><span class="w">  </span><span class="nv">top</span><span class="o">=</span><span class="s2">"</span><span class="si">${</span><span class="nv">DDIR</span><span class="si">}</span><span class="s2">/top"</span>
</span><span id="__span-6-59"><a id="__codelineno-6-59" name="__codelineno-6-59"></a><span class="w">  </span><span class="nv">ts</span><span class="o">=</span><span class="k">$(</span>timestamp_ns<span class="k">)</span>
</span><span id="__span-6-60"><a id="__codelineno-6-60" name="__codelineno-6-60"></a><span class="w">  </span><span class="si">${</span><span class="nv">top_cmd</span><span class="si">}</span><span class="w"> </span>-b<span class="w"> </span>-c<span class="w"> </span>-n<span class="w"> </span><span class="m">1</span><span class="w"> </span>-w<span class="w"> </span><span class="m">512</span><span class="w"> </span><span class="p">|</span>
</span><span id="__span-6-61"><a id="__codelineno-6-61" name="__codelineno-6-61"></a><span class="w">    </span>grep<span class="w"> </span>-vE<span class="w"> </span><span class="s1">' 0\..   0\..|^top|^Tasks|^%|^MiB|^$|[[:blank:]]*PID USER'</span><span class="w"> </span><span class="p">|</span>
</span><span id="__span-6-62"><a id="__codelineno-6-62" name="__codelineno-6-62"></a><span class="w">    </span>awk<span class="w"> </span><span class="s1">'{print $2,$9,$10,$12,$13,$14,$15,$16,$17,$18,$19,$20}'</span><span class="w"> </span><span class="p">|</span>
</span><span id="__span-6-63"><a id="__codelineno-6-63" name="__codelineno-6-63"></a><span class="w">    </span>tr<span class="w"> </span><span class="s1">'\\'</span><span class="w"> </span><span class="s1">'/'</span><span class="w"> </span><span class="p">|</span>
</span><span id="__span-6-64"><a id="__codelineno-6-64" name="__codelineno-6-64"></a><span class="w">    </span>sed<span class="w"> </span><span class="s1">'s/\.minecraft\/bin\/[0-9a-f]\+.*/minecraft/'</span><span class="w"> </span><span class="p">|</span>
</span><span id="__span-6-65"><a id="__codelineno-6-65" name="__codelineno-6-65"></a><span class="w">    </span>sed<span class="w"> </span><span class="s1">'s/[C-Z]:\/.*\/\([a-zA-Z0-9 _-]\+\.[a-z][a-z][a-z]\).*/\1/'</span><span class="w"> </span><span class="p">|</span>
</span><span id="__span-6-66"><a id="__codelineno-6-66" name="__codelineno-6-66"></a><span class="w">    </span>sed<span class="w"> </span><span class="s1">'s/\/[^ ]*\///'</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>sed<span class="w"> </span><span class="s1">'s/\(bash\|sh\|python\|python3\) .*\///'</span><span class="w"> </span><span class="p">|</span>
</span><span id="__span-6-67"><a id="__codelineno-6-67" name="__codelineno-6-67"></a><span class="w">    </span>tr<span class="w"> </span>-d<span class="w"> </span><span class="s1">'['</span><span class="w"> </span><span class="p">|</span>
</span><span id="__span-6-68"><a id="__codelineno-6-68" name="__codelineno-6-68"></a><span class="w">    </span>tr<span class="w"> </span>-d<span class="w"> </span><span class="s1">']'</span><span class="w"> </span><span class="p">|</span>
</span><span id="__span-6-69"><a id="__codelineno-6-69" name="__codelineno-6-69"></a><span class="w">    </span>awk<span class="w"> </span><span class="s1">'{print $1,$2,$3,$4}'</span><span class="w"> </span>&gt;<span class="s2">"</span><span class="si">${</span><span class="nv">top</span><span class="si">}</span><span class="s2">"</span>
</span><span id="__span-6-70"><a id="__codelineno-6-70" name="__codelineno-6-70"></a><span class="w">  </span><span class="c1"># Total CPU(%) usage.</span>
</span><span id="__span-6-71"><a id="__codelineno-6-71" name="__codelineno-6-71"></a><span class="w">  </span><span class="nv">cpu_load</span><span class="o">=</span><span class="k">$(</span>awk<span class="w"> </span><span class="s1">'{print $2}'</span><span class="w"> </span><span class="si">${</span><span class="nv">top</span><span class="si">}</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>-v<span class="w"> </span><span class="s1">'^0\.0$'</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>tr<span class="w"> </span><span class="s1">'\n'</span><span class="w"> </span><span class="s1">'+'</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>sed<span class="w"> </span><span class="s1">'s/+$/\n/'</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>bc<span class="w"> </span>-ql<span class="k">)</span>
</span><span id="__span-6-72"><a id="__codelineno-6-72" name="__codelineno-6-72"></a><span class="w">  </span>store_line<span class="w"> </span><span class="s2">"top,host=</span><span class="si">${</span><span class="nv">host</span><span class="si">}</span><span class="s2"> value=</span><span class="si">${</span><span class="nv">cpu_load</span><span class="si">}</span><span class="s2"> </span><span class="si">${</span><span class="nv">ts</span><span class="si">}</span><span class="s2">"</span>
</span><span id="__span-6-73"><a id="__codelineno-6-73" name="__codelineno-6-73"></a><span class="w">  </span><span class="c1"># Launch the slower per-process metrics in the background.</span>
</span><span id="__span-6-74"><a id="__codelineno-6-74" name="__codelineno-6-74"></a><span class="w">  </span><span class="nv">ptop</span><span class="o">=</span><span class="s2">"</span><span class="si">${</span><span class="nv">top</span><span class="si">}</span><span class="s2">.</span><span class="nv">$RANDOM</span><span class="s2">"</span>
</span><span id="__span-6-75"><a id="__codelineno-6-75" name="__codelineno-6-75"></a><span class="w">  </span>mv<span class="w"> </span><span class="s2">"</span><span class="si">${</span><span class="nv">top</span><span class="si">}</span><span class="s2">"</span><span class="w"> </span><span class="s2">"</span><span class="si">${</span><span class="nv">ptop</span><span class="si">}</span><span class="s2">"</span>
</span><span id="__span-6-76"><a id="__codelineno-6-76" name="__codelineno-6-76"></a><span class="w">  </span>report_top_per_process<span class="w"> </span><span class="s2">"</span><span class="si">${</span><span class="nv">ts</span><span class="si">}</span><span class="s2">"</span><span class="w"> </span><span class="s2">"</span><span class="si">${</span><span class="nv">ptop</span><span class="si">}</span><span class="s2">"</span><span class="w"> </span><span class="p">&amp;</span>
</span><span id="__span-6-77"><a id="__codelineno-6-77" name="__codelineno-6-77"></a><span class="o">}</span>
</span><span id="__span-6-78"><a id="__codelineno-6-78" name="__codelineno-6-78"></a>
</span><span id="__span-6-79"><a id="__codelineno-6-79" name="__codelineno-6-79"></a>report_vcgencmd<span class="o">()</span><span class="w"> </span><span class="o">{</span>
</span><span id="__span-6-80"><a id="__codelineno-6-80" name="__codelineno-6-80"></a><span class="w">  </span><span class="c1"># Raspberry Pi CPU temperature.</span>
</span><span id="__span-6-81"><a id="__codelineno-6-81" name="__codelineno-6-81"></a><span class="w">  </span><span class="c1"># Depends on: vcgencmd.</span>
</span><span id="__span-6-82"><a id="__codelineno-6-82" name="__codelineno-6-82"></a><span class="w">  </span><span class="nv">vcgencmd</span><span class="o">=</span><span class="k">$(</span><span class="nb">command</span><span class="w"> </span>-v<span class="w"> </span>vcgencmd<span class="k">)</span>
</span><span id="__span-6-83"><a id="__codelineno-6-83" name="__codelineno-6-83"></a><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span>-z<span class="w"> </span><span class="s2">"</span><span class="si">${</span><span class="nv">vcgencmd</span><span class="si">}</span><span class="s2">"</span><span class="w"> </span><span class="o">]</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="o">[</span><span class="w"> </span>!<span class="w"> </span>-f<span class="w"> </span><span class="s2">"</span><span class="si">${</span><span class="nv">vcgencmd</span><span class="si">}</span><span class="s2">"</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
</span><span id="__span-6-84"><a id="__codelineno-6-84" name="__codelineno-6-84"></a><span class="w">    </span><span class="k">return</span>
</span><span id="__span-6-85"><a id="__codelineno-6-85" name="__codelineno-6-85"></a><span class="w">  </span><span class="k">fi</span>
</span><span id="__span-6-86"><a id="__codelineno-6-86" name="__codelineno-6-86"></a><span class="w">  </span><span class="nv">ts</span><span class="o">=</span><span class="k">$(</span>timestamp_ns<span class="k">)</span>
</span><span id="__span-6-87"><a id="__codelineno-6-87" name="__codelineno-6-87"></a><span class="w">  </span><span class="nv">cpu_temp</span><span class="o">=</span><span class="k">$(</span><span class="si">${</span><span class="nv">vcgencmd</span><span class="si">}</span><span class="w"> </span>measure_temp<span class="w"> </span><span class="p">|</span><span class="w"> </span>cut<span class="w"> </span>-f2<span class="w"> </span>-d<span class="o">=</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>cut<span class="w"> </span>-f1<span class="w"> </span>-d<span class="s2">"'"</span><span class="k">)</span>
</span><span id="__span-6-88"><a id="__codelineno-6-88" name="__codelineno-6-88"></a><span class="w">  </span>store_line<span class="w"> </span><span class="s2">"vcgencmd,metric=temp,host=</span><span class="si">${</span><span class="nv">host</span><span class="si">}</span><span class="s2"> value=</span><span class="si">${</span><span class="nv">cpu_temp</span><span class="si">}</span><span class="s2"> </span><span class="si">${</span><span class="nv">ts</span><span class="si">}</span><span class="s2">"</span>
</span><span id="__span-6-89"><a id="__codelineno-6-89" name="__codelineno-6-89"></a><span class="w">  </span><span class="k">if</span><span class="w"> </span>grep<span class="w"> </span>-q<span class="w"> </span><span class="s1">'Pi 4'</span><span class="w"> </span>/proc/device-tree/model<span class="p">;</span><span class="w"> </span><span class="k">then</span>
</span><span id="__span-6-90"><a id="__codelineno-6-90" name="__codelineno-6-90"></a><span class="w">    </span><span class="nv">ts</span><span class="o">=</span><span class="k">$(</span>timestamp_ns<span class="k">)</span>
</span><span id="__span-6-91"><a id="__codelineno-6-91" name="__codelineno-6-91"></a><span class="w">    </span><span class="nv">pmic_temp</span><span class="o">=</span><span class="k">$(</span><span class="si">${</span><span class="nv">vcgencmd</span><span class="si">}</span><span class="w"> </span>measure_temp<span class="w"> </span>pmic<span class="w"> </span><span class="p">|</span><span class="w"> </span>cut<span class="w"> </span>-f2<span class="w"> </span>-d<span class="o">=</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>cut<span class="w"> </span>-f1<span class="w"> </span>-d<span class="s2">"'"</span><span class="k">)</span>
</span><span id="__span-6-92"><a id="__codelineno-6-92" name="__codelineno-6-92"></a><span class="w">    </span>store_line<span class="w"> </span><span class="s2">"vcgencmd,metric=temp_pmic,host=</span><span class="si">${</span><span class="nv">host</span><span class="si">}</span><span class="s2"> value=</span><span class="si">${</span><span class="nv">pmic_temp</span><span class="si">}</span><span class="s2"> </span><span class="si">${</span><span class="nv">ts</span><span class="si">}</span><span class="s2">"</span>
</span><span id="__span-6-93"><a id="__codelineno-6-93" name="__codelineno-6-93"></a><span class="w">  </span><span class="k">fi</span>
</span><span id="__span-6-94"><a id="__codelineno-6-94" name="__codelineno-6-94"></a><span class="w">  </span>cat<span class="w"> </span><span class="s2">"</span><span class="si">${</span><span class="nv">DATA</span><span class="si">}</span><span class="s2">"</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>cut<span class="w"> </span>-f1<span class="w"> </span>-d,<span class="w"> </span><span class="p">|</span><span class="w"> </span>sort<span class="w"> </span><span class="p">|</span><span class="w"> </span>uniq<span class="w"> </span>-c
</span><span id="__span-6-95"><a id="__codelineno-6-95" name="__codelineno-6-95"></a><span class="o">}</span>
</span><span id="__span-6-96"><a id="__codelineno-6-96" name="__codelineno-6-96"></a>
</span><span id="__span-6-97"><a id="__codelineno-6-97" name="__codelineno-6-97"></a>report_sensors<span class="o">()</span><span class="w"> </span><span class="o">{</span>
</span><span id="__span-6-98"><a id="__codelineno-6-98" name="__codelineno-6-98"></a><span class="w">  </span><span class="c1"># CPU, SSD, NVMe temperatures and other sensors (if available).</span>
</span><span id="__span-6-99"><a id="__codelineno-6-99" name="__codelineno-6-99"></a><span class="w">  </span><span class="c1"># Depends on: jq, sensors.</span>
</span><span id="__span-6-100"><a id="__codelineno-6-100" name="__codelineno-6-100"></a><span class="w">  </span><span class="nv">jq</span><span class="o">=</span><span class="k">$(</span><span class="nb">command</span><span class="w"> </span>-v<span class="w"> </span>jq<span class="k">)</span>
</span><span id="__span-6-101"><a id="__codelineno-6-101" name="__codelineno-6-101"></a><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span>-z<span class="w"> </span><span class="s2">"</span><span class="si">${</span><span class="nv">jq</span><span class="si">}</span><span class="s2">"</span><span class="w"> </span><span class="o">]</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="o">[</span><span class="w"> </span>!<span class="w"> </span>-f<span class="w"> </span><span class="s2">"</span><span class="si">${</span><span class="nv">jq</span><span class="si">}</span><span class="s2">"</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
</span><span id="__span-6-102"><a id="__codelineno-6-102" name="__codelineno-6-102"></a><span class="w">    </span><span class="k">return</span>
</span><span id="__span-6-103"><a id="__codelineno-6-103" name="__codelineno-6-103"></a><span class="w">  </span><span class="k">fi</span>
</span><span id="__span-6-104"><a id="__codelineno-6-104" name="__codelineno-6-104"></a><span class="w">  </span><span class="nv">sensors</span><span class="o">=</span><span class="k">$(</span><span class="nb">command</span><span class="w"> </span>-v<span class="w"> </span>sensors<span class="k">)</span>
</span><span id="__span-6-105"><a id="__codelineno-6-105" name="__codelineno-6-105"></a><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span>-z<span class="w"> </span><span class="s2">"</span><span class="si">${</span><span class="nv">sensors</span><span class="si">}</span><span class="s2">"</span><span class="w"> </span><span class="o">]</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="o">[</span><span class="w"> </span>!<span class="w"> </span>-f<span class="w"> </span><span class="s2">"</span><span class="si">${</span><span class="nv">sensors</span><span class="si">}</span><span class="s2">"</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
</span><span id="__span-6-106"><a id="__codelineno-6-106" name="__codelineno-6-106"></a><span class="w">    </span><span class="k">return</span>
</span><span id="__span-6-107"><a id="__codelineno-6-107" name="__codelineno-6-107"></a><span class="w">  </span><span class="k">fi</span>
</span><span id="__span-6-108"><a id="__codelineno-6-108" name="__codelineno-6-108"></a><span class="w">  </span><span class="nv">sensors_json</span><span class="o">=</span><span class="s2">"</span><span class="si">${</span><span class="nv">DDIR</span><span class="si">}</span><span class="s2">/sensors"</span>
</span><span id="__span-6-109"><a id="__codelineno-6-109" name="__codelineno-6-109"></a><span class="w">  </span><span class="nv">ts</span><span class="o">=</span><span class="k">$(</span>timestamp_ns<span class="k">)</span>
</span><span id="__span-6-110"><a id="__codelineno-6-110" name="__codelineno-6-110"></a><span class="w">  </span><span class="s2">"</span><span class="si">${</span><span class="nv">sensors</span><span class="si">}</span><span class="s2">"</span><span class="w"> </span>-j<span class="w"> </span>&gt;<span class="s2">"</span><span class="si">${</span><span class="nv">sensors_json</span><span class="si">}</span><span class="s2">"</span>
</span><span id="__span-6-111"><a id="__codelineno-6-111" name="__codelineno-6-111"></a><span class="w">  </span><span class="nv">$jq</span><span class="w"> </span><span class="s1">'keys'</span><span class="w"> </span><span class="s2">"</span><span class="si">${</span><span class="nv">sensors_json</span><span class="si">}</span><span class="s2">"</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span><span class="s1">'^  "'</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>cut<span class="w"> </span>-f2<span class="w"> </span>-d<span class="s1">'"'</span><span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="k">while</span><span class="w"> </span><span class="nb">read</span><span class="w"> </span>adapter<span class="p">;</span><span class="w"> </span><span class="k">do</span>
</span><span id="__span-6-112"><a id="__codelineno-6-112" name="__codelineno-6-112"></a><span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">"adapter: </span><span class="nv">$adapter</span><span class="s2">"</span>
</span><span id="__span-6-113"><a id="__codelineno-6-113" name="__codelineno-6-113"></a><span class="w">    </span><span class="nv">$jq</span><span class="w"> </span><span class="s2">".\"</span><span class="si">${</span><span class="nv">adapter</span><span class="si">}</span><span class="s2">\""</span><span class="w"> </span><span class="s2">"</span><span class="si">${</span><span class="nv">sensors_json</span><span class="si">}</span><span class="s2">"</span><span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="nv">$jq</span><span class="w"> </span><span class="s1">'keys'</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span><span class="s1">'^  "'</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>-v<span class="w"> </span><span class="s1">'"Adapter"'</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>cut<span class="w"> </span>-f2<span class="w"> </span>-d<span class="s1">'"'</span><span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="k">while</span><span class="w"> </span><span class="nb">read</span><span class="w"> </span>name<span class="p">;</span><span class="w"> </span><span class="k">do</span>
</span><span id="__span-6-114"><a id="__codelineno-6-114" name="__codelineno-6-114"></a><span class="w">      </span><span class="nv">key</span><span class="o">=</span><span class="k">$(</span><span class="nv">$jq</span><span class="w"> </span><span class="s2">".\"</span><span class="si">${</span><span class="nv">adapter</span><span class="si">}</span><span class="s2">\".\"</span><span class="si">${</span><span class="nv">name</span><span class="si">}</span><span class="s2">\""</span><span class="w"> </span><span class="s2">"</span><span class="si">${</span><span class="nv">sensors_json</span><span class="si">}</span><span class="s2">"</span><span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="nv">$jq</span><span class="w"> </span><span class="s1">'keys'</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span><span class="s1">'^  "'</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span><span class="s1">'_input"'</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>cut<span class="w"> </span>-f2<span class="w"> </span>-d<span class="s1">'"'</span><span class="k">)</span>
</span><span id="__span-6-115"><a id="__codelineno-6-115" name="__codelineno-6-115"></a><span class="w">      </span><span class="nv">value</span><span class="o">=</span><span class="k">$(</span><span class="nv">$jq</span><span class="w"> </span><span class="s2">".\"</span><span class="si">${</span><span class="nv">adapter</span><span class="si">}</span><span class="s2">\".\"</span><span class="si">${</span><span class="nv">name</span><span class="si">}</span><span class="s2">\".\"</span><span class="si">${</span><span class="nv">key</span><span class="si">}</span><span class="s2">\""</span><span class="w"> </span><span class="s2">"</span><span class="si">${</span><span class="nv">sensors_json</span><span class="si">}</span><span class="s2">"</span><span class="k">)</span>
</span><span id="__span-6-116"><a id="__codelineno-6-116" name="__codelineno-6-116"></a><span class="w">      </span>store_line<span class="w"> </span><span class="s2">"sensors,host=</span><span class="si">${</span><span class="nv">host</span><span class="si">}</span><span class="s2">,adapter=</span><span class="si">${</span><span class="nv">adapter</span><span class="si">}</span><span class="s2">,name=</span><span class="si">${</span><span class="nv">name</span><span class="p">/ /_</span><span class="si">}</span><span class="s2"> value=</span><span class="si">${</span><span class="nv">value</span><span class="si">}</span><span class="s2"> </span><span class="si">${</span><span class="nv">ts</span><span class="si">}</span><span class="s2">"</span>
</span><span id="__span-6-117"><a id="__codelineno-6-117" name="__codelineno-6-117"></a><span class="w">    </span><span class="k">done</span>
</span><span id="__span-6-118"><a id="__codelineno-6-118" name="__codelineno-6-118"></a><span class="w">  </span><span class="k">done</span>
</span><span id="__span-6-119"><a id="__codelineno-6-119" name="__codelineno-6-119"></a><span class="o">}</span>
</span><span id="__span-6-120"><a id="__codelineno-6-120" name="__codelineno-6-120"></a>
</span><span id="__span-6-121"><a id="__codelineno-6-121" name="__codelineno-6-121"></a>report_intel_gpu_top<span class="o">()</span><span class="w"> </span><span class="o">{</span>
</span><span id="__span-6-122"><a id="__codelineno-6-122" name="__codelineno-6-122"></a><span class="w">  </span><span class="c1"># Intel GPU.</span>
</span><span id="__span-6-123"><a id="__codelineno-6-123" name="__codelineno-6-123"></a><span class="w">  </span><span class="c1"># Depends on: intel_gpu_top (as root).</span>
</span><span id="__span-6-124"><a id="__codelineno-6-124" name="__codelineno-6-124"></a><span class="w">  </span><span class="nv">intel_gpu_top</span><span class="o">=</span><span class="k">$(</span><span class="nb">command</span><span class="w"> </span>-v<span class="w"> </span>intel_gpu_top<span class="k">)</span>
</span><span id="__span-6-125"><a id="__codelineno-6-125" name="__codelineno-6-125"></a><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span>-z<span class="w"> </span><span class="nv">$intel_gpu_top</span><span class="w"> </span><span class="o">]</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="o">[</span><span class="w"> </span>!<span class="w"> </span>-f<span class="w"> </span><span class="nv">$intel_gpu_top</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
</span><span id="__span-6-126"><a id="__codelineno-6-126" name="__codelineno-6-126"></a><span class="w">    </span><span class="k">return</span>
</span><span id="__span-6-127"><a id="__codelineno-6-127" name="__codelineno-6-127"></a><span class="w">  </span><span class="k">fi</span>
</span><span id="__span-6-128"><a id="__codelineno-6-128" name="__codelineno-6-128"></a><span class="w">  </span><span class="nv">ts</span><span class="o">=</span><span class="k">$(</span>timestamp_ns<span class="k">)</span>
</span><span id="__span-6-129"><a id="__codelineno-6-129" name="__codelineno-6-129"></a><span class="w">  </span><span class="c1"># TODO: try with -J and find the most meaningful metrics.</span>
</span><span id="__span-6-130"><a id="__codelineno-6-130" name="__codelineno-6-130"></a><span class="w">  </span><span class="nv">gpu_load</span><span class="o">=</span><span class="k">$(</span>sudo<span class="w"> </span><span class="si">${</span><span class="nv">intel_gpu_top</span><span class="si">}</span><span class="w"> </span>-o<span class="w"> </span>-<span class="w"> </span><span class="p">|</span><span class="w"> </span>head<span class="w"> </span>-3<span class="w"> </span><span class="p">|</span><span class="w"> </span>tail<span class="w"> </span>-1<span class="w"> </span><span class="p">|</span><span class="w"> </span>awk<span class="w"> </span><span class="s1">'{print $2}'</span><span class="k">)</span>
</span><span id="__span-6-131"><a id="__codelineno-6-131" name="__codelineno-6-131"></a><span class="w">  </span>store_line<span class="w"> </span><span class="s2">"intel_gpu,host=</span><span class="si">${</span><span class="nv">host</span><span class="si">}</span><span class="s2"> value=</span><span class="si">${</span><span class="nv">value</span><span class="si">}</span><span class="s2"> </span><span class="si">${</span><span class="nv">ts</span><span class="si">}</span><span class="s2">"</span>
</span><span id="__span-6-132"><a id="__codelineno-6-132" name="__codelineno-6-132"></a><span class="o">}</span>
</span><span id="__span-6-133"><a id="__codelineno-6-133" name="__codelineno-6-133"></a>
</span><span id="__span-6-134"><a id="__codelineno-6-134" name="__codelineno-6-134"></a>report_nvidia_smi<span class="o">()</span><span class="w"> </span><span class="o">{</span>
</span><span id="__span-6-135"><a id="__codelineno-6-135" name="__codelineno-6-135"></a><span class="w">  </span><span class="c1"># NVidia GPU.</span>
</span><span id="__span-6-136"><a id="__codelineno-6-136" name="__codelineno-6-136"></a><span class="w">  </span><span class="c1"># Depends on: nvidia-smi</span>
</span><span id="__span-6-137"><a id="__codelineno-6-137" name="__codelineno-6-137"></a><span class="w">  </span><span class="nv">nvidia_smi</span><span class="o">=</span><span class="k">$(</span><span class="nb">command</span><span class="w"> </span>-v<span class="w"> </span>nvidia-smi<span class="k">)</span>
</span><span id="__span-6-138"><a id="__codelineno-6-138" name="__codelineno-6-138"></a><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span>-z<span class="w"> </span><span class="s2">"</span><span class="si">${</span><span class="nv">nvidia_smi</span><span class="si">}</span><span class="s2">"</span><span class="w"> </span><span class="o">]</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="o">[</span><span class="w"> </span>!<span class="w"> </span>-f<span class="w"> </span><span class="s2">"</span><span class="si">${</span><span class="nv">nvidia_smi</span><span class="si">}</span><span class="s2">"</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
</span><span id="__span-6-139"><a id="__codelineno-6-139" name="__codelineno-6-139"></a><span class="w">    </span><span class="k">return</span>
</span><span id="__span-6-140"><a id="__codelineno-6-140" name="__codelineno-6-140"></a><span class="w">  </span><span class="k">fi</span>
</span><span id="__span-6-141"><a id="__codelineno-6-141" name="__codelineno-6-141"></a><span class="w">  </span><span class="nv">ts</span><span class="o">=</span><span class="k">$(</span>timestamp_ns<span class="k">)</span>
</span><span id="__span-6-142"><a id="__codelineno-6-142" name="__codelineno-6-142"></a><span class="w">  </span><span class="nv">temp</span><span class="o">=</span><span class="k">$(</span><span class="si">${</span><span class="nv">nvidia_smi</span><span class="si">}</span><span class="w"> </span>-i<span class="w"> </span><span class="m">0</span><span class="w"> </span>--query-gpu<span class="o">=</span>temperature.gpu<span class="w"> </span>--format<span class="o">=</span>csv,noheader<span class="k">)</span>
</span><span id="__span-6-143"><a id="__codelineno-6-143" name="__codelineno-6-143"></a><span class="w">  </span><span class="nv">util</span><span class="o">=</span><span class="k">$(</span><span class="si">${</span><span class="nv">nvidia_smi</span><span class="si">}</span><span class="w"> </span>-i<span class="w"> </span><span class="m">0</span><span class="w"> </span>--query-gpu<span class="o">=</span>utilization.gpu<span class="w"> </span>--format<span class="o">=</span>csv,noheader<span class="w"> </span><span class="p">|</span><span class="w"> </span>cut<span class="w"> </span>-f1<span class="w"> </span>-d<span class="s1">' '</span><span class="k">)</span>
</span><span id="__span-6-144"><a id="__codelineno-6-144" name="__codelineno-6-144"></a><span class="w">  </span><span class="nv">vram</span><span class="o">=</span><span class="k">$(</span><span class="si">${</span><span class="nv">nvidia_smi</span><span class="si">}</span><span class="w"> </span>-i<span class="w"> </span><span class="m">0</span><span class="w"> </span>--query-gpu<span class="o">=</span>memory.used<span class="w"> </span>--format<span class="o">=</span>csv,noheader<span class="w"> </span><span class="p">|</span><span class="w"> </span>cut<span class="w"> </span>-f1<span class="w"> </span>-d<span class="s1">' '</span><span class="k">)</span>
</span><span id="__span-6-145"><a id="__codelineno-6-145" name="__codelineno-6-145"></a><span class="w">  </span><span class="nv">draw</span><span class="o">=</span><span class="k">$(</span><span class="si">${</span><span class="nv">nvidia_smi</span><span class="si">}</span><span class="w"> </span>-i<span class="w"> </span><span class="m">0</span><span class="w"> </span>--query-gpu<span class="o">=</span>power.draw<span class="w"> </span>--format<span class="o">=</span>csv,noheader<span class="w"> </span><span class="p">|</span><span class="w"> </span>cut<span class="w"> </span>-f1<span class="w"> </span>-d<span class="s1">' '</span><span class="k">)</span>
</span><span id="__span-6-146"><a id="__codelineno-6-146" name="__codelineno-6-146"></a><span class="w">  </span><span class="nv">fans</span><span class="o">=</span><span class="k">$(</span><span class="si">${</span><span class="nv">nvidia_smi</span><span class="si">}</span><span class="w"> </span>-i<span class="w"> </span><span class="m">0</span><span class="w"> </span>--query-gpu<span class="o">=</span>fan.speed<span class="w"> </span>--format<span class="o">=</span>csv,noheader<span class="w"> </span><span class="p">|</span><span class="w"> </span>cut<span class="w"> </span>-f1<span class="w"> </span>-d<span class="s1">' '</span><span class="k">)</span>
</span><span id="__span-6-147"><a id="__codelineno-6-147" name="__codelineno-6-147"></a><span class="w">  </span>store_line<span class="w"> </span><span class="s2">"nvidia_smi,host=</span><span class="si">${</span><span class="nv">host</span><span class="si">}</span><span class="s2">,metric=temperature value=</span><span class="si">${</span><span class="nv">temp</span><span class="si">}</span><span class="s2"> </span><span class="si">${</span><span class="nv">ts</span><span class="si">}</span><span class="s2">"</span>
</span><span id="__span-6-148"><a id="__codelineno-6-148" name="__codelineno-6-148"></a><span class="w">  </span>store_line<span class="w"> </span><span class="s2">"nvidia_smi,host=</span><span class="si">${</span><span class="nv">host</span><span class="si">}</span><span class="s2">,metric=utilization value=</span><span class="si">${</span><span class="nv">util</span><span class="si">}</span><span class="s2"> </span><span class="si">${</span><span class="nv">ts</span><span class="si">}</span><span class="s2">"</span>
</span><span id="__span-6-149"><a id="__codelineno-6-149" name="__codelineno-6-149"></a><span class="w">  </span>store_line<span class="w"> </span><span class="s2">"nvidia_smi,host=</span><span class="si">${</span><span class="nv">host</span><span class="si">}</span><span class="s2">,metric=memory value=</span><span class="si">${</span><span class="nv">vram</span><span class="si">}</span><span class="s2"> </span><span class="si">${</span><span class="nv">ts</span><span class="si">}</span><span class="s2">"</span>
</span><span id="__span-6-150"><a id="__codelineno-6-150" name="__codelineno-6-150"></a><span class="w">  </span>store_line<span class="w"> </span><span class="s2">"nvidia_smi,host=</span><span class="si">${</span><span class="nv">host</span><span class="si">}</span><span class="s2">,metric=power value=</span><span class="si">${</span><span class="nv">draw</span><span class="si">}</span><span class="s2"> </span><span class="si">${</span><span class="nv">ts</span><span class="si">}</span><span class="s2">"</span>
</span><span id="__span-6-151"><a id="__codelineno-6-151" name="__codelineno-6-151"></a><span class="w">  </span>store_line<span class="w"> </span><span class="s2">"nvidia_smi,host=</span><span class="si">${</span><span class="nv">host</span><span class="si">}</span><span class="s2">,metric=fan value=</span><span class="si">${</span><span class="nv">fans</span><span class="si">}</span><span class="s2"> </span><span class="si">${</span><span class="nv">ts</span><span class="si">}</span><span class="s2">"</span>
</span><span id="__span-6-152"><a id="__codelineno-6-152" name="__codelineno-6-152"></a><span class="o">}</span>
</span><span id="__span-6-153"><a id="__codelineno-6-153" name="__codelineno-6-153"></a>
</span><span id="__span-6-154"><a id="__codelineno-6-154" name="__codelineno-6-154"></a>report_free<span class="o">()</span><span class="w"> </span><span class="o">{</span>
</span><span id="__span-6-155"><a id="__codelineno-6-155" name="__codelineno-6-155"></a><span class="w">  </span><span class="c1"># Stats from free: RAM used, buffered/cached, free.</span>
</span><span id="__span-6-156"><a id="__codelineno-6-156" name="__codelineno-6-156"></a><span class="w">  </span><span class="c1"># Depends on: free.</span>
</span><span id="__span-6-157"><a id="__codelineno-6-157" name="__codelineno-6-157"></a><span class="w">  </span><span class="nv">ts</span><span class="o">=</span><span class="k">$(</span>timestamp_ns<span class="k">)</span>
</span><span id="__span-6-158"><a id="__codelineno-6-158" name="__codelineno-6-158"></a><span class="w">  </span><span class="nv">mem_used</span><span class="o">=</span><span class="k">$(</span>free<span class="w"> </span>-b<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span><span class="s1">'Mem:'</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>awk<span class="w"> </span><span class="s1">'{print $3}'</span><span class="k">)</span>
</span><span id="__span-6-159"><a id="__codelineno-6-159" name="__codelineno-6-159"></a><span class="w">  </span><span class="nv">mem_free</span><span class="o">=</span><span class="k">$(</span>free<span class="w"> </span>-b<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span><span class="s1">'Mem:'</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>awk<span class="w"> </span><span class="s1">'{print $4}'</span><span class="k">)</span>
</span><span id="__span-6-160"><a id="__codelineno-6-160" name="__codelineno-6-160"></a><span class="w">  </span><span class="nv">mem_buff</span><span class="o">=</span><span class="k">$(</span>free<span class="w"> </span>-b<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span><span class="s1">'Mem:'</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>awk<span class="w"> </span><span class="s1">'{print $6}'</span><span class="k">)</span>
</span><span id="__span-6-161"><a id="__codelineno-6-161" name="__codelineno-6-161"></a><span class="w">  </span>store_line<span class="w"> </span><span class="s2">"free,host=</span><span class="si">${</span><span class="nv">host</span><span class="si">}</span><span class="s2">,metric=used value=</span><span class="si">${</span><span class="nv">mem_used</span><span class="si">}</span><span class="s2"> </span><span class="si">${</span><span class="nv">ts</span><span class="si">}</span><span class="s2">"</span>
</span><span id="__span-6-162"><a id="__codelineno-6-162" name="__codelineno-6-162"></a><span class="w">  </span>store_line<span class="w"> </span><span class="s2">"free,host=</span><span class="si">${</span><span class="nv">host</span><span class="si">}</span><span class="s2">,metric=free value=</span><span class="si">${</span><span class="nv">mem_free</span><span class="si">}</span><span class="s2"> </span><span class="si">${</span><span class="nv">ts</span><span class="si">}</span><span class="s2">"</span>
</span><span id="__span-6-163"><a id="__codelineno-6-163" name="__codelineno-6-163"></a><span class="w">  </span>store_line<span class="w"> </span><span class="s2">"free,host=</span><span class="si">${</span><span class="nv">host</span><span class="si">}</span><span class="s2">,metric=buff_cache value=</span><span class="si">${</span><span class="nv">mem_buff</span><span class="si">}</span><span class="s2"> </span><span class="si">${</span><span class="nv">ts</span><span class="si">}</span><span class="s2">"</span>
</span><span id="__span-6-164"><a id="__codelineno-6-164" name="__codelineno-6-164"></a><span class="o">}</span>
</span><span id="__span-6-165"><a id="__codelineno-6-165" name="__codelineno-6-165"></a>
</span><span id="__span-6-166"><a id="__codelineno-6-166" name="__codelineno-6-166"></a>report_df<span class="o">()</span><span class="w"> </span><span class="o">{</span>
</span><span id="__span-6-167"><a id="__codelineno-6-167" name="__codelineno-6-167"></a><span class="w">  </span><span class="c1"># Stats from df: used/free space per file system.</span>
</span><span id="__span-6-168"><a id="__codelineno-6-168" name="__codelineno-6-168"></a><span class="w">  </span><span class="c1"># Depends on: df.</span>
</span><span id="__span-6-169"><a id="__codelineno-6-169" name="__codelineno-6-169"></a><span class="w">  </span><span class="nv">ts</span><span class="o">=</span><span class="k">$(</span>timestamp_ns<span class="k">)</span>
</span><span id="__span-6-170"><a id="__codelineno-6-170" name="__codelineno-6-170"></a><span class="w">  </span>df<span class="w"> </span>-k<span class="w"> </span><span class="p">|</span><span class="w"> </span>egrep<span class="w"> </span>-v<span class="w"> </span><span class="s1">'udev|loop|/sys|/run|/dev$'</span><span class="w"> </span><span class="p">|</span>
</span><span id="__span-6-171"><a id="__codelineno-6-171" name="__codelineno-6-171"></a><span class="w">    </span>grep<span class="w"> </span><span class="s1">' /'</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>awk<span class="w"> </span><span class="s1">'{print $4,$5,$6}'</span><span class="w"> </span><span class="p">|</span>
</span><span id="__span-6-172"><a id="__codelineno-6-172" name="__codelineno-6-172"></a><span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="nb">read</span><span class="w"> </span>line<span class="p">;</span><span class="w"> </span><span class="k">do</span>
</span><span id="__span-6-173"><a id="__codelineno-6-173" name="__codelineno-6-173"></a><span class="w">      </span><span class="c1"># Note free space is given in 1KB blocks.</span>
</span><span id="__span-6-174"><a id="__codelineno-6-174" name="__codelineno-6-174"></a><span class="w">      </span><span class="nv">fs_path</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span><span class="w"> </span><span class="s2">"</span><span class="si">${</span><span class="nv">line</span><span class="si">}</span><span class="s2">"</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>cut<span class="w"> </span>-f3<span class="w"> </span>-d<span class="s1">' '</span><span class="k">)</span>
</span><span id="__span-6-175"><a id="__codelineno-6-175" name="__codelineno-6-175"></a><span class="w">      </span><span class="nv">fs_used</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span><span class="w"> </span><span class="s2">"</span><span class="si">${</span><span class="nv">line</span><span class="si">}</span><span class="s2">"</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>cut<span class="w"> </span>-f2<span class="w"> </span>-d<span class="s1">' '</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>cut<span class="w"> </span>-f1<span class="w"> </span>-d<span class="s1">'%'</span><span class="k">)</span>
</span><span id="__span-6-176"><a id="__codelineno-6-176" name="__codelineno-6-176"></a><span class="w">      </span><span class="nv">fs_free</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span><span class="w"> </span><span class="s2">"</span><span class="si">${</span><span class="nv">line</span><span class="si">}</span><span class="s2">"</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>cut<span class="w"> </span>-f1<span class="w"> </span>-d<span class="s1">' '</span><span class="k">)</span>
</span><span id="__span-6-177"><a id="__codelineno-6-177" name="__codelineno-6-177"></a><span class="w">      </span><span class="nv">fs_free</span><span class="o">=</span><span class="k">$((</span><span class="m">1024</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nv">fs_free</span><span class="k">))</span>
</span><span id="__span-6-178"><a id="__codelineno-6-178" name="__codelineno-6-178"></a><span class="w">      </span>store_line<span class="w"> </span><span class="s2">"df,host=</span><span class="si">${</span><span class="nv">host</span><span class="si">}</span><span class="s2">,path=</span><span class="si">${</span><span class="nv">fs_path</span><span class="si">}</span><span class="s2">,metric=tot_free value=</span><span class="si">${</span><span class="nv">fs_free</span><span class="si">}</span><span class="s2"> </span><span class="si">${</span><span class="nv">ts</span><span class="si">}</span><span class="s2">"</span>
</span><span id="__span-6-179"><a id="__codelineno-6-179" name="__codelineno-6-179"></a><span class="w">      </span>store_line<span class="w"> </span><span class="s2">"df,host=</span><span class="si">${</span><span class="nv">host</span><span class="si">}</span><span class="s2">,path=</span><span class="si">${</span><span class="nv">fs_path</span><span class="si">}</span><span class="s2">,metric=pct_used value=</span><span class="si">${</span><span class="nv">fs_used</span><span class="si">}</span><span class="s2"> </span><span class="si">${</span><span class="nv">ts</span><span class="si">}</span><span class="s2">"</span>
</span><span id="__span-6-180"><a id="__codelineno-6-180" name="__codelineno-6-180"></a><span class="w">    </span><span class="k">done</span>
</span><span id="__span-6-181"><a id="__codelineno-6-181" name="__codelineno-6-181"></a><span class="o">}</span>
</span><span id="__span-6-182"><a id="__codelineno-6-182" name="__codelineno-6-182"></a>
</span><span id="__span-6-183"><a id="__codelineno-6-183" name="__codelineno-6-183"></a>report_diskstats<span class="o">()</span><span class="w"> </span><span class="o">{</span>
</span><span id="__span-6-184"><a id="__codelineno-6-184" name="__codelineno-6-184"></a><span class="w">  </span><span class="c1"># Disk I/O stats from /proc/diskstats.</span>
</span><span id="__span-6-185"><a id="__codelineno-6-185" name="__codelineno-6-185"></a><span class="w">  </span><span class="c1"># Depends on: /proc/diskstats.</span>
</span><span id="__span-6-186"><a id="__codelineno-6-186" name="__codelineno-6-186"></a><span class="w">  </span><span class="nv">ts</span><span class="o">=</span><span class="k">$(</span>timestamp_ns<span class="k">)</span>
</span><span id="__span-6-187"><a id="__codelineno-6-187" name="__codelineno-6-187"></a><span class="w">  </span><span class="c1"># The /proc/diskstats file displays the I/O statistics of block devices.</span>
</span><span id="__span-6-188"><a id="__codelineno-6-188" name="__codelineno-6-188"></a><span class="w">  </span><span class="c1"># Each line contains the following fields (and more, omitted here):</span>
</span><span id="__span-6-189"><a id="__codelineno-6-189" name="__codelineno-6-189"></a><span class="w">  </span><span class="c1">#  1  major number</span>
</span><span id="__span-6-190"><a id="__codelineno-6-190" name="__codelineno-6-190"></a><span class="w">  </span><span class="c1">#  2  minor mumber</span>
</span><span id="__span-6-191"><a id="__codelineno-6-191" name="__codelineno-6-191"></a><span class="w">  </span><span class="c1">#  3  device name</span>
</span><span id="__span-6-192"><a id="__codelineno-6-192" name="__codelineno-6-192"></a><span class="w">  </span><span class="c1">#  4  reads completed successfully</span>
</span><span id="__span-6-193"><a id="__codelineno-6-193" name="__codelineno-6-193"></a><span class="w">  </span><span class="c1">#  5  reads merged</span>
</span><span id="__span-6-194"><a id="__codelineno-6-194" name="__codelineno-6-194"></a><span class="w">  </span><span class="c1">#  6  sectors read</span>
</span><span id="__span-6-195"><a id="__codelineno-6-195" name="__codelineno-6-195"></a><span class="w">  </span><span class="c1">#  7  time spent reading (ms)</span>
</span><span id="__span-6-196"><a id="__codelineno-6-196" name="__codelineno-6-196"></a><span class="w">  </span><span class="c1">#  8  writes completed</span>
</span><span id="__span-6-197"><a id="__codelineno-6-197" name="__codelineno-6-197"></a><span class="w">  </span><span class="c1">#  9  writes merged</span>
</span><span id="__span-6-198"><a id="__codelineno-6-198" name="__codelineno-6-198"></a><span class="w">  </span><span class="c1"># 10  sectors written</span>
</span><span id="__span-6-199"><a id="__codelineno-6-199" name="__codelineno-6-199"></a><span class="w">  </span><span class="c1"># 11  time spent writing (ms)</span>
</span><span id="__span-6-200"><a id="__codelineno-6-200" name="__codelineno-6-200"></a><span class="w">  </span><span class="c1"># Source: https://www.kernel.org/doc/Documentation/ABI/testing/procfs-diskstats</span>
</span><span id="__span-6-201"><a id="__codelineno-6-201" name="__codelineno-6-201"></a><span class="w">  </span>grep<span class="w"> </span>-v<span class="w"> </span><span class="s1">' 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0'</span><span class="w"> </span>/proc/diskstats<span class="w"> </span><span class="p">|</span><span class="w"> </span>egrep<span class="w"> </span>-v<span class="w"> </span><span class="s1">'loop|[hs]d[a-z][1-9]|k0p[0-9]'</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>awk<span class="w"> </span><span class="s1">'{print $3,$4,$6,$7,$8,$10,$11}'</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>sort<span class="w"> </span>&gt;<span class="nv">$DDIR</span>/disk1
</span><span id="__span-6-202"><a id="__codelineno-6-202" name="__codelineno-6-202"></a><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="o">[[</span><span class="w"> </span>-f<span class="w"> </span><span class="s2">"</span><span class="si">${</span><span class="nv">DDIR</span><span class="si">}</span><span class="s2">/disk0"</span><span class="w"> </span><span class="o">]]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
</span><span id="__span-6-203"><a id="__codelineno-6-203" name="__codelineno-6-203"></a><span class="w">    </span><span class="c1"># Columns used: disk reads rsect rtime writs wsect wtime</span>
</span><span id="__span-6-204"><a id="__codelineno-6-204" name="__codelineno-6-204"></a><span class="w">    </span><span class="c1"># disk:   3  device name</span>
</span><span id="__span-6-205"><a id="__codelineno-6-205" name="__codelineno-6-205"></a><span class="w">    </span><span class="c1"># reads:  4  reads completed successfully</span>
</span><span id="__span-6-206"><a id="__codelineno-6-206" name="__codelineno-6-206"></a><span class="w">    </span><span class="c1"># rsect:  6  sectors read</span>
</span><span id="__span-6-207"><a id="__codelineno-6-207" name="__codelineno-6-207"></a><span class="w">    </span><span class="c1"># rtime:  7  time spent reading (ms)</span>
</span><span id="__span-6-208"><a id="__codelineno-6-208" name="__codelineno-6-208"></a><span class="w">    </span><span class="c1"># writs:  8  writes completed</span>
</span><span id="__span-6-209"><a id="__codelineno-6-209" name="__codelineno-6-209"></a><span class="w">    </span><span class="c1"># wsect: 10  sectors written</span>
</span><span id="__span-6-210"><a id="__codelineno-6-210" name="__codelineno-6-210"></a><span class="w">    </span><span class="c1"># wtime: 11  time spent writing (ms)</span>
</span><span id="__span-6-211"><a id="__codelineno-6-211" name="__codelineno-6-211"></a><span class="w">    </span>paste<span class="w"> </span><span class="s2">"</span><span class="si">${</span><span class="nv">DDIR</span><span class="si">}</span><span class="s2">/disk0"</span><span class="w"> </span><span class="s2">"</span><span class="si">${</span><span class="nv">DDIR</span><span class="si">}</span><span class="s2">/disk1"</span><span class="w"> </span><span class="p">|</span>
</span><span id="__span-6-212"><a id="__codelineno-6-212" name="__codelineno-6-212"></a><span class="w">      </span><span class="k">while</span><span class="w"> </span><span class="nb">read</span><span class="w"> </span><span class="se">\</span>
</span><span id="__span-6-213"><a id="__codelineno-6-213" name="__codelineno-6-213"></a><span class="w">        </span>disk0<span class="w"> </span>reads0<span class="w"> </span>rsect0<span class="w"> </span>rtime0<span class="w"> </span>writs0<span class="w"> </span>wsect0<span class="w"> </span>wtime0<span class="w"> </span><span class="se">\</span>
</span><span id="__span-6-214"><a id="__codelineno-6-214" name="__codelineno-6-214"></a><span class="w">        </span>disk1<span class="w"> </span>reads1<span class="w"> </span>rsect1<span class="w"> </span>rtime1<span class="w"> </span>writs1<span class="w"> </span>wsect1<span class="w"> </span>wtime1<span class="p">;</span><span class="w"> </span><span class="k">do</span>
</span><span id="__span-6-215"><a id="__codelineno-6-215" name="__codelineno-6-215"></a><span class="w">        </span><span class="c1"># Skip momentary inconsistencies when disks are added or removed.</span>
</span><span id="__span-6-216"><a id="__codelineno-6-216" name="__codelineno-6-216"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="s2">"</span><span class="si">${</span><span class="nv">disk0</span><span class="si">}</span><span class="s2">"</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">"</span><span class="si">${</span><span class="nv">disk1</span><span class="si">}</span><span class="s2">"</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
</span><span id="__span-6-217"><a id="__codelineno-6-217" name="__codelineno-6-217"></a><span class="w">          </span><span class="nv">disk</span><span class="o">=</span><span class="nv">$disk0</span>
</span><span id="__span-6-218"><a id="__codelineno-6-218" name="__codelineno-6-218"></a><span class="w">          </span><span class="c1"># Assume 512-byte sectors.</span>
</span><span id="__span-6-219"><a id="__codelineno-6-219" name="__codelineno-6-219"></a><span class="w">          </span><span class="nv">rsect</span><span class="o">=</span><span class="k">$((</span><span class="m">512</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="o">(</span><span class="nv">rsect1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nv">rsect0</span><span class="k">))</span><span class="o">)</span>
</span><span id="__span-6-220"><a id="__codelineno-6-220" name="__codelineno-6-220"></a><span class="w">          </span><span class="nv">wsect</span><span class="o">=</span><span class="k">$((</span><span class="m">512</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="o">(</span><span class="nv">wsect1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nv">wsect0</span><span class="k">))</span><span class="o">)</span>
</span><span id="__span-6-221"><a id="__codelineno-6-221" name="__codelineno-6-221"></a><span class="w">          </span>store_line<span class="w"> </span><span class="s2">"diskstats,host=</span><span class="si">${</span><span class="nv">host</span><span class="si">}</span><span class="s2">,device=</span><span class="si">${</span><span class="nv">disk</span><span class="si">}</span><span class="s2">,metric=bytes_read    value=</span><span class="si">${</span><span class="nv">rsect</span><span class="si">}</span><span class="s2"> </span><span class="si">${</span><span class="nv">ts</span><span class="si">}</span><span class="s2">"</span>
</span><span id="__span-6-222"><a id="__codelineno-6-222" name="__codelineno-6-222"></a><span class="w">          </span>store_line<span class="w"> </span><span class="s2">"diskstats,host=</span><span class="si">${</span><span class="nv">host</span><span class="si">}</span><span class="s2">,device=</span><span class="si">${</span><span class="nv">disk</span><span class="si">}</span><span class="s2">,metric=bytes_written value=</span><span class="si">${</span><span class="nv">wsect</span><span class="si">}</span><span class="s2"> </span><span class="si">${</span><span class="nv">ts</span><span class="si">}</span><span class="s2">"</span>
</span><span id="__span-6-223"><a id="__codelineno-6-223" name="__codelineno-6-223"></a><span class="w">          </span><span class="c1"># Successful I/O ops.</span>
</span><span id="__span-6-224"><a id="__codelineno-6-224" name="__codelineno-6-224"></a><span class="w">          </span><span class="nv">reads</span><span class="o">=</span><span class="k">$((</span><span class="nv">reads1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nv">reads0</span><span class="k">))</span>
</span><span id="__span-6-225"><a id="__codelineno-6-225" name="__codelineno-6-225"></a><span class="w">          </span><span class="nv">writs</span><span class="o">=</span><span class="k">$((</span><span class="nv">writs1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nv">writs0</span><span class="k">))</span>
</span><span id="__span-6-226"><a id="__codelineno-6-226" name="__codelineno-6-226"></a><span class="w">          </span>store_line<span class="w"> </span><span class="s2">"diskstats,host=</span><span class="si">${</span><span class="nv">host</span><span class="si">}</span><span class="s2">,device=</span><span class="si">${</span><span class="nv">disk</span><span class="si">}</span><span class="s2">,metric=successful_reads  value=</span><span class="si">${</span><span class="nv">reads</span><span class="si">}</span><span class="s2"> </span><span class="si">${</span><span class="nv">ts</span><span class="si">}</span><span class="s2">"</span>
</span><span id="__span-6-227"><a id="__codelineno-6-227" name="__codelineno-6-227"></a><span class="w">          </span>store_line<span class="w"> </span><span class="s2">"diskstats,host=</span><span class="si">${</span><span class="nv">host</span><span class="si">}</span><span class="s2">,device=</span><span class="si">${</span><span class="nv">disk</span><span class="si">}</span><span class="s2">,metric=successful_writes value=</span><span class="si">${</span><span class="nv">writs</span><span class="si">}</span><span class="s2"> </span><span class="si">${</span><span class="nv">ts</span><span class="si">}</span><span class="s2">"</span>
</span><span id="__span-6-228"><a id="__codelineno-6-228" name="__codelineno-6-228"></a><span class="w">          </span><span class="c1"># Time spent.</span>
</span><span id="__span-6-229"><a id="__codelineno-6-229" name="__codelineno-6-229"></a><span class="w">          </span><span class="nv">read_ms</span><span class="o">=</span><span class="k">$((</span><span class="nv">rtime1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nv">rtime0</span><span class="k">))</span>
</span><span id="__span-6-230"><a id="__codelineno-6-230" name="__codelineno-6-230"></a><span class="w">          </span><span class="nv">writ_ms</span><span class="o">=</span><span class="k">$((</span><span class="nv">wtime1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nv">wtime0</span><span class="k">))</span>
</span><span id="__span-6-231"><a id="__codelineno-6-231" name="__codelineno-6-231"></a><span class="w">          </span>store_line<span class="w"> </span><span class="s2">"diskstats,host=</span><span class="si">${</span><span class="nv">host</span><span class="si">}</span><span class="s2">,device=</span><span class="si">${</span><span class="nv">disk</span><span class="si">}</span><span class="s2">,metric=time_spent_reads  value=</span><span class="si">${</span><span class="nv">read_ms</span><span class="si">}</span><span class="s2"> </span><span class="si">${</span><span class="nv">ts</span><span class="si">}</span><span class="s2">"</span>
</span><span id="__span-6-232"><a id="__codelineno-6-232" name="__codelineno-6-232"></a><span class="w">          </span>store_line<span class="w"> </span><span class="s2">"diskstats,host=</span><span class="si">${</span><span class="nv">host</span><span class="si">}</span><span class="s2">,device=</span><span class="si">${</span><span class="nv">disk</span><span class="si">}</span><span class="s2">,metric=time_spent_writes value=</span><span class="si">${</span><span class="nv">writ_ms</span><span class="si">}</span><span class="s2"> </span><span class="si">${</span><span class="nv">ts</span><span class="si">}</span><span class="s2">"</span>
</span><span id="__span-6-233"><a id="__codelineno-6-233" name="__codelineno-6-233"></a><span class="w">        </span><span class="k">fi</span>
</span><span id="__span-6-234"><a id="__codelineno-6-234" name="__codelineno-6-234"></a><span class="w">      </span><span class="k">done</span>
</span><span id="__span-6-235"><a id="__codelineno-6-235" name="__codelineno-6-235"></a><span class="w">  </span><span class="k">fi</span>
</span><span id="__span-6-236"><a id="__codelineno-6-236" name="__codelineno-6-236"></a><span class="w">  </span>mv<span class="w"> </span><span class="s2">"</span><span class="si">${</span><span class="nv">DDIR</span><span class="si">}</span><span class="s2">/disk1"</span><span class="w"> </span><span class="s2">"</span><span class="si">${</span><span class="nv">DDIR</span><span class="si">}</span><span class="s2">/disk0"</span>
</span><span id="__span-6-237"><a id="__codelineno-6-237" name="__codelineno-6-237"></a><span class="o">}</span>
</span><span id="__span-6-238"><a id="__codelineno-6-238" name="__codelineno-6-238"></a>
</span><span id="__span-6-239"><a id="__codelineno-6-239" name="__codelineno-6-239"></a>bytes_from_value_and_units<span class="o">()</span><span class="w"> </span><span class="o">{</span>
</span><span id="__span-6-240"><a id="__codelineno-6-240" name="__codelineno-6-240"></a><span class="w">  </span><span class="nv">value</span><span class="o">=</span><span class="nv">$1</span>
</span><span id="__span-6-241"><a id="__codelineno-6-241" name="__codelineno-6-241"></a><span class="w">  </span><span class="nv">units</span><span class="o">=</span><span class="nv">$2</span>
</span><span id="__span-6-242"><a id="__codelineno-6-242" name="__codelineno-6-242"></a><span class="w">  </span><span class="nv">factor</span><span class="o">=</span><span class="m">1</span>
</span><span id="__span-6-243"><a id="__codelineno-6-243" name="__codelineno-6-243"></a><span class="w">  </span><span class="k">case</span><span class="w"> </span><span class="s2">"</span><span class="si">${</span><span class="nv">units</span><span class="si">}</span><span class="s2">"</span><span class="w"> </span><span class="k">in</span>
</span><span id="__span-6-244"><a id="__codelineno-6-244" name="__codelineno-6-244"></a><span class="w">  </span><span class="s2">"K/s"</span><span class="o">)</span>
</span><span id="__span-6-245"><a id="__codelineno-6-245" name="__codelineno-6-245"></a><span class="w">    </span><span class="nv">factor</span><span class="o">=</span><span class="m">1024</span>
</span><span id="__span-6-246"><a id="__codelineno-6-246" name="__codelineno-6-246"></a><span class="w">    </span><span class="p">;;</span>
</span><span id="__span-6-247"><a id="__codelineno-6-247" name="__codelineno-6-247"></a><span class="w">  </span><span class="s2">"M/s"</span><span class="o">)</span>
</span><span id="__span-6-248"><a id="__codelineno-6-248" name="__codelineno-6-248"></a><span class="w">    </span><span class="nv">factor</span><span class="o">=</span><span class="m">1024</span>*1024
</span><span id="__span-6-249"><a id="__codelineno-6-249" name="__codelineno-6-249"></a><span class="w">    </span><span class="p">;;</span>
</span><span id="__span-6-250"><a id="__codelineno-6-250" name="__codelineno-6-250"></a><span class="w">  </span><span class="s2">"G/s"</span><span class="o">)</span>
</span><span id="__span-6-251"><a id="__codelineno-6-251" name="__codelineno-6-251"></a><span class="w">    </span><span class="nv">factor</span><span class="o">=</span><span class="m">1024</span>*1024*1024
</span><span id="__span-6-252"><a id="__codelineno-6-252" name="__codelineno-6-252"></a><span class="w">    </span><span class="p">;;</span>
</span><span id="__span-6-253"><a id="__codelineno-6-253" name="__codelineno-6-253"></a><span class="w">  </span><span class="s2">"T/s"</span><span class="o">)</span>
</span><span id="__span-6-254"><a id="__codelineno-6-254" name="__codelineno-6-254"></a><span class="w">    </span><span class="nv">factor</span><span class="o">=</span><span class="m">1024</span>*1024*1024*1024
</span><span id="__span-6-255"><a id="__codelineno-6-255" name="__codelineno-6-255"></a><span class="w">    </span><span class="p">;;</span>
</span><span id="__span-6-256"><a id="__codelineno-6-256" name="__codelineno-6-256"></a><span class="w">  </span><span class="k">esac</span>
</span><span id="__span-6-257"><a id="__codelineno-6-257" name="__codelineno-6-257"></a><span class="w">  </span>bc<span class="w"> </span>-ql<span class="w"> </span><span class="o">&lt;&lt;&lt;</span><span class="s2">"</span><span class="si">${</span><span class="nv">factor</span><span class="si">}</span><span class="s2"> * </span><span class="si">${</span><span class="nv">value</span><span class="si">}</span><span class="s2">"</span>
</span><span id="__span-6-258"><a id="__codelineno-6-258" name="__codelineno-6-258"></a><span class="o">}</span>
</span><span id="__span-6-259"><a id="__codelineno-6-259" name="__codelineno-6-259"></a>
</span><span id="__span-6-260"><a id="__codelineno-6-260" name="__codelineno-6-260"></a>report_iotop<span class="o">()</span><span class="w"> </span><span class="o">{</span>
</span><span id="__span-6-261"><a id="__codelineno-6-261" name="__codelineno-6-261"></a><span class="w">  </span><span class="c1"># I/O stats from iotop (per process).</span>
</span><span id="__span-6-262"><a id="__codelineno-6-262" name="__codelineno-6-262"></a><span class="w">  </span><span class="c1"># Depends on: iotop (as root).</span>
</span><span id="__span-6-263"><a id="__codelineno-6-263" name="__codelineno-6-263"></a><span class="w">  </span><span class="nv">iotop</span><span class="o">=</span><span class="k">$(</span><span class="nb">command</span><span class="w"> </span>-v<span class="w"> </span>iotop<span class="k">)</span>
</span><span id="__span-6-264"><a id="__codelineno-6-264" name="__codelineno-6-264"></a><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span>-z<span class="w"> </span><span class="nv">$iotop</span><span class="w"> </span><span class="o">]</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="o">[</span><span class="w"> </span>!<span class="w"> </span>-f<span class="w"> </span><span class="nv">$iotop</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
</span><span id="__span-6-265"><a id="__codelineno-6-265" name="__codelineno-6-265"></a><span class="w">    </span><span class="k">return</span>
</span><span id="__span-6-266"><a id="__codelineno-6-266" name="__codelineno-6-266"></a><span class="w">  </span><span class="k">fi</span>
</span><span id="__span-6-267"><a id="__codelineno-6-267" name="__codelineno-6-267"></a><span class="w">  </span><span class="nv">ts</span><span class="o">=</span><span class="k">$(</span>timestamp_ns<span class="k">)</span>
</span><span id="__span-6-268"><a id="__codelineno-6-268" name="__codelineno-6-268"></a><span class="w">  </span><span class="nv">iotop_stats</span><span class="o">=</span><span class="nv">$DDIR</span>/iotop
</span><span id="__span-6-269"><a id="__codelineno-6-269" name="__codelineno-6-269"></a><span class="w">  </span><span class="c1"># The Linux kernel interfaces that iotop relies on now require root</span>
</span><span id="__span-6-270"><a id="__codelineno-6-270" name="__codelineno-6-270"></a><span class="w">  </span><span class="c1"># privileges or the NET_ADMIN capability. This change occurred because a</span>
</span><span id="__span-6-271"><a id="__codelineno-6-271" name="__codelineno-6-271"></a><span class="w">  </span><span class="c1"># security issue (CVE-2011-2494) was found that allows leakage of sensitive</span>
</span><span id="__span-6-272"><a id="__codelineno-6-272" name="__codelineno-6-272"></a><span class="w">  </span><span class="c1"># data across user boundaries. If you require the ability to run iotop as a</span>
</span><span id="__span-6-273"><a id="__codelineno-6-273" name="__codelineno-6-273"></a><span class="w">  </span><span class="c1"># non-root user, please configure sudo to allow you to run iotop as root.</span>
</span><span id="__span-6-274"><a id="__codelineno-6-274" name="__codelineno-6-274"></a><span class="w">  </span>sudo<span class="w"> </span><span class="nv">$iotop</span><span class="w"> </span>-b<span class="w"> </span>-P<span class="w"> </span>-n<span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="p">|</span>
</span><span id="__span-6-275"><a id="__codelineno-6-275" name="__codelineno-6-275"></a><span class="w">    </span>grep<span class="w"> </span>-Ev<span class="w"> </span><span class="s1">'task_delayacct|locale|DISK READ|0.00 B/s    0.00 B/s'</span><span class="w"> </span><span class="p">|</span>
</span><span id="__span-6-276"><a id="__codelineno-6-276" name="__codelineno-6-276"></a><span class="w">    </span>tr<span class="w"> </span>-d<span class="w"> </span><span class="s1">'['</span><span class="w"> </span><span class="p">|</span>
</span><span id="__span-6-277"><a id="__codelineno-6-277" name="__codelineno-6-277"></a><span class="w">    </span>tr<span class="w"> </span>-d<span class="w"> </span><span class="s1">']'</span><span class="w"> </span><span class="p">|</span>
</span><span id="__span-6-278"><a id="__codelineno-6-278" name="__codelineno-6-278"></a><span class="w">    </span>sed<span class="w"> </span><span class="s1">'s/kworker\///'</span><span class="w"> </span><span class="p">|</span>
</span><span id="__span-6-279"><a id="__codelineno-6-279" name="__codelineno-6-279"></a><span class="w">    </span>sed<span class="w"> </span><span class="s1">'s/u64:[0-9]\+-//'</span><span class="w"> </span><span class="p">|</span>
</span><span id="__span-6-280"><a id="__codelineno-6-280" name="__codelineno-6-280"></a><span class="w">    </span>awk<span class="w"> </span><span class="s1">'{print $4,$5,$6,$7,$9}'</span><span class="w"> </span><span class="se">\</span>
</span><span id="__span-6-281"><a id="__codelineno-6-281" name="__codelineno-6-281"></a><span class="w">      </span>&gt;<span class="s2">"</span><span class="si">${</span><span class="nv">iotop_stats</span><span class="si">}</span><span class="s2">"</span>
</span><span id="__span-6-282"><a id="__codelineno-6-282" name="__codelineno-6-282"></a><span class="w">  </span><span class="c1"># Return if iotop could not be run successfully.</span>
</span><span id="__span-6-283"><a id="__codelineno-6-283" name="__codelineno-6-283"></a><span class="w">  </span><span class="c1"># This is typically caused by 'Netlink error: Operation not permitted'.</span>
</span><span id="__span-6-284"><a id="__codelineno-6-284" name="__codelineno-6-284"></a><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="o">[[</span><span class="w"> </span><span class="nv">$?</span><span class="w"> </span>-gt<span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="o">]]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
</span><span id="__span-6-285"><a id="__codelineno-6-285" name="__codelineno-6-285"></a><span class="w">    </span><span class="k">return</span>
</span><span id="__span-6-286"><a id="__codelineno-6-286" name="__codelineno-6-286"></a><span class="w">  </span><span class="k">fi</span>
</span><span id="__span-6-287"><a id="__codelineno-6-287" name="__codelineno-6-287"></a><span class="w">  </span><span class="c1"># Report I/O stats for each process.</span>
</span><span id="__span-6-288"><a id="__codelineno-6-288" name="__codelineno-6-288"></a><span class="w">  </span><span class="c1"># Note: this aggregates I/O per process name (basename), across all PIDs.</span>
</span><span id="__span-6-289"><a id="__codelineno-6-289" name="__codelineno-6-289"></a><span class="w">  </span>cat<span class="w"> </span><span class="s2">"</span><span class="si">${</span><span class="nv">iotop_stats</span><span class="si">}</span><span class="s2">"</span><span class="w"> </span><span class="p">|</span>
</span><span id="__span-6-290"><a id="__codelineno-6-290" name="__codelineno-6-290"></a><span class="w">    </span>cut<span class="w"> </span>-f5<span class="w"> </span>-d<span class="s1">' '</span><span class="w"> </span><span class="p">|</span>
</span><span id="__span-6-291"><a id="__codelineno-6-291" name="__codelineno-6-291"></a><span class="w">    </span>sort<span class="w"> </span>-u<span class="w"> </span><span class="p">|</span>
</span><span id="__span-6-292"><a id="__codelineno-6-292" name="__codelineno-6-292"></a><span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="nb">read</span><span class="w"> </span>-r<span class="w"> </span>process<span class="p">;</span><span class="w"> </span><span class="k">do</span>
</span><span id="__span-6-293"><a id="__codelineno-6-293" name="__codelineno-6-293"></a><span class="w">      </span><span class="nv">process_read</span><span class="o">=</span><span class="m">0</span>
</span><span id="__span-6-294"><a id="__codelineno-6-294" name="__codelineno-6-294"></a><span class="w">      </span><span class="nv">process_write</span><span class="o">=</span><span class="m">0</span>
</span><span id="__span-6-295"><a id="__codelineno-6-295" name="__codelineno-6-295"></a><span class="w">      </span><span class="k">while</span><span class="w"> </span><span class="nb">read</span><span class="w"> </span>-r<span class="w"> </span>line<span class="p">;</span><span class="w"> </span><span class="k">do</span>
</span><span id="__span-6-296"><a id="__codelineno-6-296" name="__codelineno-6-296"></a><span class="w">        </span><span class="nv">read_value</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span><span class="w"> </span><span class="s2">"</span><span class="si">${</span><span class="nv">line</span><span class="si">}</span><span class="s2">"</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>cut<span class="w"> </span>-f1<span class="w"> </span>-d<span class="s1">' '</span><span class="k">)</span>
</span><span id="__span-6-297"><a id="__codelineno-6-297" name="__codelineno-6-297"></a><span class="w">        </span><span class="nv">read_units</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span><span class="w"> </span><span class="s2">"</span><span class="si">${</span><span class="nv">line</span><span class="si">}</span><span class="s2">"</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>cut<span class="w"> </span>-f2<span class="w"> </span>-d<span class="s1">' '</span><span class="k">)</span>
</span><span id="__span-6-298"><a id="__codelineno-6-298" name="__codelineno-6-298"></a><span class="w">        </span><span class="nv">read_bytes</span><span class="o">=</span><span class="k">$(</span>bytes_from_value_and_units<span class="w"> </span><span class="s2">"</span><span class="si">${</span><span class="nv">read_value</span><span class="si">}</span><span class="s2">"</span><span class="w"> </span><span class="s2">"</span><span class="si">${</span><span class="nv">read_units</span><span class="si">}</span><span class="s2">"</span><span class="k">)</span>
</span><span id="__span-6-299"><a id="__codelineno-6-299" name="__codelineno-6-299"></a><span class="w">        </span><span class="nv">process_read</span><span class="o">=</span><span class="k">$(</span>bc<span class="w"> </span>-ql<span class="w"> </span><span class="o">&lt;&lt;&lt;</span><span class="s2">"</span><span class="si">${</span><span class="nv">process_read</span><span class="si">}</span><span class="s2">+</span><span class="si">${</span><span class="nv">read_bytes</span><span class="si">}</span><span class="s2">"</span><span class="k">)</span>
</span><span id="__span-6-300"><a id="__codelineno-6-300" name="__codelineno-6-300"></a><span class="w">        </span><span class="nv">write_value</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span><span class="w"> </span><span class="s2">"</span><span class="si">${</span><span class="nv">line</span><span class="si">}</span><span class="s2">"</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>cut<span class="w"> </span>-f3<span class="w"> </span>-d<span class="s1">' '</span><span class="k">)</span>
</span><span id="__span-6-301"><a id="__codelineno-6-301" name="__codelineno-6-301"></a><span class="w">        </span><span class="nv">write_units</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span><span class="w"> </span><span class="s2">"</span><span class="si">${</span><span class="nv">line</span><span class="si">}</span><span class="s2">"</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>cut<span class="w"> </span>-f4<span class="w"> </span>-d<span class="s1">' '</span><span class="k">)</span>
</span><span id="__span-6-302"><a id="__codelineno-6-302" name="__codelineno-6-302"></a><span class="w">        </span><span class="nv">write_bytes</span><span class="o">=</span><span class="k">$(</span>bytes_from_value_and_units<span class="w"> </span><span class="s2">"</span><span class="si">${</span><span class="nv">write_value</span><span class="si">}</span><span class="s2">"</span><span class="w"> </span><span class="s2">"</span><span class="si">${</span><span class="nv">write_units</span><span class="si">}</span><span class="s2">"</span><span class="k">)</span>
</span><span id="__span-6-303"><a id="__codelineno-6-303" name="__codelineno-6-303"></a><span class="w">        </span><span class="nv">process_write</span><span class="o">=</span><span class="k">$(</span>bc<span class="w"> </span>-ql<span class="w"> </span><span class="o">&lt;&lt;&lt;</span><span class="s2">"</span><span class="si">${</span><span class="nv">process_write</span><span class="si">}</span><span class="s2">+</span><span class="si">${</span><span class="nv">write_bytes</span><span class="si">}</span><span class="s2">"</span><span class="k">)</span>
</span><span id="__span-6-304"><a id="__codelineno-6-304" name="__codelineno-6-304"></a><span class="w">      </span><span class="k">done</span><span class="w"> </span>&lt;<span class="w"> </span>&lt;<span class="o">(</span>grep<span class="w"> </span><span class="s2">" </span><span class="si">${</span><span class="nv">process</span><span class="si">}</span><span class="s2">\$"</span><span class="w"> </span><span class="s2">"</span><span class="si">${</span><span class="nv">iotop_stats</span><span class="si">}</span><span class="s2">"</span><span class="o">)</span>
</span><span id="__span-6-305"><a id="__codelineno-6-305" name="__codelineno-6-305"></a><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="o">[[</span><span class="w"> </span><span class="k">$(</span><span class="nb">echo</span><span class="w"> </span><span class="s2">"</span><span class="si">${</span><span class="nv">process_read</span><span class="si">}</span><span class="s2">"</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>sed<span class="w"> </span><span class="s1">'s/\..*//'</span><span class="k">)</span><span class="w"> </span>-gt<span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="o">]]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
</span><span id="__span-6-306"><a id="__codelineno-6-306" name="__codelineno-6-306"></a><span class="w">        </span>store_line<span class="w"> </span><span class="s2">"iotop,host=</span><span class="si">${</span><span class="nv">host</span><span class="si">}</span><span class="s2">,command=</span><span class="si">${</span><span class="nv">process</span><span class="si">}</span><span class="s2">,metric=read value=</span><span class="si">${</span><span class="nv">process_read</span><span class="si">}</span><span class="s2"> </span><span class="si">${</span><span class="nv">ts</span><span class="si">}</span><span class="s2">"</span>
</span><span id="__span-6-307"><a id="__codelineno-6-307" name="__codelineno-6-307"></a><span class="w">      </span><span class="k">fi</span>
</span><span id="__span-6-308"><a id="__codelineno-6-308" name="__codelineno-6-308"></a><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="o">[[</span><span class="w"> </span><span class="s2">"</span><span class="k">$(</span><span class="nb">echo</span><span class="w"> </span><span class="s2">"</span><span class="si">${</span><span class="nv">process_write</span><span class="si">}</span><span class="s2">"</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>sed<span class="w"> </span><span class="s1">'s/\..*//'</span><span class="k">)</span><span class="s2">"</span><span class="w"> </span>-gt<span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="o">]]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
</span><span id="__span-6-309"><a id="__codelineno-6-309" name="__codelineno-6-309"></a><span class="w">        </span>store_line<span class="w"> </span><span class="s2">"iotop,host=</span><span class="si">${</span><span class="nv">host</span><span class="si">}</span><span class="s2">,command=</span><span class="si">${</span><span class="nv">process</span><span class="si">}</span><span class="s2">,metric=write value=</span><span class="si">${</span><span class="nv">process_write</span><span class="si">}</span><span class="s2"> </span><span class="si">${</span><span class="nv">ts</span><span class="si">}</span><span class="s2">"</span>
</span><span id="__span-6-310"><a id="__codelineno-6-310" name="__codelineno-6-310"></a><span class="w">      </span><span class="k">fi</span>
</span><span id="__span-6-311"><a id="__codelineno-6-311" name="__codelineno-6-311"></a><span class="w">    </span><span class="k">done</span>
</span><span id="__span-6-312"><a id="__codelineno-6-312" name="__codelineno-6-312"></a><span class="o">}</span>
</span><span id="__span-6-313"><a id="__codelineno-6-313" name="__codelineno-6-313"></a>
</span><span id="__span-6-314"><a id="__codelineno-6-314" name="__codelineno-6-314"></a>report_net_dev<span class="o">()</span><span class="w"> </span><span class="o">{</span>
</span><span id="__span-6-315"><a id="__codelineno-6-315" name="__codelineno-6-315"></a><span class="w">  </span><span class="c1"># Network I/O stats from /proc/net/dev.</span>
</span><span id="__span-6-316"><a id="__codelineno-6-316" name="__codelineno-6-316"></a><span class="w">  </span><span class="c1"># Depends on: /proc/net/dev.</span>
</span><span id="__span-6-317"><a id="__codelineno-6-317" name="__codelineno-6-317"></a><span class="w">  </span><span class="nv">ts</span><span class="o">=</span><span class="k">$(</span>timestamp_ns<span class="k">)</span>
</span><span id="__span-6-318"><a id="__codelineno-6-318" name="__codelineno-6-318"></a><span class="w">  </span>grep<span class="w"> </span>-Ev<span class="w"> </span><span class="s1">'Inter|face'</span><span class="w"> </span>/proc/net/dev<span class="w"> </span><span class="p">|</span><span class="w"> </span>tr<span class="w"> </span>-d<span class="w"> </span><span class="s1">':'</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>awk<span class="w"> </span><span class="s1">'{print $1,$2,$10}'</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>sort<span class="w"> </span>&gt;<span class="s2">"</span><span class="si">${</span><span class="nv">DDIR</span><span class="si">}</span><span class="s2">/net1"</span>
</span><span id="__span-6-319"><a id="__codelineno-6-319" name="__codelineno-6-319"></a><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="o">[[</span><span class="w"> </span>-f<span class="w"> </span><span class="s2">"</span><span class="si">${</span><span class="nv">DDIR</span><span class="si">}</span><span class="s2">/net0"</span><span class="w"> </span><span class="o">]]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
</span><span id="__span-6-320"><a id="__codelineno-6-320" name="__codelineno-6-320"></a><span class="w">    </span><span class="nv">ts0</span><span class="o">=</span><span class="k">$(</span>cat<span class="w"> </span><span class="s2">"</span><span class="si">${</span><span class="nv">DDIR</span><span class="si">}</span><span class="s2">/net0-ts"</span><span class="k">)</span>
</span><span id="__span-6-321"><a id="__codelineno-6-321" name="__codelineno-6-321"></a><span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">"</span><span class="si">${</span><span class="nv">ts</span><span class="si">}</span><span class="s2">"</span><span class="w"> </span>&gt;<span class="s2">"</span><span class="si">${</span><span class="nv">DDIR</span><span class="si">}</span><span class="s2">/net1-ts"</span>
</span><span id="__span-6-322"><a id="__codelineno-6-322" name="__codelineno-6-322"></a><span class="w">    </span>paste<span class="w"> </span><span class="s2">"</span><span class="si">${</span><span class="nv">DDIR</span><span class="si">}</span><span class="s2">/net0"</span><span class="w"> </span><span class="s2">"</span><span class="si">${</span><span class="nv">DDIR</span><span class="si">}</span><span class="s2">/net1"</span><span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="k">while</span><span class="w"> </span><span class="nb">read</span><span class="w"> </span>-r<span class="w"> </span>dev0<span class="w"> </span>rx0<span class="w"> </span>tx0<span class="w"> </span>dev1<span class="w"> </span>rx1<span class="w"> </span>tx1<span class="p">;</span><span class="w"> </span><span class="k">do</span>
</span><span id="__span-6-323"><a id="__codelineno-6-323" name="__codelineno-6-323"></a><span class="w">      </span><span class="c1"># Skip momentary inconsistencies when devs are added or removed.</span>
</span><span id="__span-6-324"><a id="__codelineno-6-324" name="__codelineno-6-324"></a><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="o">[[</span><span class="w"> </span><span class="s2">"</span><span class="si">${</span><span class="nv">dev0</span><span class="si">}</span><span class="s2">"</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">"</span><span class="si">${</span><span class="nv">dev1</span><span class="si">}</span><span class="s2">"</span><span class="w"> </span><span class="o">]]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
</span><span id="__span-6-325"><a id="__codelineno-6-325" name="__codelineno-6-325"></a><span class="w">        </span><span class="c1"># Compute rx/tx bytes / sec (ts is in nanoseconds).</span>
</span><span id="__span-6-326"><a id="__codelineno-6-326" name="__codelineno-6-326"></a><span class="w">        </span><span class="nv">rx</span><span class="o">=</span><span class="k">$(</span>bc<span class="w"> </span>-ql<span class="w"> </span><span class="o">&lt;&lt;&lt;</span><span class="s2">"1000000000 * (</span><span class="si">${</span><span class="nv">rx1</span><span class="si">}</span><span class="s2"> - </span><span class="si">${</span><span class="nv">rx0</span><span class="si">}</span><span class="s2">) / (</span><span class="si">${</span><span class="nv">ts</span><span class="si">}</span><span class="s2"> - </span><span class="si">${</span><span class="nv">ts0</span><span class="si">}</span><span class="s2">)"</span><span class="k">)</span>
</span><span id="__span-6-327"><a id="__codelineno-6-327" name="__codelineno-6-327"></a><span class="w">        </span><span class="nv">tx</span><span class="o">=</span><span class="k">$(</span>bc<span class="w"> </span>-ql<span class="w"> </span><span class="o">&lt;&lt;&lt;</span><span class="s2">"1000000000 * (</span><span class="si">${</span><span class="nv">tx1</span><span class="si">}</span><span class="s2"> - </span><span class="si">${</span><span class="nv">tx0</span><span class="si">}</span><span class="s2">) / (</span><span class="si">${</span><span class="nv">ts</span><span class="si">}</span><span class="s2"> - </span><span class="si">${</span><span class="nv">ts0</span><span class="si">}</span><span class="s2">)"</span><span class="k">)</span>
</span><span id="__span-6-328"><a id="__codelineno-6-328" name="__codelineno-6-328"></a><span class="w">        </span>store_line<span class="w"> </span><span class="s2">"net_dev,host=</span><span class="si">${</span><span class="nv">host</span><span class="si">}</span><span class="s2">,device=</span><span class="si">${</span><span class="nv">dev0</span><span class="si">}</span><span class="s2">,metric=rx value=</span><span class="si">${</span><span class="nv">rx</span><span class="si">}</span><span class="s2"> </span><span class="si">${</span><span class="nv">ts</span><span class="si">}</span><span class="s2">"</span>
</span><span id="__span-6-329"><a id="__codelineno-6-329" name="__codelineno-6-329"></a><span class="w">        </span>store_line<span class="w"> </span><span class="s2">"net_dev,host=</span><span class="si">${</span><span class="nv">host</span><span class="si">}</span><span class="s2">,device=</span><span class="si">${</span><span class="nv">dev0</span><span class="si">}</span><span class="s2">,metric=tx value=</span><span class="si">${</span><span class="nv">tx</span><span class="si">}</span><span class="s2"> </span><span class="si">${</span><span class="nv">ts</span><span class="si">}</span><span class="s2">"</span>
</span><span id="__span-6-330"><a id="__codelineno-6-330" name="__codelineno-6-330"></a><span class="w">      </span><span class="k">fi</span>
</span><span id="__span-6-331"><a id="__codelineno-6-331" name="__codelineno-6-331"></a><span class="w">    </span><span class="k">done</span>
</span><span id="__span-6-332"><a id="__codelineno-6-332" name="__codelineno-6-332"></a><span class="w">  </span><span class="k">fi</span>
</span><span id="__span-6-333"><a id="__codelineno-6-333" name="__codelineno-6-333"></a><span class="w">  </span>mv<span class="w"> </span><span class="s2">"</span><span class="si">${</span><span class="nv">DDIR</span><span class="si">}</span><span class="s2">/net1"</span><span class="w"> </span><span class="s2">"</span><span class="si">${</span><span class="nv">DDIR</span><span class="si">}</span><span class="s2">/net0"</span>
</span><span id="__span-6-334"><a id="__codelineno-6-334" name="__codelineno-6-334"></a><span class="w">  </span>mv<span class="w"> </span><span class="s2">"</span><span class="si">${</span><span class="nv">DDIR</span><span class="si">}</span><span class="s2">/net1-ts"</span><span class="w"> </span><span class="s2">"</span><span class="si">${</span><span class="nv">DDIR</span><span class="si">}</span><span class="s2">/net0-ts"</span>
</span><span id="__span-6-335"><a id="__codelineno-6-335" name="__codelineno-6-335"></a><span class="o">}</span>
</span><span id="__span-6-336"><a id="__codelineno-6-336" name="__codelineno-6-336"></a>
</span><span id="__span-6-337"><a id="__codelineno-6-337" name="__codelineno-6-337"></a>report_du<span class="o">()</span><span class="w"> </span><span class="o">{</span>
</span><span id="__span-6-338"><a id="__codelineno-6-338" name="__codelineno-6-338"></a><span class="w">  </span><span class="c1"># Disk usage stats from du.</span>
</span><span id="__span-6-339"><a id="__codelineno-6-339" name="__codelineno-6-339"></a><span class="w">  </span><span class="c1"># Files and directories to monitor in /etc/conmon/du</span>
</span><span id="__span-6-340"><a id="__codelineno-6-340" name="__codelineno-6-340"></a><span class="w">  </span><span class="c1"># Depends on du (as root).</span>
</span><span id="__span-6-341"><a id="__codelineno-6-341" name="__codelineno-6-341"></a><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span>-z<span class="w"> </span>/etc/conmon/du<span class="w"> </span><span class="o">]</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="o">[</span><span class="w"> </span>!<span class="w"> </span>-f<span class="w"> </span>$/etc/conmon/du<span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
</span><span id="__span-6-342"><a id="__codelineno-6-342" name="__codelineno-6-342"></a><span class="w">    </span><span class="k">return</span>
</span><span id="__span-6-343"><a id="__codelineno-6-343" name="__codelineno-6-343"></a><span class="w">  </span><span class="k">fi</span>
</span><span id="__span-6-344"><a id="__codelineno-6-344" name="__codelineno-6-344"></a><span class="w">  </span><span class="nv">ts</span><span class="o">=</span><span class="k">$(</span>timestamp_ns<span class="k">)</span>
</span><span id="__span-6-345"><a id="__codelineno-6-345" name="__codelineno-6-345"></a><span class="w">  </span><span class="k">while</span><span class="w"> </span><span class="nb">read</span><span class="w"> </span>-r<span class="w"> </span>path<span class="w"> </span>&lt;/etc/conmon/du<span class="p">;</span><span class="w"> </span><span class="k">do</span>
</span><span id="__span-6-346"><a id="__codelineno-6-346" name="__codelineno-6-346"></a><span class="w">    </span><span class="nv">kbytes</span><span class="o">=</span><span class="k">$(</span>sudo<span class="w"> </span>du<span class="w"> </span>-s<span class="w"> </span><span class="s2">"</span><span class="si">${</span><span class="nv">path</span><span class="si">}</span><span class="s2">"</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>awk<span class="w"> </span><span class="s1">'{print $1}'</span><span class="k">)</span>
</span><span id="__span-6-347"><a id="__codelineno-6-347" name="__codelineno-6-347"></a><span class="w">    </span><span class="nv">bytes</span><span class="o">=</span><span class="k">$((</span><span class="m">1024</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nv">kbytes</span><span class="k">))</span>
</span><span id="__span-6-348"><a id="__codelineno-6-348" name="__codelineno-6-348"></a><span class="w">    </span>store_line<span class="w"> </span><span class="s2">"du,host=</span><span class="si">${</span><span class="nv">host</span><span class="si">}</span><span class="s2">,path=</span><span class="si">${</span><span class="nv">path</span><span class="si">}</span><span class="s2"> value=</span><span class="si">${</span><span class="nv">bytes</span><span class="si">}</span><span class="s2"> </span><span class="si">${</span><span class="nv">ts</span><span class="si">}</span><span class="s2">"</span>
</span><span id="__span-6-349"><a id="__codelineno-6-349" name="__codelineno-6-349"></a><span class="w">  </span><span class="k">done</span>
</span><span id="__span-6-350"><a id="__codelineno-6-350" name="__codelineno-6-350"></a><span class="o">}</span>
</span><span id="__span-6-351"><a id="__codelineno-6-351" name="__codelineno-6-351"></a>
</span><span id="__span-6-352"><a id="__codelineno-6-352" name="__codelineno-6-352"></a>post_lines_to_influxdb<span class="o">()</span><span class="w"> </span><span class="o">{</span>
</span><span id="__span-6-353"><a id="__codelineno-6-353" name="__codelineno-6-353"></a><span class="w">  </span><span class="c1"># POST data to InfluxDB in batch, when target is available.</span>
</span><span id="__span-6-354"><a id="__codelineno-6-354" name="__codelineno-6-354"></a><span class="w">  </span><span class="c1"># Depends on: nc.</span>
</span><span id="__span-6-355"><a id="__codelineno-6-355" name="__codelineno-6-355"></a><span class="w">  </span><span class="c1"># All other tasks write data to the file in append mode (&gt;&gt;).</span>
</span><span id="__span-6-356"><a id="__codelineno-6-356" name="__codelineno-6-356"></a><span class="w">  </span><span class="c1"># This task reads everything at once and immediately deletes the file.</span>
</span><span id="__span-6-357"><a id="__codelineno-6-357" name="__codelineno-6-357"></a><span class="w">  </span><span class="c1"># This makes all the other tasks write to the same file, created anew.</span>
</span><span id="__span-6-358"><a id="__codelineno-6-358" name="__codelineno-6-358"></a><span class="w">  </span>sleep<span class="w"> </span><span class="si">${</span><span class="nv">DELAY_POST</span><span class="si">}</span>
</span><span id="__span-6-359"><a id="__codelineno-6-359" name="__codelineno-6-359"></a><span class="w">  </span>mv<span class="w"> </span>-f<span class="w"> </span><span class="s2">"</span><span class="si">${</span><span class="nv">DATA</span><span class="si">}</span><span class="s2">"</span><span class="w"> </span><span class="s2">"</span><span class="si">${</span><span class="nv">DATA</span><span class="si">}</span><span class="s2">.POST"</span>
</span><span id="__span-6-360"><a id="__codelineno-6-360" name="__codelineno-6-360"></a><span class="w">  </span><span class="c1"># Post over HTTP without auth.</span>
</span><span id="__span-6-361"><a id="__codelineno-6-361" name="__codelineno-6-361"></a><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span>-n<span class="w"> </span><span class="s2">"</span><span class="nv">$TARGET_HTTP</span><span class="s2">"</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
</span><span id="__span-6-362"><a id="__codelineno-6-362" name="__codelineno-6-362"></a><span class="w">    </span><span class="nv">host_and_port</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span><span class="w"> </span><span class="s2">"</span><span class="nv">$TARGET_HTTP</span><span class="s2">"</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>sed<span class="w"> </span><span class="s1">'s/.*\///'</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>tr<span class="w"> </span>:<span class="w"> </span><span class="s1">' '</span><span class="k">)</span>
</span><span id="__span-6-363"><a id="__codelineno-6-363" name="__codelineno-6-363"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span>nc<span class="w"> </span><span class="m">2</span>&gt;<span class="p">&amp;</span><span class="m">1</span><span class="w"> </span>-zv<span class="w"> </span><span class="nv">$host_and_port</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>-q<span class="w"> </span>succeeded<span class="p">;</span><span class="w"> </span><span class="k">then</span>
</span><span id="__span-6-364"><a id="__codelineno-6-364" name="__codelineno-6-364"></a><span class="w">      </span>curl<span class="w"> </span>&gt;/dev/null<span class="w"> </span><span class="m">2</span>&gt;/dev/null<span class="w"> </span><span class="se">\</span>
</span><span id="__span-6-365"><a id="__codelineno-6-365" name="__codelineno-6-365"></a><span class="w">        </span>-i<span class="w"> </span>-XPOST<span class="w"> </span><span class="s2">"</span><span class="si">${</span><span class="nv">TARGET_HTTP</span><span class="si">}</span><span class="s2">/write?db=</span><span class="si">${</span><span class="nv">DBNAME</span><span class="si">}</span><span class="s2">"</span><span class="w"> </span><span class="se">\</span>
</span><span id="__span-6-366"><a id="__codelineno-6-366" name="__codelineno-6-366"></a><span class="w">        </span>--data-binary<span class="w"> </span>@<span class="s2">"</span><span class="si">${</span><span class="nv">DATA</span><span class="si">}</span><span class="s2">.POST"</span>
</span><span id="__span-6-367"><a id="__codelineno-6-367" name="__codelineno-6-367"></a><span class="w">    </span><span class="k">fi</span>
</span><span id="__span-6-368"><a id="__codelineno-6-368" name="__codelineno-6-368"></a><span class="w">  </span><span class="k">fi</span>
</span><span id="__span-6-369"><a id="__codelineno-6-369" name="__codelineno-6-369"></a><span class="w">  </span><span class="c1"># Post over HTTPS with Basic Auth, provided credentials are</span>
</span><span id="__span-6-370"><a id="__codelineno-6-370" name="__codelineno-6-370"></a><span class="w">  </span><span class="c1"># found in /etc/conmon/influxdb-auth</span>
</span><span id="__span-6-371"><a id="__codelineno-6-371" name="__codelineno-6-371"></a><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span>-n<span class="w"> </span><span class="s2">"</span><span class="nv">$TARGET_HTTPS</span><span class="s2">"</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
</span><span id="__span-6-372"><a id="__codelineno-6-372" name="__codelineno-6-372"></a><span class="w">    </span><span class="nv">influxdb_auth</span><span class="o">=</span>/etc/conmon/influxdb-auth
</span><span id="__span-6-373"><a id="__codelineno-6-373" name="__codelineno-6-373"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span>-z<span class="w"> </span><span class="nv">$influxdb_auth</span><span class="w"> </span><span class="o">]</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="o">[</span><span class="w"> </span>!<span class="w"> </span>-f<span class="w"> </span><span class="nv">$influxdb_auth</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
</span><span id="__span-6-374"><a id="__codelineno-6-374" name="__codelineno-6-374"></a><span class="w">      </span><span class="k">return</span>
</span><span id="__span-6-375"><a id="__codelineno-6-375" name="__codelineno-6-375"></a><span class="w">    </span><span class="k">fi</span>
</span><span id="__span-6-376"><a id="__codelineno-6-376" name="__codelineno-6-376"></a><span class="w">    </span><span class="nv">host_and_port</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span><span class="w"> </span><span class="s2">"</span><span class="nv">$TARGET_HTTPS</span><span class="s2">"</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>sed<span class="w"> </span><span class="s1">'s/.*\///'</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>tr<span class="w"> </span>:<span class="w"> </span><span class="s1">' '</span><span class="k">)</span>
</span><span id="__span-6-377"><a id="__codelineno-6-377" name="__codelineno-6-377"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span>nc<span class="w"> </span><span class="m">2</span>&gt;<span class="p">&amp;</span><span class="m">1</span><span class="w"> </span>-zv<span class="w"> </span><span class="nv">$host_and_port</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>-q<span class="w"> </span>succeeded<span class="p">;</span><span class="w"> </span><span class="k">then</span>
</span><span id="__span-6-378"><a id="__codelineno-6-378" name="__codelineno-6-378"></a><span class="w">      </span>curl<span class="w"> </span>&gt;/dev/null<span class="w"> </span><span class="m">2</span>&gt;/dev/null<span class="w"> </span><span class="se">\</span>
</span><span id="__span-6-379"><a id="__codelineno-6-379" name="__codelineno-6-379"></a><span class="w">        </span>-u<span class="w"> </span><span class="k">$(</span>sudo<span class="w"> </span>cat<span class="w"> </span><span class="nv">$influxdb_auth</span><span class="k">)</span><span class="w"> </span><span class="se">\</span>
</span><span id="__span-6-380"><a id="__codelineno-6-380" name="__codelineno-6-380"></a><span class="w">        </span>-i<span class="w"> </span>-XPOST<span class="w"> </span><span class="s2">"</span><span class="si">${</span><span class="nv">TARGET_HTTPS</span><span class="si">}</span><span class="s2">/write?db=</span><span class="si">${</span><span class="nv">DBNAME</span><span class="si">}</span><span class="s2">"</span><span class="w"> </span><span class="se">\</span>
</span><span id="__span-6-381"><a id="__codelineno-6-381" name="__codelineno-6-381"></a><span class="w">        </span>--data-binary<span class="w"> </span>@<span class="s2">"</span><span class="si">${</span><span class="nv">DATA</span><span class="si">}</span><span class="s2">.POST"</span>
</span><span id="__span-6-382"><a id="__codelineno-6-382" name="__codelineno-6-382"></a><span class="w">    </span><span class="k">fi</span>
</span><span id="__span-6-383"><a id="__codelineno-6-383" name="__codelineno-6-383"></a><span class="w">  </span><span class="k">fi</span>
</span><span id="__span-6-384"><a id="__codelineno-6-384" name="__codelineno-6-384"></a><span class="o">}</span>
</span><span id="__span-6-385"><a id="__codelineno-6-385" name="__codelineno-6-385"></a>
</span><span id="__span-6-386"><a id="__codelineno-6-386" name="__codelineno-6-386"></a>pause_depending_on_rpi_model<span class="o">()</span><span class="w"> </span><span class="o">{</span>
</span><span id="__span-6-387"><a id="__codelineno-6-387" name="__codelineno-6-387"></a><span class="w">  </span><span class="c1"># Pause for a few seconds depending on which model of Raspberry Pi.</span>
</span><span id="__span-6-388"><a id="__codelineno-6-388" name="__codelineno-6-388"></a><span class="w">  </span><span class="c1"># The delay depends also on the system load as reported by top.</span>
</span><span id="__span-6-389"><a id="__codelineno-6-389" name="__codelineno-6-389"></a><span class="w">  </span><span class="c1"># Depends on: grep, /proc/cpu_info.</span>
</span><span id="__span-6-390"><a id="__codelineno-6-390" name="__codelineno-6-390"></a><span class="w">  </span><span class="nv">top_cmd</span><span class="o">=</span><span class="k">$(</span><span class="nb">command</span><span class="w"> </span>-v<span class="w"> </span>top<span class="k">)</span>
</span><span id="__span-6-391"><a id="__codelineno-6-391" name="__codelineno-6-391"></a><span class="w">  </span><span class="nv">load</span><span class="o">=</span><span class="k">$(</span><span class="si">${</span><span class="nv">top_cmd</span><span class="si">}</span><span class="w"> </span>-b<span class="w"> </span>-n<span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>head<span class="w"> </span>-1<span class="w"> </span><span class="p">|</span><span class="w"> </span>sed<span class="w"> </span><span class="s1">'s/.*load average: //'</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>cut<span class="w"> </span>-f1<span class="w"> </span>-d,<span class="w"> </span><span class="p">|</span><span class="w"> </span>tr<span class="w"> </span>-d<span class="w"> </span><span class="s1">'.'</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>sed<span class="w"> </span><span class="s1">'s/^0//'</span><span class="k">)</span>
</span><span id="__span-6-392"><a id="__codelineno-6-392" name="__codelineno-6-392"></a><span class="w">  </span><span class="nb">declare</span><span class="w"> </span>-A<span class="w"> </span><span class="nv">cpu_mhz_per_model</span><span class="o">=(</span>
</span><span id="__span-6-393"><a id="__codelineno-6-393" name="__codelineno-6-393"></a><span class="w">    </span><span class="o">[</span><span class="s2">"Raspberry_Pi_Zero_W_Rev_1_1"</span><span class="o">]=</span><span class="m">1000</span><span class="w">         </span><span class="c1"># 1x1000 MHz</span>
</span><span id="__span-6-394"><a id="__codelineno-6-394" name="__codelineno-6-394"></a><span class="w">    </span><span class="o">[</span><span class="s2">"Raspberry_Pi_Zero_2_W_Rev_1_0"</span><span class="o">]=</span><span class="m">4000</span><span class="w">       </span><span class="c1"># 4x1000 MHz</span>
</span><span id="__span-6-395"><a id="__codelineno-6-395" name="__codelineno-6-395"></a><span class="w">    </span><span class="o">[</span><span class="s2">"Raspberry_Pi_3_Model_A_Plus_Rev_1_0"</span><span class="o">]=</span><span class="m">1400</span><span class="w"> </span><span class="c1"># 1x1400 MHz</span>
</span><span id="__span-6-396"><a id="__codelineno-6-396" name="__codelineno-6-396"></a><span class="w">    </span><span class="o">[</span><span class="s2">"Raspberry_Pi_3_Model_B_Rev_1_3"</span><span class="o">]=</span><span class="m">4800</span><span class="w">      </span><span class="c1"># 4x1200 MHz</span>
</span><span id="__span-6-397"><a id="__codelineno-6-397" name="__codelineno-6-397"></a><span class="w">    </span><span class="o">[</span><span class="s2">"Raspberry_Pi_4_Model_B_Rev_1_4"</span><span class="o">]=</span><span class="m">6000</span><span class="w">      </span><span class="c1"># 4x1500 MHz</span>
</span><span id="__span-6-398"><a id="__codelineno-6-398" name="__codelineno-6-398"></a><span class="w">  </span><span class="o">)</span>
</span><span id="__span-6-399"><a id="__codelineno-6-399" name="__codelineno-6-399"></a><span class="w">  </span><span class="nv">model</span><span class="o">=</span><span class="k">$(</span>grep<span class="w"> </span>Model<span class="w"> </span>/proc/cpuinfo<span class="w"> </span><span class="p">|</span><span class="w"> </span>sed<span class="w"> </span><span class="s1">'s/.*: //'</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>tr<span class="w"> </span><span class="s1">' '</span><span class="w"> </span><span class="s1">'_'</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>tr<span class="w"> </span><span class="s1">'.'</span><span class="w"> </span><span class="s1">'_'</span><span class="k">)</span>
</span><span id="__span-6-400"><a id="__codelineno-6-400" name="__codelineno-6-400"></a><span class="w">  </span><span class="nv">mhz</span><span class="o">=</span><span class="si">${</span><span class="nv">cpu_mhz_per_model</span><span class="p">[</span><span class="s2">"</span><span class="si">${</span><span class="nv">model</span><span class="si">}</span><span class="s2">"</span><span class="p">]</span><span class="si">}</span>
</span><span id="__span-6-401"><a id="__codelineno-6-401" name="__codelineno-6-401"></a><span class="w">  </span><span class="nv">delay</span><span class="o">=</span><span class="k">$((</span><span class="m">250</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nv">load</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="nv">mhz</span><span class="k">))</span>
</span><span id="__span-6-402"><a id="__codelineno-6-402" name="__codelineno-6-402"></a><span class="w">  </span>sleep<span class="w"> </span><span class="si">${</span><span class="nv">delay</span><span class="si">}</span>
</span><span id="__span-6-403"><a id="__codelineno-6-403" name="__codelineno-6-403"></a><span class="o">}</span>
</span><span id="__span-6-404"><a id="__codelineno-6-404" name="__codelineno-6-404"></a>
</span><span id="__span-6-405"><a id="__codelineno-6-405" name="__codelineno-6-405"></a><span class="c1"># Run all the above tasks in a loop.</span>
</span><span id="__span-6-406"><a id="__codelineno-6-406" name="__codelineno-6-406"></a><span class="c1"># Each task is responsible of its own checks.</span>
</span><span id="__span-6-407"><a id="__codelineno-6-407" name="__codelineno-6-407"></a><span class="k">while</span><span class="w"> </span>true<span class="p">;</span><span class="w"> </span><span class="k">do</span>
</span><span id="__span-6-408"><a id="__codelineno-6-408" name="__codelineno-6-408"></a><span class="w">  </span>report_df
</span><span id="__span-6-409"><a id="__codelineno-6-409" name="__codelineno-6-409"></a><span class="w">  </span>report_du
</span><span id="__span-6-410"><a id="__codelineno-6-410" name="__codelineno-6-410"></a><span class="w">  </span>report_top
</span><span id="__span-6-411"><a id="__codelineno-6-411" name="__codelineno-6-411"></a><span class="w">  </span>report_free
</span><span id="__span-6-412"><a id="__codelineno-6-412" name="__codelineno-6-412"></a><span class="w">  </span>report_iotop
</span><span id="__span-6-413"><a id="__codelineno-6-413" name="__codelineno-6-413"></a><span class="w">  </span>report_sensors
</span><span id="__span-6-414"><a id="__codelineno-6-414" name="__codelineno-6-414"></a><span class="w">  </span>report_net_dev
</span><span id="__span-6-415"><a id="__codelineno-6-415" name="__codelineno-6-415"></a><span class="w">  </span>report_vcgencmd
</span><span id="__span-6-416"><a id="__codelineno-6-416" name="__codelineno-6-416"></a><span class="w">  </span>report_diskstats
</span><span id="__span-6-417"><a id="__codelineno-6-417" name="__codelineno-6-417"></a><span class="w">  </span>report_nvidia_smi
</span><span id="__span-6-418"><a id="__codelineno-6-418" name="__codelineno-6-418"></a><span class="w">  </span>report_intel_gpu_top
</span><span id="__span-6-419"><a id="__codelineno-6-419" name="__codelineno-6-419"></a><span class="w">  </span>post_lines_to_influxdb
</span><span id="__span-6-420"><a id="__codelineno-6-420" name="__codelineno-6-420"></a><span class="w">  </span>pause_depending_on_rpi_model
</span><span id="__span-6-421"><a id="__codelineno-6-421" name="__codelineno-6-421"></a><span class="k">done</span>
</span></code></pre></div></td></tr></table></div>
<h2 id="multi-thread">Multi-thread</h2>
<p>To run in slow systems such as Raspberry Pi computers, including any one from the 
<a href="https://www.raspberrypi.com/products/raspberry-pi-zero-w/">Zero W (v1)</a>
to the 
<a href="https://www.raspberrypi.com/products/raspberry-pi-4-model-b/">4 model B</a>, the single-thread version below
(<a href="#conmon-st"><code>conmon-st</code></a>) is preferred, with a sampling
delay based on each Raspberry CPU to avoid interfering with
other processes.</p>
<h3 id="deploy-to-pcs"><code>deploy-to-pcs</code></h3>
<p>In environments with multiple (desktop / server) computers,
it may be useful to use this script (<code>deploy-to-pcs</code>) to
deploy the latest version of the script to all computers.</p>
<div class="language-bash highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">deploy-to-pcs</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-7-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-7-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-7-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-7-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-7-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-7-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-7-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-7-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-7-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-7-10">10</a></span>
<span class="normal"><a href="#__codelineno-7-11">11</a></span>
<span class="normal"><a href="#__codelineno-7-12">12</a></span>
<span class="normal"><a href="#__codelineno-7-13">13</a></span>
<span class="normal"><a href="#__codelineno-7-14">14</a></span>
<span class="normal"><a href="#__codelineno-7-15">15</a></span>
<span class="normal"><a href="#__codelineno-7-16">16</a></span>
<span class="normal"><a href="#__codelineno-7-17">17</a></span>
<span class="normal"><a href="#__codelineno-7-18">18</a></span>
<span class="normal"><a href="#__codelineno-7-19">19</a></span>
<span class="normal"><a href="#__codelineno-7-20">20</a></span>
<span class="normal"><a href="#__codelineno-7-21">21</a></span>
<span class="normal"><a href="#__codelineno-7-22">22</a></span>
<span class="normal"><a href="#__codelineno-7-23">23</a></span>
<span class="normal"><a href="#__codelineno-7-24">24</a></span>
<span class="normal"><a href="#__codelineno-7-25">25</a></span>
<span class="normal"><a href="#__codelineno-7-26">26</a></span>
<span class="normal"><a href="#__codelineno-7-27">27</a></span>
<span class="normal"><a href="#__codelineno-7-28">28</a></span>
<span class="normal"><a href="#__codelineno-7-29">29</a></span>
<span class="normal"><a href="#__codelineno-7-30">30</a></span>
<span class="normal"><a href="#__codelineno-7-31">31</a></span>
<span class="normal"><a href="#__codelineno-7-32">32</a></span>
<span class="normal"><a href="#__codelineno-7-33">33</a></span>
<span class="normal"><a href="#__codelineno-7-34">34</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-7-1"><a id="__codelineno-7-1" name="__codelineno-7-1"></a><span class="ch">#!/bin/bash</span>
</span><span id="__span-7-2"><a id="__codelineno-7-2" name="__codelineno-7-2"></a><span class="c1">#</span>
</span><span id="__span-7-3"><a id="__codelineno-7-3" name="__codelineno-7-3"></a><span class="c1"># Deplay conmon-mt to PC hosts.</span>
</span><span id="__span-7-4"><a id="__codelineno-7-4" name="__codelineno-7-4"></a>
</span><span id="__span-7-5"><a id="__codelineno-7-5" name="__codelineno-7-5"></a><span class="k">for</span><span class="w"> </span>host<span class="w"> </span><span class="k">in</span><span class="w"> </span>computer<span class="w"> </span>smart-computer<span class="w"> </span>lexicon<span class="w"> </span>rapture<span class="p">;</span><span class="w"> </span><span class="k">do</span>
</span><span id="__span-7-6"><a id="__codelineno-7-6" name="__codelineno-7-6"></a><span class="w">  </span><span class="k">if</span><span class="w"> </span>nc<span class="w"> </span><span class="m">2</span>&gt;<span class="p">&amp;</span><span class="m">1</span><span class="w"> </span>-zv<span class="w"> </span><span class="si">${</span><span class="nv">host</span><span class="si">}</span><span class="w"> </span><span class="m">22</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>-q<span class="w"> </span>succeeded<span class="p">;</span><span class="w"> </span><span class="k">then</span>
</span><span id="__span-7-7"><a id="__codelineno-7-7" name="__codelineno-7-7"></a><span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">"Deploying to </span><span class="si">${</span><span class="nv">host</span><span class="si">}</span><span class="s2"> ..."</span>
</span><span id="__span-7-8"><a id="__codelineno-7-8" name="__codelineno-7-8"></a><span class="w">    </span>scp<span class="w"> </span><span class="m">2</span>&gt;/dev/null<span class="w"> </span><span class="se">\</span>
</span><span id="__span-7-9"><a id="__codelineno-7-9" name="__codelineno-7-9"></a><span class="w">      </span>-qr<span class="w"> </span><span class="se">\</span>
</span><span id="__span-7-10"><a id="__codelineno-7-10" name="__codelineno-7-10"></a><span class="w">      </span>../conmon<span class="w"> </span><span class="se">\</span>
</span><span id="__span-7-11"><a id="__codelineno-7-11" name="__codelineno-7-11"></a><span class="w">      </span>root@<span class="si">${</span><span class="nv">host</span><span class="si">}</span>:
</span><span id="__span-7-12"><a id="__codelineno-7-12" name="__codelineno-7-12"></a><span class="w">    </span>ssh<span class="w"> </span><span class="m">2</span>&gt;/dev/null<span class="w"> </span><span class="se">\</span>
</span><span id="__span-7-13"><a id="__codelineno-7-13" name="__codelineno-7-13"></a><span class="w">      </span>root@<span class="si">${</span><span class="nv">host</span><span class="si">}</span><span class="w"> </span><span class="se">\</span>
</span><span id="__span-7-14"><a id="__codelineno-7-14" name="__codelineno-7-14"></a><span class="w">      </span><span class="s2">"cp /root/conmon/conmon-mt /usr/local/bin/conmon"</span>
</span><span id="__span-7-15"><a id="__codelineno-7-15" name="__codelineno-7-15"></a><span class="w">    </span>ssh<span class="w"> </span><span class="m">2</span>&gt;/dev/null<span class="w"> </span><span class="se">\</span>
</span><span id="__span-7-16"><a id="__codelineno-7-16" name="__codelineno-7-16"></a><span class="w">      </span>root@<span class="si">${</span><span class="nv">host</span><span class="si">}</span><span class="w"> </span><span class="se">\</span>
</span><span id="__span-7-17"><a id="__codelineno-7-17" name="__codelineno-7-17"></a><span class="w">      </span><span class="s2">"systemctl restart conmon.service"</span>
</span><span id="__span-7-18"><a id="__codelineno-7-18" name="__codelineno-7-18"></a><span class="w">    </span><span class="nv">etc_influxdb_auth</span><span class="o">=</span>/etc/conmon/influxdb-auth
</span><span id="__span-7-19"><a id="__codelineno-7-19" name="__codelineno-7-19"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span>src_influxdb_auth<span class="w"> </span><span class="k">in</span><span class="w"> </span>/etc/conmon/influxdb-auth<span class="w"> </span><span class="s2">"</span><span class="si">${</span><span class="nv">HOME</span><span class="si">}</span><span class="s2">/.conmon-influxdb-auth"</span><span class="p">;</span><span class="w"> </span><span class="k">do</span>
</span><span id="__span-7-20"><a id="__codelineno-7-20" name="__codelineno-7-20"></a><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span>-f<span class="w"> </span><span class="nv">$src_influxdb_auth</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
</span><span id="__span-7-21"><a id="__codelineno-7-21" name="__codelineno-7-21"></a><span class="w">        </span>ssh<span class="w"> </span><span class="m">2</span>&gt;/dev/null<span class="w"> </span><span class="se">\</span>
</span><span id="__span-7-22"><a id="__codelineno-7-22" name="__codelineno-7-22"></a><span class="w">          </span>root@<span class="si">${</span><span class="nv">host</span><span class="si">}</span><span class="w"> </span><span class="se">\</span>
</span><span id="__span-7-23"><a id="__codelineno-7-23" name="__codelineno-7-23"></a><span class="w">          </span><span class="s2">"mkdir -p </span><span class="k">$(</span>dirname<span class="w"> </span><span class="nv">$etc_influxdb_auth</span><span class="k">)</span><span class="s2">"</span>
</span><span id="__span-7-24"><a id="__codelineno-7-24" name="__codelineno-7-24"></a><span class="w">        </span>scp<span class="w"> </span><span class="m">2</span>&gt;/dev/null<span class="w"> </span><span class="se">\</span>
</span><span id="__span-7-25"><a id="__codelineno-7-25" name="__codelineno-7-25"></a><span class="w">          </span>-qr<span class="w"> </span><span class="se">\</span>
</span><span id="__span-7-26"><a id="__codelineno-7-26" name="__codelineno-7-26"></a><span class="w">          </span><span class="nv">$src_influxdb_auth</span><span class="w"> </span><span class="se">\</span>
</span><span id="__span-7-27"><a id="__codelineno-7-27" name="__codelineno-7-27"></a><span class="w">          </span>root@<span class="si">${</span><span class="nv">host</span><span class="si">}</span>:<span class="nv">$etc_influxdb_auth</span>
</span><span id="__span-7-28"><a id="__codelineno-7-28" name="__codelineno-7-28"></a><span class="w">        </span>ssh<span class="w"> </span><span class="m">2</span>&gt;/dev/null<span class="w"> </span><span class="se">\</span>
</span><span id="__span-7-29"><a id="__codelineno-7-29" name="__codelineno-7-29"></a><span class="w">          </span>root@<span class="si">${</span><span class="nv">host</span><span class="si">}</span><span class="w"> </span><span class="se">\</span>
</span><span id="__span-7-30"><a id="__codelineno-7-30" name="__codelineno-7-30"></a><span class="w">          </span><span class="s2">"chmod 400 </span><span class="nv">$etc_influxdb_auth</span><span class="s2">"</span>
</span><span id="__span-7-31"><a id="__codelineno-7-31" name="__codelineno-7-31"></a><span class="w">      </span><span class="k">fi</span>
</span><span id="__span-7-32"><a id="__codelineno-7-32" name="__codelineno-7-32"></a><span class="w">    </span><span class="k">done</span>
</span><span id="__span-7-33"><a id="__codelineno-7-33" name="__codelineno-7-33"></a><span class="w">  </span><span class="k">fi</span>
</span><span id="__span-7-34"><a id="__codelineno-7-34" name="__codelineno-7-34"></a><span class="k">done</span>
</span></code></pre></div></td></tr></table></div>
<h3 id="conmon-mt"><code>conmon-mt</code></h3>
<div class="language-bash highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">conmon-mt</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-8-1">  1</a></span>
<span class="normal"><a href="#__codelineno-8-2">  2</a></span>
<span class="normal"><a href="#__codelineno-8-3">  3</a></span>
<span class="normal"><a href="#__codelineno-8-4">  4</a></span>
<span class="normal"><a href="#__codelineno-8-5">  5</a></span>
<span class="normal"><a href="#__codelineno-8-6">  6</a></span>
<span class="normal"><a href="#__codelineno-8-7">  7</a></span>
<span class="normal"><a href="#__codelineno-8-8">  8</a></span>
<span class="normal"><a href="#__codelineno-8-9">  9</a></span>
<span class="normal"><a href="#__codelineno-8-10"> 10</a></span>
<span class="normal"><a href="#__codelineno-8-11"> 11</a></span>
<span class="normal"><a href="#__codelineno-8-12"> 12</a></span>
<span class="normal"><a href="#__codelineno-8-13"> 13</a></span>
<span class="normal"><a href="#__codelineno-8-14"> 14</a></span>
<span class="normal"><a href="#__codelineno-8-15"> 15</a></span>
<span class="normal"><a href="#__codelineno-8-16"> 16</a></span>
<span class="normal"><a href="#__codelineno-8-17"> 17</a></span>
<span class="normal"><a href="#__codelineno-8-18"> 18</a></span>
<span class="normal"><a href="#__codelineno-8-19"> 19</a></span>
<span class="normal"><a href="#__codelineno-8-20"> 20</a></span>
<span class="normal"><a href="#__codelineno-8-21"> 21</a></span>
<span class="normal"><a href="#__codelineno-8-22"> 22</a></span>
<span class="normal"><a href="#__codelineno-8-23"> 23</a></span>
<span class="normal"><a href="#__codelineno-8-24"> 24</a></span>
<span class="normal"><a href="#__codelineno-8-25"> 25</a></span>
<span class="normal"><a href="#__codelineno-8-26"> 26</a></span>
<span class="normal"><a href="#__codelineno-8-27"> 27</a></span>
<span class="normal"><a href="#__codelineno-8-28"> 28</a></span>
<span class="normal"><a href="#__codelineno-8-29"> 29</a></span>
<span class="normal"><a href="#__codelineno-8-30"> 30</a></span>
<span class="normal"><a href="#__codelineno-8-31"> 31</a></span>
<span class="normal"><a href="#__codelineno-8-32"> 32</a></span>
<span class="normal"><a href="#__codelineno-8-33"> 33</a></span>
<span class="normal"><a href="#__codelineno-8-34"> 34</a></span>
<span class="normal"><a href="#__codelineno-8-35"> 35</a></span>
<span class="normal"><a href="#__codelineno-8-36"> 36</a></span>
<span class="normal"><a href="#__codelineno-8-37"> 37</a></span>
<span class="normal"><a href="#__codelineno-8-38"> 38</a></span>
<span class="normal"><a href="#__codelineno-8-39"> 39</a></span>
<span class="normal"><a href="#__codelineno-8-40"> 40</a></span>
<span class="normal"><a href="#__codelineno-8-41"> 41</a></span>
<span class="normal"><a href="#__codelineno-8-42"> 42</a></span>
<span class="normal"><a href="#__codelineno-8-43"> 43</a></span>
<span class="normal"><a href="#__codelineno-8-44"> 44</a></span>
<span class="normal"><a href="#__codelineno-8-45"> 45</a></span>
<span class="normal"><a href="#__codelineno-8-46"> 46</a></span>
<span class="normal"><a href="#__codelineno-8-47"> 47</a></span>
<span class="normal"><a href="#__codelineno-8-48"> 48</a></span>
<span class="normal"><a href="#__codelineno-8-49"> 49</a></span>
<span class="normal"><a href="#__codelineno-8-50"> 50</a></span>
<span class="normal"><a href="#__codelineno-8-51"> 51</a></span>
<span class="normal"><a href="#__codelineno-8-52"> 52</a></span>
<span class="normal"><a href="#__codelineno-8-53"> 53</a></span>
<span class="normal"><a href="#__codelineno-8-54"> 54</a></span>
<span class="normal"><a href="#__codelineno-8-55"> 55</a></span>
<span class="normal"><a href="#__codelineno-8-56"> 56</a></span>
<span class="normal"><a href="#__codelineno-8-57"> 57</a></span>
<span class="normal"><a href="#__codelineno-8-58"> 58</a></span>
<span class="normal"><a href="#__codelineno-8-59"> 59</a></span>
<span class="normal"><a href="#__codelineno-8-60"> 60</a></span>
<span class="normal"><a href="#__codelineno-8-61"> 61</a></span>
<span class="normal"><a href="#__codelineno-8-62"> 62</a></span>
<span class="normal"><a href="#__codelineno-8-63"> 63</a></span>
<span class="normal"><a href="#__codelineno-8-64"> 64</a></span>
<span class="normal"><a href="#__codelineno-8-65"> 65</a></span>
<span class="normal"><a href="#__codelineno-8-66"> 66</a></span>
<span class="normal"><a href="#__codelineno-8-67"> 67</a></span>
<span class="normal"><a href="#__codelineno-8-68"> 68</a></span>
<span class="normal"><a href="#__codelineno-8-69"> 69</a></span>
<span class="normal"><a href="#__codelineno-8-70"> 70</a></span>
<span class="normal"><a href="#__codelineno-8-71"> 71</a></span>
<span class="normal"><a href="#__codelineno-8-72"> 72</a></span>
<span class="normal"><a href="#__codelineno-8-73"> 73</a></span>
<span class="normal"><a href="#__codelineno-8-74"> 74</a></span>
<span class="normal"><a href="#__codelineno-8-75"> 75</a></span>
<span class="normal"><a href="#__codelineno-8-76"> 76</a></span>
<span class="normal"><a href="#__codelineno-8-77"> 77</a></span>
<span class="normal"><a href="#__codelineno-8-78"> 78</a></span>
<span class="normal"><a href="#__codelineno-8-79"> 79</a></span>
<span class="normal"><a href="#__codelineno-8-80"> 80</a></span>
<span class="normal"><a href="#__codelineno-8-81"> 81</a></span>
<span class="normal"><a href="#__codelineno-8-82"> 82</a></span>
<span class="normal"><a href="#__codelineno-8-83"> 83</a></span>
<span class="normal"><a href="#__codelineno-8-84"> 84</a></span>
<span class="normal"><a href="#__codelineno-8-85"> 85</a></span>
<span class="normal"><a href="#__codelineno-8-86"> 86</a></span>
<span class="normal"><a href="#__codelineno-8-87"> 87</a></span>
<span class="normal"><a href="#__codelineno-8-88"> 88</a></span>
<span class="normal"><a href="#__codelineno-8-89"> 89</a></span>
<span class="normal"><a href="#__codelineno-8-90"> 90</a></span>
<span class="normal"><a href="#__codelineno-8-91"> 91</a></span>
<span class="normal"><a href="#__codelineno-8-92"> 92</a></span>
<span class="normal"><a href="#__codelineno-8-93"> 93</a></span>
<span class="normal"><a href="#__codelineno-8-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-8-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-8-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-8-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-8-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-8-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-8-100">100</a></span>
<span class="normal"><a href="#__codelineno-8-101">101</a></span>
<span class="normal"><a href="#__codelineno-8-102">102</a></span>
<span class="normal"><a href="#__codelineno-8-103">103</a></span>
<span class="normal"><a href="#__codelineno-8-104">104</a></span>
<span class="normal"><a href="#__codelineno-8-105">105</a></span>
<span class="normal"><a href="#__codelineno-8-106">106</a></span>
<span class="normal"><a href="#__codelineno-8-107">107</a></span>
<span class="normal"><a href="#__codelineno-8-108">108</a></span>
<span class="normal"><a href="#__codelineno-8-109">109</a></span>
<span class="normal"><a href="#__codelineno-8-110">110</a></span>
<span class="normal"><a href="#__codelineno-8-111">111</a></span>
<span class="normal"><a href="#__codelineno-8-112">112</a></span>
<span class="normal"><a href="#__codelineno-8-113">113</a></span>
<span class="normal"><a href="#__codelineno-8-114">114</a></span>
<span class="normal"><a href="#__codelineno-8-115">115</a></span>
<span class="normal"><a href="#__codelineno-8-116">116</a></span>
<span class="normal"><a href="#__codelineno-8-117">117</a></span>
<span class="normal"><a href="#__codelineno-8-118">118</a></span>
<span class="normal"><a href="#__codelineno-8-119">119</a></span>
<span class="normal"><a href="#__codelineno-8-120">120</a></span>
<span class="normal"><a href="#__codelineno-8-121">121</a></span>
<span class="normal"><a href="#__codelineno-8-122">122</a></span>
<span class="normal"><a href="#__codelineno-8-123">123</a></span>
<span class="normal"><a href="#__codelineno-8-124">124</a></span>
<span class="normal"><a href="#__codelineno-8-125">125</a></span>
<span class="normal"><a href="#__codelineno-8-126">126</a></span>
<span class="normal"><a href="#__codelineno-8-127">127</a></span>
<span class="normal"><a href="#__codelineno-8-128">128</a></span>
<span class="normal"><a href="#__codelineno-8-129">129</a></span>
<span class="normal"><a href="#__codelineno-8-130">130</a></span>
<span class="normal"><a href="#__codelineno-8-131">131</a></span>
<span class="normal"><a href="#__codelineno-8-132">132</a></span>
<span class="normal"><a href="#__codelineno-8-133">133</a></span>
<span class="normal"><a href="#__codelineno-8-134">134</a></span>
<span class="normal"><a href="#__codelineno-8-135">135</a></span>
<span class="normal"><a href="#__codelineno-8-136">136</a></span>
<span class="normal"><a href="#__codelineno-8-137">137</a></span>
<span class="normal"><a href="#__codelineno-8-138">138</a></span>
<span class="normal"><a href="#__codelineno-8-139">139</a></span>
<span class="normal"><a href="#__codelineno-8-140">140</a></span>
<span class="normal"><a href="#__codelineno-8-141">141</a></span>
<span class="normal"><a href="#__codelineno-8-142">142</a></span>
<span class="normal"><a href="#__codelineno-8-143">143</a></span>
<span class="normal"><a href="#__codelineno-8-144">144</a></span>
<span class="normal"><a href="#__codelineno-8-145">145</a></span>
<span class="normal"><a href="#__codelineno-8-146">146</a></span>
<span class="normal"><a href="#__codelineno-8-147">147</a></span>
<span class="normal"><a href="#__codelineno-8-148">148</a></span>
<span class="normal"><a href="#__codelineno-8-149">149</a></span>
<span class="normal"><a href="#__codelineno-8-150">150</a></span>
<span class="normal"><a href="#__codelineno-8-151">151</a></span>
<span class="normal"><a href="#__codelineno-8-152">152</a></span>
<span class="normal"><a href="#__codelineno-8-153">153</a></span>
<span class="normal"><a href="#__codelineno-8-154">154</a></span>
<span class="normal"><a href="#__codelineno-8-155">155</a></span>
<span class="normal"><a href="#__codelineno-8-156">156</a></span>
<span class="normal"><a href="#__codelineno-8-157">157</a></span>
<span class="normal"><a href="#__codelineno-8-158">158</a></span>
<span class="normal"><a href="#__codelineno-8-159">159</a></span>
<span class="normal"><a href="#__codelineno-8-160">160</a></span>
<span class="normal"><a href="#__codelineno-8-161">161</a></span>
<span class="normal"><a href="#__codelineno-8-162">162</a></span>
<span class="normal"><a href="#__codelineno-8-163">163</a></span>
<span class="normal"><a href="#__codelineno-8-164">164</a></span>
<span class="normal"><a href="#__codelineno-8-165">165</a></span>
<span class="normal"><a href="#__codelineno-8-166">166</a></span>
<span class="normal"><a href="#__codelineno-8-167">167</a></span>
<span class="normal"><a href="#__codelineno-8-168">168</a></span>
<span class="normal"><a href="#__codelineno-8-169">169</a></span>
<span class="normal"><a href="#__codelineno-8-170">170</a></span>
<span class="normal"><a href="#__codelineno-8-171">171</a></span>
<span class="normal"><a href="#__codelineno-8-172">172</a></span>
<span class="normal"><a href="#__codelineno-8-173">173</a></span>
<span class="normal"><a href="#__codelineno-8-174">174</a></span>
<span class="normal"><a href="#__codelineno-8-175">175</a></span>
<span class="normal"><a href="#__codelineno-8-176">176</a></span>
<span class="normal"><a href="#__codelineno-8-177">177</a></span>
<span class="normal"><a href="#__codelineno-8-178">178</a></span>
<span class="normal"><a href="#__codelineno-8-179">179</a></span>
<span class="normal"><a href="#__codelineno-8-180">180</a></span>
<span class="normal"><a href="#__codelineno-8-181">181</a></span>
<span class="normal"><a href="#__codelineno-8-182">182</a></span>
<span class="normal"><a href="#__codelineno-8-183">183</a></span>
<span class="normal"><a href="#__codelineno-8-184">184</a></span>
<span class="normal"><a href="#__codelineno-8-185">185</a></span>
<span class="normal"><a href="#__codelineno-8-186">186</a></span>
<span class="normal"><a href="#__codelineno-8-187">187</a></span>
<span class="normal"><a href="#__codelineno-8-188">188</a></span>
<span class="normal"><a href="#__codelineno-8-189">189</a></span>
<span class="normal"><a href="#__codelineno-8-190">190</a></span>
<span class="normal"><a href="#__codelineno-8-191">191</a></span>
<span class="normal"><a href="#__codelineno-8-192">192</a></span>
<span class="normal"><a href="#__codelineno-8-193">193</a></span>
<span class="normal"><a href="#__codelineno-8-194">194</a></span>
<span class="normal"><a href="#__codelineno-8-195">195</a></span>
<span class="normal"><a href="#__codelineno-8-196">196</a></span>
<span class="normal"><a href="#__codelineno-8-197">197</a></span>
<span class="normal"><a href="#__codelineno-8-198">198</a></span>
<span class="normal"><a href="#__codelineno-8-199">199</a></span>
<span class="normal"><a href="#__codelineno-8-200">200</a></span>
<span class="normal"><a href="#__codelineno-8-201">201</a></span>
<span class="normal"><a href="#__codelineno-8-202">202</a></span>
<span class="normal"><a href="#__codelineno-8-203">203</a></span>
<span class="normal"><a href="#__codelineno-8-204">204</a></span>
<span class="normal"><a href="#__codelineno-8-205">205</a></span>
<span class="normal"><a href="#__codelineno-8-206">206</a></span>
<span class="normal"><a href="#__codelineno-8-207">207</a></span>
<span class="normal"><a href="#__codelineno-8-208">208</a></span>
<span class="normal"><a href="#__codelineno-8-209">209</a></span>
<span class="normal"><a href="#__codelineno-8-210">210</a></span>
<span class="normal"><a href="#__codelineno-8-211">211</a></span>
<span class="normal"><a href="#__codelineno-8-212">212</a></span>
<span class="normal"><a href="#__codelineno-8-213">213</a></span>
<span class="normal"><a href="#__codelineno-8-214">214</a></span>
<span class="normal"><a href="#__codelineno-8-215">215</a></span>
<span class="normal"><a href="#__codelineno-8-216">216</a></span>
<span class="normal"><a href="#__codelineno-8-217">217</a></span>
<span class="normal"><a href="#__codelineno-8-218">218</a></span>
<span class="normal"><a href="#__codelineno-8-219">219</a></span>
<span class="normal"><a href="#__codelineno-8-220">220</a></span>
<span class="normal"><a href="#__codelineno-8-221">221</a></span>
<span class="normal"><a href="#__codelineno-8-222">222</a></span>
<span class="normal"><a href="#__codelineno-8-223">223</a></span>
<span class="normal"><a href="#__codelineno-8-224">224</a></span>
<span class="normal"><a href="#__codelineno-8-225">225</a></span>
<span class="normal"><a href="#__codelineno-8-226">226</a></span>
<span class="normal"><a href="#__codelineno-8-227">227</a></span>
<span class="normal"><a href="#__codelineno-8-228">228</a></span>
<span class="normal"><a href="#__codelineno-8-229">229</a></span>
<span class="normal"><a href="#__codelineno-8-230">230</a></span>
<span class="normal"><a href="#__codelineno-8-231">231</a></span>
<span class="normal"><a href="#__codelineno-8-232">232</a></span>
<span class="normal"><a href="#__codelineno-8-233">233</a></span>
<span class="normal"><a href="#__codelineno-8-234">234</a></span>
<span class="normal"><a href="#__codelineno-8-235">235</a></span>
<span class="normal"><a href="#__codelineno-8-236">236</a></span>
<span class="normal"><a href="#__codelineno-8-237">237</a></span>
<span class="normal"><a href="#__codelineno-8-238">238</a></span>
<span class="normal"><a href="#__codelineno-8-239">239</a></span>
<span class="normal"><a href="#__codelineno-8-240">240</a></span>
<span class="normal"><a href="#__codelineno-8-241">241</a></span>
<span class="normal"><a href="#__codelineno-8-242">242</a></span>
<span class="normal"><a href="#__codelineno-8-243">243</a></span>
<span class="normal"><a href="#__codelineno-8-244">244</a></span>
<span class="normal"><a href="#__codelineno-8-245">245</a></span>
<span class="normal"><a href="#__codelineno-8-246">246</a></span>
<span class="normal"><a href="#__codelineno-8-247">247</a></span>
<span class="normal"><a href="#__codelineno-8-248">248</a></span>
<span class="normal"><a href="#__codelineno-8-249">249</a></span>
<span class="normal"><a href="#__codelineno-8-250">250</a></span>
<span class="normal"><a href="#__codelineno-8-251">251</a></span>
<span class="normal"><a href="#__codelineno-8-252">252</a></span>
<span class="normal"><a href="#__codelineno-8-253">253</a></span>
<span class="normal"><a href="#__codelineno-8-254">254</a></span>
<span class="normal"><a href="#__codelineno-8-255">255</a></span>
<span class="normal"><a href="#__codelineno-8-256">256</a></span>
<span class="normal"><a href="#__codelineno-8-257">257</a></span>
<span class="normal"><a href="#__codelineno-8-258">258</a></span>
<span class="normal"><a href="#__codelineno-8-259">259</a></span>
<span class="normal"><a href="#__codelineno-8-260">260</a></span>
<span class="normal"><a href="#__codelineno-8-261">261</a></span>
<span class="normal"><a href="#__codelineno-8-262">262</a></span>
<span class="normal"><a href="#__codelineno-8-263">263</a></span>
<span class="normal"><a href="#__codelineno-8-264">264</a></span>
<span class="normal"><a href="#__codelineno-8-265">265</a></span>
<span class="normal"><a href="#__codelineno-8-266">266</a></span>
<span class="normal"><a href="#__codelineno-8-267">267</a></span>
<span class="normal"><a href="#__codelineno-8-268">268</a></span>
<span class="normal"><a href="#__codelineno-8-269">269</a></span>
<span class="normal"><a href="#__codelineno-8-270">270</a></span>
<span class="normal"><a href="#__codelineno-8-271">271</a></span>
<span class="normal"><a href="#__codelineno-8-272">272</a></span>
<span class="normal"><a href="#__codelineno-8-273">273</a></span>
<span class="normal"><a href="#__codelineno-8-274">274</a></span>
<span class="normal"><a href="#__codelineno-8-275">275</a></span>
<span class="normal"><a href="#__codelineno-8-276">276</a></span>
<span class="normal"><a href="#__codelineno-8-277">277</a></span>
<span class="normal"><a href="#__codelineno-8-278">278</a></span>
<span class="normal"><a href="#__codelineno-8-279">279</a></span>
<span class="normal"><a href="#__codelineno-8-280">280</a></span>
<span class="normal"><a href="#__codelineno-8-281">281</a></span>
<span class="normal"><a href="#__codelineno-8-282">282</a></span>
<span class="normal"><a href="#__codelineno-8-283">283</a></span>
<span class="normal"><a href="#__codelineno-8-284">284</a></span>
<span class="normal"><a href="#__codelineno-8-285">285</a></span>
<span class="normal"><a href="#__codelineno-8-286">286</a></span>
<span class="normal"><a href="#__codelineno-8-287">287</a></span>
<span class="normal"><a href="#__codelineno-8-288">288</a></span>
<span class="normal"><a href="#__codelineno-8-289">289</a></span>
<span class="normal"><a href="#__codelineno-8-290">290</a></span>
<span class="normal"><a href="#__codelineno-8-291">291</a></span>
<span class="normal"><a href="#__codelineno-8-292">292</a></span>
<span class="normal"><a href="#__codelineno-8-293">293</a></span>
<span class="normal"><a href="#__codelineno-8-294">294</a></span>
<span class="normal"><a href="#__codelineno-8-295">295</a></span>
<span class="normal"><a href="#__codelineno-8-296">296</a></span>
<span class="normal"><a href="#__codelineno-8-297">297</a></span>
<span class="normal"><a href="#__codelineno-8-298">298</a></span>
<span class="normal"><a href="#__codelineno-8-299">299</a></span>
<span class="normal"><a href="#__codelineno-8-300">300</a></span>
<span class="normal"><a href="#__codelineno-8-301">301</a></span>
<span class="normal"><a href="#__codelineno-8-302">302</a></span>
<span class="normal"><a href="#__codelineno-8-303">303</a></span>
<span class="normal"><a href="#__codelineno-8-304">304</a></span>
<span class="normal"><a href="#__codelineno-8-305">305</a></span>
<span class="normal"><a href="#__codelineno-8-306">306</a></span>
<span class="normal"><a href="#__codelineno-8-307">307</a></span>
<span class="normal"><a href="#__codelineno-8-308">308</a></span>
<span class="normal"><a href="#__codelineno-8-309">309</a></span>
<span class="normal"><a href="#__codelineno-8-310">310</a></span>
<span class="normal"><a href="#__codelineno-8-311">311</a></span>
<span class="normal"><a href="#__codelineno-8-312">312</a></span>
<span class="normal"><a href="#__codelineno-8-313">313</a></span>
<span class="normal"><a href="#__codelineno-8-314">314</a></span>
<span class="normal"><a href="#__codelineno-8-315">315</a></span>
<span class="normal"><a href="#__codelineno-8-316">316</a></span>
<span class="normal"><a href="#__codelineno-8-317">317</a></span>
<span class="normal"><a href="#__codelineno-8-318">318</a></span>
<span class="normal"><a href="#__codelineno-8-319">319</a></span>
<span class="normal"><a href="#__codelineno-8-320">320</a></span>
<span class="normal"><a href="#__codelineno-8-321">321</a></span>
<span class="normal"><a href="#__codelineno-8-322">322</a></span>
<span class="normal"><a href="#__codelineno-8-323">323</a></span>
<span class="normal"><a href="#__codelineno-8-324">324</a></span>
<span class="normal"><a href="#__codelineno-8-325">325</a></span>
<span class="normal"><a href="#__codelineno-8-326">326</a></span>
<span class="normal"><a href="#__codelineno-8-327">327</a></span>
<span class="normal"><a href="#__codelineno-8-328">328</a></span>
<span class="normal"><a href="#__codelineno-8-329">329</a></span>
<span class="normal"><a href="#__codelineno-8-330">330</a></span>
<span class="normal"><a href="#__codelineno-8-331">331</a></span>
<span class="normal"><a href="#__codelineno-8-332">332</a></span>
<span class="normal"><a href="#__codelineno-8-333">333</a></span>
<span class="normal"><a href="#__codelineno-8-334">334</a></span>
<span class="normal"><a href="#__codelineno-8-335">335</a></span>
<span class="normal"><a href="#__codelineno-8-336">336</a></span>
<span class="normal"><a href="#__codelineno-8-337">337</a></span>
<span class="normal"><a href="#__codelineno-8-338">338</a></span>
<span class="normal"><a href="#__codelineno-8-339">339</a></span>
<span class="normal"><a href="#__codelineno-8-340">340</a></span>
<span class="normal"><a href="#__codelineno-8-341">341</a></span>
<span class="normal"><a href="#__codelineno-8-342">342</a></span>
<span class="normal"><a href="#__codelineno-8-343">343</a></span>
<span class="normal"><a href="#__codelineno-8-344">344</a></span>
<span class="normal"><a href="#__codelineno-8-345">345</a></span>
<span class="normal"><a href="#__codelineno-8-346">346</a></span>
<span class="normal"><a href="#__codelineno-8-347">347</a></span>
<span class="normal"><a href="#__codelineno-8-348">348</a></span>
<span class="normal"><a href="#__codelineno-8-349">349</a></span>
<span class="normal"><a href="#__codelineno-8-350">350</a></span>
<span class="normal"><a href="#__codelineno-8-351">351</a></span>
<span class="normal"><a href="#__codelineno-8-352">352</a></span>
<span class="normal"><a href="#__codelineno-8-353">353</a></span>
<span class="normal"><a href="#__codelineno-8-354">354</a></span>
<span class="normal"><a href="#__codelineno-8-355">355</a></span>
<span class="normal"><a href="#__codelineno-8-356">356</a></span>
<span class="normal"><a href="#__codelineno-8-357">357</a></span>
<span class="normal"><a href="#__codelineno-8-358">358</a></span>
<span class="normal"><a href="#__codelineno-8-359">359</a></span>
<span class="normal"><a href="#__codelineno-8-360">360</a></span>
<span class="normal"><a href="#__codelineno-8-361">361</a></span>
<span class="normal"><a href="#__codelineno-8-362">362</a></span>
<span class="normal"><a href="#__codelineno-8-363">363</a></span>
<span class="normal"><a href="#__codelineno-8-364">364</a></span>
<span class="normal"><a href="#__codelineno-8-365">365</a></span>
<span class="normal"><a href="#__codelineno-8-366">366</a></span>
<span class="normal"><a href="#__codelineno-8-367">367</a></span>
<span class="normal"><a href="#__codelineno-8-368">368</a></span>
<span class="normal"><a href="#__codelineno-8-369">369</a></span>
<span class="normal"><a href="#__codelineno-8-370">370</a></span>
<span class="normal"><a href="#__codelineno-8-371">371</a></span>
<span class="normal"><a href="#__codelineno-8-372">372</a></span>
<span class="normal"><a href="#__codelineno-8-373">373</a></span>
<span class="normal"><a href="#__codelineno-8-374">374</a></span>
<span class="normal"><a href="#__codelineno-8-375">375</a></span>
<span class="normal"><a href="#__codelineno-8-376">376</a></span>
<span class="normal"><a href="#__codelineno-8-377">377</a></span>
<span class="normal"><a href="#__codelineno-8-378">378</a></span>
<span class="normal"><a href="#__codelineno-8-379">379</a></span>
<span class="normal"><a href="#__codelineno-8-380">380</a></span>
<span class="normal"><a href="#__codelineno-8-381">381</a></span>
<span class="normal"><a href="#__codelineno-8-382">382</a></span>
<span class="normal"><a href="#__codelineno-8-383">383</a></span>
<span class="normal"><a href="#__codelineno-8-384">384</a></span>
<span class="normal"><a href="#__codelineno-8-385">385</a></span>
<span class="normal"><a href="#__codelineno-8-386">386</a></span>
<span class="normal"><a href="#__codelineno-8-387">387</a></span>
<span class="normal"><a href="#__codelineno-8-388">388</a></span>
<span class="normal"><a href="#__codelineno-8-389">389</a></span>
<span class="normal"><a href="#__codelineno-8-390">390</a></span>
<span class="normal"><a href="#__codelineno-8-391">391</a></span>
<span class="normal"><a href="#__codelineno-8-392">392</a></span>
<span class="normal"><a href="#__codelineno-8-393">393</a></span>
<span class="normal"><a href="#__codelineno-8-394">394</a></span>
<span class="normal"><a href="#__codelineno-8-395">395</a></span>
<span class="normal"><a href="#__codelineno-8-396">396</a></span>
<span class="normal"><a href="#__codelineno-8-397">397</a></span>
<span class="normal"><a href="#__codelineno-8-398">398</a></span>
<span class="normal"><a href="#__codelineno-8-399">399</a></span>
<span class="normal"><a href="#__codelineno-8-400">400</a></span>
<span class="normal"><a href="#__codelineno-8-401">401</a></span>
<span class="normal"><a href="#__codelineno-8-402">402</a></span>
<span class="normal"><a href="#__codelineno-8-403">403</a></span>
<span class="normal"><a href="#__codelineno-8-404">404</a></span>
<span class="normal"><a href="#__codelineno-8-405">405</a></span>
<span class="normal"><a href="#__codelineno-8-406">406</a></span>
<span class="normal"><a href="#__codelineno-8-407">407</a></span>
<span class="normal"><a href="#__codelineno-8-408">408</a></span>
<span class="normal"><a href="#__codelineno-8-409">409</a></span>
<span class="normal"><a href="#__codelineno-8-410">410</a></span>
<span class="normal"><a href="#__codelineno-8-411">411</a></span>
<span class="normal"><a href="#__codelineno-8-412">412</a></span>
<span class="normal"><a href="#__codelineno-8-413">413</a></span>
<span class="normal"><a href="#__codelineno-8-414">414</a></span>
<span class="normal"><a href="#__codelineno-8-415">415</a></span>
<span class="normal"><a href="#__codelineno-8-416">416</a></span>
<span class="normal"><a href="#__codelineno-8-417">417</a></span>
<span class="normal"><a href="#__codelineno-8-418">418</a></span>
<span class="normal"><a href="#__codelineno-8-419">419</a></span>
<span class="normal"><a href="#__codelineno-8-420">420</a></span>
<span class="normal"><a href="#__codelineno-8-421">421</a></span>
<span class="normal"><a href="#__codelineno-8-422">422</a></span>
<span class="normal"><a href="#__codelineno-8-423">423</a></span>
<span class="normal"><a href="#__codelineno-8-424">424</a></span>
<span class="normal"><a href="#__codelineno-8-425">425</a></span>
<span class="normal"><a href="#__codelineno-8-426">426</a></span>
<span class="normal"><a href="#__codelineno-8-427">427</a></span>
<span class="normal"><a href="#__codelineno-8-428">428</a></span>
<span class="normal"><a href="#__codelineno-8-429">429</a></span>
<span class="normal"><a href="#__codelineno-8-430">430</a></span>
<span class="normal"><a href="#__codelineno-8-431">431</a></span>
<span class="normal"><a href="#__codelineno-8-432">432</a></span>
<span class="normal"><a href="#__codelineno-8-433">433</a></span>
<span class="normal"><a href="#__codelineno-8-434">434</a></span>
<span class="normal"><a href="#__codelineno-8-435">435</a></span>
<span class="normal"><a href="#__codelineno-8-436">436</a></span>
<span class="normal"><a href="#__codelineno-8-437">437</a></span>
<span class="normal"><a href="#__codelineno-8-438">438</a></span>
<span class="normal"><a href="#__codelineno-8-439">439</a></span>
<span class="normal"><a href="#__codelineno-8-440">440</a></span>
<span class="normal"><a href="#__codelineno-8-441">441</a></span>
<span class="normal"><a href="#__codelineno-8-442">442</a></span>
<span class="normal"><a href="#__codelineno-8-443">443</a></span>
<span class="normal"><a href="#__codelineno-8-444">444</a></span>
<span class="normal"><a href="#__codelineno-8-445">445</a></span>
<span class="normal"><a href="#__codelineno-8-446">446</a></span>
<span class="normal"><a href="#__codelineno-8-447">447</a></span>
<span class="normal"><a href="#__codelineno-8-448">448</a></span>
<span class="normal"><a href="#__codelineno-8-449">449</a></span>
<span class="normal"><a href="#__codelineno-8-450">450</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-8-1"><a id="__codelineno-8-1" name="__codelineno-8-1"></a><span class="ch">#!/bin/bash</span>
</span><span id="__span-8-2"><a id="__codelineno-8-2" name="__codelineno-8-2"></a><span class="c1">#</span>
</span><span id="__span-8-3"><a id="__codelineno-8-3" name="__codelineno-8-3"></a><span class="c1"># Export system monitoring metrics to influxdb.</span>
</span><span id="__span-8-4"><a id="__codelineno-8-4" name="__codelineno-8-4"></a>
</span><span id="__span-8-5"><a id="__codelineno-8-5" name="__codelineno-8-5"></a><span class="c1"># InfluxDB target.</span>
</span><span id="__span-8-6"><a id="__codelineno-8-6" name="__codelineno-8-6"></a><span class="nv">DBNAME</span><span class="o">=</span>monitoring
</span><span id="__span-8-7"><a id="__codelineno-8-7" name="__codelineno-8-7"></a><span class="nv">TARGET_HTTP</span><span class="o">=</span><span class="s1">''</span><span class="w"> </span><span class="c1"># Leave empty to skip.</span>
</span><span id="__span-8-8"><a id="__codelineno-8-8" name="__codelineno-8-8"></a><span class="nv">TARGET_HTTPS</span><span class="o">=</span><span class="s1">'http://lexicon:30086'</span>
</span><span id="__span-8-9"><a id="__codelineno-8-9" name="__codelineno-8-9"></a>
</span><span id="__span-8-10"><a id="__codelineno-8-10" name="__codelineno-8-10"></a><span class="c1"># Default delay between each POST request to InfluxDB.</span>
</span><span id="__span-8-11"><a id="__codelineno-8-11" name="__codelineno-8-11"></a><span class="nv">DELAY_POST</span><span class="o">=</span><span class="m">4</span>
</span><span id="__span-8-12"><a id="__codelineno-8-12" name="__codelineno-8-12"></a>
</span><span id="__span-8-13"><a id="__codelineno-8-13" name="__codelineno-8-13"></a><span class="c1"># Default delay between each round of "fast" metrics.</span>
</span><span id="__span-8-14"><a id="__codelineno-8-14" name="__codelineno-8-14"></a><span class="nv">DELAY_FAST</span><span class="o">=</span><span class="m">2</span>
</span><span id="__span-8-15"><a id="__codelineno-8-15" name="__codelineno-8-15"></a>
</span><span id="__span-8-16"><a id="__codelineno-8-16" name="__codelineno-8-16"></a><span class="c1"># Default delay between each round of top (neither fast nor slow).</span>
</span><span id="__span-8-17"><a id="__codelineno-8-17" name="__codelineno-8-17"></a><span class="nv">DELAY_TOP</span><span class="o">=</span><span class="m">2</span>
</span><span id="__span-8-18"><a id="__codelineno-8-18" name="__codelineno-8-18"></a>
</span><span id="__span-8-19"><a id="__codelineno-8-19" name="__codelineno-8-19"></a><span class="c1"># Default delay between each round of slow metrics (e.g. I/O bound).</span>
</span><span id="__span-8-20"><a id="__codelineno-8-20" name="__codelineno-8-20"></a><span class="nv">DELAY_SLOW</span><span class="o">=</span><span class="m">300</span>
</span><span id="__span-8-21"><a id="__codelineno-8-21" name="__codelineno-8-21"></a>
</span><span id="__span-8-22"><a id="__codelineno-8-22" name="__codelineno-8-22"></a><span class="c1"># Data file for batch POST.</span>
</span><span id="__span-8-23"><a id="__codelineno-8-23" name="__codelineno-8-23"></a><span class="nv">DDIR</span><span class="o">=</span><span class="s2">"/dev/shm/</span><span class="nv">$$</span><span class="s2">"</span>
</span><span id="__span-8-24"><a id="__codelineno-8-24" name="__codelineno-8-24"></a><span class="nv">DATA</span><span class="o">=</span><span class="s2">"</span><span class="si">${</span><span class="nv">DDIR</span><span class="si">}</span><span class="s2">/DATA.txt"</span>
</span><span id="__span-8-25"><a id="__codelineno-8-25" name="__codelineno-8-25"></a>mkdir<span class="w"> </span>-p<span class="w"> </span><span class="s2">"</span><span class="si">${</span><span class="nv">DDIR</span><span class="si">}</span><span class="s2">"</span>
</span><span id="__span-8-26"><a id="__codelineno-8-26" name="__codelineno-8-26"></a>
</span><span id="__span-8-27"><a id="__codelineno-8-27" name="__codelineno-8-27"></a><span class="nv">host</span><span class="o">=</span><span class="k">$(</span>hostname<span class="k">)</span>
</span><span id="__span-8-28"><a id="__codelineno-8-28" name="__codelineno-8-28"></a>
</span><span id="__span-8-29"><a id="__codelineno-8-29" name="__codelineno-8-29"></a>timestamp_ns<span class="o">()</span><span class="w"> </span><span class="o">{</span>
</span><span id="__span-8-30"><a id="__codelineno-8-30" name="__codelineno-8-30"></a><span class="w">  </span>date<span class="w"> </span>+<span class="s1">'%s%N'</span>
</span><span id="__span-8-31"><a id="__codelineno-8-31" name="__codelineno-8-31"></a><span class="o">}</span>
</span><span id="__span-8-32"><a id="__codelineno-8-32" name="__codelineno-8-32"></a>
</span><span id="__span-8-33"><a id="__codelineno-8-33" name="__codelineno-8-33"></a>store_line<span class="o">()</span><span class="w"> </span><span class="o">{</span>
</span><span id="__span-8-34"><a id="__codelineno-8-34" name="__codelineno-8-34"></a><span class="w">  </span><span class="c1"># Write a line of data to the temporary in-memory file.</span>
</span><span id="__span-8-35"><a id="__codelineno-8-35" name="__codelineno-8-35"></a><span class="w">  </span><span class="c1"># Exit immediately if this fails.</span>
</span><span id="__span-8-36"><a id="__codelineno-8-36" name="__codelineno-8-36"></a><span class="w">  </span><span class="nb">echo</span><span class="w"> </span><span class="nv">$1</span><span class="w"> </span>&gt;&gt;<span class="s2">"</span><span class="si">${</span><span class="nv">DATA</span><span class="si">}</span><span class="s2">"</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nb">exit</span><span class="w"> </span><span class="m">1</span>
</span><span id="__span-8-37"><a id="__codelineno-8-37" name="__codelineno-8-37"></a><span class="o">}</span>
</span><span id="__span-8-38"><a id="__codelineno-8-38" name="__codelineno-8-38"></a>
</span><span id="__span-8-39"><a id="__codelineno-8-39" name="__codelineno-8-39"></a>report_top_per_process<span class="o">()</span><span class="w"> </span><span class="o">{</span>
</span><span id="__span-8-40"><a id="__codelineno-8-40" name="__codelineno-8-40"></a><span class="w">  </span><span class="c1"># Per-process CPU(%) &amp; MEM(bytes) usage.</span>
</span><span id="__span-8-41"><a id="__codelineno-8-41" name="__codelineno-8-41"></a><span class="w">  </span><span class="c1"># Re-use the ptop file created by report_top().</span>
</span><span id="__span-8-42"><a id="__codelineno-8-42" name="__codelineno-8-42"></a><span class="w">  </span><span class="nv">ts</span><span class="o">=</span><span class="nv">$1</span>
</span><span id="__span-8-43"><a id="__codelineno-8-43" name="__codelineno-8-43"></a><span class="w">  </span><span class="nv">ptop</span><span class="o">=</span><span class="nv">$2</span>
</span><span id="__span-8-44"><a id="__codelineno-8-44" name="__codelineno-8-44"></a><span class="w">  </span>awk<span class="w"> </span><span class="s1">'{print $4}'</span><span class="w"> </span><span class="s2">"</span><span class="si">${</span><span class="nv">ptop</span><span class="si">}</span><span class="s2">"</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>sort<span class="w"> </span>-u<span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="k">while</span><span class="w"> </span><span class="nb">read</span><span class="w"> </span>cmd<span class="p">;</span><span class="w"> </span><span class="k">do</span>
</span><span id="__span-8-45"><a id="__codelineno-8-45" name="__codelineno-8-45"></a><span class="w">    </span><span class="nv">user</span><span class="o">=</span><span class="k">$(</span>grep<span class="w"> </span><span class="s2">" </span><span class="si">${</span><span class="nv">cmd</span><span class="si">}</span><span class="s2">\$"</span><span class="w"> </span><span class="si">${</span><span class="nv">ptop</span><span class="si">}</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>cut<span class="w"> </span>-f1<span class="w"> </span>-d<span class="s1">' '</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>sort<span class="w"> </span>-u<span class="w"> </span><span class="p">|</span><span class="w"> </span>head<span class="w"> </span>-1<span class="k">)</span>
</span><span id="__span-8-46"><a id="__codelineno-8-46" name="__codelineno-8-46"></a><span class="w">    </span><span class="c1"># CPU per proccess, only when &gt; 0</span>
</span><span id="__span-8-47"><a id="__codelineno-8-47" name="__codelineno-8-47"></a><span class="w">    </span><span class="nv">cpu</span><span class="o">=</span><span class="k">$(</span>grep<span class="w"> </span><span class="s2">" </span><span class="si">${</span><span class="nv">cmd</span><span class="si">}</span><span class="s2">\$"</span><span class="w"> </span><span class="si">${</span><span class="nv">ptop</span><span class="si">}</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>cut<span class="w"> </span>-f2<span class="w"> </span>-d<span class="s1">' '</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>-v<span class="w"> </span><span class="s1">'^0\.0$'</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>tr<span class="w"> </span><span class="s1">'\n'</span><span class="w"> </span><span class="s1">'+'</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>sed<span class="w"> </span><span class="s1">'s/+$/\n/'</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>bc<span class="w"> </span>-ql<span class="k">)</span>
</span><span id="__span-8-48"><a id="__codelineno-8-48" name="__codelineno-8-48"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="o">[[</span><span class="w"> </span>!<span class="w"> </span>-z<span class="w"> </span><span class="s2">"</span><span class="si">${</span><span class="nv">cpu</span><span class="si">}</span><span class="s2">"</span><span class="w"> </span><span class="o">]]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
</span><span id="__span-8-49"><a id="__codelineno-8-49" name="__codelineno-8-49"></a><span class="w">      </span>store_line<span class="w"> </span><span class="s2">"top_cpu,host=</span><span class="si">${</span><span class="nv">host</span><span class="si">}</span><span class="s2">,user=</span><span class="si">${</span><span class="nv">user</span><span class="si">}</span><span class="s2">,command=</span><span class="si">${</span><span class="nv">cmd</span><span class="si">}</span><span class="s2"> value=</span><span class="si">${</span><span class="nv">cpu</span><span class="si">}</span><span class="s2"> </span><span class="si">${</span><span class="nv">ts</span><span class="si">}</span><span class="s2">"</span>
</span><span id="__span-8-50"><a id="__codelineno-8-50" name="__codelineno-8-50"></a><span class="w">    </span><span class="k">fi</span>
</span><span id="__span-8-51"><a id="__codelineno-8-51" name="__codelineno-8-51"></a><span class="w">    </span><span class="c1"># Memory per proccess, only when &gt; 1%</span>
</span><span id="__span-8-52"><a id="__codelineno-8-52" name="__codelineno-8-52"></a><span class="w">    </span><span class="nv">mem</span><span class="o">=</span><span class="k">$(</span>grep<span class="w"> </span><span class="s2">" </span><span class="si">${</span><span class="nv">cmd</span><span class="si">}</span><span class="s2">\$"</span><span class="w"> </span><span class="si">${</span><span class="nv">ptop</span><span class="si">}</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>cut<span class="w"> </span>-f3<span class="w"> </span>-d<span class="s1">' '</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>-v<span class="w"> </span><span class="s1">'^0\.0$'</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>tr<span class="w"> </span><span class="s1">'\n'</span><span class="w"> </span><span class="s1">'+'</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>sed<span class="w"> </span><span class="s1">'s/+$/\n/'</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>bc<span class="w"> </span>-ql<span class="w"> </span><span class="p">|</span><span class="w"> </span>sed<span class="w"> </span><span class="s1">'s/^\./0./'</span><span class="k">)</span>
</span><span id="__span-8-53"><a id="__codelineno-8-53" name="__codelineno-8-53"></a><span class="w">    </span><span class="c1"># Multiply %mem by total system RAM.</span>
</span><span id="__span-8-54"><a id="__codelineno-8-54" name="__codelineno-8-54"></a><span class="w">    </span><span class="nv">tot</span><span class="o">=</span><span class="k">$(</span>free<span class="w"> </span>-b<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span><span class="s1">'Mem:'</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>awk<span class="w"> </span><span class="s1">'{print $2}'</span><span class="k">)</span>
</span><span id="__span-8-55"><a id="__codelineno-8-55" name="__codelineno-8-55"></a><span class="w">    </span><span class="nv">ram</span><span class="o">=</span><span class="k">$(</span>bc<span class="w"> </span>-ql<span class="w"> </span><span class="o">&lt;&lt;&lt;</span><span class="s2">"</span><span class="si">${</span><span class="nv">tot</span><span class="si">}</span><span class="s2"> * </span><span class="si">${</span><span class="nv">mem</span><span class="si">}</span><span class="s2"> / 100"</span><span class="k">)</span>
</span><span id="__span-8-56"><a id="__codelineno-8-56" name="__codelineno-8-56"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="o">[[</span><span class="w"> </span>!<span class="w"> </span>-z<span class="w"> </span><span class="s2">"</span><span class="si">${</span><span class="nv">ram</span><span class="si">}</span><span class="s2">"</span><span class="w"> </span><span class="o">]]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
</span><span id="__span-8-57"><a id="__codelineno-8-57" name="__codelineno-8-57"></a><span class="w">      </span>store_line<span class="w"> </span><span class="s2">"top_mem,host=</span><span class="si">${</span><span class="nv">host</span><span class="si">}</span><span class="s2">,user=</span><span class="si">${</span><span class="nv">user</span><span class="si">}</span><span class="s2">,command=</span><span class="si">${</span><span class="nv">cmd</span><span class="si">}</span><span class="s2"> value=</span><span class="si">${</span><span class="nv">ram</span><span class="si">}</span><span class="s2"> </span><span class="si">${</span><span class="nv">ts</span><span class="si">}</span><span class="s2">"</span>
</span><span id="__span-8-58"><a id="__codelineno-8-58" name="__codelineno-8-58"></a><span class="w">    </span><span class="k">fi</span>
</span><span id="__span-8-59"><a id="__codelineno-8-59" name="__codelineno-8-59"></a><span class="w">  </span><span class="k">done</span>
</span><span id="__span-8-60"><a id="__codelineno-8-60" name="__codelineno-8-60"></a><span class="w">  </span>rm<span class="w"> </span>-f<span class="w"> </span><span class="s2">"</span><span class="si">${</span><span class="nv">ptop</span><span class="si">}</span><span class="s2">"</span>
</span><span id="__span-8-61"><a id="__codelineno-8-61" name="__codelineno-8-61"></a><span class="o">}</span>
</span><span id="__span-8-62"><a id="__codelineno-8-62" name="__codelineno-8-62"></a>
</span><span id="__span-8-63"><a id="__codelineno-8-63" name="__codelineno-8-63"></a>report_top<span class="o">()</span><span class="w"> </span><span class="o">{</span>
</span><span id="__span-8-64"><a id="__codelineno-8-64" name="__codelineno-8-64"></a><span class="w">  </span><span class="c1"># Stats from top: CPU (overall and per process) and RAM (per process).</span>
</span><span id="__span-8-65"><a id="__codelineno-8-65" name="__codelineno-8-65"></a><span class="w">  </span><span class="c1"># Depends on: top, free.</span>
</span><span id="__span-8-66"><a id="__codelineno-8-66" name="__codelineno-8-66"></a><span class="w">  </span><span class="k">while</span><span class="w"> </span>true<span class="p">;</span><span class="w"> </span><span class="k">do</span>
</span><span id="__span-8-67"><a id="__codelineno-8-67" name="__codelineno-8-67"></a><span class="w">    </span><span class="nv">top_cmd</span><span class="o">=</span><span class="k">$(</span><span class="nb">command</span><span class="w"> </span>-v<span class="w"> </span>top<span class="k">)</span>
</span><span id="__span-8-68"><a id="__codelineno-8-68" name="__codelineno-8-68"></a><span class="w">    </span><span class="nv">top</span><span class="o">=</span><span class="s2">"</span><span class="si">${</span><span class="nv">DDIR</span><span class="si">}</span><span class="s2">/top"</span>
</span><span id="__span-8-69"><a id="__codelineno-8-69" name="__codelineno-8-69"></a><span class="w">    </span><span class="nv">ts</span><span class="o">=</span><span class="k">$(</span>timestamp_ns<span class="k">)</span>
</span><span id="__span-8-70"><a id="__codelineno-8-70" name="__codelineno-8-70"></a><span class="w">    </span><span class="si">${</span><span class="nv">top_cmd</span><span class="si">}</span><span class="w"> </span>-b<span class="w"> </span>-c<span class="w"> </span>-n<span class="w"> </span><span class="m">1</span><span class="w"> </span>-w<span class="w"> </span><span class="m">512</span><span class="w"> </span><span class="p">|</span>
</span><span id="__span-8-71"><a id="__codelineno-8-71" name="__codelineno-8-71"></a><span class="w">      </span>grep<span class="w"> </span>-vE<span class="w"> </span><span class="s1">' 0\..   0\..|^top|^Tasks|^%|^MiB|^$|[[:blank:]]*PID USER'</span><span class="w"> </span><span class="p">|</span>
</span><span id="__span-8-72"><a id="__codelineno-8-72" name="__codelineno-8-72"></a><span class="w">      </span>awk<span class="w"> </span><span class="s1">'{print $2,$9,$10,$12,$13,$14,$15,$16,$17,$18,$19,$20}'</span><span class="w"> </span><span class="p">|</span>
</span><span id="__span-8-73"><a id="__codelineno-8-73" name="__codelineno-8-73"></a><span class="w">      </span>tr<span class="w"> </span><span class="s1">'\\'</span><span class="w"> </span><span class="s1">'/'</span><span class="w"> </span><span class="p">|</span>
</span><span id="__span-8-74"><a id="__codelineno-8-74" name="__codelineno-8-74"></a><span class="w">      </span>sed<span class="w"> </span><span class="s1">'s/\.minecraft\/bin\/[0-9a-f]\+.*/minecraft/'</span><span class="w"> </span><span class="p">|</span>
</span><span id="__span-8-75"><a id="__codelineno-8-75" name="__codelineno-8-75"></a><span class="w">      </span>sed<span class="w"> </span><span class="s1">'s/[C-Z]:\/.*\/\([a-zA-Z0-9 _-]\+\.[a-z][a-z][a-z]\).*/\1/'</span><span class="w"> </span><span class="p">|</span>
</span><span id="__span-8-76"><a id="__codelineno-8-76" name="__codelineno-8-76"></a><span class="w">      </span>sed<span class="w"> </span><span class="s1">'s/\/[^ ]*\///'</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>sed<span class="w"> </span><span class="s1">'s/\(bash\|sh\|python\|python3\) .*\///'</span><span class="w"> </span><span class="p">|</span>
</span><span id="__span-8-77"><a id="__codelineno-8-77" name="__codelineno-8-77"></a><span class="w">      </span>tr<span class="w"> </span>-d<span class="w"> </span><span class="s1">'['</span><span class="w"> </span><span class="p">|</span>
</span><span id="__span-8-78"><a id="__codelineno-8-78" name="__codelineno-8-78"></a><span class="w">      </span>tr<span class="w"> </span>-d<span class="w"> </span><span class="s1">']'</span><span class="w"> </span><span class="p">|</span>
</span><span id="__span-8-79"><a id="__codelineno-8-79" name="__codelineno-8-79"></a><span class="w">      </span>awk<span class="w"> </span><span class="s1">'{print $1,$2,$3,$4}'</span><span class="w"> </span>&gt;<span class="s2">"</span><span class="si">${</span><span class="nv">top</span><span class="si">}</span><span class="s2">"</span>
</span><span id="__span-8-80"><a id="__codelineno-8-80" name="__codelineno-8-80"></a><span class="w">    </span><span class="c1"># Total CPU(%) usage.</span>
</span><span id="__span-8-81"><a id="__codelineno-8-81" name="__codelineno-8-81"></a><span class="w">    </span><span class="nv">cpu_load</span><span class="o">=</span><span class="k">$(</span>awk<span class="w"> </span><span class="s1">'{print $2}'</span><span class="w"> </span><span class="si">${</span><span class="nv">top</span><span class="si">}</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>-v<span class="w"> </span><span class="s1">'^0\.0$'</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>tr<span class="w"> </span><span class="s1">'\n'</span><span class="w"> </span><span class="s1">'+'</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>sed<span class="w"> </span><span class="s1">'s/+$/\n/'</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>bc<span class="w"> </span>-ql<span class="k">)</span>
</span><span id="__span-8-82"><a id="__codelineno-8-82" name="__codelineno-8-82"></a><span class="w">    </span>store_line<span class="w"> </span><span class="s2">"top,host=</span><span class="si">${</span><span class="nv">host</span><span class="si">}</span><span class="s2"> value=</span><span class="si">${</span><span class="nv">cpu_load</span><span class="si">}</span><span class="s2"> </span><span class="si">${</span><span class="nv">ts</span><span class="si">}</span><span class="s2">"</span>
</span><span id="__span-8-83"><a id="__codelineno-8-83" name="__codelineno-8-83"></a><span class="w">    </span><span class="c1"># Launch the slower per-process metrics in the background.</span>
</span><span id="__span-8-84"><a id="__codelineno-8-84" name="__codelineno-8-84"></a><span class="w">    </span><span class="nv">ptop</span><span class="o">=</span><span class="s2">"</span><span class="si">${</span><span class="nv">top</span><span class="si">}</span><span class="s2">.</span><span class="nv">$RANDOM</span><span class="s2">"</span>
</span><span id="__span-8-85"><a id="__codelineno-8-85" name="__codelineno-8-85"></a><span class="w">    </span>mv<span class="w"> </span><span class="s2">"</span><span class="si">${</span><span class="nv">top</span><span class="si">}</span><span class="s2">"</span><span class="w"> </span><span class="s2">"</span><span class="si">${</span><span class="nv">ptop</span><span class="si">}</span><span class="s2">"</span>
</span><span id="__span-8-86"><a id="__codelineno-8-86" name="__codelineno-8-86"></a><span class="w">    </span>report_top_per_process<span class="w"> </span><span class="s2">"</span><span class="si">${</span><span class="nv">ts</span><span class="si">}</span><span class="s2">"</span><span class="w"> </span><span class="s2">"</span><span class="si">${</span><span class="nv">ptop</span><span class="si">}</span><span class="s2">"</span><span class="w"> </span><span class="p">&amp;</span>
</span><span id="__span-8-87"><a id="__codelineno-8-87" name="__codelineno-8-87"></a><span class="w">    </span>sleep<span class="w"> </span><span class="si">${</span><span class="nv">DELAY_TOP</span><span class="si">}</span>
</span><span id="__span-8-88"><a id="__codelineno-8-88" name="__codelineno-8-88"></a><span class="w">  </span><span class="k">done</span>
</span><span id="__span-8-89"><a id="__codelineno-8-89" name="__codelineno-8-89"></a><span class="o">}</span>
</span><span id="__span-8-90"><a id="__codelineno-8-90" name="__codelineno-8-90"></a>
</span><span id="__span-8-91"><a id="__codelineno-8-91" name="__codelineno-8-91"></a>report_vcgencmd<span class="o">()</span><span class="w"> </span><span class="o">{</span>
</span><span id="__span-8-92"><a id="__codelineno-8-92" name="__codelineno-8-92"></a><span class="w">  </span><span class="c1"># Raspberry Pi CPU temperature.</span>
</span><span id="__span-8-93"><a id="__codelineno-8-93" name="__codelineno-8-93"></a><span class="w">  </span><span class="c1"># Depends on: vcgencmd.</span>
</span><span id="__span-8-94"><a id="__codelineno-8-94" name="__codelineno-8-94"></a><span class="w">  </span><span class="nv">vcgencmd</span><span class="o">=</span><span class="k">$(</span><span class="nb">command</span><span class="w"> </span>-v<span class="w"> </span>vcgencmd<span class="k">)</span>
</span><span id="__span-8-95"><a id="__codelineno-8-95" name="__codelineno-8-95"></a><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span>-z<span class="w"> </span><span class="s2">"</span><span class="si">${</span><span class="nv">vcgencmd</span><span class="si">}</span><span class="s2">"</span><span class="w"> </span><span class="o">]</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="o">[</span><span class="w"> </span>!<span class="w"> </span>-f<span class="w"> </span><span class="s2">"</span><span class="si">${</span><span class="nv">vcgencmd</span><span class="si">}</span><span class="s2">"</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
</span><span id="__span-8-96"><a id="__codelineno-8-96" name="__codelineno-8-96"></a><span class="w">    </span><span class="k">return</span>
</span><span id="__span-8-97"><a id="__codelineno-8-97" name="__codelineno-8-97"></a><span class="w">  </span><span class="k">fi</span>
</span><span id="__span-8-98"><a id="__codelineno-8-98" name="__codelineno-8-98"></a><span class="w">  </span><span class="k">while</span><span class="w"> </span>true<span class="p">;</span><span class="w"> </span><span class="k">do</span>
</span><span id="__span-8-99"><a id="__codelineno-8-99" name="__codelineno-8-99"></a><span class="w">    </span><span class="nv">ts</span><span class="o">=</span><span class="k">$(</span>timestamp_ns<span class="k">)</span>
</span><span id="__span-8-100"><a id="__codelineno-8-100" name="__codelineno-8-100"></a><span class="w">    </span><span class="nv">cpu_temp</span><span class="o">=</span><span class="k">$(</span><span class="si">${</span><span class="nv">vcgencmd</span><span class="si">}</span><span class="w"> </span>measure_temp<span class="w"> </span><span class="p">|</span><span class="w"> </span>cut<span class="w"> </span>-f2<span class="w"> </span>-d<span class="o">=</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>cut<span class="w"> </span>-f1<span class="w"> </span>-d<span class="s2">"'"</span><span class="k">)</span>
</span><span id="__span-8-101"><a id="__codelineno-8-101" name="__codelineno-8-101"></a><span class="w">    </span>store_line<span class="w"> </span><span class="s2">"vcgencmd,metric=temp,host=</span><span class="si">${</span><span class="nv">host</span><span class="si">}</span><span class="s2"> value=</span><span class="si">${</span><span class="nv">cpu_temp</span><span class="si">}</span><span class="s2"> </span><span class="si">${</span><span class="nv">ts</span><span class="si">}</span><span class="s2">"</span>
</span><span id="__span-8-102"><a id="__codelineno-8-102" name="__codelineno-8-102"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span>grep<span class="w"> </span>-q<span class="w"> </span><span class="s1">'Pi 4'</span><span class="w"> </span>/proc/device-tree/model<span class="p">;</span><span class="w"> </span><span class="k">then</span>
</span><span id="__span-8-103"><a id="__codelineno-8-103" name="__codelineno-8-103"></a><span class="w">      </span><span class="nv">ts</span><span class="o">=</span><span class="k">$(</span>timestamp_ns<span class="k">)</span>
</span><span id="__span-8-104"><a id="__codelineno-8-104" name="__codelineno-8-104"></a><span class="w">      </span><span class="nv">pmic_temp</span><span class="o">=</span><span class="k">$(</span><span class="si">${</span><span class="nv">vcgencmd</span><span class="si">}</span><span class="w"> </span>measure_temp<span class="w"> </span>pmic<span class="w"> </span><span class="p">|</span><span class="w"> </span>cut<span class="w"> </span>-f2<span class="w"> </span>-d<span class="o">=</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>cut<span class="w"> </span>-f1<span class="w"> </span>-d<span class="s2">"'"</span><span class="k">)</span>
</span><span id="__span-8-105"><a id="__codelineno-8-105" name="__codelineno-8-105"></a><span class="w">      </span>store_line<span class="w"> </span><span class="s2">"vcgencmd,metric=temp_pmic,host=</span><span class="si">${</span><span class="nv">host</span><span class="si">}</span><span class="s2"> value=</span><span class="si">${</span><span class="nv">pmic_temp</span><span class="si">}</span><span class="s2"> </span><span class="si">${</span><span class="nv">ts</span><span class="si">}</span><span class="s2">"</span>
</span><span id="__span-8-106"><a id="__codelineno-8-106" name="__codelineno-8-106"></a><span class="w">    </span><span class="k">fi</span>
</span><span id="__span-8-107"><a id="__codelineno-8-107" name="__codelineno-8-107"></a><span class="w">    </span>cat<span class="w"> </span><span class="s2">"</span><span class="si">${</span><span class="nv">DATA</span><span class="si">}</span><span class="s2">"</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>cut<span class="w"> </span>-f1<span class="w"> </span>-d,<span class="w"> </span><span class="p">|</span><span class="w"> </span>sort<span class="w"> </span><span class="p">|</span><span class="w"> </span>uniq<span class="w"> </span>-c
</span><span id="__span-8-108"><a id="__codelineno-8-108" name="__codelineno-8-108"></a><span class="w">    </span>sleep<span class="w"> </span><span class="si">${</span><span class="nv">DELAY_FAST</span><span class="si">}</span>
</span><span id="__span-8-109"><a id="__codelineno-8-109" name="__codelineno-8-109"></a><span class="w">  </span><span class="k">done</span>
</span><span id="__span-8-110"><a id="__codelineno-8-110" name="__codelineno-8-110"></a><span class="o">}</span>
</span><span id="__span-8-111"><a id="__codelineno-8-111" name="__codelineno-8-111"></a>
</span><span id="__span-8-112"><a id="__codelineno-8-112" name="__codelineno-8-112"></a>report_sensors<span class="o">()</span><span class="w"> </span><span class="o">{</span>
</span><span id="__span-8-113"><a id="__codelineno-8-113" name="__codelineno-8-113"></a><span class="w">  </span><span class="c1"># CPU, SSD, NVMe temperatures and other sensors (if available).</span>
</span><span id="__span-8-114"><a id="__codelineno-8-114" name="__codelineno-8-114"></a><span class="w">  </span><span class="c1"># Depends on: jq, sensors.</span>
</span><span id="__span-8-115"><a id="__codelineno-8-115" name="__codelineno-8-115"></a><span class="w">  </span><span class="nv">jq</span><span class="o">=</span><span class="k">$(</span><span class="nb">command</span><span class="w"> </span>-v<span class="w"> </span>jq<span class="k">)</span>
</span><span id="__span-8-116"><a id="__codelineno-8-116" name="__codelineno-8-116"></a><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span>-z<span class="w"> </span><span class="s2">"</span><span class="si">${</span><span class="nv">jq</span><span class="si">}</span><span class="s2">"</span><span class="w"> </span><span class="o">]</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="o">[</span><span class="w"> </span>!<span class="w"> </span>-f<span class="w"> </span><span class="s2">"</span><span class="si">${</span><span class="nv">jq</span><span class="si">}</span><span class="s2">"</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
</span><span id="__span-8-117"><a id="__codelineno-8-117" name="__codelineno-8-117"></a><span class="w">    </span><span class="k">return</span>
</span><span id="__span-8-118"><a id="__codelineno-8-118" name="__codelineno-8-118"></a><span class="w">  </span><span class="k">fi</span>
</span><span id="__span-8-119"><a id="__codelineno-8-119" name="__codelineno-8-119"></a><span class="w">  </span><span class="nv">sensors</span><span class="o">=</span><span class="k">$(</span><span class="nb">command</span><span class="w"> </span>-v<span class="w"> </span>sensors<span class="k">)</span>
</span><span id="__span-8-120"><a id="__codelineno-8-120" name="__codelineno-8-120"></a><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span>-z<span class="w"> </span><span class="s2">"</span><span class="si">${</span><span class="nv">sensors</span><span class="si">}</span><span class="s2">"</span><span class="w"> </span><span class="o">]</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="o">[</span><span class="w"> </span>!<span class="w"> </span>-f<span class="w"> </span><span class="s2">"</span><span class="si">${</span><span class="nv">sensors</span><span class="si">}</span><span class="s2">"</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
</span><span id="__span-8-121"><a id="__codelineno-8-121" name="__codelineno-8-121"></a><span class="w">    </span><span class="k">return</span>
</span><span id="__span-8-122"><a id="__codelineno-8-122" name="__codelineno-8-122"></a><span class="w">  </span><span class="k">fi</span>
</span><span id="__span-8-123"><a id="__codelineno-8-123" name="__codelineno-8-123"></a><span class="w">  </span><span class="nv">sensors_json</span><span class="o">=</span><span class="s2">"</span><span class="si">${</span><span class="nv">DDIR</span><span class="si">}</span><span class="s2">/sensors"</span>
</span><span id="__span-8-124"><a id="__codelineno-8-124" name="__codelineno-8-124"></a><span class="w">  </span><span class="k">while</span><span class="w"> </span>true<span class="p">;</span><span class="w"> </span><span class="k">do</span>
</span><span id="__span-8-125"><a id="__codelineno-8-125" name="__codelineno-8-125"></a><span class="w">    </span><span class="nv">ts</span><span class="o">=</span><span class="k">$(</span>timestamp_ns<span class="k">)</span>
</span><span id="__span-8-126"><a id="__codelineno-8-126" name="__codelineno-8-126"></a><span class="w">    </span><span class="s2">"</span><span class="si">${</span><span class="nv">sensors</span><span class="si">}</span><span class="s2">"</span><span class="w"> </span>-j<span class="w"> </span>&gt;<span class="s2">"</span><span class="si">${</span><span class="nv">sensors_json</span><span class="si">}</span><span class="s2">"</span>
</span><span id="__span-8-127"><a id="__codelineno-8-127" name="__codelineno-8-127"></a><span class="w">    </span><span class="nv">$jq</span><span class="w"> </span><span class="s1">'keys'</span><span class="w"> </span><span class="s2">"</span><span class="si">${</span><span class="nv">sensors_json</span><span class="si">}</span><span class="s2">"</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span><span class="s1">'^  "'</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>cut<span class="w"> </span>-f2<span class="w"> </span>-d<span class="s1">'"'</span><span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="k">while</span><span class="w"> </span><span class="nb">read</span><span class="w"> </span>adapter<span class="p">;</span><span class="w"> </span><span class="k">do</span>
</span><span id="__span-8-128"><a id="__codelineno-8-128" name="__codelineno-8-128"></a><span class="w">      </span><span class="nb">echo</span><span class="w"> </span><span class="s2">"adapter: </span><span class="nv">$adapter</span><span class="s2">"</span>
</span><span id="__span-8-129"><a id="__codelineno-8-129" name="__codelineno-8-129"></a><span class="w">      </span><span class="nv">$jq</span><span class="w"> </span><span class="s2">".\"</span><span class="si">${</span><span class="nv">adapter</span><span class="si">}</span><span class="s2">\""</span><span class="w"> </span><span class="s2">"</span><span class="si">${</span><span class="nv">sensors_json</span><span class="si">}</span><span class="s2">"</span><span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="nv">$jq</span><span class="w"> </span><span class="s1">'keys'</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span><span class="s1">'^  "'</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>-v<span class="w"> </span><span class="s1">'"Adapter"'</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>cut<span class="w"> </span>-f2<span class="w"> </span>-d<span class="s1">'"'</span><span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="k">while</span><span class="w"> </span><span class="nb">read</span><span class="w"> </span>name<span class="p">;</span><span class="w"> </span><span class="k">do</span>
</span><span id="__span-8-130"><a id="__codelineno-8-130" name="__codelineno-8-130"></a><span class="w">        </span><span class="nv">key</span><span class="o">=</span><span class="k">$(</span><span class="nv">$jq</span><span class="w"> </span><span class="s2">".\"</span><span class="si">${</span><span class="nv">adapter</span><span class="si">}</span><span class="s2">\".\"</span><span class="si">${</span><span class="nv">name</span><span class="si">}</span><span class="s2">\""</span><span class="w"> </span><span class="s2">"</span><span class="si">${</span><span class="nv">sensors_json</span><span class="si">}</span><span class="s2">"</span><span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="nv">$jq</span><span class="w"> </span><span class="s1">'keys'</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span><span class="s1">'^  "'</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span><span class="s1">'_input"'</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>cut<span class="w"> </span>-f2<span class="w"> </span>-d<span class="s1">'"'</span><span class="k">)</span>
</span><span id="__span-8-131"><a id="__codelineno-8-131" name="__codelineno-8-131"></a><span class="w">        </span><span class="nv">value</span><span class="o">=</span><span class="k">$(</span><span class="nv">$jq</span><span class="w"> </span><span class="s2">".\"</span><span class="si">${</span><span class="nv">adapter</span><span class="si">}</span><span class="s2">\".\"</span><span class="si">${</span><span class="nv">name</span><span class="si">}</span><span class="s2">\".\"</span><span class="si">${</span><span class="nv">key</span><span class="si">}</span><span class="s2">\""</span><span class="w"> </span><span class="s2">"</span><span class="si">${</span><span class="nv">sensors_json</span><span class="si">}</span><span class="s2">"</span><span class="k">)</span>
</span><span id="__span-8-132"><a id="__codelineno-8-132" name="__codelineno-8-132"></a><span class="w">        </span>store_line<span class="w"> </span><span class="s2">"sensors,host=</span><span class="si">${</span><span class="nv">host</span><span class="si">}</span><span class="s2">,adapter=</span><span class="si">${</span><span class="nv">adapter</span><span class="si">}</span><span class="s2">,name=</span><span class="si">${</span><span class="nv">name</span><span class="p">/ /_</span><span class="si">}</span><span class="s2"> value=</span><span class="si">${</span><span class="nv">value</span><span class="si">}</span><span class="s2"> </span><span class="si">${</span><span class="nv">ts</span><span class="si">}</span><span class="s2">"</span>
</span><span id="__span-8-133"><a id="__codelineno-8-133" name="__codelineno-8-133"></a><span class="w">      </span><span class="k">done</span>
</span><span id="__span-8-134"><a id="__codelineno-8-134" name="__codelineno-8-134"></a><span class="w">    </span><span class="k">done</span>
</span><span id="__span-8-135"><a id="__codelineno-8-135" name="__codelineno-8-135"></a><span class="w">    </span>sleep<span class="w"> </span><span class="si">${</span><span class="nv">DELAY_FAST</span><span class="si">}</span>
</span><span id="__span-8-136"><a id="__codelineno-8-136" name="__codelineno-8-136"></a><span class="w">  </span><span class="k">done</span>
</span><span id="__span-8-137"><a id="__codelineno-8-137" name="__codelineno-8-137"></a><span class="o">}</span>
</span><span id="__span-8-138"><a id="__codelineno-8-138" name="__codelineno-8-138"></a>
</span><span id="__span-8-139"><a id="__codelineno-8-139" name="__codelineno-8-139"></a>report_intel_gpu_top<span class="o">()</span><span class="w"> </span><span class="o">{</span>
</span><span id="__span-8-140"><a id="__codelineno-8-140" name="__codelineno-8-140"></a><span class="w">  </span><span class="c1"># Intel GPU.</span>
</span><span id="__span-8-141"><a id="__codelineno-8-141" name="__codelineno-8-141"></a><span class="w">  </span><span class="c1"># Depends on: intel_gpu_top (as root).</span>
</span><span id="__span-8-142"><a id="__codelineno-8-142" name="__codelineno-8-142"></a><span class="w">  </span><span class="nv">intel_gpu_top</span><span class="o">=</span><span class="k">$(</span><span class="nb">command</span><span class="w"> </span>-v<span class="w"> </span>intel_gpu_top<span class="k">)</span>
</span><span id="__span-8-143"><a id="__codelineno-8-143" name="__codelineno-8-143"></a><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span>-z<span class="w"> </span><span class="nv">$intel_gpu_top</span><span class="w"> </span><span class="o">]</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="o">[</span><span class="w"> </span>!<span class="w"> </span>-f<span class="w"> </span><span class="nv">$intel_gpu_top</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
</span><span id="__span-8-144"><a id="__codelineno-8-144" name="__codelineno-8-144"></a><span class="w">    </span><span class="k">return</span>
</span><span id="__span-8-145"><a id="__codelineno-8-145" name="__codelineno-8-145"></a><span class="w">  </span><span class="k">fi</span>
</span><span id="__span-8-146"><a id="__codelineno-8-146" name="__codelineno-8-146"></a><span class="w">  </span><span class="k">while</span><span class="w"> </span>true<span class="p">;</span><span class="w"> </span><span class="k">do</span>
</span><span id="__span-8-147"><a id="__codelineno-8-147" name="__codelineno-8-147"></a><span class="w">    </span><span class="nv">ts</span><span class="o">=</span><span class="k">$(</span>timestamp_ns<span class="k">)</span>
</span><span id="__span-8-148"><a id="__codelineno-8-148" name="__codelineno-8-148"></a><span class="w">    </span><span class="c1"># TODO: try with -J and find the most meaningful metrics.</span>
</span><span id="__span-8-149"><a id="__codelineno-8-149" name="__codelineno-8-149"></a><span class="w">    </span><span class="nv">gpu_load</span><span class="o">=</span><span class="k">$(</span>sudo<span class="w"> </span><span class="si">${</span><span class="nv">intel_gpu_top</span><span class="si">}</span><span class="w"> </span>-o<span class="w"> </span>-<span class="w"> </span><span class="p">|</span><span class="w"> </span>head<span class="w"> </span>-3<span class="w"> </span><span class="p">|</span><span class="w"> </span>tail<span class="w"> </span>-1<span class="w"> </span><span class="p">|</span><span class="w"> </span>awk<span class="w"> </span><span class="s1">'{print $2}'</span><span class="k">)</span>
</span><span id="__span-8-150"><a id="__codelineno-8-150" name="__codelineno-8-150"></a><span class="w">    </span>store_line<span class="w"> </span><span class="s2">"intel_gpu,host=</span><span class="si">${</span><span class="nv">host</span><span class="si">}</span><span class="s2"> value=</span><span class="si">${</span><span class="nv">value</span><span class="si">}</span><span class="s2"> </span><span class="si">${</span><span class="nv">ts</span><span class="si">}</span><span class="s2">"</span>
</span><span id="__span-8-151"><a id="__codelineno-8-151" name="__codelineno-8-151"></a><span class="w">    </span>sleep<span class="w"> </span><span class="si">${</span><span class="nv">DELAY_FAST</span><span class="si">}</span>
</span><span id="__span-8-152"><a id="__codelineno-8-152" name="__codelineno-8-152"></a><span class="w">  </span><span class="k">done</span>
</span><span id="__span-8-153"><a id="__codelineno-8-153" name="__codelineno-8-153"></a><span class="o">}</span>
</span><span id="__span-8-154"><a id="__codelineno-8-154" name="__codelineno-8-154"></a>
</span><span id="__span-8-155"><a id="__codelineno-8-155" name="__codelineno-8-155"></a>report_nvidia_smi<span class="o">()</span><span class="w"> </span><span class="o">{</span>
</span><span id="__span-8-156"><a id="__codelineno-8-156" name="__codelineno-8-156"></a><span class="w">  </span><span class="c1"># NVidia GPU.</span>
</span><span id="__span-8-157"><a id="__codelineno-8-157" name="__codelineno-8-157"></a><span class="w">  </span><span class="c1"># Depends on: nvidia-smi</span>
</span><span id="__span-8-158"><a id="__codelineno-8-158" name="__codelineno-8-158"></a><span class="w">  </span><span class="nv">nvidia_smi</span><span class="o">=</span><span class="k">$(</span><span class="nb">command</span><span class="w"> </span>-v<span class="w"> </span>nvidia-smi<span class="k">)</span>
</span><span id="__span-8-159"><a id="__codelineno-8-159" name="__codelineno-8-159"></a><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span>-z<span class="w"> </span><span class="s2">"</span><span class="si">${</span><span class="nv">nvidia_smi</span><span class="si">}</span><span class="s2">"</span><span class="w"> </span><span class="o">]</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="o">[</span><span class="w"> </span>!<span class="w"> </span>-f<span class="w"> </span><span class="s2">"</span><span class="si">${</span><span class="nv">nvidia_smi</span><span class="si">}</span><span class="s2">"</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
</span><span id="__span-8-160"><a id="__codelineno-8-160" name="__codelineno-8-160"></a><span class="w">    </span><span class="k">return</span>
</span><span id="__span-8-161"><a id="__codelineno-8-161" name="__codelineno-8-161"></a><span class="w">  </span><span class="k">fi</span>
</span><span id="__span-8-162"><a id="__codelineno-8-162" name="__codelineno-8-162"></a><span class="w">  </span><span class="k">while</span><span class="w"> </span>true<span class="p">;</span><span class="w"> </span><span class="k">do</span>
</span><span id="__span-8-163"><a id="__codelineno-8-163" name="__codelineno-8-163"></a><span class="w">    </span><span class="nv">ts</span><span class="o">=</span><span class="k">$(</span>timestamp_ns<span class="k">)</span>
</span><span id="__span-8-164"><a id="__codelineno-8-164" name="__codelineno-8-164"></a><span class="w">    </span><span class="nv">temp</span><span class="o">=</span><span class="k">$(</span><span class="si">${</span><span class="nv">nvidia_smi</span><span class="si">}</span><span class="w"> </span>-i<span class="w"> </span><span class="m">0</span><span class="w"> </span>--query-gpu<span class="o">=</span>temperature.gpu<span class="w"> </span>--format<span class="o">=</span>csv,noheader<span class="k">)</span>
</span><span id="__span-8-165"><a id="__codelineno-8-165" name="__codelineno-8-165"></a><span class="w">    </span><span class="nv">util</span><span class="o">=</span><span class="k">$(</span><span class="si">${</span><span class="nv">nvidia_smi</span><span class="si">}</span><span class="w"> </span>-i<span class="w"> </span><span class="m">0</span><span class="w"> </span>--query-gpu<span class="o">=</span>utilization.gpu<span class="w"> </span>--format<span class="o">=</span>csv,noheader<span class="w"> </span><span class="p">|</span><span class="w"> </span>cut<span class="w"> </span>-f1<span class="w"> </span>-d<span class="s1">' '</span><span class="k">)</span>
</span><span id="__span-8-166"><a id="__codelineno-8-166" name="__codelineno-8-166"></a><span class="w">    </span><span class="nv">vram</span><span class="o">=</span><span class="k">$(</span><span class="si">${</span><span class="nv">nvidia_smi</span><span class="si">}</span><span class="w"> </span>-i<span class="w"> </span><span class="m">0</span><span class="w"> </span>--query-gpu<span class="o">=</span>memory.used<span class="w"> </span>--format<span class="o">=</span>csv,noheader<span class="w"> </span><span class="p">|</span><span class="w"> </span>cut<span class="w"> </span>-f1<span class="w"> </span>-d<span class="s1">' '</span><span class="k">)</span>
</span><span id="__span-8-167"><a id="__codelineno-8-167" name="__codelineno-8-167"></a><span class="w">    </span><span class="nv">draw</span><span class="o">=</span><span class="k">$(</span><span class="si">${</span><span class="nv">nvidia_smi</span><span class="si">}</span><span class="w"> </span>-i<span class="w"> </span><span class="m">0</span><span class="w"> </span>--query-gpu<span class="o">=</span>power.draw<span class="w"> </span>--format<span class="o">=</span>csv,noheader<span class="w"> </span><span class="p">|</span><span class="w"> </span>cut<span class="w"> </span>-f1<span class="w"> </span>-d<span class="s1">' '</span><span class="k">)</span>
</span><span id="__span-8-168"><a id="__codelineno-8-168" name="__codelineno-8-168"></a><span class="w">    </span><span class="nv">fans</span><span class="o">=</span><span class="k">$(</span><span class="si">${</span><span class="nv">nvidia_smi</span><span class="si">}</span><span class="w"> </span>-i<span class="w"> </span><span class="m">0</span><span class="w"> </span>--query-gpu<span class="o">=</span>fan.speed<span class="w"> </span>--format<span class="o">=</span>csv,noheader<span class="w"> </span><span class="p">|</span><span class="w"> </span>cut<span class="w"> </span>-f1<span class="w"> </span>-d<span class="s1">' '</span><span class="k">)</span>
</span><span id="__span-8-169"><a id="__codelineno-8-169" name="__codelineno-8-169"></a><span class="w">    </span>store_line<span class="w"> </span><span class="s2">"nvidia_smi,host=</span><span class="si">${</span><span class="nv">host</span><span class="si">}</span><span class="s2">,metric=temperature value=</span><span class="si">${</span><span class="nv">temp</span><span class="si">}</span><span class="s2"> </span><span class="si">${</span><span class="nv">ts</span><span class="si">}</span><span class="s2">"</span>
</span><span id="__span-8-170"><a id="__codelineno-8-170" name="__codelineno-8-170"></a><span class="w">    </span>store_line<span class="w"> </span><span class="s2">"nvidia_smi,host=</span><span class="si">${</span><span class="nv">host</span><span class="si">}</span><span class="s2">,metric=utilization value=</span><span class="si">${</span><span class="nv">util</span><span class="si">}</span><span class="s2"> </span><span class="si">${</span><span class="nv">ts</span><span class="si">}</span><span class="s2">"</span>
</span><span id="__span-8-171"><a id="__codelineno-8-171" name="__codelineno-8-171"></a><span class="w">    </span>store_line<span class="w"> </span><span class="s2">"nvidia_smi,host=</span><span class="si">${</span><span class="nv">host</span><span class="si">}</span><span class="s2">,metric=memory value=</span><span class="si">${</span><span class="nv">vram</span><span class="si">}</span><span class="s2"> </span><span class="si">${</span><span class="nv">ts</span><span class="si">}</span><span class="s2">"</span>
</span><span id="__span-8-172"><a id="__codelineno-8-172" name="__codelineno-8-172"></a><span class="w">    </span>store_line<span class="w"> </span><span class="s2">"nvidia_smi,host=</span><span class="si">${</span><span class="nv">host</span><span class="si">}</span><span class="s2">,metric=power value=</span><span class="si">${</span><span class="nv">draw</span><span class="si">}</span><span class="s2"> </span><span class="si">${</span><span class="nv">ts</span><span class="si">}</span><span class="s2">"</span>
</span><span id="__span-8-173"><a id="__codelineno-8-173" name="__codelineno-8-173"></a><span class="w">    </span>store_line<span class="w"> </span><span class="s2">"nvidia_smi,host=</span><span class="si">${</span><span class="nv">host</span><span class="si">}</span><span class="s2">,metric=fan value=</span><span class="si">${</span><span class="nv">fans</span><span class="si">}</span><span class="s2"> </span><span class="si">${</span><span class="nv">ts</span><span class="si">}</span><span class="s2">"</span>
</span><span id="__span-8-174"><a id="__codelineno-8-174" name="__codelineno-8-174"></a><span class="w">    </span>sleep<span class="w"> </span><span class="si">${</span><span class="nv">DELAY_FAST</span><span class="si">}</span>
</span><span id="__span-8-175"><a id="__codelineno-8-175" name="__codelineno-8-175"></a><span class="w">  </span><span class="k">done</span>
</span><span id="__span-8-176"><a id="__codelineno-8-176" name="__codelineno-8-176"></a><span class="o">}</span>
</span><span id="__span-8-177"><a id="__codelineno-8-177" name="__codelineno-8-177"></a>
</span><span id="__span-8-178"><a id="__codelineno-8-178" name="__codelineno-8-178"></a>report_free<span class="o">()</span><span class="w"> </span><span class="o">{</span>
</span><span id="__span-8-179"><a id="__codelineno-8-179" name="__codelineno-8-179"></a><span class="w">  </span><span class="c1"># Stats from free: RAM used, buffered/cached, free.</span>
</span><span id="__span-8-180"><a id="__codelineno-8-180" name="__codelineno-8-180"></a><span class="w">  </span><span class="c1"># Depends on: free.</span>
</span><span id="__span-8-181"><a id="__codelineno-8-181" name="__codelineno-8-181"></a><span class="w">  </span><span class="k">while</span><span class="w"> </span>true<span class="p">;</span><span class="w"> </span><span class="k">do</span>
</span><span id="__span-8-182"><a id="__codelineno-8-182" name="__codelineno-8-182"></a><span class="w">    </span><span class="nv">ts</span><span class="o">=</span><span class="k">$(</span>timestamp_ns<span class="k">)</span>
</span><span id="__span-8-183"><a id="__codelineno-8-183" name="__codelineno-8-183"></a><span class="w">    </span><span class="nv">mem_used</span><span class="o">=</span><span class="k">$(</span>free<span class="w"> </span>-b<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span><span class="s1">'Mem:'</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>awk<span class="w"> </span><span class="s1">'{print $3}'</span><span class="k">)</span>
</span><span id="__span-8-184"><a id="__codelineno-8-184" name="__codelineno-8-184"></a><span class="w">    </span><span class="nv">mem_free</span><span class="o">=</span><span class="k">$(</span>free<span class="w"> </span>-b<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span><span class="s1">'Mem:'</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>awk<span class="w"> </span><span class="s1">'{print $4}'</span><span class="k">)</span>
</span><span id="__span-8-185"><a id="__codelineno-8-185" name="__codelineno-8-185"></a><span class="w">    </span><span class="nv">mem_buff</span><span class="o">=</span><span class="k">$(</span>free<span class="w"> </span>-b<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span><span class="s1">'Mem:'</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>awk<span class="w"> </span><span class="s1">'{print $6}'</span><span class="k">)</span>
</span><span id="__span-8-186"><a id="__codelineno-8-186" name="__codelineno-8-186"></a><span class="w">    </span>store_line<span class="w"> </span><span class="s2">"free,host=</span><span class="si">${</span><span class="nv">host</span><span class="si">}</span><span class="s2">,metric=used value=</span><span class="si">${</span><span class="nv">mem_used</span><span class="si">}</span><span class="s2"> </span><span class="si">${</span><span class="nv">ts</span><span class="si">}</span><span class="s2">"</span>
</span><span id="__span-8-187"><a id="__codelineno-8-187" name="__codelineno-8-187"></a><span class="w">    </span>store_line<span class="w"> </span><span class="s2">"free,host=</span><span class="si">${</span><span class="nv">host</span><span class="si">}</span><span class="s2">,metric=free value=</span><span class="si">${</span><span class="nv">mem_free</span><span class="si">}</span><span class="s2"> </span><span class="si">${</span><span class="nv">ts</span><span class="si">}</span><span class="s2">"</span>
</span><span id="__span-8-188"><a id="__codelineno-8-188" name="__codelineno-8-188"></a><span class="w">    </span>store_line<span class="w"> </span><span class="s2">"free,host=</span><span class="si">${</span><span class="nv">host</span><span class="si">}</span><span class="s2">,metric=buff_cache value=</span><span class="si">${</span><span class="nv">mem_buff</span><span class="si">}</span><span class="s2"> </span><span class="si">${</span><span class="nv">ts</span><span class="si">}</span><span class="s2">"</span>
</span><span id="__span-8-189"><a id="__codelineno-8-189" name="__codelineno-8-189"></a><span class="w">    </span>sleep<span class="w"> </span><span class="si">${</span><span class="nv">DELAY_FAST</span><span class="si">}</span>
</span><span id="__span-8-190"><a id="__codelineno-8-190" name="__codelineno-8-190"></a><span class="w">  </span><span class="k">done</span>
</span><span id="__span-8-191"><a id="__codelineno-8-191" name="__codelineno-8-191"></a><span class="o">}</span>
</span><span id="__span-8-192"><a id="__codelineno-8-192" name="__codelineno-8-192"></a>
</span><span id="__span-8-193"><a id="__codelineno-8-193" name="__codelineno-8-193"></a>report_df<span class="o">()</span><span class="w"> </span><span class="o">{</span>
</span><span id="__span-8-194"><a id="__codelineno-8-194" name="__codelineno-8-194"></a><span class="w">  </span><span class="c1"># Stats from df: used/free space per file system.</span>
</span><span id="__span-8-195"><a id="__codelineno-8-195" name="__codelineno-8-195"></a><span class="w">  </span><span class="c1"># Depends on: df.</span>
</span><span id="__span-8-196"><a id="__codelineno-8-196" name="__codelineno-8-196"></a><span class="w">  </span><span class="k">while</span><span class="w"> </span>true<span class="p">;</span><span class="w"> </span><span class="k">do</span>
</span><span id="__span-8-197"><a id="__codelineno-8-197" name="__codelineno-8-197"></a><span class="w">    </span><span class="nv">ts</span><span class="o">=</span><span class="k">$(</span>timestamp_ns<span class="k">)</span>
</span><span id="__span-8-198"><a id="__codelineno-8-198" name="__codelineno-8-198"></a><span class="w">    </span>df<span class="w"> </span>-k<span class="w"> </span><span class="p">|</span><span class="w"> </span>egrep<span class="w"> </span>-v<span class="w"> </span><span class="s1">'/run|/pods|udev|loop|/sys|/run|/dev$'</span><span class="w"> </span><span class="p">|</span>
</span><span id="__span-8-199"><a id="__codelineno-8-199" name="__codelineno-8-199"></a><span class="w">      </span>grep<span class="w"> </span><span class="s1">' /'</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>awk<span class="w"> </span><span class="s1">'{print $4,$5,$6}'</span><span class="w"> </span><span class="p">|</span>
</span><span id="__span-8-200"><a id="__codelineno-8-200" name="__codelineno-8-200"></a><span class="w">      </span><span class="k">while</span><span class="w"> </span><span class="nb">read</span><span class="w"> </span>line<span class="p">;</span><span class="w"> </span><span class="k">do</span>
</span><span id="__span-8-201"><a id="__codelineno-8-201" name="__codelineno-8-201"></a><span class="w">        </span><span class="c1"># Note free space is given in 1KB blocks.</span>
</span><span id="__span-8-202"><a id="__codelineno-8-202" name="__codelineno-8-202"></a><span class="w">        </span><span class="nv">fs_path</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span><span class="w"> </span><span class="s2">"</span><span class="si">${</span><span class="nv">line</span><span class="si">}</span><span class="s2">"</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>cut<span class="w"> </span>-f3<span class="w"> </span>-d<span class="s1">' '</span><span class="k">)</span>
</span><span id="__span-8-203"><a id="__codelineno-8-203" name="__codelineno-8-203"></a><span class="w">        </span><span class="nv">fs_used</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span><span class="w"> </span><span class="s2">"</span><span class="si">${</span><span class="nv">line</span><span class="si">}</span><span class="s2">"</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>cut<span class="w"> </span>-f2<span class="w"> </span>-d<span class="s1">' '</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>cut<span class="w"> </span>-f1<span class="w"> </span>-d<span class="s1">'%'</span><span class="k">)</span>
</span><span id="__span-8-204"><a id="__codelineno-8-204" name="__codelineno-8-204"></a><span class="w">        </span><span class="nv">fs_free</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span><span class="w"> </span><span class="s2">"</span><span class="si">${</span><span class="nv">line</span><span class="si">}</span><span class="s2">"</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>cut<span class="w"> </span>-f1<span class="w"> </span>-d<span class="s1">' '</span><span class="k">)</span>
</span><span id="__span-8-205"><a id="__codelineno-8-205" name="__codelineno-8-205"></a><span class="w">        </span><span class="nv">fs_free</span><span class="o">=</span><span class="k">$((</span><span class="m">1024</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nv">fs_free</span><span class="k">))</span>
</span><span id="__span-8-206"><a id="__codelineno-8-206" name="__codelineno-8-206"></a><span class="w">        </span>store_line<span class="w"> </span><span class="s2">"df,host=</span><span class="si">${</span><span class="nv">host</span><span class="si">}</span><span class="s2">,path=</span><span class="si">${</span><span class="nv">fs_path</span><span class="si">}</span><span class="s2">,metric=tot_free value=</span><span class="si">${</span><span class="nv">fs_free</span><span class="si">}</span><span class="s2"> </span><span class="si">${</span><span class="nv">ts</span><span class="si">}</span><span class="s2">"</span>
</span><span id="__span-8-207"><a id="__codelineno-8-207" name="__codelineno-8-207"></a><span class="w">        </span>store_line<span class="w"> </span><span class="s2">"df,host=</span><span class="si">${</span><span class="nv">host</span><span class="si">}</span><span class="s2">,path=</span><span class="si">${</span><span class="nv">fs_path</span><span class="si">}</span><span class="s2">,metric=pct_used value=</span><span class="si">${</span><span class="nv">fs_used</span><span class="si">}</span><span class="s2"> </span><span class="si">${</span><span class="nv">ts</span><span class="si">}</span><span class="s2">"</span>
</span><span id="__span-8-208"><a id="__codelineno-8-208" name="__codelineno-8-208"></a><span class="w">      </span><span class="k">done</span>
</span><span id="__span-8-209"><a id="__codelineno-8-209" name="__codelineno-8-209"></a><span class="w">    </span>sleep<span class="w"> </span><span class="si">${</span><span class="nv">DELAY_FAST</span><span class="si">}</span>
</span><span id="__span-8-210"><a id="__codelineno-8-210" name="__codelineno-8-210"></a><span class="w">  </span><span class="k">done</span>
</span><span id="__span-8-211"><a id="__codelineno-8-211" name="__codelineno-8-211"></a><span class="o">}</span>
</span><span id="__span-8-212"><a id="__codelineno-8-212" name="__codelineno-8-212"></a>
</span><span id="__span-8-213"><a id="__codelineno-8-213" name="__codelineno-8-213"></a>report_diskstats<span class="o">()</span><span class="w"> </span><span class="o">{</span>
</span><span id="__span-8-214"><a id="__codelineno-8-214" name="__codelineno-8-214"></a><span class="w">  </span><span class="c1"># Disk I/O stats from /proc/diskstats.</span>
</span><span id="__span-8-215"><a id="__codelineno-8-215" name="__codelineno-8-215"></a><span class="w">  </span><span class="c1"># Depends on: /proc/diskstats.</span>
</span><span id="__span-8-216"><a id="__codelineno-8-216" name="__codelineno-8-216"></a><span class="w">  </span><span class="k">while</span><span class="w"> </span>true<span class="p">;</span><span class="w"> </span><span class="k">do</span>
</span><span id="__span-8-217"><a id="__codelineno-8-217" name="__codelineno-8-217"></a><span class="w">    </span><span class="nv">ts</span><span class="o">=</span><span class="k">$(</span>timestamp_ns<span class="k">)</span>
</span><span id="__span-8-218"><a id="__codelineno-8-218" name="__codelineno-8-218"></a><span class="w">    </span><span class="c1"># The /proc/diskstats file displays the I/O statistics of block devices.</span>
</span><span id="__span-8-219"><a id="__codelineno-8-219" name="__codelineno-8-219"></a><span class="w">    </span><span class="c1"># Each line contains the following fields (and more, omitted here):</span>
</span><span id="__span-8-220"><a id="__codelineno-8-220" name="__codelineno-8-220"></a><span class="w">    </span><span class="c1">#  1  major number</span>
</span><span id="__span-8-221"><a id="__codelineno-8-221" name="__codelineno-8-221"></a><span class="w">    </span><span class="c1">#  2  minor mumber</span>
</span><span id="__span-8-222"><a id="__codelineno-8-222" name="__codelineno-8-222"></a><span class="w">    </span><span class="c1">#  3  device name</span>
</span><span id="__span-8-223"><a id="__codelineno-8-223" name="__codelineno-8-223"></a><span class="w">    </span><span class="c1">#  4  reads completed successfully</span>
</span><span id="__span-8-224"><a id="__codelineno-8-224" name="__codelineno-8-224"></a><span class="w">    </span><span class="c1">#  5  reads merged</span>
</span><span id="__span-8-225"><a id="__codelineno-8-225" name="__codelineno-8-225"></a><span class="w">    </span><span class="c1">#  6  sectors read</span>
</span><span id="__span-8-226"><a id="__codelineno-8-226" name="__codelineno-8-226"></a><span class="w">    </span><span class="c1">#  7  time spent reading (ms)</span>
</span><span id="__span-8-227"><a id="__codelineno-8-227" name="__codelineno-8-227"></a><span class="w">    </span><span class="c1">#  8  writes completed</span>
</span><span id="__span-8-228"><a id="__codelineno-8-228" name="__codelineno-8-228"></a><span class="w">    </span><span class="c1">#  9  writes merged</span>
</span><span id="__span-8-229"><a id="__codelineno-8-229" name="__codelineno-8-229"></a><span class="w">    </span><span class="c1"># 10  sectors written</span>
</span><span id="__span-8-230"><a id="__codelineno-8-230" name="__codelineno-8-230"></a><span class="w">    </span><span class="c1"># 11  time spent writing (ms)</span>
</span><span id="__span-8-231"><a id="__codelineno-8-231" name="__codelineno-8-231"></a><span class="w">    </span><span class="c1"># Source: https://www.kernel.org/doc/Documentation/ABI/testing/procfs-diskstats</span>
</span><span id="__span-8-232"><a id="__codelineno-8-232" name="__codelineno-8-232"></a><span class="w">    </span>grep<span class="w"> </span>-v<span class="w"> </span><span class="s1">' 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0'</span><span class="w"> </span>/proc/diskstats<span class="w"> </span><span class="p">|</span><span class="w"> </span>egrep<span class="w"> </span>-v<span class="w"> </span><span class="s1">'loop|[hs]d[a-z][1-9]|k0p[0-9]'</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>awk<span class="w"> </span><span class="s1">'{print $3,$4,$6,$7,$8,$10,$11}'</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>sort<span class="w"> </span>&gt;<span class="nv">$DDIR</span>/disk1
</span><span id="__span-8-233"><a id="__codelineno-8-233" name="__codelineno-8-233"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="o">[[</span><span class="w"> </span>-f<span class="w"> </span><span class="s2">"</span><span class="si">${</span><span class="nv">DDIR</span><span class="si">}</span><span class="s2">/disk0"</span><span class="w"> </span><span class="o">]]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
</span><span id="__span-8-234"><a id="__codelineno-8-234" name="__codelineno-8-234"></a><span class="w">      </span><span class="c1"># Columns used: disk reads rsect rtime writs wsect wtime</span>
</span><span id="__span-8-235"><a id="__codelineno-8-235" name="__codelineno-8-235"></a><span class="w">      </span><span class="c1"># disk:   3  device name</span>
</span><span id="__span-8-236"><a id="__codelineno-8-236" name="__codelineno-8-236"></a><span class="w">      </span><span class="c1"># reads:  4  reads completed successfully</span>
</span><span id="__span-8-237"><a id="__codelineno-8-237" name="__codelineno-8-237"></a><span class="w">      </span><span class="c1"># rsect:  6  sectors read</span>
</span><span id="__span-8-238"><a id="__codelineno-8-238" name="__codelineno-8-238"></a><span class="w">      </span><span class="c1"># rtime:  7  time spent reading (ms)</span>
</span><span id="__span-8-239"><a id="__codelineno-8-239" name="__codelineno-8-239"></a><span class="w">      </span><span class="c1"># writs:  8  writes completed</span>
</span><span id="__span-8-240"><a id="__codelineno-8-240" name="__codelineno-8-240"></a><span class="w">      </span><span class="c1"># wsect: 10  sectors written</span>
</span><span id="__span-8-241"><a id="__codelineno-8-241" name="__codelineno-8-241"></a><span class="w">      </span><span class="c1"># wtime: 11  time spent writing (ms)</span>
</span><span id="__span-8-242"><a id="__codelineno-8-242" name="__codelineno-8-242"></a><span class="w">      </span>paste<span class="w"> </span><span class="s2">"</span><span class="si">${</span><span class="nv">DDIR</span><span class="si">}</span><span class="s2">/disk0"</span><span class="w"> </span><span class="s2">"</span><span class="si">${</span><span class="nv">DDIR</span><span class="si">}</span><span class="s2">/disk1"</span><span class="w"> </span><span class="p">|</span>
</span><span id="__span-8-243"><a id="__codelineno-8-243" name="__codelineno-8-243"></a><span class="w">        </span><span class="k">while</span><span class="w"> </span><span class="nb">read</span><span class="w"> </span><span class="se">\</span>
</span><span id="__span-8-244"><a id="__codelineno-8-244" name="__codelineno-8-244"></a><span class="w">          </span>disk0<span class="w"> </span>reads0<span class="w"> </span>rsect0<span class="w"> </span>rtime0<span class="w"> </span>writs0<span class="w"> </span>wsect0<span class="w"> </span>wtime0<span class="w"> </span><span class="se">\</span>
</span><span id="__span-8-245"><a id="__codelineno-8-245" name="__codelineno-8-245"></a><span class="w">          </span>disk1<span class="w"> </span>reads1<span class="w"> </span>rsect1<span class="w"> </span>rtime1<span class="w"> </span>writs1<span class="w"> </span>wsect1<span class="w"> </span>wtime1<span class="p">;</span><span class="w"> </span><span class="k">do</span>
</span><span id="__span-8-246"><a id="__codelineno-8-246" name="__codelineno-8-246"></a><span class="w">          </span><span class="c1"># Skip momentary inconsistencies when disks are added or removed.</span>
</span><span id="__span-8-247"><a id="__codelineno-8-247" name="__codelineno-8-247"></a><span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="s2">"</span><span class="si">${</span><span class="nv">disk0</span><span class="si">}</span><span class="s2">"</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">"</span><span class="si">${</span><span class="nv">disk1</span><span class="si">}</span><span class="s2">"</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
</span><span id="__span-8-248"><a id="__codelineno-8-248" name="__codelineno-8-248"></a><span class="w">            </span><span class="nv">disk</span><span class="o">=</span><span class="nv">$disk0</span>
</span><span id="__span-8-249"><a id="__codelineno-8-249" name="__codelineno-8-249"></a><span class="w">            </span><span class="c1"># Assume 512-byte sectors.</span>
</span><span id="__span-8-250"><a id="__codelineno-8-250" name="__codelineno-8-250"></a><span class="w">            </span><span class="nv">rsect</span><span class="o">=</span><span class="k">$((</span><span class="m">512</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="o">(</span><span class="nv">rsect1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nv">rsect0</span><span class="k">))</span><span class="o">)</span>
</span><span id="__span-8-251"><a id="__codelineno-8-251" name="__codelineno-8-251"></a><span class="w">            </span><span class="nv">wsect</span><span class="o">=</span><span class="k">$((</span><span class="m">512</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="o">(</span><span class="nv">wsect1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nv">wsect0</span><span class="k">))</span><span class="o">)</span>
</span><span id="__span-8-252"><a id="__codelineno-8-252" name="__codelineno-8-252"></a><span class="w">            </span>store_line<span class="w"> </span><span class="s2">"diskstats,host=</span><span class="si">${</span><span class="nv">host</span><span class="si">}</span><span class="s2">,device=</span><span class="si">${</span><span class="nv">disk</span><span class="si">}</span><span class="s2">,metric=bytes_read    value=</span><span class="si">${</span><span class="nv">rsect</span><span class="si">}</span><span class="s2"> </span><span class="si">${</span><span class="nv">ts</span><span class="si">}</span><span class="s2">"</span>
</span><span id="__span-8-253"><a id="__codelineno-8-253" name="__codelineno-8-253"></a><span class="w">            </span>store_line<span class="w"> </span><span class="s2">"diskstats,host=</span><span class="si">${</span><span class="nv">host</span><span class="si">}</span><span class="s2">,device=</span><span class="si">${</span><span class="nv">disk</span><span class="si">}</span><span class="s2">,metric=bytes_written value=</span><span class="si">${</span><span class="nv">wsect</span><span class="si">}</span><span class="s2"> </span><span class="si">${</span><span class="nv">ts</span><span class="si">}</span><span class="s2">"</span>
</span><span id="__span-8-254"><a id="__codelineno-8-254" name="__codelineno-8-254"></a><span class="w">            </span><span class="c1"># Successful I/O ops.</span>
</span><span id="__span-8-255"><a id="__codelineno-8-255" name="__codelineno-8-255"></a><span class="w">            </span><span class="nv">reads</span><span class="o">=</span><span class="k">$((</span><span class="nv">reads1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nv">reads0</span><span class="k">))</span>
</span><span id="__span-8-256"><a id="__codelineno-8-256" name="__codelineno-8-256"></a><span class="w">            </span><span class="nv">writs</span><span class="o">=</span><span class="k">$((</span><span class="nv">writs1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nv">writs0</span><span class="k">))</span>
</span><span id="__span-8-257"><a id="__codelineno-8-257" name="__codelineno-8-257"></a><span class="w">            </span>store_line<span class="w"> </span><span class="s2">"diskstats,host=</span><span class="si">${</span><span class="nv">host</span><span class="si">}</span><span class="s2">,device=</span><span class="si">${</span><span class="nv">disk</span><span class="si">}</span><span class="s2">,metric=successful_reads  value=</span><span class="si">${</span><span class="nv">reads</span><span class="si">}</span><span class="s2"> </span><span class="si">${</span><span class="nv">ts</span><span class="si">}</span><span class="s2">"</span>
</span><span id="__span-8-258"><a id="__codelineno-8-258" name="__codelineno-8-258"></a><span class="w">            </span>store_line<span class="w"> </span><span class="s2">"diskstats,host=</span><span class="si">${</span><span class="nv">host</span><span class="si">}</span><span class="s2">,device=</span><span class="si">${</span><span class="nv">disk</span><span class="si">}</span><span class="s2">,metric=successful_writes value=</span><span class="si">${</span><span class="nv">writs</span><span class="si">}</span><span class="s2"> </span><span class="si">${</span><span class="nv">ts</span><span class="si">}</span><span class="s2">"</span>
</span><span id="__span-8-259"><a id="__codelineno-8-259" name="__codelineno-8-259"></a><span class="w">            </span><span class="c1"># Time spent.</span>
</span><span id="__span-8-260"><a id="__codelineno-8-260" name="__codelineno-8-260"></a><span class="w">            </span><span class="nv">read_ms</span><span class="o">=</span><span class="k">$((</span><span class="nv">rtime1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nv">rtime0</span><span class="k">))</span>
</span><span id="__span-8-261"><a id="__codelineno-8-261" name="__codelineno-8-261"></a><span class="w">            </span><span class="nv">writ_ms</span><span class="o">=</span><span class="k">$((</span><span class="nv">wtime1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nv">wtime0</span><span class="k">))</span>
</span><span id="__span-8-262"><a id="__codelineno-8-262" name="__codelineno-8-262"></a><span class="w">            </span>store_line<span class="w"> </span><span class="s2">"diskstats,host=</span><span class="si">${</span><span class="nv">host</span><span class="si">}</span><span class="s2">,device=</span><span class="si">${</span><span class="nv">disk</span><span class="si">}</span><span class="s2">,metric=time_spent_reads  value=</span><span class="si">${</span><span class="nv">read_ms</span><span class="si">}</span><span class="s2"> </span><span class="si">${</span><span class="nv">ts</span><span class="si">}</span><span class="s2">"</span>
</span><span id="__span-8-263"><a id="__codelineno-8-263" name="__codelineno-8-263"></a><span class="w">            </span>store_line<span class="w"> </span><span class="s2">"diskstats,host=</span><span class="si">${</span><span class="nv">host</span><span class="si">}</span><span class="s2">,device=</span><span class="si">${</span><span class="nv">disk</span><span class="si">}</span><span class="s2">,metric=time_spent_writes value=</span><span class="si">${</span><span class="nv">writ_ms</span><span class="si">}</span><span class="s2"> </span><span class="si">${</span><span class="nv">ts</span><span class="si">}</span><span class="s2">"</span>
</span><span id="__span-8-264"><a id="__codelineno-8-264" name="__codelineno-8-264"></a><span class="w">          </span><span class="k">fi</span>
</span><span id="__span-8-265"><a id="__codelineno-8-265" name="__codelineno-8-265"></a><span class="w">        </span><span class="k">done</span>
</span><span id="__span-8-266"><a id="__codelineno-8-266" name="__codelineno-8-266"></a><span class="w">    </span><span class="k">fi</span>
</span><span id="__span-8-267"><a id="__codelineno-8-267" name="__codelineno-8-267"></a><span class="w">    </span>mv<span class="w"> </span><span class="s2">"</span><span class="si">${</span><span class="nv">DDIR</span><span class="si">}</span><span class="s2">/disk1"</span><span class="w"> </span><span class="s2">"</span><span class="si">${</span><span class="nv">DDIR</span><span class="si">}</span><span class="s2">/disk0"</span>
</span><span id="__span-8-268"><a id="__codelineno-8-268" name="__codelineno-8-268"></a><span class="w">    </span>sleep<span class="w"> </span><span class="si">${</span><span class="nv">DELAY_FAST</span><span class="si">}</span>
</span><span id="__span-8-269"><a id="__codelineno-8-269" name="__codelineno-8-269"></a><span class="w">  </span><span class="k">done</span>
</span><span id="__span-8-270"><a id="__codelineno-8-270" name="__codelineno-8-270"></a><span class="o">}</span>
</span><span id="__span-8-271"><a id="__codelineno-8-271" name="__codelineno-8-271"></a>
</span><span id="__span-8-272"><a id="__codelineno-8-272" name="__codelineno-8-272"></a>bytes_from_value_and_units<span class="o">()</span><span class="w"> </span><span class="o">{</span>
</span><span id="__span-8-273"><a id="__codelineno-8-273" name="__codelineno-8-273"></a><span class="w">  </span><span class="nv">value</span><span class="o">=</span><span class="nv">$1</span>
</span><span id="__span-8-274"><a id="__codelineno-8-274" name="__codelineno-8-274"></a><span class="w">  </span><span class="nv">units</span><span class="o">=</span><span class="nv">$2</span>
</span><span id="__span-8-275"><a id="__codelineno-8-275" name="__codelineno-8-275"></a><span class="w">  </span><span class="nv">factor</span><span class="o">=</span><span class="m">1</span>
</span><span id="__span-8-276"><a id="__codelineno-8-276" name="__codelineno-8-276"></a><span class="w">  </span><span class="k">case</span><span class="w"> </span><span class="s2">"</span><span class="si">${</span><span class="nv">units</span><span class="si">}</span><span class="s2">"</span><span class="w"> </span><span class="k">in</span>
</span><span id="__span-8-277"><a id="__codelineno-8-277" name="__codelineno-8-277"></a><span class="w">  </span><span class="s2">"K/s"</span><span class="o">)</span>
</span><span id="__span-8-278"><a id="__codelineno-8-278" name="__codelineno-8-278"></a><span class="w">    </span><span class="nv">factor</span><span class="o">=</span><span class="m">1024</span>
</span><span id="__span-8-279"><a id="__codelineno-8-279" name="__codelineno-8-279"></a><span class="w">    </span><span class="p">;;</span>
</span><span id="__span-8-280"><a id="__codelineno-8-280" name="__codelineno-8-280"></a><span class="w">  </span><span class="s2">"M/s"</span><span class="o">)</span>
</span><span id="__span-8-281"><a id="__codelineno-8-281" name="__codelineno-8-281"></a><span class="w">    </span><span class="nv">factor</span><span class="o">=</span><span class="m">1024</span>*1024
</span><span id="__span-8-282"><a id="__codelineno-8-282" name="__codelineno-8-282"></a><span class="w">    </span><span class="p">;;</span>
</span><span id="__span-8-283"><a id="__codelineno-8-283" name="__codelineno-8-283"></a><span class="w">  </span><span class="s2">"G/s"</span><span class="o">)</span>
</span><span id="__span-8-284"><a id="__codelineno-8-284" name="__codelineno-8-284"></a><span class="w">    </span><span class="nv">factor</span><span class="o">=</span><span class="m">1024</span>*1024*1024
</span><span id="__span-8-285"><a id="__codelineno-8-285" name="__codelineno-8-285"></a><span class="w">    </span><span class="p">;;</span>
</span><span id="__span-8-286"><a id="__codelineno-8-286" name="__codelineno-8-286"></a><span class="w">  </span><span class="s2">"T/s"</span><span class="o">)</span>
</span><span id="__span-8-287"><a id="__codelineno-8-287" name="__codelineno-8-287"></a><span class="w">    </span><span class="nv">factor</span><span class="o">=</span><span class="m">1024</span>*1024*1024*1024
</span><span id="__span-8-288"><a id="__codelineno-8-288" name="__codelineno-8-288"></a><span class="w">    </span><span class="p">;;</span>
</span><span id="__span-8-289"><a id="__codelineno-8-289" name="__codelineno-8-289"></a><span class="w">  </span><span class="k">esac</span>
</span><span id="__span-8-290"><a id="__codelineno-8-290" name="__codelineno-8-290"></a><span class="w">  </span>bc<span class="w"> </span>-ql<span class="w"> </span><span class="o">&lt;&lt;&lt;</span><span class="s2">"</span><span class="si">${</span><span class="nv">factor</span><span class="si">}</span><span class="s2"> * </span><span class="si">${</span><span class="nv">value</span><span class="si">}</span><span class="s2">"</span>
</span><span id="__span-8-291"><a id="__codelineno-8-291" name="__codelineno-8-291"></a><span class="o">}</span>
</span><span id="__span-8-292"><a id="__codelineno-8-292" name="__codelineno-8-292"></a>
</span><span id="__span-8-293"><a id="__codelineno-8-293" name="__codelineno-8-293"></a>report_iotop<span class="o">()</span><span class="w"> </span><span class="o">{</span>
</span><span id="__span-8-294"><a id="__codelineno-8-294" name="__codelineno-8-294"></a><span class="w">  </span><span class="c1"># I/O stats from iotop (per process).</span>
</span><span id="__span-8-295"><a id="__codelineno-8-295" name="__codelineno-8-295"></a><span class="w">  </span><span class="c1"># Depends on: iotop (as root).</span>
</span><span id="__span-8-296"><a id="__codelineno-8-296" name="__codelineno-8-296"></a><span class="w">  </span><span class="nv">iotop</span><span class="o">=</span><span class="k">$(</span><span class="nb">command</span><span class="w"> </span>-v<span class="w"> </span>iotop<span class="k">)</span>
</span><span id="__span-8-297"><a id="__codelineno-8-297" name="__codelineno-8-297"></a><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span>-z<span class="w"> </span><span class="nv">$iotop</span><span class="w"> </span><span class="o">]</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="o">[</span><span class="w"> </span>!<span class="w"> </span>-f<span class="w"> </span><span class="nv">$iotop</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
</span><span id="__span-8-298"><a id="__codelineno-8-298" name="__codelineno-8-298"></a><span class="w">    </span><span class="k">return</span>
</span><span id="__span-8-299"><a id="__codelineno-8-299" name="__codelineno-8-299"></a><span class="w">  </span><span class="k">fi</span>
</span><span id="__span-8-300"><a id="__codelineno-8-300" name="__codelineno-8-300"></a><span class="w">  </span><span class="k">while</span><span class="w"> </span>true<span class="p">;</span><span class="w"> </span><span class="k">do</span>
</span><span id="__span-8-301"><a id="__codelineno-8-301" name="__codelineno-8-301"></a><span class="w">    </span><span class="nv">ts</span><span class="o">=</span><span class="k">$(</span>timestamp_ns<span class="k">)</span>
</span><span id="__span-8-302"><a id="__codelineno-8-302" name="__codelineno-8-302"></a><span class="w">    </span><span class="nv">iotop_stats</span><span class="o">=</span><span class="nv">$DDIR</span>/iotop
</span><span id="__span-8-303"><a id="__codelineno-8-303" name="__codelineno-8-303"></a><span class="w">    </span><span class="c1"># The Linux kernel interfaces that iotop relies on now require root</span>
</span><span id="__span-8-304"><a id="__codelineno-8-304" name="__codelineno-8-304"></a><span class="w">    </span><span class="c1"># privileges or the NET_ADMIN capability. This change occurred because a</span>
</span><span id="__span-8-305"><a id="__codelineno-8-305" name="__codelineno-8-305"></a><span class="w">    </span><span class="c1"># security issue (CVE-2011-2494) was found that allows leakage of sensitive</span>
</span><span id="__span-8-306"><a id="__codelineno-8-306" name="__codelineno-8-306"></a><span class="w">    </span><span class="c1"># data across user boundaries. If you require the ability to run iotop as a</span>
</span><span id="__span-8-307"><a id="__codelineno-8-307" name="__codelineno-8-307"></a><span class="w">    </span><span class="c1"># non-root user, please configure sudo to allow you to run iotop as root.</span>
</span><span id="__span-8-308"><a id="__codelineno-8-308" name="__codelineno-8-308"></a><span class="w">    </span>sudo<span class="w"> </span><span class="nv">$iotop</span><span class="w"> </span>-b<span class="w"> </span>-P<span class="w"> </span>-n<span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="p">|</span>
</span><span id="__span-8-309"><a id="__codelineno-8-309" name="__codelineno-8-309"></a><span class="w">      </span>grep<span class="w"> </span>-Ev<span class="w"> </span><span class="s1">'task_delayacct|locale|DISK READ|0.00 B/s    0.00 B/s'</span><span class="w"> </span><span class="p">|</span>
</span><span id="__span-8-310"><a id="__codelineno-8-310" name="__codelineno-8-310"></a><span class="w">      </span>tr<span class="w"> </span>-d<span class="w"> </span><span class="s1">'['</span><span class="w"> </span><span class="p">|</span>
</span><span id="__span-8-311"><a id="__codelineno-8-311" name="__codelineno-8-311"></a><span class="w">      </span>tr<span class="w"> </span>-d<span class="w"> </span><span class="s1">']'</span><span class="w"> </span><span class="p">|</span>
</span><span id="__span-8-312"><a id="__codelineno-8-312" name="__codelineno-8-312"></a><span class="w">      </span>sed<span class="w"> </span><span class="s1">'s/kworker\///'</span><span class="w"> </span><span class="p">|</span>
</span><span id="__span-8-313"><a id="__codelineno-8-313" name="__codelineno-8-313"></a><span class="w">      </span>sed<span class="w"> </span><span class="s1">'s/u64:[0-9]\+-//'</span><span class="w"> </span><span class="p">|</span>
</span><span id="__span-8-314"><a id="__codelineno-8-314" name="__codelineno-8-314"></a><span class="w">      </span>awk<span class="w"> </span><span class="s1">'{print $4,$5,$6,$7,$9}'</span><span class="w"> </span><span class="se">\</span>
</span><span id="__span-8-315"><a id="__codelineno-8-315" name="__codelineno-8-315"></a><span class="w">        </span>&gt;<span class="s2">"</span><span class="si">${</span><span class="nv">iotop_stats</span><span class="si">}</span><span class="s2">"</span>
</span><span id="__span-8-316"><a id="__codelineno-8-316" name="__codelineno-8-316"></a><span class="w">    </span><span class="c1"># Return if iotop could not be run successfully.</span>
</span><span id="__span-8-317"><a id="__codelineno-8-317" name="__codelineno-8-317"></a><span class="w">    </span><span class="c1"># This is typically caused by 'Netlink error: Operation not permitted'.</span>
</span><span id="__span-8-318"><a id="__codelineno-8-318" name="__codelineno-8-318"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="o">[[</span><span class="w"> </span><span class="nv">$?</span><span class="w"> </span>-gt<span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="o">]]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
</span><span id="__span-8-319"><a id="__codelineno-8-319" name="__codelineno-8-319"></a><span class="w">      </span><span class="k">return</span>
</span><span id="__span-8-320"><a id="__codelineno-8-320" name="__codelineno-8-320"></a><span class="w">    </span><span class="k">fi</span>
</span><span id="__span-8-321"><a id="__codelineno-8-321" name="__codelineno-8-321"></a><span class="w">    </span><span class="c1"># Report I/O stats for each process.</span>
</span><span id="__span-8-322"><a id="__codelineno-8-322" name="__codelineno-8-322"></a><span class="w">    </span><span class="c1"># Note: this aggregates I/O per process name (basename), across all PIDs.</span>
</span><span id="__span-8-323"><a id="__codelineno-8-323" name="__codelineno-8-323"></a><span class="w">    </span>cat<span class="w"> </span><span class="s2">"</span><span class="si">${</span><span class="nv">iotop_stats</span><span class="si">}</span><span class="s2">"</span><span class="w"> </span><span class="p">|</span>
</span><span id="__span-8-324"><a id="__codelineno-8-324" name="__codelineno-8-324"></a><span class="w">      </span>cut<span class="w"> </span>-f5<span class="w"> </span>-d<span class="s1">' '</span><span class="w"> </span><span class="p">|</span>
</span><span id="__span-8-325"><a id="__codelineno-8-325" name="__codelineno-8-325"></a><span class="w">      </span>sort<span class="w"> </span>-u<span class="w"> </span><span class="p">|</span>
</span><span id="__span-8-326"><a id="__codelineno-8-326" name="__codelineno-8-326"></a><span class="w">      </span><span class="k">while</span><span class="w"> </span><span class="nb">read</span><span class="w"> </span>-r<span class="w"> </span>process<span class="p">;</span><span class="w"> </span><span class="k">do</span>
</span><span id="__span-8-327"><a id="__codelineno-8-327" name="__codelineno-8-327"></a><span class="w">        </span><span class="nv">process_read</span><span class="o">=</span><span class="m">0</span>
</span><span id="__span-8-328"><a id="__codelineno-8-328" name="__codelineno-8-328"></a><span class="w">        </span><span class="nv">process_write</span><span class="o">=</span><span class="m">0</span>
</span><span id="__span-8-329"><a id="__codelineno-8-329" name="__codelineno-8-329"></a><span class="w">        </span><span class="k">while</span><span class="w"> </span><span class="nb">read</span><span class="w"> </span>-r<span class="w"> </span>line<span class="p">;</span><span class="w"> </span><span class="k">do</span>
</span><span id="__span-8-330"><a id="__codelineno-8-330" name="__codelineno-8-330"></a><span class="w">          </span><span class="nv">read_value</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span><span class="w"> </span><span class="s2">"</span><span class="si">${</span><span class="nv">line</span><span class="si">}</span><span class="s2">"</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>cut<span class="w"> </span>-f1<span class="w"> </span>-d<span class="s1">' '</span><span class="k">)</span>
</span><span id="__span-8-331"><a id="__codelineno-8-331" name="__codelineno-8-331"></a><span class="w">          </span><span class="nv">read_units</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span><span class="w"> </span><span class="s2">"</span><span class="si">${</span><span class="nv">line</span><span class="si">}</span><span class="s2">"</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>cut<span class="w"> </span>-f2<span class="w"> </span>-d<span class="s1">' '</span><span class="k">)</span>
</span><span id="__span-8-332"><a id="__codelineno-8-332" name="__codelineno-8-332"></a><span class="w">          </span><span class="nv">read_bytes</span><span class="o">=</span><span class="k">$(</span>bytes_from_value_and_units<span class="w"> </span><span class="s2">"</span><span class="si">${</span><span class="nv">read_value</span><span class="si">}</span><span class="s2">"</span><span class="w"> </span><span class="s2">"</span><span class="si">${</span><span class="nv">read_units</span><span class="si">}</span><span class="s2">"</span><span class="k">)</span>
</span><span id="__span-8-333"><a id="__codelineno-8-333" name="__codelineno-8-333"></a><span class="w">          </span><span class="nv">process_read</span><span class="o">=</span><span class="k">$(</span>bc<span class="w"> </span>-ql<span class="w"> </span><span class="o">&lt;&lt;&lt;</span><span class="s2">"</span><span class="si">${</span><span class="nv">process_read</span><span class="si">}</span><span class="s2">+</span><span class="si">${</span><span class="nv">read_bytes</span><span class="si">}</span><span class="s2">"</span><span class="k">)</span>
</span><span id="__span-8-334"><a id="__codelineno-8-334" name="__codelineno-8-334"></a><span class="w">          </span><span class="nv">write_value</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span><span class="w"> </span><span class="s2">"</span><span class="si">${</span><span class="nv">line</span><span class="si">}</span><span class="s2">"</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>cut<span class="w"> </span>-f3<span class="w"> </span>-d<span class="s1">' '</span><span class="k">)</span>
</span><span id="__span-8-335"><a id="__codelineno-8-335" name="__codelineno-8-335"></a><span class="w">          </span><span class="nv">write_units</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span><span class="w"> </span><span class="s2">"</span><span class="si">${</span><span class="nv">line</span><span class="si">}</span><span class="s2">"</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>cut<span class="w"> </span>-f4<span class="w"> </span>-d<span class="s1">' '</span><span class="k">)</span>
</span><span id="__span-8-336"><a id="__codelineno-8-336" name="__codelineno-8-336"></a><span class="w">          </span><span class="nv">write_bytes</span><span class="o">=</span><span class="k">$(</span>bytes_from_value_and_units<span class="w"> </span><span class="s2">"</span><span class="si">${</span><span class="nv">write_value</span><span class="si">}</span><span class="s2">"</span><span class="w"> </span><span class="s2">"</span><span class="si">${</span><span class="nv">write_units</span><span class="si">}</span><span class="s2">"</span><span class="k">)</span>
</span><span id="__span-8-337"><a id="__codelineno-8-337" name="__codelineno-8-337"></a><span class="w">          </span><span class="nv">process_write</span><span class="o">=</span><span class="k">$(</span>bc<span class="w"> </span>-ql<span class="w"> </span><span class="o">&lt;&lt;&lt;</span><span class="s2">"</span><span class="si">${</span><span class="nv">process_write</span><span class="si">}</span><span class="s2">+</span><span class="si">${</span><span class="nv">write_bytes</span><span class="si">}</span><span class="s2">"</span><span class="k">)</span>
</span><span id="__span-8-338"><a id="__codelineno-8-338" name="__codelineno-8-338"></a><span class="w">        </span><span class="k">done</span><span class="w"> </span>&lt;<span class="w"> </span>&lt;<span class="o">(</span>grep<span class="w"> </span><span class="s2">" </span><span class="si">${</span><span class="nv">process</span><span class="si">}</span><span class="s2">\$"</span><span class="w"> </span><span class="s2">"</span><span class="si">${</span><span class="nv">iotop_stats</span><span class="si">}</span><span class="s2">"</span><span class="o">)</span>
</span><span id="__span-8-339"><a id="__codelineno-8-339" name="__codelineno-8-339"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="o">[[</span><span class="w"> </span><span class="k">$(</span><span class="nb">echo</span><span class="w"> </span><span class="s2">"</span><span class="si">${</span><span class="nv">process_read</span><span class="si">}</span><span class="s2">"</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>sed<span class="w"> </span><span class="s1">'s/\..*//'</span><span class="k">)</span><span class="w"> </span>-gt<span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="o">]]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
</span><span id="__span-8-340"><a id="__codelineno-8-340" name="__codelineno-8-340"></a><span class="w">          </span>store_line<span class="w"> </span><span class="s2">"iotop,host=</span><span class="si">${</span><span class="nv">host</span><span class="si">}</span><span class="s2">,command=</span><span class="si">${</span><span class="nv">process</span><span class="si">}</span><span class="s2">,metric=read value=</span><span class="si">${</span><span class="nv">process_read</span><span class="si">}</span><span class="s2"> </span><span class="si">${</span><span class="nv">ts</span><span class="si">}</span><span class="s2">"</span>
</span><span id="__span-8-341"><a id="__codelineno-8-341" name="__codelineno-8-341"></a><span class="w">        </span><span class="k">fi</span>
</span><span id="__span-8-342"><a id="__codelineno-8-342" name="__codelineno-8-342"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="o">[[</span><span class="w"> </span><span class="s2">"</span><span class="k">$(</span><span class="nb">echo</span><span class="w"> </span><span class="s2">"</span><span class="si">${</span><span class="nv">process_write</span><span class="si">}</span><span class="s2">"</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>sed<span class="w"> </span><span class="s1">'s/\..*//'</span><span class="k">)</span><span class="s2">"</span><span class="w"> </span>-gt<span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="o">]]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
</span><span id="__span-8-343"><a id="__codelineno-8-343" name="__codelineno-8-343"></a><span class="w">          </span>store_line<span class="w"> </span><span class="s2">"iotop,host=</span><span class="si">${</span><span class="nv">host</span><span class="si">}</span><span class="s2">,command=</span><span class="si">${</span><span class="nv">process</span><span class="si">}</span><span class="s2">,metric=write value=</span><span class="si">${</span><span class="nv">process_write</span><span class="si">}</span><span class="s2"> </span><span class="si">${</span><span class="nv">ts</span><span class="si">}</span><span class="s2">"</span>
</span><span id="__span-8-344"><a id="__codelineno-8-344" name="__codelineno-8-344"></a><span class="w">        </span><span class="k">fi</span>
</span><span id="__span-8-345"><a id="__codelineno-8-345" name="__codelineno-8-345"></a><span class="w">      </span><span class="k">done</span>
</span><span id="__span-8-346"><a id="__codelineno-8-346" name="__codelineno-8-346"></a><span class="w">    </span>sleep<span class="w"> </span><span class="si">${</span><span class="nv">DELAY_FAST</span><span class="si">}</span>
</span><span id="__span-8-347"><a id="__codelineno-8-347" name="__codelineno-8-347"></a><span class="w">  </span><span class="k">done</span>
</span><span id="__span-8-348"><a id="__codelineno-8-348" name="__codelineno-8-348"></a><span class="o">}</span>
</span><span id="__span-8-349"><a id="__codelineno-8-349" name="__codelineno-8-349"></a>
</span><span id="__span-8-350"><a id="__codelineno-8-350" name="__codelineno-8-350"></a>report_net_dev<span class="o">()</span><span class="w"> </span><span class="o">{</span>
</span><span id="__span-8-351"><a id="__codelineno-8-351" name="__codelineno-8-351"></a><span class="w">  </span><span class="c1"># Network I/O stats from /proc/net/dev.</span>
</span><span id="__span-8-352"><a id="__codelineno-8-352" name="__codelineno-8-352"></a><span class="w">  </span><span class="c1"># Depends on: /proc/net/dev.</span>
</span><span id="__span-8-353"><a id="__codelineno-8-353" name="__codelineno-8-353"></a><span class="w">  </span><span class="k">while</span><span class="w"> </span>true<span class="p">;</span><span class="w"> </span><span class="k">do</span>
</span><span id="__span-8-354"><a id="__codelineno-8-354" name="__codelineno-8-354"></a><span class="w">    </span><span class="nv">ts</span><span class="o">=</span><span class="k">$(</span>timestamp_ns<span class="k">)</span>
</span><span id="__span-8-355"><a id="__codelineno-8-355" name="__codelineno-8-355"></a><span class="w">    </span>grep<span class="w"> </span>-Ev<span class="w"> </span><span class="s1">'Inter|face'</span><span class="w"> </span>/proc/net/dev<span class="w"> </span><span class="p">|</span><span class="w"> </span>tr<span class="w"> </span>-d<span class="w"> </span><span class="s1">':'</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>awk<span class="w"> </span><span class="s1">'{print $1,$2,$10}'</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>sort<span class="w"> </span>&gt;<span class="s2">"</span><span class="si">${</span><span class="nv">DDIR</span><span class="si">}</span><span class="s2">/net1"</span>
</span><span id="__span-8-356"><a id="__codelineno-8-356" name="__codelineno-8-356"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="o">[[</span><span class="w"> </span>-f<span class="w"> </span><span class="s2">"</span><span class="si">${</span><span class="nv">DDIR</span><span class="si">}</span><span class="s2">/net0"</span><span class="w"> </span><span class="o">]]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
</span><span id="__span-8-357"><a id="__codelineno-8-357" name="__codelineno-8-357"></a><span class="w">      </span><span class="nv">ts0</span><span class="o">=</span><span class="k">$(</span>cat<span class="w"> </span><span class="s2">"</span><span class="si">${</span><span class="nv">DDIR</span><span class="si">}</span><span class="s2">/net0-ts"</span><span class="k">)</span>
</span><span id="__span-8-358"><a id="__codelineno-8-358" name="__codelineno-8-358"></a><span class="w">      </span><span class="nb">echo</span><span class="w"> </span><span class="s2">"</span><span class="si">${</span><span class="nv">ts</span><span class="si">}</span><span class="s2">"</span><span class="w"> </span>&gt;<span class="s2">"</span><span class="si">${</span><span class="nv">DDIR</span><span class="si">}</span><span class="s2">/net1-ts"</span>
</span><span id="__span-8-359"><a id="__codelineno-8-359" name="__codelineno-8-359"></a><span class="w">      </span>paste<span class="w"> </span><span class="s2">"</span><span class="si">${</span><span class="nv">DDIR</span><span class="si">}</span><span class="s2">/net0"</span><span class="w"> </span><span class="s2">"</span><span class="si">${</span><span class="nv">DDIR</span><span class="si">}</span><span class="s2">/net1"</span><span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="k">while</span><span class="w"> </span><span class="nb">read</span><span class="w"> </span>-r<span class="w"> </span>dev0<span class="w"> </span>rx0<span class="w"> </span>tx0<span class="w"> </span>dev1<span class="w"> </span>rx1<span class="w"> </span>tx1<span class="p">;</span><span class="w"> </span><span class="k">do</span>
</span><span id="__span-8-360"><a id="__codelineno-8-360" name="__codelineno-8-360"></a><span class="w">        </span><span class="c1"># Skip momentary inconsistencies when devs are added or removed.</span>
</span><span id="__span-8-361"><a id="__codelineno-8-361" name="__codelineno-8-361"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="o">[[</span><span class="w"> </span><span class="s2">"</span><span class="si">${</span><span class="nv">dev0</span><span class="si">}</span><span class="s2">"</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">"</span><span class="si">${</span><span class="nv">dev1</span><span class="si">}</span><span class="s2">"</span><span class="w"> </span><span class="o">]]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
</span><span id="__span-8-362"><a id="__codelineno-8-362" name="__codelineno-8-362"></a><span class="w">          </span><span class="c1"># Compute rx/tx bytes / sec (ts is in nanoseconds).</span>
</span><span id="__span-8-363"><a id="__codelineno-8-363" name="__codelineno-8-363"></a><span class="w">          </span><span class="nv">rx</span><span class="o">=</span><span class="k">$(</span>bc<span class="w"> </span>-ql<span class="w"> </span><span class="o">&lt;&lt;&lt;</span><span class="s2">"1000000000 * (</span><span class="si">${</span><span class="nv">rx1</span><span class="si">}</span><span class="s2"> - </span><span class="si">${</span><span class="nv">rx0</span><span class="si">}</span><span class="s2">) / (</span><span class="si">${</span><span class="nv">ts</span><span class="si">}</span><span class="s2"> - </span><span class="si">${</span><span class="nv">ts0</span><span class="si">}</span><span class="s2">)"</span><span class="k">)</span>
</span><span id="__span-8-364"><a id="__codelineno-8-364" name="__codelineno-8-364"></a><span class="w">          </span><span class="nv">tx</span><span class="o">=</span><span class="k">$(</span>bc<span class="w"> </span>-ql<span class="w"> </span><span class="o">&lt;&lt;&lt;</span><span class="s2">"1000000000 * (</span><span class="si">${</span><span class="nv">tx1</span><span class="si">}</span><span class="s2"> - </span><span class="si">${</span><span class="nv">tx0</span><span class="si">}</span><span class="s2">) / (</span><span class="si">${</span><span class="nv">ts</span><span class="si">}</span><span class="s2"> - </span><span class="si">${</span><span class="nv">ts0</span><span class="si">}</span><span class="s2">)"</span><span class="k">)</span>
</span><span id="__span-8-365"><a id="__codelineno-8-365" name="__codelineno-8-365"></a><span class="w">          </span>store_line<span class="w"> </span><span class="s2">"net_dev,host=</span><span class="si">${</span><span class="nv">host</span><span class="si">}</span><span class="s2">,device=</span><span class="si">${</span><span class="nv">dev0</span><span class="si">}</span><span class="s2">,metric=rx value=</span><span class="si">${</span><span class="nv">rx</span><span class="si">}</span><span class="s2"> </span><span class="si">${</span><span class="nv">ts</span><span class="si">}</span><span class="s2">"</span>
</span><span id="__span-8-366"><a id="__codelineno-8-366" name="__codelineno-8-366"></a><span class="w">          </span>store_line<span class="w"> </span><span class="s2">"net_dev,host=</span><span class="si">${</span><span class="nv">host</span><span class="si">}</span><span class="s2">,device=</span><span class="si">${</span><span class="nv">dev0</span><span class="si">}</span><span class="s2">,metric=tx value=</span><span class="si">${</span><span class="nv">tx</span><span class="si">}</span><span class="s2"> </span><span class="si">${</span><span class="nv">ts</span><span class="si">}</span><span class="s2">"</span>
</span><span id="__span-8-367"><a id="__codelineno-8-367" name="__codelineno-8-367"></a><span class="w">        </span><span class="k">fi</span>
</span><span id="__span-8-368"><a id="__codelineno-8-368" name="__codelineno-8-368"></a><span class="w">      </span><span class="k">done</span>
</span><span id="__span-8-369"><a id="__codelineno-8-369" name="__codelineno-8-369"></a><span class="w">    </span><span class="k">fi</span>
</span><span id="__span-8-370"><a id="__codelineno-8-370" name="__codelineno-8-370"></a><span class="w">    </span>mv<span class="w"> </span><span class="s2">"</span><span class="si">${</span><span class="nv">DDIR</span><span class="si">}</span><span class="s2">/net1"</span><span class="w"> </span><span class="s2">"</span><span class="si">${</span><span class="nv">DDIR</span><span class="si">}</span><span class="s2">/net0"</span>
</span><span id="__span-8-371"><a id="__codelineno-8-371" name="__codelineno-8-371"></a><span class="w">    </span>mv<span class="w"> </span><span class="s2">"</span><span class="si">${</span><span class="nv">DDIR</span><span class="si">}</span><span class="s2">/net1-ts"</span><span class="w"> </span><span class="s2">"</span><span class="si">${</span><span class="nv">DDIR</span><span class="si">}</span><span class="s2">/net0-ts"</span>
</span><span id="__span-8-372"><a id="__codelineno-8-372" name="__codelineno-8-372"></a><span class="w">    </span>sleep<span class="w"> </span><span class="si">${</span><span class="nv">DELAY_FAST</span><span class="si">}</span>
</span><span id="__span-8-373"><a id="__codelineno-8-373" name="__codelineno-8-373"></a><span class="w">  </span><span class="k">done</span>
</span><span id="__span-8-374"><a id="__codelineno-8-374" name="__codelineno-8-374"></a><span class="o">}</span>
</span><span id="__span-8-375"><a id="__codelineno-8-375" name="__codelineno-8-375"></a>
</span><span id="__span-8-376"><a id="__codelineno-8-376" name="__codelineno-8-376"></a>report_du<span class="o">()</span><span class="w"> </span><span class="o">{</span>
</span><span id="__span-8-377"><a id="__codelineno-8-377" name="__codelineno-8-377"></a><span class="w">  </span><span class="c1"># Disk usage stats from du.</span>
</span><span id="__span-8-378"><a id="__codelineno-8-378" name="__codelineno-8-378"></a><span class="w">  </span><span class="c1"># Files and directories to monitor in /etc/conmon/du</span>
</span><span id="__span-8-379"><a id="__codelineno-8-379" name="__codelineno-8-379"></a><span class="w">  </span><span class="c1"># Depends on du (as root).</span>
</span><span id="__span-8-380"><a id="__codelineno-8-380" name="__codelineno-8-380"></a><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span>-z<span class="w"> </span>/etc/conmon/du<span class="w"> </span><span class="o">]</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="o">[</span><span class="w"> </span>!<span class="w"> </span>-f<span class="w"> </span>$/etc/conmon/du<span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
</span><span id="__span-8-381"><a id="__codelineno-8-381" name="__codelineno-8-381"></a><span class="w">    </span><span class="k">return</span>
</span><span id="__span-8-382"><a id="__codelineno-8-382" name="__codelineno-8-382"></a><span class="w">  </span><span class="k">fi</span>
</span><span id="__span-8-383"><a id="__codelineno-8-383" name="__codelineno-8-383"></a><span class="w">  </span><span class="k">while</span><span class="w"> </span>true<span class="p">;</span><span class="w"> </span><span class="k">do</span>
</span><span id="__span-8-384"><a id="__codelineno-8-384" name="__codelineno-8-384"></a><span class="w">    </span><span class="nv">ts</span><span class="o">=</span><span class="k">$(</span>timestamp_ns<span class="k">)</span>
</span><span id="__span-8-385"><a id="__codelineno-8-385" name="__codelineno-8-385"></a><span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="nb">read</span><span class="w"> </span>-r<span class="w"> </span>path<span class="w"> </span>&lt;/etc/conmon/du<span class="p">;</span><span class="w"> </span><span class="k">do</span>
</span><span id="__span-8-386"><a id="__codelineno-8-386" name="__codelineno-8-386"></a><span class="w">      </span><span class="nv">kbytes</span><span class="o">=</span><span class="k">$(</span>sudo<span class="w"> </span>du<span class="w"> </span>-s<span class="w"> </span><span class="s2">"</span><span class="si">${</span><span class="nv">path</span><span class="si">}</span><span class="s2">"</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>awk<span class="w"> </span><span class="s1">'{print $1}'</span><span class="k">)</span>
</span><span id="__span-8-387"><a id="__codelineno-8-387" name="__codelineno-8-387"></a><span class="w">      </span><span class="nv">bytes</span><span class="o">=</span><span class="k">$((</span><span class="m">1024</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nv">kbytes</span><span class="k">))</span>
</span><span id="__span-8-388"><a id="__codelineno-8-388" name="__codelineno-8-388"></a><span class="w">      </span>store_line<span class="w"> </span><span class="s2">"du,host=</span><span class="si">${</span><span class="nv">host</span><span class="si">}</span><span class="s2">,path=</span><span class="si">${</span><span class="nv">path</span><span class="si">}</span><span class="s2"> value=</span><span class="si">${</span><span class="nv">bytes</span><span class="si">}</span><span class="s2"> </span><span class="si">${</span><span class="nv">ts</span><span class="si">}</span><span class="s2">"</span>
</span><span id="__span-8-389"><a id="__codelineno-8-389" name="__codelineno-8-389"></a><span class="w">    </span><span class="k">done</span>
</span><span id="__span-8-390"><a id="__codelineno-8-390" name="__codelineno-8-390"></a><span class="w">    </span>sleep<span class="w"> </span><span class="si">${</span><span class="nv">DELAY_SLOW</span><span class="si">}</span>
</span><span id="__span-8-391"><a id="__codelineno-8-391" name="__codelineno-8-391"></a><span class="w">  </span><span class="k">done</span>
</span><span id="__span-8-392"><a id="__codelineno-8-392" name="__codelineno-8-392"></a><span class="o">}</span>
</span><span id="__span-8-393"><a id="__codelineno-8-393" name="__codelineno-8-393"></a>
</span><span id="__span-8-394"><a id="__codelineno-8-394" name="__codelineno-8-394"></a>post_lines_to_influxdb<span class="o">()</span><span class="w"> </span><span class="o">{</span>
</span><span id="__span-8-395"><a id="__codelineno-8-395" name="__codelineno-8-395"></a><span class="w">  </span><span class="c1"># POST data to InfluxDB in batch, when targets are available.</span>
</span><span id="__span-8-396"><a id="__codelineno-8-396" name="__codelineno-8-396"></a><span class="w">  </span><span class="c1"># Depends on: curl, nc.</span>
</span><span id="__span-8-397"><a id="__codelineno-8-397" name="__codelineno-8-397"></a><span class="w">  </span><span class="c1"># All other tasks write data to the file in append mode (&gt;&gt;).</span>
</span><span id="__span-8-398"><a id="__codelineno-8-398" name="__codelineno-8-398"></a><span class="w">  </span><span class="c1"># This task reads everything at once and immediately deletes the file.</span>
</span><span id="__span-8-399"><a id="__codelineno-8-399" name="__codelineno-8-399"></a><span class="w">  </span><span class="c1"># This makes all the other tasks write to the same file, created anew.</span>
</span><span id="__span-8-400"><a id="__codelineno-8-400" name="__codelineno-8-400"></a><span class="w">  </span><span class="c1"># To avoid losing data between reading and delete the file, rename it,</span>
</span><span id="__span-8-401"><a id="__codelineno-8-401" name="__codelineno-8-401"></a><span class="w">  </span><span class="c1"># wait a little (DELAY_FAST) for the writes of tasks that already had</span>
</span><span id="__span-8-402"><a id="__codelineno-8-402" name="__codelineno-8-402"></a><span class="w">  </span><span class="c1"># it open, then other tasks will have to write to a new file.</span>
</span><span id="__span-8-403"><a id="__codelineno-8-403" name="__codelineno-8-403"></a><span class="w">  </span><span class="k">while</span><span class="w"> </span>true<span class="p">;</span><span class="w"> </span><span class="k">do</span>
</span><span id="__span-8-404"><a id="__codelineno-8-404" name="__codelineno-8-404"></a><span class="w">    </span>sleep<span class="w"> </span><span class="si">${</span><span class="nv">DELAY_POST</span><span class="si">}</span>
</span><span id="__span-8-405"><a id="__codelineno-8-405" name="__codelineno-8-405"></a><span class="w">    </span>mv<span class="w"> </span>-f<span class="w"> </span><span class="s2">"</span><span class="si">${</span><span class="nv">DATA</span><span class="si">}</span><span class="s2">"</span><span class="w"> </span><span class="s2">"</span><span class="si">${</span><span class="nv">DATA</span><span class="si">}</span><span class="s2">.POST"</span>
</span><span id="__span-8-406"><a id="__codelineno-8-406" name="__codelineno-8-406"></a><span class="w">    </span><span class="c1"># Post over HTTP without auth.</span>
</span><span id="__span-8-407"><a id="__codelineno-8-407" name="__codelineno-8-407"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span>-n<span class="w"> </span><span class="s2">"</span><span class="nv">$TARGET_HTTP</span><span class="s2">"</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
</span><span id="__span-8-408"><a id="__codelineno-8-408" name="__codelineno-8-408"></a><span class="w">      </span><span class="nv">host_and_port</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span><span class="w"> </span><span class="s2">"</span><span class="nv">$TARGET_HTTP</span><span class="s2">"</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>sed<span class="w"> </span><span class="s1">'s/.*\///'</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>tr<span class="w"> </span>:<span class="w"> </span><span class="s1">' '</span><span class="k">)</span>
</span><span id="__span-8-409"><a id="__codelineno-8-409" name="__codelineno-8-409"></a><span class="w">      </span><span class="k">if</span><span class="w"> </span>nc<span class="w"> </span><span class="m">2</span>&gt;<span class="p">&amp;</span><span class="m">1</span><span class="w"> </span>-zv<span class="w"> </span><span class="nv">$host_and_port</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>-q<span class="w"> </span>succeeded<span class="p">;</span><span class="w"> </span><span class="k">then</span>
</span><span id="__span-8-410"><a id="__codelineno-8-410" name="__codelineno-8-410"></a><span class="w">        </span>curl<span class="w"> </span>&gt;/dev/null<span class="w"> </span><span class="m">2</span>&gt;/dev/null<span class="w"> </span><span class="se">\</span>
</span><span id="__span-8-411"><a id="__codelineno-8-411" name="__codelineno-8-411"></a><span class="w">          </span>-i<span class="w"> </span>-XPOST<span class="w"> </span><span class="s2">"</span><span class="si">${</span><span class="nv">TARGET_HTTP</span><span class="si">}</span><span class="s2">/write?db=</span><span class="si">${</span><span class="nv">DBNAME</span><span class="si">}</span><span class="s2">"</span><span class="w"> </span><span class="se">\</span>
</span><span id="__span-8-412"><a id="__codelineno-8-412" name="__codelineno-8-412"></a><span class="w">          </span>--data-binary<span class="w"> </span>@<span class="s2">"</span><span class="si">${</span><span class="nv">DATA</span><span class="si">}</span><span class="s2">.POST"</span>
</span><span id="__span-8-413"><a id="__codelineno-8-413" name="__codelineno-8-413"></a><span class="w">      </span><span class="k">fi</span>
</span><span id="__span-8-414"><a id="__codelineno-8-414" name="__codelineno-8-414"></a><span class="w">    </span><span class="k">fi</span>
</span><span id="__span-8-415"><a id="__codelineno-8-415" name="__codelineno-8-415"></a><span class="w">    </span><span class="c1"># Post over HTTPS with Basic Auth, provided credentials are</span>
</span><span id="__span-8-416"><a id="__codelineno-8-416" name="__codelineno-8-416"></a><span class="w">    </span><span class="c1"># found in /etc/conmon/influxdb-auth</span>
</span><span id="__span-8-417"><a id="__codelineno-8-417" name="__codelineno-8-417"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span>-n<span class="w"> </span><span class="s2">"</span><span class="nv">$TARGET_HTTPS</span><span class="s2">"</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
</span><span id="__span-8-418"><a id="__codelineno-8-418" name="__codelineno-8-418"></a><span class="w">      </span><span class="nv">influxdb_auth</span><span class="o">=</span>/etc/conmon/influxdb-auth
</span><span id="__span-8-419"><a id="__codelineno-8-419" name="__codelineno-8-419"></a><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span>-z<span class="w"> </span><span class="nv">$influxdb_auth</span><span class="w"> </span><span class="o">]</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="o">[</span><span class="w"> </span>!<span class="w"> </span>-f<span class="w"> </span><span class="nv">$influxdb_auth</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
</span><span id="__span-8-420"><a id="__codelineno-8-420" name="__codelineno-8-420"></a><span class="w">        </span><span class="k">return</span>
</span><span id="__span-8-421"><a id="__codelineno-8-421" name="__codelineno-8-421"></a><span class="w">      </span><span class="k">fi</span>
</span><span id="__span-8-422"><a id="__codelineno-8-422" name="__codelineno-8-422"></a><span class="w">      </span><span class="nv">host_and_port</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span><span class="w"> </span><span class="s2">"</span><span class="nv">$TARGET_HTTPS</span><span class="s2">"</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>sed<span class="w"> </span><span class="s1">'s/.*\///'</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>tr<span class="w"> </span>:<span class="w"> </span><span class="s1">' '</span><span class="k">)</span>
</span><span id="__span-8-423"><a id="__codelineno-8-423" name="__codelineno-8-423"></a><span class="w">      </span><span class="k">if</span><span class="w"> </span>nc<span class="w"> </span><span class="m">2</span>&gt;<span class="p">&amp;</span><span class="m">1</span><span class="w"> </span>-zv<span class="w"> </span><span class="nv">$host_and_port</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>-q<span class="w"> </span>succeeded<span class="p">;</span><span class="w"> </span><span class="k">then</span>
</span><span id="__span-8-424"><a id="__codelineno-8-424" name="__codelineno-8-424"></a><span class="w">        </span>curl<span class="w"> </span>&gt;/dev/null<span class="w"> </span><span class="m">2</span>&gt;/dev/null<span class="w"> </span><span class="se">\</span>
</span><span id="__span-8-425"><a id="__codelineno-8-425" name="__codelineno-8-425"></a><span class="w">          </span>-u<span class="w"> </span><span class="k">$(</span>sudo<span class="w"> </span>cat<span class="w"> </span><span class="nv">$influxdb_auth</span><span class="k">)</span><span class="w"> </span><span class="se">\</span>
</span><span id="__span-8-426"><a id="__codelineno-8-426" name="__codelineno-8-426"></a><span class="w">          </span>-i<span class="w"> </span>-XPOST<span class="w"> </span><span class="s2">"</span><span class="si">${</span><span class="nv">TARGET_HTTPS</span><span class="si">}</span><span class="s2">/write?db=</span><span class="si">${</span><span class="nv">DBNAME</span><span class="si">}</span><span class="s2">"</span><span class="w"> </span><span class="se">\</span>
</span><span id="__span-8-427"><a id="__codelineno-8-427" name="__codelineno-8-427"></a><span class="w">          </span>--data-binary<span class="w"> </span>@<span class="s2">"</span><span class="si">${</span><span class="nv">DATA</span><span class="si">}</span><span class="s2">.POST"</span>
</span><span id="__span-8-428"><a id="__codelineno-8-428" name="__codelineno-8-428"></a><span class="w">      </span><span class="k">fi</span>
</span><span id="__span-8-429"><a id="__codelineno-8-429" name="__codelineno-8-429"></a><span class="w">    </span><span class="k">fi</span>
</span><span id="__span-8-430"><a id="__codelineno-8-430" name="__codelineno-8-430"></a><span class="w">  </span><span class="k">done</span>
</span><span id="__span-8-431"><a id="__codelineno-8-431" name="__codelineno-8-431"></a><span class="o">}</span>
</span><span id="__span-8-432"><a id="__codelineno-8-432" name="__codelineno-8-432"></a>
</span><span id="__span-8-433"><a id="__codelineno-8-433" name="__codelineno-8-433"></a><span class="c1"># Run all the above tasks in parallel.</span>
</span><span id="__span-8-434"><a id="__codelineno-8-434" name="__codelineno-8-434"></a><span class="c1"># Each task is responsible of its own checks and sampling ratio / delay.</span>
</span><span id="__span-8-435"><a id="__codelineno-8-435" name="__codelineno-8-435"></a>report_df<span class="w"> </span><span class="p">&amp;</span>
</span><span id="__span-8-436"><a id="__codelineno-8-436" name="__codelineno-8-436"></a>report_du<span class="w"> </span><span class="p">&amp;</span>
</span><span id="__span-8-437"><a id="__codelineno-8-437" name="__codelineno-8-437"></a>report_top<span class="w"> </span><span class="p">&amp;</span>
</span><span id="__span-8-438"><a id="__codelineno-8-438" name="__codelineno-8-438"></a>report_free<span class="w"> </span><span class="p">&amp;</span>
</span><span id="__span-8-439"><a id="__codelineno-8-439" name="__codelineno-8-439"></a>report_iotop<span class="w"> </span><span class="p">&amp;</span>
</span><span id="__span-8-440"><a id="__codelineno-8-440" name="__codelineno-8-440"></a>report_sensors<span class="w"> </span><span class="p">&amp;</span>
</span><span id="__span-8-441"><a id="__codelineno-8-441" name="__codelineno-8-441"></a>report_net_dev<span class="w"> </span><span class="p">&amp;</span>
</span><span id="__span-8-442"><a id="__codelineno-8-442" name="__codelineno-8-442"></a>report_vcgencmd<span class="w"> </span><span class="p">&amp;</span>
</span><span id="__span-8-443"><a id="__codelineno-8-443" name="__codelineno-8-443"></a>report_diskstats<span class="w"> </span><span class="p">&amp;</span>
</span><span id="__span-8-444"><a id="__codelineno-8-444" name="__codelineno-8-444"></a>report_nvidia_smi<span class="w"> </span><span class="p">&amp;</span>
</span><span id="__span-8-445"><a id="__codelineno-8-445" name="__codelineno-8-445"></a>report_intel_gpu_top<span class="w"> </span><span class="p">&amp;</span>
</span><span id="__span-8-446"><a id="__codelineno-8-446" name="__codelineno-8-446"></a>post_lines_to_influxdb<span class="w"> </span><span class="p">&amp;</span>
</span><span id="__span-8-447"><a id="__codelineno-8-447" name="__codelineno-8-447"></a>
</span><span id="__span-8-448"><a id="__codelineno-8-448" name="__codelineno-8-448"></a><span class="c1"># HACK: sleep for a while before leaving all the above tasks running in the</span>
</span><span id="__span-8-449"><a id="__codelineno-8-449" name="__codelineno-8-449"></a><span class="c1"># background. This is so that this can be ended with Ctrl+C.</span>
</span><span id="__span-8-450"><a id="__codelineno-8-450" name="__codelineno-8-450"></a>sleep<span class="w"> </span><span class="m">10000000000</span>
</span></code></pre></div></td></tr></table></div>
<h2 id="additional-scripts">Additional scripts</h2>
<h3 id="conmon-speedtest"><code>conmon-speedtest</code></h3>
<div class="language-bash highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">conmon-speedtest</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-9-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-9-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-9-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-9-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-9-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-9-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-9-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-9-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-9-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-9-10">10</a></span>
<span class="normal"><a href="#__codelineno-9-11">11</a></span>
<span class="normal"><a href="#__codelineno-9-12">12</a></span>
<span class="normal"><a href="#__codelineno-9-13">13</a></span>
<span class="normal"><a href="#__codelineno-9-14">14</a></span>
<span class="normal"><a href="#__codelineno-9-15">15</a></span>
<span class="normal"><a href="#__codelineno-9-16">16</a></span>
<span class="normal"><a href="#__codelineno-9-17">17</a></span>
<span class="normal"><a href="#__codelineno-9-18">18</a></span>
<span class="normal"><a href="#__codelineno-9-19">19</a></span>
<span class="normal"><a href="#__codelineno-9-20">20</a></span>
<span class="normal"><a href="#__codelineno-9-21">21</a></span>
<span class="normal"><a href="#__codelineno-9-22">22</a></span>
<span class="normal"><a href="#__codelineno-9-23">23</a></span>
<span class="normal"><a href="#__codelineno-9-24">24</a></span>
<span class="normal"><a href="#__codelineno-9-25">25</a></span>
<span class="normal"><a href="#__codelineno-9-26">26</a></span>
<span class="normal"><a href="#__codelineno-9-27">27</a></span>
<span class="normal"><a href="#__codelineno-9-28">28</a></span>
<span class="normal"><a href="#__codelineno-9-29">29</a></span>
<span class="normal"><a href="#__codelineno-9-30">30</a></span>
<span class="normal"><a href="#__codelineno-9-31">31</a></span>
<span class="normal"><a href="#__codelineno-9-32">32</a></span>
<span class="normal"><a href="#__codelineno-9-33">33</a></span>
<span class="normal"><a href="#__codelineno-9-34">34</a></span>
<span class="normal"><a href="#__codelineno-9-35">35</a></span>
<span class="normal"><a href="#__codelineno-9-36">36</a></span>
<span class="normal"><a href="#__codelineno-9-37">37</a></span>
<span class="normal"><a href="#__codelineno-9-38">38</a></span>
<span class="normal"><a href="#__codelineno-9-39">39</a></span>
<span class="normal"><a href="#__codelineno-9-40">40</a></span>
<span class="normal"><a href="#__codelineno-9-41">41</a></span>
<span class="normal"><a href="#__codelineno-9-42">42</a></span>
<span class="normal"><a href="#__codelineno-9-43">43</a></span>
<span class="normal"><a href="#__codelineno-9-44">44</a></span>
<span class="normal"><a href="#__codelineno-9-45">45</a></span>
<span class="normal"><a href="#__codelineno-9-46">46</a></span>
<span class="normal"><a href="#__codelineno-9-47">47</a></span>
<span class="normal"><a href="#__codelineno-9-48">48</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-9-1"><a id="__codelineno-9-1" name="__codelineno-9-1"></a><span class="ch">#!/bin/bash</span>
</span><span id="__span-9-2"><a id="__codelineno-9-2" name="__codelineno-9-2"></a>
</span><span id="__span-9-3"><a id="__codelineno-9-3" name="__codelineno-9-3"></a><span class="c1"># InfluxDB target.</span>
</span><span id="__span-9-4"><a id="__codelineno-9-4" name="__codelineno-9-4"></a><span class="nv">DBNAME</span><span class="o">=</span>monitoring
</span><span id="__span-9-5"><a id="__codelineno-9-5" name="__codelineno-9-5"></a><span class="nv">TARGET_HTTP</span><span class="o">=</span><span class="s1">''</span><span class="w"> </span><span class="c1"># Leave empty to skip.</span>
</span><span id="__span-9-6"><a id="__codelineno-9-6" name="__codelineno-9-6"></a><span class="nv">TARGET_HTTPS</span><span class="o">=</span><span class="s1">'http://lexicon:30086'</span>
</span><span id="__span-9-7"><a id="__codelineno-9-7" name="__codelineno-9-7"></a>
</span><span id="__span-9-8"><a id="__codelineno-9-8" name="__codelineno-9-8"></a><span class="nv">host</span><span class="o">=</span><span class="k">$(</span>hostname<span class="k">)</span>
</span><span id="__span-9-9"><a id="__codelineno-9-9" name="__codelineno-9-9"></a>
</span><span id="__span-9-10"><a id="__codelineno-9-10" name="__codelineno-9-10"></a><span class="c1"># Data file for batch POST.</span>
</span><span id="__span-9-11"><a id="__codelineno-9-11" name="__codelineno-9-11"></a><span class="nv">DATA</span><span class="o">=</span><span class="s2">"/dev/shm/</span><span class="nv">$$</span><span class="s2">.txt"</span>
</span><span id="__span-9-12"><a id="__codelineno-9-12" name="__codelineno-9-12"></a>
</span><span id="__span-9-13"><a id="__codelineno-9-13" name="__codelineno-9-13"></a><span class="nv">tmp</span><span class="o">=</span>/dev/shm/speedtest
</span><span id="__span-9-14"><a id="__codelineno-9-14" name="__codelineno-9-14"></a>speedtest-cli<span class="w"> </span>--secure<span class="w"> </span>&gt;<span class="nv">$tmp</span>
</span><span id="__span-9-15"><a id="__codelineno-9-15" name="__codelineno-9-15"></a><span class="nv">netspd_up</span><span class="o">=</span><span class="k">$(</span>grep<span class="w"> </span>-E<span class="w"> </span><span class="s1">'Upload'</span><span class="w"> </span><span class="nv">$tmp</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>cut<span class="w"> </span>-f2<span class="w"> </span>-d:<span class="w"> </span><span class="p">|</span><span class="w"> </span>egrep<span class="w"> </span>-o<span class="w"> </span><span class="s1">'[0-9]+\.[0-9]'</span><span class="k">)</span>
</span><span id="__span-9-16"><a id="__codelineno-9-16" name="__codelineno-9-16"></a><span class="nv">netspd_down</span><span class="o">=</span><span class="k">$(</span>cat<span class="w"> </span><span class="si">${</span><span class="nv">tmp</span><span class="si">}</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>egrep<span class="w"> </span><span class="s1">'Download'</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>cut<span class="w"> </span>-f2<span class="w"> </span>-d:<span class="w"> </span><span class="p">|</span><span class="w"> </span>egrep<span class="w"> </span>-o<span class="w"> </span><span class="s1">'[0-9]+\.[0-9]'</span><span class="k">)</span>
</span><span id="__span-9-17"><a id="__codelineno-9-17" name="__codelineno-9-17"></a><span class="nv">netspd_ping</span><span class="o">=</span><span class="k">$(</span>cat<span class="w"> </span><span class="si">${</span><span class="nv">tmp</span><span class="si">}</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>egrep<span class="w"> </span><span class="s1">'ms$'</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>cut<span class="w"> </span>-f2<span class="w"> </span>-d:<span class="w"> </span><span class="p">|</span><span class="w"> </span>egrep<span class="w"> </span>-o<span class="w"> </span><span class="s1">'[0-9]+\.[0-9]'</span><span class="k">)</span>
</span><span id="__span-9-18"><a id="__codelineno-9-18" name="__codelineno-9-18"></a>
</span><span id="__span-9-19"><a id="__codelineno-9-19" name="__codelineno-9-19"></a><span class="nb">echo</span><span class="w"> </span><span class="s2">"inet_up,host=</span><span class="si">${</span><span class="nv">host</span><span class="si">}</span><span class="s2"> value=</span><span class="si">${</span><span class="nv">netspd_up</span><span class="si">}</span><span class="s2">"</span><span class="w"> </span>&gt;&gt;<span class="s2">"</span><span class="nv">$DATA</span><span class="s2">"</span>
</span><span id="__span-9-20"><a id="__codelineno-9-20" name="__codelineno-9-20"></a><span class="nb">echo</span><span class="w"> </span><span class="s2">"inet_down,host=</span><span class="si">${</span><span class="nv">host</span><span class="si">}</span><span class="s2"> value=</span><span class="si">${</span><span class="nv">netspd_down</span><span class="si">}</span><span class="s2">"</span><span class="w"> </span>&gt;&gt;<span class="s2">"</span><span class="nv">$DATA</span><span class="s2">"</span>
</span><span id="__span-9-21"><a id="__codelineno-9-21" name="__codelineno-9-21"></a><span class="nb">echo</span><span class="w"> </span><span class="s2">"inet_ping,host=</span><span class="si">${</span><span class="nv">host</span><span class="si">}</span><span class="s2"> value=</span><span class="si">${</span><span class="nv">netspd_ping</span><span class="si">}</span><span class="s2">"</span><span class="w"> </span>&gt;&gt;<span class="s2">"</span><span class="nv">$DATA</span><span class="s2">"</span>
</span><span id="__span-9-22"><a id="__codelineno-9-22" name="__codelineno-9-22"></a>
</span><span id="__span-9-23"><a id="__codelineno-9-23" name="__codelineno-9-23"></a><span class="c1"># POST all data points in one batch request.</span>
</span><span id="__span-9-24"><a id="__codelineno-9-24" name="__codelineno-9-24"></a><span class="c1"># Post over HTTP without auth.</span>
</span><span id="__span-9-25"><a id="__codelineno-9-25" name="__codelineno-9-25"></a><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span>-n<span class="w"> </span><span class="s2">"</span><span class="nv">$TARGET_HTTP</span><span class="s2">"</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
</span><span id="__span-9-26"><a id="__codelineno-9-26" name="__codelineno-9-26"></a><span class="w">    </span><span class="nv">host_and_port</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span><span class="w"> </span><span class="nv">$TARGET_HTTP</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>sed<span class="w"> </span><span class="s1">'s/.*\///'</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>tr<span class="w"> </span>:<span class="w"> </span><span class="s1">' '</span><span class="k">)</span>
</span><span id="__span-9-27"><a id="__codelineno-9-27" name="__codelineno-9-27"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span>nc<span class="w"> </span><span class="m">2</span>&gt;<span class="p">&amp;</span><span class="m">1</span><span class="w"> </span>-zv<span class="w"> </span><span class="nv">$host_and_port</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>-q<span class="w"> </span>succeeded<span class="p">;</span><span class="w"> </span><span class="k">then</span>
</span><span id="__span-9-28"><a id="__codelineno-9-28" name="__codelineno-9-28"></a><span class="w">        </span>curl<span class="w"> </span>&gt;/dev/null<span class="w"> </span><span class="m">2</span>&gt;/dev/null<span class="w"> </span><span class="se">\</span>
</span><span id="__span-9-29"><a id="__codelineno-9-29" name="__codelineno-9-29"></a><span class="w">            </span>-i<span class="w"> </span>-XPOST<span class="w"> </span><span class="s2">"</span><span class="si">${</span><span class="nv">TARGET_HTTP</span><span class="si">}</span><span class="s2">/write?db=</span><span class="si">${</span><span class="nv">DBNAME</span><span class="si">}</span><span class="s2">"</span><span class="w"> </span><span class="se">\</span>
</span><span id="__span-9-30"><a id="__codelineno-9-30" name="__codelineno-9-30"></a><span class="w">            </span>--data-binary<span class="w"> </span>@<span class="s2">"</span><span class="si">${</span><span class="nv">DATA</span><span class="si">}</span><span class="s2">"</span>
</span><span id="__span-9-31"><a id="__codelineno-9-31" name="__codelineno-9-31"></a><span class="w">    </span><span class="k">fi</span>
</span><span id="__span-9-32"><a id="__codelineno-9-32" name="__codelineno-9-32"></a><span class="k">fi</span>
</span><span id="__span-9-33"><a id="__codelineno-9-33" name="__codelineno-9-33"></a><span class="c1"># Post over HTTPS with Basic Auth, provided credentials are</span>
</span><span id="__span-9-34"><a id="__codelineno-9-34" name="__codelineno-9-34"></a><span class="c1"># found in /etc/conmon/influxdb-auth</span>
</span><span id="__span-9-35"><a id="__codelineno-9-35" name="__codelineno-9-35"></a><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span>-n<span class="w"> </span><span class="s2">"</span><span class="nv">$TARGET_HTTPS</span><span class="s2">"</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
</span><span id="__span-9-36"><a id="__codelineno-9-36" name="__codelineno-9-36"></a><span class="w">    </span><span class="nv">influxdb_auth</span><span class="o">=</span>/etc/conmon/influxdb-auth
</span><span id="__span-9-37"><a id="__codelineno-9-37" name="__codelineno-9-37"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span>-z<span class="w"> </span><span class="nv">$influxdb_auth</span><span class="w"> </span><span class="o">]</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="o">[</span><span class="w"> </span>!<span class="w"> </span>-f<span class="w"> </span><span class="nv">$influxdb_auth</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
</span><span id="__span-9-38"><a id="__codelineno-9-38" name="__codelineno-9-38"></a><span class="w">        </span><span class="nb">exit</span><span class="w"> </span><span class="m">1</span>
</span><span id="__span-9-39"><a id="__codelineno-9-39" name="__codelineno-9-39"></a><span class="w">    </span><span class="k">fi</span>
</span><span id="__span-9-40"><a id="__codelineno-9-40" name="__codelineno-9-40"></a><span class="w">    </span><span class="nv">host_and_port</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span><span class="w"> </span><span class="nv">$TARGET_HTTPS</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>sed<span class="w"> </span><span class="s1">'s/.*\///'</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>tr<span class="w"> </span>:<span class="w"> </span><span class="s1">' '</span><span class="k">)</span>
</span><span id="__span-9-41"><a id="__codelineno-9-41" name="__codelineno-9-41"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span>nc<span class="w"> </span><span class="m">2</span>&gt;<span class="p">&amp;</span><span class="m">1</span><span class="w"> </span>-zv<span class="w"> </span><span class="nv">$host_and_port</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>-q<span class="w"> </span>succeeded<span class="p">;</span><span class="w"> </span><span class="k">then</span>
</span><span id="__span-9-42"><a id="__codelineno-9-42" name="__codelineno-9-42"></a><span class="w">        </span>curl<span class="w"> </span>&gt;/dev/null<span class="w"> </span><span class="m">2</span>&gt;/dev/null<span class="w"> </span><span class="se">\</span>
</span><span id="__span-9-43"><a id="__codelineno-9-43" name="__codelineno-9-43"></a><span class="w">            </span>-u<span class="w"> </span><span class="k">$(</span>cat<span class="w"> </span><span class="nv">$influxdb_auth</span><span class="k">)</span><span class="w"> </span><span class="se">\</span>
</span><span id="__span-9-44"><a id="__codelineno-9-44" name="__codelineno-9-44"></a><span class="w">            </span>-i<span class="w"> </span>-XPOST<span class="w"> </span><span class="s2">"</span><span class="si">${</span><span class="nv">TARGET_HTTPS</span><span class="si">}</span><span class="s2">/write?db=</span><span class="si">${</span><span class="nv">DBNAME</span><span class="si">}</span><span class="s2">"</span><span class="w"> </span><span class="se">\</span>
</span><span id="__span-9-45"><a id="__codelineno-9-45" name="__codelineno-9-45"></a><span class="w">            </span>--data-binary<span class="w"> </span>@<span class="s2">"</span><span class="si">${</span><span class="nv">DATA</span><span class="si">}</span><span class="s2">"</span>
</span><span id="__span-9-46"><a id="__codelineno-9-46" name="__codelineno-9-46"></a><span class="w">    </span><span class="k">fi</span>
</span><span id="__span-9-47"><a id="__codelineno-9-47" name="__codelineno-9-47"></a><span class="k">fi</span>
</span><span id="__span-9-48"><a id="__codelineno-9-48" name="__codelineno-9-48"></a>rm<span class="w"> </span>-f<span class="w"> </span><span class="s2">"</span><span class="si">${</span><span class="nv">DATA</span><span class="si">}</span><span class="s2">"</span>
</span></code></pre></div></td></tr></table></div>
<h3 id="conmon-mystrom"><code>conmon-mystrom</code></h3>
<div class="language-bash highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">conmon-mystrom</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-10-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-10-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-10-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-10-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-10-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-10-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-10-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-10-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-10-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-10-10">10</a></span>
<span class="normal"><a href="#__codelineno-10-11">11</a></span>
<span class="normal"><a href="#__codelineno-10-12">12</a></span>
<span class="normal"><a href="#__codelineno-10-13">13</a></span>
<span class="normal"><a href="#__codelineno-10-14">14</a></span>
<span class="normal"><a href="#__codelineno-10-15">15</a></span>
<span class="normal"><a href="#__codelineno-10-16">16</a></span>
<span class="normal"><a href="#__codelineno-10-17">17</a></span>
<span class="normal"><a href="#__codelineno-10-18">18</a></span>
<span class="normal"><a href="#__codelineno-10-19">19</a></span>
<span class="normal"><a href="#__codelineno-10-20">20</a></span>
<span class="normal"><a href="#__codelineno-10-21">21</a></span>
<span class="normal"><a href="#__codelineno-10-22">22</a></span>
<span class="normal"><a href="#__codelineno-10-23">23</a></span>
<span class="normal"><a href="#__codelineno-10-24">24</a></span>
<span class="normal"><a href="#__codelineno-10-25">25</a></span>
<span class="normal"><a href="#__codelineno-10-26">26</a></span>
<span class="normal"><a href="#__codelineno-10-27">27</a></span>
<span class="normal"><a href="#__codelineno-10-28">28</a></span>
<span class="normal"><a href="#__codelineno-10-29">29</a></span>
<span class="normal"><a href="#__codelineno-10-30">30</a></span>
<span class="normal"><a href="#__codelineno-10-31">31</a></span>
<span class="normal"><a href="#__codelineno-10-32">32</a></span>
<span class="normal"><a href="#__codelineno-10-33">33</a></span>
<span class="normal"><a href="#__codelineno-10-34">34</a></span>
<span class="normal"><a href="#__codelineno-10-35">35</a></span>
<span class="normal"><a href="#__codelineno-10-36">36</a></span>
<span class="normal"><a href="#__codelineno-10-37">37</a></span>
<span class="normal"><a href="#__codelineno-10-38">38</a></span>
<span class="normal"><a href="#__codelineno-10-39">39</a></span>
<span class="normal"><a href="#__codelineno-10-40">40</a></span>
<span class="normal"><a href="#__codelineno-10-41">41</a></span>
<span class="normal"><a href="#__codelineno-10-42">42</a></span>
<span class="normal"><a href="#__codelineno-10-43">43</a></span>
<span class="normal"><a href="#__codelineno-10-44">44</a></span>
<span class="normal"><a href="#__codelineno-10-45">45</a></span>
<span class="normal"><a href="#__codelineno-10-46">46</a></span>
<span class="normal"><a href="#__codelineno-10-47">47</a></span>
<span class="normal"><a href="#__codelineno-10-48">48</a></span>
<span class="normal"><a href="#__codelineno-10-49">49</a></span>
<span class="normal"><a href="#__codelineno-10-50">50</a></span>
<span class="normal"><a href="#__codelineno-10-51">51</a></span>
<span class="normal"><a href="#__codelineno-10-52">52</a></span>
<span class="normal"><a href="#__codelineno-10-53">53</a></span>
<span class="normal"><a href="#__codelineno-10-54">54</a></span>
<span class="normal"><a href="#__codelineno-10-55">55</a></span>
<span class="normal"><a href="#__codelineno-10-56">56</a></span>
<span class="normal"><a href="#__codelineno-10-57">57</a></span>
<span class="normal"><a href="#__codelineno-10-58">58</a></span>
<span class="normal"><a href="#__codelineno-10-59">59</a></span>
<span class="normal"><a href="#__codelineno-10-60">60</a></span>
<span class="normal"><a href="#__codelineno-10-61">61</a></span>
<span class="normal"><a href="#__codelineno-10-62">62</a></span>
<span class="normal"><a href="#__codelineno-10-63">63</a></span>
<span class="normal"><a href="#__codelineno-10-64">64</a></span>
<span class="normal"><a href="#__codelineno-10-65">65</a></span>
<span class="normal"><a href="#__codelineno-10-66">66</a></span>
<span class="normal"><a href="#__codelineno-10-67">67</a></span>
<span class="normal"><a href="#__codelineno-10-68">68</a></span>
<span class="normal"><a href="#__codelineno-10-69">69</a></span>
<span class="normal"><a href="#__codelineno-10-70">70</a></span>
<span class="normal"><a href="#__codelineno-10-71">71</a></span>
<span class="normal"><a href="#__codelineno-10-72">72</a></span>
<span class="normal"><a href="#__codelineno-10-73">73</a></span>
<span class="normal"><a href="#__codelineno-10-74">74</a></span>
<span class="normal"><a href="#__codelineno-10-75">75</a></span>
<span class="normal"><a href="#__codelineno-10-76">76</a></span>
<span class="normal"><a href="#__codelineno-10-77">77</a></span>
<span class="normal"><a href="#__codelineno-10-78">78</a></span>
<span class="normal"><a href="#__codelineno-10-79">79</a></span>
<span class="normal"><a href="#__codelineno-10-80">80</a></span>
<span class="normal"><a href="#__codelineno-10-81">81</a></span>
<span class="normal"><a href="#__codelineno-10-82">82</a></span>
<span class="normal"><a href="#__codelineno-10-83">83</a></span>
<span class="normal"><a href="#__codelineno-10-84">84</a></span>
<span class="normal"><a href="#__codelineno-10-85">85</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-10-1"><a id="__codelineno-10-1" name="__codelineno-10-1"></a><span class="ch">#!/bin/bash</span>
</span><span id="__span-10-2"><a id="__codelineno-10-2" name="__codelineno-10-2"></a><span class="c1">#</span>
</span><span id="__span-10-3"><a id="__codelineno-10-3" name="__codelineno-10-3"></a><span class="c1"># Export system monitoring metrics to influxdb.</span>
</span><span id="__span-10-4"><a id="__codelineno-10-4" name="__codelineno-10-4"></a>
</span><span id="__span-10-5"><a id="__codelineno-10-5" name="__codelineno-10-5"></a><span class="c1"># InfluxDB target.</span>
</span><span id="__span-10-6"><a id="__codelineno-10-6" name="__codelineno-10-6"></a><span class="nv">DBNAME</span><span class="o">=</span>monitoring
</span><span id="__span-10-7"><a id="__codelineno-10-7" name="__codelineno-10-7"></a><span class="nv">TARGET_HTTP</span><span class="o">=</span><span class="s1">''</span><span class="w"> </span><span class="c1"># Leave empty to skip.</span>
</span><span id="__span-10-8"><a id="__codelineno-10-8" name="__codelineno-10-8"></a><span class="nv">TARGET_HTTPS</span><span class="o">=</span><span class="s1">'http://lexicon:30086'</span>
</span><span id="__span-10-9"><a id="__codelineno-10-9" name="__codelineno-10-9"></a>
</span><span id="__span-10-10"><a id="__codelineno-10-10" name="__codelineno-10-10"></a><span class="c1"># MyStrom switches.</span>
</span><span id="__span-10-11"><a id="__codelineno-10-11" name="__codelineno-10-11"></a><span class="nb">declare</span><span class="w"> </span>-A<span class="w"> </span><span class="nv">switches</span><span class="o">=(</span>
</span><span id="__span-10-12"><a id="__codelineno-10-12" name="__codelineno-10-12"></a><span class="w">    </span><span class="o">[</span><span class="s2">"office"</span><span class="o">]=</span><span class="s2">"192.168.0.191"</span>
</span><span id="__span-10-13"><a id="__codelineno-10-13" name="__codelineno-10-13"></a><span class="o">)</span>
</span><span id="__span-10-14"><a id="__codelineno-10-14" name="__codelineno-10-14"></a>
</span><span id="__span-10-15"><a id="__codelineno-10-15" name="__codelineno-10-15"></a><span class="c1"># Default delay between each POST request to InfluxDB.</span>
</span><span id="__span-10-16"><a id="__codelineno-10-16" name="__codelineno-10-16"></a><span class="nv">DELAY_POST</span><span class="o">=</span><span class="m">4</span>
</span><span id="__span-10-17"><a id="__codelineno-10-17" name="__codelineno-10-17"></a>
</span><span id="__span-10-18"><a id="__codelineno-10-18" name="__codelineno-10-18"></a><span class="c1"># Data file for batch POST.</span>
</span><span id="__span-10-19"><a id="__codelineno-10-19" name="__codelineno-10-19"></a><span class="nv">DDIR</span><span class="o">=</span><span class="s2">"/dev/shm/</span><span class="nv">$$</span><span class="s2">"</span>
</span><span id="__span-10-20"><a id="__codelineno-10-20" name="__codelineno-10-20"></a><span class="nv">DATA</span><span class="o">=</span><span class="s2">"</span><span class="si">${</span><span class="nv">DDIR</span><span class="si">}</span><span class="s2">/DATA.txt"</span>
</span><span id="__span-10-21"><a id="__codelineno-10-21" name="__codelineno-10-21"></a>mkdir<span class="w"> </span>-p<span class="w"> </span><span class="s2">"</span><span class="si">${</span><span class="nv">DDIR</span><span class="si">}</span><span class="s2">"</span>
</span><span id="__span-10-22"><a id="__codelineno-10-22" name="__codelineno-10-22"></a>
</span><span id="__span-10-23"><a id="__codelineno-10-23" name="__codelineno-10-23"></a><span class="nv">host</span><span class="o">=</span><span class="k">$(</span>hostname<span class="k">)</span>
</span><span id="__span-10-24"><a id="__codelineno-10-24" name="__codelineno-10-24"></a>
</span><span id="__span-10-25"><a id="__codelineno-10-25" name="__codelineno-10-25"></a>timestamp_ns<span class="o">()</span><span class="w"> </span><span class="o">{</span>
</span><span id="__span-10-26"><a id="__codelineno-10-26" name="__codelineno-10-26"></a><span class="w">    </span>date<span class="w"> </span>+<span class="s1">'%s%N'</span>
</span><span id="__span-10-27"><a id="__codelineno-10-27" name="__codelineno-10-27"></a><span class="o">}</span>
</span><span id="__span-10-28"><a id="__codelineno-10-28" name="__codelineno-10-28"></a>
</span><span id="__span-10-29"><a id="__codelineno-10-29" name="__codelineno-10-29"></a>store_line<span class="o">()</span><span class="w"> </span><span class="o">{</span>
</span><span id="__span-10-30"><a id="__codelineno-10-30" name="__codelineno-10-30"></a><span class="w">    </span><span class="c1"># Write a line of data to the temporary in-memory file.</span>
</span><span id="__span-10-31"><a id="__codelineno-10-31" name="__codelineno-10-31"></a><span class="w">    </span><span class="c1"># Exit immediately if this fails.</span>
</span><span id="__span-10-32"><a id="__codelineno-10-32" name="__codelineno-10-32"></a><span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="nv">$1</span><span class="w"> </span>&gt;&gt;<span class="s2">"</span><span class="si">${</span><span class="nv">DATA</span><span class="si">}</span><span class="s2">"</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nb">exit</span><span class="w"> </span><span class="m">1</span>
</span><span id="__span-10-33"><a id="__codelineno-10-33" name="__codelineno-10-33"></a><span class="o">}</span>
</span><span id="__span-10-34"><a id="__codelineno-10-34" name="__codelineno-10-34"></a>
</span><span id="__span-10-35"><a id="__codelineno-10-35" name="__codelineno-10-35"></a>post_lines_to_influxdb<span class="o">()</span><span class="w"> </span><span class="o">{</span>
</span><span id="__span-10-36"><a id="__codelineno-10-36" name="__codelineno-10-36"></a><span class="w">    </span><span class="c1"># POST data to InfluxDB in batch, when target is available.</span>
</span><span id="__span-10-37"><a id="__codelineno-10-37" name="__codelineno-10-37"></a><span class="w">    </span><span class="c1"># Depends on: nc.</span>
</span><span id="__span-10-38"><a id="__codelineno-10-38" name="__codelineno-10-38"></a><span class="w">    </span><span class="c1"># All other tasks write data to the file in append mode (&gt;&gt;).</span>
</span><span id="__span-10-39"><a id="__codelineno-10-39" name="__codelineno-10-39"></a><span class="w">    </span><span class="c1"># This task reads everything at once and immediately deletes the file.</span>
</span><span id="__span-10-40"><a id="__codelineno-10-40" name="__codelineno-10-40"></a><span class="w">    </span><span class="c1"># This makes all the other tasks write to the same file, created anew.</span>
</span><span id="__span-10-41"><a id="__codelineno-10-41" name="__codelineno-10-41"></a><span class="w">    </span><span class="c1"># To avoid losing data between reading and delete the file, rename it,</span>
</span><span id="__span-10-42"><a id="__codelineno-10-42" name="__codelineno-10-42"></a><span class="w">    </span><span class="c1"># wait a little (DELAY_FAST) for the writes of tasks that already had</span>
</span><span id="__span-10-43"><a id="__codelineno-10-43" name="__codelineno-10-43"></a><span class="w">    </span><span class="c1"># it open, then other tasks will have to write to a new file.</span>
</span><span id="__span-10-44"><a id="__codelineno-10-44" name="__codelineno-10-44"></a><span class="w">    </span><span class="c1"># Post over HTTP without auth.</span>
</span><span id="__span-10-45"><a id="__codelineno-10-45" name="__codelineno-10-45"></a><span class="w">    </span>sleep<span class="w"> </span><span class="si">${</span><span class="nv">DELAY_POST</span><span class="si">}</span>
</span><span id="__span-10-46"><a id="__codelineno-10-46" name="__codelineno-10-46"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span>-n<span class="w"> </span><span class="s2">"</span><span class="nv">$TARGET_HTTP</span><span class="s2">"</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
</span><span id="__span-10-47"><a id="__codelineno-10-47" name="__codelineno-10-47"></a><span class="w">        </span><span class="nv">host_and_port</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span><span class="w"> </span><span class="nv">$TARGET_HTTP</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>sed<span class="w"> </span><span class="s1">'s/.*\///'</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>tr<span class="w"> </span>:<span class="w"> </span><span class="s1">' '</span><span class="k">)</span>
</span><span id="__span-10-48"><a id="__codelineno-10-48" name="__codelineno-10-48"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span>nc<span class="w"> </span><span class="m">2</span>&gt;<span class="p">&amp;</span><span class="m">1</span><span class="w"> </span>-zv<span class="w"> </span><span class="nv">$host_and_port</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>-q<span class="w"> </span>succeeded<span class="p">;</span><span class="w"> </span><span class="k">then</span>
</span><span id="__span-10-49"><a id="__codelineno-10-49" name="__codelineno-10-49"></a><span class="w">            </span>curl<span class="w"> </span>&gt;/dev/null<span class="w"> </span><span class="m">2</span>&gt;/dev/null<span class="w"> </span><span class="se">\</span>
</span><span id="__span-10-50"><a id="__codelineno-10-50" name="__codelineno-10-50"></a><span class="w">                </span>-i<span class="w"> </span>-XPOST<span class="w"> </span><span class="s2">"</span><span class="si">${</span><span class="nv">TARGET_HTTP</span><span class="si">}</span><span class="s2">/write?db=</span><span class="si">${</span><span class="nv">DBNAME</span><span class="si">}</span><span class="s2">"</span><span class="w"> </span><span class="se">\</span>
</span><span id="__span-10-51"><a id="__codelineno-10-51" name="__codelineno-10-51"></a><span class="w">                </span>--data-binary<span class="w"> </span>@<span class="s2">"</span><span class="si">${</span><span class="nv">DATA</span><span class="si">}</span><span class="s2">"</span>
</span><span id="__span-10-52"><a id="__codelineno-10-52" name="__codelineno-10-52"></a><span class="w">        </span><span class="k">fi</span>
</span><span id="__span-10-53"><a id="__codelineno-10-53" name="__codelineno-10-53"></a><span class="w">    </span><span class="k">fi</span>
</span><span id="__span-10-54"><a id="__codelineno-10-54" name="__codelineno-10-54"></a><span class="w">    </span><span class="c1"># Post over HTTPS with Basic Auth, provided credentials are</span>
</span><span id="__span-10-55"><a id="__codelineno-10-55" name="__codelineno-10-55"></a><span class="w">    </span><span class="c1"># found in /etc/conmon/influxdb-auth</span>
</span><span id="__span-10-56"><a id="__codelineno-10-56" name="__codelineno-10-56"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span>-n<span class="w"> </span><span class="s2">"</span><span class="nv">$TARGET_HTTPS</span><span class="s2">"</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
</span><span id="__span-10-57"><a id="__codelineno-10-57" name="__codelineno-10-57"></a><span class="w">        </span><span class="nv">influxdb_auth</span><span class="o">=</span>/etc/conmon/influxdb-auth
</span><span id="__span-10-58"><a id="__codelineno-10-58" name="__codelineno-10-58"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span>-z<span class="w"> </span><span class="nv">$influxdb_auth</span><span class="w"> </span><span class="o">]</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="o">[</span><span class="w"> </span>!<span class="w"> </span>-f<span class="w"> </span><span class="nv">$influxdb_auth</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
</span><span id="__span-10-59"><a id="__codelineno-10-59" name="__codelineno-10-59"></a><span class="w">            </span><span class="k">return</span>
</span><span id="__span-10-60"><a id="__codelineno-10-60" name="__codelineno-10-60"></a><span class="w">        </span><span class="k">fi</span>
</span><span id="__span-10-61"><a id="__codelineno-10-61" name="__codelineno-10-61"></a><span class="w">        </span><span class="nv">host_and_port</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span><span class="w"> </span><span class="nv">$TARGET_HTTPS</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>sed<span class="w"> </span><span class="s1">'s/.*\///'</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>tr<span class="w"> </span>:<span class="w"> </span><span class="s1">' '</span><span class="k">)</span>
</span><span id="__span-10-62"><a id="__codelineno-10-62" name="__codelineno-10-62"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span>nc<span class="w"> </span><span class="m">2</span>&gt;<span class="p">&amp;</span><span class="m">1</span><span class="w"> </span>-zv<span class="w"> </span><span class="nv">$host_and_port</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>-q<span class="w"> </span>succeeded<span class="p">;</span><span class="w"> </span><span class="k">then</span>
</span><span id="__span-10-63"><a id="__codelineno-10-63" name="__codelineno-10-63"></a><span class="w">            </span>curl<span class="w"> </span>&gt;/dev/null<span class="w"> </span><span class="m">2</span>&gt;/dev/null<span class="w"> </span><span class="se">\</span>
</span><span id="__span-10-64"><a id="__codelineno-10-64" name="__codelineno-10-64"></a><span class="w">                </span>-u<span class="w"> </span><span class="k">$(</span>cat<span class="w"> </span><span class="nv">$influxdb_auth</span><span class="k">)</span><span class="w"> </span><span class="se">\</span>
</span><span id="__span-10-65"><a id="__codelineno-10-65" name="__codelineno-10-65"></a><span class="w">                </span>-i<span class="w"> </span>-XPOST<span class="w"> </span><span class="s2">"</span><span class="si">${</span><span class="nv">TARGET_HTTPS</span><span class="si">}</span><span class="s2">/write?db=</span><span class="si">${</span><span class="nv">DBNAME</span><span class="si">}</span><span class="s2">"</span><span class="w"> </span><span class="se">\</span>
</span><span id="__span-10-66"><a id="__codelineno-10-66" name="__codelineno-10-66"></a><span class="w">                </span>--data-binary<span class="w"> </span>@<span class="s2">"</span><span class="si">${</span><span class="nv">DATA</span><span class="si">}</span><span class="s2">"</span>
</span><span id="__span-10-67"><a id="__codelineno-10-67" name="__codelineno-10-67"></a><span class="w">        </span><span class="k">fi</span>
</span><span id="__span-10-68"><a id="__codelineno-10-68" name="__codelineno-10-68"></a><span class="w">    </span><span class="k">fi</span>
</span><span id="__span-10-69"><a id="__codelineno-10-69" name="__codelineno-10-69"></a><span class="o">}</span>
</span><span id="__span-10-70"><a id="__codelineno-10-70" name="__codelineno-10-70"></a>
</span><span id="__span-10-71"><a id="__codelineno-10-71" name="__codelineno-10-71"></a><span class="c1"># myStrom WiFi switch.</span>
</span><span id="__span-10-72"><a id="__codelineno-10-72" name="__codelineno-10-72"></a><span class="c1"># API: https://api.mystrom.ch/</span>
</span><span id="__span-10-73"><a id="__codelineno-10-73" name="__codelineno-10-73"></a><span class="c1"># Depends on: curl.</span>
</span><span id="__span-10-74"><a id="__codelineno-10-74" name="__codelineno-10-74"></a><span class="k">while</span><span class="w"> </span>true<span class="p">;</span><span class="w"> </span><span class="k">do</span>
</span><span id="__span-10-75"><a id="__codelineno-10-75" name="__codelineno-10-75"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span>name<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="s2">"</span><span class="si">${</span><span class="p">!switches[@]</span><span class="si">}</span><span class="s2">"</span><span class="p">;</span><span class="w"> </span><span class="k">do</span>
</span><span id="__span-10-76"><a id="__codelineno-10-76" name="__codelineno-10-76"></a><span class="w">        </span><span class="nv">ts</span><span class="o">=</span><span class="k">$(</span>timestamp_ns<span class="k">)</span>
</span><span id="__span-10-77"><a id="__codelineno-10-77" name="__codelineno-10-77"></a><span class="w">        </span><span class="nv">switch_ip</span><span class="o">=</span><span class="s2">"</span><span class="si">${</span><span class="nv">switches</span><span class="p">[</span><span class="nv">$name</span><span class="p">]</span><span class="si">}</span><span class="s2">"</span>
</span><span id="__span-10-78"><a id="__codelineno-10-78" name="__codelineno-10-78"></a><span class="w">        </span><span class="nv">json</span><span class="o">=</span><span class="k">$(</span>curl<span class="w"> </span><span class="m">2</span>&gt;/dev/null<span class="w"> </span>http://<span class="si">${</span><span class="nv">switch_ip</span><span class="si">}</span>/report<span class="k">)</span>
</span><span id="__span-10-79"><a id="__codelineno-10-79" name="__codelineno-10-79"></a><span class="w">        </span><span class="k">for</span><span class="w"> </span>metric<span class="w"> </span><span class="k">in</span><span class="w"> </span>Ws<span class="w"> </span>power<span class="w"> </span>temperature<span class="p">;</span><span class="w"> </span><span class="k">do</span>
</span><span id="__span-10-80"><a id="__codelineno-10-80" name="__codelineno-10-80"></a><span class="w">            </span><span class="nv">value</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span><span class="w"> </span><span class="si">${</span><span class="nv">json</span><span class="si">}</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>-o<span class="w"> </span><span class="s2">".</span><span class="si">${</span><span class="nv">metric</span><span class="si">}</span><span class="s2">.:[^,}]*"</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>cut<span class="w"> </span>-f2<span class="w"> </span>-d:<span class="k">)</span>
</span><span id="__span-10-81"><a id="__codelineno-10-81" name="__codelineno-10-81"></a><span class="w">            </span>store_line<span class="w"> </span><span class="s2">"mystrom,switch=</span><span class="si">${</span><span class="nv">name</span><span class="si">}</span><span class="s2">,metric=</span><span class="si">${</span><span class="nv">metric</span><span class="si">}</span><span class="s2"> value=</span><span class="si">${</span><span class="nv">value</span><span class="si">}</span><span class="s2"> </span><span class="si">${</span><span class="nv">ts</span><span class="si">}</span><span class="s2">"</span>
</span><span id="__span-10-82"><a id="__codelineno-10-82" name="__codelineno-10-82"></a><span class="w">        </span><span class="k">done</span>
</span><span id="__span-10-83"><a id="__codelineno-10-83" name="__codelineno-10-83"></a><span class="w">    </span><span class="k">done</span>
</span><span id="__span-10-84"><a id="__codelineno-10-84" name="__codelineno-10-84"></a><span class="w">    </span>post_lines_to_influxdb
</span><span id="__span-10-85"><a id="__codelineno-10-85" name="__codelineno-10-85"></a><span class="k">done</span>
</span></code></pre></div></td></tr></table></div>
<h3 id="conmon-tapopy"><code>conmon-tapo.py</code></h3>
<p><a href="../blog/2024/12/28/continuous-monitoring-for-tp-link-tapo-devices/">Continuous Monitoring for TP-Link Tapo devices</a>
explains this script and its dependencies in more details.</p>
<div class="language-py highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-11-1">  1</a></span>
<span class="normal"><a href="#__codelineno-11-2">  2</a></span>
<span class="normal"><a href="#__codelineno-11-3">  3</a></span>
<span class="normal"><a href="#__codelineno-11-4">  4</a></span>
<span class="normal"><a href="#__codelineno-11-5">  5</a></span>
<span class="normal"><a href="#__codelineno-11-6">  6</a></span>
<span class="normal"><a href="#__codelineno-11-7">  7</a></span>
<span class="normal"><a href="#__codelineno-11-8">  8</a></span>
<span class="normal"><a href="#__codelineno-11-9">  9</a></span>
<span class="normal"><a href="#__codelineno-11-10"> 10</a></span>
<span class="normal"><a href="#__codelineno-11-11"> 11</a></span>
<span class="normal"><a href="#__codelineno-11-12"> 12</a></span>
<span class="normal"><a href="#__codelineno-11-13"> 13</a></span>
<span class="normal"><a href="#__codelineno-11-14"> 14</a></span>
<span class="normal"><a href="#__codelineno-11-15"> 15</a></span>
<span class="normal"><a href="#__codelineno-11-16"> 16</a></span>
<span class="normal"><a href="#__codelineno-11-17"> 17</a></span>
<span class="normal"><a href="#__codelineno-11-18"> 18</a></span>
<span class="normal"><a href="#__codelineno-11-19"> 19</a></span>
<span class="normal"><a href="#__codelineno-11-20"> 20</a></span>
<span class="normal"><a href="#__codelineno-11-21"> 21</a></span>
<span class="normal"><a href="#__codelineno-11-22"> 22</a></span>
<span class="normal"><a href="#__codelineno-11-23"> 23</a></span>
<span class="normal"><a href="#__codelineno-11-24"> 24</a></span>
<span class="normal"><a href="#__codelineno-11-25"> 25</a></span>
<span class="normal"><a href="#__codelineno-11-26"> 26</a></span>
<span class="normal"><a href="#__codelineno-11-27"> 27</a></span>
<span class="normal"><a href="#__codelineno-11-28"> 28</a></span>
<span class="normal"><a href="#__codelineno-11-29"> 29</a></span>
<span class="normal"><a href="#__codelineno-11-30"> 30</a></span>
<span class="normal"><a href="#__codelineno-11-31"> 31</a></span>
<span class="normal"><a href="#__codelineno-11-32"> 32</a></span>
<span class="normal"><a href="#__codelineno-11-33"> 33</a></span>
<span class="normal"><a href="#__codelineno-11-34"> 34</a></span>
<span class="normal"><a href="#__codelineno-11-35"> 35</a></span>
<span class="normal"><a href="#__codelineno-11-36"> 36</a></span>
<span class="normal"><a href="#__codelineno-11-37"> 37</a></span>
<span class="normal"><a href="#__codelineno-11-38"> 38</a></span>
<span class="normal"><a href="#__codelineno-11-39"> 39</a></span>
<span class="normal"><a href="#__codelineno-11-40"> 40</a></span>
<span class="normal"><a href="#__codelineno-11-41"> 41</a></span>
<span class="normal"><a href="#__codelineno-11-42"> 42</a></span>
<span class="normal"><a href="#__codelineno-11-43"> 43</a></span>
<span class="normal"><a href="#__codelineno-11-44"> 44</a></span>
<span class="normal"><a href="#__codelineno-11-45"> 45</a></span>
<span class="normal"><a href="#__codelineno-11-46"> 46</a></span>
<span class="normal"><a href="#__codelineno-11-47"> 47</a></span>
<span class="normal"><a href="#__codelineno-11-48"> 48</a></span>
<span class="normal"><a href="#__codelineno-11-49"> 49</a></span>
<span class="normal"><a href="#__codelineno-11-50"> 50</a></span>
<span class="normal"><a href="#__codelineno-11-51"> 51</a></span>
<span class="normal"><a href="#__codelineno-11-52"> 52</a></span>
<span class="normal"><a href="#__codelineno-11-53"> 53</a></span>
<span class="normal"><a href="#__codelineno-11-54"> 54</a></span>
<span class="normal"><a href="#__codelineno-11-55"> 55</a></span>
<span class="normal"><a href="#__codelineno-11-56"> 56</a></span>
<span class="normal"><a href="#__codelineno-11-57"> 57</a></span>
<span class="normal"><a href="#__codelineno-11-58"> 58</a></span>
<span class="normal"><a href="#__codelineno-11-59"> 59</a></span>
<span class="normal"><a href="#__codelineno-11-60"> 60</a></span>
<span class="normal"><a href="#__codelineno-11-61"> 61</a></span>
<span class="normal"><a href="#__codelineno-11-62"> 62</a></span>
<span class="normal"><a href="#__codelineno-11-63"> 63</a></span>
<span class="normal"><a href="#__codelineno-11-64"> 64</a></span>
<span class="normal"><a href="#__codelineno-11-65"> 65</a></span>
<span class="normal"><a href="#__codelineno-11-66"> 66</a></span>
<span class="normal"><a href="#__codelineno-11-67"> 67</a></span>
<span class="normal"><a href="#__codelineno-11-68"> 68</a></span>
<span class="normal"><a href="#__codelineno-11-69"> 69</a></span>
<span class="normal"><a href="#__codelineno-11-70"> 70</a></span>
<span class="normal"><a href="#__codelineno-11-71"> 71</a></span>
<span class="normal"><a href="#__codelineno-11-72"> 72</a></span>
<span class="normal"><a href="#__codelineno-11-73"> 73</a></span>
<span class="normal"><a href="#__codelineno-11-74"> 74</a></span>
<span class="normal"><a href="#__codelineno-11-75"> 75</a></span>
<span class="normal"><a href="#__codelineno-11-76"> 76</a></span>
<span class="normal"><a href="#__codelineno-11-77"> 77</a></span>
<span class="normal"><a href="#__codelineno-11-78"> 78</a></span>
<span class="normal"><a href="#__codelineno-11-79"> 79</a></span>
<span class="normal"><a href="#__codelineno-11-80"> 80</a></span>
<span class="normal"><a href="#__codelineno-11-81"> 81</a></span>
<span class="normal"><a href="#__codelineno-11-82"> 82</a></span>
<span class="normal"><a href="#__codelineno-11-83"> 83</a></span>
<span class="normal"><a href="#__codelineno-11-84"> 84</a></span>
<span class="normal"><a href="#__codelineno-11-85"> 85</a></span>
<span class="normal"><a href="#__codelineno-11-86"> 86</a></span>
<span class="normal"><a href="#__codelineno-11-87"> 87</a></span>
<span class="normal"><a href="#__codelineno-11-88"> 88</a></span>
<span class="normal"><a href="#__codelineno-11-89"> 89</a></span>
<span class="normal"><a href="#__codelineno-11-90"> 90</a></span>
<span class="normal"><a href="#__codelineno-11-91"> 91</a></span>
<span class="normal"><a href="#__codelineno-11-92"> 92</a></span>
<span class="normal"><a href="#__codelineno-11-93"> 93</a></span>
<span class="normal"><a href="#__codelineno-11-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-11-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-11-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-11-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-11-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-11-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-11-100">100</a></span>
<span class="normal"><a href="#__codelineno-11-101">101</a></span>
<span class="normal"><a href="#__codelineno-11-102">102</a></span>
<span class="normal"><a href="#__codelineno-11-103">103</a></span>
<span class="normal"><a href="#__codelineno-11-104">104</a></span>
<span class="normal"><a href="#__codelineno-11-105">105</a></span>
<span class="normal"><a href="#__codelineno-11-106">106</a></span>
<span class="normal"><a href="#__codelineno-11-107">107</a></span>
<span class="normal"><a href="#__codelineno-11-108">108</a></span>
<span class="normal"><a href="#__codelineno-11-109">109</a></span>
<span class="normal"><a href="#__codelineno-11-110">110</a></span>
<span class="normal"><a href="#__codelineno-11-111">111</a></span>
<span class="normal"><a href="#__codelineno-11-112">112</a></span>
<span class="normal"><a href="#__codelineno-11-113">113</a></span>
<span class="normal"><a href="#__codelineno-11-114">114</a></span>
<span class="normal"><a href="#__codelineno-11-115">115</a></span>
<span class="normal"><a href="#__codelineno-11-116">116</a></span>
<span class="normal"><a href="#__codelineno-11-117">117</a></span>
<span class="normal"><a href="#__codelineno-11-118">118</a></span>
<span class="normal"><a href="#__codelineno-11-119">119</a></span>
<span class="normal"><a href="#__codelineno-11-120">120</a></span>
<span class="normal"><a href="#__codelineno-11-121">121</a></span>
<span class="normal"><a href="#__codelineno-11-122">122</a></span>
<span class="normal"><a href="#__codelineno-11-123">123</a></span>
<span class="normal"><a href="#__codelineno-11-124">124</a></span>
<span class="normal"><a href="#__codelineno-11-125">125</a></span>
<span class="normal"><a href="#__codelineno-11-126">126</a></span>
<span class="normal"><a href="#__codelineno-11-127">127</a></span>
<span class="normal"><a href="#__codelineno-11-128">128</a></span>
<span class="normal"><a href="#__codelineno-11-129">129</a></span>
<span class="normal"><a href="#__codelineno-11-130">130</a></span>
<span class="normal"><a href="#__codelineno-11-131">131</a></span>
<span class="normal"><a href="#__codelineno-11-132">132</a></span>
<span class="normal"><a href="#__codelineno-11-133">133</a></span>
<span class="normal"><a href="#__codelineno-11-134">134</a></span>
<span class="normal"><a href="#__codelineno-11-135">135</a></span>
<span class="normal"><a href="#__codelineno-11-136">136</a></span>
<span class="normal"><a href="#__codelineno-11-137">137</a></span>
<span class="normal"><a href="#__codelineno-11-138">138</a></span>
<span class="normal"><a href="#__codelineno-11-139">139</a></span>
<span class="normal"><a href="#__codelineno-11-140">140</a></span>
<span class="normal"><a href="#__codelineno-11-141">141</a></span>
<span class="normal"><a href="#__codelineno-11-142">142</a></span>
<span class="normal"><a href="#__codelineno-11-143">143</a></span>
<span class="normal"><a href="#__codelineno-11-144">144</a></span>
<span class="normal"><a href="#__codelineno-11-145">145</a></span>
<span class="normal"><a href="#__codelineno-11-146">146</a></span>
<span class="normal"><a href="#__codelineno-11-147">147</a></span>
<span class="normal"><a href="#__codelineno-11-148">148</a></span>
<span class="normal"><a href="#__codelineno-11-149">149</a></span>
<span class="normal"><a href="#__codelineno-11-150">150</a></span>
<span class="normal"><a href="#__codelineno-11-151">151</a></span>
<span class="normal"><a href="#__codelineno-11-152">152</a></span>
<span class="normal"><a href="#__codelineno-11-153">153</a></span>
<span class="normal"><a href="#__codelineno-11-154">154</a></span>
<span class="normal"><a href="#__codelineno-11-155">155</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-11-1"><a id="__codelineno-11-1" name="__codelineno-11-1"></a><span class="ch">#!/usr/bin/env python3</span>
</span><span id="__span-11-2"><a id="__codelineno-11-2" name="__codelineno-11-2"></a>
</span><span id="__span-11-3"><a id="__codelineno-11-3" name="__codelineno-11-3"></a><span class="sd">"""Script to poll TAPO devices for monitoring data and post it to InfluxDB.</span>
</span><span id="__span-11-4"><a id="__codelineno-11-4" name="__codelineno-11-4"></a>
</span><span id="__span-11-5"><a id="__codelineno-11-5" name="__codelineno-11-5"></a><span class="sd">Run conmon-tapo --help to see all available options.</span>
</span><span id="__span-11-6"><a id="__codelineno-11-6" name="__codelineno-11-6"></a>
</span><span id="__span-11-7"><a id="__codelineno-11-7" name="__codelineno-11-7"></a><span class="sd">Usage:</span>
</span><span id="__span-11-8"><a id="__codelineno-11-8" name="__codelineno-11-8"></a><span class="sd">  conmon-tapo [options]</span>
</span><span id="__span-11-9"><a id="__codelineno-11-9" name="__codelineno-11-9"></a>
</span><span id="__span-11-10"><a id="__codelineno-11-10" name="__codelineno-11-10"></a><span class="sd">Requires:</span>
</span><span id="__span-11-11"><a id="__codelineno-11-11" name="__codelineno-11-11"></a><span class="sd">  absl-py</span>
</span><span id="__span-11-12"><a id="__codelineno-11-12" name="__codelineno-11-12"></a><span class="sd">  https://github.com/abseil/abseil-py</span>
</span><span id="__span-11-13"><a id="__codelineno-11-13" name="__codelineno-11-13"></a>
</span><span id="__span-11-14"><a id="__codelineno-11-14" name="__codelineno-11-14"></a><span class="sd">  tapo</span>
</span><span id="__span-11-15"><a id="__codelineno-11-15" name="__codelineno-11-15"></a><span class="sd">  https://github.com/mihai-dinculescu/tapo/</span>
</span><span id="__span-11-16"><a id="__codelineno-11-16" name="__codelineno-11-16"></a><span class="sd">"""</span>
</span><span id="__span-11-17"><a id="__codelineno-11-17" name="__codelineno-11-17"></a>
</span><span id="__span-11-18"><a id="__codelineno-11-18" name="__codelineno-11-18"></a><span class="kn">import</span> <span class="nn">asyncio</span>
</span><span id="__span-11-19"><a id="__codelineno-11-19" name="__codelineno-11-19"></a><span class="kn">import</span> <span class="nn">json</span>
</span><span id="__span-11-20"><a id="__codelineno-11-20" name="__codelineno-11-20"></a><span class="kn">import</span> <span class="nn">os</span>
</span><span id="__span-11-21"><a id="__codelineno-11-21" name="__codelineno-11-21"></a><span class="kn">import</span> <span class="nn">socket</span>
</span><span id="__span-11-22"><a id="__codelineno-11-22" name="__codelineno-11-22"></a><span class="kn">import</span> <span class="nn">sys</span>
</span><span id="__span-11-23"><a id="__codelineno-11-23" name="__codelineno-11-23"></a><span class="kn">import</span> <span class="nn">time</span>
</span><span id="__span-11-24"><a id="__codelineno-11-24" name="__codelineno-11-24"></a><span class="kn">import</span> <span class="nn">yaml</span>
</span><span id="__span-11-25"><a id="__codelineno-11-25" name="__codelineno-11-25"></a>
</span><span id="__span-11-26"><a id="__codelineno-11-26" name="__codelineno-11-26"></a><span class="kn">from</span> <span class="nn">absl</span> <span class="kn">import</span> <span class="n">app</span><span class="p">,</span> <span class="n">flags</span>
</span><span id="__span-11-27"><a id="__codelineno-11-27" name="__codelineno-11-27"></a><span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
</span><span id="__span-11-28"><a id="__codelineno-11-28" name="__codelineno-11-28"></a><span class="kn">from</span> <span class="nn">influxdb</span> <span class="kn">import</span> <span class="n">InfluxDBClient</span>
</span><span id="__span-11-29"><a id="__codelineno-11-29" name="__codelineno-11-29"></a>
</span><span id="__span-11-30"><a id="__codelineno-11-30" name="__codelineno-11-30"></a><span class="kn">from</span> <span class="nn">tapo</span> <span class="kn">import</span> <span class="n">ApiClient</span>
</span><span id="__span-11-31"><a id="__codelineno-11-31" name="__codelineno-11-31"></a><span class="kn">from</span> <span class="nn">tapo.requests</span> <span class="kn">import</span> <span class="n">EnergyDataInterval</span>
</span><span id="__span-11-32"><a id="__codelineno-11-32" name="__codelineno-11-32"></a><span class="kn">from</span> <span class="nn">tapo.responses</span> <span class="kn">import</span> <span class="n">T31XResult</span>
</span><span id="__span-11-33"><a id="__codelineno-11-33" name="__codelineno-11-33"></a>
</span><span id="__span-11-34"><a id="__codelineno-11-34" name="__codelineno-11-34"></a><span class="n">FLAGS</span> <span class="o">=</span> <span class="n">flags</span><span class="o">.</span><span class="n">FLAGS</span>
</span><span id="__span-11-35"><a id="__codelineno-11-35" name="__codelineno-11-35"></a>
</span><span id="__span-11-36"><a id="__codelineno-11-36" name="__codelineno-11-36"></a><span class="n">flags</span><span class="o">.</span><span class="n">DEFINE_string</span><span class="p">(</span>
</span><span id="__span-11-37"><a id="__codelineno-11-37" name="__codelineno-11-37"></a>    <span class="s2">"config"</span><span class="p">,</span>
</span><span id="__span-11-38"><a id="__codelineno-11-38" name="__codelineno-11-38"></a>    <span class="s2">"/etc/conmon/tapo.yaml"</span><span class="p">,</span>
</span><span id="__span-11-39"><a id="__codelineno-11-39" name="__codelineno-11-39"></a>    <span class="s2">"Configuration file with settings for InfluxDB and Tapo devices."</span><span class="p">,</span>
</span><span id="__span-11-40"><a id="__codelineno-11-40" name="__codelineno-11-40"></a>    <span class="n">short_name</span><span class="o">=</span><span class="s2">"c"</span>
</span><span id="__span-11-41"><a id="__codelineno-11-41" name="__codelineno-11-41"></a><span class="p">)</span>
</span><span id="__span-11-42"><a id="__codelineno-11-42" name="__codelineno-11-42"></a>
</span><span id="__span-11-43"><a id="__codelineno-11-43" name="__codelineno-11-43"></a>
</span><span id="__span-11-44"><a id="__codelineno-11-44" name="__codelineno-11-44"></a><span class="k">def</span> <span class="nf">load_config</span><span class="p">(</span><span class="n">filepath</span><span class="p">):</span>
</span><span id="__span-11-45"><a id="__codelineno-11-45" name="__codelineno-11-45"></a>    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span><span id="__span-11-46"><a id="__codelineno-11-46" name="__codelineno-11-46"></a>        <span class="n">config</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">Loader</span><span class="o">=</span><span class="n">yaml</span><span class="o">.</span><span class="n">FullLoader</span><span class="p">)</span>
</span><span id="__span-11-47"><a id="__codelineno-11-47" name="__codelineno-11-47"></a>    <span class="c1"># Override values from environment variables.</span>
</span><span id="__span-11-48"><a id="__codelineno-11-48" name="__codelineno-11-48"></a>    <span class="k">for</span> <span class="n">section</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">"influxdb"</span><span class="p">,</span> <span class="s2">"tapo_auth"</span><span class="p">):</span>
</span><span id="__span-11-49"><a id="__codelineno-11-49" name="__codelineno-11-49"></a>        <span class="k">for</span> <span class="n">variable</span> <span class="ow">in</span> <span class="n">config</span><span class="p">[</span><span class="n">section</span><span class="p">]:</span>
</span><span id="__span-11-50"><a id="__codelineno-11-50" name="__codelineno-11-50"></a>            <span class="k">if</span> <span class="n">variable</span><span class="p">[</span><span class="o">-</span><span class="mi">8</span><span class="p">:]</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">"username"</span><span class="p">,</span> <span class="s2">"password"</span><span class="p">):</span>
</span><span id="__span-11-51"><a id="__codelineno-11-51" name="__codelineno-11-51"></a>                <span class="n">env_value</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="n">section</span><span class="p">][</span><span class="n">variable</span><span class="p">])</span>
</span><span id="__span-11-52"><a id="__codelineno-11-52" name="__codelineno-11-52"></a>                <span class="k">if</span> <span class="n">env_value</span><span class="p">:</span>
</span><span id="__span-11-53"><a id="__codelineno-11-53" name="__codelineno-11-53"></a>                    <span class="n">config</span><span class="p">[</span><span class="n">section</span><span class="p">][</span><span class="n">variable</span><span class="p">]</span> <span class="o">=</span> <span class="n">env_value</span>
</span><span id="__span-11-54"><a id="__codelineno-11-54" name="__codelineno-11-54"></a>    <span class="k">return</span> <span class="n">config</span>
</span><span id="__span-11-55"><a id="__codelineno-11-55" name="__codelineno-11-55"></a>
</span><span id="__span-11-56"><a id="__codelineno-11-56" name="__codelineno-11-56"></a>
</span><span id="__span-11-57"><a id="__codelineno-11-57" name="__codelineno-11-57"></a><span class="k">async</span> <span class="k">def</span> <span class="nf">fetch_reports</span><span class="p">(</span><span class="n">config</span><span class="p">):</span>
</span><span id="__span-11-58"><a id="__codelineno-11-58" name="__codelineno-11-58"></a>    <span class="n">client</span> <span class="o">=</span> <span class="n">ApiClient</span><span class="p">(</span><span class="o">**</span><span class="n">config</span><span class="p">[</span><span class="s2">"tapo_auth"</span><span class="p">])</span>
</span><span id="__span-11-59"><a id="__codelineno-11-59" name="__codelineno-11-59"></a>    <span class="n">reports</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="__span-11-60"><a id="__codelineno-11-60" name="__codelineno-11-60"></a>    <span class="k">for</span> <span class="n">device</span> <span class="ow">in</span> <span class="n">config</span><span class="p">[</span><span class="s2">"devices"</span><span class="p">]:</span>
</span><span id="__span-11-61"><a id="__codelineno-11-61" name="__codelineno-11-61"></a>        <span class="n">model</span> <span class="o">=</span> <span class="n">device</span><span class="p">[</span><span class="s2">"model"</span><span class="p">]</span>
</span><span id="__span-11-62"><a id="__codelineno-11-62" name="__codelineno-11-62"></a>        <span class="n">report</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">)</span>
</span><span id="__span-11-63"><a id="__codelineno-11-63" name="__codelineno-11-63"></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="__span-11-64"><a id="__codelineno-11-64" name="__codelineno-11-64"></a>            <span class="k">if</span> <span class="n">model</span> <span class="o">==</span> <span class="s2">"H100"</span><span class="p">:</span>
</span><span id="__span-11-65"><a id="__codelineno-11-65" name="__codelineno-11-65"></a>                <span class="n">device_conn</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">h100</span><span class="p">(</span><span class="n">device</span><span class="p">[</span><span class="s2">"ip"</span><span class="p">])</span>
</span><span id="__span-11-66"><a id="__codelineno-11-66" name="__codelineno-11-66"></a>                <span class="n">device_info</span> <span class="o">=</span> <span class="k">await</span> <span class="n">device_conn</span><span class="o">.</span><span class="n">get_device_info</span><span class="p">()</span>
</span><span id="__span-11-67"><a id="__codelineno-11-67" name="__codelineno-11-67"></a>                <span class="n">report</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
</span><span id="__span-11-68"><a id="__codelineno-11-68" name="__codelineno-11-68"></a>                    <span class="n">model</span><span class="o">=</span><span class="n">device_info</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"model"</span><span class="p">),</span>
</span><span id="__span-11-69"><a id="__codelineno-11-69" name="__codelineno-11-69"></a>                    <span class="n">nickname</span><span class="o">=</span><span class="n">device_info</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"nickname"</span><span class="p">)</span>
</span><span id="__span-11-70"><a id="__codelineno-11-70" name="__codelineno-11-70"></a>                <span class="p">)</span>
</span><span id="__span-11-71"><a id="__codelineno-11-71" name="__codelineno-11-71"></a>                <span class="n">children</span><span class="o">=</span><span class="p">[]</span>
</span><span id="__span-11-72"><a id="__codelineno-11-72" name="__codelineno-11-72"></a>                <span class="n">child_device_list</span> <span class="o">=</span> <span class="k">await</span> <span class="n">device_conn</span><span class="o">.</span><span class="n">get_child_device_list</span><span class="p">()</span>
</span><span id="__span-11-73"><a id="__codelineno-11-73" name="__codelineno-11-73"></a>                <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">child_device_list</span><span class="p">:</span>
</span><span id="__span-11-74"><a id="__codelineno-11-74" name="__codelineno-11-74"></a>                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">child</span><span class="p">,</span> <span class="n">T31XResult</span><span class="p">):</span>
</span><span id="__span-11-75"><a id="__codelineno-11-75" name="__codelineno-11-75"></a>                        <span class="n">t315</span> <span class="o">=</span> <span class="k">await</span> <span class="n">device_conn</span><span class="o">.</span><span class="n">t315</span><span class="p">(</span><span class="n">device_id</span><span class="o">=</span><span class="n">child</span><span class="o">.</span><span class="n">device_id</span><span class="p">)</span>
</span><span id="__span-11-76"><a id="__codelineno-11-76" name="__codelineno-11-76"></a>                        <span class="n">children</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span>
</span><span id="__span-11-77"><a id="__codelineno-11-77" name="__codelineno-11-77"></a>                            <span class="n">model</span><span class="o">=</span><span class="s2">"T315"</span><span class="p">,</span>
</span><span id="__span-11-78"><a id="__codelineno-11-78" name="__codelineno-11-78"></a>                            <span class="n">nickname</span><span class="o">=</span><span class="n">child</span><span class="o">.</span><span class="n">nickname</span><span class="p">,</span>
</span><span id="__span-11-79"><a id="__codelineno-11-79" name="__codelineno-11-79"></a>                            <span class="n">humidity</span><span class="o">=</span><span class="n">child</span><span class="o">.</span><span class="n">current_humidity</span><span class="p">,</span>
</span><span id="__span-11-80"><a id="__codelineno-11-80" name="__codelineno-11-80"></a>                            <span class="n">temperature</span><span class="o">=</span><span class="n">child</span><span class="o">.</span><span class="n">current_temperature</span>
</span><span id="__span-11-81"><a id="__codelineno-11-81" name="__codelineno-11-81"></a>                        <span class="p">))</span>
</span><span id="__span-11-82"><a id="__codelineno-11-82" name="__codelineno-11-82"></a>                <span class="n">report</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">children</span><span class="o">=</span><span class="n">children</span><span class="p">))</span>
</span><span id="__span-11-83"><a id="__codelineno-11-83" name="__codelineno-11-83"></a>            <span class="k">elif</span> <span class="n">model</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">"P110"</span><span class="p">,</span> <span class="s2">"P115"</span><span class="p">):</span>
</span><span id="__span-11-84"><a id="__codelineno-11-84" name="__codelineno-11-84"></a>                <span class="n">device_conn</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">p110</span><span class="p">(</span><span class="n">device</span><span class="p">[</span><span class="s2">"ip"</span><span class="p">])</span>
</span><span id="__span-11-85"><a id="__codelineno-11-85" name="__codelineno-11-85"></a>                <span class="n">device_info</span> <span class="o">=</span> <span class="k">await</span> <span class="n">device_conn</span><span class="o">.</span><span class="n">get_device_info</span><span class="p">()</span>
</span><span id="__span-11-86"><a id="__codelineno-11-86" name="__codelineno-11-86"></a>                <span class="n">energy_usage</span> <span class="o">=</span> <span class="k">await</span> <span class="n">device_conn</span><span class="o">.</span><span class="n">get_energy_usage</span><span class="p">()</span>
</span><span id="__span-11-87"><a id="__codelineno-11-87" name="__codelineno-11-87"></a>                <span class="n">report</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
</span><span id="__span-11-88"><a id="__codelineno-11-88" name="__codelineno-11-88"></a>                    <span class="n">model</span><span class="o">=</span><span class="n">device_info</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"model"</span><span class="p">),</span>
</span><span id="__span-11-89"><a id="__codelineno-11-89" name="__codelineno-11-89"></a>                    <span class="n">nickname</span><span class="o">=</span><span class="n">device_info</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"nickname"</span><span class="p">),</span>
</span><span id="__span-11-90"><a id="__codelineno-11-90" name="__codelineno-11-90"></a>                    <span class="n">current_power</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">energy_usage</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"current_power"</span><span class="p">)</span><span class="o">/</span><span class="mi">1000</span><span class="p">)</span>
</span><span id="__span-11-91"><a id="__codelineno-11-91" name="__codelineno-11-91"></a>                <span class="p">)</span>
</span><span id="__span-11-92"><a id="__codelineno-11-92" name="__codelineno-11-92"></a>        <span class="k">except</span><span class="p">:</span>
</span><span id="__span-11-93"><a id="__codelineno-11-93" name="__codelineno-11-93"></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">"Could not get data from </span><span class="si">%s</span><span class="s2"> on </span><span class="si">%s</span><span class="s2"> "</span> <span class="o">%</span> <span class="p">(</span>
</span><span id="__span-11-94"><a id="__codelineno-11-94" name="__codelineno-11-94"></a>                <span class="n">device</span><span class="p">[</span><span class="s2">"model"</span><span class="p">],</span> <span class="n">device</span><span class="p">[</span><span class="s2">"ip"</span><span class="p">]))</span>
</span><span id="__span-11-95"><a id="__codelineno-11-95" name="__codelineno-11-95"></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="__span-11-96"><a id="__codelineno-11-96" name="__codelineno-11-96"></a>            <span class="n">reports</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">report</span><span class="p">)</span>
</span><span id="__span-11-97"><a id="__codelineno-11-97" name="__codelineno-11-97"></a>    <span class="k">return</span> <span class="n">reports</span>
</span><span id="__span-11-98"><a id="__codelineno-11-98" name="__codelineno-11-98"></a>
</span><span id="__span-11-99"><a id="__codelineno-11-99" name="__codelineno-11-99"></a>
</span><span id="__span-11-100"><a id="__codelineno-11-100" name="__codelineno-11-100"></a><span class="k">def</span> <span class="nf">always_on_reports</span><span class="p">(</span><span class="n">config</span><span class="p">):</span>
</span><span id="__span-11-101"><a id="__codelineno-11-101" name="__codelineno-11-101"></a>    <span class="n">reports</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="__span-11-102"><a id="__codelineno-11-102" name="__codelineno-11-102"></a>    <span class="k">if</span> <span class="s2">"always_on"</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">config</span><span class="p">:</span>
</span><span id="__span-11-103"><a id="__codelineno-11-103" name="__codelineno-11-103"></a>      <span class="k">return</span> <span class="n">reports</span>
</span><span id="__span-11-104"><a id="__codelineno-11-104" name="__codelineno-11-104"></a>    <span class="k">for</span> <span class="n">device</span> <span class="ow">in</span> <span class="n">config</span><span class="p">[</span><span class="s2">"always_on"</span><span class="p">]:</span>
</span><span id="__span-11-105"><a id="__codelineno-11-105" name="__codelineno-11-105"></a>        <span class="n">reports</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span>
</span><span id="__span-11-106"><a id="__codelineno-11-106" name="__codelineno-11-106"></a>            <span class="n">model</span><span class="o">=</span><span class="s2">"P115"</span><span class="p">,</span>
</span><span id="__span-11-107"><a id="__codelineno-11-107" name="__codelineno-11-107"></a>            <span class="n">nickname</span><span class="o">=</span><span class="n">device</span><span class="p">[</span><span class="s2">"name"</span><span class="p">],</span>
</span><span id="__span-11-108"><a id="__codelineno-11-108" name="__codelineno-11-108"></a>            <span class="n">current_power</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">device</span><span class="p">[</span><span class="s2">"power"</span><span class="p">])</span>
</span><span id="__span-11-109"><a id="__codelineno-11-109" name="__codelineno-11-109"></a>        <span class="p">))</span>
</span><span id="__span-11-110"><a id="__codelineno-11-110" name="__codelineno-11-110"></a>    <span class="k">return</span> <span class="n">reports</span>
</span><span id="__span-11-111"><a id="__codelineno-11-111" name="__codelineno-11-111"></a>
</span><span id="__span-11-112"><a id="__codelineno-11-112" name="__codelineno-11-112"></a>
</span><span id="__span-11-113"><a id="__codelineno-11-113" name="__codelineno-11-113"></a><span class="k">def</span> <span class="nf">json_body_point</span><span class="p">(</span><span class="n">measurement</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">ts</span><span class="p">,</span> <span class="n">tags</span><span class="p">):</span>
</span><span id="__span-11-114"><a id="__codelineno-11-114" name="__codelineno-11-114"></a>    <span class="n">tags</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="n">socket</span><span class="o">.</span><span class="n">gethostname</span><span class="p">()))</span>
</span><span id="__span-11-115"><a id="__codelineno-11-115" name="__codelineno-11-115"></a>    <span class="k">return</span> <span class="p">{</span>
</span><span id="__span-11-116"><a id="__codelineno-11-116" name="__codelineno-11-116"></a>      <span class="s2">"measurement"</span><span class="p">:</span> <span class="n">measurement</span><span class="p">,</span>
</span><span id="__span-11-117"><a id="__codelineno-11-117" name="__codelineno-11-117"></a>      <span class="s2">"tags"</span><span class="p">:</span> <span class="n">tags</span><span class="p">,</span>
</span><span id="__span-11-118"><a id="__codelineno-11-118" name="__codelineno-11-118"></a>      <span class="s2">"time"</span><span class="p">:</span> <span class="n">ts</span><span class="p">,</span>
</span><span id="__span-11-119"><a id="__codelineno-11-119" name="__codelineno-11-119"></a>      <span class="s2">"fields"</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-11-120"><a id="__codelineno-11-120" name="__codelineno-11-120"></a>        <span class="s2">"value"</span><span class="p">:</span> <span class="n">value</span>
</span><span id="__span-11-121"><a id="__codelineno-11-121" name="__codelineno-11-121"></a>      <span class="p">}</span>
</span><span id="__span-11-122"><a id="__codelineno-11-122" name="__codelineno-11-122"></a>    <span class="p">}</span>
</span><span id="__span-11-123"><a id="__codelineno-11-123" name="__codelineno-11-123"></a>
</span><span id="__span-11-124"><a id="__codelineno-11-124" name="__codelineno-11-124"></a>
</span><span id="__span-11-125"><a id="__codelineno-11-125" name="__codelineno-11-125"></a><span class="k">def</span> <span class="nf">json_body_points_from_report</span><span class="p">(</span><span class="n">report</span><span class="p">,</span> <span class="n">ts</span><span class="p">):</span>
</span><span id="__span-11-126"><a id="__codelineno-11-126" name="__codelineno-11-126"></a>    <span class="n">json_body</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="__span-11-127"><a id="__codelineno-11-127" name="__codelineno-11-127"></a>    <span class="n">tags</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">report</span><span class="p">[</span><span class="s2">"model"</span><span class="p">],</span> <span class="n">nickname</span><span class="o">=</span><span class="n">report</span><span class="p">[</span><span class="s2">"nickname"</span><span class="p">])</span>
</span><span id="__span-11-128"><a id="__codelineno-11-128" name="__codelineno-11-128"></a>    <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">report</span><span class="p">:</span>
</span><span id="__span-11-129"><a id="__codelineno-11-129" name="__codelineno-11-129"></a>        <span class="k">if</span> <span class="n">field</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">"model"</span><span class="p">,</span> <span class="s2">"nickname"</span><span class="p">):</span> <span class="k">continue</span>
</span><span id="__span-11-130"><a id="__codelineno-11-130" name="__codelineno-11-130"></a>        <span class="n">json_body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">json_body_point</span><span class="p">(</span><span class="s2">"tapo_</span><span class="si">%s</span><span class="s2">"</span> <span class="o">%</span> <span class="n">field</span><span class="p">,</span> <span class="n">report</span><span class="p">[</span><span class="n">field</span><span class="p">],</span> <span class="n">ts</span><span class="p">,</span> <span class="n">tags</span><span class="p">))</span>
</span><span id="__span-11-131"><a id="__codelineno-11-131" name="__codelineno-11-131"></a>    <span class="k">return</span> <span class="n">json_body</span>
</span><span id="__span-11-132"><a id="__codelineno-11-132" name="__codelineno-11-132"></a>
</span><span id="__span-11-133"><a id="__codelineno-11-133" name="__codelineno-11-133"></a>
</span><span id="__span-11-134"><a id="__codelineno-11-134" name="__codelineno-11-134"></a><span class="k">def</span> <span class="nf">post_reports</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">reports</span><span class="p">):</span>
</span><span id="__span-11-135"><a id="__codelineno-11-135" name="__codelineno-11-135"></a>    <span class="n">client</span> <span class="o">=</span> <span class="n">InfluxDBClient</span><span class="p">(</span><span class="o">**</span><span class="n">config</span><span class="p">[</span><span class="s2">"influxdb"</span><span class="p">])</span>
</span><span id="__span-11-136"><a id="__codelineno-11-136" name="__codelineno-11-136"></a>    <span class="n">json_body</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="__span-11-137"><a id="__codelineno-11-137" name="__codelineno-11-137"></a>    <span class="n">ts</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">1000000000</span> <span class="o">*</span> <span class="n">time</span><span class="o">.</span><span class="n">mktime</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">localtime</span><span class="p">()))</span>
</span><span id="__span-11-138"><a id="__codelineno-11-138" name="__codelineno-11-138"></a>    <span class="k">for</span> <span class="n">report</span> <span class="ow">in</span> <span class="n">reports</span><span class="p">:</span>
</span><span id="__span-11-139"><a id="__codelineno-11-139" name="__codelineno-11-139"></a>        <span class="k">if</span> <span class="s2">"children"</span> <span class="ow">in</span> <span class="n">report</span><span class="p">:</span>
</span><span id="__span-11-140"><a id="__codelineno-11-140" name="__codelineno-11-140"></a>            <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">report</span><span class="p">[</span><span class="s2">"children"</span><span class="p">]:</span>
</span><span id="__span-11-141"><a id="__codelineno-11-141" name="__codelineno-11-141"></a>                <span class="n">json_body</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">json_body_points_from_report</span><span class="p">(</span><span class="n">child</span><span class="p">,</span> <span class="n">ts</span><span class="p">))</span>
</span><span id="__span-11-142"><a id="__codelineno-11-142" name="__codelineno-11-142"></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="__span-11-143"><a id="__codelineno-11-143" name="__codelineno-11-143"></a>            <span class="n">json_body</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">json_body_points_from_report</span><span class="p">(</span><span class="n">report</span><span class="p">,</span> <span class="n">ts</span><span class="p">))</span>
</span><span id="__span-11-144"><a id="__codelineno-11-144" name="__codelineno-11-144"></a>    <span class="n">client</span><span class="o">.</span><span class="n">write_points</span><span class="p">(</span><span class="n">json_body</span><span class="p">)</span>
</span><span id="__span-11-145"><a id="__codelineno-11-145" name="__codelineno-11-145"></a>
</span><span id="__span-11-146"><a id="__codelineno-11-146" name="__codelineno-11-146"></a>
</span><span id="__span-11-147"><a id="__codelineno-11-147" name="__codelineno-11-147"></a><span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">argv</span><span class="p">):</span>
</span><span id="__span-11-148"><a id="__codelineno-11-148" name="__codelineno-11-148"></a>    <span class="n">config</span> <span class="o">=</span> <span class="n">load_config</span><span class="p">(</span><span class="n">FLAGS</span><span class="o">.</span><span class="n">config</span><span class="p">)</span>
</span><span id="__span-11-149"><a id="__codelineno-11-149" name="__codelineno-11-149"></a>    <span class="n">reports</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">fetch_reports</span><span class="p">(</span><span class="n">config</span><span class="p">))</span>
</span><span id="__span-11-150"><a id="__codelineno-11-150" name="__codelineno-11-150"></a>    <span class="n">reports</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">always_on_reports</span><span class="p">(</span><span class="n">config</span><span class="p">))</span>
</span><span id="__span-11-151"><a id="__codelineno-11-151" name="__codelineno-11-151"></a>    <span class="n">post_reports</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">reports</span><span class="p">)</span>
</span><span id="__span-11-152"><a id="__codelineno-11-152" name="__codelineno-11-152"></a>
</span><span id="__span-11-153"><a id="__codelineno-11-153" name="__codelineno-11-153"></a>
</span><span id="__span-11-154"><a id="__codelineno-11-154" name="__codelineno-11-154"></a><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">"__main__"</span><span class="p">:</span>
</span><span id="__span-11-155"><a id="__codelineno-11-155" name="__codelineno-11-155"></a>    <span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">main</span><span class="p">)</span>
</span></code></pre></div></td></tr></table></div>
<h4 id="tapoyaml"><code>tapo.yaml</code></h4>
<div class="language-yaml highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-12-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-12-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-12-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-12-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-12-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-12-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-12-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-12-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-12-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-12-10">10</a></span>
<span class="normal"><a href="#__codelineno-12-11">11</a></span>
<span class="normal"><a href="#__codelineno-12-12">12</a></span>
<span class="normal"><a href="#__codelineno-12-13">13</a></span>
<span class="normal"><a href="#__codelineno-12-14">14</a></span>
<span class="normal"><a href="#__codelineno-12-15">15</a></span>
<span class="normal"><a href="#__codelineno-12-16">16</a></span>
<span class="normal"><a href="#__codelineno-12-17">17</a></span>
<span class="normal"><a href="#__codelineno-12-18">18</a></span>
<span class="normal"><a href="#__codelineno-12-19">19</a></span>
<span class="normal"><a href="#__codelineno-12-20">20</a></span>
<span class="normal"><a href="#__codelineno-12-21">21</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-12-1"><a id="__codelineno-12-1" name="__codelineno-12-1"></a><span class="nt">always_on</span><span class="p">:</span>
</span><span id="__span-12-2"><a id="__codelineno-12-2" name="__codelineno-12-2"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s">"Dehumidifier"</span>
</span><span id="__span-12-3"><a id="__codelineno-12-3" name="__codelineno-12-3"></a><span class="w">    </span><span class="nt">power</span><span class="p">:</span><span class="w"> </span><span class="s">"250"</span>
</span><span id="__span-12-4"><a id="__codelineno-12-4" name="__codelineno-12-4"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s">"PC"</span>
</span><span id="__span-12-5"><a id="__codelineno-12-5" name="__codelineno-12-5"></a><span class="w">    </span><span class="nt">power</span><span class="p">:</span><span class="w"> </span><span class="s">"150"</span>
</span><span id="__span-12-6"><a id="__codelineno-12-6" name="__codelineno-12-6"></a><span class="nt">devices</span><span class="p">:</span>
</span><span id="__span-12-7"><a id="__codelineno-12-7" name="__codelineno-12-7"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">ip</span><span class="p">:</span><span class="w"> </span><span class="s">"192.168.0.115"</span>
</span><span id="__span-12-8"><a id="__codelineno-12-8" name="__codelineno-12-8"></a><span class="w">    </span><span class="nt">model</span><span class="p">:</span><span class="w"> </span><span class="s">"P115"</span>
</span><span id="__span-12-9"><a id="__codelineno-12-9" name="__codelineno-12-9"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">ip</span><span class="p">:</span><span class="w"> </span><span class="s">"192.168.0.100"</span>
</span><span id="__span-12-10"><a id="__codelineno-12-10" name="__codelineno-12-10"></a><span class="w">    </span><span class="nt">model</span><span class="p">:</span><span class="w"> </span><span class="s">"H100"</span>
</span><span id="__span-12-11"><a id="__codelineno-12-11" name="__codelineno-12-11"></a><span class="nt">influxdb</span><span class="p">:</span>
</span><span id="__span-12-12"><a id="__codelineno-12-12" name="__codelineno-12-12"></a><span class="w">  </span><span class="nt">host</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">inf.ssl.uu.am</span>
</span><span id="__span-12-13"><a id="__codelineno-12-13" name="__codelineno-12-13"></a><span class="w">  </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">443</span>
</span><span id="__span-12-14"><a id="__codelineno-12-14" name="__codelineno-12-14"></a><span class="w">  </span><span class="nt">database</span><span class="p">:</span><span class="w"> </span><span class="s">"home"</span>
</span><span id="__span-12-15"><a id="__codelineno-12-15" name="__codelineno-12-15"></a><span class="w">  </span><span class="nt">username</span><span class="p">:</span><span class="w"> </span><span class="s">"INFLUXDB_USERNAME"</span>
</span><span id="__span-12-16"><a id="__codelineno-12-16" name="__codelineno-12-16"></a><span class="w">  </span><span class="nt">password</span><span class="p">:</span><span class="w"> </span><span class="s">"INFLUXDB_PASSWORD"</span>
</span><span id="__span-12-17"><a id="__codelineno-12-17" name="__codelineno-12-17"></a><span class="w">  </span><span class="nt">ssl</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">True</span>
</span><span id="__span-12-18"><a id="__codelineno-12-18" name="__codelineno-12-18"></a><span class="w">  </span><span class="nt">verify_ssl</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">True</span>
</span><span id="__span-12-19"><a id="__codelineno-12-19" name="__codelineno-12-19"></a><span class="nt">tapo_auth</span><span class="p">:</span>
</span><span id="__span-12-20"><a id="__codelineno-12-20" name="__codelineno-12-20"></a><span class="w">  </span><span class="nt">tapo_username</span><span class="p">:</span><span class="w"> </span><span class="s">"TAPO_USERNAME"</span>
</span><span id="__span-12-21"><a id="__codelineno-12-21" name="__codelineno-12-21"></a><span class="w">  </span><span class="nt">tapo_password</span><span class="p">:</span><span class="w"> </span><span class="s">"TAPO_PASSWORD"</span>
</span></code></pre></div></td></tr></table></div>
<h4 id="python-dependencies">Python dependencies</h4>
<p>The <code>absl</code> and <code>influxdb</code> modules can be installed with<code>apt</code>:</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-13-1"><a id="__codelineno-13-1" name="__codelineno-13-1" href="#__codelineno-13-1"></a><span class="gp"># </span>apt<span class="w"> </span>install<span class="w"> </span>python3-absl<span class="w"> </span>python3-influxdb
</span></code></pre></div>
<p>The <a href="https://github.com/mihai-dinculescu/tapo/"><code>tapo</code></a> module
is more complicated to install. The recommended approach is to use
<strong>virtualenv</strong>:</p>
<details class="terminal">
<summary><code># apt install python3-venv -y</code></summary>
<div class="language-console highlight"><pre><span></span><code><span id="__span-14-1"><a id="__codelineno-14-1" name="__codelineno-14-1" href="#__codelineno-14-1"></a><span class="gp"># </span>apt<span class="w"> </span>install<span class="w"> </span>python3-venv<span class="w"> </span>-y
</span><span id="__span-14-2"><a id="__codelineno-14-2" name="__codelineno-14-2" href="#__codelineno-14-2"></a><span class="go">Reading package lists... Done</span>
</span><span id="__span-14-3"><a id="__codelineno-14-3" name="__codelineno-14-3" href="#__codelineno-14-3"></a><span class="go">Building dependency tree... Done</span>
</span><span id="__span-14-4"><a id="__codelineno-14-4" name="__codelineno-14-4" href="#__codelineno-14-4"></a><span class="go">Reading state information... Done</span>
</span><span id="__span-14-5"><a id="__codelineno-14-5" name="__codelineno-14-5" href="#__codelineno-14-5"></a><span class="go">The following additional packages will be installed:</span>
</span><span id="__span-14-6"><a id="__codelineno-14-6" name="__codelineno-14-6" href="#__codelineno-14-6"></a><span class="go">  python3-pip-whl python3-setuptools-whl python3.12-venv</span>
</span><span id="__span-14-7"><a id="__codelineno-14-7" name="__codelineno-14-7" href="#__codelineno-14-7"></a><span class="go">The following NEW packages will be installed:</span>
</span><span id="__span-14-8"><a id="__codelineno-14-8" name="__codelineno-14-8" href="#__codelineno-14-8"></a><span class="go">  python3-pip-whl python3-setuptools-whl python3-venv python3.12-venv</span>
</span><span id="__span-14-9"><a id="__codelineno-14-9" name="__codelineno-14-9" href="#__codelineno-14-9"></a><span class="go">0 upgraded, 4 newly installed, 0 to remove and 3 not upgraded.</span>
</span><span id="__span-14-10"><a id="__codelineno-14-10" name="__codelineno-14-10" href="#__codelineno-14-10"></a><span class="go">Need to get 2,425 kB of archives.</span>
</span><span id="__span-14-11"><a id="__codelineno-14-11" name="__codelineno-14-11" href="#__codelineno-14-11"></a><span class="go">After this operation, 2,777 kB of additional disk space will be used.</span>
</span><span id="__span-14-12"><a id="__codelineno-14-12" name="__codelineno-14-12" href="#__codelineno-14-12"></a><span class="go">Get:1 http://archive.ubuntu.com/ubuntu noble-updates/universe amd64 python3-pip-whl all 24.0+dfsg-1ubuntu1.1 [1,703 kB]</span>
</span><span id="__span-14-13"><a id="__codelineno-14-13" name="__codelineno-14-13" href="#__codelineno-14-13"></a><span class="go">Get:2 http://archive.ubuntu.com/ubuntu noble-updates/universe amd64 python3-setuptools-whl all 68.1.2-2ubuntu1.1 [716 kB]</span>
</span><span id="__span-14-14"><a id="__codelineno-14-14" name="__codelineno-14-14" href="#__codelineno-14-14"></a><span class="go">Get:3 http://archive.ubuntu.com/ubuntu noble-updates/universe amd64 python3.12-venv amd64 3.12.3-1ubuntu0.3 [5,678 B]</span>
</span><span id="__span-14-15"><a id="__codelineno-14-15" name="__codelineno-14-15" href="#__codelineno-14-15"></a><span class="go">Get:4 http://archive.ubuntu.com/ubuntu noble-updates/universe amd64 python3-venv amd64 3.12.3-0ubuntu2 [1,034 B]</span>
</span><span id="__span-14-16"><a id="__codelineno-14-16" name="__codelineno-14-16" href="#__codelineno-14-16"></a><span class="go">Fetched 2,425 kB in 1s (1,736 kB/s)      </span>
</span><span id="__span-14-17"><a id="__codelineno-14-17" name="__codelineno-14-17" href="#__codelineno-14-17"></a><span class="go">Selecting previously unselected package python3-pip-whl.</span>
</span><span id="__span-14-18"><a id="__codelineno-14-18" name="__codelineno-14-18" href="#__codelineno-14-18"></a><span class="gp gp-VirtualEnv">(Reading database ... 425834 files and directories currently installed.)</span>
</span><span id="__span-14-19"><a id="__codelineno-14-19" name="__codelineno-14-19" href="#__codelineno-14-19"></a><span class="go">Preparing to unpack .../python3-pip-whl_24.0+dfsg-1ubuntu1.1_all.deb ...</span>
</span><span id="__span-14-20"><a id="__codelineno-14-20" name="__codelineno-14-20" href="#__codelineno-14-20"></a><span class="go">Unpacking python3-pip-whl (24.0+dfsg-1ubuntu1.1) ...</span>
</span><span id="__span-14-21"><a id="__codelineno-14-21" name="__codelineno-14-21" href="#__codelineno-14-21"></a><span class="go">Selecting previously unselected package python3-setuptools-whl.</span>
</span><span id="__span-14-22"><a id="__codelineno-14-22" name="__codelineno-14-22" href="#__codelineno-14-22"></a><span class="go">Preparing to unpack .../python3-setuptools-whl_68.1.2-2ubuntu1.1_all.deb ...</span>
</span><span id="__span-14-23"><a id="__codelineno-14-23" name="__codelineno-14-23" href="#__codelineno-14-23"></a><span class="go">Unpacking python3-setuptools-whl (68.1.2-2ubuntu1.1) ...</span>
</span><span id="__span-14-24"><a id="__codelineno-14-24" name="__codelineno-14-24" href="#__codelineno-14-24"></a><span class="go">Selecting previously unselected package python3.12-venv.</span>
</span><span id="__span-14-25"><a id="__codelineno-14-25" name="__codelineno-14-25" href="#__codelineno-14-25"></a><span class="go">Preparing to unpack .../python3.12-venv_3.12.3-1ubuntu0.3_amd64.deb ...</span>
</span><span id="__span-14-26"><a id="__codelineno-14-26" name="__codelineno-14-26" href="#__codelineno-14-26"></a><span class="go">Unpacking python3.12-venv (3.12.3-1ubuntu0.3) ...</span>
</span><span id="__span-14-27"><a id="__codelineno-14-27" name="__codelineno-14-27" href="#__codelineno-14-27"></a><span class="go">Selecting previously unselected package python3-venv.</span>
</span><span id="__span-14-28"><a id="__codelineno-14-28" name="__codelineno-14-28" href="#__codelineno-14-28"></a><span class="go">Preparing to unpack .../python3-venv_3.12.3-0ubuntu2_amd64.deb ...</span>
</span><span id="__span-14-29"><a id="__codelineno-14-29" name="__codelineno-14-29" href="#__codelineno-14-29"></a><span class="go">Unpacking python3-venv (3.12.3-0ubuntu2) ...</span>
</span><span id="__span-14-30"><a id="__codelineno-14-30" name="__codelineno-14-30" href="#__codelineno-14-30"></a><span class="go">Setting up python3-setuptools-whl (68.1.2-2ubuntu1.1) ...</span>
</span><span id="__span-14-31"><a id="__codelineno-14-31" name="__codelineno-14-31" href="#__codelineno-14-31"></a><span class="go">Setting up python3-pip-whl (24.0+dfsg-1ubuntu1.1) ...</span>
</span><span id="__span-14-32"><a id="__codelineno-14-32" name="__codelineno-14-32" href="#__codelineno-14-32"></a><span class="go">Setting up python3.12-venv (3.12.3-1ubuntu0.3) ...</span>
</span><span id="__span-14-33"><a id="__codelineno-14-33" name="__codelineno-14-33" href="#__codelineno-14-33"></a><span class="go">Setting up python3-venv (3.12.3-0ubuntu2) ...</span>
</span></code></pre></div>
</details>
<div class="language-console highlight"><pre><span></span><code><span id="__span-15-1"><a id="__codelineno-15-1" name="__codelineno-15-1" href="#__codelineno-15-1"></a><span class="gp">$ </span>mkdir<span class="w"> </span>-p<span class="w"> </span>~/.venvs
</span><span id="__span-15-2"><a id="__codelineno-15-2" name="__codelineno-15-2" href="#__codelineno-15-2"></a><span class="gp">$ </span>python3<span class="w"> </span>-m<span class="w"> </span>venv<span class="w"> </span>--system-site-packages<span class="w"> </span>~/.venvs/tapo
</span><span id="__span-15-3"><a id="__codelineno-15-3" name="__codelineno-15-3" href="#__codelineno-15-3"></a><span class="gp">$ </span>~/.venvs/tapo/bin/python<span class="w"> </span>-m<span class="w"> </span>pip<span class="w"> </span>install<span class="w"> </span>tapo
</span><span id="__span-15-4"><a id="__codelineno-15-4" name="__codelineno-15-4" href="#__codelineno-15-4"></a><span class="go">Collecting tapo</span>
</span><span id="__span-15-5"><a id="__codelineno-15-5" name="__codelineno-15-5" href="#__codelineno-15-5"></a><span class="go">  Using cached tapo-0.8.0-cp312-cp312-manylinux_2_17_x86_64.manylinux2014_x86_64.whl.metadata (12 kB)</span>
</span><span id="__span-15-6"><a id="__codelineno-15-6" name="__codelineno-15-6" href="#__codelineno-15-6"></a><span class="go">Using cached tapo-0.8.0-cp312-cp312-manylinux_2_17_x86_64.manylinux2014_x86_64.whl (3.3 MB)</span>
</span><span id="__span-15-7"><a id="__codelineno-15-7" name="__codelineno-15-7" href="#__codelineno-15-7"></a><span class="go">Installing collected packages: tapo</span>
</span><span id="__span-15-8"><a id="__codelineno-15-8" name="__codelineno-15-8" href="#__codelineno-15-8"></a><span class="go">Successfully installed tapo-0.8.0</span>
</span><span id="__span-15-9"><a id="__codelineno-15-9" name="__codelineno-15-9" href="#__codelineno-15-9"></a>
</span><span id="__span-15-10"><a id="__codelineno-15-10" name="__codelineno-15-10" href="#__codelineno-15-10"></a><span class="gp">$ </span>~/.venvs/tapo/bin/python<span class="w"> </span>./conmon-tapo.py
</span></code></pre></div>
<p>The <code>tapo</code> module can also be installed the <em>not recommended</em> way: </p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-16-1"><a id="__codelineno-16-1" name="__codelineno-16-1" href="#__codelineno-16-1"></a><span class="gp"># </span>pip<span class="w"> </span>install<span class="w"> </span>--break-system-packages<span class="w"> </span>tapo
</span><span id="__span-16-2"><a id="__codelineno-16-2" name="__codelineno-16-2" href="#__codelineno-16-2"></a><span class="go">Collecting tapo</span>
</span><span id="__span-16-3"><a id="__codelineno-16-3" name="__codelineno-16-3" href="#__codelineno-16-3"></a><span class="go">  Using cached tapo-0.8.0-cp312-cp312-manylinux_2_17_x86_64.manylinux2014_x86_64.whl.metadata (12 kB)</span>
</span><span id="__span-16-4"><a id="__codelineno-16-4" name="__codelineno-16-4" href="#__codelineno-16-4"></a><span class="go">Using cached tapo-0.8.0-cp312-cp312-manylinux_2_17_x86_64.manylinux2014_x86_64.whl (3.3 MB)</span>
</span><span id="__span-16-5"><a id="__codelineno-16-5" name="__codelineno-16-5" href="#__codelineno-16-5"></a><span class="go">Installing collected packages: tapo</span>
</span><span id="__span-16-6"><a id="__codelineno-16-6" name="__codelineno-16-6" href="#__codelineno-16-6"></a><span class="go">Successfully installed tapo-0.8.0</span>
</span><span id="__span-16-7"><a id="__codelineno-16-7" name="__codelineno-16-7" href="#__codelineno-16-7"></a><span class="go">WARNING: Running pip as the 'root' user can result in broken permissions and conflicting behaviour with the system package manager. It is recommended to use a virtual environment instead: https://pip.pypa.io/warnings/venv</span>
</span></code></pre></div>
<h4 id="device-ip-dependencies">Device IP dependencies</h4>
<p>The "<code>conmon-tapo.py</code> script was initially writen on the assumption
that Tapo devices would keep their IP address constant long-term,
so if they change IP addresses the script crashes when trying to read
the wrong fields, or simply not being able to connect to one of them:</p>
<details class="failure">
<summary>Trying to reach a device at nobody's IP address</summary>
<div class="language-console highlight"><pre><span></span><code><span id="__span-17-1"><a id="__codelineno-17-1" name="__codelineno-17-1" href="#__codelineno-17-1"></a><span class="gp">$ </span>~/.venvs/tapo/bin/python<span class="w"> </span>./conmon-tapo.py<span class="w"> </span>
</span><span id="__span-17-2"><a id="__codelineno-17-2" name="__codelineno-17-2" href="#__codelineno-17-2"></a><span class="go">Traceback (most recent call last):</span>
</span><span id="__span-17-3"><a id="__codelineno-17-3" name="__codelineno-17-3" href="#__codelineno-17-3"></a><span class="go">  File "/home/coder/src/conmon/./conmon-tapo.py", line 138, in &lt;module&gt;</span>
</span><span id="__span-17-4"><a id="__codelineno-17-4" name="__codelineno-17-4" href="#__codelineno-17-4"></a><span class="go">    app.run(main)</span>
</span><span id="__span-17-5"><a id="__codelineno-17-5" name="__codelineno-17-5" href="#__codelineno-17-5"></a><span class="go">  File "/usr/lib/python3/dist-packages/absl/app.py", line 308, in run</span>
</span><span id="__span-17-6"><a id="__codelineno-17-6" name="__codelineno-17-6" href="#__codelineno-17-6"></a><span class="go">    _run_main(main, args)</span>
</span><span id="__span-17-7"><a id="__codelineno-17-7" name="__codelineno-17-7" href="#__codelineno-17-7"></a><span class="go">  File "/usr/lib/python3/dist-packages/absl/app.py", line 254, in _run_main</span>
</span><span id="__span-17-8"><a id="__codelineno-17-8" name="__codelineno-17-8" href="#__codelineno-17-8"></a><span class="go">    sys.exit(main(argv))</span>
</span><span id="__span-17-9"><a id="__codelineno-17-9" name="__codelineno-17-9" href="#__codelineno-17-9"></a><span class="go">            ^^^^^^^^^^</span>
</span><span id="__span-17-10"><a id="__codelineno-17-10" name="__codelineno-17-10" href="#__codelineno-17-10"></a><span class="go">  File "/home/coder/src/conmon/./conmon-tapo.py", line 132, in main</span>
</span><span id="__span-17-11"><a id="__codelineno-17-11" name="__codelineno-17-11" href="#__codelineno-17-11"></a><span class="go">    reports = asyncio.run(fetch_reports(config))</span>
</span><span id="__span-17-12"><a id="__codelineno-17-12" name="__codelineno-17-12" href="#__codelineno-17-12"></a><span class="go">              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^</span>
</span><span id="__span-17-13"><a id="__codelineno-17-13" name="__codelineno-17-13" href="#__codelineno-17-13"></a><span class="go">  File "/usr/lib/python3.12/asyncio/runners.py", line 194, in run</span>
</span><span id="__span-17-14"><a id="__codelineno-17-14" name="__codelineno-17-14" href="#__codelineno-17-14"></a><span class="go">    return runner.run(main)</span>
</span><span id="__span-17-15"><a id="__codelineno-17-15" name="__codelineno-17-15" href="#__codelineno-17-15"></a><span class="go">          ^^^^^^^^^^^^^^^^</span>
</span><span id="__span-17-16"><a id="__codelineno-17-16" name="__codelineno-17-16" href="#__codelineno-17-16"></a><span class="go">  File "/usr/lib/python3.12/asyncio/runners.py", line 118, in run</span>
</span><span id="__span-17-17"><a id="__codelineno-17-17" name="__codelineno-17-17" href="#__codelineno-17-17"></a><span class="go">    return self._loop.run_until_complete(task)</span>
</span><span id="__span-17-18"><a id="__codelineno-17-18" name="__codelineno-17-18" href="#__codelineno-17-18"></a><span class="go">          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^</span>
</span><span id="__span-17-19"><a id="__codelineno-17-19" name="__codelineno-17-19" href="#__codelineno-17-19"></a><span class="go">  File "/usr/lib/python3.12/asyncio/base_events.py", line 687, in run_until_complete</span>
</span><span id="__span-17-20"><a id="__codelineno-17-20" name="__codelineno-17-20" href="#__codelineno-17-20"></a><span class="go">    return future.result()</span>
</span><span id="__span-17-21"><a id="__codelineno-17-21" name="__codelineno-17-21" href="#__codelineno-17-21"></a><span class="go">          ^^^^^^^^^^^^^^^</span>
</span><span id="__span-17-22"><a id="__codelineno-17-22" name="__codelineno-17-22" href="#__codelineno-17-22"></a><span class="go">  File "/home/coder/src/conmon/./conmon-tapo.py", line 83, in fetch_reports</span>
</span><span id="__span-17-23"><a id="__codelineno-17-23" name="__codelineno-17-23" href="#__codelineno-17-23"></a><span class="go">    device_conn = await client.p110(device["ip"])</span>
</span><span id="__span-17-24"><a id="__codelineno-17-24" name="__codelineno-17-24" href="#__codelineno-17-24"></a><span class="go">                  ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^</span>
</span><span id="__span-17-25"><a id="__codelineno-17-25" name="__codelineno-17-25" href="#__codelineno-17-25"></a><span class="hll"><span class="go">Exception: Http(reqwest::Error { kind: Request, url: "http://192.168.0.41/app", source: hyper_util::client::legacy::Error(Connect, ConnectError("tcp connect error", Os { code: 113, kind: HostUnreachable, message: "No route to host" })) })</span>
</span></span></code></pre></div>
</details>
<details class="failure">
<summary>Trying to reach a device at somebody else's IP address</summary>
<div class="language-console highlight"><pre><span></span><code><span id="__span-18-1"><a id="__codelineno-18-1" name="__codelineno-18-1" href="#__codelineno-18-1"></a><span class="gp">$ </span>~/.venvs/tapo/bin/python<span class="w"> </span>./conmon-tapo.py<span class="w"> </span>
</span><span id="__span-18-2"><a id="__codelineno-18-2" name="__codelineno-18-2" href="#__codelineno-18-2"></a><span class="go">Traceback (most recent call last):</span>
</span><span id="__span-18-3"><a id="__codelineno-18-3" name="__codelineno-18-3" href="#__codelineno-18-3"></a><span class="go">  File "/home/coder/src/conmon/./conmon-tapo.py", line 138, in &lt;module&gt;</span>
</span><span id="__span-18-4"><a id="__codelineno-18-4" name="__codelineno-18-4" href="#__codelineno-18-4"></a><span class="go">    app.run(main)</span>
</span><span id="__span-18-5"><a id="__codelineno-18-5" name="__codelineno-18-5" href="#__codelineno-18-5"></a><span class="go">  File "/usr/lib/python3/dist-packages/absl/app.py", line 308, in run</span>
</span><span id="__span-18-6"><a id="__codelineno-18-6" name="__codelineno-18-6" href="#__codelineno-18-6"></a><span class="go">    _run_main(main, args)</span>
</span><span id="__span-18-7"><a id="__codelineno-18-7" name="__codelineno-18-7" href="#__codelineno-18-7"></a><span class="go">  File "/usr/lib/python3/dist-packages/absl/app.py", line 254, in _run_main</span>
</span><span id="__span-18-8"><a id="__codelineno-18-8" name="__codelineno-18-8" href="#__codelineno-18-8"></a><span class="go">    sys.exit(main(argv))</span>
</span><span id="__span-18-9"><a id="__codelineno-18-9" name="__codelineno-18-9" href="#__codelineno-18-9"></a><span class="go">            ^^^^^^^^^^</span>
</span><span id="__span-18-10"><a id="__codelineno-18-10" name="__codelineno-18-10" href="#__codelineno-18-10"></a><span class="go">  File "/home/coder/src/conmon/./conmon-tapo.py", line 132, in main</span>
</span><span id="__span-18-11"><a id="__codelineno-18-11" name="__codelineno-18-11" href="#__codelineno-18-11"></a><span class="go">    reports = asyncio.run(fetch_reports(config))</span>
</span><span id="__span-18-12"><a id="__codelineno-18-12" name="__codelineno-18-12" href="#__codelineno-18-12"></a><span class="go">              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^</span>
</span><span id="__span-18-13"><a id="__codelineno-18-13" name="__codelineno-18-13" href="#__codelineno-18-13"></a><span class="go">  File "/usr/lib/python3.12/asyncio/runners.py", line 194, in run</span>
</span><span id="__span-18-14"><a id="__codelineno-18-14" name="__codelineno-18-14" href="#__codelineno-18-14"></a><span class="go">    return runner.run(main)</span>
</span><span id="__span-18-15"><a id="__codelineno-18-15" name="__codelineno-18-15" href="#__codelineno-18-15"></a><span class="go">          ^^^^^^^^^^^^^^^^</span>
</span><span id="__span-18-16"><a id="__codelineno-18-16" name="__codelineno-18-16" href="#__codelineno-18-16"></a><span class="go">  File "/usr/lib/python3.12/asyncio/runners.py", line 118, in run</span>
</span><span id="__span-18-17"><a id="__codelineno-18-17" name="__codelineno-18-17" href="#__codelineno-18-17"></a><span class="go">    return self._loop.run_until_complete(task)</span>
</span><span id="__span-18-18"><a id="__codelineno-18-18" name="__codelineno-18-18" href="#__codelineno-18-18"></a><span class="go">          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^</span>
</span><span id="__span-18-19"><a id="__codelineno-18-19" name="__codelineno-18-19" href="#__codelineno-18-19"></a><span class="go">  File "/usr/lib/python3.12/asyncio/base_events.py", line 687, in run_until_complete</span>
</span><span id="__span-18-20"><a id="__codelineno-18-20" name="__codelineno-18-20" href="#__codelineno-18-20"></a><span class="go">    return future.result()</span>
</span><span id="__span-18-21"><a id="__codelineno-18-21" name="__codelineno-18-21" href="#__codelineno-18-21"></a><span class="go">          ^^^^^^^^^^^^^^^</span>
</span><span id="__span-18-22"><a id="__codelineno-18-22" name="__codelineno-18-22" href="#__codelineno-18-22"></a><span class="go">  File "/home/coder/src/conmon/./conmon-tapo.py", line 83, in fetch_reports</span>
</span><span id="__span-18-23"><a id="__codelineno-18-23" name="__codelineno-18-23" href="#__codelineno-18-23"></a><span class="go">    device_conn = await client.p110(device["ip"])</span>
</span><span id="__span-18-24"><a id="__codelineno-18-24" name="__codelineno-18-24" href="#__codelineno-18-24"></a><span class="go">                  ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^</span>
</span><span id="__span-18-25"><a id="__codelineno-18-25" name="__codelineno-18-25" href="#__codelineno-18-25"></a><span class="hll"><span class="go">Exception: Http(reqwest::Error { kind: Request, url: "http://192.168.0.32/app", source: hyper_util::client::legacy::Error(SendRequest, hyper::Error(Io, Os { code: 104, kind: ConnectionReset, message: "Connection reset by peer" })) })</span>
</span></span></code></pre></div>
</details>
<details class="failure">
<summary>Trying to read a P115 like it was an H100</summary>
<div class="language-console highlight"><pre><span></span><code><span id="__span-19-1"><a id="__codelineno-19-1" name="__codelineno-19-1" href="#__codelineno-19-1"></a><span class="gp">$ </span>~/.venvs/tapo/bin/python<span class="w"> </span>./conmon-tapo.py
</span><span id="__span-19-2"><a id="__codelineno-19-2" name="__codelineno-19-2" href="#__codelineno-19-2"></a><span class="go">Traceback (most recent call last):</span>
</span><span id="__span-19-3"><a id="__codelineno-19-3" name="__codelineno-19-3" href="#__codelineno-19-3"></a><span class="go">  File "/home/coder/src/conmon/./conmon-tapo.py", line 138, in &lt;module&gt;</span>
</span><span id="__span-19-4"><a id="__codelineno-19-4" name="__codelineno-19-4" href="#__codelineno-19-4"></a><span class="go">    app.run(main)</span>
</span><span id="__span-19-5"><a id="__codelineno-19-5" name="__codelineno-19-5" href="#__codelineno-19-5"></a><span class="go">  File "/usr/lib/python3/dist-packages/absl/app.py", line 308, in run</span>
</span><span id="__span-19-6"><a id="__codelineno-19-6" name="__codelineno-19-6" href="#__codelineno-19-6"></a><span class="go">    _run_main(main, args)</span>
</span><span id="__span-19-7"><a id="__codelineno-19-7" name="__codelineno-19-7" href="#__codelineno-19-7"></a><span class="go">  File "/usr/lib/python3/dist-packages/absl/app.py", line 254, in _run_main</span>
</span><span id="__span-19-8"><a id="__codelineno-19-8" name="__codelineno-19-8" href="#__codelineno-19-8"></a><span class="go">    sys.exit(main(argv))</span>
</span><span id="__span-19-9"><a id="__codelineno-19-9" name="__codelineno-19-9" href="#__codelineno-19-9"></a><span class="go">            ^^^^^^^^^^</span>
</span><span id="__span-19-10"><a id="__codelineno-19-10" name="__codelineno-19-10" href="#__codelineno-19-10"></a><span class="go">  File "/home/coder/src/conmon/./conmon-tapo.py", line 132, in main</span>
</span><span id="__span-19-11"><a id="__codelineno-19-11" name="__codelineno-19-11" href="#__codelineno-19-11"></a><span class="go">    reports = asyncio.run(fetch_reports(config))</span>
</span><span id="__span-19-12"><a id="__codelineno-19-12" name="__codelineno-19-12" href="#__codelineno-19-12"></a><span class="go">              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^</span>
</span><span id="__span-19-13"><a id="__codelineno-19-13" name="__codelineno-19-13" href="#__codelineno-19-13"></a><span class="go">  File "/usr/lib/python3.12/asyncio/runners.py", line 194, in run</span>
</span><span id="__span-19-14"><a id="__codelineno-19-14" name="__codelineno-19-14" href="#__codelineno-19-14"></a><span class="go">    return runner.run(main)</span>
</span><span id="__span-19-15"><a id="__codelineno-19-15" name="__codelineno-19-15" href="#__codelineno-19-15"></a><span class="go">          ^^^^^^^^^^^^^^^^</span>
</span><span id="__span-19-16"><a id="__codelineno-19-16" name="__codelineno-19-16" href="#__codelineno-19-16"></a><span class="go">  File "/usr/lib/python3.12/asyncio/runners.py", line 118, in run</span>
</span><span id="__span-19-17"><a id="__codelineno-19-17" name="__codelineno-19-17" href="#__codelineno-19-17"></a><span class="go">    return self._loop.run_until_complete(task)</span>
</span><span id="__span-19-18"><a id="__codelineno-19-18" name="__codelineno-19-18" href="#__codelineno-19-18"></a><span class="go">          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^</span>
</span><span id="__span-19-19"><a id="__codelineno-19-19" name="__codelineno-19-19" href="#__codelineno-19-19"></a><span class="go">  File "/usr/lib/python3.12/asyncio/base_events.py", line 687, in run_until_complete</span>
</span><span id="__span-19-20"><a id="__codelineno-19-20" name="__codelineno-19-20" href="#__codelineno-19-20"></a><span class="go">    return future.result()</span>
</span><span id="__span-19-21"><a id="__codelineno-19-21" name="__codelineno-19-21" href="#__codelineno-19-21"></a><span class="go">          ^^^^^^^^^^^^^^^</span>
</span><span id="__span-19-22"><a id="__codelineno-19-22" name="__codelineno-19-22" href="#__codelineno-19-22"></a><span class="go">  File "/home/coder/src/conmon/./conmon-tapo.py", line 65, in fetch_reports</span>
</span><span id="__span-19-23"><a id="__codelineno-19-23" name="__codelineno-19-23" href="#__codelineno-19-23"></a><span class="go">    device_info = await device_conn.get_device_info()</span>
</span><span id="__span-19-24"><a id="__codelineno-19-24" name="__codelineno-19-24" href="#__codelineno-19-24"></a><span class="go">                  ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^</span>
</span><span id="__span-19-25"><a id="__codelineno-19-25" name="__codelineno-19-25" href="#__codelineno-19-25"></a><span class="hll"><span class="go">Exception: Serde(Error("missing field `in_alarm_source`", line: 1, column: 822))</span>
</span></span></code></pre></div>
</details></div>


  




                
              </article>
            </div>
          
          
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright &copy; 2019-2025 Ponder Stibbons
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "..", "features": ["content.code.copy", "search.highlight", "search.suggest"], "search": "../assets/javascripts/workers/search.a264c092.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../assets/javascripts/bundle.4e0fa4ba.min.js"></script>
      
    
  <script id="init-glightbox">const lightbox = GLightbox({"touchNavigation": true, "loop": false, "zoomable": true, "draggable": true, "openEffect": "zoom", "closeEffect": "zoom", "slideEffect": "slide"});
document$.subscribe(() => { lightbox.reload() });
</script></body>
</html>